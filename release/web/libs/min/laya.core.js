window.Laya=function(t){"use strict";function dummy(){}function dummy2(){}class e{static defaultFontStr(){return e.defaultFontSize+"px "+e.defaultFont}}e.isAntialias=!0,e.useWebGL2=!0,e.FPS=60,e.useRetinalCanvas=!1,e.animationInterval=50,e.webGL2D_MeshAllocMaxMem=!0,e.defaultFontSize=12,e.defaultFont="Arial",e.isAlpha=!1,e.isDepth=!1,e.isfailIfMajorPerformanceCaveat=!1,e.powerPreference="default",e.premultipliedAlpha=!0,e.isStencil=!1,e.preserveDrawingBuffer=!1,e.printWebglOrder=!1,e.fontFamilyMap={"报隶":"报隶-简","黑体":"黑体-简","楷体":"楷体-简","兰亭黑":"兰亭黑-简","隶变":"隶变-简","凌慧体":"凌慧体-简","翩翩体":"翩翩体-简","苹方":"苹方-简","手札体":"手札体-简","宋体":"宋体-简","娃娃体":"娃娃体-简","魏碑":"魏碑-简","行楷":"行楷-简","雅痞":"雅痞-简","圆体":"圆体-简"};class i{}i.ENUM_TEXTALIGN_DEFAULT=0,i.ENUM_TEXTALIGN_CENTER=1,i.ENUM_TEXTALIGN_RIGHT=2,i.BYTES_PE=4,i.BYTES_PIDX=2,i.MAX_CLIP_SIZE=99999999;class r{}r.NOT_ACTIVE=1,r.ACTIVE_INHIERARCHY=2,r.AWAKED=4,r.NOT_READY=8,r.DISPLAY=16,r.HAS_ZORDER=32,r.HAS_MOUSE=64,r.DISPLAYED_INSTAGE=128,r.DRAWCALL_OPTIMIZE=256,r.PROCESS_COLLISIONS=512,r.PROCESS_TRIGGERS=1024,r.HAS_SCRIPT=2048,r.ESCAPE_DRAWING_TO_TEXTURE=4096,r.DISABLE_INNER_CLIPPING=8192,r.DISABLE_OUTER_CLIPPING=16384,r.DISABLE_VISIBILITY=32768,r.HIDE_BY_EDITOR=65536,r.LOCK_BY_EDITOR=131072;class s{}s.HideInHierarchy=1,s.HideInInspector=2,s.DontSave=4,s.HideAndDontSave=7;class a{static regClass(t,e){a._classMap[t]=e}static getClass(t){return a._classMap[t]}static getInstance(t){var e=a.getClass(t);return e?new e:(console.warn("[error] Undefined class:",t),null)}}a._classMap={};class n{}n.Loader=null,n.Context=null,n.Browser=null,n.Laya=null,n.loader=null,n.timer=null,n.systemTimer=null,n.physicsTimer=null,n.stage=null;class h{}h.version="3.0.0rc",h.isPlaying=!0,h.isPreview=!1,h.isConch=null!=window.conch;class o{static getPoolBySign(t){return o._poolDic[t]||(o._poolDic[t]=[])}static clearBySign(t){o._poolDic[t]&&(o._poolDic[t].length=0)}static recover(t,e){e[o.POOLSIGN]||(e[o.POOLSIGN]=!0,o.getPoolBySign(t).push(e))}static recoverByClass(t){if(t){var e=t.__className||t.constructor._$gid;e&&o.recover(e,t)}}static _getClassSign(t){var e=t.__className||t._$gid;return e||(t._$gid=e=o._CLSID+"",o._CLSID++),e}static createByClass(t){return o.getItemByClass(o._getClassSign(t),t)}static getItemByClass(t,e){if(!o._poolDic[t])return new e;var i=o.getPoolBySign(t);if(i.length){var r=i.pop();r[o.POOLSIGN]=!1}else r=new e;return r}static getItemByCreateFun(t,e,i=null){var r=o.getPoolBySign(t),s=r.length?r.pop():e.call(i);return s[o.POOLSIGN]=!1,s}static getItem(t){var e=o.getPoolBySign(t),i=e.length?e.pop():null;return i&&(i[o.POOLSIGN]=!1),i}}o._CLSID=0,o.POOLSIGN="__InPool",o._poolDic={};var l=1;const _=180/Math.PI,u=Math.PI/180;class d{static toRadian(t){return t*u}static toAngle(t){return t*_}static toHexColor(t){if(t<0||isNaN(t))return null;for(var e=t.toString(16);e.length<6;)e="0"+e;return"#"+e}static fromStringColor(t){if(!t)return 0;if(t.indexOf("rgba(")>=0||t.indexOf("rgb(")>=0){let e=t.indexOf("("),i=t.indexOf(")");if(-1==e||-1==i)return 0;let r=(t=t.substring(e+1,i)).split(","),s=r.length;for(let t=0;t<s;t++)r[t]=parseFloat(r[t]),isNaN(r[t])&&(r[t]=0);return 4==r.length?(r[0]<<24)+(r[1]<<16)+(r[2]<<8)+Math.round(255*r[3]):(r[0]<<16)+(r[1]<<8)+r[2]}{"#"===t.charAt(0)&&(t=t.substring(1));let e=t.length;if(3===e||4===e){let i="";for(let r=0;r<e;r++)i+=t[r]+t[r];t=i}return parseInt(t,16)}}static getGID(){return l++}static copyArray(t,e){if(t||(t=[]),!e)return t;t.length=e.length;var i=e.length;for(let r=0;r<i;r++)t[r]=e[r];return t}static transPointList(t,e,i){var r,s=t.length;for(r=0;r<s;r+=2)t[r]+=e,t[r+1]+=i}static parseInt(t,e=0){var i=parseInt(t,e);return isNaN(i)?0:i}static getBaseName(t){let e=t.lastIndexOf("/");return-1!=e&&(t=t.substring(e+1)),e=t.indexOf("?"),-1!=e&&(t=t.substring(0,e)),t}static getFileExtension(t){let e=t.lastIndexOf(".");if(-1!=e){let i=t.substring(e+1).toLowerCase(),r=i.indexOf("?");if(-1!=r&&(i=i.substring(0,r)),"ls"===i){let r=t.lastIndexOf(".",e-1);if(-1!=r){let s=t.substring(r+1,e+1)+i;if("lanit.ls"===s||"ltcb.ls"===s)return s}}return i}return""}static replaceFileExtension(t,e){if(!t)return t;let i=t.lastIndexOf(".");if(e.length>0&&(e="."+e),-1!=i){let r=t.indexOf("?",i);return-1!=r?t.substring(0,i)+e+t.substring(r):t.substring(0,i)+e}return t+e}}d.parseXMLFromString=function(t){var e;if(t=t.replace(/>\s+</g,"><"),(e=(new DOMParser).parseFromString(t,"text/xml")).firstChild.textContent.indexOf("This page contains the following errors")>-1)throw new Error(e.firstChild.firstChild.textContent);return e};class c{get hideFlags(){return this._hideFlags}set hideFlags(t){this._hideFlags=t}constructor(){this._hideFlags=0,this._status=0,this._enabled=!0,this._singleton=!0,this._id=d.getGID(),this._initialize()}_initialize(){this._extra={}}hasHideFlag(t){return 0!=(this._hideFlags&t)}get id(){return this._id}get enabled(){return this._enabled}set enabled(t){this._enabled!=t&&(this._enabled=t,this.owner&&this._setActive(t&&this.owner.activeInHierarchy))}get awaked(){return this._status>0}get destroyed(){return 4==this._status}_isScript(){return!1}_resetComp(){this._enabled=!0,this._status=0,this._enableState=!1,this.owner=null}_setOwner(t){if(0!=this._status)throw"reuse a destroyed component";this.owner=t,this._isScript()&&t._setBit(r.HAS_SCRIPT,!0),this._onAdded(),this.onAdded()}_onAdded(){}_onAwake(){}_onEnable(){this.onEnable()}_onDisable(){this.onDisable()}_onDestroy(){}_parse(t,e=null){}_parseInteractive(t=null,e=null){}_cloneTo(t){}_setActive(t){var e,i;if(t){if(0==this._status&&(this._status=1,(h.isPlaying||this.runInEditor)&&(this._onAwake(),this.onAwake())),this._enabled&&!this._enableState&&(this._enableState=!0,h.isPlaying||this.runInEditor)){((null===(e=this.owner._is3D&&this.owner._scene)||void 0===e?void 0:e._componentDriver)||n.stage._componentDriver).add(this),h.isPlaying&&this._isScript()&&this.setupScript(),this._onEnable()}}else if(this._enableState&&(this._enableState=!1,h.isPlaying||this.runInEditor)){((null===(i=this.owner._is3D&&this.owner._scene)||void 0===i?void 0:i._componentDriver)||n.stage._componentDriver).remove(this),this.owner.offAllCaller(this),this._onDisable()}}setupScript(){}destroy(){4!=this._status&&this.owner&&this.owner._destroyComponent(this)}_destroy(t){var e;if(t)return this._onDestroy(),this.onDestroy(),void(this.onReset&&(this.onReset(),this._resetComp(),o.recoverByClass(this)));this._setActive(!1),this._status=4,((null===(e=this.owner._is3D&&this.owner._scene)||void 0===e?void 0:e._componentDriver)||n.stage._componentDriver)._toDestroys.add(this)}onAdded(){}onAwake(){}onEnable(){}onDisable(){}onDestroy(){}}class p{constructor(t=1,e=0,i=0,r=1,s=0,a=0,n=0){if(this._bTransform=!1,null!=p._createFun)return p._createFun(t,e,i,r,s,a,n);this.a=t,this.b=e,this.c=i,this.d=r,this.tx=s,this.ty=a,this._checkTransform()}identity(){return this.a=this.d=1,this.b=this.tx=this.ty=this.c=0,this._bTransform=!1,this}_checkTransform(){return this._bTransform=1!==this.a||0!==this.b||0!==this.c||1!==this.d}setTranslate(t,e){return this.tx=t,this.ty=e,this}translate(t,e){return this.tx+=t,this.ty+=e,this}scale(t,e){return this.a*=t,this.d*=e,this.c*=t,this.b*=e,this.tx*=t,this.ty*=e,this._bTransform=!0,this}rotate(t){var e=Math.cos(t),i=Math.sin(t),r=this.a,s=this.c,a=this.tx;return this.a=r*e-this.b*i,this.b=r*i+this.b*e,this.c=s*e-this.d*i,this.d=s*i+this.d*e,this.tx=a*e-this.ty*i,this.ty=a*i+this.ty*e,this._bTransform=!0,this}skew(t,e){var i=Math.tan(t),r=Math.tan(e),s=this.a,a=this.b;return this.a+=r*this.c,this.b+=r*this.d,this.c+=i*s,this.d+=i*a,this}invertTransformPoint(t){var e=this.a,i=this.b,r=this.c,s=this.d,a=this.tx,n=e*s-i*r,h=s/n,o=-i/n,l=-r/n,_=e/n,u=(r*this.ty-s*a)/n,d=-(e*this.ty-i*a)/n;return t.setTo(h*t.x+l*t.y+u,o*t.x+_*t.y+d)}transformPoint(t){return t.setTo(this.a*t.x+this.c*t.y+this.tx,this.b*t.x+this.d*t.y+this.ty)}transformPointN(t){return t.setTo(this.a*t.x+this.c*t.y,this.b*t.x+this.d*t.y)}getScaleX(){return 0===this.b?this.a:Math.sqrt(this.a*this.a+this.b*this.b)}getScaleY(){return 0===this.c?this.d:Math.sqrt(this.c*this.c+this.d*this.d)}invert(){var t=this.a,e=this.b,i=this.c,r=this.d,s=this.tx,a=t*r-e*i;return this.a=r/a,this.b=-e/a,this.c=-i/a,this.d=t/a,this.tx=(i*this.ty-r*s)/a,this.ty=-(t*this.ty-e*s)/a,this}setTo(t,e,i,r,s,a){return this.a=t,this.b=e,this.c=i,this.d=r,this.tx=s,this.ty=a,this}concat(t){var e=this.a,i=this.c,r=this.tx;return this.a=e*t.a+this.b*t.c,this.b=e*t.b+this.b*t.d,this.c=i*t.a+this.d*t.c,this.d=i*t.b+this.d*t.d,this.tx=r*t.a+this.ty*t.c+t.tx,this.ty=r*t.b+this.ty*t.d+t.ty,this}static mul(t,e,i){var r=t.a,s=t.b,a=t.c,n=t.d,h=t.tx,o=t.ty,l=e.a,_=e.b,u=e.c,d=e.d,c=e.tx,p=e.ty;return 0!==_||0!==u?(i.a=r*l+s*u,i.b=r*_+s*d,i.c=a*l+n*u,i.d=a*_+n*d,i.tx=l*h+u*o+c,i.ty=_*h+d*o+p):(i.a=r*l,i.b=s*d,i.c=a*l,i.d=n*d,i.tx=l*h+c,i.ty=d*o+p),i}static mul16(t,e,i){var r=t.a,s=t.b,a=t.c,n=t.d,h=t.tx,o=t.ty,l=e.a,_=e.b,u=e.c,d=e.d,c=e.tx,p=e.ty;return 0!==_||0!==u?(i[0]=r*l+s*u,i[1]=r*_+s*d,i[4]=a*l+n*u,i[5]=a*_+n*d,i[12]=l*h+u*o+c,i[13]=_*h+d*o+p):(i[0]=r*l,i[1]=s*d,i[4]=a*l,i[5]=n*d,i[12]=l*h+c,i[13]=d*o+p),i}scaleEx(t,e){var i=this.a,r=this.b,s=this.c,a=this.d;0!==r||0!==s?(this.a=t*i,this.b=t*r,this.c=e*s,this.d=e*a):(this.a=t*i,this.b=0*a,this.c=0*i,this.d=e*a),this._bTransform=!0}rotateEx(t){var e=Math.cos(t),i=Math.sin(t),r=this.a,s=this.b,a=this.c,n=this.d;0!==s||0!==a?(this.a=e*r+i*a,this.b=e*s+i*n,this.c=-i*r+e*a,this.d=-i*s+e*n):(this.a=e*r,this.b=i*n,this.c=-i*r,this.d=e*n),this._bTransform=!0}clone(){var t=p.create();return t.a=this.a,t.b=this.b,t.c=this.c,t.d=this.d,t.tx=this.tx,t.ty=this.ty,t._bTransform=this._bTransform,t}copyTo(t){return t.a=this.a,t.b=this.b,t.c=this.c,t.d=this.d,t.tx=this.tx,t.ty=this.ty,t._bTransform=this._bTransform,t}toString(){return this.a+","+this.b+","+this.c+","+this.d+","+this.tx+","+this.ty}destroy(){this.recover()}recover(){o.recover("Matrix",this.identity())}static create(){return o.getItemByClass("Matrix",p)}}p.EMPTY=new p,p.TEMP=new p,p._createFun=null;class f{constructor(t=0,e=0){this.x=t,this.y=e}static create(){return o.getItemByClass("Point",f)}setTo(t,e){return this.x=t,this.y=e,this}reset(){return this.x=this.y=0,this}recover(){o.recover("Point",this.reset())}distance(t,e){return Math.sqrt((this.x-t)*(this.x-t)+(this.y-e)*(this.y-e))}toString(){return this.x+","+this.y}normalize(){var t=Math.sqrt(this.x*this.x+this.y*this.y);if(t>0){var e=1/t;this.x*=e,this.y*=e}}copy(t){return this.setTo(t.x,t.y)}}f.TEMP=new f,f.EMPTY=new f;class m{constructor(t=0,e=0,i=0,r=0){this.x=t,this.y=e,this.width=i,this.height=r}get right(){return this.x+this.width}get bottom(){return this.y+this.height}setTo(t,e,i,r){return this.x=t,this.y=e,this.width=i,this.height=r,this}reset(){return this.x=this.y=this.width=this.height=0,this}recover(){this!=m.TEMP&&this!=m.EMPTY&&o.recover("Rectangle",this.reset())}static create(){return o.getItemByClass("Rectangle",m)}copyFrom(t){return this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this}contains(t,e){return!(this.width<=0||this.height<=0)&&(t>=this.x&&t<this.right&&e>=this.y&&e<this.bottom)}intersects(t){return!(t.x>this.x+this.width||t.x+t.width<this.x||t.y>this.y+this.height||t.y+t.height<this.y)}intersection(t,e=null){return this.intersects(t)?(e||(e=new m),e.x=Math.max(this.x,t.x),e.y=Math.max(this.y,t.y),e.width=Math.min(this.right,t.right)-e.x,e.height=Math.min(this.bottom,t.bottom)-e.y,e):null}union(t,e=null){return e||(e=new m),this.clone(e),t.width<=0||t.height<=0?e:(e.addPoint(t.x,t.y),e.addPoint(t.right,t.bottom),this)}clone(t=null){return t||(t=new m),t.x=this.x,t.y=this.y,t.width=this.width,t.height=this.height,t}toString(){return this.x+","+this.y+","+this.width+","+this.height}equals(t){return!(!t||t.x!==this.x||t.y!==this.y||t.width!==this.width||t.height!==this.height)}addPoint(t,e){return this.x>t&&(this.width+=this.x-t,this.x=t),this.y>e&&(this.height+=this.y-e,this.y=e),this.width<t-this.x&&(this.width=t-this.x),this.height<e-this.y&&(this.height=e-this.y),this}_getBoundPoints(){var t=m._temB;return t.length=0,0==this.width||0==this.height||t.push(this.x,this.y,this.x+this.width,this.y,this.x,this.y+this.height,this.x+this.width,this.y+this.height),t}static _getBoundPointS(t,e,i,r,s){var a=m._temA;return a.length=0,0==i||0==r||(s&&(t*=s.width,e*=s.height,i*=s.width,r*=s.height),a.push(t,e,t+i,e,t,e+r,t+i,e+r)),a}static _getWrapRec(t,e=null){if(!t||t.length<1)return e?e.setTo(0,0,0,0):m.TEMP.setTo(0,0,0,0);e=e||m.create();var i,r,s,a,n,h=t.length,o=f.TEMP;for(s=n=-(r=a=99999),i=0;i<h;i+=2)o.x=t[i],o.y=t[i+1],r=r<o.x?r:o.x,a=a<o.y?a:o.y,s=s>o.x?s:o.x,n=n>o.y?n:o.y;return e.setTo(r,a,s-r,n-a)}isEmpty(){return this.width<=0||this.height<=0}}m.EMPTY=new m,m.TEMP=new m,m._temB=[],m._temA=[];class g{}var T,x;t.HDREncodeFormat=void 0,(T=t.HDREncodeFormat||(t.HDREncodeFormat={}))[T.NONE=0]="NONE",T[T.RGBM=1]="RGBM",T[T.RGBD=2]="RGBD",t.TextureFormat=void 0,(x=t.TextureFormat||(t.TextureFormat={}))[x.R8G8B8=0]="R8G8B8",x[x.R8G8B8A8=1]="R8G8B8A8",x[x.R5G6B5=16]="R5G6B5",x[x.Alpha8=2]="Alpha8",x[x.DXT1=3]="DXT1",x[x.DXT3=29]="DXT3",x[x.DXT5=4]="DXT5",x[x.ETC1RGB=5]="ETC1RGB",x[x.ETC2RGB=6]="ETC2RGB",x[x.ETC2RGBA=7]="ETC2RGBA",x[x.ETC2SRGB_Alpha8=8]="ETC2SRGB_Alpha8",x[x.ETC2SRGB=28]="ETC2SRGB",x[x.PVRTCRGB_2BPPV=9]="PVRTCRGB_2BPPV",x[x.PVRTCRGBA_2BPPV=10]="PVRTCRGBA_2BPPV",x[x.PVRTCRGB_4BPPV=11]="PVRTCRGB_4BPPV",x[x.PVRTCRGBA_4BPPV=12]="PVRTCRGBA_4BPPV",x[x.R32G32B32A32=15]="R32G32B32A32",x[x.R32G32B32=30]="R32G32B32",x[x.R16G16B16A16=17]="R16G16B16A16",x[x.R16G16B16=31]="R16G16B16",x[x.ASTC4x4=18]="ASTC4x4",x[x.ASTC4x4SRGB=23]="ASTC4x4SRGB",x[x.ASTC6x6=19]="ASTC6x6",x[x.ASTC6x6SRGB=24]="ASTC6x6SRGB",x[x.ASTC8x8=20]="ASTC8x8",x[x.ASTC8x8SRGB=25]="ASTC8x8SRGB",x[x.ASTC10x10=21]="ASTC10x10",x[x.ASTC10x10SRGB=26]="ASTC10x10SRGB",x[x.ASTC12x12=22]="ASTC12x12",x[x.ASTC12x12SRGB=27]="ASTC12x12SRGB",x[x.KTXTEXTURE=-1]="KTXTEXTURE",x[x.PVRTEXTURE=-2]="PVRTEXTURE";class E{constructor(){this._flag=0,this._items=[]}add(t,e,i){let r=this._items,s=r.findIndex(((i,r,s)=>i==t&&s[r+1]==e));-1!=s?(r[s+2]=i,r[s+3]=1):r.push(t,e,i,1)}once(t,e,i){let r=this._items,s=r.findIndex(((i,r,s)=>i==t&&s[r+1]==e));-1!=s?(r[s+2]=i,r[s+3]=2):r.push(t,e,i,2)}remove(t,e){let i=this._items,r=i.findIndex(((i,r,s)=>i==t&&s[r+1]==e));-1!=r&&(0!=this._flag?(i[r+3]=0,this._flag=2):i.splice(r,4))}clear(){let t=this._items;0!=this._flag?(t.forEach(((t,e,i)=>{e%4==3&&(i[e]=0)})),this._flag=2):t.length=0}clearForTarget(t){if(!t)return;let e=this._items;if(0!=this._flag)e.forEach(((e,i,r)=>{i%4==1&&r[i]==t&&(r[i+2]=0)})),this._flag=2;else{let i=e.length-4;for(;i>=0;)e[i+1]==t&&e.splice(i,4),i-=4}}get count(){return this._items.length/4}invoke(...t){if(0!=this._flag)return;this._flag=1;let e=this._items,i=e.length;for(let r=0;r<i;r+=4){let i=e[r+2];null!=i?e[r].call(e[r+1],...i,...t):e[r].call(e[r+1],...t),2==e[r+3]&&(e[r+3]=0,this._flag=2)}if(2==this._flag){let t=e.length,i=0;for(;i<t;)0!=e[i+3]?i+=4:(e.splice(i,4),t-=4)}this._flag=0}}class y{static isMouseEvent(t){return v.has(t)}constructor(){this.touchId=0,this.touchPos=new f}setTo(t,e,i){return this.type=t,this.currentTarget=e,this.target=i,this}stopPropagation(){this._stopped=!0}get touches(){return this._touches}get button(){var t,e;return null!==(e=null===(t=this.nativeEvent)||void 0===t?void 0:t.button)&&void 0!==e?e:0}get altKey(){var t;return null===(t=this.nativeEvent)||void 0===t?void 0:t.altKey}get ctrlKey(){var t;return null===(t=this.nativeEvent)||void 0===t?void 0:t.ctrlKey}get shiftKey(){var t;return null===(t=this.nativeEvent)||void 0===t?void 0:t.shiftKey}get metaKey(){var t;return null===(t=this.nativeEvent)||void 0===t?void 0:t.metaKey}get key(){return this.nativeEvent.key}get keyCode(){return this.nativeEvent.keyCode}get charCode(){var t;return null===(t=this.nativeEvent)||void 0===t?void 0:t.code}get keyLocation(){return this.nativeEvent?this.nativeEvent.location||this.nativeEvent.keyLocation:0}get stageX(){return this.touchPos.x}get stageY(){return this.touchPos.y}}y.EMPTY=new y,y.MOUSE_DOWN="mousedown",y.MOUSE_UP="mouseup",y.RIGHT_MOUSE_DOWN="rightmousedown",y.RIGHT_MOUSE_UP="rightmouseup",y.CLICK="click",y.RIGHT_CLICK="rightclick",y.MOUSE_MOVE="mousemove",y.MOUSE_OVER="mouseover",y.MOUSE_OUT="mouseout",y.MOUSE_WHEEL="mousewheel",y.ROLL_OVER="mouseover",y.ROLL_OUT="mouseout",y.DOUBLE_CLICK="doubleclick",y.MOUSE_DRAG="mousedrag",y.MOUSE_DRAG_END="mousedragend",y.DRAG_START="dragstart",y.DRAG_MOVE="dragmove",y.DRAG_END="dragend",y.KEY_DOWN="keydown",y.KEY_PRESS="keypress",y.KEY_UP="keyup",y.CHANGE="change",y.CHANGED="changed",y.WILL_RESIZE="willResize",y.RESIZE="resize",y.ADDED="added",y.REMOVED="removed",y.DISPLAY="display",y.UNDISPLAY="undisplay",y.ERROR="error",y.COMPLETE="complete",y.LOADED="loaded",y.READY="ready",y.PROGRESS="progress",y.INPUT="input",y.RENDER="render",y.OPEN="open",y.MESSAGE="message",y.CLOSE="close",y.FRAME="enterframe",y.ENTER="enter",y.SELECT="select",y.BLUR="blur",y.FOCUS="focus",y.VISIBILITY_CHANGE="visibilitychange",y.FOCUS_CHANGE="focuschange",y.PLAYED="played",y.PAUSED="paused",y.STOPPED="stopped",y.START="start",y.END="end",y.LINK="link",y.LABEL="label",y.FULL_SCREEN_CHANGE="fullscreenchange",y.DEVICE_LOST="devicelost",y.TRANSFORM_CHANGED="transformchanged",y.LAYERCHANGE="layerChange",y.staticMask="staticMask",y.TRIGGER_ENTER="triggerenter",y.TRIGGER_STAY="triggerstay",y.TRIGGER_EXIT="triggerexit",y.COLLISION_ENTER="collisionenter",y.COLLISION_STAY="collisionstay",y.COLLISION_EXIT="collisionexit",y.JOINT_BREAK="jointbreak";const v=new Set([y.MOUSE_DOWN,y.MOUSE_UP,y.MOUSE_MOVE,y.CLICK,y.RIGHT_CLICK,y.DOUBLE_CLICK,y.MOUSE_OVER,y.MOUSE_OUT,y.MOUSE_WHEEL]),S=[];class R{onStartListeningToType(t){}hasListener(t){let e=this._events&&this._events[t];return!!e&&e.count>0}event(t,e){let i=this._events&&this._events[t];if(!i)return!1;let r=i.count>0;if(Array.isArray(e))i.invoke(...e);else if(void 0!==e)i.invoke(e);else if(e===y.EMPTY){let e=S.length>0?S.pop():new y;i.invoke(e.setTo(t,this,this)),e.target=e.currentTarget=null,S.push(e)}else i.invoke();return r}on(t,e,i,r){2==arguments.length&&(i=e,e=null),this._events||(this._events={});let s=this._events[t];return s||(this.onStartListeningToType(t),this._events[t]=s=new E),s.add(i,e,r),this}once(t,e,i,r){2==arguments.length&&(i=e,e=null),this._events||(this._events={});let s=this._events[t];return s||(this.onStartListeningToType(t),this._events[t]=s=new E),s.once(i,e,r),this}off(t,e,i){2==arguments.length&&(i=e,e=null);let r=this._events&&this._events[t];return r&&r.remove(i,e),this}offAll(t){if(null==t)this._events=null;else{let e=this._events&&this._events[t];e&&e.clear()}return this}offAllCaller(t){if(t&&this._events)for(let e in this._events)this._events[e].clearForTarget(t);return this}}var b,C,A=0,w=0;class M extends R{static get cpuMemory(){return M._cpuMemory}static get gpuMemory(){return M._gpuMemory}static _addCPUMemory(t){M._cpuMemory+=t}static _addGPUMemory(t){M._gpuMemory+=t}static _addMemory(t,e){M._cpuMemory+=t,M._gpuMemory+=e}static destroyUnusedResources(){w=0,n.loader.loading?n.timer.frameLoop(1,M,M._destroyUnusedResources):M._destroyUnusedResources(!0)}static _destroyUnusedResources(t){if(!t&&n.loader.loading)return;n.timer.clear(M,M._destroyUnusedResources);let e=!0;e=!1;for(let t in M._idResourcesMap){let i=M._idResourcesMap[t];i.lock||0!==i._referenceCount||(i.destroy(),e=!0)}}get id(){return this._id}get cpuMemory(){return this._cpuMemory}get gpuMemory(){return this._gpuMemory}get destroyed(){return this._destroyed}get obsolute(){return this._obsolute}set obsolute(t){this._obsolute=t}get referenceCount(){return this._referenceCount}constructor(t){super(),this._cpuMemory=0,this._gpuMemory=0,this._id=0,this._referenceCount=0,this._id=++A,this._destroyed=!1,this._referenceCount=0,(null==t||t)&&(M._idResourcesMap[this.id]=this),this.lock=!1,this.destoryedImmediately=!0}_setCPUMemory(t){var e=t-this._cpuMemory;this._cpuMemory=t,M._addCPUMemory(e)}_setGPUMemory(t){var e=t-this._gpuMemory;this._gpuMemory=t,M._addGPUMemory(e)}_setCreateURL(t,e){this.url=t,this.uuid=e}isCreateFromURL(t){return this.uuid&&t.length===this.uuid.length+6&&t.endsWith(this.uuid)||this.url===t}_addReference(t=1){this._referenceCount+=t}_removeReference(t=1){this._referenceCount-=t,w>0&&this._referenceCount<=0&&!this.lock&&this.destoryedImmediately&&this.destroy()}_clearReference(){this._referenceCount=0}_recoverResource(){}_disposeResource(){}_activeResource(){}destroy(){this._destroyed||(this._destroyed=!0,this.lock=!1,w++,this._disposeResource(),w--,this.offAll(),delete M._idResourcesMap[this.id],this.url&&(M.DEBUG&&console.debug(`destroy ${Object.getPrototypeOf(this).constructor.name} ${this.url}`),n.loader.clearRes(this.url,this)))}}M._idResourcesMap={},M._cpuMemory=0,M._gpuMemory=0,M.DEBUG=!1;class D extends M{get width(){return this._width}set width(t){this._width=t}get height(){return this._height}set height(t){this._height=t}get dimension(){return this._dimension}get format(){return this._format}get mipmap(){return this._texture.mipmap}get mipmapCount(){return this._texture.mipmapCount}get anisoLevel(){return this._texture.anisoLevel}set anisoLevel(t){this._texture.anisoLevel=t}get filterMode(){return this._texture.filterMode}set filterMode(t){this._texture.filterMode=t}get wrapModeU(){return this._texture.wrapU}set wrapModeU(t){this._texture.wrapU=t}get wrapModeV(){return this._texture.wrapV}set wrapModeV(t){this._texture.wrapV=t}get wrapModeW(){return this._texture.wrapW}set wrapModeW(t){this._texture.wrapW=t}get compareMode(){return this._texture.compareMode}set compareMode(t){this._texture.compareMode=g.textureContext.setTextureCompareMode(this._texture,t)}get gammaCorrection(){return this._texture.gammaCorrection}set baseMipmapLevel(t){this._texture.baseMipmapLevel=t}get baseMipmapLevel(){return this._texture.baseMipmapLevel}set maxMipmapLevel(t){this._texture.maxMipmapLevel=t}get maxMipmapLevel(){return this._texture.maxMipmapLevel}get gammaSpace(){return this._texture.useSRGBLoad||this._texture.gammaCorrection>1}constructor(e,i,r){super(),this._gammaSpace=!1,this._width=e,this._height=i,this._format=r,this.destoryedImmediately=!1,this.hdrEncodeFormat=t.HDREncodeFormat.NONE}gpuCompressFormat(){switch(this._format){case t.TextureFormat.R8G8B8:case t.TextureFormat.R8G8B8A8:case t.TextureFormat.R16G16B16:case t.TextureFormat.R16G16B16A16:case t.TextureFormat.R32G32B32:case t.TextureFormat.R32G32B32A32:case t.TextureFormat.R5G6B5:case t.TextureFormat.Alpha8:return!1;case t.TextureFormat.DXT1:case t.TextureFormat.DXT3:case t.TextureFormat.DXT5:case t.TextureFormat.ETC1RGB:case t.TextureFormat.ETC2RGB:case t.TextureFormat.ETC2RGBA:case t.TextureFormat.ETC2SRGB_Alpha8:case t.TextureFormat.ETC2SRGB:case t.TextureFormat.PVRTCRGB_2BPPV:case t.TextureFormat.PVRTCRGBA_2BPPV:case t.TextureFormat.PVRTCRGB_4BPPV:case t.TextureFormat.PVRTCRGBA_4BPPV:case t.TextureFormat.ASTC4x4:case t.TextureFormat.ASTC4x4SRGB:case t.TextureFormat.ASTC6x6:case t.TextureFormat.ASTC6x6SRGB:case t.TextureFormat.ASTC8x8:case t.TextureFormat.ASTC8x8SRGB:case t.TextureFormat.ASTC10x10:case t.TextureFormat.ASTC10x10SRGB:case t.TextureFormat.ASTC12x12:case t.TextureFormat.ASTC12x12SRGB:return!0;default:return!1}}_getFormatByteCount(){switch(this._format){case t.TextureFormat.R8G8B8:return 3;case t.TextureFormat.R8G8B8A8:return 4;case t.TextureFormat.R5G6B5:case t.TextureFormat.Alpha8:return 1;case t.TextureFormat.R16G16B16A16:return 2;case t.TextureFormat.R32G32B32A32:return 4;default:throw"Texture2D: unknown format."}}_getSource(){return this._texture.resource}get defaultTexture(){throw"defaulte"}_disposeResource(){this._texture.dispose()}}class I{static getSystemEndian(){if(!I._sysEndian){var t=new ArrayBuffer(2);new DataView(t).setInt16(0,256,!0),I._sysEndian=256===new Int16Array(t)[0]?I.LITTLE_ENDIAN:I.BIG_ENDIAN}return I._sysEndian}constructor(t=null){this._xd_=!0,this._allocated_=8,this._pos_=0,this._length=0,t?(this._u8d_=new Uint8Array(t),this._d_=new DataView(this._u8d_.buffer),this._length=this._d_.byteLength):this._resizeBuffer(this._allocated_)}get buffer(){var t=this._d_.buffer;return t.byteLength===this._length?t:t.slice(0,this._length)}get endian(){return this._xd_?I.LITTLE_ENDIAN:I.BIG_ENDIAN}set endian(t){this._xd_=t===I.LITTLE_ENDIAN}set length(t){this._allocated_<t?this._resizeBuffer(this._allocated_=Math.floor(Math.max(t,2*this._allocated_))):this._allocated_>t&&this._resizeBuffer(this._allocated_=t),this._length=t}get length(){return this._length}_resizeBuffer(t){try{var e=new Uint8Array(t);null!=this._u8d_&&(this._u8d_.length<=t?e.set(this._u8d_):e.set(this._u8d_.subarray(0,t))),this._u8d_=e,this._d_=new DataView(e.buffer)}catch(e){throw"Invalid typed array length:"+t}}getString(){return this.readString()}readString(){return this._rUTF(this.getUint16())}getFloat32Array(t,e){return this.readFloat32Array(t,e)}readFloat32Array(t,e){var i=t+e;i=i>this._length?this._length:i;var r=new Float32Array(this._d_.buffer.slice(t,i));return this._pos_=i,r}getUint8Array(t,e){return this.readUint8Array(t,e)}readUint8Array(t,e){var i=t+e;i=i>this._length?this._length:i;var r=new Uint8Array(this._d_.buffer.slice(t,i));return this._pos_=i,r}getInt16Array(t,e){return this.readInt16Array(t,e)}readInt16Array(t,e){var i=t+e;i=i>this._length?this._length:i;var r=new Int16Array(this._d_.buffer.slice(t,i));return this._pos_=i,r}getFloat32(){return this.readFloat32()}readFloat32(){if(this._pos_+4>this._length)throw"getFloat32 error - Out of bounds";var t=this._d_.getFloat32(this._pos_,this._xd_);return this._pos_+=4,t}getFloat64(){return this.readFloat64()}readFloat64(){if(this._pos_+8>this._length)throw"getFloat64 error - Out of bounds";var t=this._d_.getFloat64(this._pos_,this._xd_);return this._pos_+=8,t}writeFloat32(t){this._ensureWrite(this._pos_+4),this._d_.setFloat32(this._pos_,t,this._xd_),this._pos_+=4}writeFloat64(t){this._ensureWrite(this._pos_+8),this._d_.setFloat64(this._pos_,t,this._xd_),this._pos_+=8}getInt32(){return this.readInt32()}readInt32(){if(this._pos_+4>this._length)throw"getInt32 error - Out of bounds";var t=this._d_.getInt32(this._pos_,this._xd_);return this._pos_+=4,t}getUint32(){return this.readUint32()}readUint32(){if(this._pos_+4>this._length)throw"getUint32 error - Out of bounds";var t=this._d_.getUint32(this._pos_,this._xd_);return this._pos_+=4,t}writeInt32(t){this._ensureWrite(this._pos_+4),this._d_.setInt32(this._pos_,t,this._xd_),this._pos_+=4}writeUint32(t){this._ensureWrite(this._pos_+4),this._d_.setUint32(this._pos_,t,this._xd_),this._pos_+=4}getInt16(){return this.readInt16()}readInt16(){if(this._pos_+2>this._length)throw"getInt16 error - Out of bounds";var t=this._d_.getInt16(this._pos_,this._xd_);return this._pos_+=2,t}getUint16(){return this.readUint16()}readUint16(){if(this._pos_+2>this._length)throw"getUint16 error - Out of bounds";var t=this._d_.getUint16(this._pos_,this._xd_);return this._pos_+=2,t}writeUint16(t){this._ensureWrite(this._pos_+2),this._d_.setUint16(this._pos_,t,this._xd_),this._pos_+=2}writeInt16(t){this._ensureWrite(this._pos_+2),this._d_.setInt16(this._pos_,t,this._xd_),this._pos_+=2}getUint8(){return this.readUint8()}readUint8(){if(this._pos_+1>this._length)throw"getUint8 error - Out of bounds";return this._u8d_[this._pos_++]}writeUint8(t){this._ensureWrite(this._pos_+1),this._d_.setUint8(this._pos_,t),this._pos_++}_getUInt8(t){return this._readUInt8(t)}_readUInt8(t){return this._d_.getUint8(t)}_getUint16(t){return this._readUint16(t)}_readUint16(t){return this._d_.getUint16(t,this._xd_)}_getMatrix(){return this._readMatrix()}_readMatrix(){return new p(this.getFloat32(),this.getFloat32(),this.getFloat32(),this.getFloat32(),this.getFloat32(),this.getFloat32())}_rUTF(t){var e,i,r=this._pos_+t,s=String.fromCharCode,a=this._u8d_,n=[],h=0;for(n.length=1e3;this._pos_<r;)if((e=a[this._pos_++])<128)0!=e&&(n[h++]=s(e));else if(e<224)n[h++]=s((63&e)<<6|127&a[this._pos_++]);else if(e<240)i=a[this._pos_++],n[h++]=s((31&e)<<12|(127&i)<<6|127&a[this._pos_++]);else{const t=(15&e)<<18|(127&(i=a[this._pos_++]))<<12|(127&a[this._pos_++])<<6|127&a[this._pos_++];if(t>=65536){const e=t-65536,i=55296|e>>10,r=56320|1023&e;n[h++]=s(i),n[h++]=s(r)}else n[h++]=s(t)}return n.length=h,n.join("")}getCustomString(t){return this.readCustomString(t)}readCustomString(t){for(var e,i="",r=0,s=String.fromCharCode,a=this._u8d_;t>0;)if((e=a[this._pos_])<128)i+=s(e),this._pos_++,t--;else for(r=e-128,this._pos_++,t-=r;r>0;)e=a[this._pos_++],i+=s(a[this._pos_++]<<8|e),r--;return i}get pos(){return this._pos_}set pos(t){this._pos_=t}get bytesAvailable(){return this._length-this._pos_}clear(){this._pos_=0,this.length=0}__getBuffer(){return this._d_.buffer}writeUTFBytes(t){for(var e=0,i=(t+="").length;e<i;e++){var r=t.charCodeAt(e);if(r<=127)this.writeByte(r);else if(r<=2047)this._ensureWrite(this._pos_+2),this._u8d_.set([192|r>>6,128|63&r],this._pos_),this._pos_+=2;else if(r>=55296&&r<=56319){e++;const i=t.charCodeAt(e);if(!Number.isNaN(i)&&i>=56320&&i<=57343){const t=64+(1023&r),e=1023&i,s=240|t>>8&63,a=128|t>>2&63,n=128|(3&t)<<4|e>>6&15,h=128|63&e;this._ensureWrite(this._pos_+4),this._u8d_.set([s,a,n,h],this._pos_),this._pos_+=4}}else r<=65535?(this._ensureWrite(this._pos_+3),this._u8d_.set([224|r>>12,128|r>>6&63,128|63&r],this._pos_),this._pos_+=3):(this._ensureWrite(this._pos_+4),this._u8d_.set([240|r>>18,128|r>>12&63,128|r>>6&63,128|63&r],this._pos_),this._pos_+=4)}}writeUTFString(t){var e=this.pos;this.writeUint16(1),this.writeUTFBytes(t);var i=this.pos-e-2;this._d_.setUint16(e,i,this._xd_)}writeUTFString32(t){var e=this.pos;this.writeUint32(1),this.writeUTFBytes(t);var i=this.pos-e-4;this._d_.setUint32(e,i,this._xd_)}readUTFString(){return this.readUTFBytes(this.getUint16())}readUTFString32(){return this.readUTFBytes(this.getUint32())}getUTFString(){return this.readUTFString()}readUTFBytes(t=-1){if(0===t)return"";var e=this.bytesAvailable;if(t>e)throw"readUTFBytes error - Out of bounds";return t=t>0?t:e,this._rUTF(t)}getUTFBytes(t=-1){return this.readUTFBytes(t)}writeByte(t){this._ensureWrite(this._pos_+1),this._d_.setInt8(this._pos_,t),this._pos_+=1}readByte(){if(this._pos_+1>this._length)throw"readByte error - Out of bounds";return this._d_.getInt8(this._pos_++)}getByte(){return this.readByte()}_ensureWrite(t){this._length<t&&(this._length=t),this._allocated_<t&&(this.length=t)}writeArrayBuffer(t,e=0,i=0){if(e<0||i<0)throw"writeArrayBuffer error - Out of bounds";0==i&&(i=t.byteLength-e),this._ensureWrite(this._pos_+i);var r=new Uint8Array(t);this._u8d_.set(r.subarray(e,e+i),this._pos_),this._pos_+=i}readArrayBuffer(t){var e;return e=this._u8d_.buffer.slice(this._pos_,this._pos_+t),this._pos_=this._pos_+t,e}}I.BIG_ENDIAN="bigEndian",I.LITTLE_ENDIAN="littleEndian",I._sysEndian=null;class P{static __init__(){for(var t=0;t<256;++t){var e=t-127;e<-27?(P._baseTable[0|t]=0,P._baseTable[256|t]=32768,P._shiftTable[0|t]=24,P._shiftTable[256|t]=24):e<-14?(P._baseTable[0|t]=1024>>-e-14,P._baseTable[256|t]=1024>>-e-14|32768,P._shiftTable[0|t]=-e-1,P._shiftTable[256|t]=-e-1):e<=15?(P._baseTable[0|t]=e+15<<10,P._baseTable[256|t]=e+15<<10|32768,P._shiftTable[0|t]=13,P._shiftTable[256|t]=13):e<128?(P._baseTable[0|t]=31744,P._baseTable[256|t]=64512,P._shiftTable[0|t]=24,P._shiftTable[256|t]=24):(P._baseTable[0|t]=31744,P._baseTable[256|t]=64512,P._shiftTable[0|t]=13,P._shiftTable[256|t]=13)}for(P._mantissaTable[0]=0,t=1;t<1024;++t){var i=t<<13;for(e=0;0==(8388608&i);)e-=8388608,i<<=1;i&=-8388609,e+=947912704,P._mantissaTable[t]=i|e}for(t=1024;t<2048;++t)P._mantissaTable[t]=939524096+(t-1024<<13);for(P._exponentTable[0]=0,t=1;t<31;++t)P._exponentTable[t]=t<<23;for(P._exponentTable[31]=1199570944,P._exponentTable[32]=2147483648,t=33;t<63;++t)P._exponentTable[t]=2147483648+(t-32<<23);for(P._exponentTable[63]=3347054592,P._offsetTable[0]=0,t=1;t<64;++t)P._offsetTable[t]=32===t?0:1024}static roundToFloat16Bits(t){P._floatView[0]=t;var e=P._uint32View[0],i=e>>23&511;return P._baseTable[i]+((8388607&e)>>P._shiftTable[i])}static convertToNumber(t){var e=t>>10;return P._uint32View[0]=P._mantissaTable[P._offsetTable[e]+(1023&t)]+P._exponentTable[e],P._floatView[0]}}P._buffer=new ArrayBuffer(4),P._floatView=new Float32Array(P._buffer),P._uint32View=new Uint32Array(P._buffer),P._baseTable=new Uint32Array(512),P._shiftTable=new Uint32Array(512),P._mantissaTable=new Uint32Array(2048),P._exponentTable=new Uint32Array(64),P._offsetTable=new Uint32Array(64),t.FilterMode=void 0,(b=t.FilterMode||(t.FilterMode={}))[b.Point=0]="Point",b[b.Bilinear=1]="Bilinear",b[b.Trilinear=2]="Trilinear",t.RenderCapable=void 0,(C=t.RenderCapable||(t.RenderCapable={}))[C.Element_Index_Uint32=0]="Element_Index_Uint32",C[C.TextureFormat_R32G32B32A32=1]="TextureFormat_R32G32B32A32",C[C.TextureFormat_R16G16B16A16=2]="TextureFormat_R16G16B16A16",C[C.Texture_anisotropic=3]="Texture_anisotropic",C[C.RenderTextureFormat_R16G16B16A16=4]="RenderTextureFormat_R16G16B16A16",C[C.RenderTextureFormat_Depth=5]="RenderTextureFormat_Depth",C[C.RenderTextureFormat_ShadowMap=6]="RenderTextureFormat_ShadowMap",C[C.Vertex_VAO=7]="Vertex_VAO",C[C.DrawElement_Instance=8]="DrawElement_Instance",C[C.Shader_TextureLod=9]="Shader_TextureLod",C[C.COMPRESS_TEXTURE_S3TC=10]="COMPRESS_TEXTURE_S3TC",C[C.COMPRESS_TEXTURE_S3TC_SRGB=11]="COMPRESS_TEXTURE_S3TC_SRGB",C[C.COMPRESS_TEXTURE_PVRTC=12]="COMPRESS_TEXTURE_PVRTC",C[C.COMPRESS_TEXTURE_ETC1=13]="COMPRESS_TEXTURE_ETC1",C[C.COMPRESS_TEXTURE_ETC=14]="COMPRESS_TEXTURE_ETC",C[C.COMPRESS_TEXTURE_ASTC=15]="COMPRESS_TEXTURE_ASTC",C[C.Texture_SRGB=16]="Texture_SRGB",C[C.MSAA=17]="MSAA",C[C.UnifromBufferObject=18]="UnifromBufferObject",C[C.GRAPHICS_API_GLES3=19]="GRAPHICS_API_GLES3";const B=827611204,L=861165636,F=894720068,O=131072;class N{constructor(t,e,i,r,s,a,n,h,o,l){this.width=t,this.height=e,this.mipmapCount=i,this.isCube=r,this.blockBytes=a,this.dataOffset=n,this.format=h,this.source=l,this.bpp=s,this.compressed=o}static getDDSTextureInfo(e){let i=new Int32Array(e,0,31),r=i[4],s=i[3],a=1;131072&i[2]&&(a=Math.max(1,i[7]));let n=i[21],h=4==(4&i[20]),o=64==(64&i[20]),l=(i[20]&O)===O,_=512==(512&i[28]),u=n===B||n===L||n===F,d=t.TextureFormat.DXT1,c=i[1]+4,p=1;switch(n){case B:d=t.TextureFormat.DXT1,p=8;break;case L:d=t.TextureFormat.DXT3,p=16;break;case F:d=t.TextureFormat.DXT5,p=16;break;case 113:d=t.TextureFormat.R16G16B16A16,p=4;break;case 116:d=t.TextureFormat.R32G32B32A32,p=4;break;default:throw"Unsupported format "+(f=n,String.fromCharCode(255&f,f>>8&255,f>>16&255,f>>24&255))}var f;if(542327876!==i[0])throw"Invalid magic number in DDS header";if(!h&&!o&&!l)throw"Unsupported format, must contain a FourCC, RGB or LUMINANCE code";let m=g.renderEngine.getCapable(t.RenderCapable.COMPRESS_TEXTURE_S3TC)||g.renderEngine.getCapable(t.RenderCapable.COMPRESS_TEXTURE_S3TC_SRGB);if(u&&!m)throw"Compressed textures are not supported on this platform.";return new N(r,s,a,_,0,p,c,d,u,e)}}var U;t.TextureDimension=void 0,(U=t.TextureDimension||(t.TextureDimension={}))[U.Tex2D=0]="Tex2D",U[U.Cube=1]="Cube",U[U.Tex3D=2]="Tex3D",U[U.Texture2DArray=3]="Texture2DArray",U[U.CubeArray=4]="CubeArray",U[U.Unkonw=5]="Unkonw",U[U.None=6]="None";const G=6408,k=6407,W=5121;class V{static getLayaFormat(e,i,r,s){if(0!=e){if(e==G&&32856==i&&r==W)return{format:t.TextureFormat.R8G8B8A8,sRGB:!1};if(e==G&&35907==i&&r==W)return{format:t.TextureFormat.R8G8B8A8,sRGB:!0};if(e==G&&34836==i&&5126==r)return{format:t.TextureFormat.R32G32B32A32,sRGB:!1};if(e==G&&34842==i&&5131==r)return{format:t.TextureFormat.R16G16B16A16,sRGB:!1};if(e==k&&34837==i&&5126==r)return{format:t.TextureFormat.R32G32B32,sRGB:!1};if(e==k&&34843==i&&5131==r)return{format:t.TextureFormat.R16G16B16,sRGB:!1};if(e==k&&35905==i&&r==W)return{format:t.TextureFormat.R8G8B8,sRGB:!0};if(e==k&&32849==i&&r==W)return{format:t.TextureFormat.R8G8B8,sRGB:!1};throw"ktx: Unsupported UnCompressed image data."}switch(i){case 36196:return{format:t.TextureFormat.ETC1RGB,sRGB:!1};case 37496:return{format:t.TextureFormat.ETC2RGBA,sRGB:!1};case 37492:return{format:t.TextureFormat.ETC2RGB,sRGB:!1};case 37497:return{format:t.TextureFormat.ETC2SRGB_Alpha8,sRGB:!0};case 37493:return{format:t.TextureFormat.ETC2SRGB,sRGB:!0};case 37808:return{format:t.TextureFormat.ASTC4x4,sRGB:!1};case 37812:return{format:t.TextureFormat.ASTC6x6,sRGB:!1};case 37815:return{format:t.TextureFormat.ASTC8x8,sRGB:!1};case 37819:return{format:t.TextureFormat.ASTC10x10,sRGB:!1};case 37821:return{format:t.TextureFormat.ASTC12x12,sRGB:!1};case 37840:return{format:t.TextureFormat.ASTC4x4SRGB,sRGB:!0};case 37844:return{format:t.TextureFormat.ASTC6x6SRGB,sRGB:!0};case 37847:return{format:t.TextureFormat.ASTC8x8SRGB,sRGB:!0};case 37851:return{format:t.TextureFormat.ASTC10x10SRGB,sRGB:!0};case 37853:return{format:t.TextureFormat.ASTC12x12SRGB,sRGB:!0};default:throw"KTX: UnSupported Compressed format."}}static getKTXTextureInfo(t){let e=new Uint8Array(t,0,12);if(171===e[0]&&75===e[1]&&84===e[2]&&88===e[3]&&32===e[4]&&50===e[5]&&48===e[6]&&187===e[7]&&13===e[8]&&10===e[9]&&26===e[10]&&10===e[11])throw"ktx2 !";if(171===e[0]&&75===e[1]&&84===e[2]&&88===e[3]&&32===e[4]&&49===e[5]&&49===e[6]&&187===e[7]&&13===e[8]&&10===e[9]&&26===e[10]&&10===e[11])return V.createKTX1Info(t);throw"ktx data wrong, not ktx1 or ktx2 buffer!"}static createKTX1Info(e){let i=Uint32Array.BYTES_PER_ELEMENT,r=new DataView(e,12,13*i),s=67305985==r.getUint32(0,!0),a=r.getUint32(1*i,s),n=r.getUint32(2*i,s),h=r.getUint32(3*i,s),o=r.getUint32(4*i,s);r.getUint32(5*i,s);let l=r.getUint32(6*i,s),_=r.getUint32(7*i,s);r.getUint32(8*i,s);let u=r.getUint32(9*i,s),d=r.getUint32(10*i,s),c=r.getUint32(11*i,s),p=r.getUint32(12*i,s),f=V.getLayaFormat(h,o,a,n),m=f.format,g=f.sRGB,T=t.TextureDimension.Tex2D;d>1&&u>1?T=t.TextureDimension.CubeArray:d>1&&u<=1?T=t.TextureDimension.Cube:d<=1&&u>1&&(T=t.TextureDimension.Texture2DArray);return new V(e,0==h,g,T,l,_,m,c||1,p,64)}constructor(t,e,i,r,s,a,n,h,o,l){this.source=t,this.compress=e,this.sRGB=i,this.dimension=r,this.width=s,this.height=a,this.format=n,this.mipmapCount=h,this.bytesOfKeyValueData=o,this.headerOffset=l}}class X extends D{static __init__(){var e=new Uint8Array(3);if(e[0]=128,e[1]=128,e[2]=128,X.grayTexture=new X(1,1,t.TextureFormat.R8G8B8,!1,!1),X.grayTexture.setPixelsData(e,!1,!1),X.grayTexture.lock=!0,e[0]=255,e[1]=255,e[2]=255,X.whiteTexture=new X(1,1,t.TextureFormat.R8G8B8,!1,!1),X.whiteTexture.setPixelsData(e,!1,!1),X.whiteTexture.lock=!0,e[0]=0,e[1]=0,e[2]=0,X.blackTexture=new X(1,1,t.TextureFormat.R8G8B8,!1,!1),X.blackTexture.setPixelsData(e,!1,!1),X.blackTexture.lock=!0,g.renderEngine.getCapable(t.RenderCapable.TextureFormat_R16G16B16A16)){let e=new Uint16Array(3);e[0]=14336,e[1]=14336,e[1]=15360,X.normalTexture=new X(1,1,t.TextureFormat.R16G16B16,!1,!1,!1),X.normalTexture.setPixelsData(e,!1,!1)}else e[0]=128,e[1]=128,e[2]=255,X.normalTexture=new X(1,1,t.TextureFormat.R8G8B8,!1,!1,!1),X.normalTexture.setPixelsData(e,!1,!1);X.normalTexture.lock=!0,X.erroTextur=X.whiteTexture}static _SimpleAnimatorTextureParse(e,i=null,r=null){var s,a,n=new I(e);switch(n.readUTFString()){case"LAYAANIMATORTEXTURE:0000":var h,o=n.readInt32(),l=n.readInt32();s=new Float32Array(o*o*4),a=new Float32Array(n.readArrayBuffer(4*l)),s.set(a,0),(h=new X(o,o,t.TextureFormat.R32G32B32A32,!1,!1)).setPixelsData(s,!1,!1),h.filterMode=t.FilterMode.Point;break;case"LAYACOMPRESSANIMATORTEXTURE:0000":o=n.readInt32(),l=n.readInt32();if(s=new Uint16Array(n.readArrayBuffer(2*l)),g.renderEngine.getCapable(t.RenderCapable.TextureFormat_R16G16B16A16))(a=new Uint16Array(o*o*4)).set(s,0),(h=new X(o,o,t.TextureFormat.R16G16B16A16,!1,!1)).setPixelsData(a,!1,!1),h.filterMode=t.FilterMode.Point;else{console.log("The platform does not support 16-bit floating-point textures"),g.renderEngine.getCapable(t.RenderCapable.TextureFormat_R32G32B32A32)||console.error("The platform does not support 32-bit floating-point textures"),a=new Float32Array(o*o*4);for(var _=0,u=s.length;_<u;_++)a[_]=P.convertToNumber(s[_]);(h=new X(o,o,t.TextureFormat.R32G32B32A32,!1,!1)).setPixelsData(a,!1,!1),h.filterMode=t.FilterMode.Point}break;default:throw"Laya3D:unknow version."}return h}static _parseImage(e,i=null,r=null){let s=r?r[2]:t.TextureFormat.R8G8B8A8,a=!r||r[3],o=!!r&&r[4],l=!!r&&r[5],_=new X(e.width,e.height,s,a,o,l);if(i){let t=i.premultiplyAlpha;_.setImageData(e,t,!1),_.setProperties(i)}else _.setImageData(e,!1,!1);return o&&(h.isConch&&e._nativeObj?_._pixels=new Uint8Array(e._nativeObj.getImageData(0,0,e.width,e.height)):(n.Browser.canvas.size(e.width,e.height),n.Browser.canvas.clear(),n.Browser.context.drawImage(e,0,0,e.width,e.height),_._pixels=new Uint8Array(n.Browser.context.getImageData(0,0,e.width,e.height).data.buffer))),_}static _parseDDS(t,e=null,i=null){let r=N.getDDSTextureInfo(t),s=new X(r.width,r.height,r.format,r.mipmapCount>1,!1,!1);return s.setDDSData(r),e&&s.setProperties(e),s}static _parseKTX(t,e=null,i=null){let r=V.getKTXTextureInfo(t),s=new X(r.width,r.height,r.format,r.mipmapCount>1,!1,r.sRGB);return s.setKTXData(r),e&&s.setProperties(e),s}static _parsePVR(t,e=null,i=null){throw"pvr !"}static load(t,e){n.loader.load(t,e,null,n.Loader.TEXTURE2D)}constructor(e,i,r,s=!0,a,n=!1){super(e,i,r),this._canRead=!1,this._dimension=t.TextureDimension.Tex2D,this._gammaSpace=n,this._canRead=a,this._texture=g.textureContext.createTextureInternal(this._dimension,e,i,r,s,n)}setImageData(t,e,i){let r=this._texture;g.textureContext.setTextureImageData(r,t,e,i)}setPixelsData(t,e,i){let r=this._texture;g.textureContext.setTexturePixelsData(r,t,e,i)}setSubPixelsData(t,e,i,r,s,a,n,h,o){let l=this._texture;g.textureContext.setTextureSubPixelsData(l,s,a,n,t,e,i,r,h,o)}setDDSData(t){let e=this._texture;g.textureContext.setTextureDDSData(e,t)}setKTXData(t){let e=this._texture;g.textureContext.setTextureKTXData(e,t)}setHDRData(t){let e=this._texture;g.textureContext.setTextureHDRData(e,t)}get defaultTexture(){return X.grayTexture}getPixels(){if(this._canRead&&this._pixels)return this._pixels;throw new Error("Texture2D: must set texture canRead is true.")}setProperties(t){t&&(null!=t.wrapModeU&&(this.wrapModeU=t.wrapModeU),null!=t.wrapModeV&&(this.wrapModeV=t.wrapModeV),null!=t.filterMode&&(this.filterMode=t.filterMode),null!=t.anisoLevel&&(this.anisoLevel=t.anisoLevel))}}X.TEXTURE2D="TEXTURE2D",X.grayTexture=null,X.whiteTexture=null,X.blackTexture=null,X.normalTexture=null,X.erroTextur=null;class H extends M{constructor(){super()}}class Y{static mat2MatArray(t,e){var i=t,r=e;return r[0]=i.a,r[1]=i.b,r[2]=Y.EMPTYMAT4_ARRAY[2],r[3]=Y.EMPTYMAT4_ARRAY[3],r[4]=i.c,r[5]=i.d,r[6]=Y.EMPTYMAT4_ARRAY[6],r[7]=Y.EMPTYMAT4_ARRAY[7],r[8]=Y.EMPTYMAT4_ARRAY[8],r[9]=Y.EMPTYMAT4_ARRAY[9],r[10]=Y.EMPTYMAT4_ARRAY[10],r[11]=Y.EMPTYMAT4_ARRAY[11],r[12]=i.tx,r[13]=i.ty,r[14]=Y.EMPTYMAT4_ARRAY[14],r[15]=Y.EMPTYMAT4_ARRAY[15],e}static restoreTempArray(){Y.TEMPMAT4_ARRAY[0]=1,Y.TEMPMAT4_ARRAY[1]=0,Y.TEMPMAT4_ARRAY[4]=0,Y.TEMPMAT4_ARRAY[5]=1,Y.TEMPMAT4_ARRAY[12]=0,Y.TEMPMAT4_ARRAY[13]=0}static clear(){Y.worldScissorTest=!1,Y.worldAlpha=1}}var z,j,K,q,$;Y._MAXSIZE=99999999,Y.EMPTYMAT4_ARRAY=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],Y.TEMPMAT4_ARRAY=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],Y.worldMatrix4=Y.TEMPMAT4_ARRAY,Y.worldMatrix=new p,Y.matWVP=null,Y.worldAlpha=1,Y.worldScissorTest=!1,Y.width=0,Y.height=0,Y.InvertY=!1,t.RenderTargetFormat=void 0,(z=t.RenderTargetFormat||(t.RenderTargetFormat={}))[z.None=-1]="None",z[z.R8G8B8=0]="R8G8B8",z[z.R8G8B8A8=1]="R8G8B8A8",z[z.R16G16B16A16=17]="R16G16B16A16",z[z.R32G32B32=30]="R32G32B32",z[z.R32G32B32A32=15]="R32G32B32A32",z[z.R16G16B16=31]="R16G16B16",z[z.DEPTH_16=35]="DEPTH_16",z[z.STENCIL_8=36]="STENCIL_8",z[z.DEPTHSTENCIL_24_8=37]="DEPTHSTENCIL_24_8",z[z.DEPTH_32=38]="DEPTH_32",t.RenderClearFlag=void 0,(j=t.RenderClearFlag||(t.RenderClearFlag={}))[j.Nothing=0]="Nothing",j[j.Color=1]="Color",j[j.Depth=2]="Depth",j[j.Stencil=4]="Stencil";class Z{static gammaToLinearSpace(t){return t<=.04045?t/12.92:t<1?Math.pow((t+.055)/1.055,2.4):Math.pow(t,2.4)}static linearToGammaSpace(t){return t<=0?0:t<=.0031308?12.92*t:t<=1?1.055*Math.pow(t,.41666)-.055:Math.pow(t,.41666)}constructor(t=1,e=1,i=1,r=1){this.r=t,this.g=e,this.b=i,this.a=r}equal(t){if(!t)return!1;const toFIxed=(t,e)=>{var i=1e-5;return-i<t-e&&t-e<i};return toFIxed(t.r,this.r)&&toFIxed(t.g,this.g)&&toFIxed(t.b,this.b)&&toFIxed(t.a,this.a)}toLinear(t){t.r=Z.gammaToLinearSpace(this.r),t.g=Z.gammaToLinearSpace(this.g),t.b=Z.gammaToLinearSpace(this.b),t.a=this.a}toGamma(t){t.r=Z.linearToGammaSpace(this.r),t.g=Z.linearToGammaSpace(this.g),t.b=Z.linearToGammaSpace(this.b),t.a=this.a}cloneTo(t){var e=t;e.r=this.r,e.g=this.g,e.b=this.b,e.a=this.a}scale(t){return this.r=this.r*t,this.g=this.g*t,this.b=this.b*t,this}setValue(t,e,i,r){this.r=t,this.g=e,this.b=i,this.a=r}fromArray(t,e=0){this.r=t[e+0],this.g=t[e+1],this.b=t[e+2],this.a=t[e+3]}toArray(){return[this.r,this.g,this.b,this.a]}clone(){var t=new Z;return this.cloneTo(t),t}}Z.RED=new Z(1,0,0,1),Z.GREEN=new Z(0,1,0,1),Z.BLUE=new Z(0,0,1,1),Z.CYAN=new Z(0,1,1,1),Z.YELLOW=new Z(1,.92,.016,1),Z.MAGENTA=new Z(1,0,1,1),Z.GRAY=new Z(.5,.5,.5,1),Z.WHITE=new Z(1,1,1,1),Z.BLACK=new Z(0,0,0,1),Z.CLEAR=new Z(0,0,0,0);class Q extends D{static get currentActive(){return Q._currentActive}get depthStencilFormat(){return this._depthStencilFormat}get defaultTexture(){return X.grayTexture}getIsReady(){return!0}get sourceWidth(){return this._width}get sourceHeight(){return this._height}get offsetX(){return 0}get offsetY(){return 0}constructor(e,i,r=t.RenderTargetFormat.R8G8B8,s=t.RenderTargetFormat.DEPTH_16,a=!0){super(e,i,r),this._mgrKey=0,this._colorFormat=r,this._depthStencilFormat=s,0!=e&&0!=i&&a&&this._create(),this.lock=!0}get isCube(){return this._nativeObj.isCube}get samples(){return this._nativeObj.samples}get generateMipmap(){return this._nativeObj.generateMipmap}_start(){throw new Error("Method not implemented.")}_end(){throw new Error("Method not implemented.")}_create(){this._nativeObj=new window.conchRenderTexture2D(g.renderEngine._nativeObj,this.width,this.height,this._colorFormat,this.depthStencilFormat),this._texture=this._nativeObj._renderTarget._textures[0]}static pushRT(){throw new Error("Method not implemented.")}static popRT(){throw new Error("Method not implemented.")}start(){this._nativeObj.start()}end(){this._nativeObj.end()}restore(){this._nativeObj.restore()}clear(t=0,e=0,i=0,r=1){this._nativeObj.clear(t,e,i,r)}getData(t,e,i,r){return this._nativeObj.getData(t,e,i,r)}recycle(){}_disposeResource(){this._nativeObj._disposeResource()}}Q._clearColor=new Z,Q.rtStack=[],Q.defuv=[0,0,1,0,1,1,0,1],Q.flipyuv=[0,1,1,1,1,0,0,0];class J extends D{static get currentActive(){return J._currentActive}get depthStencilFormat(){return this._depthStencilFormat}get defaultTexture(){return X.grayTexture}getIsReady(){return!0}get sourceWidth(){return this._width}get sourceHeight(){return this._height}get offsetX(){return 0}get offsetY(){return 0}constructor(e,i,r=t.RenderTargetFormat.R8G8B8,s=t.RenderTargetFormat.None){super(e,i,r),this._mgrKey=0,this._colorFormat=r,this._depthStencilFormat=s,0!=e&&0!=i&&this._create(),this.lock=!0}get isCube(){return this._renderTarget._isCube}get samples(){return this._renderTarget._samples}get generateMipmap(){return this._renderTarget._generateMipmap}_start(){throw new Error("Method not implemented.")}_end(){throw new Error("Method not implemented.")}_create(){this._renderTarget=g.textureContext.createRenderTargetInternal(this.width,this.height,this._colorFormat,this.depthStencilFormat,!1,!0,1),this._texture=this._renderTarget._textures[0]}static pushRT(){J.rtStack.push({rt:J._currentActive,w:Y.width,h:Y.height})}static popRT(){var t=J.rtStack.pop();t&&(J._currentActive!=t.rt&&(t.rt?g.textureContext.bindRenderTarget(t.rt._renderTarget):g.textureContext.bindoutScreenTarget(),J._currentActive=t.rt),g.renderEngine.viewport(0,0,t.w,t.h),Y.width=t.w,Y.height=t.h)}start(){g.textureContext.bindRenderTarget(this._renderTarget),this._lastRT=J._currentActive,J._currentActive=this,g.renderEngine.viewport(0,0,this._width,this._height),this._lastWidth=Y.width,this._lastHeight=Y.height,Y.width=this._width,Y.height=this._height,H.activeShader=null}end(){g.textureContext.unbindRenderTarget(this._renderTarget),J._currentActive=null}restore(){this._lastRT!=J._currentActive&&(this._lastRT?g.textureContext.bindRenderTarget(this._lastRT._renderTarget):g.textureContext.unbindRenderTarget(this._renderTarget),J._currentActive=this._lastRT),g.renderEngine.viewport(0,0,this._lastWidth,this._lastHeight),Y.width=this._lastWidth,Y.height=this._lastHeight,H.activeShader=null}clear(e=0,i=0,r=0,s=1){J._clearColor.r=e,J._clearColor.g=i,J._clearColor.b=r,J._clearColor.a=s,J._clearColor.toLinear(J._clearLinearColor),g.renderEngine.clearRenderTexture(t.RenderClearFlag.Color|t.RenderClearFlag.Depth,J._clearLinearColor,1)}getData(t,e,i,r){return g.textureContext.getRenderTextureData(this._renderTarget,t,e,i,r)}recycle(){}_disposeResource(){this._renderTarget&&this._renderTarget.dispose()}}J._clearColor=new Z,J._clearLinearColor=new Z,J.rtStack=[],J.defuv=[0,0,1,0,1,1,0,1],J.flipyuv=[0,1,1,1,1,0,0,0],window.conch&&!window.conchConfig.conchWebGL&&(J=Q);class tt{static getRT(e,i){return i|=0,(e|=0)>=1e4&&console.error("getRT error! w too big"),new J(e,i,t.RenderTargetFormat.R8G8B8A8,t.RenderTargetFormat.None)}static releaseRT(t){t.destroy()}}tt.dict={},t.BlendFactor=void 0,(K=t.BlendFactor||(t.BlendFactor={}))[K.Zero=0]="Zero",K[K.One=1]="One",K[K.SourceColor=2]="SourceColor",K[K.OneMinusSourceColor=3]="OneMinusSourceColor",K[K.DestinationColor=4]="DestinationColor",K[K.OneMinusDestinationColor=5]="OneMinusDestinationColor",K[K.SourceAlpha=6]="SourceAlpha",K[K.OneMinusSourceAlpha=7]="OneMinusSourceAlpha",K[K.DestinationAlpha=8]="DestinationAlpha",K[K.OneMinusDestinationAlpha=9]="OneMinusDestinationAlpha",K[K.SourceAlphaSaturate=10]="SourceAlphaSaturate",K[K.BlendColor=11]="BlendColor",K[K.OneMinusBlendColor=12]="OneMinusBlendColor",t.BlendType=void 0,(q=t.BlendType||(t.BlendType={}))[q.BLEND_DISABLE=0]="BLEND_DISABLE",q[q.BLEND_ENABLE_ALL=1]="BLEND_ENABLE_ALL",q[q.BLEND_ENABLE_SEPERATE=2]="BLEND_ENABLE_SEPERATE",t.RenderStateType=void 0,($=t.RenderStateType||(t.RenderStateType={}))[$.DepthTest=0]="DepthTest",$[$.DepthMask=1]="DepthMask",$[$.DepthFunc=2]="DepthFunc",$[$.StencilTest=3]="StencilTest",$[$.StencilMask=4]="StencilMask",$[$.StencilFunc=5]="StencilFunc",$[$.StencilOp=6]="StencilOp",$[$.BlendType=7]="BlendType",$[$.BlendEquation=8]="BlendEquation",$[$.BlendEquationSeparate=9]="BlendEquationSeparate",$[$.BlendFunc=10]="BlendFunc",$[$.BlendFuncSeperate=11]="BlendFuncSeperate",$[$.CullFace=12]="CullFace",$[$.FrontFace=13]="FrontFace";class et{static __init__(){et.DepthTestCMD=g.renderEngine.createRenderStateComand(),et.DepthMaskCMD=g.renderEngine.createRenderStateComand(),et.DepthFuncCMD=g.renderEngine.createRenderStateComand(),et.StencilTestCMD=g.renderEngine.createRenderStateComand(),et.StencilMaskCMD=g.renderEngine.createRenderStateComand(),et.StencilFuncCMD=g.renderEngine.createRenderStateComand(),et.stencilOpCMD=g.renderEngine.createRenderStateComand(),et.BlendCMD=g.renderEngine.createRenderStateComand(),et.BlendEquationCMD=g.renderEngine.createRenderStateComand(),et.BlendEquationSeparateCMD=g.renderEngine.createRenderStateComand(),et.BlendFuncCMD=g.renderEngine.createRenderStateComand(),et.BlendFuncSeperateCMD=g.renderEngine.createRenderStateComand(),et.CullFaceCMD=g.renderEngine.createRenderStateComand(),et.FrontFaceCMD=g.renderEngine.createRenderStateComand()}static setDepthTest(e){et.DepthTestCMD.clear(),et.DepthTestCMD.addCMD(t.RenderStateType.DepthTest,e),et.DepthTestCMD.applyCMD()}static setDepthMask(e){et.DepthMaskCMD.clear(),et.DepthMaskCMD.addCMD(t.RenderStateType.DepthMask,e),et.DepthMaskCMD.applyCMD()}static setDepthFunc(e){et.DepthFuncCMD.clear(),et.DepthFuncCMD.addCMD(t.RenderStateType.DepthFunc,e),et.DepthFuncCMD.applyCMD()}static setStencilTest(e){et.StencilTestCMD.clear(),et.StencilTestCMD.addCMD(t.RenderStateType.StencilTest,e),et.StencilTestCMD.applyCMD()}static setStencilMask(e){et.StencilMaskCMD.clear(),et.StencilMaskCMD.addCMD(t.RenderStateType.StencilMask,e),et.StencilMaskCMD.applyCMD()}static setStencilFunc(e,i){et.StencilFuncCMD.clear(),et.stencilFuncArray[0]=e,et.stencilFuncArray[1]=i,et.StencilFuncCMD.addCMD(t.RenderStateType.StencilFunc,et.stencilFuncArray),et.StencilFuncCMD.applyCMD()}static setstencilOp(e,i,r){et.stencilOpCMD.clear(),et.stencilOpArray[0]=e,et.stencilOpArray[1]=i,et.stencilOpArray[2]=r,et.stencilOpCMD.addCMD(t.RenderStateType.StencilOp,et.stencilOpArray),et.stencilOpCMD.applyCMD()}static setBlend(e){et.BlendCMD.clear(),e?et.BlendCMD.addCMD(t.RenderStateType.BlendType,t.BlendType.BLEND_ENABLE_SEPERATE):et.BlendCMD.addCMD(t.RenderStateType.BlendType,t.BlendType.BLEND_DISABLE),et.BlendCMD.applyCMD()}static setBlendEquation(e){et.BlendEquationCMD.clear(),et.BlendEquationCMD.addCMD(t.RenderStateType.BlendEquation,e),et.BlendEquationCMD.applyCMD()}static setBlendEquationSeparate(e,i){et.BlendEquationSeparateCMD.clear(),et.blendEquationSeparateArray[0]=e,et.blendEquationSeparateArray[1]=i,et.BlendEquationSeparateCMD.addCMD(t.RenderStateType.BlendEquationSeparate,et.blendEquationSeparateArray),et.BlendEquationSeparateCMD.applyCMD()}static setBlendFunc(e,i,r=!1){et.BlendFuncCMD.clear(),et.blenfunArray[0]=e,et.blenfunArray[1]=i,et.BlendFuncCMD.addCMD(t.RenderStateType.BlendFunc,et.blenfunArray),et.BlendFuncCMD.applyCMD()}static setBlendFuncSeperate(e,i,r,s){et.BlendFuncSeperateCMD.clear(),et.blendFuncSeperateArray[0]=e,et.blendFuncSeperateArray[1]=i,et.blendFuncSeperateArray[2]=r,et.blendFuncSeperateArray[3]=s,et.BlendFuncSeperateCMD.addCMD(t.RenderStateType.BlendFuncSeperate,et.blendFuncSeperateArray),et.BlendFuncSeperateCMD.applyCMD()}}et.stencilFuncArray=new Array(2),et.blendEquationSeparateArray=new Array(2),et.blenfunArray=new Array(2),et.blendFuncSeperateArray=new Array(4),et.stencilOpArray=new Array(3);class it{static _init_(){it.fns=[it.BlendNormal,it.BlendAdd,it.BlendMultiply,it.BlendScreen,it.BlendOverlay,it.BlendLight,it.BlendMask,it.BlendDestinationOut,it.BlendAddOld],it.targetFns=[it.BlendNormalTarget,it.BlendAddTarget,it.BlendMultiplyTarget,it.BlendScreenTarget,it.BlendOverlayTarget,it.BlendLightTarget,it.BlendMask,it.BlendDestinationOut,it.BlendAddTargetOld]}static BlendNormal(){et.setBlendFunc(t.BlendFactor.One,t.BlendFactor.OneMinusSourceAlpha,!0)}static BlendAddOld(){et.setBlendFunc(t.BlendFactor.One,t.BlendFactor.DestinationAlpha,!0)}static BlendAdd(){et.setBlendFunc(t.BlendFactor.One,t.BlendFactor.One,!0)}static BlendMultiply(){et.setBlendFunc(t.BlendFactor.DestinationColor,t.BlendFactor.OneMinusSourceAlpha,!0)}static BlendScreen(){et.setBlendFunc(t.BlendFactor.One,t.BlendFactor.One,!0)}static BlendOverlay(){et.setBlendFunc(t.BlendFactor.One,t.BlendFactor.OneMinusSourceAlpha,!0)}static BlendLight(){et.setBlendFunc(t.BlendFactor.One,t.BlendFactor.One,!0)}static BlendNormalTarget(){et.setBlendFunc(t.BlendFactor.One,t.BlendFactor.OneMinusSourceAlpha,!0)}static BlendAddTargetOld(){et.setBlendFunc(t.BlendFactor.One,t.BlendFactor.DestinationAlpha,!0)}static BlendAddTarget(){et.setBlendFunc(t.BlendFactor.One,t.BlendFactor.One,!0)}static BlendMultiplyTarget(){et.setBlendFunc(t.BlendFactor.DestinationColor,t.BlendFactor.OneMinusSourceAlpha,!0)}static BlendScreenTarget(){et.setBlendFunc(t.BlendFactor.One,t.BlendFactor.One,!0)}static BlendOverlayTarget(){et.setBlendFunc(t.BlendFactor.One,t.BlendFactor.OneMinusSourceColor,!0)}static BlendLightTarget(){et.setBlendFunc(t.BlendFactor.One,t.BlendFactor.One,!0)}static BlendMask(){et.setBlendFunc(t.BlendFactor.Zero,t.BlendFactor.SourceAlpha,!0)}static BlendDestinationOut(){et.setBlendFunc(t.BlendFactor.Zero,t.BlendFactor.Zero,!0)}}it.activeBlendFunction=null,it.NAMES=["normal","add","multiply","screen","overlay","light","mask","destination-out","add_old"],it.TOINT={normal:0,add:1,multiply:2,screen:3,overlay:4,light:5,mask:6,"destination-out":7,lighter:1,lighter_old:8,add_old:8},it.NORMAL="normal",it.MASK="mask",it.LIGHTER="lighter";class rt{constructor(t,e,i){this._value=0,this._name2int=t,this._int2name=e,this._int2nameMap=i}add(t){return this._value|="string"==typeof t?this._name2int[t]:t,this._value}addInt(t){return this._value|=t,this._value}remove(t){return this._value&="string"==typeof t?~this._name2int[t]:~t,this._value}isDefine(t){return(this._value&t)===t}getValue(){return this._value}setValue(t){this._value=t}toNameDic(){var t=this._int2nameMap[this._value];return t||rt._toText(this._value,this._int2name,this._int2nameMap)}static _reg(t,e,i,r){i[t]=e,r[e]=t}static _toText(t,e,i){var r=i[t];if(r)return r;for(var s={},a=1,n=0;n<32&&!((a=1<<n)>t);n++)if(t&a){var h=e[a];h&&(s[h]="")}return i[t]=s,s}static _toInt(t,e){for(var i=t.split("."),r=0,s=0,a=i.length;s<a;s++){var n=e[i[s]];if(!n)throw new Error("Defines to int err:"+t+"/"+i[s]);r|=n}return r}}class st extends rt{static __init__(){st.reg("TEXTURE2D",st.TEXTURE2D),st.reg("PRIMITIVE",st.PRIMITIVE),st.reg("GLOW_FILTER",st.FILTERGLOW),st.reg("BLUR_FILTER",st.FILTERBLUR),st.reg("COLOR_FILTER",st.FILTERCOLOR),st.reg("COLOR_ADD",st.COLORADD),st.reg("WORLDMAT",st.WORLDMAT),st.reg("FILLTEXTURE",st.FILLTEXTURE),st.reg("MVP3D",st.MVP3D),st.reg("GAMMASPACE",st.GAMMASPACE),st.reg("INVERTY",st.INVERTY)}constructor(){super(st.__name2int,st.__int2name,st.__int2nameMap)}static reg(t,e){this._reg(t,e,st.__name2int,st.__int2name)}static toText(t,e,i){return this._toText(t,e,i)}static toInt(t){return this._toInt(t,st.__name2int)}}st.TEXTURE2D=1,st.PRIMITIVE=4,st.FILTERGLOW=8,st.FILTERBLUR=16,st.FILTERCOLOR=32,st.COLORADD=64,st.WORLDMAT=128,st.FILLTEXTURE=256,st.SKINMESH=512,st.MVP3D=2048,st.GAMMASPACE=4096,st.INVERTY=8192,st.NOOPTMASK=st.FILTERGLOW|st.FILTERBLUR|st.FILTERCOLOR|st.FILLTEXTURE,st.__name2int={},st.__int2name=[],st.__int2nameMap=[];const at=new m,nt=new m;class ht extends M{static create(t,e,i,r,s,a=0,n=0,h=0,o=0){return ht._create(t,e,i,r,s,a,n,h,o)}static _create(t,e,i,r,s,a=0,n=0,h=0,o=0,l=null){var _,u=t instanceof ht,d=u?t.uv:ht.DEF_UV,c=u?t.bitmap:t;c.width&&e+r>c.width&&(r=c.width-e),c.height&&i+s>c.height&&(s=c.height-i),l?(_=l).setTo(c,null,h||r,o||s):_=new ht(c,null,h||r,o||s),_.width=r,_.height=s,_.offsetX=a,_.offsetY=n;var p=1/c.width,f=1/c.height;e*=p,i*=f,r*=p,s*=f;var m=_.uv[0],g=_.uv[1],T=_.uv[4],x=_.uv[5],E=T-m,y=x-g,v=function(t,e,i){for(var r=0;r<8;r+=2)i[r]+=t,i[r+1]+=e;return i}(d[0],d[1],[e,i,e+r,i,e+r,i+s,e,i+s]);_.uv=new Float32Array([m+v[0]*E,g+v[1]*y,T-(1-v[2])*E,g+v[3]*y,T-(1-v[4])*E,x-(1-v[5])*y,m+v[6]*E,x-(1-v[7])*y]);var S=c.scaleRate;return S&&1!=S?(_.sourceWidth/=S,_.sourceHeight/=S,_.width/=S,_.height/=S,_.scaleRate=S,_.offsetX/=S,_.offsetY/=S):_.scaleRate=1,_}static createFromTexture(t,e,i,r,s){var a=t.scaleRate;1!=a&&(e*=a,i*=a,r*=a,s*=a);var n=m.TEMP.setTo(e-t.offsetX,i-t.offsetY,r,s),h=n.intersection(at.setTo(0,0,t.width,t.height),nt);return h?ht.create(t,h.x,h.y,h.width,h.height,h.x-n.x,h.y-n.y,r,s):null}get uv(){return this._uv}set uv(t){this.uvrect[0]=Math.min(t[0],t[2],t[4],t[6]),this.uvrect[1]=Math.min(t[1],t[3],t[5],t[7]),this.uvrect[2]=Math.max(t[0],t[2],t[4],t[6])-this.uvrect[0],this.uvrect[3]=Math.max(t[1],t[3],t[5],t[7])-this.uvrect[1],this._uv=t}get width(){return this._w?this._w:this.bitmap?this.uv&&this.uv!==ht.DEF_UV?(this.uv[2]-this.uv[0])*this.bitmap.width:this.bitmap.width:0}set width(t){this._w=t,this.sourceWidth||(this.sourceWidth=t)}get height(){return this._h?this._h:this.bitmap?this.uv&&this.uv!==ht.DEF_UV?(this.uv[5]-this.uv[1])*this.bitmap.height:this.bitmap.height:0}set height(t){this._h=t,this.sourceHeight||(this.sourceHeight=t)}get bitmap(){return this._bitmap}set bitmap(t){this._bitmap!=t&&(this._bitmap&&this._bitmap._removeReference(this._referenceCount),this._bitmap=t,t&&t._addReference(this._referenceCount))}constructor(t=null,e=null,i=0,r=0){super(!1),this.uvrect=[0,0,1,1],this._w=0,this._h=0,this.offsetX=0,this.offsetY=0,this.sourceWidth=0,this.sourceHeight=0,this.scaleRate=1;let s=t instanceof ht?t.bitmap:t;this.setTo(s,e,i,r)}_addReference(t=1){super._addReference(t),this._bitmap&&this._bitmap._addReference(t)}_removeReference(t=1){super._removeReference(t),this._bitmap&&this._bitmap._removeReference(t)}_getSource(t=null){return this._destroyed||!this._bitmap?null:(this.recoverBitmap(t),this._bitmap.destroyed?null:this.bitmap._getSource())}setTo(t=null,e=null,i=0,r=0){this.bitmap=t,this.sourceWidth=i,this.sourceHeight=r,t&&(this._w=t.width,this._h=t.height,this.sourceWidth=this.sourceWidth||t.width,this.sourceHeight=this.sourceHeight||t.height),this.uv=e||ht.DEF_UV}load(t,e){return this._destroyed?Promise.resolve():n.loader.load(t).then((t=>{let i=t.bitmap;this.bitmap=i,this.sourceWidth=this._w=i.width,this.sourceHeight=this._h=i.height,e&&e.run(),this.event(y.READY,this)}))}getTexturePixels(t,e,i,r){var s,a,h,o=this.bitmap,l=this._w,_=this._h,u=this.sourceWidth,d=this.sourceHeight,c=o.width,p=o.height,f=this.offsetX,m=this.offsetY;let g=i,T=r;if(t+i>l+f&&(g-=t+i-l-f),t+i>u&&(i-=t+i-u),e+r>_+m&&(T-=e+r-_-m),e+r>d&&(r-=e+r-d),i<=0||r<=0)return null;let x=f>t?f-t:0,E=m>e?m-e:0,y=t>f?t-f:0,v=e>m?e-m:0;g-=x,T-=E;var S=4*i,R=null;try{R=o.getPixels()}catch(t){}if(R){if(0==t&&0==e&&i==c&&r==p)return R;let n=this._uv.slice(),o=Math.round(n[0]*c),l=Math.round(n[1]*p);var b=new Uint8Array(i*r*4);for(s=4*o+4*y+(a=(l+v)*(S=4*c)),h=0;h<T;h++)b.set(R.slice(s,s+4*g),4*i*(h+E)+4*x),s+=S;return b}var C=new n.Context;C.size(i,r),C.asBitmap=!0;var A=null;if(0!=t||0!=e||i!=c||r!=p){var w=(A=this._uv.slice())[0],M=A[1],D=(A[2]-w)/l,I=(A[7]-M)/_;A=[w+y*D,M+v*I,w+(y+g)*D,M+v*I,w+(y+g)*D,M+(v+T)*I,w+y*D,M+(v+T)*I]}C._drawTextureM(this,x,E,g,T,null,1,A),C._targets.start(),C.flush(),C._targets.end(),C._targets.restore();var P=C._targets.getData(0,0,i,r);for(C.destroy(),b=new Uint8Array(i*r*4),s=0,a=(r-1)*S,h=r-1;h>=0;h--)b.set(P.slice(a,a+S),s),s+=S,a-=S;return b}getPixels(t,e,i,r){return this.getTexturePixels(t,e,i,r)}recoverBitmap(t=null){var e=this._bitmap.url;this._destroyed||this._bitmap&&!this._bitmap.destroyed||!e||n.loader.load(e).then((e=>{this.bitmap=e.bitmap,t&&t()}))}disposeBitmap(){!this._destroyed&&this._bitmap&&this._bitmap.destroy()}get valid(){return!this._destroyed&&this._bitmap&&!this._bitmap.destroyed}get obsolute(){return this._obsolute||!this._bitmap||this._bitmap.destroyed||this._bitmap.obsolute}set obsolute(t){this._obsolute=t}_disposeResource(){let t=this._bitmap;this._bitmap=null,t&&t._removeReference(this._referenceCount)}getCachedClip(t,e,i,r){let s=`${t}_${e}_${i}_${r}`;this.clipCache||(this.clipCache=new Map);let a=this.clipCache.get(s);return a||(a=ht.createFromTexture(this,t,e,i,r),this.clipCache.size>100&&this.clipCache.clear(),this.clipCache.set(s,a),a)}}ht.DEF_UV=new Float32Array([0,0,1,0,1,1,0,1]),ht.NO_UV=new Float32Array([0,0,0,0,0,0,0,0]),ht.INV_UV=new Float32Array([0,1,1,1,1,0,0,0]);class ot{constructor(){this._strsToID={},this._idToStrs=[],this._length=0}add(t){var e=this._strsToID[t];return null!=e?e:(this._idToStrs[this._length]=t,this._strsToID[t]=this._length++)}getID(t){var e=this._strsToID[t];return null==e?-1:e}getName(t){var e=this._idToStrs[t];return null==e?void 0:e}}class lt{constructor(){this.uuidMap={},this.shaderNameMap={},this.metaMap={},this.enableImageMetaFile=!1}UUID_to_URL(t){return this.uuidMap[t]}UUID_to_URL_async(t){return null}URL_to_UUID_async(t){return null}resolveURL(t,e){if(t.startsWith("res://")){let i=t.substring(6);if(t=this.UUID_to_URL(i))return void e(t);let r=lt.inst.UUID_to_URL_async(i);if(r)return void r.then(e)}e(t)}shaderName_to_URL(t){return this.shaderNameMap[t]}shaderName_to_URL_async(t){return console.warn(`unknown shaderName: ${t}`),null}getMeta(t,e){let i=this.metaMap[t];return i||(this.enableImageMetaFile?t+".json":null)}getSubAssetURL(t,e,i,r){return`${d.replaceFileExtension(t,"")}@${i}.${r}`}}lt.inst=new lt;class _t{static __init__(){_t.rootPath=_t.basePath=location&&null!=location.protocol&&""!=location.protocol?_t.getPath(location.protocol+"//"+location.host+location.pathname):"",h.isPlaying&&!h.isPreview&&(this.overrideExtension(["rendertexture","videotexture"],"rt.json"),this.overrideExtension(["controller"],"controller.json"),this.overrideExtension(["mc"],"mc.bin"),this.overrideExtension(["mcc"],"mcc.json"),this.overrideExtension(["shader"],"shader.json"))}constructor(t){this._url=_t.formatURL(t),this._path=_t.getPath(t)}get url(){return this._url}get path(){return this._path}static formatURL(t,e){if(!t)return e||_t.basePath||"";if(t.startsWith("res://")){let e=t.substring(6),i=lt.inst.UUID_to_URL(e);if(!i)return t;t=i}let i=t.charCodeAt(0);return-1==t.indexOf(":")&&47!==i&&(null!=_t.customFormat&&(t=_t.customFormat(t)),t=126===i?_t.join(_t.rootPath,t.substring(2)):_t.join(null!=e?e:_t.basePath,t)),t}static postFormatURL(t){if(_t.hasExtOverrides){let e=d.getFileExtension(t),i=_t.overrideFileExts[e];null!=i&&(t=d.replaceFileExtension(t,i))}return t}static normalize(t){if(-1==t.indexOf("./"))return t;let e=t.split("/"),i=e.length,r=0;for(;r<i;)if("."!=e[r]){if(".."==e[r]){let t=r-1;if(t>=0&&".."!==e[t]){e.splice(t,2),i-=2,r--;continue}}r++}else e.splice(r,1),i--;return e.length=i,e.join("/")}static getResURLByUUID(t){return t.length>=36&&45===t.charCodeAt(8)&&45===t.charCodeAt(13)?"res://"+t:t}static join(t,e){if(!e)return"";if(e.indexOf(":")>0)return e;if(t){let i=e.charCodeAt(0);126!==i&&47!==i&&(e=47!==t.charCodeAt(t.length-1)?t+"/"+e:t+e)}return _t.normalize(e)}static getPath(t){var e=t.lastIndexOf("/");return e>0?t.substring(0,e+1):""}static getFileName(t){var e=t.lastIndexOf("/");return e>0?t.substring(e+1):t}static getURLVerion(t){var e=t.indexOf("?");return e>=0?t.substring(e):null}static overrideExtension(t,e){for(let i of t)_t.overrideFileExts[i]=e;_t.hasExtOverrides=!0}static set exportSceneToJson(t){t&&_t.overrideExtension(["scene3d","scene","taa","prefab"],"json")}}_t.version={},_t.basePath="",_t.rootPath="",_t.overrideFileExts={},_t.customFormat=function(t){let e=_t.version[t];return window.conch||null==e||(-1!=t.indexOf("?")?-1==t.indexOf("&v=")&&-1==t.indexOf("?v=")&&(t+="&v="+e):t+="?v="+e),t};class ut{static splitToWords(t,e){for(var i,r,s=[],a=-1,n=0,h=t.length;n<h;n++)if(i=t.charAt(n)," \t=+-*/&%!<>()'\",;".indexOf(i)>=0){if(a>=0&&n-a>1&&(r=t.substr(a,n-a),s.push(r)),'"'==i||"'"==i){var o=t.indexOf(i,n+1);if(o<0)throw"Sharder err:"+t;s.push(t.substr(n+1,o-n-1)),n=o,a=-1;continue}"("==i&&e&&s.length>0&&(r=s[s.length-1]+";","vec4;main;".indexOf(r)<0&&(e.useFuns+=r)),a=-1}else a<0&&(a=n);return a<h&&h-a>1&&(r=t.substr(a,h-a),s.push(r)),s}constructor(t){this.codes={},this.funs={},this.curUseID=-1,this.funnames="",this.script=t;for(var e,i,r=0;!((r=t.indexOf("#begin",r))<0);){for(i=r+5;!((i=t.indexOf("#end",i))<0)&&"i"===t.charAt(i+4);)i+=5;if(i<0)throw"add include err,no #end:"+t;e=t.indexOf("\n",r);var s=ut.splitToWords(t.substr(r,e-r),null);"code"==s[1]?this.codes[s[2]]=t.substr(e+1,i-e-1):"function"==s[1]&&(e=t.indexOf("function",r),e+="function".length,this.funs[s[3]]=t.substr(e+1,i-e-1),this.funnames+=s[3]+";"),r=i+1}}getWith(t=null){var e=t?this.codes[t]:this.script;if(!e)throw"get with error:"+t;return e}getFunsScript(t){var e="";for(var i in this.funs)t.indexOf(i+";")>=0&&(e+=this.funs[i]);return e}}class dt{constructor(t){this.childs=[],this.text="",this.useFuns="",this.z=0,this.includefiles=t}setParent(t){t.childs.push(this),this.z=t.z+1,this.parent=t}setCondition(t,e){t&&(this.conditionType=e,t=t.replace(/(\s*$)/g,""),this.condition=function(){return this[t]},this.condition.__condition=t)}toscript(t,e){return this._toscript(t,e,++dt.__id)}_toscript(t,e,i){if(this.childs.length<1&&!this.text)return e;if(e.length,this.condition){var r=!!this.condition.call(t);if(2===this.conditionType&&(r=!r),!r&&dt.__noCompileEnable)return e}if(!this.noCompile&&dt.__noCompileEnable||this.text&&e.push(this.text),this.childs.length>0&&this.childs.forEach((function(r,s,a){r._toscript(t,e,i)})),this.includefiles.length>0&&this.useFuns.length>0)for(var s,a=0,n=this.includefiles.length;a<n;a++)this.includefiles[a].curUseID!=i&&(s=this.includefiles[a].file.getFunsScript(this.useFuns)).length>0&&(this.includefiles[a].curUseID=i,e[0]=s+e[0]);return e}}dt.__id=1,dt.__noCompileEnable=!0;const ct=new RegExp("\r","g"),pt=new RegExp("[ \\t=\\+\\-*/&%!<>!%(),;\\|]","g");class ft{static addInclude(t,e,i){if(!e||0===e.length)return console.error("shader include file err:"+t),null;if(!i&&ft.includes[t])return console.warn("shader include file already exists:"+t),ft.includes[t];e=e.replace(ct,"");let r=new ut(e);return ft.includes[t]=r,r}static compile(t,e,i){let r={vsNode:new dt([]),psNode:new dt([]),includeNames:new Set,defs:new Set},s=[];t=t.replace(ct,""),e=e.replace(ct,""),ft._compileToTree(r.vsNode,t,r.defs,s,i),ft._compileToTree(r.psNode,e,r.defs,s,i);for(let t of s)t.file?r.includeNames.add(t.name):console.warn(`ShaderCompile missing file ${t.name}`);return r}static compileAsync(t,e,i){let r={vsNode:new dt([]),psNode:new dt([]),includeNames:new Set,defs:new Set},s=[];return t=t.replace(ct,""),e=e.replace(ct,""),ft._compileToTree(r.vsNode,t,r.defs,s,i),ft._compileToTree(r.psNode,e,r.defs,s,i),this._loadIncludesDeep(r,s,0)}static _loadIncludesDeep(t,e,i){let r,s=e.length;for(let a=i;a<s;a++){let i=e[a];i.file?t.includeNames.add(i.name):(r||(r=[]),r.push(i))}return r?n.loader.load(r.map((t=>t.name))).then((i=>{let a=r.length;for(let s=0;s<a;s++){let a=r[s],n=i[s];if(n){t.includeNames.add(a.name);let i=n.getWith(a.codeName);a.node.condition?a.node.text=i:(ft._compileToTree(a.node,i,t.defs,e,_t.getPath(a.name)),a.node.text="")}else{let t=a.node.parent.childs;t.splice(t.indexOf(a.node),1)}}return e.length>s?ft._loadIncludesDeep(t,e,s):t})):Promise.resolve(t)}static _compileToTree(t,e,i,r,s){let a,n,h,o,l,_,u,d,c,p,f=e.split("\n");for(d=0;d<f.length;d++)if(h=f[d],!(h.length<1)&&(_=h.indexOf("//"),0!==_))if(_>=0&&(h=h.substr(0,_)),(_=h.indexOf("#"))<0){n=t.childs[t.childs.length-1];let e=t.includefiles;if(n&&!n.name){e.length>0&&ut.splitToWords(h,n),n.text+="\n"+h;continue}a=new dt(e),a.text=h,a.noCompile=!0,e.length>0&&ut.splitToWords(h,a),a.setParent(t)}else{for(a=new dt(t.includefiles),a.text=h,a.noCompile=!0,o="#",p=_+1,c=h.length;p<c;p++){let t=h.charAt(p);if(" "===t||"\t"===t||"?"===t)break;o+=t}switch(a.name=o,o){case"#ifdef":case"#ifndef":for(a.src=h,a.noCompile=null!=h.match(/[!&|()=<>]/),a.noCompile?console.log("function():Boolean{return "+h.substr(_+a.name.length)+"}"):(u=h.replace(/^\s*/,"").split(/\s+/),a.setCondition(u[1],"#ifdef"===o?ft.IFDEF_YES:ft.IFDEF_ELSE),a.text=a.text),a.setParent(t),t=a,u=h.substr(p).split(pt),p=0;p<u.length;p++)h=u[p],h.length&&i.add(h);break;case"#if":case"#elif":for(a.src=h,a.noCompile=!0,"#elif"==o&&(n=(t=t.parent).childs[t.childs.length-1],n.text=n.src,n.noCompile=!0,n.condition=null),a.setParent(t),t=a,u=h.substr(p).split(pt),p=0;p<u.length;p++)h=u[p],h.length&&"defined"!=h&&i.add(h);break;case"#else":a.src=h,n=(t=t.parent).childs[t.childs.length-1],a.noCompile=n.noCompile,a.noCompile||(a.condition=n.condition,a.conditionType=n.conditionType==ft.IFDEF_YES?ft.IFDEF_ELSE:ft.IFDEF_YES),a.setParent(t),t=a;break;case"#endif":n=(t=t.parent).childs[t.childs.length-1],a.noCompile=n.noCompile,a.noCompile||(a.text=a.text),a.setParent(t);break;case"#include":u=ut.splitToWords(h,null);let e,d=u[1];d.startsWith(".")&&(d=_t.join(s,d)),e=ft.includes[d],!e&&ft.loadIncludeFileSync&&(ft.loadIncludeFileSync(d),e=ft.includes[d]);let c="with"==u[2]?u[3]:null;r.push({name:d,codeName:c,node:a,file:e}),a.setParent(t),(_=u[0].indexOf("?"))<0?(e&&(h=e.getWith(c),this._compileToTree(a,h,i,r,_t.getPath(d))),a.text=""):(a.setCondition(u[0].substr(_+1),ft.IFDEF_YES),e&&(a.text=e.getWith(c)));break;case"#import":u=ut.splitToWords(h,null),l=u[1],a.includefiles.push({node:a,file:ft.includes[l],ofs:a.text.length});break;default:a.setParent(t)}}}}ft.IFDEF_NO=0,ft.IFDEF_YES=1,ft.IFDEF_ELSE=2,ft.IFDEF_PARENT=3,ft.includes={};class mt extends H{static create(t,e,i=null,r=null,s=null){return new mt(t,e,i,r,s)}static withCompile2D(t,e,i,r,s,a=null){if(r&&mt.sharders[r])return mt.sharders[r];var n=mt._preCompileShader[mt.SHADERNAME2ID*t+e];if(!n)throw new Error("withCompile shader err!"+t+" "+e);var h={},o="";if(i)for(var l in i)o+="#define "+l+"\n",h[l]=!0;var _=n.vsNode.toscript(h,[]),u=n.psNode.toscript(h,[]);return(s||mt.create)(o+_.join("\n"),o+u.join("\n"),r,n.nameMap,a)}static addInclude(t,e){ft.addInclude(t,e)}static preCompile(t,e,i,r){let s=mt.SHADERNAME2ID*t,a=ft.compile(e,i);a.nameMap=r,mt._preCompileShader[s]=a}static preCompile2D(t,e,i,r,s){let a=mt.SHADERNAME2ID*t+e,n=ft.compile(i,r);n.nameMap=s,mt._preCompileShader[a]=n}constructor(t,e,i=null,r=null,s=null){if(super(),this._attribInfo=null,this._curActTexIndex=0,this.tag={},this._program=null,this._params=null,this._paramsMap={},!t||!e)throw"Shader Error";this._attribInfo=s,this._id=++mt._count,this._vs=t,this._ps=e,this._nameMap=r||{},null!=i&&(mt.sharders[i]=this),this.recreateResource(),this.lock=!0,this._render2DContext=g.render2DContext}recreateResource(){this._compile(),this._setGPUMemory(0)}_disposeResource(){et.mainContext.deleteShader(this._vshader),et.mainContext.deleteShader(this._pshader),et.mainContext.deleteProgram(this._program),this._vshader=this._pshader=this._program=null,this._params=null,this._paramsMap={},this._setGPUMemory(0),this._curActTexIndex=0}_compile(){if(this._vs&&this._ps&&!this._params){this._reCompile=!0,this._params=[];var t,e,i,r=et.mainContext;this._program=r.createProgram(),this._vshader=mt._createShader(r,this._vs,r.VERTEX_SHADER),this._pshader=mt._createShader(r,this._ps,r.FRAGMENT_SHADER),r.attachShader(this._program,this._vshader),r.attachShader(this._program,this._pshader);var s=this._attribInfo?this._attribInfo.length:0;for(e=0;e<s;e+=2)r.bindAttribLocation(this._program,this._attribInfo[e+1],this._attribInfo[e]);if(r.linkProgram(this._program),!r.getProgramParameter(this._program,r.LINK_STATUS))throw r.getProgramInfoLog(this._program);var a=r.getProgramParameter(this._program,r.ACTIVE_UNIFORMS);for(e=0;e<a;e++){var n=r.getActiveUniform(this._program,e);(t={vartype:"uniform",glfun:null,ivartype:1,location:r.getUniformLocation(this._program,n.name),name:n.name,type:n.type,isArray:!1,isSame:!1,preValue:null,indexOfParams:0}).name.indexOf("[0]")>0&&(t.name=t.name.substr(0,t.name.length-3),t.isArray=!0,t.location=r.getUniformLocation(this._program,t.name)),this._params.push(t)}for(e=0,i=this._params.length;e<i;e++)switch((t=this._params[e]).indexOfParams=e,t.index=1,t.value=[t.location,null],t.codename=t.name,t.name=this._nameMap[t.codename]?this._nameMap[t.codename]:t.codename,this._paramsMap[t.name]=t,t._this=this,t.uploadedValue=[],t.type){case r.INT:t.fun=t.isArray?this._uniform1iv:this._uniform1i;break;case r.FLOAT:t.fun=t.isArray?this._uniform1fv:this._uniform1f;break;case r.FLOAT_VEC2:t.fun=t.isArray?this._uniform_vec2v:this._uniform_vec2;break;case r.FLOAT_VEC3:t.fun=t.isArray?this._uniform_vec3v:this._uniform_vec3;break;case r.FLOAT_VEC4:t.fun=t.isArray?this._uniform_vec4v:this._uniform_vec4;break;case r.SAMPLER_2D:t.fun=this._uniform_sampler2D;break;case r.SAMPLER_CUBE:t.fun=this._uniform_samplerCube;break;case r.FLOAT_MAT4:t.glfun=r.uniformMatrix4fv,t.fun=this._uniformMatrix4fv;break;case r.BOOL:t.fun=this._uniform1i;break;case r.FLOAT_MAT2:case r.FLOAT_MAT3:default:throw new Error("compile shader err!")}}}static _createShader(t,e,i){var r=t.createShader(i);return t.shaderSource(r,e),t.compileShader(r),t.getShaderParameter(r,t.COMPILE_STATUS)?r:(console.log(t.getShaderInfoLog(r)),null)}getUniform(t){return this._paramsMap[t]}_uniform1f(t,e){var i=t.uploadedValue;return i[0]!==e?(et.mainContext.uniform1f(t.location,i[0]=e),1):0}_uniform1fv(t,e){if(e.length<4){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]||i[2]!==e[2]||i[3]!==e[3]?(et.mainContext.uniform1fv(t.location,e),i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],1):0}return et.mainContext.uniform1fv(t.location,e),1}_uniform_vec2(t,e){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]?(et.mainContext.uniform2f(t.location,i[0]=e[0],i[1]=e[1]),1):0}_uniform_vec2v(t,e){if(e.length<2){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]||i[2]!==e[2]||i[3]!==e[3]?(et.mainContext.uniform2fv(t.location,e),i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],1):0}return et.mainContext.uniform2fv(t.location,e),1}_uniform_vec3(t,e){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]||i[2]!==e[2]?(et.mainContext.uniform3f(t.location,i[0]=e[0],i[1]=e[1],i[2]=e[2]),1):0}_uniform_vec3v(t,e){return et.mainContext.uniform3fv(t.location,e),1}_uniform_vec4(t,e){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]||i[2]!==e[2]||i[3]!==e[3]?(et.mainContext.uniform4f(t.location,i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3]),1):0}_uniform_vec4v(t,e){return et.mainContext.uniform4fv(t.location,e),1}_uniformMatrix4fv(t,e){return et.mainContext.uniformMatrix4fv(t.location,!1,e),1}_uniform1i(t,e){var i=t.uploadedValue;return i[0]!==e?(et.mainContext.uniform1i(t.location,i[0]=e),1):0}_uniform1iv(t,e){return et.mainContext.uniform1iv(t.location,e),1}_uniform_sampler2D(t,e){var i=et.mainContext,r=t.uploadedValue;return null==r[0]?(r[0]=this._curActTexIndex,i.uniform1i(t.location,this._curActTexIndex),this._render2DContext.activeTexture(i.TEXTURE0+this._curActTexIndex),this._render2DContext.bindTexture(i.TEXTURE_2D,e),this._curActTexIndex++,1):(this._render2DContext.activeTexture(i.TEXTURE0+r[0]),this._render2DContext.bindTexture(i.TEXTURE_2D,e),0)}_uniform_samplerCube(t,e){var i=et.mainContext,r=t.uploadedValue;return null==r[0]?(r[0]=this._curActTexIndex,i.uniform1i(t.location,this._curActTexIndex),this._render2DContext.activeTexture(i.TEXTURE0+this._curActTexIndex),this._render2DContext.bindTexture(i.TEXTURE_CUBE_MAP,e),this._curActTexIndex++,1):(this._render2DContext.activeTexture(i.TEXTURE0+r[0]),this._render2DContext.bindTexture(i.TEXTURE_CUBE_MAP,e),0)}uploadTexture2D(t){this._render2DContext.bindTexture(et.mainContext.TEXTURE_2D,t)}upload(t,e=null){H.activeShader=H.bindShader=this,this._render2DContext.bindUseProgram(this._program),this._reCompile?(e=this._params,this._reCompile=!1):e=e||this._params;for(var i,r,s=e.length,a=0;a<s;a++)null!==(r=t[(i=e[a]).name])&&i.fun.call(this,i,r)}}mt._count=0,mt._preCompileShader={},mt.SHADERNAME2ID=2e-4,mt.nameKey=new ot,mt.sharders=new Array(32);class gt extends mt{constructor(t,e,i=null,r=null,s=null){super(t,e,i,r,s),this._params2dQuick2=null,this._shaderValueWidth=0,this._shaderValueHeight=0}_disposeResource(){super._disposeResource(),this._params2dQuick2=null}upload2dQuick2(t){this.upload(t,this._params2dQuick2||this._make2dQuick2())}_make2dQuick2(){if(!this._params2dQuick2){this._params2dQuick2=[];for(var t,e=this._params,i=0,r=e.length;i<r;i++)"size"!==(t=e[i]).name&&this._params2dQuick2.push(t)}return this._params2dQuick2}static create(t,e,i=null,r=null,s=null){return new gt(t,e,i,r,s)}}class Tt{static _initone(t,e){Tt._typeClass[t]=e,Tt._cache[t]=[],Tt._cache[t]._length=0}static create(t,e){var i=Tt._cache[t|e];return i._length?i[--i._length]:new Tt._typeClass[t|e](e)}static __init__(){}constructor(t,e){this.defines=new st,this.size=[0,0],this.alpha=1,this.ALPHA=1,this.subID=0,this.ref=1,this._cacheID=0,this.clipMatDir=[i.MAX_CLIP_SIZE,0,0,i.MAX_CLIP_SIZE],this.clipMatPos=[0,0],this.clipOff=[0,0],this.mainID=t,this.subID=e,this.textureHost=null,this.texture=null,this.color=null,this.colorAdd=null,this.u_mmat2=null,this._cacheID=t|e,this._inClassCache=Tt._cache[this._cacheID],t>0&&!this._inClassCache&&(this._inClassCache=Tt._cache[this._cacheID]=[],this._inClassCache._length=0),this.clear()}setValue(t){}_ShaderWithCompile(){return mt.withCompile2D(0,this.mainID,this.defines.toNameDic(),this.mainID|this.defines._value,gt.create,this._attribLocation)}upload(){var t=Y;Y.worldMatrix4===Y.TEMPMAT4_ARRAY||this.defines.addInt(st.WORLDMAT),this.mmat=t.worldMatrix4,Y.matWVP&&(this.defines.addInt(st.MVP3D),this.u_MvpMatrix=Y.matWVP.elements);let e=!J.currentActive;e&&this.textureHost&&(this.textureHost instanceof J?e=1==this.textureHost.gammaCorrection:this.textureHost instanceof ht&&(e=1==this.textureHost.bitmap.gammaCorrection)),e?this.defines.addInt(st.GAMMASPACE):this.defines.remove(st.GAMMASPACE),Y.InvertY?this.defines.addInt(st.INVERTY):this.defines.remove(st.INVERTY);var i=mt.sharders[this.mainID|this.defines._value]||this._ShaderWithCompile();i._shaderValueWidth!==t.width||i._shaderValueHeight!==t.height?(this.size[0]=t.width,this.size[1]=t.height,i._shaderValueWidth=t.width,i._shaderValueHeight=t.height,i.upload(this,null)):i.upload(this,i._params2dQuick2||i._make2dQuick2())}setFilters(t){if(this.filters=t,t)for(var e,i=t.length,r=0;r<i;r++)(e=t[r])&&(this.defines.add(e.type),e.action.setValue(this))}clear(){this.defines._value=this.subID,this.clipOff[0]=0}release(){--this.ref<1&&(this._inClassCache&&(this._inClassCache[this._inClassCache._length++]=this),this.clear(),this.filters=null,this.ref=1,this.clipOff[0]=0)}}Tt._cache=[],Tt._typeClass=[],Tt.TEMPMAT4_ARRAY=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];class xt{constructor(){this.clear()}clear(){this.submitType=-1,this.blendShader=this.other=0}copyFrom(t){this.other=t.other,this.blendShader=t.blendShader,this.submitType=t.submitType}copyFrom2(t,e,i){this.other=i,this.submitType=e}equal3_2(t,e,i){return this.submitType===e&&this.other===i&&this.blendShader===t.blendShader}equal4_2(t,e,i){return this.submitType===e&&this.other===i&&this.blendShader===t.blendShader}equal_3(t){return this.submitType===t.submitType&&this.blendShader===t.blendShader}equal(t){return this.other===t.other&&this.submitType===t.submitType&&this.blendShader===t.blendShader}}class Et{constructor(){this._ref=1,this._key=new xt}renderSubmit(){return this.fun.apply(this._this,this.args),1}getRenderType(){return 0}releaseRender(){if(--this._ref<1){var t=Et.POOL;t[t._length++]=this,this.args=null,this.fun=null,this._this=null}}static create(t,e,i){var r=Et.POOL._length?Et.POOL[--Et.POOL._length]:new Et;return r.fun=e,r.args=t,r._this=i,r._ref=1,r._key.clear(),r}}Et.POOL=[],Et.POOL._length=0;class yt{constructor(){}get type(){return-1}}yt.BLUR=16,yt.COLOR=32,yt.GLOW=8,yt._filter=function(t,e,i,r){var s=e,a=this._next;if(a){var n=t.filters,h=n.length;if(1==h&&n[0].type==yt.COLOR)return e.save(),e.setColorFilter(n[0]),a._fun.call(a,t,e,i,r),void e.restore();var o,l=Tt.create(st.TEXTURE2D,0),_=f.TEMP,u=s._curMat,d=p.create();u.copyTo(d);var c=0,g=0,T=null,x=t._cacheStyle.filterCache||null;if(x&&0==t.getRepaint()){if((t._isHaveGlowFilter()||!1)&&(c=50,g=25),(o=t.getBounds()).width<=0||o.height<=0)return;o.width+=c+8,o.height+=c+8,o.x-=t.pivotX+4,o.y-=t.pivotY+4,_.x=o.x*d.a+o.y*d.c,_.y=o.y*d.d+o.x*d.b,o.x=_.x,o.y=_.y,_.x=o.width*d.a+o.height*d.c,_.y=o.height*d.d+o.width*d.b,o.width=_.x,o.height=_.y}else{t._isHaveGlowFilter()&&(c=50,g=25),(o=new m).copyFrom(t.getSelfBounds()),o.x+=t.x,o.y+=t.y,o.x-=t.pivotX+4,o.y-=t.pivotY+4;var E=o.x,y=o.y;if(o.width+=c+8,o.height+=c+8,_.x=o.x*d.a+o.y*d.c,_.y=o.y*d.d+o.x*d.b,o.x=_.x,o.y=_.y,_.x=o.width*d.a+o.height*d.c,_.y=o.height*d.d+o.width*d.b,o.width=_.x,o.height=_.y,o.width<=0||o.height<=0)return;x&&tt.releaseRT(x),T=tt.getRT(o.width,o.height);var v=x=tt.getRT(o.width,o.height);t._getCacheStyle().filterCache=x,s.pushRT(),s.useRT(T);var S=t.x-E+g,R=t.y-y+g;a._fun.call(a,t,e,S,R),s.useRT(v);for(var b=0;b<h;b++){0!=b&&(s.useRT(T),s.drawTarget(v,0,0,o.width,o.height,p.TEMP.identity(),l,null,it.TOINT.overlay),s.useRT(v));var C=n[b];switch(C.type){case yt.BLUR:case yt.GLOW:C._glRender&&C._glRender.render(T,e,o.width,o.height,C);break;case yt.COLOR:s.setColorFilter(C),s.drawTarget(T,0,0,o.width,o.height,p.EMPTY.identity(),Tt.create(st.TEXTURE2D,0)),s.setColorFilter(null)}}s.popRT()}if(i=i-g-t.x,r=r-g-t.y,_.setTo(i,r),d.transformPoint(_),i=_.x+o.x,r=_.y+o.y,s._drawRenderTexture(x,i,r,o.width,o.height,p.TEMP.identity(),1,J.defuv),T){var A=Et.create([T],(function(t){t.destroy()}),this);T=null,e.addRenderObject(A)}d.destroy()}};const vt={purple:"#800080",orange:"#ffa500",white:"#FFFFFF",red:"#FF0000",green:"#00FF00",blue:"#0000FF",black:"#000000",yellow:"#FFFF00",gray:"#808080"};class St{constructor(t){if(this.arrColor=[],null==t||"none"==t)return this.strColor="#00000000",this.numColor=0,void(this.arrColor=[0,0,0,0]);let e;"string"==typeof t?(e=d.fromStringColor(t),this.strColor=t):(e=t,this.strColor=d.toHexColor(e)),this.strColor.indexOf("rgba")>=0||9===this.strColor.length?(this.arrColor=[((4278190080&e)>>>24)/255,((16711680&e)>>16)/255,((65280&e)>>8)/255,(255&e)/255],this.numColor=(4278190080&e)>>>24|(16711680&e)>>8|(65280&e)<<8|(255&e)<<24):(this.arrColor=[((16711680&e)>>16)/255,((65280&e)>>8)/255,(255&e)/255,1],this.numColor=4278190080|(16711680&e)>>16|65280&e|(255&e)<<16)}static _initDefault(){for(var t in St._DEFAULT={},vt)St._SAVE[t]=St._DEFAULT[t]=new St(vt[t]);return St._DEFAULT}static _initSaveMap(){St._SAVE_SIZE=0,St._SAVE=Object.assign({},St._DEFAULT)}static create(t){let e=t+"",i=St._SAVE[e];return null!=i?i:(St._SAVE_SIZE>500&&St._initSaveMap(),St._SAVE_SIZE++,St._SAVE[e]=new St(t))}}St._SAVE={},St._SAVE_SIZE=0,St._DEFAULT=St._initDefault();const Rt=[0,.01,.02,.04,.05,.06,.07,.08,.1,.11,.12,.14,.15,.16,.17,.18,.2,.21,.22,.24,.25,.27,.28,.3,.32,.34,.36,.38,.4,.42,.44,.46,.48,.5,.53,.56,.59,.62,.65,.68,.71,.74,.77,.8,.83,.86,.89,.92,.95,.98,1,1.06,1.12,1.18,1.24,1.3,1.36,1.42,1.48,1.54,1.6,1.66,1.72,1.78,1.84,1.9,1.96,2,2.12,2.25,2.37,2.5,2.62,2.75,2.87,3,3.2,3.4,3.6,3.8,4,4.3,4.7,4.9,5,5.5,6,6.5,6.8,7,7.3,7.5,7.8,8,8.4,8.7,9,9.4,9.6,9.8,10],bt=[.3086,.6094,.082,0,0,.3086,.6094,.082,0,0,.3086,.6094,.082,0,0,0,0,0,1,0],Ct=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1];class At extends yt{constructor(t=null){super(),t||(t=this._copyMatrix(Ct)),this._mat=new Float32Array(16),this._alpha=new Float32Array(4),this.setByMatrix(t)}gray(){return this.setByMatrix(bt)}color(t=0,e=0,i=0,r=1){return this.setByMatrix([t,0,0,0,1,0,e,0,0,1,0,0,i,0,1,0,0,0,r,0])}setColor(t){var e=St.create(t).arrColor,i=[0,0,0,0,256*e[0],0,0,0,0,256*e[1],0,0,0,0,256*e[2],0,0,0,1,0];return this.setByMatrix(i)}setByMatrix(t){this._matrix!=t&&this._copyMatrix(t);for(var e=0,i=0,r=0;r<20;r++)r%5!=4?this._mat[e++]=t[r]:this._alpha[i++]=t[r];return this}get type(){return yt.COLOR}adjustColor(t,e,i,r){return this.adjustHue(r),this.adjustContrast(e),this.adjustBrightness(t),this.adjustSaturation(i),this}adjustBrightness(t){return 0==(t=this._clampValue(t,100))||isNaN(t)?this:this._multiplyMatrix([1,0,0,0,t,0,1,0,0,t,0,0,1,0,t,0,0,0,1,0,0,0,0,0,1])}adjustContrast(t){if(0==(t=this._clampValue(t,100))||isNaN(t))return this;var e,i=(e=t<0?127+t/100*127:127*(e=0==(e=t%1)?Rt[t]:Rt[t<<0]*(1-e)+Rt[1+(t<<0)]*e)+127)/127,r=.5*(127-e);return this._multiplyMatrix([i,0,0,0,r,0,i,0,0,r,0,0,i,0,r,0,0,0,1,0,0,0,0,0,1])}adjustSaturation(t){if(0==(t=this._clampValue(t,100))||isNaN(t))return this;var e=1+(t>0?3*t/100:t/100),i=1-e,r=.3086*i,s=.6094*i,a=.082*i;return this._multiplyMatrix([r+e,s,a,0,0,r,s+e,a,0,0,r,s,a+e,0,0,0,0,0,1,0,0,0,0,0,1])}adjustHue(t){if(0==(t=this._clampValue(t,180)/180*Math.PI)||isNaN(t))return this;var e=Math.cos(t),i=Math.sin(t),r=.213,s=.715,a=.072;return this._multiplyMatrix([r+e*(1-r)+i*-r,s+e*-s+i*-s,a+e*-a+i*(1-a),0,0,r+e*-r+.143*i,s+e*(1-s)+.14*i,a+e*-a+-.283*i,0,0,r+e*-r+-.787*i,s+e*-s+i*s,a+e*(1-a)+i*a,0,0,0,0,0,1,0,0,0,0,0,1])}reset(){return this.setByMatrix(this._copyMatrix(Ct))}_multiplyMatrix(t){var e=[];this._matrix=this._fixMatrix(this._matrix);for(var i=0;i<5;i++){for(var r=0;r<5;r++)e[r]=this._matrix[r+5*i];for(r=0;r<5;r++){for(var s=0,a=0;a<5;a++)s+=t[r+5*a]*e[a];this._matrix[r+5*i]=s}}return this.setByMatrix(this._matrix)}_clampValue(t,e){return Math.min(e,Math.max(-e,t))}_fixMatrix(t=null){return null==t?Ct:(t.length<25?t=t.slice(0,t.length).concat(Ct.slice(t.length,25)):t.length>25&&(t=t.slice(0,25)),t)}_copyMatrix(t){this._matrix||(this._matrix=[]);for(var e=0;e<25;e++)this._matrix[e]=t[e];return this._matrix}onAfterDeserialize(){let t=St.create(this._color||"#FFFFFF").arrColor;this.color(t[0],t[1],t[2],t[3]),this.adjustColor(this._brightness||0,this._contrast||0,this._saturation||0,this._hue||0)}}class wt{static multiply(t,e,i){return(t.x-i.x)*(e.y-i.y)-(e.x-i.x)*(t.y-i.y)}static dis(t,e){return(t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y)}static _getPoints(t,e=!1,i=null){for(wt._mPointList||(wt._mPointList=[]);wt._mPointList.length<t;)wt._mPointList.push(new f);return i||(i=[]),i.length=0,e?wt.getFrom(i,wt._mPointList,t):wt.getFromR(i,wt._mPointList,t),i}static getFrom(t,e,i){var r;for(r=0;r<i;r++)t.push(e[r]);return t}static getFromR(t,e,i){var r;for(r=0;r<i;r++)t.push(e.pop());return t}static pListToPointList(t,e=!1){var i,r=t.length/2,s=wt._getPoints(r,e,wt._tempPointList);for(i=0;i<r;i++)s[i].setTo(t[i+i],t[i+i+1]);return s}static pointListToPlist(t){var e,i,r=t.length,s=wt._temPList;for(s.length=0,e=0;e<r;e++)i=t[e],s.push(i.x,i.y);return s}static scanPList(t){return d.copyArray(t,wt.pointListToPlist(wt.scan(wt.pListToPointList(t,!0))))}static scan(t){var e,i,r,s,a,n=0,h=t.length,o={};for((s=wt._temArr).length=0,e=(h=t.length)-1;e>=0;e--)(a=(r=t[e]).x+"_"+r.y)in o||(o[a]=!0,s.push(r));for(h=s.length,d.copyArray(t,s),e=1;e<h;e++)(t[e].y<t[n].y||t[e].y==t[n].y&&t[e].x<t[n].x)&&(n=e);for(r=t[0],t[0]=t[n],t[n]=r,e=1;e<h-1;e++){for(n=e,i=e+1;i<h;i++)(wt.multiply(t[i],t[n],t[0])>0||0==wt.multiply(t[i],t[n],t[0])&&wt.dis(t[0],t[i])<wt.dis(t[0],t[n]))&&(n=i);r=t[e],t[e]=t[n],t[n]=r}if((s=wt._temArr).length=0,t.length<3)return d.copyArray(s,t);for(s.push(t[0],t[1],t[2]),e=3;e<h;e++){for(;s.length>=2&&wt.multiply(t[e],s[s.length-1],s[s.length-2])>=0;)s.pop();t[e]&&s.push(t[e])}return s}}wt._tempPointList=[],wt._temPList=[],wt._temArr=[];class Mt{}var Dt,It,Pt,Bt,Lt,Ft,Ot;Mt.ALPHA=1,Mt.TRANSFORM=2,Mt.BLEND=4,Mt.CANVAS=8,Mt.FILTERS=16,Mt.MASK=32,Mt.CLIP=64,Mt.STYLE=128,Mt.TEXTURE=256,Mt.GRAPHICS=512,Mt.LAYAGL3D=1024,Mt.CUSTOM=2048,Mt.ONECHILD=4096,Mt.HITAREA=8192,Mt.CHILDS=16384,Mt.REPAINT_NONE=0,Mt.REPAINT_NODE=1,Mt.REPAINT_CACHE=2,Mt.REPAINT_ALL=3,t.RenderStatisticsInfo=void 0,(Dt=t.RenderStatisticsInfo||(t.RenderStatisticsInfo={}))[Dt.DrawCall=0]="DrawCall",Dt[Dt.InstanceDrawCall=1]="InstanceDrawCall",Dt[Dt.Triangle=2]="Triangle",Dt[Dt.UniformUpload=3]="UniformUpload",Dt[Dt.GPUMemory=4]="GPUMemory",Dt[Dt.TextureMemeory=5]="TextureMemeory",Dt[Dt.RenderTextureMemory=6]="RenderTextureMemory",Dt[Dt.BufferMemory=7]="BufferMemory";class Nt{static show(t=0,e=0,i=Nt.AllShow){Nt._currentShowArray=i,Nt._StatRender.show(t,e,i)}static setStat(t,e){Nt[t]||(Nt[t]=0),Nt[t]+=e}static enable(){Nt._StatRender.enable()}static hide(){Nt._StatRender.hide()}static updateEngineData(){Nt.trianglesFaces=g.renderEngine.getStatisticsInfo(t.RenderStatisticsInfo.Triangle),Nt.drawCall=g.renderEngine.getStatisticsInfo(t.RenderStatisticsInfo.DrawCall),Nt.instanceDrawCall=g.renderEngine.getStatisticsInfo(t.RenderStatisticsInfo.InstanceDrawCall),Nt.gpuMemory=g.renderEngine.getStatisticsInfo(t.RenderStatisticsInfo.GPUMemory),Nt.textureMemory=g.renderEngine.getStatisticsInfo(t.RenderStatisticsInfo.TextureMemeory),Nt.renderTextureMemory=g.renderEngine.getStatisticsInfo(t.RenderStatisticsInfo.RenderTextureMemory),Nt.bufferMemory=g.renderEngine.getStatisticsInfo(t.RenderStatisticsInfo.BufferMemory)}static clear(){Nt._currentShowArray&&(Nt._currentShowArray.forEach((t=>{"average"==t.mode&&(Nt[t.value]=0)})),g.renderEngine.clearStatisticsInfo(t.RenderStatisticsInfo.Triangle),g.renderEngine.clearStatisticsInfo(t.RenderStatisticsInfo.DrawCall),g.renderEngine.clearStatisticsInfo(t.RenderStatisticsInfo.InstanceDrawCall))}static set onclick(t){Nt._StatRender.set_onclick(t)}}Nt.FPSStatUIParams={title:"FPS(WebGL)",value:"_fpsStr",color:"yellow",units:"int",mode:"summit"},Nt.NodeStatUIParams={title:"NodeNums",value:"spriteCount",color:"white",units:"int",mode:"summit"},Nt.Sprite3DStatUIParams={title:"Sprite3D",value:"sprite3DCount",color:"white",units:"int",mode:"summit"},Nt.DrawCall={title:"DrawCall",value:"drawCall",color:"white",units:"int",mode:"average"},Nt.TriangleFace={title:"TriangleFace",value:"trianglesFaces",color:"white",units:"int",mode:"average"},Nt.RenderNode={title:"RenderNode",value:"renderNode",color:"white",units:"int",mode:"summit"},Nt.SkinRenderNode={title:"SkinRenderNode",value:"skinRenderNode",color:"white",units:"int",mode:"summit"},Nt.ParticleRenderNode={title:"ParticleRenderNode",value:"particleRenderNode",color:"white",units:"int",mode:"summit"},Nt.FrustumCulling={title:"FrustumCulling",value:"frustumCulling",color:"white",units:"int",mode:"average"},Nt.UniformUpload={title:"UniformUpload",value:"uniformUpload",color:"white",units:"int",mode:"average"},Nt.OpaqueDrawCall={title:"OpaqueDrawCall",value:"opaqueDrawCall",color:"white",units:"int",mode:"average"},Nt.TransDrawCall={title:"TransDrawCall",value:"transDrawCall",color:"white",units:"int",mode:"average"},Nt.DepthCastDrawCall={title:"DepthCastDrawCall",value:"depthCastDrawCall",color:"white",units:"int",mode:"average"},Nt.InstanceDrawCall={title:"InstanceDrawCall",value:"instanceDrawCall",color:"white",units:"int",mode:"average"},Nt.CMDDrawCall={title:"CMDDrawCall",value:"cmdDrawCall",color:"white",units:"int",mode:"average"},Nt.BlitDrawCall={title:"BlitDrawCall",value:"blitDrawCall",color:"white",units:"int",mode:"average"},Nt.GPUMemory={title:"GPUMemory",value:"gpuMemory",color:"white",units:"M",mode:"summit"},Nt.TextureMemeory={title:"TextureMemory",value:"textureMemory",color:"white",units:"M",mode:"summit"},Nt.RenderTextureMemory={title:"RenderTextureMemory",value:"renderTextureMemory",color:"white",units:"M",mode:"summit"},Nt.BufferMemory={title:"BufferMemory",value:"bufferMemory",color:"white",units:"M",mode:"summit"},Nt.AllShow=[Nt.FPSStatUIParams,Nt.NodeStatUIParams,Nt.Sprite3DStatUIParams,Nt.DrawCall,Nt.TriangleFace,Nt.RenderNode,Nt.SkinRenderNode,Nt.ParticleRenderNode,Nt.FrustumCulling,Nt.OpaqueDrawCall,Nt.TransDrawCall,Nt.DepthCastDrawCall,Nt.InstanceDrawCall,Nt.CMDDrawCall,Nt.BlitDrawCall,Nt.GPUMemory,Nt.TextureMemeory,Nt.RenderTextureMemory,Nt.BufferMemory],Nt.memoryShow=[Nt.GPUMemory,Nt.TextureMemeory,Nt.RenderTextureMemory,Nt.BufferMemory],Nt.renderShaow=[Nt.DrawCall,Nt.TriangleFace,Nt.OpaqueDrawCall,Nt.TransDrawCall,Nt.DepthCastDrawCall,Nt.InstanceDrawCall,Nt.CMDDrawCall,Nt.BlitDrawCall],Nt.FPS=0,Nt.loopCount=0,Nt.spriteRenderUseCacheCount=0,Nt.canvasNormal=0,Nt.canvasBitmap=0,Nt.canvasReCache=0,Nt.renderSlow=!1,Nt._fpsData=[],Nt._timer=0,Nt._count=0,Nt._fpsStr="",Nt.spriteCount=0,Nt.sprite3DCount=0,Nt.drawCall=0,Nt.trianglesFaces=0,Nt.renderNode=0,Nt.skinRenderNode=0,Nt.particleRenderNode=0,Nt.frustumCulling=0,Nt.uniformUpload=0,Nt.opaqueDrawCall=0,Nt.transDrawCall=0,Nt.depthCastDrawCall=0,Nt.instanceDrawCall=0,Nt.cmdDrawCall=0,Nt.blitDrawCall=0,Nt.textureMemory=0,Nt.renderTextureMemory=0,Nt.bufferMemory=0;class Ut{static __init__(){var t=Ut.RENDERBASE=new Ut(-1);t.shaderValue=new Tt(0,0),t.shaderValue.ALPHA=1,t._ref=4294967295}constructor(t=Ut.TYPE_2D){this.clipInfoID=-1,this._mesh=null,this._blendFn=null,this._id=0,this._renderType=0,this._parent=null,this._key=new xt,this._startIdx=0,this._numEle=0,this._ref=1,this.shaderValue=null,this._renderType=t,this._id=++Ut.ID}getID(){return this._id}getRenderType(){return this._renderType}toString(){return"ibindex:"+this._startIdx+" num:"+this._numEle+" key="+this._key}renderSubmit(){return 1}releaseRender(){}}Ut.TYPE_2D=1e4,Ut.TYPE_CANVAS=10003,Ut.TYPE_CMDSETRT=10004,Ut.TYPE_CUSTOM=10005,Ut.TYPE_BLURRT=10006,Ut.TYPE_CMDDESTORYPRERT=10007,Ut.TYPE_DISABLESTENCIL=10008,Ut.TYPE_OTHERIBVB=10009,Ut.TYPE_PRIMITIVE=10010,Ut.TYPE_RT=10011,Ut.TYPE_BLUR_RT=10012,Ut.TYPE_TARGET=10013,Ut.TYPE_CHANGE_VALUE=10014,Ut.TYPE_SHAPE=10015,Ut.TYPE_TEXTURE=10016,Ut.TYPE_FILLTEXTURE=10017,Ut.KEY_ONCE=-1,Ut.KEY_FILLRECT=1,Ut.KEY_DRAWTEXTURE=2,Ut.KEY_VG=3,Ut.KEY_TRIANGLES=4,Ut.ID=1,Ut.preRender=null,t.RenderParams=void 0,(It=t.RenderParams||(t.RenderParams={}))[It.Max_Active_Texture_Count=0]="Max_Active_Texture_Count",It[It.Max_Uniform_Count=1]="Max_Uniform_Count",It[It.Max_AnisoLevel_Count=2]="Max_AnisoLevel_Count",It[It.MAX_Texture_Size=3]="MAX_Texture_Size",It[It.MAX_Texture_Image_Uint=4]="MAX_Texture_Image_Uint",It[It.SHADER_CAPAILITY_LEVEL=5]="SHADER_CAPAILITY_LEVEL",It[It.FLOAT=6]="FLOAT",It[It.UNSIGNED_BYTE=7]="UNSIGNED_BYTE",It[It.BYTE=8]="BYTE",It[It.UNSIGNED_SHORT=9]="UNSIGNED_SHORT";class Gt{static __init__(){Gt._elementInfos={single:[1,g.renderEngine.getParams(t.RenderParams.FLOAT),0],vector2:[2,g.renderEngine.getParams(t.RenderParams.FLOAT),0],vector3:[3,g.renderEngine.getParams(t.RenderParams.FLOAT),0],vector4:[4,g.renderEngine.getParams(t.RenderParams.FLOAT),0],color:[4,g.renderEngine.getParams(t.RenderParams.FLOAT),0],byte4:[4,g.renderEngine.getParams(t.RenderParams.UNSIGNED_BYTE),0],byte3:[3,g.renderEngine.getParams(t.RenderParams.UNSIGNED_BYTE),0],byte2:[2,g.renderEngine.getParams(t.RenderParams.UNSIGNED_BYTE),0],byte:[1,g.renderEngine.getParams(t.RenderParams.UNSIGNED_BYTE),0],short2:[2,g.renderEngine.getParams(t.RenderParams.UNSIGNED_SHORT),0],short4:[4,g.renderEngine.getParams(t.RenderParams.UNSIGNED_SHORT),0],normalizedshort2:[2,g.renderEngine.getParams(t.RenderParams.UNSIGNED_SHORT),1],normalizedshort4:[4,g.renderEngine.getParams(t.RenderParams.UNSIGNED_SHORT),1],halfvector2:[2,g.renderEngine.getParams(t.RenderParams.FLOAT),0],halfvector4:[4,g.renderEngine.getParams(t.RenderParams.FLOAT),0],nbyte4:[4,g.renderEngine.getParams(t.RenderParams.BYTE),1]}}static getElementInfos(t){var e=Gt._elementInfos[t];if(e)return e;throw"VertexElementFormat: this vertexElementFormat is not implement."}}Gt.Single="single",Gt.Vector2="vector2",Gt.Vector3="vector3",Gt.Vector4="vector4",Gt.Color="color",Gt.Byte4="byte4",Gt.Byte3="byte3",Gt.Byte2="byte2",Gt.ByteOne="byte",Gt.Short2="short2",Gt.Short4="short4",Gt.NormalizedShort2="normalizedshort2",Gt.NormalizedShort4="normalizedshort4",Gt.HalfVector2="halfvector2",Gt.HalfVector4="halfvector4",Gt.NorByte4="nbyte4";class kt{get id(){return this._id}get vertexStride(){return this._vertexStride}get vertexElementCount(){return this._vertexElements.length}constructor(t,e){this._id=++kt._uniqueIDCounter,this._vertexElementsDic={},this._vertexStride=t,this._vertexElements=e;var i=e.length;this._shaderValues={};for(var r=0;r<i;r++){var s=e[r],a=s._elementUsage;this._vertexElementsDic[a]=s;var n=new Int32Array(5),h=Gt.getElementInfos(s._elementFormat);n[0]=h[0],n[1]=h[1],n[2]=h[2],n[3]=this._vertexStride,n[4]=s._offset,this._shaderValues[a]=n}}getVertexElementByIndex(t){return this._vertexElements[t]}getVertexElementByUsage(t){return this._vertexElementsDic[t]}}kt._uniqueIDCounter=1;class Wt{get offset(){return this._offset}get elementFormat(){return this._elementFormat}get elementUsage(){return this._elementUsage}constructor(t,e,i){this._offset=t,this._elementFormat=e,this._elementUsage=i}}t.BufferTargetType=void 0,(Pt=t.BufferTargetType||(t.BufferTargetType={}))[Pt.ARRAY_BUFFER=0]="ARRAY_BUFFER",Pt[Pt.ELEMENT_ARRAY_BUFFER=1]="ELEMENT_ARRAY_BUFFER",Pt[Pt.UNIFORM_BUFFER=2]="UNIFORM_BUFFER",Pt[Pt.COPY_READ_BUFFER=3]="COPY_READ_BUFFER",Pt[Pt.COPY_WRITE_BUFFER=4]="COPY_WRITE_BUFFER",Pt[Pt.TRANSFORM_FEEDBACK_BUFFER=5]="TRANSFORM_FEEDBACK_BUFFER",Pt[Pt.PIXEL_PACK_BUFFER=6]="PIXEL_PACK_BUFFER",Pt[Pt.PIXEL_UNPACK_BUFFER=7]="PIXEL_UNPACK_BUFFER",t.BufferUsage=void 0,(Bt=t.BufferUsage||(t.BufferUsage={}))[Bt.Static=0]="Static",Bt[Bt.Dynamic=1]="Dynamic",Bt[Bt.Stream=2]="Stream";class Vt{constructor(){this._nativeVertexArrayObject=g.renderEngine.createVertexState()}applyVertexBuffers(){this._nativeVertexArrayObject.applyVertexBuffer(this._vertexBuffers)}applyIndexBuffers(){this._nativeVertexArrayObject.applyIndexBuffer(this._bindedIndexBuffer)}applyState(t,e){this._vertexBuffers=t,this._bindedIndexBuffer=e,e&&e.unbind(),this.bind(),this.applyVertexBuffers(),this.applyIndexBuffers(),this.unBind(),e&&e.unbind()}bind(){this._nativeVertexArrayObject.bindVertexArray(),Vt._curBindedBufferState=this}unBind(){if(Vt._curBindedBufferState!=this)throw"BufferState: must call bind() function first.";this._nativeVertexArrayObject.unbindVertexArray(),Vt._curBindedBufferState=null}isbind(){return Vt._curBindedBufferState==this}destroy(){this._nativeVertexArrayObject.destroy(),this._nativeVertexArrayObject=null}}t.IndexFormat=void 0,(Lt=t.IndexFormat||(t.IndexFormat={}))[Lt.UInt8=0]="UInt8",Lt[Lt.UInt16=1]="UInt16",Lt[Lt.UInt32=2]="UInt32";class Xt{get bufferUsage(){return this._bufferUsage}constructor(t,e){this._byteLength=0,this._glBuffer=g.renderEngine.createBuffer(t,e),this._bufferType=t,this._bufferUsage=e}bind(){return this._glBuffer.bindBuffer()}unbind(){return this._glBuffer.unbindBuffer()}resizelength(t){this._byteLength=t,this._glBuffer.resizeBuffer(this._byteLength)}destroy(){this._glBuffer&&(this._glBuffer.destroy(),this._glBuffer=null)}}class Ht extends Xt{constructor(e,i){super(e,i),this._indexType=t.IndexFormat.UInt16}_setIndexData(t,e){var i=Vt._curBindedBufferState;i?i._bindedIndexBuffer===this?this._glBuffer.setDataLength(0):(i.unBind(),this.bind(),"number"==typeof t?this._glBuffer.setDataLength(t):this._glBuffer.setData(t,e),i.bind()):(this.bind(),"number"==typeof t?this._glBuffer.setDataLength(t):this._glBuffer.setData(t,e))}}class Yt{}Yt.loopStTm=0,Yt.loopCount=0;class zt{get bufferLength(){return this.constBuffer._buffer.byteLength}set byteLength(t){this.setByteLength(t)}setByteLength(t){this.constBuffer._byteLength!==t&&(t<=this._bufferSize||this._resizeBuffer(2*t+256,!0),this.constBuffer._byteLength=t)}needSize(t){var e=this.constBuffer._byteLength;if(t){var i=this.constBuffer._byteLength+t;i<=this._bufferSize||this._resizeBuffer(i<<1,!0),this.constBuffer._byteLength=i}return e}constructor(t){this._maxsize=0,this._upload=!0,this._uploadSize=0,this._bufferSize=0,this._u8Array=null,this.constBuffer=t}getFloat32Array(){return this._floatArray32||(this._floatArray32=new Float32Array(this.constBuffer._buffer.buffer)),this._floatArray32}_bufferData(){if(this._maxsize=Math.max(this._maxsize,this.constBuffer._byteLength),Yt.loopCount%30==0){if(this.constBuffer._buffer.byteLength>this._maxsize+64){this.constBuffer._buffer=this.constBuffer._buffer.slice(0,this._maxsize+64),this._bufferSize=this.constBuffer._buffer.byteLength,this._checkArrayUse();let t=this.constBuffer._buffer.buffer;this._bufferSize%4==0&&(this._floatArray32=new Float32Array(t)),this._bufferSize%4==0&&(this._uint32Array=new Uint32Array(t)),this._uint16Array=new Uint16Array(t)}this._maxsize=this.constBuffer._byteLength}this._uploadSize<this.constBuffer._buffer.byteLength&&(this._uploadSize=this.constBuffer._buffer.byteLength,this.constBuffer._glBuffer.setDataLength(this._uploadSize)),this.constBuffer._glBuffer.setData(new Uint8Array(this.constBuffer._buffer.buffer,0,this.constBuffer._byteLength),0),this.constBuffer.unbind()}_bufferSubData(t=0,e=0,i=0){if(this._maxsize=Math.max(this._maxsize,this.constBuffer._byteLength),Yt.loopCount%30==0&&(this.constBuffer._buffer.byteLength>this._maxsize+64&&(this.constBuffer._buffer=this.constBuffer._buffer.slice(0,this._maxsize+64),this._bufferSize=this.constBuffer._buffer.byteLength,this._checkArrayUse()),this._maxsize=this.constBuffer._byteLength),this._uploadSize<this.constBuffer._buffer.byteLength&&(this._uploadSize=this.constBuffer._buffer.byteLength,this.constBuffer._glBuffer.setDataLength(this._uploadSize)),e||i){var r=this.constBuffer._buffer.buffer.slice(e,i);this.constBuffer._glBuffer.setData(r,t)}else this.constBuffer._glBuffer.setData(this.constBuffer._buffer.buffer,t)}_checkArrayUse(){}_bind_upload(){return!!this._upload&&(this._upload=!1,this.constBuffer.bind(),this._bufferData(),!0)}_bind_subUpload(t=0,e=0,i=0){return!!this._upload&&(this._upload=!1,this.constBuffer.bind(),this._bufferSubData(t,e,i),!0)}_resizeBuffer(t,e){var i=this.constBuffer._buffer;if(i&&t<=i.byteLength)return this;if(this._u8Array,e&&i&&i.byteLength>0){var r=new Uint8Array(i.buffer),s=new Uint8Array(t);s.set(r,0),i=this.constBuffer._buffer=s,this._u8Array=new Uint8Array(this.constBuffer._buffer.buffer)}else{var a=new ArrayBuffer(t);i=this.constBuffer._buffer=new Uint8Array(a),this._u8Array=new Uint8Array(i.buffer)}return i=this.constBuffer._buffer.buffer,t%4==0&&(this._floatArray32=new Float32Array(i)),t%4==0&&(this._uint32Array=new Uint32Array(i)),this._uint16Array=new Uint16Array(i),this._checkArrayUse(),this._upload=!0,this._bufferSize=i.byteLength,this}append(t){var e,i;this._upload=!0,e=t.byteLength,t instanceof Uint8Array?(this._resizeBuffer(this.constBuffer._byteLength+e,!0),i=new Uint8Array(this.constBuffer._buffer.buffer,this.constBuffer._byteLength)):t instanceof Uint16Array?(this._resizeBuffer(this.constBuffer._byteLength+e,!0),i=new Uint16Array(this.constBuffer._buffer.buffer,this.constBuffer._byteLength)):t instanceof Float32Array&&(this._resizeBuffer(this.constBuffer._byteLength+e,!0),i=new Float32Array(this.constBuffer._buffer.buffer,this.constBuffer._byteLength)),i.set(t,0),this.constBuffer._byteLength+=e,this._checkArrayUse()}appendU16Array(t,e){this._resizeBuffer(this.constBuffer._byteLength+2*e,!0);var i=new Uint16Array(this.constBuffer._buffer.buffer,this.constBuffer._byteLength,e);if(6==e)i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[4]=t[4],i[5]=t[5];else if(e>=100)i.set(new Uint16Array(t.buffer,0,e));else for(var r=0;r<e;r++)i[r]=t[r];this.constBuffer._byteLength+=2*e,this._checkArrayUse()}getBuffer(){return this.constBuffer._buffer.buffer}setNeedUpload(){this._upload=!0}subUpload(t=0,e=0,i=0){var r=this._bind_subUpload();return this.constBuffer.unbind(),H.activeShader=null,r}_disposeResource(){this._upload=!0,this._uploadSize=0,this._floatArray32=null,this._uint32Array=null,this._u8Array=null}clear(){this.constBuffer._byteLength=0,this._upload=!0}}zt.FLOAT32=4,zt.SHORT=2;class jt extends Ht{constructor(e=t.BufferUsage.Static){super(t.BufferTargetType.ELEMENT_ARRAY_BUFFER,e),this.buffer2D=new zt(this),this._bufferUsage=e,this._buffer=new Uint8Array(8)}_bindForVAO(){this._glBuffer.bindBuffer()}destory(){this._uint16Array=null,this._buffer=null}disposeResource(){this.buffer2D._disposeResource()}}jt.create=function(e=t.BufferUsage.Static){return new jt(e)};class Kt extends Xt{get vertexDeclaration(){return this._vertexDeclaration}set vertexDeclaration(t){this._vertexDeclaration=t}get instanceBuffer(){return this._instanceBuffer}set instanceBuffer(t){this._instanceBuffer=t}constructor(t,e){super(t,e),this._instanceBuffer=!1,this._vertexDeclaration=null}}class qt extends Kt{get vertexStride(){return this._vertexStride}constructor(e,i){super(t.BufferTargetType.ARRAY_BUFFER,i),this.buffer2D=new zt(this),this._vertexStride=e,this._bufferUsage=i}getFloat32Array(){return this.buffer2D._floatArray32}get _floatArray32(){return this.buffer2D._floatArray32}get _uint32Array(){return this.buffer2D._uint32Array}appendArray(t){var e=this._byteLength>>2;this.buffer2D.setByteLength(this._byteLength+4*t.length),this.getFloat32Array().set(t,e),this.buffer2D._upload=!0}deleteBuffer(){this.buffer2D._disposeResource()}_bindForVAO(){this._glBuffer.bindBuffer()}destroy(){super.destroy(),this._byteLength=0,this.buffer2D._upload=!0,this._buffer=null}}qt.create=function(e,i=t.BufferUsage.Dynamic){return new qt(e,i)};class $t{constructor(i,r,s){this._stride=0,this.vertNum=0,this.indexNum=0,this._applied=!1,this._quadNum=0,this.canReuse=!1,this._stride=i,this._vb=new qt(i,t.BufferUsage.Dynamic),r?this._vb.buffer2D._resizeBuffer(r,!1):e.webGL2D_MeshAllocMaxMem&&this._vb.buffer2D._resizeBuffer(65536*i,!1),this._ib=new jt,s&&this._ib.buffer2D._resizeBuffer(s,!1)}createQuadIB(t){this._quadNum=t,this._ib.buffer2D._resizeBuffer(6*t*2,!1),this._ib.buffer2D.byteLength=this._ib.buffer2D.bufferLength;for(var e=this._ib.buffer2D._uint16Array,i=0,r=0,s=0;s<t;s++)e[i++]=r,e[i++]=r+2,e[i++]=r+1,e[i++]=r,e[i++]=r+3,e[i++]=r+2,r+=4;this._ib.buffer2D.setNeedUpload()}setAttributes(t){if(this._attribInfo=t,this._attribInfo.length%3!=0)throw"Mesh2D setAttributes error!"}configVAO(){this._applied||(this._applied=!0,this._vao||(this._vao=new Vt),this._vao.applyState([this._vb],this._ib))}useMesh(){this._vao&&!this._vao.isbind()&&Vt._curBindedBufferState&&Vt._curBindedBufferState.unBind(),this._applied||this.configVAO(),this._ib.buffer2D._bind_upload(),this._vb.buffer2D._bind_upload(),this._vao.bind()}releaseMesh(){}destroy(){}clearVB(){this._vb.buffer2D.clear()}}$t._gvaoid=0;class Zt extends $t{static __int__(){Zt._fixattriInfo=[5126,4,0,5121,4,16,5121,4,20]}constructor(){super(Zt.const_stride,4,4),this.canReuse=!0,this.setAttributes(Zt._fixattriInfo),Zt._fixib?(this._ib=Zt._fixib,this._quadNum=Zt._maxIB):(this.createQuadIB(Zt._maxIB),Zt._fixib=this._ib),Zt.VertexDeclarition||(Zt.VertexDeclarition=new kt(24,[new Wt(0,Gt.Vector4,0),new Wt(16,Gt.Byte4,1),new Wt(20,Gt.Byte4,2)])),this._vb.vertexDeclaration=Zt.VertexDeclarition}static getAMesh(t){var e=null;return e=Zt._POOL.length?Zt._POOL.pop():new Zt,t&&e._vb.buffer2D._resizeBuffer(65536*Zt.const_stride,!1),e}releaseMesh(){this._vb.buffer2D.setByteLength(0),this.vertNum=0,this.indexNum=0,Zt._POOL.push(this)}destroy(){this._vb.destroy(),this._vb.deleteBuffer()}addQuad(t,e,i,r){var s=this._vb,a=s._byteLength>>2;s.buffer2D.setByteLength(a+Zt.const_stride<<2);var n=s._floatArray32||s.getFloat32Array(),h=s._uint32Array,o=a,l=r?255:0;n[o++]=t[0],n[o++]=t[1],n[o++]=e[0],n[o++]=e[1],h[o++]=i,h[o++]=l,n[o++]=t[2],n[o++]=t[3],n[o++]=e[2],n[o++]=e[3],h[o++]=i,h[o++]=l,n[o++]=t[4],n[o++]=t[5],n[o++]=e[4],n[o++]=e[5],h[o++]=i,h[o++]=l,n[o++]=t[6],n[o++]=t[7],n[o++]=e[6],n[o++]=e[7],h[o++]=i,h[o++]=l,s.buffer2D._upload=!0}}Zt.const_stride=24,Zt._maxIB=16384,Zt._POOL=[];class Qt extends $t{static __init__(){Qt._fixattriInfo=[5126,4,0,5121,4,16,5121,4,20]}constructor(){super(Qt.const_stride,4,4),this.canReuse=!0,this.setAttributes(Qt._fixattriInfo),Qt.VertexDeclarition||(Qt.VertexDeclarition=new kt(24,[new Wt(0,Gt.Vector4,0),new Wt(16,Gt.Byte4,1),new Wt(20,Gt.Byte4,2)])),this._vb.vertexDeclaration=Qt.VertexDeclarition}static getAMesh(t){var e;return e=Qt._POOL.length?Qt._POOL.pop():new Qt,t&&e._vb.buffer2D._resizeBuffer(65536*Qt.const_stride,!1),e}addData(t,e,i,r,s){var a=this._vb,n=this._ib,h=t.length>>1,o=a.buffer2D.needSize(h*Qt.const_stride)>>2,l=a._floatArray32||a.getFloat32Array(),_=a._uint32Array,u=0,d=r.a,c=r.b,p=r.c,f=r.d,m=r.tx,g=r.ty,T=0;for(T=0;T<h;T++){var x=t[u],E=t[u+1];l[o]=x*d+E*p+m,l[o+1]=x*c+E*f+g,l[o+2]=e[u],l[o+3]=e[u+1],_[o+4]=s,_[o+5]=255,o+=6,u+=2}a.buffer2D.setNeedUpload();var y=this.vertNum,v=i.length,S=n.buffer2D.needSize(i.byteLength),R=n.buffer2D._uint16Array,b=S>>1;if(y>0){var C=b+v,A=0;for(T=b;T<C;T++,A++)R[T]=i[A]+y}else R.set(i,b);n.buffer2D.setNeedUpload(),this.vertNum+=h,this.indexNum+=i.length}releaseMesh(){this._vb.buffer2D.setByteLength(0),this._ib.buffer2D.setByteLength(0),this.vertNum=0,this.indexNum=0,Qt._POOL.push(this)}destroy(){this._ib.destroy(),this._vb.destroy(),this._ib.disposeResource(),this._vb.deleteBuffer()}}Qt.const_stride=24,Qt._POOL=[];class Jt extends $t{static __init__(){Jt._fixattriInfo=[5126,2,0,5121,4,8]}constructor(){super(Jt.const_stride,4,4),this.canReuse=!0,this.setAttributes(Jt._fixattriInfo),Jt.vertexDeclaration||(Jt.vertexDeclaration=new kt(12,[new Wt(0,Gt.Vector2,0),new Wt(8,Gt.Byte4,1)])),this._vb.vertexDeclaration=Jt.vertexDeclaration}static getAMesh(t){var e;return e=Jt._POOL.length?Jt._POOL.pop():new Jt,t&&e._vb.buffer2D._resizeBuffer(65536*Jt.const_stride,!1),e}addVertAndIBToMesh(t,e,i,r){for(var s=this._vb.buffer2D.needSize(e.length/2*Jt.const_stride)>>2,a=this._vb._floatArray32||this._vb.getFloat32Array(),n=this._vb._uint32Array,h=0,o=e.length/2,l=0;l<o;l++)a[s++]=e[h],a[s++]=e[h+1],h+=2,n[s++]=i;this._vb.buffer2D.setNeedUpload(),this._ib.buffer2D.append(new Uint16Array(r)),this._ib.buffer2D.setNeedUpload(),this.vertNum+=o,this.indexNum+=r.length}releaseMesh(){this._vb.buffer2D.setByteLength(0),this._ib.buffer2D.setByteLength(0),this.vertNum=0,this.indexNum=0,Jt._POOL.push(this)}destroy(){this._ib.destroy(),this._vb.destroy(),this._ib.disposeResource(),this._vb.deleteBuffer()}}Jt.const_stride=12,Jt._POOL=[],Jt.vertexDeclaration=null;class te{constructor(t,e){this._context=t,this._nativeObj=new window._conchWebGLCacheAsNormalCanvas(t._nativeObj,0)}startRec(){this._nativeObj.startRec()}endRec(){this._nativeObj.endRec()}isCacheValid(){return this._nativeObj.isCacheValid()}isTextNeedRestore(){return this._nativeObj.isTextNeedRestore()}get context(){return this._context}}class ee{constructor(t,e){this.submitStartPos=0,this.submitEndPos=0,this.touches=[],this.submits=[],this.sprite=null,this.meshlist=[],this.cachedClipInfo=new p,this.oldTx=0,this.oldTy=0,this.invMat=new p,this.context=t,this.sprite=e,t._globalClipMatrix.copyTo(this.cachedClipInfo)}startRec(){let t=this.context;t._charSubmitCache&&t._charSubmitCache._enable&&(t._charSubmitCache.enable(!1,t),t._charSubmitCache.enable(!0,t)),t._incache=!0,this.touches.length=0,t.touches=this.touches,t._globalClipMatrix.copyTo(this.cachedClipInfo),this.submits.length=0,this.submitStartPos=t._submits._length;for(var e=0,i=this.meshlist.length;e<i;e++){var r=this.meshlist[e];r.canReuse?r.releaseMesh():r.destroy()}this.meshlist.length=0,this._mesh=Zt.getAMesh(!1),this._pathMesh=Jt.getAMesh(!1),this._triangleMesh=Qt.getAMesh(!1),this.meshlist.push(this._mesh),this.meshlist.push(this._pathMesh),this.meshlist.push(this._triangleMesh),t._curSubmit=Ut.RENDERBASE,this._oldMesh=t._mesh,this._oldPathMesh=t._pathMesh,this._oldTriMesh=t._triangleMesh,this._oldMeshList=t.meshlist,t._mesh=this._mesh,t._pathMesh=this._pathMesh,t._triangleMesh=this._triangleMesh,t.meshlist=this.meshlist,this.oldTx=t._curMat.tx,this.oldTy=t._curMat.ty,t._curMat.tx=0,t._curMat.ty=0,t._curMat.copyTo(this.invMat),this.invMat.invert()}endRec(){let t=this.context;t._charSubmitCache&&t._charSubmitCache._enable&&(t._charSubmitCache.enable(!1,t),t._charSubmitCache.enable(!0,t));var e=t._submits;this.submitEndPos=e._length;for(var i=this.submitEndPos-this.submitStartPos,r=0;r<i;r++)this.submits.push(e[this.submitStartPos+r]);e._length-=i,t._mesh=this._oldMesh,t._pathMesh=this._oldPathMesh,t._triangleMesh=this._oldTriMesh,t.meshlist=this._oldMeshList,t._curSubmit=Ut.RENDERBASE,t._curMat.tx=this.oldTx,t._curMat.ty=this.oldTy,t.touches=null,t._incache=!1}isCacheValid(){var t=this.context._globalClipMatrix;return t.a==this.cachedClipInfo.a&&t.b==this.cachedClipInfo.b&&t.c==this.cachedClipInfo.c&&t.d==this.cachedClipInfo.d&&t.tx==this.cachedClipInfo.tx&&t.ty==this.cachedClipInfo.ty}isTextNeedRestore(){var t=!1,e=this.touches;if(e)for(var i=0;i<e.length;i++)if(e[i].deleted){t=!0;break}return t}flushsubmit(){var t=Ut.RENDERBASE;this.submits.forEach((function(e){e!=Ut.RENDERBASE&&(Ut.preRender=t,t=e,e.renderSubmit())}))}releaseMem(){}}ee.matI=new p,window.conch&&!window.conchConfig.conchWebGL&&(ee=te);class ie{static __init__(){ie.map[Mt.ALPHA|Mt.TRANSFORM|Mt.GRAPHICS]=ie.alpha_transform_drawLayaGL,ie.map[Mt.ALPHA|Mt.GRAPHICS]=ie.alpha_drawLayaGL,ie.map[Mt.TRANSFORM|Mt.GRAPHICS]=ie.transform_drawLayaGL,ie.map[Mt.TRANSFORM|Mt.CHILDS]=ie.transform_drawNodes,ie.map[Mt.ALPHA|Mt.TRANSFORM|Mt.TEXTURE]=ie.alpha_transform_drawTexture,ie.map[Mt.ALPHA|Mt.TEXTURE]=ie.alpha_drawTexture,ie.map[Mt.TRANSFORM|Mt.TEXTURE]=ie.transform_drawTexture,ie.map[Mt.GRAPHICS|Mt.CHILDS]=ie.drawLayaGL_drawNodes}static transform_drawTexture(t,e,i,s){t._style;var a=t.texture;e.saveTransform(ie.curMat),e.transformByMatrix(t.transform,i,s);var n=t._width||a.sourceWidth,h=t._height||a.sourceHeight,o=n/a.sourceWidth,l=h/a.sourceHeight;if(n=a.width*o,h=a.height*l,n<=0||h<=0)return null;var _=-t.pivotX+a.offsetX*o,u=-t.pivotY+a.offsetY*l;t._getBit(r.HIDE_BY_EDITOR)||e.drawTexture(a,_,u,n,h),e.restoreTransform(ie.curMat)}static alpha_drawTexture(t,e,i,s){var a,n=t._style,h=t.texture;if((a=n.alpha)>.01||t._needRepaint()){var o=e.globalAlpha;e.globalAlpha*=a;var l=t._width||h.width,_=t._height||h.height,u=l/h.sourceWidth,d=_/h.sourceHeight;if(l=h.width*u,_=h.height*d,l<=0||_<=0)return null;var c=i-n.pivotX+h.offsetX*u,p=s-n.pivotY+h.offsetY*d;t._getBit(r.HIDE_BY_EDITOR)||e.drawTexture(h,c,p,l,_),e.globalAlpha=o}}static alpha_transform_drawTexture(t,e,i,s){var a,n=t._style,h=t.texture;if((a=n.alpha)>.01||t._needRepaint()){var o=e.globalAlpha;e.globalAlpha*=a,e.saveTransform(ie.curMat),e.transformByMatrix(t.transform,i,s);var l=t._width||h.sourceWidth,_=t._height||h.sourceHeight,u=l/h.sourceWidth,d=_/h.sourceHeight;if(l=h.width*u,_=h.height*d,l<=0||_<=0)return null;var c=-n.pivotX+h.offsetX*u,p=-n.pivotY+h.offsetY*d;t._getBit(r.HIDE_BY_EDITOR)||e.drawTexture(h,c,p,l,_),e.restoreTransform(ie.curMat),e.globalAlpha=o}}static alpha_transform_drawLayaGL(t,e,i,s){var a,n=t._style;if((a=n.alpha)>.01||t._needRepaint()){var h=e.globalAlpha;e.globalAlpha*=a,e.saveTransform(ie.curMat),e.transformByMatrix(t.transform,i,s),t._getBit(r.HIDE_BY_EDITOR)||t._graphics&&t._graphics._render(t,e,-n.pivotX,-n.pivotY),e.restoreTransform(ie.curMat),e.globalAlpha=h}}static alpha_drawLayaGL(t,e,i,s){var a,n=t._style;if((a=n.alpha)>.01||t._needRepaint()){var h=e.globalAlpha;e.globalAlpha*=a,t._getBit(r.HIDE_BY_EDITOR)||t._graphics&&t._graphics._render(t,e,i-n.pivotX,s-n.pivotY),e.globalAlpha=h}}static transform_drawLayaGL(t,e,i,s){var a=t._style;e.saveTransform(ie.curMat),e.transformByMatrix(t.transform,i,s),t._getBit(r.HIDE_BY_EDITOR)||t._graphics&&t._graphics._render(t,e,-a.pivotX,-a.pivotY),e.restoreTransform(ie.curMat)}static transform_drawNodes(t,e,i,s){var a=t._getBit(r.DRAWCALL_OPTIMIZE)&&e.drawCallOptimize(!0);let n=e._drawingToTexture;var h=t._style;e.saveTransform(ie.curMat),e.transformByMatrix(t.transform,i,s),i=-h.pivotX,s=-h.pivotY;var o=t._children,l=o.length;let _,u,d,c,p,f,m;h.viewport&&(_=h.viewport,u=_.x,d=_.y,c=_.right,p=_.bottom);for(let t=0;t<l;++t){let a,h=o[t];a=n?h._visible&&!h._getBit(r.ESCAPE_DRAWING_TO_TEXTURE):h._visible||h._getBit(r.DISABLE_VISIBILITY),_&&((f=h._x)>=c||f+h.width<=u||(m=h._y)>=p||m+h.height<=d)&&(a=!1),a&&h.render(e,i,s)}e.restoreTransform(ie.curMat),a&&e.drawCallOptimize(!1)}static drawLayaGL_drawNodes(t,e,i,s){var a=t._getBit(r.DRAWCALL_OPTIMIZE)&&e.drawCallOptimize(!0);let n=e._drawingToTexture;var h=t._style;i-=h.pivotX,s-=h.pivotY,t._getBit(r.HIDE_BY_EDITOR)||t._graphics&&t._graphics._render(t,e,i,s);var o=t._children,l=o.length;let _,u,d,c,p,f,m;h.viewport&&(_=h.viewport,u=_.x,d=_.y,c=_.right,p=_.bottom);for(let t=0;t<l;++t){let a,h=o[t];a=n?h._visible&&!h._getBit(r.ESCAPE_DRAWING_TO_TEXTURE):h._visible||h._getBit(r.DISABLE_VISIBILITY),_&&((f=h._x)>=c||f+h.width<=u||(m=h._y)>=p||m+h.height<=d)&&(a=!1),a&&h.render(e,i,s)}a&&e.drawCallOptimize(!1)}}ie.map=[],ie.curMat=new p;class re{constructor(){}get type(){return-1}}re.BLUR=16,re.COLOR=32,re.GLOW=8,re._filter=function(e,i,r,s){var a=i,n=this._next;if(n){var h=e.filters,o=h.length;if(1==o&&h[0].type==re.COLOR)return i.save(),i.setColorFilter(h[0]),n._fun.call(n,e,i,r,s),void i.restore();var l,_=Tt.create(st.TEXTURE2D,0),u=f.TEMP,d=a._curMat,c=p.create();d.copyTo(c);var T=0,x=0,E=null,y=e._cacheStyle.filterCache||null;if(y&&0==e.getRepaint()){if((e._isHaveGlowFilter()||!1)&&(T=50,x=25),(l=e.getBounds()).width<=0||l.height<=0)return;l.width+=T+8,l.height+=T+8,l.x-=e.pivotX+4,l.y-=e.pivotY+4,u.x=l.x*c.a+l.y*c.c,u.y=l.y*c.d+l.x*c.b,l.x=u.x,l.y=u.y,u.x=l.width*c.a+l.height*c.c,u.y=l.height*c.d+l.width*c.b,l.width=u.x,l.height=u.y}else{e._isHaveGlowFilter()&&(T=50,x=25),(l=new m).copyFrom(e.getSelfBounds()),l.x+=e.x,l.y+=e.y,l.x-=e.pivotX+4,l.y-=e.pivotY+4;var v=l.x,S=l.y;if(l.width+=T+8,l.height+=T+8,u.x=l.x*c.a+l.y*c.c,u.y=l.y*c.d+l.x*c.b,l.x=u.x,l.y=u.y,u.x=l.width*c.a+l.height*c.c,u.y=l.height*c.d+l.width*c.b,l.width=u.x,l.height=u.y,l.width<=0||l.height<=0)return;y&&y.destroy(),E=new window.conchRenderTexture2D(g.renderEngine._nativeObj,l.width,l.height,t.RenderTargetFormat.R8G8B8A8,t.RenderTargetFormat.None);var R=y=new window.conchRenderTexture2D(g.renderEngine._nativeObj,l.width,l.height,t.RenderTargetFormat.R8G8B8A8,t.RenderTargetFormat.None);e._getCacheStyle().filterCache=y,a.pushRT(),a.useRT(E);var b=e.x-v+x,C=e.y-S+x;n._fun.call(n,e,i,b,C),a.useRT(R);for(var A=0;A<o;A++){0!=A&&(a.useRT(E),a.drawTarget(R,0,0,l.width,l.height,p.TEMP.identity(),_,null,it.TOINT.overlay),a.useRT(R));var w=h[A];switch(w.type){case re.BLUR:a.drawTargetBlurFilter(E,0,0,l.width,l.height,w.strength);break;case re.GLOW:w._glRender&&w._glRender.render(E,i,l.width,l.height,w);break;case re.COLOR:a.setColorFilter(w),a.drawTarget(E,0,0,l.width,l.height,p.EMPTY.identity(),Tt.create(st.TEXTURE2D,0)),a.setColorFilter(null)}}a.popRT()}r=r-x-e.x,s=s-x-e.y,u.setTo(r,s),c.transformPoint(u),r=u.x+l.x,s=u.y+l.y,a.drawFilter(y,E,r,s,l.width,l.height),c.destroy()}};class se{static __init__(){var t,e,i;for(ie.__init__(),i=new se(se.INIT,null),e=se.renders.length=2*Mt.CHILDS,t=0;t<e;t++)se.renders[t]=i;se.renders[0]=new se(0,null)}static _initRenderFun(t,e,i,r){var s=t._renderType;(se.renders[s]=se._getTypeRender(s))._fun(t,e,i,r)}static _getTypeRender(t){if(ie.map[t])return new se(t,null);for(var e=null,i=Mt.CHILDS;i>0;)i&t&&(e=new se(i,e)),i>>=1;return e}constructor(t,e){if(ie.map[t])return this._fun=ie.map[t],void(this._next=se.NORENDER);switch(this._next=e||se.NORENDER,t){case 0:return void(this._fun=this._no);case Mt.ALPHA:return void(this._fun=this._alpha);case Mt.TRANSFORM:return void(this._fun=this._transform);case Mt.BLEND:return void(this._fun=this._blend);case Mt.CANVAS:return void(this._fun=this._canvas);case Mt.MASK:return void(h.isConch&&!window.conchConfig.conchWebGL?this._fun=this._maskNative:this._fun=this._mask);case Mt.CLIP:return void(this._fun=this._clip);case Mt.STYLE:return void(this._fun=this._style);case Mt.GRAPHICS:return void(this._fun=this._graphics);case Mt.CHILDS:return void(this._fun=this._children);case Mt.CUSTOM:return void(this._fun=this._custom);case Mt.TEXTURE:return void(this._fun=this._texture);case Mt.FILTERS:return void(h.isConch&&!window.conchConfig.conchWebGL?this._fun=re._filter:this._fun=yt._filter);case Mt.HITAREA:return void(this._fun=this._hitarea);case se.INIT:return void(this._fun=se._initRenderFun)}this.onCreate(t)}onCreate(t){}_style(t,e,i,r){var s=t._style;null!=s.render&&s.render(t,e,i,r);var a=this._next;a._fun.call(a,t,e,i,r)}_no(t,e,i,r){}_custom(t,e,i,r){t.customRender(e,i,r),this._next._fun.call(this._next,t,e,0,0)}_clip(t,e,i,s){var a=this._next;if(a!=se.NORENDER)if(t._getBit(r.DISABLE_INNER_CLIPPING))a._fun.call(a,t,e,i,s);else{var n=t._style.scrollRect,h=n.width,o=n.height;0!==h&&0!==o&&(e.save(),e.clipRect(i,s,h,o),a._fun.call(a,t,e,i-n.x,s-n.y),e.restore())}}_texture(t,e,i,s){if(!t._getBit(r.HIDE_BY_EDITOR)){var a=t.texture;if(a._getSource()){var n=t._width||a.sourceWidth,h=t._height||a.sourceHeight,o=n/a.sourceWidth,l=h/a.sourceHeight;if(n=a.width*o,h=a.height*l,n<=0||h<=0)return;var _=i-t.pivotX+a.offsetX*o,u=s-t.pivotY+a.offsetY*l;e.drawTexture(a,_,u,n,h)}}var d=this._next;d!=se.NORENDER&&d._fun.call(d,t,e,i,s)}_graphics(t,e,i,s){if(!t._getBit(r.HIDE_BY_EDITOR)){var a=t._style,n=t._graphics;n&&n._render(t,e,i-a.pivotX,s-a.pivotY)}var h=this._next;h!=se.NORENDER&&h._fun.call(h,t,e,i,s)}_hitarea(t,e,i,r){if(!e._drawingToTexture&&t.hitArea){var s=t._style,a=t.hitArea._hit,n=e.globalAlpha;e.globalAlpha*=.5,a&&a._render(t,e,i-s.pivotX,r-s.pivotY),(a=t.hitArea._unHit)&&a._render(t,e,i-s.pivotX,r-s.pivotY),e.globalAlpha=n}var h=this._next;h!=se.NORENDER&&h._fun.call(h,t,e,i,r)}_alpha(t,e,i,r){var s;if((s=t._style.alpha)>.01||t._needRepaint()){var a=e.globalAlpha;e.globalAlpha*=s;var n=this._next;n._fun.call(n,t,e,i,r),e.globalAlpha=a}}_transform(t,e,i,r){var s=t.transform,a=this._next;t._style,s&&a!=se.NORENDER?(e.save(),e.transform(s.a,s.b,s.c,s.d,s.tx+i,s.ty+r),a._fun.call(a,t,e,0,0),e.restore()):a!=se.NORENDER&&a._fun.call(a,t,e,i,r)}_children(t,e,i,s){let a=t._style,n=t._children,h=n.length;i-=t.pivotX,s-=t.pivotY;let o,l,_,u,d,c,p,f=t._getBit(r.DRAWCALL_OPTIMIZE)&&e.drawCallOptimize(!0),m=e._drawingToTexture;a.viewport&&(o=a.viewport,l=o.x,_=o.y,u=o.right,d=o.bottom);for(let a=0;a<h;++a){let h,f=n[a];h=m?f._visible&&!f._getBit(r.ESCAPE_DRAWING_TO_TEXTURE):f._visible||f._getBit(r.DISABLE_VISIBILITY),h&&(o&&((c=f._x)>=u||c+f.width<=l||(p=f._y)>=d||p+f.height<=_)?h=!1:t._cacheStyle.mask!=f||f._getBit(r.DISABLE_VISIBILITY)||(h=!1)),h&&(f._getBit(r.DISABLE_OUTER_CLIPPING)&&e.clipRect(0,0,1,1,!0),f.render(e,i,s))}f&&e.drawCallOptimize(!1)}_canvas(t,e,i,s){var a=t._cacheStyle,h=this._next;if(!a.enableCanvasRender||!e._drawingToTexture&&a.mask&&a.mask._getBit(r.DISABLE_VISIBILITY))h._fun.call(h,t,e,i,s);else{"bitmap"===a.cacheAs?Nt.canvasBitmap++:Nt.canvasNormal++;var o=!1,l=!1;if(a.canvas){var _=a.canvas;l=_.isTextNeedRestore&&_.isTextNeedRestore(),o=_.isCacheValid&&!_.isCacheValid()}if(t._needRepaint()||!a.canvas||l||o||n.stage.isGlobalRepaint())if("normal"===a.cacheAs){if(e._targets)return void h._fun.call(h,t,e,i,s);this._canvas_webgl_normal_repaint(t,e)}else this._canvas_repaint(t,e,i,s);var u=a.cacheRect;e.drawCanvas(a.canvas,i+u.x,s+u.y,u.width,u.height)}}_canvas_repaint(t,e,i,r){var s,a,n,h,o,l,_,u,d,c=t._cacheStyle,p=this._next,f=c.canvas,m=c.cacheAs;if(_=(d=c._calculateCacheRect(t,m,i,r)).x,u=d.y,o=(h=c.cacheRect).width*_,l=h.height*u,a=h.x,n=h.y,"bitmap"===m&&(o>2048||l>2048))return console.warn("cache bitmap size larger than 2048,cache ignored"),c.releaseContext(),void p._fun.call(p,t,e,i,r);if(f||(c.createContext(),f=c.canvas),(s=f.context).sprite=t,(f.width!=o||f.height!=l)&&f.size(o,l),"bitmap"===m?s.asBitmap=!0:"normal"===m&&(s.asBitmap=!1),s.clear(),1!=_||1!=u){var g=s;g.save(),g.scale(_,u),p._fun.call(p,t,s,-a,-n),g.restore(),t._applyFilters()}else g=s,p._fun.call(p,t,s,-a,-n),t._applyFilters();c.staticCache&&(c.reCache=!1),Nt.canvasReCache++}_canvas_webgl_normal_repaint(t,e){var i=t._cacheStyle,r=this._next,s=i.canvas,a=i.cacheAs;i._calculateCacheRect(t,a,0,0),s||(s=new ee(e,t),i.canvas=s);var n=s.context;s.startRec(),r._fun.call(r,t,n,t.pivotX,t.pivotY),t._applyFilters(),Nt.canvasReCache++,s.endRec()}_blend(t,e,i,r){var s=t._style,a=this._next;s.blendMode?(e.save(),e.globalCompositeOperation=s.blendMode,a._fun.call(a,t,e,i,r),e.restore()):a._fun.call(a,t,e,i,r)}_mask(t,e,i,s){var a=this._next,n=t.mask,h=e;if(!n||n._getBit(r.DISABLE_VISIBILITY)&&!e._drawingToTexture)a._fun.call(a,t,e,i,s);else{h.save();var o=h.globalCompositeOperation,l=new m;if(l.copyFrom(n.getBounds()),l.width=Math.round(l.width),l.height=Math.round(l.height),l.x=Math.round(l.x),l.y=Math.round(l.y),l.width>0&&l.height>0){var _=l.width,u=l.height,d=tt.getRT(_,u);h.breakNextMerge(),h.pushRT(),h.addRenderObject(Et.create([h,d,_,u],se.tmpTarget,this)),n.render(h,-l.x,-l.y),h.breakNextMerge(),h.popRT(),h.save();let e=.1;h.clipRect(i+l.x-t.getStyle().pivotX+e,s+l.y-t.getStyle().pivotY+e,_-2*e,u-2*e),a._fun.call(a,t,h,i,s),h.restore(),o=h.globalCompositeOperation,h.addRenderObject(Et.create(["mask"],se.setBlendMode,this));var c=Tt.create(st.TEXTURE2D,0),f=ht.INV_UV;h.drawTarget(d,i+l.x-t.getStyle().pivotX,s+l.y-t.getStyle().pivotY,_,u,p.TEMP.identity(),c,f,6),h.addRenderObject(Et.create([d],se.recycleTarget,this)),h.addRenderObject(Et.create([o],se.setBlendMode,this))}h.restore()}}_maskNative(t,e,i,r){var s=this._next,a=t.mask,n=e;if(a){n.save(),n.globalCompositeOperation;var h=new m;if(h.copyFrom(a.getBounds()),h.width=Math.round(h.width),h.height=Math.round(h.height),h.x=Math.round(h.x),h.y=Math.round(h.y),h.width>0&&h.height>0){var o=h.width,l=h.height,_=n.drawMask(o,l);a.render(n,-h.x,-h.y);let e=.1;n.drawMasked(i+h.x-t.getStyle().pivotX+e,r+h.y-t.getStyle().pivotY+e,o-2*e,l-2*e),s._fun.call(s,t,n,i,r),n.drawMaskComposite(_,i+h.x-t.getStyle().pivotX,r+h.y-t.getStyle().pivotY,o,l)}n.restore()}else s._fun.call(s,t,e,i,r)}static tmpTarget(t,e,i,r){e.start(),e.clear(0,0,0,0)}static recycleTarget(t){tt.releaseRT(t)}static setBlendMode(t){it.targetFns[it.TOINT[t]]()}}se.INIT=69905,se.renders=[],se.NORENDER=new se(0,null);class ae{constructor(){this._controlPoints=[new f,new f,new f],this._calFun=this.getPoint2}_switchPoint(t,e){var i=this._controlPoints.shift();i.setTo(t,e),this._controlPoints.push(i)}getPoint2(t,e){var i=this._controlPoints[0],r=this._controlPoints[1],s=this._controlPoints[2],a=Math.pow(1-t,2)*i.x+2*t*(1-t)*r.x+Math.pow(t,2)*s.x,n=Math.pow(1-t,2)*i.y+2*t*(1-t)*r.y+Math.pow(t,2)*s.y;e.push(a,n)}getPoint3(t,e){var i=this._controlPoints[0],r=this._controlPoints[1],s=this._controlPoints[2],a=this._controlPoints[3],n=Math.pow(1-t,3)*i.x+3*r.x*t*(1-t)*(1-t)+3*s.x*t*t*(1-t)+a.x*Math.pow(t,3),h=Math.pow(1-t,3)*i.y+3*r.y*t*(1-t)*(1-t)+3*s.y*t*t*(1-t)+a.y*Math.pow(t,3);e.push(n,h)}insertPoints(t,e){var i,r;for(r=1/(t=t>0?t:5),i=0;i<=1;i+=r)this._calFun(i,e)}getBezierPoints(t,e=5,i=2){var r,s;if((s=t.length)<2*(i+1))return[];var a=[];switch(i){case 2:this._calFun=this.getPoint2;break;case 3:this._calFun=this.getPoint3;break;default:return[]}for(;this._controlPoints.length<=i;)this._controlPoints.push(f.create());for(r=0;r<2*i;r+=2)this._switchPoint(t[r],t[r+1]);for(r=2*i;r<s;r+=2)this._switchPoint(t[r],t[r+1]),r/2%i==0&&this.insertPoints(e,a);return a}}ae.I=new ae,t.BlendEquationSeparate=void 0,(Ft=t.BlendEquationSeparate||(t.BlendEquationSeparate={}))[Ft.ADD=0]="ADD",Ft[Ft.SUBTRACT=1]="SUBTRACT",Ft[Ft.REVERSE_SUBTRACT=2]="REVERSE_SUBTRACT",Ft[Ft.MIN=3]="MIN",Ft[Ft.MAX=4]="MAX",t.CullMode=void 0,(Ot=t.CullMode||(t.CullMode={}))[Ot.Off=0]="Off",Ot[Ot.Front=1]="Front",Ot[Ot.Back=2]="Back";class ne{static create(t){if(t){var e=t instanceof St?t:St.create(t);return e._drawStyle||(e._drawStyle=new ne(t))}return ne.DEFAULT}constructor(t){this.setValue(t)}setValue(t){this._color=t?t instanceof St?t:St.create(t):St.create("#000000")}reset(){this._color=St.create("#000000")}toInt(){return this._color.numColor}equal(t){return"string"==typeof t?this._color.strColor===t:t instanceof St&&this._color.numColor===t.numColor}toColorStr(){return this._color.strColor}}ne.DEFAULT=new ne("#000000");class he{constructor(){this._lastOriX=0,this._lastOriY=0,this.paths=[],this._curPath=null}beginPath(t){this.paths.length=1,this._curPath=this.paths[0]=new oe,this._curPath.convex=t}closePath(){this._curPath.loop=!0}newPath(){this._curPath=new oe,this.paths.push(this._curPath)}addPoint(t,e){this._curPath.path.push(t,e)}push(t,e){this._curPath?this._curPath.path.length>0&&(this._curPath=new oe,this.paths.push(this._curPath)):(this._curPath=new oe,this.paths.push(this._curPath));var i=this._curPath;i.path=t.slice(),i.convex=e}reset(){this.paths.length=0}}class oe{constructor(){this.path=[],this.loop=!1,this.convex=!1}}class le{static _createArray(){var t=[];return t._length=0,t}static _init(){var t=le._namemap={};return t[le.TYPE_ALPHA]="ALPHA",t[le.TYPE_FILESTYLE]="fillStyle",t[le.TYPE_FONT]="font",t[le.TYPE_LINEWIDTH]="lineWidth",t[le.TYPE_STROKESTYLE]="strokeStyle",t[le.TYPE_ENABLEMERGE]="_mergeID",t[le.TYPE_MARK]=t[le.TYPE_TRANSFORM]=t[le.TYPE_TRANSLATE]=[],t[le.TYPE_TEXTBASELINE]="textBaseline",t[le.TYPE_TEXTALIGN]="textAlign",t[le.TYPE_GLOBALCOMPOSITEOPERATION]="_nBlendType",t[le.TYPE_SHADER]="shader",t[le.TYPE_FILTERS]="filters",t[le.TYPE_COLORFILTER]="_colorFiler",t}constructor(){}isSaveMark(){return!1}restore(t){this._dataObj[this._valueName]=this._value,le.POOL[le.POOL._length++]=this,this._newSubmit&&(t._curSubmit=Ut.RENDERBASE)}static save(t,e,i,r){if((t._saveMark._saveuse&e)!==e){t._saveMark._saveuse|=e;var s=le.POOL,a=s._length>0?s[--s._length]:new le;a._value=i[a._valueName=le._namemap[e]],a._dataObj=i,a._newSubmit=r;var n=t._save;n[n._length++]=a}}}le.TYPE_ALPHA=1,le.TYPE_FILESTYLE=2,le.TYPE_FONT=8,le.TYPE_LINEWIDTH=256,le.TYPE_STROKESTYLE=512,le.TYPE_MARK=1024,le.TYPE_TRANSFORM=2048,le.TYPE_TRANSLATE=4096,le.TYPE_ENABLEMERGE=8192,le.TYPE_TEXTBASELINE=16384,le.TYPE_TEXTALIGN=32768,le.TYPE_GLOBALCOMPOSITEOPERATION=65536,le.TYPE_CLIPRECT=131072,le.TYPE_CLIPRECT_STENCIL=262144,le.TYPE_IBVB=524288,le.TYPE_SHADER=1048576,le.TYPE_FILTERS=2097152,le.TYPE_FILTERS_TYPE=4194304,le.TYPE_COLORFILTER=8388608,le.POOL=le._createArray(),le._namemap=le._init();class _e{constructor(){this._globalClipMatrix=new p,this._clipInfoID=-1,this._clipRect=new m,this.incache=!1}isSaveMark(){return!1}restore(t){this._globalClipMatrix.copyTo(t._globalClipMatrix),this._clipRect.clone(t._clipRect),t._clipInfoID=this._clipInfoID,_e.POOL[_e.POOL._length++]=this,t._clipInCache=this.incache}static save(t){if((t._saveMark._saveuse&le.TYPE_CLIPRECT)!=le.TYPE_CLIPRECT){t._saveMark._saveuse|=le.TYPE_CLIPRECT;var e=_e.POOL,i=e._length>0?e[--e._length]:new _e;t._globalClipMatrix.copyTo(i._globalClipMatrix),t._clipRect.clone(i._clipRect),i._clipInfoID=t._clipInfoID,i.incache=t._clipInCache;var r=t._save;r[r._length++]=i}}}_e.POOL=le._createArray();class ue{constructor(){this._saveuse=0}isSaveMark(){return!0}restore(t){t._saveMark=this._preSaveMark,ue.POOL[ue.POOL._length++]=this}static Create(t){var e=ue.POOL,i=e._length>0?e[--e._length]:new ue;return i._saveuse=0,i._preSaveMark=t._saveMark,t._saveMark=i,i}}ue.POOL=le._createArray();class de{constructor(){this._matrix=new p}isSaveMark(){return!1}restore(t){t._curMat=this._savematrix,de.POOL[de.POOL._length++]=this}static save(t){var e=t._saveMark;if((e._saveuse&le.TYPE_TRANSFORM)!==le.TYPE_TRANSFORM){e._saveuse|=le.TYPE_TRANSFORM;var i=de.POOL,r=i._length>0?i[--i._length]:new de;r._savematrix=t._curMat,t._curMat=t._curMat.copyTo(r._matrix);var s=t._save;s[s._length++]=r}}}de.POOL=le._createArray();class ce{constructor(){this._mat=new p}isSaveMark(){return!1}restore(t){this._mat.copyTo(t._curMat),ce.POOL[ce.POOL._length++]=this}static save(t){var e=ce.POOL,i=e._length>0?e[--e._length]:new ce;t._curMat.copyTo(i._mat);var r=t._save;r[r._length++]=i}}ce.POOL=le._createArray();var pe,fe,me,ge="/*\n\ttexture和fillrect使用的。\n*/\nattribute vec4 posuv;\nattribute vec4 attribColor;\nattribute vec4 attribFlags;\n//attribute vec4 clipDir;\n//attribute vec2 clipRect;\nuniform vec4 clipMatDir;\nuniform vec2 clipMatPos;\t\t// 这个是全局的，不用再应用矩阵了。\nvarying vec2 cliped;\nuniform vec2 size;\nuniform vec2 clipOff;\t\t\t// 使用要把clip偏移。cacheas normal用. 只用了[0]\n#ifdef WORLDMAT\n\tuniform mat4 mmat;\n#endif\n#ifdef MVP3D\n\tuniform mat4 u_MvpMatrix;\n#endif\nvarying vec4 v_texcoordAlpha;\nvarying vec4 v_color;\nvarying float v_useTex;\n\nvoid main() {\n\n\tvec4 pos = vec4(posuv.xy,0.,1.);\n#ifdef WORLDMAT\n\tpos=mmat*pos;\n#endif\n\tvec4 pos1  =vec4((pos.x/size.x-0.5)*2.0,(0.5-pos.y/size.y)*2.0,0.,1.0);\n#ifdef MVP3D\n\tgl_Position=u_MvpMatrix*pos1;\n#else\n\tgl_Position=pos1;\n#endif\n\tv_texcoordAlpha.xy = posuv.zw;\n\t//v_texcoordAlpha.z = attribColor.a/255.0;\n\tv_color = attribColor/255.0;\n\tv_color.xyz*=v_color.w;//反正后面也要预乘\n\t\n\tv_useTex = attribFlags.r/255.0;\n\tfloat clipw = length(clipMatDir.xy);\n\tfloat cliph = length(clipMatDir.zw);\n\t\n\tvec2 clpos = clipMatPos.xy;\n\t#ifdef WORLDMAT\n\t\t// 如果有mmat，需要修改clipMatPos,因为 这是cacheas normal （如果不是就错了）， clipMatPos被去掉了偏移\n\t\tif(clipOff[0]>0.0){\n\t\t\tclpos.x+=mmat[3].x;\t//tx\t最简单处理\n\t\t\tclpos.y+=mmat[3].y;\t//ty\n\t\t}\n\t#endif\n\tvec2 clippos = pos.xy - clpos;\t//pos已经应用矩阵了，为了减的有意义，clip的位置也要缩放\n\tif(clipw>20000. && cliph>20000.)\n\t\tcliped = vec2(0.5,0.5);\n\telse {\n\t\t//转成0到1之间。/clipw/clipw 表示clippos与normalize之后的clip朝向点积之后，再除以clipw\n\t\tcliped=vec2( dot(clippos,clipMatDir.xy)/clipw/clipw, dot(clippos,clipMatDir.zw)/cliph/cliph);\n\t}\n\n\t#ifdef INVERTY\n\t\tgl_Position.y = -gl_Position.y;\n\t#endif\n\n}",Te="/*\n\ttexture和fillrect使用的。\n*/\n#if defined(GL_FRAGMENT_PRECISION_HIGH) // 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nvec3 linearToGamma(in vec3 value)\n{\n    return vec3(mix(pow(value.rgb, vec3(0.41666)) * 1.055 - vec3(0.055), value.rgb * 12.92, vec3(lessThanEqual(value.rgb, vec3(0.0031308)))));\n\n    // return pow(value, vec3(1.0 / 2.2));\n    // return pow(value, vec3(0.455));\n}\n\nvec4 linearToGamma(in vec4 value)\n{\n    return vec4(linearToGamma(value.rgb), value.a);\n}\n\n\nvarying vec4 v_texcoordAlpha;\nvarying vec4 v_color;\nvarying float v_useTex;\nuniform sampler2D texture;\nvarying vec2 cliped;\n\nvec4 sampleTexture(sampler2D texture, vec2 uv)\n{\n    vec4 color = texture2D(texture, uv);\n#ifdef GAMMASPACE\n    color.xyz = linearToGamma(color.xyz);\n#endif\n    return color;\n}\n\n#ifdef BLUR_FILTER\nuniform vec4 strength_sig2_2sig2_gauss1; // TODO模糊的过程中会导致变暗变亮\nuniform vec2 blurInfo;\n\n    #define PI 3.141593\n\nfloat getGaussian(float x, float y)\n{\n    return strength_sig2_2sig2_gauss1.w * exp(-(x * x + y * y) / strength_sig2_2sig2_gauss1.z);\n}\n\nvec4 blur()\n{\n    const float blurw = 9.0;\n    vec4 vec4Color = vec4(0.0, 0.0, 0.0, 0.0);\n    vec2 halfsz = vec2(blurw, blurw) / 2.0 / blurInfo;\n    vec2 startpos = v_texcoordAlpha.xy - halfsz;\n    vec2 ctexcoord = startpos;\n    vec2 step = 1.0 / blurInfo; //每个像素\n\n    for (float y = 0.0; y <= blurw; ++y)\n\t{\n\t    ctexcoord.x = startpos.x;\n\t    for (float x = 0.0; x <= blurw; ++x)\n\t\t{\n\t\t    // TODO 纹理坐标的固定偏移应该在vs中处理\n\t\t    vec4Color += sampleTexture(texture, ctexcoord) * getGaussian(x - blurw / 2.0, y - blurw / 2.0);\n\t\t    ctexcoord.x += step.x;\n\t\t}\n\t    ctexcoord.y += step.y;\n\t}\n    // vec4Color.w=1.0;  这个会导致丢失alpha。以后有时间再找模糊会导致透明的问题\n    return vec4Color;\n}\n#endif\n\n#ifdef COLOR_FILTER\nuniform vec4 colorAlpha;\nuniform mat4 colorMat;\n#endif\n\n#ifdef GLOW_FILTER\nuniform vec4 u_color;\nuniform vec4 u_blurInfo1;\nuniform vec4 u_blurInfo2;\n#endif\n\n#ifdef COLOR_ADD\nuniform vec4 colorAdd;\n#endif\n\n#ifdef FILLTEXTURE\nuniform vec4 u_TexRange; // startu,startv,urange, vrange\n#endif\n\nvoid main()\n{\n    if (cliped.x < 0.)\n\tdiscard;\n    if (cliped.x > 1.)\n\tdiscard;\n    if (cliped.y < 0.)\n\tdiscard;\n    if (cliped.y > 1.)\n\tdiscard;\n\n#ifdef FILLTEXTURE\n    vec4 color = sampleTexture(texture, fract(v_texcoordAlpha.xy) * u_TexRange.zw + u_TexRange.xy);\n#else\n    vec4 color = sampleTexture(texture, v_texcoordAlpha.xy);\n#endif\n\n    if (v_useTex <= 0.)\n\tcolor = vec4(1., 1., 1., 1.);\n    color.a *= v_color.w;\n    // color.rgb*=v_color.w;\n    color.rgb *= v_color.rgb;\n    gl_FragColor = color;\n\n#ifdef COLOR_ADD\n    gl_FragColor = vec4(colorAdd.rgb, colorAdd.a * gl_FragColor.a);\n    gl_FragColor.xyz *= colorAdd.a;\n#endif\n\n#ifdef BLUR_FILTER\n    gl_FragColor = blur();\n    gl_FragColor.w *= v_color.w;\n#endif\n\n#ifdef COLOR_FILTER\n    mat4 alphaMat = colorMat;\n\n    alphaMat[0][3] *= gl_FragColor.a;\n    alphaMat[1][3] *= gl_FragColor.a;\n    alphaMat[2][3] *= gl_FragColor.a;\n\n    gl_FragColor = gl_FragColor * alphaMat;\n    gl_FragColor += colorAlpha / 255.0 * gl_FragColor.a;\n#endif\n\n#ifdef GLOW_FILTER\n    const float c_IterationTime = 10.0;\n    float floatIterationTotalTime = c_IterationTime * c_IterationTime;\n    vec4 vec4Color = vec4(0.0, 0.0, 0.0, 0.0);\n    vec2 vec2FilterDir = vec2(-(u_blurInfo1.z) / u_blurInfo2.x, -(u_blurInfo1.w) / u_blurInfo2.y);\n    vec2 vec2FilterOff = vec2(u_blurInfo1.x / u_blurInfo2.x / c_IterationTime * 2.0, u_blurInfo1.y / u_blurInfo2.y / c_IterationTime * 2.0);\n    float maxNum = u_blurInfo1.x * u_blurInfo1.y;\n    vec2 vec2Off = vec2(0.0, 0.0);\n    float floatOff = c_IterationTime / 2.0;\n    for (float i = 0.0; i <= c_IterationTime; ++i)\n\t{\n\t    for (float j = 0.0; j <= c_IterationTime; ++j)\n\t\t{\n\t\t    vec2Off = vec2(vec2FilterOff.x * (i - floatOff), vec2FilterOff.y * (j - floatOff));\n\t\t    vec4Color += sampleTexture(texture, v_texcoordAlpha.xy + vec2FilterDir + vec2Off) / floatIterationTotalTime;\n\t\t}\n\t}\n    gl_FragColor = vec4(u_color.rgb, vec4Color.a * u_blurInfo2.z);\n    gl_FragColor.rgb *= gl_FragColor.a;\n#endif\n}",xe="attribute vec4 position;\nattribute vec4 attribColor;\n//attribute vec4 clipDir;\n//attribute vec2 clipRect;\nuniform vec4 clipMatDir;\nuniform vec2 clipMatPos;\n#ifdef WORLDMAT\n\tuniform mat4 mmat;\n#endif\nuniform mat4 u_mmat2;\n//uniform vec2 u_pos;\nuniform vec2 size;\nvarying vec4 color;\n//vec4 dirxy=vec4(0.9,0.1, -0.1,0.9);\n//vec4 clip=vec4(100.,30.,300.,600.);\nvarying vec2 cliped;\nvoid main(){\n\t\n#ifdef WORLDMAT\n\tvec4 pos=mmat*vec4(position.xy,0.,1.);\n\tgl_Position =vec4((pos.x/size.x-0.5)*2.0,(0.5-pos.y/size.y)*2.0,pos.z,1.0);\n#else\n\tgl_Position =vec4((position.x/size.x-0.5)*2.0,(0.5-position.y/size.y)*2.0,position.z,1.0);\n#endif\t\n\tfloat clipw = length(clipMatDir.xy);\n\tfloat cliph = length(clipMatDir.zw);\n\tvec2 clippos = position.xy - clipMatPos.xy;\t//pos已经应用矩阵了，为了减的有意义，clip的位置也要缩放\n\tif(clipw>20000. && cliph>20000.)\n\t\tcliped = vec2(0.5,0.5);\n\telse {\n\t\t//clipdir是带缩放的方向，由于上面clippos是在缩放后的空间计算的，所以需要把方向先normalize一下\n\t\tcliped=vec2( dot(clippos,clipMatDir.xy)/clipw/clipw, dot(clippos,clipMatDir.zw)/cliph/cliph);\n\t}\n  //pos2d.x = dot(clippos,dirx);\n  color=attribColor/255.;\n}",Ee="precision mediump float;\n//precision mediump float;\nvarying vec4 color;\n//uniform float alpha;\nvarying vec2 cliped;\nvoid main(){\n\t//vec4 a=vec4(color.r, color.g, color.b, 1);\n\t//a.a*=alpha;\n    gl_FragColor= color;// vec4(color.r, color.g, color.b, alpha);\n\tgl_FragColor.rgb*=color.a;\n\tif(cliped.x<0.) discard;\n\tif(cliped.x>1.) discard;\n\tif(cliped.y<0.) discard;\n\tif(cliped.y>1.) discard;\n}",ye="attribute vec2 position;\nattribute vec2 texcoord;\nattribute vec4 color;\nuniform vec2 size;\nuniform float offsetX;\nuniform float offsetY;\nuniform mat4 mmat;\nuniform mat4 u_mmat2;\nvarying vec2 v_texcoord;\nvarying vec4 v_color;\nvoid main() {\n  vec4 pos=mmat*u_mmat2*vec4(offsetX+position.x,offsetY+position.y,0,1 );\n  gl_Position = vec4((pos.x/size.x-0.5)*2.0,(0.5-pos.y/size.y)*2.0,pos.z,1.0);\n  v_color = color;\n  v_color.rgb *= v_color.a;\n  v_texcoord = texcoord;  \n}",ve="precision mediump float;\nvarying vec2 v_texcoord;\nvarying vec4 v_color;\nuniform sampler2D texture;\nuniform float alpha;\n\nvec4 sampleTexture(sampler2D texture,vec2 uv){\n   vec4 color = texture2D(texture,uv);\n   #ifdef GAMMASPACE\n      color.xyz = color.xyz*color.xyz;\n   #endif\n   return color;\n}\n\nvoid main() {\n\tvec4 t_color = sampleTexture(texture, v_texcoord);\n\tgl_FragColor = t_color.rgba * v_color;\n\tgl_FragColor *= alpha;\n}";class Se{constructor(){this.ALPHA=1,this.defines=new st,this.shaderType=0,this.fillStyle=ne.DEFAULT,this.strokeStyle=ne.DEFAULT}destroy(){this.defines=null,this.filters=null}static __init__(){window.conch&&!window.conchConfig.conchWebGL?(window.preCompile2D(st.TEXTURE2D,ge,Te),window.preCompile2D(st.PRIMITIVE,xe,Ee),window.preCompile2D(st.SKINMESH,ye,ve)):(mt.preCompile2D(0,st.TEXTURE2D,ge,Te,null),mt.preCompile2D(0,st.PRIMITIVE,xe,Ee,null),mt.preCompile2D(0,st.SKINMESH,ye,ve,null))}}class Re{constructor(){this.ib=jt.create(t.BufferUsage.Dynamic),this.vb=qt.create(8)}static getInstance(){return Re.instance=Re.instance||new Re}addSkinMesh(t){t.getData2(this.vb,this.ib,this.vb._byteLength/32)}reset(){this.vb.buffer2D.clear(),this.ib.buffer2D.clear()}}class be{static createLine2(t,e,i,r,s,a){if(t.length<4)return null;var n=be.tempData.length>t.length+2?be.tempData:new Array(t.length+2);n[0]=t[0],n[1]=t[1];var h=2,o=0,l=t.length;for(o=2;o<l;o+=2)Math.abs(t[o]-t[o-2])+Math.abs(t[o+1]-t[o-1])>.01&&(n[h++]=t[o],n[h++]=t[o+1]);a&&Math.abs(t[0]-n[h-2])+Math.abs(t[1]-n[h-1])>.01&&(n[h++]=t[0],n[h++]=t[1]);var _=s;l=h/2;var u,d,c,p,f,m,g,T,x,E,y,v,S,R,b,C,A,w,M,D,I=i/2;for(c=n[0],p=n[1],E=c-(f=n[2]),x=(x=-(p-(m=n[3])))/(D=Math.sqrt(x*x+E*E))*I,E=E/D*I,_.push(c-x,p-E,c+x,p+E),o=1;o<l-1;o++)c=n[2*(o-1)],p=n[2*(o-1)+1],f=n[2*o],m=n[2*o+1],g=n[2*(o+1)],T=n[2*(o+1)+1],E=c-f,v=f-g,b=(-(x=(x=-(p-m))/(D=Math.sqrt(x*x+E*E))*I)+c)*(-(E=E/D*I)+m)-(-x+f)*(-E+p),w=(-(y=(y=-(m-T))/(D=Math.sqrt(y*y+v*v))*I)+g)*(-(v=v/D*I)+m)-(-y+f)*(-v+T),M=(S=-E+p-(-E+m))*(A=-y+f-(-y+g))-(C=-v+T-(-v+m))*(R=-x+f-(-x+c)),Math.abs(M)<.1?(M+=10.1,_.push(f-x,m-E,f+x,m+E)):(u=(R*w-A*b)/M,d=(C*b-S*w)/M,_.push(u,d,f-(u-f),m-(d-m)));for(c=n[h-4],p=n[h-3],E=c-(f=n[h-2]),x=(x=-(p-(m=n[h-1])))/(D=Math.sqrt(x*x+E*E))*I,E=E/D*I,_.push(f-x,m-E,f+x,m+E),o=1;o<l;o++)e.push(r+2*(o-1),r+2*(o-1)+1,r+2*o+1,r+2*o+1,r+2*o,r+2*(o-1));return _}static createLineTriangle(t,e,i,r,s,a,n){var h=t.slice(),o=h.length,l=h[0],_=h[1],u=h[2],d=(h[2],0),c=0,p=0,f=0,m=o/2;if(!(m<=1)&&2!=m){for(var g=new Array(4*m),T=0,x=0,E=0;E<m-1;E++)l=h[x++],_=h[x++],u=h[x++],f=h[x++]-_,0!=(p=u-l)&&0!=f&&(d=Math.sqrt(p*p+f*f))>.001&&(g[c=4*T]=l,g[c+1]=_,g[c+2]=p/d,g[c+3]=f/d,T++);for(r?(l=h[o-2],_=h[o-1],u=h[0],f=h[1]-_,0!=(p=u-l)&&0!=f&&(d=Math.sqrt(p*p+f*f))>.001&&(g[c=4*T]=l,g[c+1]=_,g[c+2]=p/d,g[c+3]=f/d,T++)):(g[c=4*T]=l,g[c+1]=_,g[c+2]=p/d,g[c+3]=f/d,T++),x=0,E=0;E<m;E++)l=h[x],_=h[x+1],u=h[x+2],h[x+3]}}}be.tempData=new Array(256);class Ce{constructor(t,e,i){this.i=t,this.x=e,this.y=i,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}}class Ae{static earcut(t,e,i){i=i||2;var r,s,a,n,h,o,l,_=e&&e.length,u=_?e[0]*i:t.length,d=Ae.linkedList(t,0,u,i,!0),c=[];if(!d)return c;if(_&&(d=Ae.eliminateHoles(t,e,d,i)),t.length>80*i){r=a=t[0],s=n=t[1];for(var p=i;p<u;p+=i)(h=t[p])<r&&(r=h),(o=t[p+1])<s&&(s=o),h>a&&(a=h),o>n&&(n=o);l=0!==(l=Math.max(a-r,n-s))?1/l:0}return Ae.earcutLinked(d,c,i,r,s,l),c}static linkedList(t,e,i,r,s){var a,n;if(s===Ae.signedArea(t,e,i,r)>0)for(a=e;a<i;a+=r)n=Ae.insertNode(a,t[a],t[a+1],n);else for(a=i-r;a>=e;a-=r)n=Ae.insertNode(a,t[a],t[a+1],n);return n&&Ae.equals(n,n.next)&&(Ae.removeNode(n),n=n.next),n}static filterPoints(t,e){if(!t)return t;e||(e=t);var i,r=t;do{if(i=!1,r.steiner||!Ae.equals(r,r.next)&&0!==Ae.area(r.prev,r,r.next))r=r.next;else{if(Ae.removeNode(r),(r=e=r.prev)===r.next)break;i=!0}}while(i||r!==e);return e}static earcutLinked(t,e,i,r,s,a,n=null){if(t){!n&&a&&Ae.indexCurve(t,r,s,a);for(var h,o,l=t;t.prev!==t.next;)if(h=t.prev,o=t.next,a?Ae.isEarHashed(t,r,s,a):Ae.isEar(t))e.push(h.i/i),e.push(t.i/i),e.push(o.i/i),Ae.removeNode(t),t=o.next,l=o.next;else if((t=o)===l){n?1===n?(t=Ae.cureLocalIntersections(t,e,i),Ae.earcutLinked(t,e,i,r,s,a,2)):2===n&&Ae.splitEarcut(t,e,i,r,s,a):Ae.earcutLinked(Ae.filterPoints(t,null),e,i,r,s,a,1);break}}}static isEar(t){var e=t.prev,i=t,r=t.next;if(Ae.area(e,i,r)>=0)return!1;for(var s=t.next.next;s!==t.prev;){if(Ae.pointInTriangle(e.x,e.y,i.x,i.y,r.x,r.y,s.x,s.y)&&Ae.area(s.prev,s,s.next)>=0)return!1;s=s.next}return!0}static isEarHashed(t,e,i,r){var s=t.prev,a=t,n=t.next;if(Ae.area(s,a,n)>=0)return!1;for(var h=s.x<a.x?s.x<n.x?s.x:n.x:a.x<n.x?a.x:n.x,o=s.y<a.y?s.y<n.y?s.y:n.y:a.y<n.y?a.y:n.y,l=s.x>a.x?s.x>n.x?s.x:n.x:a.x>n.x?a.x:n.x,_=s.y>a.y?s.y>n.y?s.y:n.y:a.y>n.y?a.y:n.y,u=Ae.zOrder(h,o,e,i,r),d=Ae.zOrder(l,_,e,i,r),c=t.nextZ;c&&c.z<=d;){if(c!==t.prev&&c!==t.next&&Ae.pointInTriangle(s.x,s.y,a.x,a.y,n.x,n.y,c.x,c.y)&&Ae.area(c.prev,c,c.next)>=0)return!1;c=c.nextZ}for(c=t.prevZ;c&&c.z>=u;){if(c!==t.prev&&c!==t.next&&Ae.pointInTriangle(s.x,s.y,a.x,a.y,n.x,n.y,c.x,c.y)&&Ae.area(c.prev,c,c.next)>=0)return!1;c=c.prevZ}return!0}static cureLocalIntersections(t,e,i){var r=t;do{var s=r.prev,a=r.next.next;!Ae.equals(s,a)&&Ae.intersects(s,r,r.next,a)&&Ae.locallyInside(s,a)&&Ae.locallyInside(a,s)&&(e.push(s.i/i),e.push(r.i/i),e.push(a.i/i),Ae.removeNode(r),Ae.removeNode(r.next),r=t=a),r=r.next}while(r!==t);return r}static splitEarcut(t,e,i,r,s,a){var n=t;do{for(var h=n.next.next;h!==n.prev;){if(n.i!==h.i&&Ae.isValidDiagonal(n,h)){var o=Ae.splitPolygon(n,h);return n=Ae.filterPoints(n,n.next),o=Ae.filterPoints(o,o.next),Ae.earcutLinked(n,e,i,r,s,a),void Ae.earcutLinked(o,e,i,r,s,a)}h=h.next}n=n.next}while(n!==t)}static eliminateHoles(t,e,i,r){var s,a,n,h,o,l=[];for(s=0,a=e.length;s<a;s++)n=e[s]*r,h=s<a-1?e[s+1]*r:t.length,(o=Ae.linkedList(t,n,h,r,!1))===o.next&&(o.steiner=!0),l.push(Ae.getLeftmost(o));for(l.sort(Ae.compareX),s=0;s<l.length;s++)Ae.eliminateHole(l[s],i),i=Ae.filterPoints(i,i.next);return i}static compareX(t,e){return t.x-e.x}static eliminateHole(t,e){if(e=Ae.findHoleBridge(t,e)){var i=Ae.splitPolygon(e,t);Ae.filterPoints(i,i.next)}}static findHoleBridge(t,e){var i,r=e,s=t.x,a=t.y,n=-1/0;do{if(a<=r.y&&a>=r.next.y&&r.next.y!==r.y){var h=r.x+(a-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(h<=s&&h>n){if(n=h,h===s){if(a===r.y)return r;if(a===r.next.y)return r.next}i=r.x<r.next.x?r:r.next}}r=r.next}while(r!==e);if(!i)return null;if(s===n)return i.prev;var o,l=i,_=i.x,u=i.y,d=1/0;for(r=i.next;r!==l;)s>=r.x&&r.x>=_&&s!==r.x&&Ae.pointInTriangle(a<u?s:n,a,_,u,a<u?n:s,a,r.x,r.y)&&((o=Math.abs(a-r.y)/(s-r.x))<d||o===d&&r.x>i.x)&&Ae.locallyInside(r,t)&&(i=r,d=o),r=r.next;return i}static indexCurve(t,e,i,r){var s=t;do{null===s.z&&(s.z=Ae.zOrder(s.x,s.y,e,i,r)),s.prevZ=s.prev,s.nextZ=s.next,s=s.next}while(s!==t);s.prevZ.nextZ=null,s.prevZ=null,Ae.sortLinked(s)}static sortLinked(t){var e,i,r,s,a,n,h,o,l=1;do{for(i=t,t=null,a=null,n=0;i;){for(n++,r=i,h=0,e=0;e<l&&(h++,r=r.nextZ);e++);for(o=l;h>0||o>0&&r;)0!==h&&(0===o||!r||i.z<=r.z)?(s=i,i=i.nextZ,h--):(s=r,r=r.nextZ,o--),a?a.nextZ=s:t=s,s.prevZ=a,a=s;i=r}a.nextZ=null,l*=2}while(n>1);return t}static zOrder(t,e,i,r,s){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)*s)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-r)*s)|e<<8))|e<<4))|e<<2))|e<<1))<<1}static getLeftmost(t){var e=t,i=t;do{e.x<i.x&&(i=e),e=e.next}while(e!==t);return i}static pointInTriangle(t,e,i,r,s,a,n,h){return(s-n)*(e-h)-(t-n)*(a-h)>=0&&(t-n)*(r-h)-(i-n)*(e-h)>=0&&(i-n)*(a-h)-(s-n)*(r-h)>=0}static isValidDiagonal(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!Ae.intersectsPolygon(t,e)&&Ae.locallyInside(t,e)&&Ae.locallyInside(e,t)&&Ae.middleInside(t,e)}static area(t,e,i){return(e.y-t.y)*(i.x-e.x)-(e.x-t.x)*(i.y-e.y)}static equals(t,e){return t.x===e.x&&t.y===e.y}static intersects(t,e,i,r){return!!(Ae.equals(t,e)&&Ae.equals(i,r)||Ae.equals(t,r)&&Ae.equals(i,e))||Ae.area(t,e,i)>0!=Ae.area(t,e,r)>0&&Ae.area(i,r,t)>0!=Ae.area(i,r,e)>0}static intersectsPolygon(t,e){var i=t;do{if(i.i!==t.i&&i.next.i!==t.i&&i.i!==e.i&&i.next.i!==e.i&&Ae.intersects(i,i.next,t,e))return!0;i=i.next}while(i!==t);return!1}static locallyInside(t,e){return Ae.area(t.prev,t,t.next)<0?Ae.area(t,e,t.next)>=0&&Ae.area(t,t.prev,e)>=0:Ae.area(t,e,t.prev)<0||Ae.area(t,t.next,e)<0}static middleInside(t,e){var i=t,r=!1,s=(t.x+e.x)/2,a=(t.y+e.y)/2;do{i.y>a!=i.next.y>a&&i.next.y!==i.y&&s<(i.next.x-i.x)*(a-i.y)/(i.next.y-i.y)+i.x&&(r=!r),i=i.next}while(i!==t);return r}static splitPolygon(t,e){var i=new Ce(t.i,t.x,t.y),r=new Ce(e.i,e.x,e.y),s=t.next,a=e.prev;return t.next=e,e.prev=t,i.next=s,s.prev=i,r.next=i,i.prev=r,a.next=r,r.prev=a,r}static insertNode(t,e,i,r){var s=new Ce(t,e,i);return r?(s.next=r.next,s.prev=r,r.next.prev=s,r.next=s):(s.prev=s,s.next=s),s}static removeNode(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}static signedArea(t,e,i,r){for(var s=0,a=e,n=i-r;a<i;a+=r)s+=(t[n]-t[a])*(t[a+1]+t[n+1]),n=a;return s}}t.MeshTopology=void 0,(pe=t.MeshTopology||(t.MeshTopology={}))[pe.Points=0]="Points",pe[pe.Lines=1]="Lines",pe[pe.LineLoop=2]="LineLoop",pe[pe.LineStrip=3]="LineStrip",pe[pe.Triangles=4]="Triangles",pe[pe.TriangleStrip=5]="TriangleStrip",pe[pe.TriangleFan=6]="TriangleFan";class we extends Ut{constructor(t=Ut.TYPE_2D){super(t)}renderSubmit(){if(0===this._numEle||!this._mesh||0==this._numEle)return 1;var e=this.shaderValue.textureHost;if(e){var i=e._getSource();if(!i)return 1;this.shaderValue.texture=i}return this._mesh.useMesh(),this.shaderValue.upload(),it.activeBlendFunction!==this._blendFn&&(et.setBlend(!0),this._blendFn(),it.activeBlendFunction=this._blendFn),g.renderDrawContext.drawElements(t.MeshTopology.Triangles,this._numEle,t.IndexFormat.UInt16,this._startIdx),1}releaseRender(){Ut.RENDERBASE!=this&&--this._ref<1&&(we.POOL[we._poolSize++]=this,this.shaderValue.release(),this.shaderValue=null,this._mesh=null,this._parent&&(this._parent.releaseRender(),this._parent=null))}static create(t,e,r){var s=we._poolSize?we.POOL[--we._poolSize]:new we;s._ref=1,s._mesh=e,s._key.clear(),s._startIdx=e.indexNum*i.BYTES_PIDX,s._numEle=0;var a=t._nBlendType;s._blendFn=t._targets?it.targetFns[a]:it.fns[a],s.shaderValue=r,s.shaderValue.setValue(t._shader2D);var n=t._shader2D.filters;return n&&s.shaderValue.setFilters(n),s}static createShape(t,e,i,r){var s=we._poolSize?we.POOL[--we._poolSize]:new we;s._mesh=e,s._numEle=i,s._startIdx=2*e.indexNum,s._ref=1,s.shaderValue=r,s.shaderValue.setValue(t._shader2D);var a=t._nBlendType;return s._key.blendShader=a,s._blendFn=t._targets?it.targetFns[a]:it.fns[a],s}}we._poolSize=0,we.POOL=[];class Me extends Ut{static create(t,e,i){var r=Me.POOL._length?Me.POOL[--Me.POOL._length]:new Me;r.canv=t,r._ref=1,r._numEle=0;var s=r.shaderValue;return s.alpha=e,s.defines.setValue(0),i&&i.length&&s.setFilters(i),r}constructor(){super(Ut.TYPE_2D),this._matrix=new p,this._matrix4=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],this.shaderValue=new Tt(0,0)}renderSubmit(){var t=Y.worldAlpha,e=Y.worldMatrix4,i=Y.worldMatrix,r=Y.worldFilters,s=Y.worldShaderDefines,a=this.shaderValue,n=this._matrix,h=this._matrix4,o=p.TEMP;return p.mul(n,i,o),h[0]=o.a,h[1]=o.b,h[4]=o.c,h[5]=o.d,h[12]=o.tx,h[13]=o.ty,Y.worldMatrix=o.clone(),Y.worldMatrix4=h,Y.worldAlpha=Y.worldAlpha*a.alpha,a.filters&&a.filters.length&&(Y.worldFilters=a.filters,Y.worldShaderDefines=a.defines),this.canv.flushsubmit(),Y.worldAlpha=t,Y.worldMatrix4=e,Y.worldMatrix.destroy(),Y.worldMatrix=i,Y.worldFilters=r,Y.worldShaderDefines=s,1}releaseRender(){if(--this._ref<1){var t=Me.POOL;this._mesh=null,t[t._length++]=this}}getRenderType(){return Ut.TYPE_CANVAS}}Me.POOL=[],Me.POOL._length=0;class De{constructor(){this.blendType=0,this._ref=1,this._key=new xt}renderSubmit(){this._mesh.useMesh();var e=this.srcRT;return e&&(this.shaderValue.texture=e._getSource(),this.shaderValue.upload(),this.blend(),g.renderDrawContext.drawElements(t.MeshTopology.Triangles,this._numEle,t.IndexFormat.UInt16,this._startIdx)),1}blend(){it.activeBlendFunction!==it.fns[this.blendType]&&(et.setBlend(!0),it.fns[this.blendType](),it.activeBlendFunction=it.fns[this.blendType])}getRenderType(){return 0}releaseRender(){if(--this._ref<1){var t=De.POOL;t[t._length++]=this}}static create(t,e,r,s){var a=De.POOL._length?De.POOL[--De.POOL._length]:new De;if(a._mesh=e,a.srcRT=s,a._startIdx=e.indexNum*i.BYTES_PIDX,a._ref=1,a._key.clear(),a._numEle=0,a.blendType=t._nBlendType,a._key.blendShader=a.blendType,a.shaderValue=r,a.shaderValue.setValue(t._shader2D),t._colorFiler){var n=t._colorFiler;r.defines.add(n.type),r.colorMat=n._mat,r.colorAlpha=n._alpha}return a}}De.POOL=[],De.POOL._length=0;class Ie extends Ut{constructor(t=Ut.TYPE_2D){super(t)}releaseRender(){--this._ref<1&&(Ie.POOL[Ie._poolSize++]=this,this.shaderValue.release(),this._mesh=null,this._parent&&(this._parent.releaseRender(),this._parent=null))}renderSubmit(){if(0===this._numEle)return 1;var e=this.shaderValue.textureHost;if(e){var i=e?e._getSource():null;if(!i)return 1}this._mesh.useMesh();var r=Ut.preRender,s=Ut.preRender._key;return 0===this._key.blendShader&&this._key.submitType===s.submitType&&this._key.blendShader===s.blendShader&&H.activeShader&&Ut.preRender.clipInfoID==this.clipInfoID&&r.shaderValue.defines._value===this.shaderValue.defines._value&&0==(this.shaderValue.defines._value&st.NOOPTMASK)?H.activeShader.uploadTexture2D(i):(it.activeBlendFunction!==this._blendFn&&(et.setBlend(!0),this._blendFn(),it.activeBlendFunction=this._blendFn),this.shaderValue.texture=i,this.shaderValue.upload()),g.renderDrawContext.drawElements(t.MeshTopology.Triangles,this._numEle,t.IndexFormat.UInt16,this._startIdx),1}static create(t,e,r){var s=Ie._poolSize?Ie.POOL[--Ie._poolSize]:new Ie(Ut.TYPE_TEXTURE);s._mesh=e,s._key.clear(),s._key.submitType=Ut.KEY_DRAWTEXTURE,s._ref=1,s._startIdx=e.indexNum*i.BYTES_PIDX,s._numEle=0;var a=t._nBlendType;if(s._key.blendShader=a,s._blendFn=t._targets?it.targetFns[a]:it.fns[a],s.shaderValue=r,t._colorFiler){var n=t._colorFiler;r.defines.add(n.type),r.colorMat=n._mat,r.colorAlpha=n._alpha}return s}}Ie._poolSize=0,Ie.POOL=[];class Pe{constructor(){this._data=[],this._ndata=0,this._clipid=-1,this._clipMatrix=new p,this._enable=!1}clear(){this._tex=null,this._imgId=-1,this._ndata=0,this._enable=!1,this._colorFiler=null}destroy(){this.clear(),this._data.length=0,this._data=null}add(t,e,i,r,s,a){this._ndata>0&&(this._tex!=e||this._imgId!=i||this._clipid>=0&&this._clipid!=t._clipInfoID)&&this.submit(t),this._clipid=t._clipInfoID,t._globalClipMatrix.copyTo(this._clipMatrix),this._tex=e,this._imgId=i,this._colorFiler=t._colorFiler,this._data[this._ndata]=r,this._data[this._ndata+1]=s,this._data[this._ndata+2]=a,this._ndata+=3}getPos(){return 0==Pe.__nPosPool?new Array(8):Pe.__posPool[--Pe.__nPosPool]}enable(t,e){t!==this._enable&&(this._enable=t,this._enable||this.submit(e))}submit(t){var e=this._ndata;if(e){var i=t._mesh,r=t._colorFiler;t._colorFiler=this._colorFiler;var s=Ie.create(t,i,Tt.create(st.TEXTURE2D,0));t._submits[t._submits._length++]=t._curSubmit=s,s.shaderValue.textureHost=this._tex,s._key.other=this._imgId,t._colorFiler=r,t._copyClipInfo(s,this._clipMatrix),s.clipInfoID=this._clipid;for(var a=0;a<e;a+=3)i.addQuad(this._data[a],this._data[a+1],this._data[a+2],!0),Pe.__posPool[Pe.__nPosPool++]=this._data[a];e/=3,s._numEle+=6*e,i.indexNum+=6*e,i.vertNum+=4*e,t._drawCount+=e,this._ndata=0,Yt.loopCount%100==0&&(this._data.length=0)}}}Pe.__posPool=[],Pe.__nPosPool=0;class Be{constructor(t=0,e=0,i=0){this.atlasID=0,this._width=0,this._height=0,this._texCount=0,this._rowInfo=null,this._cells=null,this._used=0,this._cells=null,this._rowInfo=null,this.atlasID=i,this._init(t,e)}addRect(t,e,i,r){return!!this._get(e,i,r)&&(this._fill(r.x,r.y,e,i,t),this._texCount++,!0)}_release(){this._cells=null,this._rowInfo=null}_init(t,e){return this._width=t,this._height=e,this._release(),0!=this._width&&(this._cells=new Uint8Array(this._width*this._height*3),this._rowInfo=new Uint8Array(this._height),this._used=0,this._clear(),!0)}_get(t,e,i){if(t>this._width||e>this._height)return!1;for(var r=-1,s=-1,a=this._width,n=this._height,h=this._cells,o=0;o<n;o++)if(!(this._rowInfo[o]<t))for(var l=0;l<a;){var _=3*(o*a+l);if(0!=h[_]||h[_+1]<t||h[_+2]<e)l+=h[_+1];else{r=l,s=o;for(var u=0;u<t;u++)if(h[3*u+_+2]<e){r=-1;break}if(!(r<0))return i.x=r,i.y=s,!0;l+=h[_+1]}}return!1}_fill(t,e,i,r,s){var a=this._width,n=this._height;this._check(t+i<=a&&e+r<=n);for(var h=e;h<r+e;++h){this._check(this._rowInfo[h]>=i),this._rowInfo[h]-=i;for(var o=0;o<i;o++){var l=3*(t+h*a+o);this._check(0==this._cells[l]),this._cells[l]=s,this._cells[l+1]=i,this._cells[l+2]=r}}if(t>0)for(h=0;h<r;++h){var _=0;for(o=t-1;o>=0&&0==this._cells[3*((e+h)*a+o)];--o,++_);for(o=_;o>0;--o)this._cells[3*((e+h)*a+t-o)+1]=o,this._check(o>0)}if(e>0)for(o=t;o<t+i;++o){for(_=0,h=e-1;h>=0&&0==this._cells[3*(o+h*a)];--h,_++);for(h=_;h>0;--h)this._cells[3*(o+(e-h)*a)+2]=h,this._check(h>0)}this._used+=i*r/(this._width*this._height)}_check(t){0==t&&console.log("xtexMerger 错误啦")}_clear(){this._texCount=0;for(var t=0;t<this._height;t++)this._rowInfo[t]=this._width;for(var e=0;e<this._height;e++)for(var i=0;i<this._width;i++){var r=3*(e*this._width+i);this._cells[r]=0,this._cells[r+1]=this._width-i,this._cells[r+2]=this._width-e}}}t.WrapMode=void 0,(fe=t.WrapMode||(t.WrapMode={}))[fe.Repeat=0]="Repeat",fe[fe.Clamp=1]="Clamp",fe[fe.Mirrored=2]="Mirrored";class Le extends M{get gammaCorrection(){return this.bitmap._glTexture.gammaCorrection}constructor(t,e){super(),this._texW=0,this._texH=0,this._discardTm=0,this.genID=0,this.bitmap={id:0,_glTexture:null},this.curUsedCovRate=0,this.curUsedCovRateAtlas=0,this.lastTouchTm=0,this.ri=null,this._texW=t||He.atlasWidth,this._texH=e||He.atlasWidth,this.bitmap.id=this.id,this.lock=!0,this._render2DContext=g.render2DContext}recreateResource(){if(!this._source){var e=this._source=new X(this._texW,this._texH,t.TextureFormat.R8G8B8A8,!1,!1,!0);e.setPixelsData(null,!0,!1),e.lock=!0,this.bitmap._glTexture=e,this._source.filterMode=t.FilterMode.Bilinear,this._source.wrapModeU=t.WrapMode.Clamp,this._source.wrapModeV=t.WrapMode.Clamp,He.debugUV&&this.fillWhite()}}addChar(t,e,i,r=null){if(He.isWan1Wan)return this.addCharCanvas(t,e,i,r);var s,a,n,h,o=t.data;return t.data instanceof Uint8ClampedArray&&(o=new Uint8Array(o.buffer)),!this._source&&this.recreateResource(),g.textureContext.setTextureSubPixelsData(this._source._texture,o,0,!1,e,i,t.width,t.height,!0,!1),s=e/this._texW,a=i/this._texH,n=(e+t.width)/this._texW,h=(i+t.height)/this._texH,(r=r||new Array(8))[0]=s,r[1]=a,r[2]=n,r[3]=a,r[4]=n,r[5]=h,r[6]=s,r[7]=h,r}addCharCanvas(t,e,i,r=null){var s,a,n,o;return!this._source&&this.recreateResource(),g.textureContext.setTexturebySubImageData(this._source._texture,t,e,i,!0,!1),h.isConch?(s=e/this._texW,a=i/this._texH,n=(e+t.width)/this._texW,o=(i+t.height)/this._texH):(s=(e+1)/this._texW,a=(i+1)/this._texH,n=(e+t.width-1)/this._texW,o=(i+t.height-1)/this._texH),(r=r||new Array(8))[0]=s,r[1]=a,r[2]=n,r[3]=a,r[4]=n,r[5]=o,r[6]=s,r[7]=o,r}fillWhite(){!this._source&&this.recreateResource();var t=new Uint8Array(this._texW*this._texH*4);t.fill(255),g.textureContext.setTextureImageData(this._source._getSource(),t,!0,!1)}discard(){n.stage.setGlobalRepaint(),this.destroy()}static getTextTexture(t,e){return new Le(t,e)}_disposeResource(){this._source&&this._source.destroy(),this._source=null}static clean(){var t=Yt.loopStTm;if(0===Le.cleanTm&&(Le.cleanTm=t),t-Le.cleanTm>=He.checkCleanTextureDt){for(var e=0;e<Le.poolLen;e++){var i=Le.pool[e];t-i._discardTm>=He.destroyUnusedTextureDt&&(i.destroy(),Le.pool[e]=Le.pool[Le.poolLen-1],Le.poolLen--,e--)}Le.cleanTm=t}}touchRect(t,e){this.lastTouchTm!=e&&(this.curUsedCovRate=0,this.curUsedCovRateAtlas=0,this.lastTouchTm=e);var i=He.atlasWidth*He.atlasWidth,r=Fe.atlasGridW*Fe.atlasGridW;this.curUsedCovRate+=t.bmpWidth*t.bmpHeight/i,this.curUsedCovRateAtlas+=Math.ceil(t.bmpWidth/Fe.atlasGridW)*Math.ceil(t.bmpHeight/Fe.atlasGridW)/(i/r)}get texture(){return this}_getSource(){return this._source._getSource()}drawOnScreen(t,e){}}Le.pool=new Array(10),Le.poolLen=0,Le.cleanTm=0;class Fe{constructor(){this.texWidth=1024,this.texHeight=1024,this.texture=null,this.charMaps={},this.texHeight=this.texWidth=He.atlasWidth,this.texture=Le.getTextTexture(this.texWidth,this.texHeight),this.texWidth/Fe.atlasGridW>256&&(Fe.atlasGridW=Math.ceil(this.texWidth/256)),this.atlasgrid=new Be(this.texWidth/Fe.atlasGridW,this.texHeight/Fe.atlasGridW,this.texture.id)}setProtecteDist(t){}getAEmpty(t,e,i){var r=this.atlasgrid.addRect(1,Math.ceil(t/Fe.atlasGridW),Math.ceil(e/Fe.atlasGridW),i);return r&&(i.x*=Fe.atlasGridW,i.y*=Fe.atlasGridW),r}get usedRate(){return this.atlasgrid._used}destroy(){for(var t in this.charMaps){this.charMaps[t].deleted=!0}this.texture.discard()}printDebugInfo(){}}Fe.atlasGridW=16;class Oe{static Parse(t){if(t===Oe._lastFont)return Oe._lastFontInfo;var e=Oe._cache[t];return e||(e=Oe._cache[t]=new Oe(t)),Oe._lastFont=t,Oe._lastFontInfo=e,e}constructor(t){this._font="14px Arial",this._family="Arial",this._size=14,this._italic=!1,this._bold=!1,this._id=Oe._gfontID++,this.setFont(t||this._font)}setFont(t){this._font=t;var e=t.split(" "),i=e.length;if(i<2)1==i&&e[0].indexOf("px")>0&&(this._size=parseInt(e[0]));else{for(var r=-1,s=0;s<i;s++)if(e[s].indexOf("px")>0||e[s].indexOf("pt")>0){r=s,this._size=parseInt(e[s]),this._size<=0&&(console.error("font parse error:"+t),this._size=14);break}var a=r+1,n=e[a];for(a++;a<i;a++)n+=" "+e[a];this._family=n.split(",")[0],this._italic=e.indexOf("italic")>=0,this._bold=e.indexOf("bold")>=0}}}Oe.EMPTY=new Oe(null),Oe._cache={},Oe._gfontID=0,Oe._lastFont="";class Ne{constructor(){this._nativeObj=new window._conchWordText}setText(t){this._nativeObj._text=t,this.cleanCache()}cleanCache(){this._nativeObj.cleanCache()}set splitRender(t){this._nativeObj.splitRender=t}}class Ue{constructor(){this.save=[],this.toUpperCase=null,this.width=-1,this.pageChars=[],this.startID=0,this.startIDStroke=0,this.lastGCCnt=0,this.splitRender=!1,this.scalex=1,this.scaley=1}setText(t){this.changed=!0,this._text=t,this.width=-1,this.cleanCache()}toString(){return this._text}get length(){return this._text?this._text.length:0}charCodeAt(t){return this._text?this._text.charCodeAt(t):NaN}charAt(t){return this._text?this._text.charAt(t):null}cleanCache(){let t=this.pageChars;for(var e in t){let r=t[e];var i=r.tex;1==r.words.length&&i&&i.ri&&i.destroy()}this.pageChars=[],this.startID=0,this.scalex=1,this.scaley=1}}window.conch&&!window.conchConfig.conchWebGL&&(Ue=Ne);class Ge{constructor(){this.char="",this.deleted=!1,this.uv=new Array(8),this.pos=0,this.orix=0,this.oriy=0,this.touchTick=0,this.isSpace=!1}touch(){var t=Yt.loopCount;this.touchTick!=t&&this.tex.touchRect(this,t),this.touchTick=t}}class ke{constructor(){this.fontsz=16}getWidth(t,e){return 0}scale(t,e){}get canvasWidth(){return 0}set canvasWidth(t){}getCharBmp(t,e,i,r,s,a,n,h,o,l,_=null){return null}}class We{static __init__(){let t=window.Laya||n.Laya;if(We._window)return We._window;let e=We._window=window,i=We._document=e.document,r=We.userAgent=e.navigator.userAgent,s=e.navigator.maxTouchPoints||0,a=e.navigator.platform;window.conch&&"conchUseWXAdapter"in We.window&&(window.wxMiniGame(t,t),t.MiniAdpter.enable()),"my"in We.window&&(r.indexOf("TB/")>-1||r.indexOf("Taobao/")>-1||r.indexOf("TM/")>-1?(window.tbMiniGame(t,t),t.TBMiniAdapter?t.TBMiniAdapter.enable():console.error("请先添加淘宝适配库,详细教程：https://ldc2.layabox.com/doc/?language=zh&nav=zh-ts-5-6-0")):r.indexOf("AlipayMiniGame")>-1&&(window.aliPayMiniGame(t,t),t.ALIMiniAdapter?t.ALIMiniAdapter.enable():console.error("请先添加阿里小游戏适配库,详细教程：https://ldc2.layabox.com/doc/?language=zh&nav=zh-ts-5-6-0"))),-1==r.indexOf("OPPO")&&r.indexOf("MiniGame")>-1&&"wx"in We.window&&("tt"in We.window?(window.ttMiniGame(t,t),t.TTMiniAdapter?t.TTMiniAdapter.enable():console.error("请引入字节跳动小游戏的适配库")):"bl"in We.window?(window.biliMiniGame(t,t),t.BLMiniAdapter?t.BLMiniAdapter.enable():console.error("请引入bilibili小游戏的适配库,详细教程：https://ldc2.layabox.com/doc/?language=zh&nav=zh-ts-5-7-0")):"qq"in We.window?(window.qqMiniGame(t,t),t.QQMiniAdapter?t.QQMiniAdapter.enable():console.error("请引入手机QQ小游戏的适配库,详细教程：https://ldc2.layabox.com/doc/?language=zh&nav=zh-ts-5-0-0")):(window.wxMiniGame(t,t),t.MiniAdpter?t.MiniAdpter.enable():console.error("请先添加小游戏适配库,详细教程：https://ldc2.layabox.com/doc/?nav=zh-ts-5-0-0"))),"hbs"in We.window&&(window.hwMiniGame(t,t),t.HWMiniAdapter?t.HWMiniAdapter.enable():console.error("请先添加小游戏适配库!")),r.indexOf("SwanGame")>-1&&(window.bdMiniGame(t,t),t.BMiniAdapter?t.BMiniAdapter.enable():console.error("请先添加百度小游戏适配库,详细教程：https://ldc2.layabox.com/doc/?language=zh&nav=zh-ts-5-1-0")),r.indexOf("QuickGame")>-1&&(window.miMiniGame(t,t),t.KGMiniAdapter?t.KGMiniAdapter.enable():console.error("请先添加小米小游戏适配库,详细教程：https://ldc2.layabox.com/doc/?language=zh&nav=zh-ts-5-2-0")),r.indexOf("OPPO")>-1&&r.indexOf("MiniGame")>-1&&(window.qgMiniGame(t,t),t.QGMiniAdapter?t.QGMiniAdapter.enable():console.error("请先添加OPPO小游戏适配库,详细教程：https://ldc2.layabox.com/doc/?language=zh&nav=zh-ts-5-3-0")),r.indexOf("VVGame")>-1&&(window.vvMiniGame(t,t),t.VVMiniAdapter?t.VVMiniAdapter.enable():console.error("请先添加VIVO小游戏适配库,详细教程：https://ldc2.layabox.com/doc/?language=zh&nav=zh-ts-5-4-0")),e.trace=console.log,e.requestAnimationFrame=e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||e.oRequestAnimationFrame||e.msRequestAnimationFrame||function(t){return e.setTimeout(t,1e3/60)};var h=i.body.style;h.margin=0,h.overflow="hidden",h["-webkit-user-select"]="none",h["-webkit-tap-highlight-color"]="rgba(200,200,200,0)";for(var o=i.getElementsByTagName("meta"),l=0,_=!1,u="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no";l<o.length;){var d=o[l];if("viewport"==d.name){d.content=u,_=!0;break}l++}return _||((d=i.createElement("meta")).name="viewport",d.content=u,i.getElementsByTagName("head")[0].appendChild(d)),We.onMobile=!!window.conch||r.indexOf("Mobile")>-1,We.onIOS=!!r.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),We.onIPhone=r.indexOf("iPhone")>-1,We.onMac=r.indexOf("Mac OS X")>-1,We.onIPad=r.indexOf("iPad")>-1||"MacIntel"===a&&s>1,We.onAndroid=r.indexOf("Android")>-1||r.indexOf("Adr")>-1,We.onWP=r.indexOf("Windows Phone")>-1,We.onQQBrowser=r.indexOf("QQBrowser")>-1,We.onMQQBrowser=r.indexOf("MQQBrowser")>-1||r.indexOf("Mobile")>-1&&r.indexOf("QQ")>-1,We.onIE=!!e.ActiveXObject||"ActiveXObject"in e,We.onWeiXin=r.indexOf("MicroMessenger")>-1,We.onSafari=r.indexOf("Safari")>-1,We.onChrome=r.indexOf("Chrome")>-1,We.onPC=!We.onMobile,We.onFirefox=r.indexOf("Firefox")>-1,We.onEdge=r.indexOf("Edge")>-1,We.onMiniGame=r.indexOf("MiniGame")>-1,We.onBDMiniGame=r.indexOf("SwanGame")>-1,We.onLayaRuntime=!!window.conch,r.indexOf("OPPO")>-1&&r.indexOf("MiniGame")>-1?(We.onQGMiniGame=!0,We.onMiniGame=!1):"qq"in We.window&&r.indexOf("MiniGame")>-1?(We.onQQMiniGame=!0,We.onMiniGame=!1):"bl"in We.window&&r.indexOf("MiniGame")>-1?(We.onBLMiniGame=!0,We.onMiniGame=!1):"tt"in We.window&&r.indexOf("MiniGame")>-1&&(We.onTTMiniGame=!0,We.onMiniGame=!1),We.onHWMiniGame="hbs"in We.window,We.onVVMiniGame=r.indexOf("VVGame")>-1,We.onKGMiniGame=r.indexOf("QuickGame")>-1,r.indexOf("AlipayMiniGame")>-1&&(We.onAlipayMiniGame=!0,We.onMiniGame=!1),(r.indexOf("TB/")>-1||r.indexOf("Taobao/")>-1||r.indexOf("TM/")>-1)&&(We.onTBMiniGame=!0),(We.onAndroid||We.onIOS)&&(!a||-1==a.indexOf("Win")&&-1==a.indexOf("Mac"))?We.onAndroid?We.platform=We.PLATFORM_ANDROID:We.platform=We.PLATFORM_IOS:We.platform=We.PLATFORM_PC,e}static get _isMiniGame(){return We.onMiniGame||We.onBDMiniGame||We.onQGMiniGame||We.onKGMiniGame||We.onVVMiniGame||We.onAlipayMiniGame||We.onQQMiniGame||We.onBLMiniGame||We.onTTMiniGame||We.onHWMiniGame||We.onTBMiniGame}static createElement(t){return We.__init__(),We._document.createElement(t)}static getElementById(t){return We.__init__(),We._document.getElementById(t)}static removeElement(t){t&&t.parentNode&&t.parentNode.removeChild(t)}static now(){return Date.now()}static get clientWidth(){return We.__init__(),We._clientWidth||We._window.innerWidth||We._document.body.clientWidth}static set clientWidth(t){We._clientWidth=t}static get clientHeight(){return We.__init__(),We._clientHeight||We._window.innerHeight||We._document.body.clientHeight||We._document.documentElement.clientHeight}static set clientHeight(t){We._clientHeight=t}static get width(){return We.__init__(),(n.stage&&n.stage.canvasRotation?We.clientHeight:We.clientWidth)*We.pixelRatio}static get height(){return We.__init__(),(n.stage&&n.stage.canvasRotation?We.clientWidth:We.clientHeight)*We.pixelRatio}static get pixelRatio(){return We._pixelRatio<0&&(We.__init__(),We.userAgent.indexOf("Mozilla/6.0(Linux; Android 6.0; HUAWEI NXT-AL10 Build/HUAWEINXT-AL10)")>-1?We._pixelRatio=2:(We._pixelRatio=We._window.devicePixelRatio||1,We._pixelRatio<1&&(We._pixelRatio=1))),We._pixelRatio}static get container(){return We._container||(We.__init__(),We._container=We.createElement("div"),We._container.id="layaContainer",We._document.body.appendChild(We._container)),We._container}static set container(t){We._container=t}static get window(){return We._window||We.__init__()}static get document(){return We.__init__(),We._document}static getQueryString(t){if(We.onMiniGame)return null;if(!window.location||!window.location.search)return null;var e=new RegExp("(^|&)"+t+"=([^&]*)(&|$)"),i=window.location.search.substring(1).match(e);return null!=i?unescape(i[2]):null}}We.PLATFORM_PC=0,We.PLATFORM_ANDROID=1,We.PLATFORM_IOS=2,We._pixelRatio=-1,We.mainCanvas=null,We.hanzi=new RegExp("^[一-龥]$"),We.fontMap={},We.measureText=function(t,e){let i=We.hanzi.test(t);if(i&&We.fontMap[e])return We.fontMap[e];let r=We.context;r.font=e;let s=r.measureText(t);return i&&(We.fontMap[e]=s),s};class Ve extends ke{constructor(t,e,i=!0,r=!0,s=!1){super(),this.ctx=null,this.lastScaleX=1,this.lastScaleY=1,this.maxTexW=0,this.maxTexH=0,this.scaleFontSize=!0,this.showDbgInfo=!1,this.supportImageData=!0,this.maxTexW=t,this.maxTexH=e,this.scaleFontSize=i,this.supportImageData=r,this.showDbgInfo=s,Ve.canvas||(Ve.canvas=We.createElement("canvas"),Ve.canvas.width=1024,Ve.canvas.height=512,Ve.canvas.style.left="-10000px",Ve.canvas.style.position="absolute",document.body.appendChild(Ve.canvas),this.ctx=Ve.canvas.getContext("2d",{willReadFrequently:!0}))}get canvasWidth(){return Ve.canvas.width}set canvasWidth(t){Ve.canvas.width!=t&&(Ve.canvas.width=t,t>2048&&console.warn("画文字设置的宽度太大，超过2048了"),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.scale(this.lastScaleX,this.lastScaleY))}getWidth(t,e){return this.ctx?(this.ctx._lastFont!=t&&(this.ctx.font=t,this.ctx._lastFont=t),this.ctx.measureText(e).width):0}scale(t,e){if(!this.supportImageData)return this.lastScaleX=t,void(this.lastScaleY=e);this.lastScaleX==t&&this.lastScaleY==e||(this.ctx.setTransform(t,0,0,e,0,0),this.lastScaleX=t,this.lastScaleY=e)}getCharBmp(t,e,i,r,s,a,n,h,o,l,_=null){if(!this.supportImageData)return this.getCharCanvas(t,e,i,r,s,a,n,h,o,l);var u=this.ctx,d=this.fontsz;u.font!=e&&(u.font=e,u._lastFont=e),a.width=u.measureText(t).width;var c=a.width*this.lastScaleX,p=a.height*this.lastScaleY;c+=(n+o)*this.lastScaleX,p+=(h+l)*this.lastScaleY,c=Math.ceil(c),p=Math.ceil(p);var f=(c=Math.min(c,Ve.canvas.width))+2*i+1,m=(p=Math.min(p,Ve.canvas.height))+2*i+1;_&&(f=Math.max(f,_[0]+_[2]+1),m=Math.max(m,_[1]+_[3]+1)),u.clearRect(0,0,f/this.lastScaleX+1,m/this.lastScaleY+1),u.save(),u.textBaseline="middle",i>0&&(u.strokeStyle=s,u.lineWidth=i,u.strokeText(t,n,h+d/2)),r&&(u.fillStyle=r,u.fillText(t,n,h+d/2)),this.showDbgInfo&&(u.strokeStyle="#ff0000",u.strokeRect(1,1,c-2,p-2),u.strokeStyle="#00ff00",u.strokeRect(n,h,a.width,a.height)),_&&(-1==_[2]&&(_[2]=Math.ceil((a.width+2*i)*this.lastScaleX)),_[2]<=0&&(_[2]=1));var g=_?u.getImageData(_[0],_[1],_[2],_[3]+1):u.getImageData(0,0,c,p+1);return u.restore(),a.bmpWidth=g.width,a.bmpHeight=g.height,g}getCharCanvas(t,e,i,r,s,a,n,h,o,l){var _=this.ctx;_.font!=e&&(_.font=e,_._lastFont=e),a.width=_.measureText(t).width;var u=a.width*this.lastScaleX,d=a.height*this.lastScaleY;u+=(n+o)*this.lastScaleX,d+=(h+l)*this.lastScaleY+1,u=Math.min(u,this.maxTexW),d=Math.min(d,this.maxTexH),Ve.canvas.width=Math.min(u+1,this.maxTexW),Ve.canvas.height=Math.min(d+1,this.maxTexH),_.font=e,_.clearRect(0,0,u+1+i,d+1+i),_.setTransform(1,0,0,1,0,0),_.save(),this.scaleFontSize&&_.scale(this.lastScaleX,this.lastScaleY),_.translate(n,h),_.textAlign="left";var c=this.fontsz;return _.textBaseline="middle",i>0?(_.strokeStyle=s,_.fillStyle=r,_.lineWidth=i,_.fillAndStrokeText?_.fillAndStrokeText(t,0,c/2):(_.strokeText(t,0,c/2),_.fillText(t,0,c/2))):r&&(_.fillStyle=r,_.fillText(t,0,c/2)),this.showDbgInfo&&(_.strokeStyle="#ff0000",_.strokeRect(0,0,u,d),_.strokeStyle="#00ff00",_.strokeRect(0,0,a.width,a.height)),_.restore(),a.bmpWidth=Ve.canvas.width,a.bmpHeight=Ve.canvas.height,Ve.canvas}}Ve.canvas=null;class Xe extends ke{constructor(){super(),this.lastFont="",this.lastScaleX=1,this.lastScaleY=1}getWidth(t,e){return window.conchTextCanvas?(window.conchTextCanvas.font=t,this.lastFont=t,window.conchTextCanvas.measureText(e).width):0}scale(t,e){this.lastScaleX=t,this.lastScaleY=e}getCharBmp(t,e,i,r,s,a,n,h,o,l,_=null){if(!window.conchTextCanvas)return null;window.conchTextCanvas.font=e,this.lastFont=e,a.width=window.conchTextCanvas.measureText(t).width,a.height,window.conchTextCanvas.scale&&window.conchTextCanvas.scale(this.lastScaleX,this.lastScaleY);var u=St.create(s).numColor,d=St.create(r).numColor,c=window.conchTextCanvas.getTextBitmapData(t,d,i>2?2:i,u);return a.bmpWidth=c.width,a.bmpHeight=c.height,c}}class He{constructor(){this.fontSizeInfo={},this.mapFont={},this.fontID=0,this.fontScaleX=1,this.fontScaleY=1,this._curStrPos=0,this.textAtlases=[],this.isoTextures=[],this.lastFont=null,this.fontSizeW=0,this.fontSizeH=0,this.fontSizeOffX=0,this.fontSizeOffY=0,this.renderPerChar=!0,this.tmpAtlasPos=new f,this.textureMem=0;var t=!1,e=n.Laya.MiniAdpter;e&&e.systemInfo&&e.systemInfo.system&&(t="ios 10.1.1"===e.systemInfo.system.toLowerCase()),(n.Browser.onMiniGame||n.Browser.onTTMiniGame||n.Browser.onBLMiniGame||n.Browser.onAlipayMiniGame||n.Browser.onTBMiniGame)&&!t&&(He.isWan1Wan=!0),this.charRender=h.isConch?new Xe:new Ve(2048,2048,He.scaleFontWithCtx,!He.isWan1Wan,!1),He.textRenderInst=this,n.Laya.textRender=this,He.atlasWidth2=He.atlasWidth*He.atlasWidth}setFont(t){if(this.lastFont!=t){this.lastFont=t;var e=this.getFontSizeInfo(t._family),i=e>>24,r=e>>16&255,s=e>>8&255,a=255&e,n=t._size/He.standardFontSize;this.fontSizeOffX=Math.ceil(i*n),this.fontSizeOffY=Math.ceil(r*n),this.fontSizeW=Math.ceil(s*n),this.fontSizeH=Math.ceil(a*n),t._font.indexOf("italic")>=0?this.fontStr=t._font.replace("italic",""):this.fontStr=t._font}}getNextChar(t){var e=t.length,i=this._curStrPos;if(!t.substring)return null;if(i>=e)return null;for(var r=i,s=0;r<e;r++){var a=t.charCodeAt(r);if(a>>>11==27){if(1==s)break;s=1,r++}else if(65038===a||65039===a);else if(8205==a)s=2;else if(0==s)s=1;else if(1==s)break}return this._curStrPos=r,t.substring(i,r)}filltext(t,e,r,s,a,n,h,o,l,_=0){if(!(e.length<=0)){var u=Oe.Parse(a),d=0;switch(l){case"center":d=i.ENUM_TEXTALIGN_CENTER;break;case"right":d=i.ENUM_TEXTALIGN_RIGHT}this._fast_filltext(t,e,null,r,s,u,n,h,o,d,_)}}fillWords(t,e,i,r,s,a,n,h){if(e&&!(e.length<=0)){var o="string"==typeof s?Oe.Parse(s):s;this._fast_filltext(t,null,e,i,r,o,a,n,h,0,0)}}_fast_filltext(t,e,r,s,a,n,o,l,_,u,d=0){if((!e||e.length>=1)&&!(r&&r.length<1)){if(_<0&&(_=0),this.setFont(n),this.fontScaleX=this.fontScaleY=1,He.scaleFontWithCtx){var c=1,p=1;if(h.isConch&&!window.conchTextCanvas.scale||(c=t.getMatScaleX(),p=t.getMatScaleY()),c<1e-4||p<.1)return;c>1&&(this.fontScaleX=c),p>1&&(this.fontScaleY=p)}n._italic&&(t._italicDeg=13);var f=e,m=!r&&e instanceof Ue,g=e&&e.toString(),T=!!r,x=m?f.pageChars:[],E=0;switch(m?(g=f._text,(E=f.width)<0&&(E=f.width=this.charRender.getWidth(this.fontStr,g))):E=g?this.charRender.getWidth(this.fontStr,g):0,u){case i.ENUM_TEXTALIGN_CENTER:s-=E/2;break;case i.ENUM_TEXTALIGN_RIGHT:s-=E}f&&x&&this.hasFreedText(x)&&(x=f.pageChars=[]);var y=null,v=this.renderPerChar=!m||He.forceSplitRender||T||m&&f.splitRender;if(!x||x.length<1)if(m&&(f.scalex=this.fontScaleX,f.scaley=this.fontScaleY),v){var S,R=0,b=0;for(this._curStrPos=0;;){if(r){var C=r[this._curStrPos++];C?(S=C.char,R=C.x,b=C.y):S=null}else S=this.getNextChar(g);if(!S)break;if(!(y=this.getCharRenderInfo(S,n,o,l,_,!1)))break;if(y.isSpace);else{var A=x[y.tex.id];if(A)A=A.words;else{var w={texgen:y.tex.genID,tex:y.tex,words:new Array};x[y.tex.id]=w,A=w.words}A.push({ri:y,x:R,y:b,w:y.bmpWidth/this.fontScaleX,h:y.bmpHeight/this.fontScaleY}),R+=y.width}}}else{var M=h.isConch?0:n._size/3|0,D=He.noAtlas||(E+M+M)*this.fontScaleX>He.atlasWidth;y=this.getCharRenderInfo(g,n,o,l,_,D),x[0]={texgen:y.tex.genID,tex:y.tex,words:[{ri:y,x:0,y:0,w:y.bmpWidth/this.fontScaleX,h:y.bmpHeight/this.fontScaleY}]}}this._drawResortedWords(t,s,a,x),t._italicDeg=0}}_drawResortedWords(t,e,i,r){var s=!!t._charSubmitCache&&t._charSubmitCache._enable,a=t._curMat;for(var n in r){var o=r[n];if(o){var l=o.words,_=l.length;if(!(_<=0))for(var u=r[n].tex,d=0;d<_;d++){var c=l[d],p=c.ri;if(!p.isSpace){if(p.touch(),t.drawTexAlign=!0,h.isConch)t._drawTextureM(u.texture,e+c.x-p.orix,i+c.y-p.oriy,c.w,c.h,null,1,p.uv);else{let r=u;t._inner_drawTexture(r.texture,r.id,e+c.x-p.orix,i+c.y-p.oriy,c.w,c.h,a,p.uv,1,s)}t.touches&&t.touches.push(p)}}}}}hasFreedText(t){for(let r in t){var e=t[r];if(e){var i=e.tex;if(i.destroyed||i.genID!=e.texgen)return!0}}return!1}getCharRenderInfo(t,e,i,r,s,a=!1){var n=this.mapFont[e._family];null==n&&(this.mapFont[e._family]=n=this.fontID++);var o=t+"_"+n+"_"+e._size+"_"+i;s>0&&(o+="_"+r+s),e._bold&&(o+="P"),1==this.fontScaleX&&1==this.fontScaleY||(o+=(20*this.fontScaleX|0)+"_"+(20*this.fontScaleY|0));var l,_,u=0,d=this.textAtlases.length;if(!a)for(u=0;u<d;u++)if(l=(_=this.textAtlases[u]).charMaps[o])return l.touch(),l;l=new Ge,this.charRender.scale(this.fontScaleX,this.fontScaleY),l.char=t,l.height=e._size;var c=h.isConch?0:e._size/3|0,p=null;s||(s=0);var f=Math.ceil((this.charRender.getWidth(this.fontStr,t)+2*s)*this.fontScaleX);if(f>this.charRender.canvasWidth&&(this.charRender.canvasWidth=Math.min(2048,f+2*c)),a){if(this.charRender.fontsz=e._size,p=this.charRender.getCharBmp(t,this.fontStr,s,i,r,l,c,c,c,c,null)){var m=Le.getTextTexture(p.width,p.height);m.addChar(p,0,0,l.uv),l.tex=m,l.orix=c,l.oriy=c,m.ri=l,this.isoTextures.push(m)}}else{var g=t.length,T=1*s,x=Math.ceil((this.fontSizeW+2*T)*this.fontScaleX),E=Math.ceil((this.fontSizeH+2*T)*this.fontScaleY);He.imgdtRect[0]=(c-this.fontSizeOffX-T)*this.fontScaleX|0,He.imgdtRect[1]=(c-this.fontSizeOffY-T)*this.fontScaleY|0,this.renderPerChar||1==g?(He.imgdtRect[2]=Math.max(f,x),He.imgdtRect[3]=Math.max(f,E)):(He.imgdtRect[2]=-1,He.imgdtRect[3]=E),this.charRender.fontsz=e._size,(p=this.charRender.getCharBmp(t,this.fontStr,s,i,r,l,c,c,c,c,He.imgdtRect))&&(_=this.addBmpData(p,l),He.isWan1Wan?(l.orix=c,l.oriy=c):(l.orix=this.fontSizeOffX+T,l.oriy=this.fontSizeOffY+T),_.charMaps[o]=l)}return l}addBmpData(t,e){for(var i,r=t.width,s=t.height,a=this.textAtlases.length,n=!1,h=0;h<a&&!(n=(i=this.textAtlases[h]).getAEmpty(r,s,this.tmpAtlasPos));h++);if(!n){if(i=new Fe,this.textAtlases.push(i),!(n=i.getAEmpty(r,s,this.tmpAtlasPos)))throw"err1";this.cleanAtlases()}return n&&(i.texture.addChar(t,this.tmpAtlasPos.x,this.tmpAtlasPos.y,e.uv),e.tex=i.texture),i}GC(){for(var t=0,e=this.textAtlases.length,i=He.destroyAtlasDt,r=0,s=Yt.loopCount,a=-1,n=0,h=null,o=null;t<e;t++){if(h=(o=this.textAtlases[t]).texture){h.curUsedCovRate,r+=h.curUsedCovRateAtlas;var l=o.usedRate-h.curUsedCovRateAtlas;n<l&&(n=l,a=t)}s-o.texture.lastTouchTm>i&&(He.showLog&&console.log(o.texture.id),o.destroy(),this.textAtlases[t]=this.textAtlases[e-1],e--,t--,a=-1)}for(this.textAtlases.length=e,e=this.isoTextures.length,t=0;t<e;t++)s-(h=this.isoTextures[t]).lastTouchTm>He.destroyUnusedTextureDt&&(h.ri.deleted=!0,h.ri.tex=null,h.destroy(),this.isoTextures[t]=this.isoTextures[e-1],e--,t--);this.isoTextures.length=e;var _=this.textAtlases.length>1&&this.textAtlases.length-r>=2;(He.atlasWidth*He.atlasWidth*4*this.textAtlases.length>He.cleanMem||_||He.simClean)&&(He.simClean=!1,He.showLog&&console.log("清理使用率低的贴图。总使用率:",r,":",this.textAtlases.length,"最差贴图:"+a),a>=0&&((o=this.textAtlases[a]).destroy(),this.textAtlases[a]=this.textAtlases[this.textAtlases.length-1],this.textAtlases.length=this.textAtlases.length-1)),Le.clean()}cleanAtlases(){}getCharBmp(t){}checkBmpLine(t,e,i,r){this.bmpData32.buffer!=t.data.buffer&&(this.bmpData32=new Uint32Array(t.data.buffer));for(var s=t.width*e+i,a=i;a<r;a++)if(0!=this.bmpData32[s++])return!0;return!1}updateBbx(t,e,i=!1){var r=t.width,s=t.height,a=0,n=e[1],h=0,o=n;if(this.checkBmpLine(t,n,0,r))for(;;){if((o=(n+h)/2|0)+1>=n){e[1]=o;break}this.checkBmpLine(t,o,0,r)?n=o:h=o}if(e[3]>s)e[3]=s;else if(o=n=e[3],h=s,this.checkBmpLine(t,n,0,r))for(;;){if((o=(n+h)/2|0)-1<=n){e[3]=o;break}this.checkBmpLine(t,o,0,r)?n=o:h=o}if(!i){var l=e[0],_=r*e[1];for(o=e[1];o<e[3];o++){for(a=0;a<l;a++)if(0!=this.bmpData32[_+a]){l=a;break}_+=r}e[0]=l;var u=e[2];for(_=r*e[1],o=e[1];o<e[3];o++){for(a=u;a<r;a++)if(0!=this.bmpData32[_+a]){u=a;break}_+=r}e[2]=u}}getFontSizeInfo(t){var e=this.fontSizeInfo[t];if(null!=e)return e;var i="bold "+He.standardFontSize+"px "+t;if(He.isWan1Wan){this.fontSizeW=1.5*this.charRender.getWidth(i,"有"),this.fontSizeH=1.5*He.standardFontSize;var r=this.fontSizeW<<8|this.fontSizeH;return this.fontSizeInfo[t]=r,r}He.pixelBBX[0]=He.standardFontSize/2,He.pixelBBX[1]=He.standardFontSize/2,He.pixelBBX[2]=He.standardFontSize,He.pixelBBX[3]=He.standardFontSize;var s=16,a=16;this.charRender.scale(1,1),He.tmpRI.height=He.standardFontSize,this.charRender.fontsz=He.standardFontSize;var n=this.charRender.getCharBmp("g",i,0,"red",null,He.tmpRI,s,a,16,16);h.isConch&&(n.data=new Uint8ClampedArray(n.data)),this.bmpData32=new Uint32Array(n.data.buffer),this.updateBbx(n,He.pixelBBX,!1),n=this.charRender.getCharBmp("有",i,0,"red",null,He.tmpRI,a,a,16,16),h.isConch&&(n.data=new Uint8ClampedArray(n.data)),this.bmpData32=new Uint32Array(n.data.buffer),He.pixelBBX[2]<s+He.tmpRI.width&&(He.pixelBBX[2]=s+He.tmpRI.width),this.updateBbx(n,He.pixelBBX,!1),h.isConch&&(s=0,a=0);var o=Math.max(s-He.pixelBBX[0],0)<<24|Math.max(a-He.pixelBBX[1],0)<<16|He.pixelBBX[2]-He.pixelBBX[0]<<8|He.pixelBBX[3]-He.pixelBBX[1];return this.fontSizeInfo[t]=o,o}printDbgInfo(){for(var t in console.log("图集个数:"+this.textAtlases.length+",每个图集大小:"+He.atlasWidth+"x"+He.atlasWidth," 用canvas:",He.isWan1Wan),console.log("图集占用空间:"+He.atlasWidth*He.atlasWidth*4/1024/1024*this.textAtlases.length+"M"),console.log("缓存用到的字体:"),this.mapFont){var e=this.getFontSizeInfo(t),i=e>>24,r=e>>16&255,s=e>>8&255,a=255&e;console.log("    "+t," off:",i,r," size:",s,a)}var n=0;console.log("缓存数据:");var h=0,o=0;this.textAtlases.forEach((function(t){var e=t.texture.id,i=Yt.loopCount-t.texture.lastTouchTm,r=i>0?i+"帧以前":"当前帧";for(var s in h+=t.texture.curUsedCovRate,o+=t.texture.curUsedCovRateAtlas,console.log("--图集(id:"+e+",当前使用率:"+(1e3*t.texture.curUsedCovRate|0)+"‰","当前图集使用率:",(100*t.texture.curUsedCovRateAtlas|0)+"%","图集使用率:",100*t.usedRate|0,"%, 使用于:"+r+")--:"),t.charMaps){var a=t.charMaps[s];console.log("     off:",a.orix,a.oriy," bmp宽高:",a.bmpWidth,a.bmpHeight,"无效:",a.deleted,"touchdt:",Yt.loopCount-a.touchTick,"位置:",a.uv[0]*He.atlasWidth|0,a.uv[1]*He.atlasWidth|0,"字符:",a.char,"key:",s),n++}})),console.log("独立贴图文字("+this.isoTextures.length+"个):"),this.isoTextures.forEach((function(t){console.log("    size:",t._texW,t._texH,"touch间隔:",Yt.loopCount-t.lastTouchTm,"char:",t.ri.char)})),console.log("总缓存:",n,"总使用率:",h,"总当前图集使用率:",o)}showAtlas(t,e,i,r,s,a){if(!this.textAtlases[t])return console.log("没有这个图集"),null;var h=new Ki,o=this.textAtlases[t].texture,l={width:He.atlasWidth,height:He.atlasWidth,sourceWidth:He.atlasWidth,sourceHeight:He.atlasWidth,offsetX:0,offsetY:0,getIsReady:function(){return!0},_addReference:function(){},_removeReference:function(){},_getSource:function(){return o._getSource()},bitmap:{id:o.id},_uv:ht.DEF_UV};return h.size=function(t,i){return this.width=t,this.height=i,h.graphics.clear(),h.graphics.drawRect(0,0,h.width,h.height,e),h.graphics.drawTexture(l,0,0,h.width,h.height),this},h.graphics.drawRect(0,0,s,a,e),h.graphics.drawTexture(l,0,0,s,a),h.pos(i,r),n.stage.addChild(h),h}filltext_native(t,e,r,s,a,n,h,o,l,_,u=0){if(!(e&&e.length<=0||r&&r.length<1)){var d=Oe.Parse(n),c=0;switch(_){case"center":c=i.ENUM_TEXTALIGN_CENTER;break;case"right":c=i.ENUM_TEXTALIGN_RIGHT}return this._fast_filltext(t,e,r,s,a,d,h,o,l,c,u)}}}He.useOldCharBook=!1,He.atlasWidth=1024,He.noAtlas=!1,He.forceSplitRender=!1,He.forceWholeRender=!1,He.scaleFontWithCtx=!0,He.standardFontSize=32,He.destroyAtlasDt=10,He.checkCleanTextureDt=2e3,He.destroyUnusedTextureDt=3e3,He.cleanMem=104857600,He.isWan1Wan=!1,He.showLog=!1,He.debugUV=!1,He.tmpRI=new Ge,He.pixelBBX=[0,0,0,0],He.imgdtRect=[0,0,0,0],He.simClean=!1;class Ye{constructor(){}static isZero(t){return Math.abs(t)<Ye.zeroTolerance}static nearEqual(t,e){return!!Ye.isZero(t-e)}static fastInvSqrt(t){return Ye.isZero(t)?t:1/Math.sqrt(t)}}Ye.zeroTolerance=1e-6,Ye.MaxValue=340282347e30,Ye.MinValue=-340282347e30,Ye.Deg2Rad=Math.PI/180;class ze{constructor(t=0,e=0){this.x=t,this.y=e}setValue(t,e){this.x=t,this.y=e}static scale(t,e,i){i.x=t.x*e,i.y=t.y*e}fromArray(t,e=0){this.x=t[e+0],this.y=t[e+1]}toArray(){return[this.x,this.y]}writeTo(t,e=0){t[e+0]=this.x,t[e+1]=this.y}cloneTo(t){var e=t;e.x=this.x,e.y=this.y}static dot(t,e){return t.x*e.x+t.y*e.y}static normalize(t,e){var i=t.x,r=t.y,s=i*i+r*r;s>0&&(s=1/Math.sqrt(s),e.x=i*s,e.y=r*s)}static scalarLength(t){var e=t.x,i=t.y;return Math.sqrt(e*e+i*i)}clone(){var t=new ze;return this.cloneTo(t),t}forNativeElement(t=null){t?(this.elements=t,this.elements[0]=this.x,this.elements[1]=this.y):this.elements=new Float32Array([this.x,this.y]),ze.rewriteNumProperty(this,"x",0),ze.rewriteNumProperty(this,"y",1)}static rewriteNumProperty(t,e,i){Object.defineProperty(t,e,{get:function(){return this.elements[i]},set:function(t){this.elements[i]=t}})}}ze.ZERO=new ze(0,0),ze.ONE=new ze(1,1);class je{constructor(t=0,e=0,i=0,r=0){this.x=t,this.y=e,this.z=i,this.w=r}setValue(t,e,i,r){this.x=t,this.y=e,this.z=i,this.w=r}fromArray(t,e=0){this.x=t[e+0],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3]}toArray(){return[this.x,this.y,this.z,this.w]}writeTo(t,e=0){t[e+0]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w}cloneTo(t){var e=t;e.x=this.x,e.y=this.y,e.z=this.z,e.w=this.w}clone(){var t=new je;return this.cloneTo(t),t}static lerp(t,e,i,r){var s=t.x,a=t.y,n=t.z,h=t.w;r.x=s+i*(e.x-s),r.y=a+i*(e.y-a),r.z=n+i*(e.z-n),r.w=h+i*(e.w-h)}static transformByM4x4(t,e,i){var r=t.x,s=t.y,a=t.z,n=t.w,h=e.elements;i.x=r*h[0]+s*h[4]+a*h[8]+n*h[12],i.y=r*h[1]+s*h[5]+a*h[9]+n*h[13],i.z=r*h[2]+s*h[6]+a*h[10]+n*h[14],i.w=r*h[3]+s*h[7]+a*h[11]+n*h[15]}static equals(t,e){return Ye.nearEqual(Math.abs(t.x),Math.abs(e.x))&&Ye.nearEqual(Math.abs(t.y),Math.abs(e.y))&&Ye.nearEqual(Math.abs(t.z),Math.abs(e.z))&&Ye.nearEqual(Math.abs(t.w),Math.abs(e.w))}equal(t){return je.equals(this,t)}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}static normalize(t,e){var i=t.length();if(i>0){var r=1/i;e.x=t.x*r,e.y=t.y*r,e.z=t.z*r,e.w=t.w*r}}static add(t,e,i){i.x=t.x+e.x,i.y=t.y+e.y,i.z=t.z+e.z,i.w=t.w+e.w}static subtract(t,e,i){i.x=t.x-e.x,i.y=t.y-e.y,i.z=t.z-e.z,i.w=t.w-e.w}static multiply(t,e,i){i.x=t.x*e.x,i.y=t.y*e.y,i.z=t.z*e.z,i.w=t.w*e.w}static scale(t,e,i){i.x=t.x*e,i.y=t.y*e,i.z=t.z*e,i.w=t.w*e}static Clamp(t,e,i,r){var s=t.x,a=t.y,n=t.z,h=t.w,o=e.x,l=e.y,_=e.z,u=e.w,d=i.x,c=i.y,p=i.z,f=i.w;s=(s=s>d?d:s)<o?o:s,a=(a=a>c?c:a)<l?l:a,n=(n=n>p?p:n)<_?_:n,h=(h=h>f?f:h)<u?u:h,r.x=s,r.y=a,r.z=n,r.w=h}static distanceSquared(t,e){var i=t.x-e.x,r=t.y-e.y,s=t.z-e.z,a=t.w-e.w;return i*i+r*r+s*s+a*a}static distance(t,e){var i=t.x-e.x,r=t.y-e.y,s=t.z-e.z,a=t.w-e.w;return Math.sqrt(i*i+r*r+s*s+a*a)}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w}static min(t,e,i){i.x=Math.min(t.x,e.x),i.y=Math.min(t.y,e.y),i.z=Math.min(t.z,e.z),i.w=Math.min(t.w,e.w)}static max(t,e,i){i.x=Math.max(t.x,e.x),i.y=Math.max(t.y,e.y),i.z=Math.max(t.z,e.z),i.w=Math.max(t.w,e.w)}forNativeElement(t=null){t?(this.elements=t,this.elements[0]=this.x,this.elements[1]=this.y,this.elements[2]=this.z,this.elements[3]=this.w):this.elements=new Float32Array([this.x,this.y,this.z,this.w]),ze.rewriteNumProperty(this,"x",0),ze.rewriteNumProperty(this,"y",1),ze.rewriteNumProperty(this,"z",2),ze.rewriteNumProperty(this,"w",3)}}je.ZERO=new je,je.ONE=new je(1,1,1,1),je.UnitX=new je(1,0,0,0),je.UnitY=new je(0,1,0,0),je.UnitZ=new je(0,0,1,0),je.UnitW=new je(0,0,0,1),je.tempVec4=new je(0,0,0,0);class Ke{static distanceSquared(t,e){var i=t.x-e.x,r=t.y-e.y,s=t.z-e.z;return i*i+r*r+s*s}static distance(t,e){var i=t.x-e.x,r=t.y-e.y,s=t.z-e.z;return Math.sqrt(i*i+r*r+s*s)}static min(t,e,i){i.x=Math.min(t.x,e.x),i.y=Math.min(t.y,e.y),i.z=Math.min(t.z,e.z)}static max(t,e,i){i.x=Math.max(t.x,e.x),i.y=Math.max(t.y,e.y),i.z=Math.max(t.z,e.z)}static transformQuat(t,e,i){var r=t.x,s=t.y,a=t.z,n=e.x,h=e.y,o=e.z,l=e.w,_=l*r+h*a-o*s,u=l*s+o*r-n*a,d=l*a+n*s-h*r,c=-n*r-h*s-o*a;i.x=_*l+c*-n+u*-o-d*-h,i.y=u*l+c*-h+d*-n-_*-o,i.z=d*l+c*-o+_*-h-u*-n}static scalarLength(t){var e=t.x,i=t.y,r=t.z;return Math.sqrt(e*e+i*i+r*r)}static scalarLengthSquared(t){var e=t.x,i=t.y,r=t.z;return e*e+i*i+r*r}static normalize(t,e){var i=t.x,r=t.y,s=t.z,a=i*i+r*r+s*s;a>0&&(a=1/Math.sqrt(a),e.x=i*a,e.y=r*a,e.z=s*a)}static multiply(t,e,i){i.x=t.x*e.x,i.y=t.y*e.y,i.z=t.z*e.z}static scale(t,e,i){i.x=t.x*e,i.y=t.y*e,i.z=t.z*e}static lerp(t,e,i,r){var s=t.x,a=t.y,n=t.z;r.x=s+i*(e.x-s),r.y=a+i*(e.y-a),r.z=n+i*(e.z-n)}static transformV3ToV3(t,e,i){var r=Ke._tempVector4;Ke.transformV3ToV4(t,e,r),i.x=r.x,i.y=r.y,i.z=r.z}static transformV3ToV4(t,e,i){var r=t.x,s=t.y,a=t.z,n=e.elements;i.x=r*n[0]+s*n[4]+a*n[8]+n[12],i.y=r*n[1]+s*n[5]+a*n[9]+n[13],i.z=r*n[2]+s*n[6]+a*n[10]+n[14],i.w=r*n[3]+s*n[7]+a*n[11]+n[15]}static TransformNormal(t,e,i){var r=t.x,s=t.y,a=t.z,n=e.elements;i.x=r*n[0]+s*n[4]+a*n[8],i.y=r*n[1]+s*n[5]+a*n[9],i.z=r*n[2]+s*n[6]+a*n[10]}static transformCoordinate(t,e,i){var r=t.x,s=t.y,a=t.z,n=e.elements,h=r*n[3]+s*n[7]+a*n[11]+n[15];i.x=(r*n[0]+s*n[4]+a*n[8]+n[12])/h,i.y=(r*n[1]+s*n[5]+a*n[9]+n[13])/h,i.z=(r*n[2]+s*n[6]+a*n[10]+n[14])/h}static Clamp(t,e,i,r){var s=t.x,a=t.y,n=t.z,h=e.x,o=e.y,l=e.z,_=i.x,u=i.y,d=i.z;s=(s=s>_?_:s)<h?h:s,a=(a=a>u?u:a)<o?o:a,n=(n=n>d?d:n)<l?l:n,r.x=s,r.y=a,r.z=n}static add(t,e,i){i.x=t.x+e.x,i.y=t.y+e.y,i.z=t.z+e.z}static subtract(t,e,i){i.x=t.x-e.x,i.y=t.y-e.y,i.z=t.z-e.z}static cross(t,e,i){var r=t.x,s=t.y,a=t.z,n=e.x,h=e.y,o=e.z;i.x=s*o-a*h,i.y=a*n-r*o,i.z=r*h-s*n}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}static equals(t,e){return Ye.nearEqual(t.x,e.x)&&Ye.nearEqual(t.y,e.y)&&Ye.nearEqual(t.z,e.z)}constructor(t=0,e=0,i=0){this.x=t,this.y=e,this.z=i}equal(t){return Ke.equals(this,t)}setValue(t,e,i){return this.x=t,this.y=e,this.z=i,this}set(t,e,i){return this.x=t,this.y=e,this.z=i,this}fromArray(t,e=0){this.x=t[e+0],this.y=t[e+1],this.z=t[e+2]}toArray(){return[this.x,this.y,this.z]}writeTo(t,e=0){t[e+0]=this.x,t[e+1]=this.y,t[e+2]=this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z}vsub(t,e){return e.x=this.x-t.x,e.y=this.y-t.y,e.z=this.z-t.z,e}vadd(t,e){return e.x=this.x+t.x,e.y=this.y+t.y,e.z=this.z+t.z,e}scale(t,e){return e.x=this.x*t,e.y=this.y*t,e.z=this.z*t,e}normalize(){let t=this.x,e=this.y,i=this.z;var r=t*t+e*e+i*i;return r>0&&(r=1/Math.sqrt(r),this.x=t*r,this.y=e*r,this.z=i*r),this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}cross(t,e){var i=this.x,r=this.y,s=this.z,a=t.x,n=t.y,h=t.z;return e.x=r*h-s*n,e.y=s*a-i*h,e.z=i*n-r*a,e}cloneTo(t){var e=t;e.x=this.x,e.y=this.y,e.z=this.z}clone(){var t=new Ke;return this.cloneTo(t),t}toDefault(){this.x=0,this.y=0,this.z=0}}Ke._tempVector4=new je,Ke.ZERO=new Ke(0,0,0),Ke.ONE=new Ke(1,1,1),Ke.NegativeUnitX=new Ke(-1,0,0),Ke.UnitX=new Ke(1,0,0),Ke.UnitY=new Ke(0,1,0),Ke.UnitZ=new Ke(0,0,1),Ke.ForwardRH=new Ke(0,0,-1),Ke.ForwardLH=new Ke(0,0,1),Ke.Up=new Ke(0,1,0);class qe{static setResolution(t,e){qe.customResolution=!0,qe._resoluWidth=t,qe._resoluHeight=e}}qe.enableDynamicBatch=!0,qe.enableStaticBatch=!0,qe.enableUniformBufferObject=!0,qe.pixelRatio=1,qe.customResolution=!1,qe.defaultCacheRTMemory=256,qe.defaultPhysicsMemory=16,qe.enableMultiLight=!0,qe.maxLightCount=32,qe.lightClusterCount=new Ke(12,12,12),qe.useBVHCull=!1,qe.BVH_max_SpatialCount=7,qe.BVH_limit_size=32,qe.BVH_Min_Build_nums=10,qe._resoluWidth=-1,qe._resoluHeight=-1,qe.debugFrustumCulling=!1,e.isStencil=!0;class $e extends D{static get currentActive(){return $e._currentActive}static configRenderContextInstance(t){$e._configInstance=t}static createFromPool(t,e,i,r,s=!1,a=1,n=!1,h=!1){s=s&&0==(t&t-1)&&0==(e&e-1);let o=$e._pool.length;for(let l=0;l<o;l++){let _=$e._pool[l];if(_.width==t&&_.height==e&&_.colorFormat==i&&_.depthStencilFormat==r&&_._generateMipmap==s&&_.multiSamples==a&&_.generateDepthTexture==n&&_._gammaSpace==h){_._inPool=!1;let t=$e._pool[o-1];return $e._pool[l]=t,$e._pool.length-=1,$e._poolMemory-=_._renderTarget.gpuMemory/1024/1024,_}}let l=new $e(t,e,i,r,s,a,n,h);return l.lock=!0,l}static recoverToPool(t){t._inPool||t.destroyed||($e._pool.push(t),$e._poolMemory+=t._renderTarget.gpuMemory/1024/1024,t._inPool=!0)}static clearPool(){if(!($e._poolMemory<qe.defaultCacheRTMemory)){for(var t in $e._pool)$e._pool[t].destroy();$e._pool=[],$e._poolMemory=0}}static get bindCanvasRender(){return $e._bindCanvasRender}static set bindCanvasRender(t){t!=this._bindCanvasRender&&(this._bindCanvasRender=t)}get generateDepthTexture(){return this._generateDepthTexture}set generateDepthTexture(e){e&&!this._depthStencilTexture&&(this._depthStencilTexture=new D(this.width,this.height,this.depthStencilFormat),this._depthStencilTexture._dimension=t.TextureDimension.Tex2D,this._depthStencilTexture._texture=g.textureContext.createRenderTextureInternal(t.TextureDimension.Tex2D,this.width,this.height,this.depthStencilFormat,!1,!1),g.textureContext.setupRendertargetTextureAttachment(this._renderTarget,this._depthStencilTexture._texture)),this._generateDepthTexture=e}get depthStencilTexture(){return this._depthStencilTexture}get colorFormat(){return this._renderTarget.colorFormat}get depthStencilFormat(){return this._renderTarget.depthStencilFormat}get multiSamples(){return this._renderTarget._samples}get isCube(){return this._renderTarget._isCube}get samples(){return this._renderTarget._samples}get generateMipmap(){return this._renderTarget._generateMipmap}constructor(e,i,r,s,a=!1,n=1,h=!1,o=!1){super(e,i,r),this._inPool=!1,this._isCameraTarget=!1,this._generateDepthTexture=!1,this._gammaSpace=o,this._depthStencilFormat=null==s?t.RenderTargetFormat.None:s,this._generateMipmap=a,this._multiSamples=n,this._generateDepthTexture=h,this._createRenderTarget()}_createRenderTarget(){this._dimension=t.TextureDimension.Tex2D,this._renderTarget=g.textureContext.createRenderTargetInternal(this.width,this.height,this._format,this._depthStencilFormat,this._generateMipmap,this._gammaSpace,this._multiSamples),this._generateMipmap=this._renderTarget._generateMipmap,this._texture=this._renderTarget._textures[0],this.generateDepthTexture=this._generateDepthTexture}recreate(e,i,r,s,a=!1,n=1,h=!1,o=!1){this._width=e,this._height=i,this._format=r,this._gammaSpace=o,this._depthStencilFormat=null==s?t.RenderTargetFormat.None:s,this._generateMipmap=a,this._multiSamples=n,this._generateDepthTexture=h,this._disposeResource(),this._createRenderTarget()}_start(){$e._configInstance.invertY=this._isCameraTarget,$e._currentActive!=this&&($e._currentActive&&$e._currentActive._end(),$e._currentActive=this,g.textureContext.bindRenderTarget(this._renderTarget))}_end(){$e._currentActive=null,g.textureContext.unbindRenderTarget(this._renderTarget),this._isCameraTarget&&($e._configInstance.invertY=!1)}getData(t,e,i,r,s){return g.textureContext.readRenderTargetPixelData(this._renderTarget,t,e,i,r,s),s}_disposeResource(){var t;$e._currentActive==this&&this._end(),this._renderTarget.dispose(),this._renderTarget=null,null===(t=this._depthStencilTexture)||void 0===t||t.destroy(),this._depthStencilTexture=null}}$e._currentActive=null,$e._configInstance={},$e._pool=[],$e._poolMemory=0,function(t){t[t.SIZE=0]="SIZE",t[t.CLEAR=1]="CLEAR",t[t.SAVE=2]="SAVE",t[t.TRANSFORM=3]="TRANSFORM",t[t.ALPHA=4]="ALPHA",t[t.RESTORE=5]="RESTORE",t[t.FILL_STYLE=6]="FILL_STYLE",t[t.FILL_RECT=7]="FILL_RECT",t[t.STROKE_STYLE=8]="STROKE_STYLE",t[t.LINE_WIDTH=9]="LINE_WIDTH",t[t.STROKE_RECT=10]="STROKE_RECT",t[t.FILL_WORD_TEXT=11]="FILL_WORD_TEXT",t[t.DRAW_TEXTURE_SIZE_GRID=12]="DRAW_TEXTURE_SIZE_GRID",t[t.DRAW_TEXTURE=13]="DRAW_TEXTURE",t[t.CLIP_RECT=14]="CLIP_RECT",t[t.DRAW_LINE=15]="DRAW_LINE",t[t.DRAW_LINES=16]="DRAW_LINES",t[t.SCALE=17]="SCALE",t[t.TRANSLATE=18]="TRANSLATE",t[t.ROTATE=19]="ROTATE",t[t.DRAW_CIRCLE=20]="DRAW_CIRCLE",t[t.DRAW_PIE=21]="DRAW_PIE",t[t.DRAW_POLY=22]="DRAW_POLY",t[t.DRAW_CURVES=23]="DRAW_CURVES",t[t.BEGIN_PATH=24]="BEGIN_PATH",t[t.MOVE_TO=25]="MOVE_TO",t[t.LINE_TO=26]="LINE_TO",t[t.ARC_TO=27]="ARC_TO",t[t.CLOSE_PATH=28]="CLOSE_PATH",t[t.FILL=29]="FILL",t[t.STROKE=30]="STROKE",t[t.SET_AS_BITMAP=31]="SET_AS_BITMAP",t[t.DRAW_MASKED=32]="DRAW_MASKED",t[t.DRAW_TRANGLES=33]="DRAW_TRANGLES",t[t.SET_GLOBAL_COMPOSITE_OPERTAION=34]="SET_GLOBAL_COMPOSITE_OPERTAION",t[t.FILL_WORDS=35]="FILL_WORDS"}(me||(me={}));class Ze{static __init__(){}constructor(){this._byteLen=0,this.sprite=null,this._renderObject3DList=[],this._tmpMatrix=new p,this._nativeObj=new window._conchContext(g.renderEngine._nativeObj),this._byteLen=524288,this._tempRenderTexture2D=new Q(0,0,t.RenderTargetFormat.R8G8B8A8,t.RenderTargetFormat.None,!1),this._init(!1)}_init(t){this._buffer=new ArrayBuffer(this._byteLen),this._idata=new Int32Array(this._buffer),this._fdata=new Float32Array(this._buffer),this._byteArray=new Uint8Array(this._buffer);var e=window.webglPlus.createArrayBufferRef(this._buffer,Ze.ARRAY_BUFFER_TYPE_CMD,t,Ze.ARRAY_BUFFER_REF_REFERENCE);this._nativeObj.setSharedCommandBuffer(e),this._idata[0]=1}_need(t){if(!(this._byteLen-(this._idata[0]<<2)>=t)&&(this._nativeObj.flushCommand(),t>this._byteLen))throw"too big"}get lineJoin(){return""}set lineJoin(t){}get lineCap(){return""}set lineCap(t){}get miterLimit(){return""}set miterLimit(t){}clearRect(t,e,i,r){}set isMain(t){this._nativeObj.flushCommand(),this._nativeObj.isMain=t}get isMain(){return this._nativeObj.flushCommand(),this._nativeObj.isMain}set _targets(t){t&&(this._nativeObj.flushCommand(),this._nativeObj._target=t._nativeObj)}get _targets(){this._nativeObj.flushCommand();let t=this._nativeObj._target;return t?(this._tempRenderTexture2D.width=this._nativeObj.width,this._tempRenderTexture2D.height=this._nativeObj.height,this._tempRenderTexture2D._nativeObj=t,this._tempRenderTexture2D._renderTarget=t._renderTarget,this._tempRenderTexture2D._texture=t._renderTarget._textures[0],this._tempRenderTexture2D):null}alpha(t){this.globalAlpha*=t}flush(){Vt._curBindedBufferState&&Vt._curBindedBufferState.unBind(),this._nativeObj.flushCommand(),this._nativeObj.flush()}clear(){this.add_i(me.CLEAR),this._nativeObj.flushCommand(),this._renderObject3DList.length=0}destroy(t=!1){this._nativeObj.flushCommand(),this._tempRenderTexture2D._nativeObj&&(this._tempRenderTexture2D._nativeObj._deleteRT=t),this._nativeObj.destroy(t)}static set2DRenderConfig(){if(!Ze.const2DRenderCMD){const e=Ze.const2DRenderCMD=g.renderEngine.createRenderStateComand();e.addCMD(t.RenderStateType.BlendType,!0),e.addCMD(t.RenderStateType.BlendEquation,t.BlendEquationSeparate.ADD),it.activeBlendFunction=null,e.addCMD(t.RenderStateType.BlendFunc,[t.BlendFactor.One,t.BlendFactor.OneMinusSourceAlpha]),e.addCMD(t.RenderStateType.DepthTest,!1),e.addCMD(t.RenderStateType.DepthMask,!0),e.addCMD(t.RenderStateType.CullFace,!1),e.addCMD(t.RenderStateType.FrontFace,t.CullMode.Front)}Ze.const2DRenderCMD.applyCMD(),$e.currentActive&&$e.currentActive._end(),window.set2DRenderConfig(),Vt._curBindedBufferState&&Vt._curBindedBufferState.unBind()}set globalCompositeOperation(t){this.add_i_String(me.SET_GLOBAL_COMPOSITE_OPERTAION,t)}get globalCompositeOperation(){return this._nativeObj.flushCommand(),this._nativeObj.globalCompositeOperation}set fillStyle(t){var e=St.create(t);this.add_ii(me.FILL_STYLE,e.numColor)}get fillStyle(){return this._nativeObj.flushCommand(),this._nativeObj.fillStyle}set globalAlpha(t){this.add_if(me.ALPHA,t)}get globalAlpha(){return this._nativeObj.flushCommand(),this._nativeObj.globalAlpha}save(){this.add_i(me.SAVE)}restore(){this.add_i(me.RESTORE)}saveTransform(t){this.add_i(me.SAVE)}transformByMatrix(t,e,i){this.add_iffffff(me.TRANSFORM,t.a,t.b,t.c,t.d,t.tx+e,t.ty+i)}restoreTransform(t){this.add_i(me.RESTORE)}clipRect(t,e,i,r){this.add_iffff(me.CLIP_RECT,t,e,i,r)}transform(t,e,i,r,s,a){this.add_iffffff(me.TRANSFORM,t,e,i,r,s,a)}scale(t,e){this.add_iff(me.SCALE,t,e)}drawTexture(t,e,i,r,s){this.checkTexture(t)&&this.add_iiffffffffffff(me.DRAW_TEXTURE,t.bitmap._texture.id,e,i,r,s,t.uv[0],t.uv[1],t.uv[2],t.uv[3],t.uv[4],t.uv[5],t.uv[6],t.uv[7])}drawTextureWithTransform(t,e,i,r,s,a,n,h,o,l,_=null,u){if(this.checkTexture(t)){this.save(),this.alpha(o);var d=u||t.uv;a?(this.add_iffffff(me.TRANSFORM,a.a,a.b,a.c,a.d,a.tx+n,a.ty+h),this.add_iiffffffffffff(me.DRAW_TEXTURE,t.bitmap._texture.id,e,i,r||t.width,s||t.height,d[0],d[1],d[2],d[3],d[4],d[5],d[6],d[7])):this.add_iiffffffffffff(me.DRAW_TEXTURE,t.bitmap._texture.id,e+n,i+h,r||t.width,s||t.height,d[0],d[1],d[2],d[3],d[4],d[5],d[6],d[7]),this.restore()}}drawTextureWithSizeGrid(t,e,i,r,s,a,n,h){if(this.checkTexture(t)){var o=t.uv;t.bitmap.width,t.bitmap.height;var l=a[0],_=a[3],u=a[1],d=a[2],c=a[4];this.add_iiffffffffiffffffffff(me.DRAW_TEXTURE_SIZE_GRID,t.bitmap._texture.id,e,i,r,s,l,u,d,_,c?1:0,n,h,o[0],o[1],o[2],o[3],o[4],o[5],o[6],o[7])}}_drawTextureM(t,e,i,r,s,a,n,h){if(this.checkTexture(t)){this.save(),this.alpha(n),a&&this.add_iffffff(me.TRANSFORM,a.a,a.b,a.c,a.d,a.tx,a.ty);var o=h||t.uv;this.add_iiffffffffffff(me.DRAW_TEXTURE,t.bitmap._texture.id,e,i,r||t.width,s||t.height,o[0],o[1],o[2],o[3],o[4],o[5],o[6],o[7]),this.restore()}}translate(t,e){this.add_iff(me.TRANSLATE,t,e)}_transform(t,e,i){this.add_iff(me.TRANSLATE,e,i),this.add_iffffff(me.TRANSFORM,t.a,t.b,t.c,t.d,t.tx,t.ty),this.add_iff(me.TRANSLATE,-e,-i)}_rotate(t,e,i){this.add_iff(me.TRANSLATE,e,i),this.add_if(me.ROTATE,t),this.add_iff(me.TRANSLATE,-e,-i)}_scale(t,e,i,r){this.add_iff(me.TRANSLATE,i,r),this.add_iff(me.SCALE,t,e),this.add_iff(me.TRANSLATE,-i,-r)}_drawLine(t,e,i,r,s,a,n,h,o){var l=St.create(n);this.add_iffffffif(me.DRAW_LINE,t,e,i,r,s,a,l.numColor,h)}_drawLines(t,e,i,r,s,a){var n=St.create(r);this.add_iffif_ab(me.DRAW_LINES,t,e,n.numColor,s,new Float32Array(i))}_drawCircle(t,e,i,r,s,a,n){var h=St.create(r),o=St.create(s);this.add_ifffiiiif(me.DRAW_CIRCLE,t,e,i,r?1:0,h.numColor,s?1:0,o.numColor,a)}_drawPie(t,e,i,r,s,a,n,h,o){var l=St.create(a),_=St.create(n);this.add_ifffffiiiif(me.DRAW_PIE,t,e,i,r,s,a?1:0,l.numColor,n?1:0,_.numColor,h)}_drawPoly(t,e,i,r,s,a,n,h){var o=St.create(r),l=St.create(s);this.add_iffiiiifi_ab(me.DRAW_POLY,t,e,r?1:0,o.numColor,s?1:0,l.numColor,a,n?1:0,new Float32Array(i))}fillRect(t,e,i,r,s){if(null!=s){var a=St.create(s);this.add_ii(me.FILL_STYLE,a.numColor)}this.add_i(me.SAVE),this.add_iffff(me.FILL_RECT,t,e,i,r),this.add_i(me.RESTORE)}drawRect(t,e,i,r,s,a,n){if(null!=s){var h=St.create(s);this.add_i(me.SAVE),this.add_ii(me.FILL_STYLE,h.numColor),this.add_iffff(me.FILL_RECT,t,e,i,r),this.add_i(me.RESTORE)}if(null!=a){var o=St.create(a);this.add_i(me.SAVE),this.add_ii(me.STROKE_STYLE,o.numColor),this.add_if(me.LINE_WIDTH,n),this.add_iffff(me.STROKE_RECT,t,e,i,r),this.add_i(me.RESTORE)}}_drawPath(t,e,i,r,s){this.add_ii(me.BEGIN_PATH,0);for(var a=0,n=i.length;a<n;a++){var h=i[a];switch(h[0]){case"moveTo":this.add_iff(me.MOVE_TO,t+h[1],e+h[2]);break;case"lineTo":this.add_iff(me.LINE_TO,t+h[1],e+h[2]);break;case"arcTo":this.add_ifffff(me.ARC_TO,t+h[1],e+h[2],t+h[3],e+h[4],h[5]);break;case"closePath":this.add_i(me.CLOSE_PATH)}}if(null!=r){var o=St.create(r.fillStyle);this.add_ii(me.FILL_STYLE,o.numColor),this.add_i(me.FILL)}if(null!=s){var l=St.create(s.strokeStyle);this.add_ii(me.STROKE_STYLE,l.numColor),this.add_if(me.LINE_WIDTH,s.lineWidth||1),this.add_i(me.STROKE)}}drawCurves(t,e,i,r,s){var a=St.create(r);this.add_iffif_ab(me.DRAW_CURVES,t,e,a.numColor,s,new Float32Array(i))}drawCanvas(t,e,i,r,s){t&&(this._nativeObj.flushCommand(),t instanceof te?this._nativeObj.drawCanvasNormal(t._nativeObj,e,i,r,s):this._nativeObj.drawCanvasBitmap(t.context._nativeObj,e,i,r,s))}fillText(t,e,r,s,a,n,h=0,o=""){var l=0;switch(n){case"center":l=i.ENUM_TEXTALIGN_CENTER;break;case"right":l=i.ENUM_TEXTALIGN_RIGHT}var _=St.create(a),u=St.create(o);"string"==typeof t?this.add_iiiifff_String_String(me.FILL_WORDS,_.numColor,u.numColor,l,e,r,h,t,s):this.add_iiffiifi_String(me.FILL_WORD_TEXT,t._nativeObj.id,e,r,_.numColor,u.numColor,h,l,s)}drawText(t,e,r,s,a,n){var h=0;switch(n){case"center":h=i.ENUM_TEXTALIGN_CENTER;break;case"right":h=i.ENUM_TEXTALIGN_RIGHT}var o=St.create(a),l=St.create(null);"string"==typeof t?this.add_iiiifff_String_String(me.FILL_WORDS,o.numColor,l.numColor,h,e,r,0,t,s):this.add_iiffiifi_String(me.FILL_WORD_TEXT,t._nativeObj.id,e,r,o.numColor,l.numColor,0,h,s)}fillWords(t,e,i,r,s){for(var a=St.create(s),n=St.create(null),h=t.length,o=0;o<h;o++)this.add_iiiifff_String_String(me.FILL_WORDS,a.numColor,n.numColor,0,t[o].x+e,t[o].y+i,0,t[o].char,r)}strokeWord(t,e,r,s,a,n,h){var o=0;switch(h){case"center":o=i.ENUM_TEXTALIGN_CENTER;break;case"right":o=i.ENUM_TEXTALIGN_RIGHT}var l=St.create(a),_=St.create(null);"string"==typeof t?this.add_iiiifff_String_String(me.FILL_WORDS,l.numColor,_.numColor,o,e,r,n,t,s):this.add_iiffiifi_String(me.FILL_WORD_TEXT,t._nativeObj.id,e,r,l.numColor,_.numColor,n,o,s)}fillBorderText(t,e,r,s,a,n,h,o){var l=0;switch(o){case"center":l=i.ENUM_TEXTALIGN_CENTER;break;case"right":l=i.ENUM_TEXTALIGN_RIGHT}var _=St.create(a),u=St.create(n);"string"==typeof t?this.add_iiiifff_String_String(me.FILL_WORDS,_.numColor,u.numColor,l,e,r,h,t,s):this.add_iiffiifi_String(me.FILL_WORD_TEXT,t._nativeObj.id,e,r,_.numColor,u.numColor,h,l,s)}fillBorderWords(t,e,i,r,s,a,n){for(var h=St.create(s),o=St.create(a),l=t.length,_=0;_<l;_++)this.add_iiiifff_String_String(me.FILL_WORDS,h.numColor,o.numColor,0,t[_].x+e,t[_].y+i,n,t[_].char,r)}fillWords11(t,e,i,r,s,a,n){for(var h=St.create(s),o=St.create(a),l="string"==typeof r?r:r._font,_=t.length,u=0;u<_;u++)this.add_iiiifff_String_String(me.FILL_WORDS,h.numColor,o.numColor,0,t[u].x+e,t[u].y+i,n,t[u].char,l)}filltext11(t,e,r,s,a,n,h,o){var l=0;switch(o){case"center":l=i.ENUM_TEXTALIGN_CENTER;break;case"right":l=i.ENUM_TEXTALIGN_RIGHT}var _=St.create(a),u=St.create(n);"string"==typeof t?this.add_iiiifff_String_String(me.FILL_WORDS,_.numColor,u.numColor,l,e,r,h,t,s):this.add_iiffiifi_String(me.FILL_WORD_TEXT,t._nativeObj.id,e,r,_.numColor,u.numColor,h,l,s)}_fast_filltext(t,e,i,r,s,a,n,h,o=0){var l=St.create(s),_=St.create(a);"string"==typeof t?this.add_iiiifff_String_String(me.FILL_WORDS,l.numColor,_.numColor,h,e,i,n,t,r._font):this.add_iiffiifi_String(me.FILL_WORD_TEXT,t._nativeObj.id,e,i,l.numColor,_.numColor,n,h,r._font)}drawTriangles(t,e,i,r,s,a,n,h,o,l,_=4294967295){if(this.checkTexture(t)){var u=n||this._tmpMatrix;null!=l||null!=o?(this.add_i(me.SAVE),this.add_i_String(me.SET_GLOBAL_COMPOSITE_OPERTAION,l),this.add_iiifffffffff_ab_ab_ab(me.DRAW_TRANGLES,t.bitmap._texture.id,_,e,i,h,u.a,u.b,u.c,u.d,u.tx,u.ty,r instanceof Array?Float32Array.from(r):r,s instanceof Array?Float32Array.from(s):s,a instanceof Array?Uint16Array.from(a):a),this.add_i(me.RESTORE)):this.add_iiifffffffff_ab_ab_ab(me.DRAW_TRANGLES,t.bitmap._texture.id,_,e,i,h,u.a,u.b,u.c,u.d,u.tx,u.ty,r instanceof Array?Float32Array.from(r):r,s instanceof Array?Float32Array.from(s):s,a instanceof Array?Uint16Array.from(a):a)}}drawMask(t,e){return this._nativeObj.flushCommand(),this._nativeObj.drawMask(t,e)}drawMasked(t,e,i,r){this.add_iffff(me.DRAW_MASKED,t,e,i,r)}drawMaskComposite(t,e,i,r,s){this._nativeObj.flushCommand(),this._nativeObj.drawMaskComposite(t,e,i,r,s)}set asBitmap(t){this.add_ii(me.SET_AS_BITMAP,t?1:0)}size(t,e){this.add_iii(me.SIZE,t,e)}setColorFilter(t){this._nativeObj.flushCommand(),t?this._nativeObj.setColorFilter(!0,t._alpha,t._mat):this._nativeObj.setColorFilter(!1,null,null)}drawTarget(t,e,i,r,s,a,n,h=null,o=-1){return this._nativeObj.flushCommand(),this._nativeObj.drawTarget(t,e,i,r,s,a.a,a.b,a.c,a.d,a.tx,a.ty,o)}drawTargetBlurFilter(t,e,i,r,s,a){this._nativeObj.flushCommand(),this._nativeObj.drawTargetBlurFilter(t,e,i,r,s,a)}get _curMat(){this._nativeObj.flushCommand();var t=this._nativeObj._curMat,e=p.create();return e.a=t[0],e.b=t[1],e.c=t[2],e.d=t[3],e.tx=t[4],e.ty=t[5],e}addRenderObject3D(t){this._renderObject3DList.push(t),this._nativeObj.flushCommand(),this._nativeObj.addRenderObject3D(t._nativeObj)}pushRT(){this._nativeObj.flushCommand(),this._nativeObj.pushRT()}popRT(){this._nativeObj.flushCommand(),this._nativeObj.popRT()}useRT(t){this._nativeObj.flushCommand(),this._nativeObj.useRT(t)}drawFilter(t,e,i,r,s,a){this._nativeObj.flushCommand(),this._nativeObj.drawFilter(t,e,i,r,s,a)}checkTexture(t){var e=this.sprite;return!!t._getSource((function(){e&&e.repaint()}))}add_i(t){this._need(4),this._idata[this._idata[0]++]=t}add_ii(t,e){this._need(8);var i=this._idata[0];this._idata[i++]=t,this._idata[i++]=e,this._idata[0]=i}add_if(t,e){this._need(8);var i=this._idata[0];this._idata[i++]=t,this._fdata[i++]=e,this._idata[0]=i}add_iff(t,e,i){this._need(12);var r=this._idata[0];this._idata[r++]=t,this._fdata[r++]=e,this._fdata[r++]=i,this._idata[0]=r}add_iffif(t,e,i,r,s){this._need(20);var a=this._idata[0],n=this._fdata;this._idata[a++]=t,n[a++]=e,n[a++]=i,this._idata[a++]=r,n[a++]=s,this._idata[0]=a}add_iffff(t,e,i,r,s){this._need(20);var a=this._idata[0],n=this._fdata;this._idata[a++]=t,n[a++]=e,n[a++]=i,n[a++]=r,n[a++]=s,this._idata[0]=a}add_iii(t,e,i){this._need(12);var r=this._idata,s=this._idata[0];r[s++]=t,r[s++]=e,r[s++]=i,this._idata[0]=s}add_iiffff(t,e,i,r,s,a){this._need(24);var n=this._idata[0],h=this._fdata;this._idata[n++]=t,this._idata[n++]=e,h[n++]=i,h[n++]=r,h[n++]=s,h[n++]=a,this._idata[0]=n}add_ifffff(t,e,i,r,s,a){this._need(24);var n=this._idata[0],h=this._fdata;this._idata[n++]=t,h[n++]=e,h[n++]=i,h[n++]=r,h[n++]=s,h[n++]=a,this._idata[0]=n}add_iffffff(t,e,i,r,s,a,n){this._need(28);var h=this._idata[0],o=this._fdata;this._idata[h++]=t,o[h++]=e,o[h++]=i,o[h++]=r,o[h++]=s,o[h++]=a,o[h++]=n,this._idata[0]=h}add_ifffiiiif(t,e,i,r,s,a,n,h,o){this._need(36);var l=this._idata,_=l[0],u=this._fdata;l[_++]=t,u[_++]=e,u[_++]=i,u[_++]=r,l[_++]=s,l[_++]=a,l[_++]=n,l[_++]=h,u[_++]=o,l[0]=_}add_ifffffiiiif(t,e,i,r,s,a,n,h,o,l,_){this._need(44);var u=this._idata,d=u[0],c=this._fdata;u[d++]=t,c[d++]=e,c[d++]=i,c[d++]=r,c[d++]=s,c[d++]=a,u[d++]=n,u[d++]=h,u[d++]=o,u[d++]=l,c[d++]=_,u[0]=d}add_iffffffif(t,e,i,r,s,a,n,h,o){this._need(36);var l=this._idata,_=l[0],u=this._fdata;l[_++]=t,u[_++]=e,u[_++]=i,u[_++]=r,u[_++]=s,u[_++]=a,u[_++]=n,l[_++]=h,u[_++]=o,l[0]=_}add_String(t){var e=t.byteLength;if(this._need(e+4),this._idata[this._idata[0]++]=e,0!=e){var i=new Uint8Array(t);this._byteArray.set(i,4*this._idata[0]),this._idata[0]+=e/4}}add_iffiiiifi(t,e,i,r,s,a,n,h,o){this._need(45);var l=this._idata[0],_=this._fdata;this._idata[l++]=t,_[l++]=e,_[l++]=i,this._idata[l++]=r,this._idata[l++]=s,this._idata[l++]=a,this._idata[l++]=n,_[l++]=h,this._idata[l++]=o,this._idata[0]=l}add_iiffiifi(t,e,i,r,s,a,n,h){this._need(32);var o=this._idata[0],l=this._fdata;this._idata[o++]=t,this._idata[o++]=e,l[o++]=i,l[o++]=r,this._idata[o++]=s,this._idata[o++]=a,l[o++]=n,this._idata[o++]=h,this._idata[0]=o}add_i_String(t,e){var i=window.conch.strTobufer(e);this._need(4+i.byteLength+4),this.add_i(t),this.add_String(i)}add_iiiifff(t,e,i,r,s,a,n){this._need(28);var h=this._idata[0],o=this._fdata;this._idata[h++]=t,this._idata[h++]=e,this._idata[h++]=i,this._idata[h++]=r,o[h++]=s,o[h++]=a,o[h++]=n,this._idata[0]=h}add_iiffiifi_String(t,e,i,r,s,a,n,h,o){var l=window.conch.strTobufer(o);this._need(32+l.byteLength+4),this.add_iiffiifi(t,e,i,r,s,a,n,h),this.add_String(l)}add_iiiifff_String_String(t,e,i,r,s,a,n,h,o){var l=window.conch.strTobufer(h),_=window.conch.strTobufer(o);this._need(28+(l.byteLength+4)+(_.byteLength+4)),this.add_iiiifff(t,e,i,r,s,a,n),this.add_String(l),this.add_String(_)}add_iiffffffffffff(t,e,i,r,s,a,n,h,o,l,_,u,d,c){this._need(56);var p=this._idata,f=p[0],m=this._fdata;p[f++]=t,p[f++]=e,m[f++]=i,m[f++]=r,m[f++]=s,m[f++]=a,m[f++]=n,m[f++]=h,m[f++]=o,m[f++]=l,m[f++]=_,m[f++]=u,m[f++]=d,m[f++]=c,p[0]=f}add_iiffffffffiffffffffff(t,e,i,r,s,a,n,h,o,l,_,u,d,c,p,f,m,g,T,x,E){this._need(84);var y=this._idata,v=this._fdata,S=y[0];y[S++]=t,y[S++]=e,v[S++]=i,v[S++]=r,v[S++]=s,v[S++]=a,v[S++]=n,v[S++]=h,v[S++]=o,v[S++]=l,y[S++]=_,v[S++]=u,v[S++]=d,v[S++]=c,v[S++]=p,v[S++]=f,v[S++]=m,v[S++]=g,v[S++]=T,v[S++]=x,v[S++]=E,y[0]=S}add_iiifffffffff(t,e,i,r,s,a,n,h,o,l,_,u){this._need(48);var d=this._idata,c=this._fdata,p=d[0];d[p++]=t,d[p++]=e,d[p++]=i,c[p++]=r,c[p++]=s,c[p++]=a,c[p++]=n,c[p++]=h,c[p++]=o,c[p++]=l,c[p++]=_,c[p++]=u,d[0]=p}add_iiifffffffff_ab_ab_ab(t,e,i,r,s,a,n,h,o,l,_,u,d,c,p){var f=this.getAlignLength(d),m=this.getAlignLength(c),g=this.getAlignLength(p);this._need(48+(f+4)+(m+4)+(g+4)),this.add_iiifffffffff(t,e,i,r,s,a,n,h,o,l,_,u),this.wab(d,d.byteLength,f,0),this.wab(c,c.byteLength,m,0),this.wab(p,p.byteLength,g,0)}wab(t,e,i,r){r=r||0,this._need(i+4),this._idata[this._idata[0]++]=e;var s=null;if(t instanceof Float32Array&&0==r)this._fdata.set(t,this._idata[0]);else{if(t instanceof ArrayBuffer)s=new Uint8Array(t,r,e);else{if(!t.buffer)return void console.log("not arraybuffer/dataview");s=new Uint8Array(t.buffer,r+t.byteOffset,e)}this._byteArray.set(s,4*this._idata[0])}this._idata[0]+=i/4}getAlignLength(t){return t.byteLength+3&4294967292}add_iif_ab(t,e,i,r){var s=this.getAlignLength(r);this._need(12+s+4),this.add_iff(t,e,i),this.wab(r,r.byteLength,s,0)}add_iffif_ab(t,e,i,r,s,a){var n=this.getAlignLength(a);this._need(20+n+4),this.add_iffif(t,e,i,r,s),this.wab(a,a.byteLength,n,0)}add_iffiiiifi_ab(t,e,i,r,s,a,n,h,o,l){var _=this.getAlignLength(l);this._need(45+_+4),this.add_iffiiiifi(t,e,i,r,s,a,n,h,o),this.wab(l,l.byteLength,_,0)}}Ze.ARRAY_BUFFER_TYPE_DATA=0,Ze.ARRAY_BUFFER_TYPE_CMD=1,Ze.ARRAY_BUFFER_REF_REFERENCE=0,Ze.ARRAY_BUFFER_REF_COPY=1,Ze.ENUM_TEXTALIGN_DEFAULT=0,Ze.ENUM_TEXTALIGN_CENTER=1,Ze.ENUM_TEXTALIGN_RIGHT=2;const Qe=new p(i.MAX_CLIP_SIZE,0,0,i.MAX_CLIP_SIZE,0,0);class Je{static __init__(){Je.MAXCLIPRECT=new m(0,0,i.MAX_CLIP_SIZE,i.MAX_CLIP_SIZE),ti.DEFAULT=new ti}drawImage(...t){}getImageData(...t){}measureText(t){return null}setTransform(...t){}$transform(t,e,i,r,s,a){}get lineJoin(){return""}set lineJoin(t){}get lineCap(){return""}set lineCap(t){}get miterLimit(){return""}set miterLimit(t){}clearRect(t,e,i,r){}_drawRect(t,e,i,r,s){s&&(this.fillStyle=s),this.fillRect(t,e,i,r,null)}drawTexture2(t,e,i,r,s,a){}transformByMatrix(t,e,i){this.transform(t.a,t.b,t.c,t.d,t.tx+e,t.ty+i)}saveTransform(t){this.save()}restoreTransform(t){this.restore()}drawRect(t,e,i,r,s,a,n){var h=this;null!=s&&(h.fillStyle=s,h.fillRect(t,e,i,r)),null!=a&&(h.strokeStyle=a,h.lineWidth=n,h.strokeRect(t,e,i,r))}alpha(t){this.globalAlpha*=t}_transform(t,e,i){this.translate(e,i),this.transform(t.a,t.b,t.c,t.d,t.tx,t.ty),this.translate(-e,-i)}_rotate(t,e,i){this.translate(e,i),this.rotate(t),this.translate(-e,-i)}_scale(t,e,i,r){this.translate(i,r),this.scale(t,e),this.translate(-i,-r)}_drawLine(t,e,i,r,s,a,n,h,o){this.beginPath(),this.strokeStyle=n,this.lineWidth=h,this.moveTo(t+i,e+r),this.lineTo(t+s,e+a),this.stroke()}_drawLines(t,e,i,r,s,a){this.beginPath(),this.strokeStyle=r,this.lineWidth=s,this.addPath(i.slice(),!1,!1,t,e),this.stroke()}drawCurves(t,e,i,r,s){this.beginPath(),this.strokeStyle=r,this.lineWidth=s,this.moveTo(t+i[0],e+i[1]);for(var a=2,n=i.length;a<n;)this.quadraticCurveTo(t+i[a++],e+i[a++],t+i[a++],e+i[a++]);this.stroke()}_fillAndStroke(t,e,i,r=!1){null!=t&&(this.fillStyle=t,this.fill()),null!=e&&i>0&&(this.strokeStyle=e,this.lineWidth=i,this.stroke())}_drawCircle(t,e,i,r,s,a,n){this.beginPath(!0),this.arc(t,e,i,0,Je.PI2),this.closePath(),this._fillAndStroke(r,s,a)}_drawPie(t,e,i,r,s,a,n,h,o){this.beginPath(),this.moveTo(t,e),this.arc(t,e,i,r,s),this.closePath(),this._fillAndStroke(a,n,h)}_drawPoly(t,e,i,r,s,a,n,h){this.beginPath(),this.addPath(i.slice(),!0,n,t,e),this.closePath(),this._fillAndStroke(r,s,a,n)}_drawPath(t,e,i,r,s){this.beginPath();for(var a=0,n=i.length;a<n;a++){var h=i[a];switch(h[0]){case"moveTo":this.moveTo(t+h[1],e+h[2]);break;case"lineTo":this.lineTo(t+h[1],e+h[2]);break;case"arcTo":this.arcTo(t+h[1],e+h[2],t+h[3],e+h[4],h[5]);break;case"closePath":this.closePath()}}null!=r&&(this.fillStyle=r.fillStyle,this.fill()),null!=s&&(this.strokeStyle=s.strokeStyle,this.lineWidth=s.lineWidth||1,this.lineJoin=s.lineJoin,this.lineCap=s.lineCap,this.miterLimit=s.miterLimit,this.stroke())}static set2DRenderConfig(){if(!Je.const2DRenderCMD){const e=Je.const2DRenderCMD=g.renderEngine.createRenderStateComand();e.addCMD(t.RenderStateType.BlendType,!0),e.addCMD(t.RenderStateType.BlendEquation,t.BlendEquationSeparate.ADD),it.activeBlendFunction=null,e.addCMD(t.RenderStateType.BlendFunc,[t.BlendFactor.One,t.BlendFactor.OneMinusSourceAlpha]),e.addCMD(t.RenderStateType.DepthTest,!1),e.addCMD(t.RenderStateType.DepthMask,!0),e.addCMD(t.RenderStateType.CullFace,!1),e.addCMD(t.RenderStateType.FrontFace,t.CullMode.Front)}Je.const2DRenderCMD.applyCMD(),$e.currentActive&&$e.currentActive._end(),J.currentActive&&J.currentActive.end(),g.renderEngine.viewport(0,0,Y.width,Y.height),g.renderEngine.scissorTest(!0),g.renderEngine.scissor(0,0,Y.width,Y.height)}constructor(){if(this._tmpMatrix=new p,this._drawTexToDrawTri_Vert=new Float32Array(8),this._drawTexToDrawTri_Index=new Uint16Array([0,1,2,0,2,3]),this._tempUV=new Float32Array(8),this._drawTriUseAbsMatrix=!1,this._id=++Je._COUNT,this._other=null,this._renderNextSubmitIndex=0,this._path=null,this._drawCount=1,this._width=i.MAX_CLIP_SIZE,this._height=i.MAX_CLIP_SIZE,this._renderCount=0,this._submits=null,this._curSubmit=null,this._submitKey=new xt,this._pathMesh=null,this._triangleMesh=null,this.meshlist=[],this._transedPoints=new Array(8),this._temp4Points=new Array(8),this._clipRect=Je.MAXCLIPRECT,this._globalClipMatrix=Qe.clone(),this._clipInCache=!1,this._clipInfoID=0,this._clipID_Gen=0,this._lastMatScaleX=1,this._lastMatScaleY=1,this._lastMat_a=1,this._lastMat_b=0,this._lastMat_c=0,this._lastMat_d=1,this._nBlendType=0,this._save=null,this._targets=null,this._charSubmitCache=null,this._saveMark=null,this._shader2D=new Se,this.sprite=null,this._italicDeg=0,this._lastTex=null,this._fillColor=0,this._flushCnt=0,this.defTexture=null,this._colorFiler=null,this.drawTexAlign=!1,this._incache=!1,this.isMain=!1,this.clearColor=new Z,Je._contextcount++,Je._textRender=Je._textRender||new He,!this.defTexture){var e=new X(2,2,t.TextureFormat.R8G8B8A8,!0,!1,!1);e.setPixelsData(new Uint8Array(16),!1,!1),e.lock=!0,this.defTexture=new ht(e)}this._lastTex=this.defTexture,this.clear()}clearBG(e,i,r,s){this.clearColor.r=e,this.clearColor.g=i,this.clearColor.b=r,this.clearColor.a=s,g.renderEngine.clearRenderTexture(t.RenderClearFlag.Color,this.clearColor,1)}_getSubmits(){return this._submits}_releaseMem(t=!1){if(this._submits){this._curMat&&this._curMat.destroy(),this._curMat=null,this._shader2D.destroy(),this._shader2D=null,this._charSubmitCache.clear();for(var e=0,i=this._submits._length;e<i;e++)this._submits[e].releaseRender();var r;for(this._submits.length=0,this._submits._length=0,this._submits=null,this._curSubmit=null,this._path=null,this._save=null,e=0,r=this.meshlist.length;e<r;e++){this.meshlist[e].destroy()}this.meshlist.length=0,this.sprite=null,t||(this._targets&&this._targets.destroy(),this._targets=null)}}destroy(t=!1){--Je._contextcount,this.sprite=null,this._releaseMem(t),this._charSubmitCache&&this._charSubmitCache.destroy(),this._mesh.destroy(),t||(this._targets&&this._targets.destroy(),this._targets=null),this.defTexture&&(this.defTexture.bitmap&&this.defTexture.bitmap.destroy(),this.defTexture.destroy())}clear(){this._submits||(this._other=ti.DEFAULT,this._curMat=p.create(),this._charSubmitCache=new Pe,this._mesh=Zt.getAMesh(this.isMain),this.meshlist.push(this._mesh),this._pathMesh=Jt.getAMesh(this.isMain),this.meshlist.push(this._pathMesh),this._triangleMesh=Qt.getAMesh(this.isMain),this.meshlist.push(this._triangleMesh),this._submits=[],this._save=[ue.Create(this)],this._save.length=10,this._shader2D=new Se),this._submitKey.clear(),this._mesh.clearVB(),this._drawCount=1,this._other=ti.DEFAULT,this._other.lineWidth=this._shader2D.ALPHA=1,this._nBlendType=0,this._clipRect=Je.MAXCLIPRECT,this._curSubmit=Ut.RENDERBASE,Ut.RENDERBASE._ref=16777215,Ut.RENDERBASE._numEle=0,this._shader2D.fillStyle=this._shader2D.strokeStyle=ne.DEFAULT;for(let t=0,e=this._submits._length;t<e;t++)this._submits[t].releaseRender();this._submits._length=0,this._curMat.identity(),this._other.clear(),this._saveMark=this._save[0],this._save._length=1}size(e,i){this._width==e&&this._height==i||(this._width=e,this._height=i,this._targets&&(this._targets.destroy(),this._targets=new J(e,i,t.RenderTargetFormat.R8G8B8A8,-1)),this.isMain&&(g.renderEngine.viewport(0,0,e,i),Y.width=e,Y.height=i)),0===e&&0===i&&this._releaseMem()}set asBitmap(e){if(e){let e=this._targets;if(!this._width||!this._height)throw Error("asBitmap no size!");e&&e.width==this._width&&e.height==this._height||(e&&e.destroy(),this._targets=new J(this._width,this._height,t.RenderTargetFormat.R8G8B8A8))}else this._targets&&this._targets.destroy(),this._targets=null}getMatScaleX(){return this._lastMat_a==this._curMat.a&&this._lastMat_b==this._curMat.b||(this._lastMatScaleX=this._curMat.getScaleX(),this._lastMat_a=this._curMat.a,this._lastMat_b=this._curMat.b),this._lastMatScaleX}getMatScaleY(){return this._lastMat_c==this._curMat.c&&this._lastMat_d==this._curMat.d||(this._lastMatScaleY=this._curMat.getScaleY(),this._lastMat_c=this._curMat.c,this._lastMat_d=this._curMat.d),this._lastMatScaleY}setFillColor(t){this._fillColor=t}getFillColor(){return this._fillColor}set fillStyle(t){this._shader2D.fillStyle.equal(t)||(le.save(this,le.TYPE_FILESTYLE,this._shader2D,!1),this._shader2D.fillStyle=ne.create(t),this._submitKey.other=-this._shader2D.fillStyle.toInt())}get fillStyle(){return this._shader2D.fillStyle}set globalAlpha(t){(t=Math.floor(1e3*t)/1e3)!=this._shader2D.ALPHA&&(le.save(this,le.TYPE_ALPHA,this._shader2D,!1),this._shader2D.ALPHA=t)}get globalAlpha(){return this._shader2D.ALPHA}set textAlign(t){this._other.textAlign===t||(this._other=this._other.make(),le.save(this,le.TYPE_TEXTALIGN,this._other,!1),this._other.textAlign=t)}get textAlign(){return this._other.textAlign}set textBaseline(t){this._other.textBaseline===t||(this._other=this._other.make(),le.save(this,le.TYPE_TEXTBASELINE,this._other,!1),this._other.textBaseline=t)}get textBaseline(){return this._other.textBaseline}set globalCompositeOperation(t){var e=it.TOINT[t];null==e||this._nBlendType===e||(le.save(this,le.TYPE_GLOBALCOMPOSITEOPERATION,this,!0),this._curSubmit=Ut.RENDERBASE,this._nBlendType=e)}get globalCompositeOperation(){return it.NAMES[this._nBlendType]}set strokeStyle(t){this._shader2D.strokeStyle.equal(t)||(le.save(this,le.TYPE_STROKESTYLE,this._shader2D,!1),this._shader2D.strokeStyle=ne.create(t),this._submitKey.other=-this._shader2D.strokeStyle.toInt())}get strokeStyle(){return this._shader2D.strokeStyle}translate(t,e){0===t&&0===e||(ce.save(this),this._curMat._bTransform?(de.save(this),this._curMat.tx+=t*this._curMat.a+e*this._curMat.c,this._curMat.ty+=t*this._curMat.b+e*this._curMat.d):(this._curMat.tx=t,this._curMat.ty=e))}set lineWidth(t){this._other.lineWidth===t||(this._other=this._other.make(),le.save(this,le.TYPE_LINEWIDTH,this._other,!1),this._other.lineWidth=t)}get lineWidth(){return this._other.lineWidth}save(){this._save[this._save._length++]=ue.Create(this)}restore(){var t=this._save._length,e=this._nBlendType;if(!(t<1)){for(var i=t-1;i>=0;i--){var r=this._save[i];if(r.restore(this),r.isSaveMark())return void(this._save._length=i)}e!=this._nBlendType&&(this._curSubmit=Ut.RENDERBASE)}}set font(t){this._other=this._other.make(),le.save(this,le.TYPE_FONT,this._other,!1)}fillText(t,e,i,r,s,a,n=0,h=""){Je._textRender.filltext(this,t,e,i,r,s,h,n,a)}drawText(t,e,i,r,s,a){Je._textRender.filltext(this,t,e,i,r,s,null,0,a)}fillWords(t,e,i,r,s){Je._textRender.fillWords(this,t,e,i,r,s,null,0)}strokeWord(t,e,i,r,s,a,n){Je._textRender.filltext(this,t,e,i,r,null,s,a,n)}fillBorderText(t,e,i,r,s,a,n,h){Je._textRender.filltext(this,t,e,i,r,s,a,n,h)}fillBorderWords(t,e,i,r,s,a,n){Je._textRender.fillWords(this,t,e,i,r,s,a,n)}_fast_filltext(t,e,i,r,s,a,n,h,o=0){Je._textRender._fast_filltext(this,t,null,e,i,r,s,a,n,h,o)}fillWords11(t,e,i,r,s,a,n){Je._textRender.fillWords(this,t,e,i,r,s,a,n)}filltext11(t,e,i,r,s,a,n,h){Je._textRender.filltext(this,t,e,i,r,s,a,n,h)}_fillRect(t,e,i,r,s){var a=this._curSubmit,n=a&&a._key.submitType===Ut.KEY_DRAWTEXTURE&&a._key.blendShader===this._nBlendType;this._mesh.vertNum+4>Je._MAXVERTNUM&&(this._mesh=Zt.getAMesh(this.isMain),this.meshlist.push(this._mesh),n=!1),n&&(n=n&&this.isSameClipInfo(a)),this.transformQuad(t,e,i,r,0,this._curMat,this._transedPoints),this.clipedOff(this._transedPoints)||(this._mesh.addQuad(this._transedPoints,ht.NO_UV,s,!1),n||(a=this._curSubmit=Ie.create(this,this._mesh,Tt.create(st.TEXTURE2D,0)),this._submits[this._submits._length++]=a,this._copyClipInfo(a,this._globalClipMatrix),!this._lastTex||this._lastTex.destroyed?a.shaderValue.textureHost=this.defTexture:a.shaderValue.textureHost=this._lastTex,a._key.other=this._lastTex&&this._lastTex.bitmap?this._lastTex.bitmap.id:-1,a._renderType=Ut.TYPE_TEXTURE),this._curSubmit._numEle+=6,this._mesh.indexNum+=6,this._mesh.vertNum+=4)}fillRect(t,e,i,r,s){var a=s?ne.create(s):this._shader2D.fillStyle,n=this.mixRGBandAlpha(a.toInt());this._fillRect(t,e,i,r,n)}fillTexture(t,e,i,r,s,a,h){t._getSource()?this._fillTexture(t,t.width,t.height,t.uvrect,e,i,r,s,a,h.x,h.y):this.sprite&&n.systemTimer.callLater(this,this._repaintSprite)}_fillTexture(t,e,i,r,s,a,n,h,o,l,_){var u=this._curSubmit;this._mesh.vertNum+4>Je._MAXVERTNUM&&(this._mesh=Zt.getAMesh(this.isMain),this.meshlist.push(this._mesh));var d=!0,c=!0;switch(o){case"repeat":break;case"repeat-x":c=!1;break;case"repeat-y":d=!1;break;case"no-repeat":d=c=!1}var p=this._temp4Points,f=0,m=0,g=0,T=0,x=0,E=0;if(l<0?(g=s,f=-l%e/e):g=s+l,_<0?(T=a,m=-_%i/i):T=a+_,x=s+n,E=a+h,!d&&(x=Math.min(x,s+l+e)),!c&&(E=Math.min(E,a+_+i)),!(x<s||E<a||g>x||T>E)){var y=(x-s-l)/e,v=(E-a-_)/i;if(this.transformQuad(g,T,x-g,E-T,0,this._curMat,this._transedPoints),p[0]=f,p[1]=m,p[2]=y,p[3]=m,p[4]=y,p[5]=v,p[6]=f,p[7]=v,!this.clipedOff(this._transedPoints)){var S=this._mixRGBandAlpha(4294967295,this._shader2D.ALPHA);this._mesh.addQuad(this._transedPoints,p,S,!0);var R=Tt.create(st.TEXTURE2D,0);R.defines.add(st.FILLTEXTURE),R.u_TexRange=r.concat(),u=this._curSubmit=Ie.create(this,this._mesh,R),this._submits[this._submits._length++]=u,this._copyClipInfo(u,this._globalClipMatrix),u.shaderValue.textureHost=t,u._renderType=Ut.TYPE_TEXTURE,this._curSubmit._numEle+=6,this._mesh.indexNum+=6,this._mesh.vertNum+=4}this.breakNextMerge()}}setColorFilter(t){le.save(this,le.TYPE_COLORFILTER,this,!0),this._colorFiler=t,this._curSubmit=Ut.RENDERBASE}drawTexture(t,e,i,r,s){this._drawTextureM(t,e,i,r,s,null,1,null)}drawTextures(t,e,i,r){if(t._getSource())for(var s=e.length/2,a=0,h=t.bitmap.id,o=0;o<s;o++)this._inner_drawTexture(t,h,e[a++]+i,e[a++]+r,0,0,null,null,1,!1);else this.sprite&&n.systemTimer.callLater(this,this._repaintSprite)}_drawTextureAddSubmit(t,e){var i=null;i=Ie.create(this,this._mesh,Tt.create(st.TEXTURE2D,0)),this._submits[this._submits._length++]=i,i.shaderValue.textureHost=e,i._key.other=t,i._renderType=Ut.TYPE_TEXTURE,this._curSubmit=i}_drawTextureM(t,e,i,r,s,a,n,h){var o=this.sprite;return!!t._getSource((function(){o&&o.repaint()}))&&this._inner_drawTexture(t,t.bitmap.id,e,i,r,s,a,h,n,!1)}_drawRenderTexture(t,e,i,r,s,a,n,h){return this._inner_drawTexture(t,-1,e,i,r,s,a,h,1,!1)}submitDebugger(){this._submits[this._submits._length++]=Et.create([],(function(){}),this)}_copyClipInfo(t,e){var i=t.shaderValue.clipMatDir;i[0]=e.a,i[1]=e.b,i[2]=e.c,i[3]=e.d;var r=t.shaderValue.clipMatPos;r[0]=e.tx,r[1]=e.ty,t.clipInfoID=this._clipInfoID,this._clipInCache&&(t.shaderValue.clipOff[0]=1)}isSameClipInfo(t){return t.clipInfoID===this._clipInfoID}_useNewTex2DSubmit(t,e){this._mesh.vertNum+e>Je._MAXVERTNUM&&(this._mesh=Zt.getAMesh(this.isMain),this.meshlist.push(this._mesh));var i=Ie.create(this,this._mesh,Tt.create(st.TEXTURE2D,0));this._submits[this._submits._length++]=this._curSubmit=i,i.shaderValue.textureHost=t,this._copyClipInfo(i,this._globalClipMatrix)}_drawTexRect(t,e,i,r,s){this.transformQuad(t,e,i,r,this._italicDeg,this._curMat,this._transedPoints);var a=this._transedPoints;a[0]=a[0]+.5|0,a[1]=a[1]+.5|0,a[2]=a[2]+.5|0,a[3]=a[3]+.5|0,a[4]=a[4]+.5|0,a[5]=a[5]+.5|0,a[6]=a[6]+.5|0,a[7]=a[7]+.5|0,this.clipedOff(this._transedPoints)||(this._mesh.addQuad(this._transedPoints,s,this._fillColor,!0),this._curSubmit._numEle+=6,this._mesh.indexNum+=6,this._mesh.vertNum+=4)}drawCallOptimize(t){return this._charSubmitCache.enable(t,this),t}_inner_drawTexture(t,e,i,r,s,a,n,h,o,l){if(s<=0||a<=0)return!1;var _=this._curSubmit._key;if(h=h||t._uv,_.submitType===Ut.KEY_TRIANGLES&&_.other===e){var u=this._drawTexToDrawTri_Vert;u[0]=i,u[1]=r,u[2]=i+s,u[3]=r,u[4]=i+s,u[5]=r+a,u[6]=i,u[7]=r+a,this._drawTriUseAbsMatrix=!0;var d=this._tempUV;return d[0]=h[0],d[1]=h[1],d[2]=h[2],d[3]=h[3],d[4]=h[4],d[5]=h[5],d[6]=h[6],d[7]=h[7],this.drawTriangles(t,0,0,u,d,this._drawTexToDrawTri_Index,n||this._curMat,o,null,null),this._drawTriUseAbsMatrix=!1,!0}var c=this._mesh,p=this._curSubmit,f=l?this._charSubmitCache.getPos():this._transedPoints;if(this.transformQuad(i,r,s||t.width,a||t.height,this._italicDeg,n||this._curMat,f),this.drawTexAlign){var m=Math.round;f[0]=m(f[0]),f[1]=m(f[1]),f[2]=m(f[2]),f[3]=m(f[3]),f[4]=m(f[4]),f[5]=m(f[5]),f[6]=m(f[6]),f[7]=m(f[7]),this.drawTexAlign=!1}var g=this._mixRGBandAlpha(4294967295,this._shader2D.ALPHA*o);if(l)return this._charSubmitCache.add(this,t,e,f,h,g),!0;this._drawCount++;var T=e>=0&&_.submitType===Ut.KEY_DRAWTEXTURE&&_.other===e;return T&&(T=T&&this.isSameClipInfo(p)),this._lastTex=t,c.vertNum+4>Je._MAXVERTNUM&&(c=this._mesh=Zt.getAMesh(this.isMain),this.meshlist.push(c),T=!1),c.addQuad(f,h,g,!0),T||(this._submits[this._submits._length++]=this._curSubmit=p=Ie.create(this,c,Tt.create(st.TEXTURE2D,0)),p.shaderValue.textureHost=t,p._key.other=e,this._copyClipInfo(p,this._globalClipMatrix)),p._numEle+=6,c.indexNum+=6,c.vertNum+=4,!0}transform4Points(t,e,i){var r=e.tx,s=e.ty,a=e.a,n=e.b,h=e.c,o=e.d,l=t[0],_=t[1],u=t[2],d=t[3],c=t[4],p=t[5],f=t[6],m=t[7];e._bTransform?(i[0]=l*a+_*h+r,i[1]=l*n+_*o+s,i[2]=u*a+d*h+r,i[3]=u*n+d*o+s,i[4]=c*a+p*h+r,i[5]=c*n+p*o+s,i[6]=f*a+m*h+r,i[7]=f*n+m*o+s):(i[0]=l+r,i[1]=_+s,i[2]=u+r,i[3]=d+s,i[4]=c+r,i[5]=p+s,i[6]=f+r,i[7]=m+s)}clipedOff(t){return this._clipRect.width<=0||this._clipRect.height<=0}transformQuad(t,e,i,r,s,a,n){var h=0;0!=s&&(h=Math.tan(s*Math.PI/180)*r);var o=t+i,l=e+r,_=a.tx,u=a.ty,d=a.a,c=a.b,p=a.c,f=a.d,m=t+h,g=e,T=o+h,x=e,E=o,y=l,v=t,S=l;a._bTransform?(n[0]=m*d+g*p+_,n[1]=m*c+g*f+u,n[2]=T*d+x*p+_,n[3]=T*c+x*f+u,n[4]=E*d+y*p+_,n[5]=E*c+y*f+u,n[6]=v*d+S*p+_,n[7]=v*c+S*f+u):(n[0]=m+_,n[1]=g+u,n[2]=T+_,n[3]=x+u,n[4]=E+_,n[5]=y+u,n[6]=v+_,n[7]=S+u)}pushRT(){this.addRenderObject(Et.create(null,J.pushRT,this))}popRT(){this.addRenderObject(Et.create(null,J.popRT,this)),this.breakNextMerge()}useRT(t){this.addRenderObject(Et.create([t],(function(t){if(!t)throw"error useRT";t.start(),t.clear(0,0,0,0)}),this)),this.breakNextMerge()}RTRestore(t){this.addRenderObject(Et.create([t],(function(t){t.restore()}),this)),this.breakNextMerge()}breakNextMerge(){this._curSubmit=Ut.RENDERBASE}_repaintSprite(){this.sprite&&this.sprite.repaint()}drawTextureWithTransform(t,e,i,r,s,a,n,h,o,l,_=null,u){var d,c=this._curMat;l&&(d=this.globalCompositeOperation,this.globalCompositeOperation=l);var f=this._colorFiler;if(_&&this.setColorFilter(_),!a)return this._drawTextureM(t,e+n,i+h,r,s,c,o,u),l&&(this.globalCompositeOperation=d),void(_&&this.setColorFilter(f));var m=this._tmpMatrix;m.a=a.a,m.b=a.b,m.c=a.c,m.d=a.d,m.tx=a.tx+n,m.ty=a.ty+h,m._bTransform=a._bTransform,a&&c._bTransform?(p.mul(m,c,m),(a=m)._bTransform=!0):(m.tx+=c.tx,m.ty+=c.ty,a=m),this._drawTextureM(t,e,i,r,s,a,o,u),l&&(this.globalCompositeOperation=d),_&&this.setColorFilter(f)}_flushToTarget(t,e){Y.worldScissorTest=!1,g.renderEngine.scissorTest(!1);var i=Y.worldAlpha,r=Y.worldMatrix4,s=Y.worldMatrix;Y.worldShaderDefines,Y.worldMatrix=p.EMPTY,Y.restoreTempArray(),Y.worldMatrix4=Y.TEMPMAT4_ARRAY,Y.worldAlpha=1,H.activeShader=null,e.start(),t._submits._length>0&&e.clear(0,0,0,0),t._curSubmit=Ut.RENDERBASE,t.flush(),t.clear(),e.restore(),t._curSubmit=Ut.RENDERBASE,H.activeShader=null,Y.worldAlpha=i,Y.worldMatrix4=r,Y.worldMatrix=s}drawCanvas(t,e,i,r,s){if(t){var a,n=t.context;if(n._targets)n._submits._length>0&&(a=Et.create([n,n._targets],this._flushToTarget,this),this._submits[this._submits._length++]=a),this._drawRenderTexture(n._targets,e,i,r,s,null,1,J.flipyuv),this._curSubmit=Ut.RENDERBASE;else{var h=t;h.touches&&h.touches.forEach((function(t){t.touch()})),a=Me.create(t,this._shader2D.ALPHA,this._shader2D.filters),this._submits[this._submits._length++]=a,a._key.clear();var o=a._matrix;this._curMat.copyTo(o);var l=o.tx,_=o.ty;o.tx=o.ty=0,o.transformPoint(f.TEMP.setTo(e,i)),o.translate(f.TEMP.x+l,f.TEMP.y+_),p.mul(h.invMat,o,o),this._curSubmit=Ut.RENDERBASE}}}drawTarget(t,e,i,r,s,a,n,h=null,o=-1){if(this._drawCount++,this._mesh.vertNum+4>Je._MAXVERTNUM&&(this._mesh=Zt.getAMesh(this.isMain),this.meshlist.push(this._mesh)),this.transformQuad(e,i,r,s,0,a||this._curMat,this._transedPoints),!this.clipedOff(this._transedPoints)){this._mesh.addQuad(this._transedPoints,h||ht.DEF_UV,4294967295,!0);var l=this._curSubmit=De.create(this,this._mesh,n,t);return l.blendType=-1==o?this._nBlendType:o,this._copyClipInfo(l,this._globalClipMatrix),l._numEle=6,this._mesh.indexNum+=6,this._mesh.vertNum+=4,this._submits[this._submits._length++]=l,this._curSubmit=Ut.RENDERBASE,!0}return this._curSubmit=Ut.RENDERBASE,!1}drawTriangles(t,e,i,r,s,a,h,o,l,_,u=4294967295){if(t._getSource()){var d=null;_&&(d=this.globalCompositeOperation,this.globalCompositeOperation=_),this._drawCount++;var c=this._tmpMatrix,f=this._triangleMesh,m=null,g=!1;l&&(m=this._colorFiler,this._colorFiler=l,this._curSubmit=Ut.RENDERBASE,g=m!=l);var T=t.bitmap,x=this._curSubmit._key,E=x.submitType===Ut.KEY_TRIANGLES&&x.other===T.id&&x.blendShader==this._nBlendType;if(f.vertNum+r.length/2>Je._MAXVERTNUM&&(f=this._triangleMesh=Qt.getAMesh(this.isMain),this.meshlist.push(f),E=!1),!E){var y=this._curSubmit=Ie.create(this,f,Tt.create(st.TEXTURE2D,0));y.shaderValue.textureHost=t,y._renderType=Ut.TYPE_TEXTURE,y._key.submitType=Ut.KEY_TRIANGLES,y._key.other=T.id,this._copyClipInfo(y,this._globalClipMatrix),this._submits[this._submits._length++]=y}var v=this._mixRGBandAlpha(u,this._shader2D.ALPHA*o);this._drawTriUseAbsMatrix?f.addData(r,s,a,h,v):(h?(c.a=h.a,c.b=h.b,c.c=h.c,c.d=h.d,c.tx=h.tx+e,c.ty=h.ty+i):(c.a=1,c.b=0,c.c=0,c.d=1,c.tx=e,c.ty=i),p.mul(c,this._curMat,c),f.addData(r,s,a,c||this._curMat,v)),this._curSubmit._numEle+=a.length,g&&(this._colorFiler=m,this._curSubmit=Ut.RENDERBASE),_&&(this.globalCompositeOperation=d)}else this.sprite&&n.systemTimer.callLater(this,this._repaintSprite)}transform(t,e,i,r,s,a){de.save(this),p.mul(p.TEMP.setTo(t,e,i,r,s,a),this._curMat,this._curMat),this._curMat._checkTransform()}_transformByMatrix(t,e,i){t.setTranslate(e,i),p.mul(t,this._curMat,this._curMat),t.setTranslate(0,0),this._curMat._bTransform=!0}setTransformByMatrix(t){t.copyTo(this._curMat)}rotate(t){de.save(this),this._curMat.rotateEx(t)}scale(t,e){de.save(this),this._curMat.scaleEx(t,e)}clipRect(t,e,r,s,a){if(_e.save(this),this._clipRect==Je.MAXCLIPRECT?this._clipRect=new m(t,e,r,s):(this._clipRect.width=r,this._clipRect.height=s,this._clipRect.x=t,this._clipRect.y=e),this._clipID_Gen++,this._clipID_Gen%=1e4,this._clipInfoID=this._clipID_Gen,a)Qe.copyTo(this._globalClipMatrix);else{var n=this._globalClipMatrix,h=n.tx,o=n.ty,l=h+n.a,_=o+n.d;if(this._clipRect.width>=i.MAX_CLIP_SIZE?(n.a=n.d=i.MAX_CLIP_SIZE,n.b=n.c=n.tx=n.ty=0):(this._curMat._bTransform?(n.tx=this._clipRect.x*this._curMat.a+this._clipRect.y*this._curMat.c+this._curMat.tx,n.ty=this._clipRect.x*this._curMat.b+this._clipRect.y*this._curMat.d+this._curMat.ty,n.a=this._clipRect.width*this._curMat.a,n.b=this._clipRect.width*this._curMat.b,n.c=this._clipRect.height*this._curMat.c,n.d=this._clipRect.height*this._curMat.d):(n.tx=this._clipRect.x+this._curMat.tx,n.ty=this._clipRect.y+this._curMat.ty,n.a=this._clipRect.width,n.b=n.c=0,n.d=this._clipRect.height),this._incache&&(this._clipInCache=!0)),n.a>0&&n.d>0){var u=n.tx+n.a,d=n.ty+n.d;u<=h||d<=o||n.tx>=l||n.ty>=_?(n.a=-.1,n.d=-.1):(n.tx<h&&(n.a-=h-n.tx,n.tx=h),u>l&&(n.a-=u-l),n.ty<o&&(n.d-=o-n.ty,n.ty=o),d>_&&(n.d-=d-_),n.a<=0&&(n.a=-.1),n.d<=0&&(n.d=-.1))}}}addRenderObject(t){this._submits[this._submits._length++]=t}submitElement(t,e){this.isMain;var i=this._submits,r=i._length;e<0&&(e=i._length);for(var s=Ut.RENDERBASE;t<e;)this._renderNextSubmitIndex=t+1,i[t]!==Ut.RENDERBASE?(Ut.preRender=s,t+=(s=i[t]).renderSubmit()):t++;return r}flush(){this._clipID_Gen=0;var t=this.submitElement(0,this._submits._length);this._path&&this._path.reset(),Re.instance&&Re.getInstance().reset(),this._curSubmit=Ut.RENDERBASE;for(var e=0,i=this.meshlist.length;e<i;e++){var r=this.meshlist[e];r.canReuse?r.releaseMesh():r.destroy()}return this.meshlist.length=0,this._mesh=Zt.getAMesh(this.isMain),this._pathMesh=Jt.getAMesh(this.isMain),this._triangleMesh=Qt.getAMesh(this.isMain),this.meshlist.push(this._mesh,this._pathMesh,this._triangleMesh),this._flushCnt++,this._flushCnt%60==0&&this.isMain&&He.textRenderInst&&He.textRenderInst.GC(),t}beginPath(t=!1){this._getPath().beginPath(t)}closePath(){this._path.closePath()}addPath(t,e,i,r,s){let a=t.length;for(let e=0;e<a-1;e+=2)t[e]+=r,t[e+1]+=s;e&&a>5&&(t[a-2]!=t[0]||t[a-1]!=t[1])&&t.push(t[0],t[1]),this._getPath().push(t,i)}fill(){var t=this._curMat,e=this._getPath(),i=this._curSubmit,r=i._key.submitType===Ut.KEY_VG&&i._key.blendShader===this._nBlendType;r&&(r=r&&this.isSameClipInfo(i)),r||(this._curSubmit=this.addVGSubmit(this._pathMesh));for(var s,a=this.mixRGBandAlpha(this.fillStyle.toInt()),n=0,h=0,o=e.paths.length;h<o;h++){var l=e.paths[h],_=l.path.length/2;if(!(_<3||3==_&&!l.convex)){var u,d,c,p,f=l.path.concat(),m=0;if(t._bTransform)for(m=0;m<_;m++)d=(u=m<<1)+1,c=f[u],p=f[d],f[u]=t.a*c+t.c*p+t.tx,f[d]=t.b*c+t.d*p+t.ty;else for(m=0;m<_;m++)d=(u=m<<1)+1,c=f[u],p=f[d],f[u]=c+t.tx,f[d]=p+t.ty;this._pathMesh.vertNum+_>Je._MAXVERTNUM&&(this._curSubmit._numEle+=n,n=0,this._pathMesh=Jt.getAMesh(this.isMain),this._curSubmit=this.addVGSubmit(this._pathMesh));var g=this._pathMesh.vertNum;if(l.convex){var T=_-2;s=new Array(3*T);for(var x=0,E=0;E<T;E++)s[x++]=g,s[x++]=E+1+g,s[x++]=E+2+g}else if(s=Ae.earcut(f,null,2),g>0)for(var y=0;y<s.length;y++)s[y]+=g;this._pathMesh.addVertAndIBToMesh(this,f,a,s),n+=s.length}}this._curSubmit._numEle+=n}addVGSubmit(t){var e=we.createShape(this,t,0,Tt.create(st.PRIMITIVE,0));return e._key.submitType=Ut.KEY_VG,this._submits[this._submits._length++]=e,this._copyClipInfo(e,this._globalClipMatrix),e}stroke(){if(this.lineWidth>0){var t=this.mixRGBandAlpha(this.strokeStyle._color.numColor),e=this._getPath(),i=this._curSubmit,r=i._key.submitType===Ut.KEY_VG&&i._key.blendShader===this._nBlendType;r&&(r=r&&this.isSameClipInfo(i)),r||(this._curSubmit=this.addVGSubmit(this._pathMesh));for(var s=0,a=0,n=e.paths.length;a<n;a++){var h=e.paths[a];if(!(h.path.length<=0)){var o=[],l=[],_=2*h.path.length;if(!(_<2)){this._pathMesh.vertNum+_>Je._MAXVERTNUM&&(this._curSubmit._numEle+=s,s=0,this._pathMesh=Jt.getAMesh(this.isMain),this.meshlist.push(this._pathMesh),this._curSubmit=this.addVGSubmit(this._pathMesh)),be.createLine2(h.path,o,this.lineWidth,this._pathMesh.vertNum,l,h.loop);var u,d,c,p,f=l.length/2,m=this._curMat,g=0;if(m._bTransform)for(g=0;g<f;g++)d=(u=g<<1)+1,c=l[u],p=l[d],l[u]=m.a*c+m.c*p+m.tx,l[d]=m.b*c+m.d*p+m.ty;else for(g=0;g<f;g++)d=(u=g<<1)+1,c=l[u],p=l[d],l[u]=c+m.tx,l[d]=p+m.ty;this._pathMesh.addVertAndIBToMesh(this,l,t,o),s+=o.length}}}this._curSubmit._numEle+=s}}moveTo(t,e){var i=this._getPath();i.newPath(),i._lastOriX=t,i._lastOriY=e,i.addPoint(t,e)}lineTo(t,e){var i=this._getPath();Math.abs(t-i._lastOriX)<.001&&Math.abs(e-i._lastOriY)<.001||(i._lastOriX=t,i._lastOriY=e,i.addPoint(t,e))}arcTo(t,e,i,r,s){var a=0,n=0,h=0,o=this._path._lastOriX-t,l=this._path._lastOriY-e,_=Math.sqrt(o*o+l*l);if(!(_<=1e-6)){var u=o/_,d=l/_,c=i-t,p=r-e,f=c*c+p*p,m=Math.sqrt(f);if(!(m<=1e-6)){var g=c/m,T=p/m,x=u+g,E=d+T,y=Math.sqrt(x*x+E*E);if(!(y<=1e-6)){var v=x/y,S=E/y,R=Math.acos(v*u+S*d),b=Math.PI/2-R,C=(_=s/Math.tan(b))*u+t,A=_*d+e,w=Math.sqrt(_*_+s*s),M=t+v*w,D=e+S*w,I=0,P=0;if(u*T-d*g>=0){var B=2*b/Je.SEGNUM;I=Math.sin(B),P=Math.cos(B)}else B=2*-b/Je.SEGNUM,I=Math.sin(B),P=Math.cos(B);var L=this._path._lastOriX,F=this._path._lastOriY,O=C,N=A;(Math.abs(O-this._path._lastOriX)>.1||Math.abs(N-this._path._lastOriY)>.1)&&(n=O,h=N,L=O,F=N,this._path._lastOriX=n,this._path._lastOriY=h,this._path.addPoint(n,h));var U=C-M,G=A-D;for(a=0;a<Je.SEGNUM;a++){var k=U*P+G*I,W=-U*I+G*P;n=k+M,h=W+D,(Math.abs(L-n)>.1||Math.abs(F-h)>.1)&&(this._path._lastOriX=n,this._path._lastOriY=h,this._path.addPoint(n,h),L=n,F=h),U=k,G=W}}}}}arc(t,e,i,r,s,a=!1,n=!0){var h,o,l=0,_=0,u=0,d=0,c=0;if(_=s-r,a)if(Math.abs(_)>=2*Math.PI)_=2*-Math.PI;else for(;_>0;)_-=2*Math.PI;else if(Math.abs(_)>=2*Math.PI)_=2*Math.PI;else for(;_<0;)_+=2*Math.PI;var p=this.getMatScaleX(),f=this.getMatScaleY(),m=i*(p>f?p:f),g=2*Math.PI*m;o=0|Math.max(g/10,10);var T=this._getPath();for(h=0;h<=o;h++)l=r+_*(h/o),u=Math.cos(l),c=e+Math.sin(l)*i,(d=t+u*i)==this._path._lastOriX&&c==this._path._lastOriY||T.addPoint(d,c);u=Math.cos(s),c=e+Math.sin(s)*i,(d=t+u*i)==this._path._lastOriX&&c==this._path._lastOriY||T.addPoint(d,c)}quadraticCurveTo(t,e,i,r){for(var s=ae.I.getBezierPoints([this._path._lastOriX,this._path._lastOriY,t,e,i,r],30,2),a=0,n=s.length/2;a<n;a++)this.lineTo(s[2*a],s[2*a+1]);this.lineTo(i,r)}mixRGBandAlpha(t){return this._mixRGBandAlpha(t,this._shader2D.ALPHA)}_mixRGBandAlpha(t,e){if(e>=1)return t;var i=(4278190080&t)>>>24;return 0!=i?i*=e:i=255*e,16777215&t|i<<24}strokeRect(t,e,i,r,s){if(this.lineWidth>0){var a=this.mixRGBandAlpha(this.strokeStyle._color.numColor),n=this.lineWidth/2;this._fillRect(t-n,e-n,i+this.lineWidth,this.lineWidth,a),this._fillRect(t-n,e-n+r,i+this.lineWidth,this.lineWidth,a),this._fillRect(t-n,e+n,this.lineWidth,r-this.lineWidth,a),this._fillRect(t-n+i,e+n,this.lineWidth,r-this.lineWidth,a)}}clip(){}drawParticle(t,e,i){i.x=t,i.y=e,this._submits[this._submits._length++]=i}_getPath(){return this._path||(this._path=new he)}get canvas(){return this._canvas}_fillTexture_h(t,e,i,r,s,a,n,h){r<=0&&console.error("_fillTexture_h error: oriw must>0");for(var o=a,l=Math.floor(h/r),_=h%r,u=0;u<l;u++)this._inner_drawTexture(t,e,o,n,r,s,this._curMat,i,1,!1),o+=r;if(_>0){var d=i[2]-i[0],c=i[0]+d*(_/r),p=Je.tmpuv1;p[0]=i[0],p[1]=i[1],p[2]=c,p[3]=i[3],p[4]=c,p[5]=i[5],p[6]=i[6],p[7]=i[7],this._inner_drawTexture(t,e,o,n,_,s,this._curMat,p,1,!1)}}_fillTexture_v(t,e,i,r,s,a,n,h){s<=0&&console.error("_fillTexture_v error: orih must>0");for(var o=n,l=Math.floor(h/s),_=h%s,u=0;u<l;u++)this._inner_drawTexture(t,e,a,o,r,s,this._curMat,i,1,!1),o+=s;if(_>0){var d=i[7]-i[1],c=i[1]+d*(_/s),p=Je.tmpuv1;p[0]=i[0],p[1]=i[1],p[2]=i[2],p[3]=i[3],p[4]=i[4],p[5]=c,p[6]=i[6],p[7]=c,this._inner_drawTexture(t,e,a,o,r,_,this._curMat,p,1,!1)}}drawTextureWithSizeGrid(t,e,i,r,s,a,n,h){if(t._getSource()){e+=n,i+=h;var o=t.uv,l=t.bitmap.width,_=t.bitmap.height,u=a[0],d=a[3],c=a[1],p=a[2],f=a[4];r==t.width&&(d=c=0),s==t.height&&(u=p=0);var m=u/_,g=d/l,T=c/l,x=p/_,E=t.bitmap.id,y=this._curMat,v=this._tempUV,S=1,R=1;d+c>r&&(S=r/(d+c)),u+p>s&&(R=s/(u+p)),d*=S,c*=S,u*=R,p*=R;var b=o[0],C=o[1],A=o[4],w=o[5],M=b,D=C,I=A,P=w;if(d&&u&&(I=b+g,P=C+m,v[0]=b,v[1]=C,v[2]=I,v[3]=C,v[4]=I,v[5]=P,v[6]=b,v[7]=P,this._inner_drawTexture(t,E,e,i,d,u,y,v,1,!1)),c&&u&&(M=A-T,D=C,I=A,P=C+m,v[0]=M,v[1]=D,v[2]=I,v[3]=D,v[4]=I,v[5]=P,v[6]=M,v[7]=P,this._inner_drawTexture(t,E,r-c+e,0+i,c,u,y,v,1,!1)),d&&p&&(M=b,D=w-x,I=b+g,P=w,v[0]=M,v[1]=D,v[2]=I,v[3]=D,v[4]=I,v[5]=P,v[6]=M,v[7]=P,this._inner_drawTexture(t,E,0+e,s-p+i,d,p,y,v,1,!1)),c&&p&&(M=A-T,D=w-x,I=A,P=w,v[0]=M,v[1]=D,v[2]=I,v[3]=D,v[4]=I,v[5]=P,v[6]=M,v[7]=P,this._inner_drawTexture(t,E,r-c+e,s-p+i,c,p,y,v,1,!1)),u&&(M=b+g,D=C,I=A-T,P=C+m,v[0]=M,v[1]=D,v[2]=I,v[3]=D,v[4]=I,v[5]=P,v[6]=M,v[7]=P,f?this._fillTexture_h(t,E,v,t.width-d-c,u,d+e,i,r-d-c):this._inner_drawTexture(t,E,d+e,i,r-d-c,u,y,v,1,!1)),p&&(M=b+g,D=w-x,I=A-T,P=w,v[0]=M,v[1]=D,v[2]=I,v[3]=D,v[4]=I,v[5]=P,v[6]=M,v[7]=P,f?this._fillTexture_h(t,E,v,t.width-d-c,p,d+e,s-p+i,r-d-c):this._inner_drawTexture(t,E,d+e,s-p+i,r-d-c,p,y,v,1,!1)),d&&(M=b,D=C+m,I=b+g,P=w-x,v[0]=M,v[1]=D,v[2]=I,v[3]=D,v[4]=I,v[5]=P,v[6]=M,v[7]=P,f?this._fillTexture_v(t,E,v,d,t.height-u-p,e,u+i,s-u-p):this._inner_drawTexture(t,E,e,u+i,d,s-u-p,y,v,1,!1)),c&&(M=A-T,D=C+m,I=A,P=w-x,v[0]=M,v[1]=D,v[2]=I,v[3]=D,v[4]=I,v[5]=P,v[6]=M,v[7]=P,f?this._fillTexture_v(t,E,v,c,t.height-u-p,r-c+e,u+i,s-u-p):this._inner_drawTexture(t,E,r-c+e,u+i,c,s-u-p,y,v,1,!1)),M=b+g,D=C+m,I=A-T,P=w-x,v[0]=M,v[1]=D,v[2]=I,v[3]=D,v[4]=I,v[5]=P,v[6]=M,v[7]=P,f){var B=Je.tmpUVRect;B[0]=M,B[1]=D,B[2]=I-M,B[3]=P-D,this._fillTexture(t,t.width-d-c,t.height-u-p,B,d+e,u+i,r-d-c,s-u-p,"repeat",0,0)}else this._inner_drawTexture(t,E,d+e,u+i,r-d-c,s-u-p,y,v,1,!1)}}addRenderObject3D(t){this._curSubmit=Ut.RENDERBASE,this.addRenderObject(t)}}Je._SUBMITVBSIZE=32e3,Je._MAXVERTNUM=65535,Je.MAXCLIPRECT=null,Je._COUNT=0,Je.SEGNUM=32,Je._contextcount=0,Je.PI2=2*Math.PI,Je._textRender=null,Je.tmpuv1=[0,0,0,0,0,0,0,0],Je.tmpUV=[0,0,0,0,0,0,0,0],Je.tmpUVRect=[0,0,0,0];class ti{constructor(){this.lineWidth=1}clear(){this.lineWidth=1,this.textAlign=this.textBaseline=null}make(){return this===ti.DEFAULT?new ti:this}}window.conch&&!window.conchConfig.conchWebGL&&(Je=Ze);class ei extends M{get source(){return this._source}get width(){return this._width}set width(t){this._width=t}get height(){return this._height}set height(t){this._height=t}_getSource(){return this._source}constructor(t=!1){super(),this._source=t?We.createElement("canvas"):this,this.lock=!0}clear(){this._ctx&&(this._ctx.clear?this._ctx.clear():this._ctx.clearRect(0,0,this._width,this._height)),this._texture&&(this._texture.destroy(),this._texture=null)}destroy(){super.destroy(),this._setCPUMemory(0),this._ctx&&this._ctx.destroy&&this._ctx.destroy(),this._ctx=null}release(){}get context(){return this._ctx||(this._source==this?this._ctx=new Je:this._ctx=this._source.getContext(h.isConch?"layagl":"2d"),this._ctx._canvas=this),this._ctx}_setContext(t){this._ctx=t}getContext(t,e=null){return this.context}getMemSize(){return 0}size(t,e){(this._width!=t||this._height!=e||this._source&&(this._source.width!=t||this._source.height!=e))&&(this._width=t,this._height=e,this._setCPUMemory(t*e*4),this._ctx&&this._ctx.size&&this._ctx.size(t,e),this._source&&(this._source.height=e,this._source.width=t),this._texture&&(this._texture.destroy(),this._texture=null))}getTexture(){if(!this._texture){var e=new X(this.source.width,this.source.height,t.TextureFormat.R8G8B8A8,!0,!1,!1);e.setImageData(this.source,!1,!1),this._texture=new ht(e)}return this._texture}toBase64(t,e){if(this._source){if(h.isConch){var i=window,r=this._ctx._targets.sourceWidth,s=this._ctx._targets.sourceHeight,a=this._ctx._targets.getData(0,0,r,s);return i.conchToBase64FlipY?i.conchToBase64FlipY(t,e,a.buffer,r,s):i.conchToBase64(t,e,a.buffer,r,s)}return this._source.toDataURL(t,e)}return null}toBase64Async(t,e,i){var r=this._ctx._targets.sourceWidth,s=this._ctx._targets.sourceHeight;this._ctx._targets.getDataAsync(0,0,r,s,(function(a){let n=window;var h=n.conchToBase64FlipY?n.conchToBase64FlipY(t,e,a.buffer,r,s):n.conchToBase64(t,e,a.buffer,r,s);i(h)}))}}class ii{reset(){return this.bounds&&this.bounds.recover(),this.userBounds&&this.userBounds.recover(),this.bounds=null,this.userBounds=null,this.temBM=null,this}recover(){o.recover("BoundsStyle",this.reset())}static create(){return o.getItemByClass("BoundsStyle",ii)}}class ri{constructor(){this.reset()}needBitmapCache(){return this.cacheForFilters||!!this.mask}needEnableCanvasRender(){return"none"!=this.userSetCache||this.cacheForFilters||!!this.mask}releaseContext(){if(this.canvas&&this.canvas.size){o.recover("CacheCanvas",this.canvas),this.canvas.size(0,0);try{this.canvas.width=0,this.canvas.height=0}catch(t){}}this.canvas=null}createContext(){if(!this.canvas){this.canvas=o.getItem("CacheCanvas")||new ei(!1);var t=this.canvas.context;t||(t=this.canvas.getContext("2d"))}}releaseFilterCache(){var t=this.filterCache;t&&(t.destroy(),t.recycle(),this.filterCache=null)}recover(){this!==ri.EMPTY&&o.recover("SpriteCache",this.reset())}reset(){return this.releaseContext(),this.releaseFilterCache(),this.cacheAs="none",this.enableCanvasRender=!1,this.userSetCache="none",this.cacheForFilters=!1,this.staticCache=!1,this.reCache=!0,this.mask=null,this.maskParent=null,this.filterCache=null,this.filters=null,this.hasGlowFilter=!1,this.cacheRect&&this.cacheRect.recover(),this.cacheRect=null,this}static create(){return o.getItemByClass("SpriteCache",ri)}_calculateCacheRect(t,e,i,r){var s,a=t._cacheStyle;if(a.cacheRect||(a.cacheRect=m.create()),"bitmap"===e?((s=t.getSelfBounds()).width=s.width+2*ri.CANVAS_EXTEND_EDGE,s.height=s.height+2*ri.CANVAS_EXTEND_EDGE,s.x=s.x-t.pivotX,s.y=s.y-t.pivotY,s.x=s.x-ri.CANVAS_EXTEND_EDGE,s.y=s.y-ri.CANVAS_EXTEND_EDGE,s.x=Math.floor(s.x+i)-i,s.y=Math.floor(s.y+r)-r,s.width=Math.floor(s.width),s.height=Math.floor(s.height),a.cacheRect.copyFrom(s)):a.cacheRect.setTo(-t._style.pivotX,-t._style.pivotY,1,1),s=a.cacheRect,t._style.scrollRect){var n=t._style.scrollRect;s.x-=n.x,s.y-=n.y}return ri._scaleInfo.setTo(1,1),ri._scaleInfo}}ri.EMPTY=new ri,ri._scaleInfo=new f,ri.CANVAS_EXTEND_EDGE=16;class si{constructor(){this.reset()}reset(){return this.scaleX=this.scaleY=1,this.skewX=this.skewY=0,this.pivotX=this.pivotY=this.rotation=0,this.alpha=1,this.scrollRect&&this.scrollRect.recover(),this.scrollRect=null,this.viewport&&this.viewport.recover(),this.viewport=null,this.hitArea=null,this.dragging=null,this.blendMode=null,this}recover(){this!==si.EMPTY&&o.recover("SpriteStyle",this.reset())}static create(){return o.getItemByClass("SpriteStyle",si)}}si.EMPTY=new si;class ai{static create(t){var e=o.getItemByClass("AlphaCmd",ai);return e.alpha=t,e}recover(){o.recover("AlphaCmd",this)}run(t,e,i){t.alpha(this.alpha)}get cmdID(){return ai.ID}}ai.ID="Alpha";class ni{static create(t,e,i,r,s,a){var n=o.getItemByClass("DrawCircleCmd",ni),h=a>=1&&s?a/2:0;return n.x=t,n.y=e,n.radius=i-h,n.fillColor=r,n.lineColor=s,n.lineWidth=a,n}recover(){this.fillColor=null,this.lineColor=null,o.recover("DrawCircleCmd",this)}run(t,e,i){if(this.percent&&t.sprite){let r=t.sprite.width,s=t.sprite.height;t._drawCircle(this.x*r+e,this.y*s+i,this.radius*r,this.fillColor,this.lineColor,this.lineWidth,0)}else t._drawCircle(this.x+e,this.y+i,this.radius,this.fillColor,this.lineColor,this.lineWidth,0)}get cmdID(){return ni.ID}getBoundPoints(t){return m._getBoundPointS(this.x-this.radius,this.y-this.radius,this.radius+this.radius,this.radius+this.radius,this.percent?t:null)}}ni.ID="DrawCircle",a.regClass("DrawCircleCmd",ni);class hi{static create(t,e,i,r,s){var a=o.getItemByClass("DrawCurvesCmd",hi);return a.x=t,a.y=e,a.points=i,a.lineColor=r,a.lineWidth=s,a}recover(){this.points=null,this.lineColor=null,o.recover("DrawCurvesCmd",this)}run(t,e,i){this.points&&t.drawCurves(this.x+e,this.y+i,this.points,this.lineColor,this.lineWidth)}get cmdID(){return hi.ID}getBoundPoints(t){return ae.I.getBezierPoints(this.points)}}hi.ID="DrawCurves",a.regClass("DrawCurvesCmd",hi);class oi{static create(t,e,i,r,s){if(r||(r=t.sourceWidth),s||(s=t.sourceHeight),t.bitmap){var a=r/t.sourceWidth,n=s/t.sourceHeight;r=t.width*a,s=t.height*n,e+=t.offsetX*a,i+=t.offsetY*n}var h=o.getItemByClass("DrawImageCmd",oi);return h.texture=t,t._addReference(),h.x=e,h.y=i,h.width=r,h.height=s,h}recover(){this.texture&&this.texture._removeReference(),this.texture=null,o.recover("DrawImageCmd",this)}run(t,e,i){this.texture&&t.drawTexture(this.texture,this.x+e,this.y+i,this.width,this.height)}get cmdID(){return oi.ID}}oi.ID="DrawImage";class li{static create(t,e,i,r,s,a){var n=o.getItemByClass("DrawLineCmd",li),h=a<1||a%2==0?0:.5;return n.fromX=t+h,n.fromY=e+h,n.toX=i+h,n.toY=r+h,n.lineColor=s,n.lineWidth=a,n}recover(){o.recover("DrawLineCmd",this)}run(t,e,i){if(this.percent&&t.sprite){let r=t.sprite.width,s=t.sprite.height;t._drawLine(e,i,this.fromX*r,this.fromY*s,this.toX*r,this.toY*s,this.lineColor,this.lineWidth,0)}else t._drawLine(e,i,this.fromX,this.fromY,this.toX,this.toY,this.lineColor,this.lineWidth,0)}get cmdID(){return li.ID}getBoundPoints(t){let e;_i.length=0,e=.5*this.lineWidth;let i=this.fromX,r=this.fromY,s=this.toX,a=this.toY;return this.percent&&(i*=t.width,r*=t.height,s*=t.width,a*=t.height),i==s?_i.push(i+e,r,s+e,a,i-e,r,s-e,a):r==a?_i.push(i,r+e,s,a+e,i,r-e,s,a-e):_i.push(i,r,s,a),_i}}li.ID="DrawLine";const _i=[];a.regClass("DrawLineCmd",li);class ui{static create(t,e,i,r,s){var a=o.getItemByClass("DrawLinesCmd",ui),n=s<1||s%2==0?0:.5;return a.x=t+n,a.y=e+n,a.points=i,a.lineColor=r,a.lineWidth=s,a}recover(){this.points=null,this.lineColor=null,o.recover("DrawLinesCmd",this)}run(t,e,i){this.points&&t._drawLines(this.x+e,this.y+i,this.points,this.lineColor,this.lineWidth,0)}get cmdID(){return ui.ID}}ui.ID="DrawLines",a.regClass("DrawLinesCmd",ui);class di{static create(t,e,i,r,s){var a=o.getItemByClass("DrawPathCmd",di);return a.x=t,a.y=e,a.paths=i,a.brush=r,a.pen=s,a}recover(){this.paths=null,this.brush=null,this.pen=null,o.recover("DrawPathCmd",this)}run(t,e,i){this.paths&&t._drawPath(this.x+e,this.y+i,this.paths,this.brush,this.pen)}get cmdID(){return di.ID}getBoundPoints(t){let e=ci;e.length=0;let i=this.paths,r=i.length;for(let t=0;t<r;t++){let r=i[t];r.length>1&&(e.push(r[1],r[2]),r.length>3&&e.push(r[3],r[4]))}return e}}di.ID="DrawPath";const ci=[];a.regClass("DrawPathCmd",di);class pi{static create(t,e,i,r,s,a,n,h){var l=o.getItemByClass("DrawPieCmd",pi),_=h>=1&&n?h/2:0,u=n?h:0;return l.x=t+_,l.y=e+_,l.radius=i-u,l._startAngle=r,l._endAngle=s,l.fillColor=a,l.lineColor=n,l.lineWidth=h,l}recover(){this.fillColor=null,this.lineColor=null,o.recover("DrawPieCmd",this)}run(t,e,i){t._drawPie(this.x+e,this.y+i,this.radius,this._startAngle,this._endAngle,this.fillColor,this.lineColor,this.lineWidth,0)}get cmdID(){return pi.ID}get startAngle(){return 180*this._startAngle/Math.PI}set startAngle(t){this._startAngle=t*Math.PI/180}get endAngle(){return 180*this._endAngle/Math.PI}set endAngle(t){this._endAngle=t*Math.PI/180}getBoundPoints(t){let e=fi;fi.length=0;let i=Math.PI/180,r=this.endAngle-this.startAngle,s=this.x,a=this.y,n=this.radius;if(r>=360||r<=-360)return e.push(s-n,a-n),e.push(s+n,a-n),e.push(s+n,a+n),e.push(s-n,a+n),e;e.push(s,a);var h=r%360;h<0&&(h+=360);var o=this.startAngle+h,l=this.startAngle*i,_=o*i;e.push(s+n*Math.cos(l),a+n*Math.sin(l)),e.push(s+n*Math.cos(_),a+n*Math.sin(_));for(var u=90*Math.ceil(this.startAngle/90),d=90*Math.floor(o/90),c=u;c<=d;c+=90){var p=c*i;e.push(s+n*Math.cos(p),a+n*Math.sin(p))}return e}}pi.ID="DrawPie";const fi=[];a.regClass("DrawPieCmd",pi);class mi{static create(t,e,i,r,s,a){var n=o.getItemByClass("DrawPolyCmd",mi),h=!1;h=!(i.length>6);var l=a>=1&&s?a%2==0?0:.5:0;return n.x=t+l,n.y=e+l,n.points=i,n.fillColor=r,n.lineColor=s,n.lineWidth=a,n.isConvexPolygon=h,n}recover(){this.points=null,this.fillColor=null,this.lineColor=null,o.recover("DrawPolyCmd",this)}run(t,e,i){this.points&&t._drawPoly(this.x+e,this.y+i,this.points,this.fillColor,this.lineColor,this.lineWidth,this.isConvexPolygon,0)}get cmdID(){return mi.ID}}mi.ID="DrawPoly",a.regClass("DrawPolyCmd",mi);class gi{static create(t,e,i,r,s,a,n,h){var l=o.getItemByClass("DrawRectCmd",gi),_=n>=1&&a?n/2:0,u=a?n:0;return l.x=t+_,l.y=e+_,l.width=i-u,l.height=r-u,l.fillColor=s,l.lineColor=a,l.lineWidth=n,l.percent=h,l}recover(){this.fillColor=null,this.lineColor=null,o.recover("DrawRectCmd",this)}run(t,e,i){if(this.percent&&t.sprite){let r=t.sprite.width,s=t.sprite.height;t.drawRect(this.x*r+e,this.y*s+i,this.width*r,this.height*s,this.fillColor,this.lineColor,this.lineWidth)}else t.drawRect(this.x+e,this.y+i,this.width,this.height,this.fillColor,this.lineColor,this.lineWidth)}get cmdID(){return gi.ID}getBoundPoints(t){return m._getBoundPointS(this.x,this.y,this.width,this.height,this.percent?t:null)}}gi.ID="DrawRect",a.regClass("DrawRectCmd",gi);class Ti{constructor(){this.colorFlt=null,this.uv=null}static create(t,e,i,r,s,a,n,h,l,_){r||(r=t.sourceWidth),s||(s=t.sourceHeight);let u=r/t.sourceWidth,d=s/t.sourceHeight;r=t.width*u,s=t.height*d,e+=t.offsetX*u,i+=t.offsetY*d;var c=o.getItemByClass("DrawTextureCmd",Ti);return c.texture=t,t._addReference(),c.x=e,c.y=i,c.width=r,c.height=s,c.matrix=a,c.alpha=n,c.color=h,c.blendMode=l,c.uv=_||null,h?(c.colorFlt=new At,c.colorFlt.setColor(h)):c.colorFlt=null,c}recover(){this.texture&&this.texture._removeReference(),this.texture=null,this.matrix=null,o.recover("DrawTextureCmd",this)}run(t,e,i){this.texture&&t.drawTextureWithTransform(this.texture,this.x,this.y,this.width,this.height,this.matrix,e,i,this.alpha,this.blendMode,this.colorFlt,this.uv)}get cmdID(){return Ti.ID}}Ti.ID="DrawTexture";class xi{static create(t,e,i,r,s,a,n){var h=o.getItemByClass("FillTextureCmd",xi);return h.texture=t,h.x=e,h.y=i,h.width=r,h.height=s,h.type=a,h.offset=n,h}recover(){this.texture=null,this.offset=null,o.recover("FillTextureCmd",this)}run(t,e,i){if(this.texture)if(this.percent&&t.sprite){let r=t.sprite.width,s=t.sprite.height;t.fillTexture(this.texture,this.x*r+e,this.y*s+i,this.width*r,this.height*s,this.type,this.offset||f.EMPTY)}else t.fillTexture(this.texture,this.x+e,this.y+i,this.width,this.height,this.type,this.offset||f.EMPTY)}get cmdID(){return xi.ID}getBoundPoints(t){return this.width&&this.height?m._getBoundPointS(this.x,this.y,this.width,this.height,this.percent?t:null):m._getBoundPointS(this.x,this.y,this.texture.width,this.texture.height)}}xi.ID="FillTexture",a.regClass("FillTextureCmd",xi);class Ei{static create(){return o.getItemByClass("RestoreCmd",Ei)}recover(){o.recover("RestoreCmd",this)}run(t,e,i){t.restore()}get cmdID(){return Ei.ID}}Ei.ID="Restore";class yi{static create(t,e,i){var r=o.getItemByClass("RotateCmd",yi);return r.angle=t,r.pivotX=e,r.pivotY=i,r}recover(){o.recover("RotateCmd",this)}run(t,e,i){t._rotate(this.angle,this.pivotX+e,this.pivotY+i)}get cmdID(){return yi.ID}}yi.ID="Rotate";class vi{static create(t,e,i,r){var s=o.getItemByClass("ScaleCmd",vi);return s.scaleX=t,s.scaleY=e,s.pivotX=i,s.pivotY=r,s}recover(){o.recover("ScaleCmd",this)}run(t,e,i){t._scale(this.scaleX,this.scaleY,this.pivotX+e,this.pivotY+i)}get cmdID(){return vi.ID}}vi.ID="Scale";class Si{static create(t,e,i){var r=o.getItemByClass("TransformCmd",Si);return r.matrix=t,r.pivotX=e,r.pivotY=i,r}recover(){this.matrix=null,o.recover("TransformCmd",this)}run(t,e,i){t._transform(this.matrix,this.pivotX+e,this.pivotY+i)}get cmdID(){return Si.ID}}Si.ID="Transform";class Ri{static create(t,e){var i=o.getItemByClass("TranslateCmd",Ri);return i.tx=t,i.ty=e,i}recover(){o.recover("TranslateCmd",this)}run(t,e,i){t.translate(this.tx,this.ty)}get cmdID(){return Ri.ID}}Ri.ID="Translate";class bi{static create(t,e,i,r,s,a,n,h,l,_,u){var d=o.getItemByClass("DrawTrianglesCmd",bi);if(d.texture=t,d.x=e,d.y=i,d.vertices=r,d.uvs=s,d.indices=a,d.matrix=n,d.alpha=h,l){d.color=new At;var c=St.create(l).arrColor;d.color.color(255*c[0],255*c[1],255*c[2],255*c[3])}return d.blendMode=_,d.colorNum=u,d}recover(){this.texture=null,this.vertices=null,this.uvs=null,this.indices=null,this.matrix=null,o.recover("DrawTrianglesCmd",this)}run(t,e,i){t.drawTriangles(this.texture,this.x+e,this.y+i,this.vertices,this.uvs,this.indices,this.matrix,this.alpha,this.color,this.blendMode,this.colorNum)}get cmdID(){return bi.ID}getBoundPoints(t){let e=this.vertices;var i=e.length;if(i<2)return[];for(var r=e[0],s=e[1],a=r,n=s,h=2;h<i;){var o=e[h++],l=e[h++];r>o&&(r=o),s>l&&(s=l),a<o&&(a=o),n<l&&(n=l)}return[r,s,a,s,a,n,r,n]}}bi.ID="DrawTriangles",a.regClass("DrawTrianglesCmd",bi);class Ci{static create(t,e,i,r,s,a,n){let h=o.getItemByClass("Draw9GridTextureCmd",Ci);return h.texture=t,t._addReference(),h.x=e,h.y=i,h.width=r,h.height=s,h.sizeGrid=a,h.percent=n,h}recover(){this.texture._removeReference(),o.recover("Draw9GridTextureCmd",this)}run(t,e,i){if(this.texture)if(this.percent&&t.sprite){let r=t.sprite.width,s=t.sprite.height;t.drawTextureWithSizeGrid(this.texture,this.x*r,this.y*s,this.width*r,this.height*s,this.sizeGrid||Ai,e,i)}else t.drawTextureWithSizeGrid(this.texture,this.x,this.y,this.width,this.height,this.sizeGrid||Ai,e,i)}get cmdID(){return Ci.ID}getBoundPoints(t){let e=this.x,i=this.y,r=this.width,s=this.height;return this.percent&&(e*=t.width,i*=t.height,r*=t.width,s*=t.height),[e,i,r,i,r,s,e,s]}}Ci.ID="Draw9GridTexture";const Ai=[0,0,0,0,0];a.regClass("Draw9GridTextureCmd",Ci);class wi{static create(){return o.getItemByClass("SaveCmd",wi)}recover(){o.recover("SaveCmd",this)}run(t,e,i){t.save()}get cmdID(){return wi.ID}}wi.ID="Save";const Mi=new p,Di=new p,Ii=[];class Pi{constructor(){this._cacheBoundsType=!1}destroy(){this._graphics=null,this._cacheBoundsType=!1,this._temp&&(this._temp.length=0),this._rstBoundPoints&&(this._rstBoundPoints.length=0),this._bounds&&this._bounds.recover(),this._bounds=null,o.recover("GraphicsBounds",this)}static create(){return o.getItemByClass("GraphicsBounds",Pi)}reset(){this._temp&&(this._temp.length=0)}getBounds(t=!1){return(!this._bounds||!this._temp||this._temp.length<1||t!=this._cacheBoundsType)&&(this._bounds=m._getWrapRec(this.getBoundPoints(t),this._bounds)),this._cacheBoundsType=t,this._bounds}getBoundPoints(t=!1){return(!this._temp||this._temp.length<1||t!=this._cacheBoundsType)&&(this._temp=this._getCmdPoints(t)),this._cacheBoundsType=t,this._rstBoundPoints=d.copyArray(this._rstBoundPoints,this._temp)}_getCmdPoints(t=!1){let e,i=this._graphics.cmds,r=this._graphics._sp;if(e=this._temp||(this._temp=[]),e.length=0,0==i.length)return e;let s=Ii;s.length=0;let a=Di;a.identity();let n=Mi;for(let t=0,h=i.length;t<h;t++){let h=i[t];switch(h.cmdID){case ai.ID:case wi.ID:s.push(a),a=a.clone();break;case Ei.ID:a=s.pop();break;case vi.ID:n.identity(),n.translate(-h.pivotX,-h.pivotY),n.scale(h.scaleX,h.scaleY),n.translate(h.pivotX,h.pivotY),this._switchMatrix(a,n);break;case yi.ID:n.identity(),n.translate(-h.pivotX,-h.pivotY),n.rotate(h.angle),n.translate(h.pivotX,h.pivotY),this._switchMatrix(a,n);break;case Ri.ID:n.identity(),n.translate(h.tx,h.ty),this._switchMatrix(a,n);break;case Si.ID:n.identity(),n.translate(-h.pivotX,-h.pivotY),n.concat(h.matrix),n.translate(h.pivotX,h.pivotY),this._switchMatrix(a,n);break;case oi.ID:case xi.ID:addPointArrToRst(e,m._getBoundPointS(h.x,h.y,h.width,h.height),a);break;case Ti.ID:a.copyTo(n),h.matrix&&n.concat(h.matrix),addPointArrToRst(e,m._getBoundPointS(h.x,h.y,h.width,h.height),n);break;case gi.ID:case ni.ID:case li.ID:addPointArrToRst(e,h.getBoundPoints(r),a);break;case hi.ID:addPointArrToRst(e,h.getBoundPoints(r),a,h.x,h.y);break;case ui.ID:case mi.ID:addPointArrToRst(e,h.points,a,h.x,h.y);break;case di.ID:addPointArrToRst(e,h.getBoundPoints(r),a,h.x,h.y);break;case pi.ID:case bi.ID:case Ci.ID:addPointArrToRst(e,h.getBoundPoints(r),a)}}return e.length>200?e=d.copyArray(e,m._getWrapRec(e)._getBoundPoints()):e.length>8&&(e=wt.scanPList(e)),e}_switchMatrix(t,e){e.concat(t),e.copyTo(t)}}function addPointArrToRst(t,e,i,r=0,s=0){let a=e.length;for(let n=0;n<a;n+=2)addPointToRst(t,e[n]+r,e[n+1]+s,i)}function addPointToRst(t,e,i,r){var s=f.TEMP;s.setTo(e||0,i||0),r.transformPoint(s),t.push(s.x,s.y)}class Bi{static create(t,e,i,r){var s=o.getItemByClass("ClipRectCmd",Bi);return s.x=t,s.y=e,s.width=i,s.height=r,s}recover(){o.recover("ClipRectCmd",this)}run(t,e,i){t.clipRect(this.x+e,this.y+i,this.width,this.height)}get cmdID(){return Bi.ID}}Bi.ID="ClipRect";class Li{static create(t,e){var i=o.getItemByClass("DrawTexturesCmd",Li);return i.texture=t,t._addReference(),i.pos=e,i}recover(){this.texture._removeReference(),this.texture=null,this.pos=null,o.recover("DrawTexturesCmd",this)}run(t,e,i){t.drawTextures(this.texture,this.pos,e,i)}get cmdID(){return Li.ID}}Li.ID="DrawTextures";class Fi{constructor(){this._textIsWorldText=!1,this._fontColor=4294967295,this._strokeColor=0,this._fontObj=Fi._defFontObj,this._nTexAlign=0}static create(t,e,i,r,s,a,n,h,l){var _=o.getItemByClass("FillTextCmd",Fi);return _.text=t,_._textIsWorldText=t instanceof Ue,_._words=e,_.x=i,_.y=r,_.font=s,_.color=a,_.textAlign=n,_._lineWidth=h,_._borderColor=l,_}recover(){o.recover("FillTextCmd",this)}run(t,e,i){n.stage.isGlobalRepaint()&&this._textIsWorldText&&this._text.cleanCache(),this._words?t.fillWords11(this._words,this.x+e,this.y+i,this._fontObj,this._color,this._borderColor,this._lineWidth):this._textIsWorldText?t._fast_filltext(this._text,this.x+e,this.y+i,this._fontObj,this._color,this._borderColor,this._lineWidth,this._nTexAlign,0):t.filltext11(this._text,this.x+e,this.y+i,this.font,this.color,this._borderColor,this._lineWidth,this._textAlign)}get cmdID(){return Fi.ID}get text(){return this._text}set text(t){this._text=t,this._textIsWorldText=t instanceof Ue,this._textIsWorldText&&this._text.cleanCache()}get font(){return this._font}set font(t){this._font=t,this._fontObj=Oe.Parse(t),this._textIsWorldText&&this._text.cleanCache()}get color(){return this._color}set color(t){this._color=t,this._fontColor=St.create(t).numColor,this._textIsWorldText&&this._text.cleanCache()}get textAlign(){return this._textAlign}set textAlign(t){switch(this._textAlign=t,t){case"center":this._nTexAlign=i.ENUM_TEXTALIGN_CENTER;break;case"right":this._nTexAlign=i.ENUM_TEXTALIGN_RIGHT;break;default:this._nTexAlign=i.ENUM_TEXTALIGN_DEFAULT}this._textIsWorldText&&this._text.cleanCache()}}Fi.ID="FillText",Fi._defFontObj=new Oe(null);class Oi{constructor(){}static regCacheByFunction(t,e){var i;Oi.unRegCacheByFunction(t,e),i={tryDispose:t,getCacheList:e},Oi._cacheList.push(i)}static unRegCacheByFunction(t,e){var i,r;for(r=Oi._cacheList.length,i=0;i<r;i++)if(Oi._cacheList[i].tryDispose==t&&Oi._cacheList[i].getCacheList==e)return void Oi._cacheList.splice(i,1)}static forceDispose(){var t,e=Oi._cacheList.length;for(t=0;t<e;t++)Oi._cacheList[t].tryDispose(!0)}static beginCheck(t=15e3){n.systemTimer.loop(t,null,Oi._checkLoop)}static stopCheck(){n.systemTimer.clear(null,Oi._checkLoop)}static _checkLoop(){var t=Oi._cacheList;if(!(t.length<1)){var e,i,r=n.Browser.now();for(i=e=t.length;e>0&&(Oi._index++,Oi._index=Oi._index%i,t[Oi._index].tryDispose(!1),!(n.Browser.now()-r>Oi.loopTimeLimit));)e--}}}Oi.loopTimeLimit=2,Oi._cacheList=[],Oi._index=0;class Ni{constructor(){this.useDic={},this.shapeDic={},this.shapeLineDic={},this._id=0,this._checkKey=!1,this._freeIdArray=[],Oi.regCacheByFunction(this.startDispose.bind(this),this.getCacheList.bind(this))}static getInstance(){return Ni.instance=Ni.instance||new Ni}getId(){return this._id++}addShape(t,e){this.shapeDic[t]=e,this.useDic[t]||(this.useDic[t]=!0)}addLine(t,e){this.shapeLineDic[t]=e,this.shapeLineDic[t]||(this.shapeLineDic[t]=!0)}getShape(t){this._checkKey&&null!=this.useDic[t]&&(this.useDic[t]=!0)}deleteShape(t){this.shapeDic[t]&&(this.shapeDic[t]=null,delete this.shapeDic[t]),this.shapeLineDic[t]&&(this.shapeLineDic[t]=null,delete this.shapeLineDic[t]),null!=this.useDic[t]&&delete this.useDic[t]}getCacheList(){var t,e=[];for(t in this.shapeDic)e.push(this.shapeDic[t]);for(t in this.shapeLineDic)e.push(this.shapeLineDic[t]);return e}startDispose(t){var e;for(e in this.useDic)this.useDic[e]=!1;this._checkKey=!0}endDispose(){if(this._checkKey){var t;for(t in this.useDic)this.useDic[t]||this.deleteShape(t);this._checkKey=!1}}}class Ui{constructor(){this._sp=null,this._render=this._renderEmpty,this._cmds=[],this._vectorgraphArray=null,this._graphicBounds=null,this._createData()}_createData(){}_clearData(){}_destroyData(){}destroy(){this.clear(!0),this._graphicBounds&&this._graphicBounds.destroy(),this._graphicBounds=null,this._vectorgraphArray=null,this._sp&&(this._sp._renderType=0,this._sp._setRenderType(0),this._sp=null),this._destroyData()}clear(t=!0){if(t)for(let t=0,e=this._cmds.length;t<e;t++)this._cmds[t].recover();if(this._cmds.length=0,this._render=this._renderEmpty,this._clearData(),this._sp&&(this._sp._renderType&=~Mt.GRAPHICS,this._sp._setRenderType(this._sp._renderType)),this._repaint(),this._vectorgraphArray){for(let t=0,e=this._vectorgraphArray.length;t<e;t++)Ni.getInstance().deleteShape(this._vectorgraphArray[t]);this._vectorgraphArray.length=0}}_clearBoundsCache(){this._graphicBounds&&this._graphicBounds.reset()}_initGraphicBounds(){this._graphicBounds||(this._graphicBounds=Pi.create(),this._graphicBounds._graphics=this)}_repaint(){this._clearBoundsCache(),this._sp&&this._sp.repaint()}_isOnlyOne(){return 1===this._cmds.length}get cmds(){return this._cmds}set cmds(t){this._sp&&(this._sp._renderType|=Mt.GRAPHICS,this._sp._setRenderType(this._sp._renderType)),this._cmds=t;let e=t.length;this._render=0===e?this._renderEmpty:1===e?this._renderOne:this._renderAll,this._repaint()}addCmd(t){if(null!=t)return this._sp&&(this._sp._renderType|=Mt.GRAPHICS,this._sp._setRenderType(this._sp._renderType)),this._cmds.push(t),1==this._cmds.length?this._render=this._renderOne:this._render=this._renderAll,this._repaint(),t;console.warn("null cmd")}removeCmd(t){let e=this.cmds.indexOf(t);if(-1!=e){this._cmds.splice(e,1),this._sp&&(this._sp._renderType|=Mt.GRAPHICS,this._sp._setRenderType(this._sp._renderType));let t=this._cmds.length;this._render=0===t?this._renderEmpty:1===t?this._renderOne:this._renderAll,this._repaint()}}getBounds(t=!1){return this._initGraphicBounds(),this._graphicBounds.getBounds(t)}getBoundPoints(t=!1){return this._initGraphicBounds(),this._graphicBounds.getBoundPoints(t)}drawImage(t,e=0,i=0,r=0,s=0){return t&&t.bitmap?this.addCmd(oi.create(t,e,i,r,s)):null}drawTexture(t,e=0,i=0,r=0,s=0,a=null,n=1,h=null,o=null,l){return!t||n<.01?null:t.bitmap?this.addCmd(Ti.create(t,e,i,r,s,a,n,h,o,l)):null}drawTextures(t,e){return t?this.addCmd(Li.create(t,e)):null}drawTriangles(t,e,i,r,s,a,n=null,h=1,o=null,l=null,_=4294967295){return this.addCmd(bi.create(t,e,i,r,s,a,n,h,o,l,_))}fillTexture(t,e,i,r=0,s=0,a="repeat",n=null){return t&&t.bitmap?this.addCmd(xi.create(t,e,i,r,s,a,n||f.EMPTY)):null}clipRect(t,e,i,r){return this.addCmd(Bi.create(t,e,i,r))}fillText(t,i,r,s,a,n){return this.addCmd(Fi.create(t,null,i,r,s||e.defaultFontStr(),a,n,0,""))}fillBorderText(t,i,r,s,a,n,h,o){return this.addCmd(Fi.create(t,null,i,r,s||e.defaultFontStr(),a,n,h,o))}fillWords(t,i,r,s,a){return this.addCmd(Fi.create(null,t,i,r,s||e.defaultFontStr(),a,"",0,null))}fillBorderWords(t,i,r,s,a,n,h){return this.addCmd(Fi.create(null,t,i,r,s||e.defaultFontStr(),a,"",h,n))}strokeText(t,i,r,s,a,n,h){return this.addCmd(Fi.create(t,null,i,r,s||e.defaultFontStr(),null,h,n,a))}alpha(t){return this.addCmd(ai.create(t))}transform(t,e=0,i=0){return this.addCmd(Si.create(t,e,i))}rotate(t,e=0,i=0){return this.addCmd(yi.create(t,e,i))}scale(t,e,i=0,r=0){return this.addCmd(vi.create(t,e,i,r))}translate(t,e){return this.addCmd(Ri.create(t,e))}save(){return this.addCmd(wi.create())}restore(){return this.addCmd(Ei.create())}replaceText(t){this._repaint();var e=this._cmds;for(let i=e.length-1;i>-1;i--)if(this._isTextCmd(e[i]))return e[i].text=t,!0;return!1}_isTextCmd(t){return t.cmdID==Fi.ID}replaceTextColor(t){this._repaint();let e=this._cmds;for(let i=e.length-1;i>-1;i--)this._isTextCmd(e[i])&&this._setTextCmdColor(e[i],t)}_setTextCmdColor(t,e){if(t.cmdID===Fi.ID)t.color=e}loadImage(t,e=0,i=0,r=0,s=0,a=null){let h=n.loader.getRes(t);h?(this.drawImage(h,e,i,r,s),a&&a.call(this._sp)):n.loader.load(t).then((t=>{this.drawImage(t,e,i,r,s),a&&a.call(this._sp)}))}_renderEmpty(t,e,i,r){}_renderAll(t,e,i,r){e.sprite=t;var s=this._cmds;for(let t=0,a=s.length;t<a;t++)s[t].run(e,i,r)}_renderOne(t,e,i,r){e.sprite=t,this._cmds[0].run(e,i,r)}drawLine(t,e,i,r,s,a=1){return this.addCmd(li.create(t,e,i,r,s,a))}drawLines(t,e,i,r,s=1){return!i||i.length<4?null:this.addCmd(ui.create(t,e,i,r,s))}drawCurves(t,e,i,r,s=1){return this.addCmd(hi.create(t,e,i,r,s))}drawRect(t,e,i,r,s,a=null,n=1,h){return this.addCmd(gi.create(t,e,i,r,s,a,n,h))}drawCircle(t,e,i,r,s=null,a=1){return this.addCmd(ni.create(t,e,i,r,s,a))}drawPie(t,e,i,r,s,a,n=null,h=1){return this.addCmd(pi.create(t,e,i,d.toRadian(r),d.toRadian(s),a,n,h))}drawPoly(t,e,i,r,s=null,a=1){return this.addCmd(mi.create(t,e,i,r,s,a))}drawPath(t,e,i,r=null,s=null){return this.addCmd(di.create(t,e,i,r,s))}draw9Grid(t,e=0,i=0,r=0,s=0,a){this.addCmd(Ci.create(t,e,i,r,s,a))}}const Gi=[];class ki extends R{get url(){return this._url}set url(t){this._url=t}get hideFlags(){return this._hideFlags}set hideFlags(t){this._hideFlags=t}get is3D(){return this._is3D}get destroyed(){return this._destroyed}constructor(){super(),this._bits=0,this._hideFlags=0,this._children=Gi,this._extUIChild=Gi,this._parent=null,this._destroyed=!1,this.name="",this._initialize()}_initialize(){this._extra={}}_setBit(t,e){t===r.DISPLAY&&(this._getBit(t)!=e&&this._updateDisplayedInstage());e?this._bits|=t:this._bits&=~t}_getBit(t){return 0!=(this._bits&t)}_setUpNoticeChain(){this._getBit(r.DISPLAY)&&this._setBitUp(r.DISPLAY)}_setBitUp(t){var e=this;for(e._setBit(t,!0),e=e._parent;e;){if(e._getBit(t))return;e._setBit(t,!0),e=e._parent}}onStartListeningToType(t){t!==y.DISPLAY&&t!==y.UNDISPLAY||this._getBit(r.DISPLAY)||this._setBitUp(r.DISPLAY)}hasHideFlag(t){return 0!=(this._hideFlags&t)}destroy(t=!0){this._destroyed=!0,this.destroyAllComponent(),this._parent&&this._parent.removeChild(this),this._children&&(t?this.destroyChildren():this.removeChildren()),this.onDestroy(),this._children=null,this.offAll()}onDestroy(){}destroyChildren(){if(this._children)for(let t=0,e=this._children.length;t<e;t++)this._children[0]&&this._children[0].destroy(!0)}addChild(t){if(!t||this._destroyed||t===this)return t;if(t._zOrder&&this._setBit(r.HAS_ZORDER,!0),t._parent===this){var e=this.getChildIndex(t);e!==this._children.length-1&&(this._children.splice(e,1),this._children.push(t),this._childChanged())}else t._parent&&t._parent.removeChild(t),this._children===Gi&&(this._children=[]),this._children.push(t),t._setParent(this);return t}addInputChild(t){if(this._extUIChild==Gi)this._extUIChild=[t];else{if(this._extUIChild.indexOf(t)>=0)return null;this._extUIChild.push(t)}return null}removeInputChild(t){var e=this._extUIChild.indexOf(t);e>=0&&this._extUIChild.splice(e,1)}addChildren(...t){for(var e=0,i=t.length;e<i;)this.addChild(t[e++])}addChildAt(t,e){if(!t||this._destroyed||t===this)return t;if(t._zOrder&&this._setBit(r.HAS_ZORDER,!0),e>=0&&e<=this._children.length){if(t._parent===this){var i=this.getChildIndex(t);this._children.splice(i,1),this._children.splice(e,0,t),this._childChanged()}else t._parent&&t._parent.removeChild(t),this._children===Gi&&(this._children=[]),this._children.splice(e,0,t),t._setParent(this);return t}throw new Error("appendChildAt:The index is out of bounds")}getChildIndex(t){return this._children.indexOf(t)}getChildByName(t){for(let e of this._children)if(e&&e.name===t)return e;return null}getChildAt(t){return this._children[t]||null}setChildIndex(t,e){var i=this._children;if(e<0||e>=i.length)throw new Error("setChildIndex:The index is out of bounds.");var r=this.getChildIndex(t);if(r<0)throw new Error("setChildIndex:node is must child of this object.");return i.splice(r,1),i.splice(e,0,t),this._childChanged(),t}_childChanged(t=null){}removeChild(t){if(!this._children)return t;var e=this._children.indexOf(t);return this.removeChildAt(e)}removeSelf(){return this._parent&&this._parent.removeChild(this),this}removeChildByName(t){var e=this.getChildByName(t);return e&&this.removeChild(e),e}removeChildAt(t){var e=this.getChildAt(t);return e&&(this._children.splice(t,1),e._setParent(null)),e}removeChildren(t=0,e=2147483647){if(this._children&&this._children.length>0){var i=this._children;if(0===t&&e>=i.length-1){var r=i;this._children=Gi}else r=i.splice(t,e-t+1);for(var s=0,a=r.length;s<a;s++)r[s]._setParent(null)}return this}replaceChild(t,e){var i=this._children.indexOf(e);return i>-1?(this._children.splice(i,1,t),e._setParent(null),t._setParent(this),t):null}get numChildren(){return this._children?this._children.length:0}get parent(){return this._parent}isAncestorOf(t){let e=t.parent;for(;e;){if(e==this)return!0;e=e.parent}return!1}_setParent(t){if(this._parent!==t)if(t)this._parent=t,this._onAdded(),this.event(y.ADDED),this._getBit(r.DISPLAY)&&(this._setUpNoticeChain(),t.displayedInStage&&this._displayChild(this,!0)),t._childChanged(this);else{this._onRemoved(),this.event(y.REMOVED);let e=this._parent;this._getBit(r.DISPLAY)&&this._displayChild(this,!1),this._parent=t,e._childChanged(this)}}get displayedInStage(){return this._getBit(r.DISPLAY)||this._setBitUp(r.DISPLAY),this._getBit(r.DISPLAYED_INSTAGE)}_updateDisplayedInstage(){var t;t=this;for(var e=n.stage,i=!1;t;){if(t._getBit(r.DISPLAY)){i=t._getBit(r.DISPLAYED_INSTAGE);break}if(t===e||t._getBit(r.DISPLAYED_INSTAGE)){i=!0;break}t=t._parent}this._setBit(r.DISPLAYED_INSTAGE,i)}_setDisplay(t){this._getBit(r.DISPLAYED_INSTAGE)!==t&&(this._setBit(r.DISPLAYED_INSTAGE,t),t?this.event(y.DISPLAY):this.event(y.UNDISPLAY))}_displayChild(t,e){var i=t._children;if(i)for(var s=0,a=i.length;s<a;s++){var n=i[s];n&&(n._getBit(r.DISPLAY)&&(n._children.length>0?this._displayChild(n,e):n._setDisplay(e)))}t._setDisplay(e)}contains(t){if(t===this)return!0;for(;t;){if(t._parent===this)return!0;t=t._parent}return!1}timerLoop(t,e,i,r=null,s=!0,a=!1){this.timer.loop(t,e,i,r,s,a)}timerOnce(t,e,i,r=null,s=!0){this.timer._create(!1,!1,t,e,i,r,s)}frameLoop(t,e,i,r=null,s=!0){this.timer._create(!0,!0,t,e,i,r,s)}frameOnce(t,e,i,r=null,s=!0){this.timer._create(!0,!1,t,e,i,r,s)}clearTimer(t,e){this.timer.clear(t,e)}callLater(t,e=null){this.timer.callLater(this,t,e)}runCallLater(t){this.timer.runCallLater(this,t)}get scene(){return this._scene}get active(){return!this._getBit(r.NOT_READY)&&!this._getBit(r.NOT_ACTIVE)}set active(t){if(t=!!t,!this._getBit(r.NOT_ACTIVE)!==t){if(this._activeChangeScripts&&0!==this._activeChangeScripts.length)throw t?"Node: can't set the main inActive node active in hierarchy,if the operate is in main inActive node or it's children script's onDisable Event.":"Node: can't set the main active node inActive in hierarchy,if the operate is in main active node or it's children script's onEnable Event.";this._setBit(r.NOT_ACTIVE,!t),this._parent&&this._parent.activeInHierarchy&&this._processActive(t,!0)}}get activeInHierarchy(){return this._getBit(r.ACTIVE_INHIERARCHY)}_onActive(){Nt.spriteCount++}_onInActive(){Nt.spriteCount--}_onActiveInScene(){}_onInActiveInScene(){}onAwake(){}onEnable(){}onDisable(){}_parse(t,e){}_setBelongScene(t){if(!this._scene||this.scene!=t){this._scene=t,this._onActiveInScene();for(let e=0,i=this._children.length;e<i;e++)this._children[e]._setBelongScene(t)}}_setUnBelongScene(){if(this._scene!==this){this._onInActiveInScene(),this._scene=null;for(let t=0,e=this._children.length;t<e;t++)this._children[t]._setUnBelongScene()}}_processActive(t,e){this._activeChangeScripts||(this._activeChangeScripts=[]);let i=this._activeChangeScripts;t?this._activeHierarchy(i,e):this._inActiveHierarchy(i,e);for(let e=0,r=i.length;e<r;e++){let r=i[e];r.owner&&r._setActive(t)}i.length=0}_activeHierarchy(t,e){if(this._setBit(r.ACTIVE_INHIERARCHY,!0),this._components)for(let e=0,i=this._components.length;e<i;e++){let i=this._components[e];i._isScript()?i._enabled&&t.push(i):i._setActive(!0)}this._onActive();for(let i=0,s=this._children.length;i<s;i++){let s=this._children[i];!s._getBit(r.NOT_ACTIVE)&&!s._getBit(r.NOT_READY)&&s._activeHierarchy(t,e)}this._getBit(r.AWAKED)||(this._setBit(r.AWAKED,!0),this.onAwake()),this.onEnable()}_inActiveHierarchy(t,e){if(this._onInActive(),this._components)for(let e=0,i=this._components.length;e<i;e++){let i=this._components[e];i._isScript()?i._enabled&&t.push(i):i._setActive(!1)}this._setBit(r.ACTIVE_INHIERARCHY,!1);for(let i=0,s=this._children.length;i<s;i++){let s=this._children[i];s&&!s._getBit(r.NOT_ACTIVE)&&s._inActiveHierarchy(t,e)}this.onDisable()}_onAdded(){if(this._activeChangeScripts&&0!==this._activeChangeScripts.length)throw"Node: can't set the main inActive node active in hierarchy,if the operate is in main inActive node or it's children script's onDisable Event.";{let t=this._parent.scene;t&&this._setBelongScene(t),this._parent.activeInHierarchy&&this.active&&this._processActive(!0)}}_onRemoved(){if(this._activeChangeScripts&&0!==this._activeChangeScripts.length)throw"Node: can't set the main active node inActive in hierarchy,if the operate is in main active node or it's children script's onEnable Event.";this._parent.activeInHierarchy&&this.active&&this._processActive(!1),this._parent.scene&&this._setUnBelongScene()}_addComponentInstance(t){var e;this._components||(this._components=[]),this._components.push(t),t._setOwner(this),this.activeInHierarchy&&t._setActive(!0),null===(e=this._componentsChanged)||void 0===e||e.call(this,t,0)}_destroyComponent(t){var e;if(!this._components)return;let i=this._components.indexOf(t);-1!=i&&(this._components.splice(i,1),t._destroy(),null===(e=this._componentsChanged)||void 0===e||e.call(this,t,1))}destroyAllComponent(){var t;if(this._components){for(let t=0,e=this._components.length;t<e;t++){let e=this._components[t];e&&!e.destroyed&&e._destroy()}this._components.length=0,null===(t=this._componentsChanged)||void 0===t||t.call(this,null,2)}}_cloneTo(t,e,i){var r=t;if(this._components)for(let t=0,e=this._components.length;t<e;t++){var s=r.addComponent(this._components[t].constructor);this._components[t]._cloneTo(s)}}addComponentInstance(t){if(t.owner)throw"Node:the component has belong to other node.";if(t._singleton&&this.getComponent(t.constructor))throw"Node:the component is singleton, can't add the second one.";return this._addComponentInstance(t),t}addComponent(t){let e=o.createByClass(t);if(!e)throw t.toString()+"组件不存在";if(e._singleton&&this.getComponent(t))throw"无法实例"+t+"组件，"+t+"组件已存在！";return this._addComponentInstance(e),e}getComponent(t){if(this._components)for(let e=0,i=this._components.length;e<i;e++){let i=this._components[e];if(i instanceof t)return i}return null}get components(){return this._components||Gi}getComponents(t){var e;if(this._components)for(let i=0,r=this._components.length;i<r;i++){let r=this._components[i];r instanceof t&&(e=e||[]).push(r)}return e}get timer(){return this._scene?this._scene.timer:n.timer}onAfterDeserialize(){}}const Wi=.5*Math.PI,Vi=2*Math.PI;class Xi{static linearNone(t,e,i,r){return i*t/r+e}static linearIn(t,e,i,r){return i*t/r+e}static linearInOut(t,e,i,r){return i*t/r+e}static linearOut(t,e,i,r){return i*t/r+e}static bounceIn(t,e,i,r){return i-Xi.bounceOut(r-t,0,i,r)+e}static bounceInOut(t,e,i,r){return t<.5*r?.5*Xi.bounceIn(2*t,0,i,r)+e:.5*Xi.bounceOut(2*t-r,0,i,r)+.5*i+e}static bounceOut(t,e,i,r){return(t/=r)<1/2.75?i*(7.5625*t*t)+e:t<2/2.75?i*(7.5625*(t-=1.5/2.75)*t+.75)+e:t<2.5/2.75?i*(7.5625*(t-=2.25/2.75)*t+.9375)+e:i*(7.5625*(t-=2.625/2.75)*t+.984375)+e}static backIn(t,e,i,r,s=1.70158){return i*(t/=r)*t*((s+1)*t-s)+e}static backInOut(t,e,i,r,s=1.70158){return(t/=.5*r)<1?.5*i*(t*t*((1+(s*=1.525))*t-s))+e:i/2*((t-=2)*t*((1+(s*=1.525))*t+s)+2)+e}static backOut(t,e,i,r,s=1.70158){return i*((t=t/r-1)*t*((s+1)*t+s)+1)+e}static elasticIn(t,e,i,r,s=0,a=0){var n;return 0==t?e:1==(t/=r)?e+i:(a||(a=.3*r),!s||i>0&&s<i||i<0&&s<-i?(s=i,n=a/4):n=a/Vi*Math.asin(i/s),-s*Math.pow(2,10*(t-=1))*Math.sin((t*r-n)*Vi/a)+e)}static elasticInOut(t,e,i,r,s=0,a=0){var n;return 0==t?e:2==(t/=.5*r)?e+i:(a||(a=r*(.3*1.5)),!s||i>0&&s<i||i<0&&s<-i?(s=i,n=a/4):n=a/Vi*Math.asin(i/s),t<1?s*Math.pow(2,10*(t-=1))*Math.sin((t*r-n)*Vi/a)*-.5+e:s*Math.pow(2,-10*(t-=1))*Math.sin((t*r-n)*Vi/a)*.5+i+e)}static elasticOut(t,e,i,r,s=0,a=0){var n;return 0==t?e:1==(t/=r)?e+i:(a||(a=.3*r),!s||i>0&&s<i||i<0&&s<-i?(s=i,n=a/4):n=a/Vi*Math.asin(i/s),s*Math.pow(2,-10*t)*Math.sin((t*r-n)*Vi/a)+i+e)}static strongIn(t,e,i,r){return i*(t/=r)*t*t*t*t+e}static strongInOut(t,e,i,r){return(t/=.5*r)<1?.5*i*t*t*t*t*t+e:.5*i*((t-=2)*t*t*t*t+2)+e}static strongOut(t,e,i,r){return i*((t=t/r-1)*t*t*t*t+1)+e}static sineInOut(t,e,i,r){return.5*-i*(Math.cos(Math.PI*t/r)-1)+e}static sineIn(t,e,i,r){return-i*Math.cos(t/r*Wi)+i+e}static sineOut(t,e,i,r){return i*Math.sin(t/r*Wi)+e}static quintIn(t,e,i,r){return i*(t/=r)*t*t*t*t+e}static quintInOut(t,e,i,r){return(t/=.5*r)<1?.5*i*t*t*t*t*t+e:.5*i*((t-=2)*t*t*t*t+2)+e}static quintOut(t,e,i,r){return i*((t=t/r-1)*t*t*t*t+1)+e}static quartIn(t,e,i,r){return i*(t/=r)*t*t*t+e}static quartInOut(t,e,i,r){return(t/=.5*r)<1?.5*i*t*t*t*t+e:.5*-i*((t-=2)*t*t*t-2)+e}static quartOut(t,e,i,r){return-i*((t=t/r-1)*t*t*t-1)+e}static cubicIn(t,e,i,r){return i*(t/=r)*t*t+e}static cubicInOut(t,e,i,r){return(t/=.5*r)<1?.5*i*t*t*t+e:.5*i*((t-=2)*t*t+2)+e}static cubicOut(t,e,i,r){return i*((t=t/r-1)*t*t+1)+e}static quadIn(t,e,i,r){return i*(t/=r)*t+e}static quadInOut(t,e,i,r){return(t/=.5*r)<1?.5*i*t*t+e:.5*-i*(--t*(t-2)-1)+e}static quadOut(t,e,i,r){return-i*(t/=r)*(t-2)+e}static expoIn(t,e,i,r){return 0==t?e:i*Math.pow(2,10*(t/r-1))+e-.001*i}static expoInOut(t,e,i,r){return 0==t?e:t==r?e+i:(t/=.5*r)<1?.5*i*Math.pow(2,10*(t-1))+e:.5*i*(2-Math.pow(2,-10*--t))+e}static expoOut(t,e,i,r){return t==r?e+i:i*(1-Math.pow(2,-10*t/r))+e}static circIn(t,e,i,r){return-i*(Math.sqrt(1-(t/=r)*t)-1)+e}static circInOut(t,e,i,r){return(t/=.5*r)<1?.5*-i*(Math.sqrt(1-t*t)-1)+e:.5*i*(Math.sqrt(1-(t-=2)*t)+1)+e}static circOut(t,e,i,r){return i*Math.sqrt(1-(t=t/r-1)*t)+e}}class Hi{constructor(t=null,e=null,i=null,r=!1){this.once=!1,this._id=0,this.setTo(t,e,i,r)}setTo(t,e,i,r=!1){return this._id=Hi._gid++,this.caller=t,this.method=e,this.args=i,this.once=r,this}run(){if(null==this.method)return null;var t=this._id,e=this.method.apply(this.caller,this.args);return this._id===t&&this.once&&this.recover(),e}runWith(t){if(null==this.method)return null;var e=this._id;if(null==t)var i=this.method.apply(this.caller,this.args);else i=this.args||t.unshift?this.args?this.method.apply(this.caller,this.args.concat(t)):this.method.apply(this.caller,t):this.method.call(this.caller,t);return this._id===e&&this.once&&this.recover(),i}clear(){return this.caller=null,this.method=null,this.args=null,this}recover(){this._id>0&&(this._id=0,Hi._pool.push(this.clear()))}static create(t,e,i=null,r=!0){return Hi._pool.length?Hi._pool.pop().setTo(t,e,i,r):new Hi(t,e,i,r)}}Hi._pool=[],Hi._gid=1;class Yi{constructor(){this.gid=0,this.repeat=1,this._count=0}static to(t,e,i,r=null,s=null,a=0,n=!1,h=!0){return o.getItemByClass("tween",Yi)._create(t,e,i,r,s,a,n,!0,h,!0)}static from(t,e,i,r=null,s=null,a=0,n=!1,h=!0){return o.getItemByClass("tween",Yi)._create(t,e,i,r,s,a,n,!1,h,!0)}to(t,e,i,r=null,s=null,a=0,n=!1){return this._create(t,e,i,r,s,a,n,!0,!1,!0)}from(t,e,i,r=null,s=null,a=0,n=!1){return this._create(t,e,i,r,s,a,n,!1,!1,!0)}_create(t,e,i,r,s,a,h,o,l,_){if(!t)throw new Error("Tween:target is null");this._target=t,this._duration=i,this._ease=r||e.ease||Yi.easeNone,this._complete=s||e.complete,this._delay=a,this._props=[],this._usedTimer=0,this._startTimer=We.now(),this._usedPool=l,this._delayParam=null,this.update=e.update;var u=t.$_GID||(t.$_GID=d.getGID());return Yi.tweenMap[u]?(h&&Yi.clearTween(t),Yi.tweenMap[u].push(this)):Yi.tweenMap[u]=[this],_?a<=0?this.firstStart(t,e,o):(this._delayParam=[t,e,o],n.timer.once(a,this,this.firstStart,this._delayParam)):this._initProps(t,e,o),this}firstStart(t,e,i){this._delayParam=null,t.destroyed?this.clear():(this._initProps(t,e,i),this._beginLoop())}_initProps(t,e,i){for(var r in e)if("number"==typeof t[r]){var s=i?t[r]:e[r],a=i?e[r]:t[r];this._props.push([r,s,a-s]),i||(t[r]=s)}}_beginLoop(){n.timer.frameLoop(1,this,this._doEase)}_doEase(){this._updateEase(We.now())}_updateEase(t){var e=this._target;if(e){if(e.destroyed)return Yi.clearTween(e);var i=this._usedTimer=t-this._startTimer-this._delay;if(!(i<0)){if(i>=this._duration)return this.complete();for(var r=i>0?this._ease(i,0,1,this._duration):0,s=this._props,a=0,n=s.length;a<n;a++){var h=s[a];e[h[0]]=h[1]+r*h[2]}this.update&&this.update.run()}}}set progress(t){var e=t*this._duration;this._startTimer=We.now()-this._delay-e}complete(){if(this._target){n.timer.runTimer(this,this.firstStart);for(var t=this._target,e=this._props,i=this._complete,r=0,s=e.length;r<s;r++){var a=e[r];t[a[0]]=a[1]+a[2]}this.update&&this.update.run(),this._count++,0!=this.repeat&&this._count>=this.repeat?(this.clear(),i&&i.run()):this.restart()}}pause(){var t;n.timer.clear(this,this._beginLoop),n.timer.clear(this,this._doEase),n.timer.clear(this,this.firstStart),(t=We.now()-this._startTimer-this._delay)<0&&(this._usedTimer=t)}setStartTime(t){this._startTimer=t}static clearAll(t){if(t&&t.$_GID){var e=Yi.tweenMap[t.$_GID];if(e){for(var i=0,r=e.length;i<r;i++)e[i]._clear();e.length=0}}}static clear(t){t.clear()}static clearTween(t){Yi.clearAll(t)}clear(){this._target&&(this._remove(),this._clear())}_clear(){this.pause(),n.timer.clear(this,this.firstStart),this._complete=null,this._target=null,this._ease=null,this._props=null,this._delayParam=null,this.repeat=1,this._usedPool&&(this.update=null,o.recover("tween",this))}recover(){this._usedPool=!0,this._clear()}_remove(){var t=Yi.tweenMap[this._target.$_GID];if(t)for(var e=0,i=t.length;e<i;e++)if(t[e]===this){t.splice(e,1);break}}restart(){if(this.pause(),this._usedTimer=0,this._startTimer=We.now(),this._delayParam)n.timer.once(this._delay,this,this.firstStart,this._delayParam);else{for(var t=this._props,e=0,i=t.length;e<i;e++){var r=t[e];this._target[r[0]]=r[1]}n.timer.once(this._delay,this,this._beginLoop)}}resume(){this._usedTimer>=this._duration||(this._startTimer=We.now()-this._usedTimer-this._delay,this._delayParam?this._usedTimer<0?n.timer.once(-this._usedTimer,this,this.firstStart,this._delayParam):this.firstStart.apply(this,this._delayParam):this._beginLoop())}static easeNone(t,e,i,r){return i*t/r+e}}Yi.tweenMap=[];class zi{constructor(){this.ratio=.92,this.maxOffset=60,this._dragging=!1,this._clickOnly=!0}start(t,e,i,r,s,a,h=.92){this.clearTimer(),this.target=t,this.area=e,this.hasInertia=i,this.elasticDistance=e?r:0,this.elasticBackTime=s,this.data=a,this.ratio=h,this._parent=t.parent,this._clickOnly=!0,this._dragging=!0,this._elasticRateX=this._elasticRateY=1,this._lastX=this._parent.mouseX,this._lastY=this._parent.mouseY,n.stage.on(y.MOUSE_UP,this,this.onStageMouseUp),n.stage.on(y.MOUSE_OUT,this,this.onStageMouseUp),n.systemTimer.frameLoop(1,this,this.loop)}clearTimer(){n.systemTimer.clear(this,this.loop),n.systemTimer.clear(this,this.tweenMove),this._tween&&(this._tween.recover(),this._tween=null)}stop(){this._dragging&&(n.stage.off(y.MOUSE_UP,this,this.onStageMouseUp),n.stage.off(y.MOUSE_OUT,this,this.onStageMouseUp),this._dragging=!1,this.target&&this.area&&this.backToArea(),this.clear())}loop(){var t=this._parent.getMousePoint(),e=t.x,i=t.y,r=e-this._lastX,s=i-this._lastY;if(this._clickOnly){if(!(Math.abs(r*n.stage._canvasTransform.getScaleX())>1||Math.abs(s*n.stage._canvasTransform.getScaleY())>1))return;this._clickOnly=!1,this._offsets||(this._offsets=[]),this._offsets.length=0,this.target.event(y.DRAG_START,this.data)}else this._offsets.push(r,s);0===r&&0===s||(this._lastX=e,this._lastY=i,this.target.x+=r*this._elasticRateX,this.target.y+=s*this._elasticRateY,this.area&&this.checkArea(),this.target.event(y.DRAG_MOVE,this.data))}checkArea(){if(this.elasticDistance<=0)this.backToArea();else{if(this.target._x<this.area.x)var t=this.area.x-this.target._x;else t=this.target._x>this.area.x+this.area.width?this.target._x-this.area.x-this.area.width:0;if(this._elasticRateX=Math.max(0,1-t/this.elasticDistance),this.target._y<this.area.y)var e=this.area.y-this.target.y;else e=this.target._y>this.area.y+this.area.height?this.target._y-this.area.y-this.area.height:0;this._elasticRateY=Math.max(0,1-e/this.elasticDistance)}}backToArea(){this.target.x=Math.min(Math.max(this.target._x,this.area.x),this.area.x+this.area.width),this.target.y=Math.min(Math.max(this.target._y,this.area.y),this.area.y+this.area.height)}onStageMouseUp(t){if(n.stage.off(y.MOUSE_UP,this,this.onStageMouseUp),n.stage.off(y.MOUSE_OUT,this,this.onStageMouseUp),n.systemTimer.clear(this,this.loop),!this._clickOnly&&this.target)if(this.hasInertia){this._offsets.length<1&&this._offsets.push(this._parent.mouseX-this._lastX,this._parent.mouseY-this._lastY),this._offsetX=this._offsetY=0;for(var e=this._offsets.length,i=Math.min(e,6),r=this._offsets.length-i,s=e-1;s>r;s--)this._offsetY+=this._offsets[s--],this._offsetX+=this._offsets[s];this._offsetX=this._offsetX/i*2,this._offsetY=this._offsetY/i*2,Math.abs(this._offsetX)>this.maxOffset&&(this._offsetX=this._offsetX>0?this.maxOffset:-this.maxOffset),Math.abs(this._offsetY)>this.maxOffset&&(this._offsetY=this._offsetY>0?this.maxOffset:-this.maxOffset),n.systemTimer.frameLoop(1,this,this.tweenMove)}else this.elasticDistance>0?this.checkElastic():this.clear()}checkElastic(){var t=NaN,e=NaN;if(this.target.x<this.area.x?t=this.area.x:this.target._x>this.area.x+this.area.width&&(t=this.area.x+this.area.width),this.target.y<this.area.y?e=this.area.y:this.target._y>this.area.y+this.area.height&&(e=this.area.y+this.area.height),isNaN(t)&&isNaN(e))this.clear();else{var i={};isNaN(t)||(i.x=t),isNaN(e)||(i.y=e),this._tween=Yi.to(this.target,i,this.elasticBackTime,Xi.sineOut,Hi.create(this,this.clear),0,!1,!1)}}tweenMove(){this._offsetX*=this.ratio*this._elasticRateX,this._offsetY*=this.ratio*this._elasticRateY,this.target.x+=this._offsetX,this.target.y+=this._offsetY,this.area&&this.checkArea(),this.target.event(y.DRAG_MOVE,this.data),(Math.abs(this._offsetX)<1&&Math.abs(this._offsetY)<1||this._elasticRateX<.5||this._elasticRateY<.5)&&(n.systemTimer.clear(this,this.tweenMove),this.elasticDistance>0?this.checkElastic():this.clear())}clear(){if(this.target){this.clearTimer();var t=this.target;this.target=null,this._parent=null,t.event(y.DRAG_END,this.data)}}}class ji{static getGlobalRecByPoints(t,e,i,r,s){var a,n;a=f.create().setTo(e,i),a=t.localToGlobal(a),n=f.create().setTo(r,s),n=t.localToGlobal(n);var h=m._getWrapRec([a.x,a.y,n.x,n.y]);return a.recover(),n.recover(),h}static getGlobalPosAndScale(t){return ji.getGlobalRecByPoints(t,0,0,1,1)}static getTransformRelativeToWindow(t,e,i){var r=n.stage,s=ji.getGlobalPosAndScale(t),a=r._canvasTransform.clone(),h=a.tx,o=a.ty;a.rotate(-Math.PI/180*r.canvasDegree),a.scale(r.clientScaleX,r.clientScaleY);var l,_,u,d,c=r.canvasDegree%180!=0;return c?(l=i+s.y,_=e+s.x,l*=a.d,_*=a.a,90==r.canvasDegree?(l=h-l,_+=o):(l+=h,_=o-_)):(l=e+s.x,_=i+s.y,l*=a.a,_*=a.d,l+=h,_+=o),_+=r._safariOffsetY,c?(u=a.d*s.height,d=a.a*s.width):(u=a.a*s.width,d=a.d*s.height),{x:l,y:_,scaleX:u,scaleY:d}}static fitDOMElementInArea(t,e,i,r,s,a){t._fitLayaAirInitialized||(t._fitLayaAirInitialized=!0,t.style.transformOrigin=t.style.webKittransformOrigin="left top",t.style.position="absolute");var h=ji.getTransformRelativeToWindow(e,i,r);t.style.transform=t.style.webkitTransform="scale("+h.scaleX+","+h.scaleY+") rotate("+n.stage.canvasDegree+"deg)",t.style.width=s+"px",t.style.height=a+"px",t.style.left=h.x+"px",t.style.top=h.y+"px"}static updateOrder(t){if(!t||t.length<2)return!1;for(var e,i,r,s=1,a=t.length;s<a;){for(r=t[e=s],i=t[e]._zOrder;--e>-1&&t[e]._zOrder>i;)t[e+1]=t[e];t[e+1]=r,s++}return!0}}class Ki extends ki{destroy(t=!0){super.destroy(t),this._style&&this._style.recover(),this._cacheStyle&&this._cacheStyle.recover(),this._boundStyle&&this._boundStyle.recover(),this._transform&&this._transform.recover(),this._style=null,this._cacheStyle=null,this._boundStyle=null,this._transform=null,this._graphics&&this._ownGraphics&&this._graphics.destroy(),this._graphics=null,this.texture=null}constructor(){super(),this._x=0,this._y=0,this._width=0,this._height=0,this._visible=!0,this._mouseState=0,this._zOrder=0,this._renderType=0,this._transform=null,this._tfChanged=!1,this._repaint=Mt.REPAINT_NONE,this._texture=null,this._style=si.EMPTY,this._cacheStyle=ri.EMPTY,this._boundStyle=null,this._graphics=null,this._ownGraphics=!1,this.mouseThrough=!1,this.autoSize=!1,this.hitTestPrior=!1}get scene(){return this._scene}updateZOrder(){ji.updateOrder(this._children)&&this.repaint()}_getBoundsStyle(){return this._boundStyle||(this._boundStyle=ii.create()),this._boundStyle}_setCustomRender(){}set customRenderEnable(t){t&&(this._renderType|=Mt.CUSTOM,this._setRenderType(this._renderType),this._setCustomRender())}get cacheAs(){return this._cacheStyle.userSetCache}_setCacheAs(t){}set cacheAs(t){t!==this._cacheStyle.userSetCache&&(this._getCacheStyle().userSetCache=t,this.mask&&"normal"===t||(this._setCacheAs(t),this._checkCanvasEnable(),this.repaint()))}_checkCanvasEnable(){var t=this._cacheStyle.needEnableCanvasRender();this._getCacheStyle().enableCanvasRender=t,t?(this._cacheStyle.needBitmapCache()?this._cacheStyle.cacheAs="bitmap":this._cacheStyle.cacheAs=this._cacheStyle.userSetCache,this._cacheStyle.reCache=!0,this._renderType|=Mt.CANVAS):(this._cacheStyle.cacheAs="none",this._cacheStyle.releaseContext(),this._renderType&=~Mt.CANVAS),this._setCacheAs(this._cacheStyle.cacheAs),this._setRenderType(this._renderType)}get staticCache(){return this._cacheStyle.staticCache}set staticCache(t){this._getCacheStyle().staticCache=t,t||this.reCache()}reCache(){this._cacheStyle.reCache=!0,this._repaint|=Mt.REPAINT_CACHE}getRepaint(){return this._repaint}_setX(t){this._x=t}_setY(t){this._y=t}_setWidth(t,e){}_setHeight(t,e){}get x(){return this._x}set x(t){if(!this._destroyed&&this._x!==t){this._setX(t),this.parentRepaint(Mt.REPAINT_CACHE);var e=this._cacheStyle.maskParent;e&&e.repaint(Mt.REPAINT_CACHE)}}get y(){return this._y}set y(t){if(!this._destroyed&&this._y!==t){this._setY(t),this.parentRepaint(Mt.REPAINT_CACHE);var e=this._cacheStyle.maskParent;e&&e.repaint(Mt.REPAINT_CACHE)}}get width(){return this.get_width()}set width(t){this.set_width(t)}set_width(t){this._width!==t&&(this._width=0==t?1e-7:t,this._setWidth(this.texture,t),this._setTranformChange())}get_width(){return this.autoSize?this.texture?this.texture.width:this._graphics||0!==this._children.length?this.getSelfBounds().width:0:1e-7==this._width?0:this._width?this._width:this.texture?this.texture.width:0}get height(){return this.get_height()}set height(t){this.set_height(t)}set_height(t){this._height!==t&&(this._height=0==t?1e-7:t,this._setHeight(this.texture,t),this._setTranformChange())}get_height(){return this.autoSize?this.texture?this.texture.height:this._graphics||0!==this._children.length?this.getSelfBounds().height:0:1e-7==this._height?0:this._height?this._height:this.texture?this.texture.height:0}get displayWidth(){return this.width*this.scaleX}get displayHeight(){return this.height*this.scaleY}setSelfBounds(t){this._getBoundsStyle().userBounds=t}getBounds(){return this._getBoundsStyle().bounds=m._getWrapRec(this._boundPointsToParent())}getSelfBounds(){return this._boundStyle&&this._boundStyle.userBounds?this._boundStyle.userBounds:this._graphics||0!==this._children.length||this._texture?this._getBoundsStyle().bounds=m._getWrapRec(this._getBoundPointsM(!1)):m.TEMP.setTo(0,0,this.width,this.height)}_boundPointsToParent(t=!1){var e=0,i=0;this._style&&(e=this.pivotX,i=this.pivotY,t=t||0!==this._style.rotation,this._style.scrollRect&&(e+=this._style.scrollRect.x,i+=this._style.scrollRect.y));var r=this._getBoundPointsM(t);if(!r||r.length<1)return r;if(8!=r.length&&(r=t?wt.scanPList(r):m._getWrapRec(r,m.TEMP)._getBoundPoints()),!this.transform)return d.transPointList(r,this._x-e,this._y-i),r;var s,a=f.TEMP,n=r.length;for(s=0;s<n;s+=2)a.x=r[s],a.y=r[s+1],this.toParentPoint(a),r[s]=a.x,r[s+1]=a.y;return r}getGraphicBounds(t=!1){return this._graphics?this._graphics.getBounds(t):m.TEMP.setTo(0,0,0,0)}_getBoundPointsM(t=!1){if(this._boundStyle&&this._boundStyle.userBounds)return this._boundStyle.userBounds._getBoundPoints();this._boundStyle||this._getBoundsStyle();let e=this._boundStyle.temBM;if(e||(e=this._boundStyle.temBM=[]),this._style.scrollRect){e.length=0;var i=m.TEMP;return i.copyFrom(this._style.scrollRect),e.push(...i._getBoundPoints()),e}var r;let s,a,n;this._graphics?r=this._graphics.getBoundPoints():(e.length=0,r=e),this._texture&&((i=m.TEMP).setTo(0,0,this.width||this._texture.width,this.height||this._texture.height),r.push(...i._getBoundPoints())),n=this._children;for(let e=0,i=n.length;e<i;e++)s=n[e],s instanceof Ki&&!0===s._visible&&(a=s._boundPointsToParent(t),a&&(r?r.push(...a):r=a));return r}_getCacheStyle(){return this._cacheStyle===ri.EMPTY&&(this._cacheStyle=ri.create()),this._cacheStyle}getStyle(){return this._style===si.EMPTY&&(this._style=si.create()),this._style}setStyle(t){this._style=t}get scaleX(){return this._style.scaleX}set scaleX(t){this.set_scaleX(t)}_setScaleX(t){this._style.scaleX=t}get scaleY(){return this._style.scaleY}set scaleY(t){this.set_scaleY(t)}_setScaleY(t){this._style.scaleY=t}set_scaleX(t){this.getStyle().scaleX!==t&&(this._setScaleX(t),this._setTranformChange())}get_scaleX(){return this._style.scaleX}set_scaleY(t){this.getStyle().scaleY!==t&&(this._setScaleY(t),this._setTranformChange())}get_scaleY(){return this._style.scaleY}get rotation(){return this._style.rotation}set rotation(t){this.getStyle().rotation!==t&&(this._setRotation(t),this._setTranformChange())}_setRotation(t){this._style.rotation=t}get skewX(){return this._style.skewX}set skewX(t){this.getStyle().skewX!==t&&(this._setSkewX(t),this._setTranformChange())}_setSkewX(t){this._style.skewX=t}get skewY(){return this._style.skewY}set skewY(t){this.getStyle().skewY!==t&&(this._setSkewY(t),this._setTranformChange())}_setSkewY(t){this._style.skewY=t}_createTransform(){return p.create()}_adjustTransform(){this._tfChanged=!1;var t=this._style,e=t.scaleX,i=t.scaleY,r=t.skewX,s=t.skewY,a=t.rotation,n=this._transform||(this._transform=this._createTransform());if(a||1!==e||1!==i||0!==r||0!==s){n._bTransform=!0;var h=.0174532922222222*(a-r),o=.0174532922222222*(a+s),l=Math.cos(o),_=Math.sin(o),u=Math.sin(h),d=Math.cos(h);n.a=e*l,n.b=e*_,n.c=-i*u,n.d=i*d,n.tx=n.ty=0}else n.identity(),this._renderType&=~Mt.TRANSFORM,this._setRenderType(this._renderType);return n}_setTransform(t){}get transform(){return this._tfChanged?this._adjustTransform():this._transform}set transform(t){this.set_transform(t)}get_transform(){return this._tfChanged?this._adjustTransform():this._transform}set_transform(t){this._tfChanged=!1;var e=this._transform||(this._transform=this._createTransform());t.copyTo(e),this._setTransform(e),t&&(this._x=e.tx,this._y=e.ty,e.tx=e.ty=0),t?this._renderType|=Mt.TRANSFORM:this._renderType&=~Mt.TRANSFORM,this._setRenderType(this._renderType),this.parentRepaint()}_setPivotX(t){this.getStyle().pivotX=t}_getPivotX(){return this._style.pivotX}_setPivotY(t){this.getStyle().pivotY=t}_getPivotY(){return this._style.pivotY}get pivotX(){return this._getPivotX()}set pivotX(t){this._setPivotX(t),this.repaint()}get pivotY(){return this._getPivotY()}set pivotY(t){this._setPivotY(t),this.repaint()}_setAlpha(t){this._style.alpha!==t&&(this.getStyle().alpha=t,1!==t?this._renderType|=Mt.ALPHA:this._renderType&=~Mt.ALPHA,this._setRenderType(this._renderType),this.parentRepaint())}_getAlpha(){return this._style.alpha}get alpha(){return this._getAlpha()}set alpha(t){t=t<0?0:t>1?1:t,this._setAlpha(t)}get visible(){return this.get_visible()}set visible(t){this.set_visible(t)}get_visible(){return this._visible}set_visible(t){this._visible!==t&&(this._visible=t,this.parentRepaint(Mt.REPAINT_ALL))}_setBlendMode(t){}get blendMode(){return this._style.blendMode}set blendMode(t){this._setBlendMode(t),this.getStyle().blendMode=t,t&&"source-over"!=t?this._renderType|=Mt.BLEND:this._renderType&=~Mt.BLEND,this._setRenderType(this._renderType),this.parentRepaint()}get graphics(){return this._graphics||(this.graphics=new Ui,this._ownGraphics=!0),this._graphics}_setGraphics(t){}set graphics(t){this._graphics&&(this._graphics._sp=null),this._graphics=t,t?(this._setGraphics(t),this._renderType|=Mt.GRAPHICS,t._sp=this):this._renderType&=~Mt.GRAPHICS,this._setRenderType(this._renderType),this.repaint()}get scrollRect(){return this._style.scrollRect}_setScrollRect(t){}set scrollRect(t){this.getStyle().scrollRect=t,this._setScrollRect(t),t?this._renderType|=Mt.CLIP:this._renderType&=~Mt.CLIP,this._setRenderType(this._renderType),this.repaint()}pos(t,e,i=!1){if(this._x!==t||this._y!==e){if(this._destroyed)return this;if(i){this._setX(t),this._setY(e),this.parentRepaint(Mt.REPAINT_CACHE);var r=this._cacheStyle.maskParent;r&&r.repaint(Mt.REPAINT_CACHE)}else this.x=t,this.y=e}return this}pivot(t,e){return this.pivotX=t,this.pivotY=e,this}size(t,e){return this.width=t,this.height=e,this}scale(t,e,i=!1){var r=this.getStyle();if(r.scaleX!=t||r.scaleY!=e){if(this._destroyed)return this;i?(this._setScaleX(t),this._setScaleY(e),this._setTranformChange()):(this.scaleX=t,this.scaleY=e)}return this}skew(t,e){return this.skewX=t,this.skewY=e,this}render(t,e,i){se.renders[this._renderType]._fun(this,t,e+this._x,i+this._y),this._repaint=0}drawToCanvas(t,e,i,r){return Ki.drawToCanvas(this,this._renderType,t,e,i,r)}drawToTexture(t,e,i,r,s=null,a=!1){Y.InvertY=a;let n=Ki.drawToTexture(this,this._renderType,t,e,i,r,s);return Y.InvertY=!1,n}drawToTexture3D(t,e,i){throw"not implement"}static drawToCanvas(t,e,i,r,s,a){s-=t.x,a-=t.y,s|=0,a|=0,i|=0,r|=0;var n=new Je;n.size(i,r),n.asBitmap=!0,n._targets.start(),n._targets.clear(0,0,0,0),se.renders[e]._fun(t,n,s,a),n.flush(),n._targets.end(),n._targets.restore();var h=n._targets.getData(0,0,i,r);n.destroy();for(var o=new ImageData(i,r),l=4*i,_=o.data,u=r-1,d=u*l,c=0;u>=0;u--)_.set(h.subarray(c,c+l),d),d-=l,c+=l;var p=new ei(!0);return p.size(i,r),p.getContext("2d").putImageData(o,0,0),p}static drawToTexture(t,e,i,r,s,a,n=null){Ki.drawtocanvCtx||(Ki.drawtocanvCtx=new Je),s-=t.x,a-=t.y,s|=0,a|=0,i|=0,r|=0;var h=n?Ki.drawtocanvCtx:new Je;if(h.clear(),h.size(i,r),n?h._targets=n:h.asBitmap=!0,h._targets){h._targets.start();let i=J._clearColor;h._targets.clear(i.r,i.g,i.b,i.a),h._drawingToTexture=!0,se.renders[e]._fun(t,h,s,a),h._drawingToTexture=!1,h.flush(),h._targets.end(),h._targets.restore(),h._targets=null}if(!n){var o=new ht(h._targets,ht.INV_UV);return h.destroy(!0),o}return t._repaint=0,n}customRender(t,e,i){this._repaint=Mt.REPAINT_ALL}_applyFilters(){}get filters(){return this._cacheStyle.filters}set filters(t){t&&0===t.length&&(t=null),this._getCacheStyle().filters=t?t.slice():null,t?this._renderType|=Mt.FILTERS:this._renderType&=~Mt.FILTERS,this._setRenderType(this._renderType),t&&t.length>0?(this._getBit(r.DISPLAY)||this._setBitUp(r.DISPLAY),1==t.length&&t[0]instanceof At||(this._getCacheStyle().cacheForFilters=!0,this._checkCanvasEnable())):this._cacheStyle.cacheForFilters&&(this._cacheStyle.cacheForFilters=!1,this._checkCanvasEnable()),this._getCacheStyle().hasGlowFilter=this._isHaveGlowFilter(),this.repaint()}_isHaveGlowFilter(){var t,e;if(this.filters)for(t=0;t<this.filters.length;t++)if(this.filters[t].type==yt.GLOW)return!0;for(t=0,e=this._children.length;t<e;t++)if(this._children[t]._isHaveGlowFilter())return!0;return!1}localToGlobal(t,e=!1,i=null){!0===e&&(t=new f(t.x,t.y));var r=this;for(i=i||n.stage;r&&!r._destroyed&&r!=i;)t=r.toParentPoint(t),r=r.parent;return t}globalToLocal(t,e=!1,i=null){e&&(t=new f(t.x,t.y));var r=this,s=[];for(i=i||n.stage;r&&!r._destroyed&&r!=i;)s.push(r),r=r.parent;for(var a=s.length-1;a>=0;)t=(r=s[a]).fromParentPoint(t),a--;return t}toParentPoint(t){if(!t)return t;t.x-=this.pivotX,t.y-=this.pivotY,this.transform&&this._transform.transformPoint(t),t.x+=this._x,t.y+=this._y;var e=this._style.scrollRect;return e&&(t.x-=e.x,t.y-=e.y),t}fromParentPoint(t){if(!t)return t;t.x-=this._x,t.y-=this._y;var e=this._style.scrollRect;return e&&(t.x+=e.x,t.y+=e.y),this.transform&&this._transform.invertTransformPoint(t),t.x+=this.pivotX,t.y+=this.pivotY,t}onStartListeningToType(t){super.onStartListeningToType(t),1!==this._mouseState&&y.isMouseEvent(t)&&(this.mouseEnabled=!0,this._setBit(r.HAS_MOUSE,!0),this._parent&&this._onDisplay())}_onDisplay(t){if(1!==this._mouseState){var e=this;for(e=e.parent;e&&1!==e._mouseState&&!e._getBit(r.HAS_MOUSE);)e.mouseEnabled=!0,e._setBit(r.HAS_MOUSE,!0),e=e.parent}}_setParent(t){super._setParent(t),t&&this._getBit(r.HAS_MOUSE)&&this._onDisplay()}loadImage(t,e=null){if(t){let i=n.loader.getRes(t);i?(this.texture=i,this.repaint(Mt.REPAINT_ALL),e&&e.run()):(this._skinBaseUrl&&(t=_t.formatURL(t,this._skinBaseUrl)),n.loader.load(t).then((t=>{this.texture=t,this.repaint(Mt.REPAINT_ALL),e&&e.run()})))}else this.texture=null,this.repaint(Mt.REPAINT_ALL),e&&e.run();return this}static fromImage(t){return(new Ki).loadImage(t)}repaint(t=Mt.REPAINT_CACHE){this._repaint&t||(this._repaint|=t,this.parentRepaint(t)),this._cacheStyle&&this._cacheStyle.maskParent&&this._cacheStyle.maskParent.repaint(t)}_needRepaint(){return this._repaint&Mt.REPAINT_CACHE&&this._cacheStyle.enableCanvasRender&&this._cacheStyle.reCache}_childChanged(t=null){super._childChanged(t),this._children.length?this._renderType|=Mt.CHILDS:this._renderType&=~Mt.CHILDS,this._setRenderType(this._renderType),t&&this._getBit(r.HAS_ZORDER)&&n.systemTimer.callLater(this,this.updateZOrder),this.repaint(Mt.REPAINT_ALL)}parentRepaint(t=Mt.REPAINT_CACHE){var e=this._parent;!e||e._repaint&t||(e._repaint|=t,e.parentRepaint(t))}get stage(){return n.stage}get hitArea(){return this._style.hitArea}set hitArea(t){this.getStyle().hitArea=t}_setMask(t){}get mask(){return this._cacheStyle.mask}set mask(t){t&&this.mask==t&&t._cacheStyle.maskParent==this||(this.mask&&(this.mask._getCacheStyle().maskParent=null),this._getCacheStyle().mask=t,this._setMask(t),this._checkCanvasEnable(),t?(t._getCacheStyle().maskParent=this,this._renderType|=Mt.MASK):this._renderType&=~Mt.MASK,this._setRenderType(this._renderType),this.repaint())}get mouseEnabled(){return this._mouseState>1}set mouseEnabled(t){this._mouseState=t?2:1}startDrag(t=null,e=!1,i=0,r=300,s=null,a=.92){this._style.dragging||(this.getStyle().dragging=new zi),this._style.dragging.start(this,t,e,i,r,s,a)}stopDrag(){this._style.dragging&&this._style.dragging.stop()}_setDisplay(t){t||this._cacheStyle&&(this._cacheStyle.releaseContext(),this._cacheStyle.releaseFilterCache(),this._cacheStyle.hasGlowFilter&&(this._cacheStyle.hasGlowFilter=!1)),super._setDisplay(t)}hitTestPoint(t,e){var i=this.globalToLocal(f.TEMP.setTo(t,e));return t=i.x,e=i.y,(this._style.hitArea?this._style.hitArea:this._width>0&&this._height>0?m.TEMP.setTo(0,0,this._width,this._height):this.getSelfBounds()).contains(t,e)}getMousePoint(){return this.globalToLocal(f.TEMP.setTo(n.stage.mouseX,n.stage.mouseY))}get globalScaleX(){for(var t=1,e=this;e&&e!==n.stage;)t*=e.scaleX,e=e.parent;return t}get globalRotation(){for(var t=0,e=this;e&&e!==n.stage;)t+=e.rotation,e=e.parent;return t}get globalScaleY(){for(var t=1,e=this;e&&e!==n.stage;)t*=e.scaleY,e=e.parent;return t}get mouseX(){return this.getMousePoint().x}get mouseY(){return this.getMousePoint().y}get zOrder(){return this._zOrder}set zOrder(t){this._zOrder!=t&&(this._zOrder=t,this._parent&&(t&&this._parent._setBit(r.HAS_ZORDER,!0),n.systemTimer.callLater(this._parent,this.updateZOrder)))}get texture(){return this._texture}_setTexture(t){}set texture(t){"string"==typeof t?this.loadImage(t):this._texture!=t&&(this._texture&&this._texture._removeReference(),this._texture=t,t&&t._addReference(),this._setTexture(t),this._setWidth(this._texture,this.width),this._setHeight(this._texture,this.height),t?this._renderType|=Mt.TEXTURE:this._renderType&=~Mt.TEXTURE,this._setRenderType(this._renderType),this.repaint())}get viewport(){return this._style.viewport}set viewport(t){var e;"string"==typeof t&&((e=t.split(",")).length>3&&(t=new m(parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3]))));this.getStyle().viewport=t}_setRenderType(t){}_setTranformChange(){this._tfChanged=!0,this._renderType|=Mt.TRANSFORM,this.parentRepaint(Mt.REPAINT_CACHE)}_setBgStyleColor(t,e,i,r,s){}_setBorderStyleColor(t,e,i,r,s,a){}set drawCallOptimize(t){this._setBit(r.DRAWCALL_OPTIMIZE,t)}get drawCallOptimize(){return this._getBit(r.DRAWCALL_OPTIMIZE)}onAfterDeserialize(){super.onAfterDeserialize(),h.isPlaying&&(this._gcmds&&(this.graphics.cmds=this._gcmds,delete this._gcmds),this._filters&&(this.filters=this._filters,delete this._filters))}}class qi extends Ki{constructor(){super(),this.wrapMode=0,this._interval=e.animationInterval,this._isReverse=!1,this._frameRateChanged=!1,this._setBitUp(r.DISPLAY)}play(t=0,e=!0,i=""){this._isPlaying=!0,this._actionName=i,this.index="string"==typeof t?this._getFrameByLabel(t):t,this.loop=e,this._isReverse=this.wrapMode===qi.WRAP_REVERSE,0==this.index&&this._isReverse&&(this.index=this.count-1),this.interval>0&&this.timerLoop(this.interval,this,this._frameLoop,null,!0,!0)}get interval(){return this._interval}set interval(t){this._interval!=t&&(this._frameRateChanged=!0,this._interval=t,this._isPlaying&&t>0&&this.timerLoop(t,this,this._frameLoop,null,!0,!0))}_getFrameByLabel(t){for(var e=0;e<this._count;e++){var i=this._labels[e];if(i&&i.indexOf(t)>-1)return e}return 0}_frameLoop(){if(this._controlNode&&!this._controlNode._destroyed){if(this._isReverse){if(this._index--,this._index<0){if(!this.loop)return this._index=0,this.stop(),void this.event(y.COMPLETE);this.wrapMode==qi.WRAP_PINGPONG?(this._index=this._count>0?1:0,this._isReverse=!1):this._index=this._count-1,this.event(y.COMPLETE)}}else if(this._index++,this._index>=this._count){if(!this.loop)return this._index--,this.stop(),void this.event(y.COMPLETE);this.wrapMode==qi.WRAP_PINGPONG?(this._index=this._count-2>=0?this._count-2:0,this._isReverse=!0):this._index=0,this.event(y.COMPLETE)}this.index=this._index}else this.clearTimer(this,this._frameLoop)}_setControlNode(t){this._controlNode&&(this._controlNode.off(y.DISPLAY,this,this._resumePlay),this._controlNode.off(y.UNDISPLAY,this,this._resumePlay)),this._controlNode=t,t&&t!=this&&(t.on(y.DISPLAY,this,this._resumePlay),t.on(y.UNDISPLAY,this,this._resumePlay))}_setDisplay(t){super._setDisplay(t),this._resumePlay()}_resumePlay(){this._isPlaying&&(this._controlNode.displayedInStage?this.play(this._index,this.loop,this._actionName):this.clearTimer(this,this._frameLoop))}stop(){this._isPlaying=!1,this.clearTimer(this,this._frameLoop)}get isPlaying(){return this._isPlaying}addLabel(t,e){this._labels||(this._labels={}),this._labels[e]||(this._labels[e]=[]),this._labels[e].push(t)}removeLabel(t){if(t){if(this._labels)for(var e in this._labels)this._removeLabelFromList(this._labels[e],t)}else this._labels=null}_removeLabelFromList(t,e){if(t)for(var i=t.length-1;i>=0;i--)t[i]==e&&t.splice(i,1)}gotoAndStop(t){this.index="string"==typeof t?this._getFrameByLabel(t):t,this.stop()}get index(){return this._index}set index(t){if(this._index=t,this._displayToIndex(t),this._labels&&this._labels[t])for(var e=this._labels[t],i=0,r=e.length;i<r;i++)this.event(y.LABEL,e[i])}_displayToIndex(t){}get count(){return this._count}clear(){return this.stop(),this._labels=null,this}}qi.WRAP_POSITIVE=0,qi.WRAP_REVERSE=1,qi.WRAP_PINGPONG=2;class $i{static enable(t,e=null){n.loader.fetch(t,"json").then((t=>{t&&($i.addToDict(t),e&&e.run())}))}static addToDict(t){for(let e in t){let i=t[e],r=_t.formatURL(i[0]);i=i[1];let s=i.length,a={url:e};for(let t=0;t<s;t++)$i._fileLoadDic[r+i[t]]=a}}static getFileLoadPath(t){return $i._fileLoadDic[t]}}$i._fileLoadDic={};class Zi extends R{constructor(){super(),this.worker=new Worker(Zi.workerPath),this.worker.onmessage=t=>{this.workerMessage(t.data)}}static __init__(){Zi.I||Worker&&(Zi.I=new Zi)}static workerSupported(){return!!Worker}static enableWorkerLoader(){Zi.enable=!0}static set enable(t){Zi._enable!=t&&(Zi._enable=t,t&&(null==Zi.I&&Zi.__init__(),null==Zi.I.worker&&(Zi._enable=!1)))}static get enable(){return Zi._enable}workerMessage(t){if(t)switch(t.type){case"Image":this.imageLoaded(t);break;case"Disable":Zi.enable=!1}}imageLoaded(t){if(t.dataType&&"imageBitmap"==t.dataType){var e=t.imageBitmap;console.log("load:",t.url),this.event(t.url,e)}else this.event(t.url,null)}}Zi.workerPath="libs/workerloader.js",Zi._enable=!1;class Qi extends M{constructor(t,e,i){super(),this.dir=t,this.textures=e,this.frames=i,this.lock=!0}_disposeResource(){for(let t of this.textures)t&&t.destroy();for(let t of this.frames)t.destroy();this.frames.length=0,this.textures.length=0}}class Ji{constructor(t){this._callback=t,this._items=[],this._weights=[],this._progress=0}get itemCount(){return this._items.length}reset(){this._items.length=0,this._weights.length=0,this._progress=0}createCallback(t){let e=this._items.length;return this._items.push(0),null==t?this._weights.push(null):this._weights.push(Math.max(0,Math.min(t,1))),t=>this.update(e,t)}update(t,e){if(-1!=t){this._items[t]=Math.max(0,Math.min(e,1));let i=0,r=this._items,s=this._weights,a=1/r.length;for(let t=0;t<r.length;t++){let e=r[t],n=s[t];null!=e&&(i+=e*(null!=n?n:a))}e=i}e>this._progress&&(this._progress=e,this._callback(e))}}class tr{static compareVersion(t,e){let i=t.split("."),r=e.split(".");const s=Math.max(i.length,r.length);for(;i.length<s;)i.push("0");for(;r.length<s;)r.push("0");for(let t=0;t<s;t++){const e=parseInt(i[t]),s=parseInt(r[t]);if(e>s)return!0;if(e<s)return!1}return!0}static get isSupport(){if(We.onMiniGame){var t=We.window.wx.getSystemInfoSync().SDKVersion;return tr.compareVersion(t,"2.14.0")}return!!We.onLayaRuntime||!!We.window.Blob&&!!We.window.Blob}static arrayBufferToURL(t,e){if(!tr.isSupport)return null;if(tr.data[t])return tr.data[t];var i="";if(We.onMiniGame||We.onLayaRuntime)i=We.window.wx.createBufferURL(e);else if(We.window.Blob){let t=new Blob([e],{type:"application/octet-binary"});i=We.window.URL.createObjectURL(t)}return tr.isSavaData&&(tr.data[t]=i),i}static _arrayBufferToURL(t){if(!tr.isSupport)return null;var e="";if(We.onMiniGame||We.onLayaRuntime)e=We.window.wx.createBufferURL(t);else if(We.window.Blob){let i=new Blob([t],{type:"application/octet-binary"});e=We.window.URL.createObjectURL(i)}return e}static destroy(t){if(tr.isSupport){var e=tr.data[t];e&&(We.onMiniGame||We.onLayaRuntime?We.window.wx.revokeBufferURL(e):We.window.Blob&&We.window.URL.revokeObjectURL(e),delete tr.data[t])}}}tr.data={},tr.isSavaData=!1;class er extends R{constructor(){super(...arguments),this._http=new XMLHttpRequest}send(t,e=null,i="get",r="text",s=null){this._responseType=r,this._data=null,(We.onVVMiniGame||We.onQGMiniGame||We.onQQMiniGame||We.onAlipayMiniGame||We.onBLMiniGame||We.onHWMiniGame||We.onTTMiniGame||We.onTBMiniGame)&&(t=er._urlEncode(t)),this._url=t;let a=this._http;if(a.open(i,t,!0),s)for(let t=0;t<s.length;t++)a.setRequestHeader(s[t++],s[t]);e?"string"==typeof e?a.setRequestHeader("Content-Type","application/x-www-form-urlencoded"):(a.setRequestHeader("Content-Type","application/json"),e instanceof ArrayBuffer||(e=JSON.stringify(e))):We.onBLMiniGame&&We.onAndroid&&(e={});let n="arraybuffer"!==r?"text":"arraybuffer";a.responseType=n,a.dataType&&(a.dataType=n),a.onerror=t=>{this._onError(t)},a.onabort=t=>{this._onAbort(t)},a.onprogress=t=>{this._onProgress(t)},a.onload=t=>{this._onLoad(t)},a.send(e)}_onProgress(t){t&&t.lengthComputable&&this.event(y.PROGRESS,t.loaded/t.total)}_onAbort(t){this.error("Request was aborted by user")}_onError(t){this.error("Request failed Status:"+this._http.status+" text:"+this._http.statusText)}_onLoad(t){var e=this._http,i=void 0!==e.status?e.status:200;200===i||204===i||0===i?this.complete():this.error("["+e.status+"]"+e.statusText+":"+e.responseURL)}error(t){this.clear(),this.event(y.ERROR,t)}complete(){this.clear();var t=!0;try{"json"===this._responseType?this._data=JSON.parse(this._http.responseText):"xml"===this._responseType?this._data=d.parseXMLFromString(this._http.responseText):this._data=this._http.response||this._http.responseText}catch(e){t=!1,this.error(e.message)}t&&this.event(y.COMPLETE,this._data instanceof Array?[this._data]:this._data)}clear(){var t=this._http;t.onerror=t.onabort=t.onprogress=t.onload=null}get url(){return this._url}get data(){return this._data}get http(){return this._http}reset(){this.offAll(),this._data=null}}er._urlEncode=encodeURI;class ir{constructor(){this.httpRequestPool=[]}common(t,e,i,r,s,a){let n=this.getRequestInst();n.on(y.COMPLETE,(()=>{let t=n.data;this.returnRequestInst(n),a(t)})),n.on(y.ERROR,null,(t=>{this.returnRequestInst(n),a(null,t)})),s&&n.on(y.PROGRESS,s),n.send(e,null,"get",r),t.$ref=n}image(t,e,i,r,s){let a=new We.window.Image;a.crossOrigin="",a.onload=()=>{a.onload=null,a.onerror=null,s(a)},a.onerror=()=>{a.onload=null,a.onerror=null,s(null,"")},a.src=e,t.$ref=a}imageWithBlob(t,e,i,r,s){let a=tr.arrayBufferToURL(i,e);this.image(t,a,i,r,s)}imageWithWorker(t,e,i,r,s){if(Zi.enableWorkerLoader(),Zi.enable){let t=Zi.I;t.once(e,null,(t=>{t?s(t):s(null,"workerloader failed!")})),t.worker.postMessage(e)}else this.image(t,e,i,r,s)}audio(t,e,i,r,s){let a=We.createElement("audio");a.crossOrigin="",a.oncanplaythrough=()=>{a.oncanplaythrough=null,a.onerror=null,s(a)},a.onerror=()=>{a.oncanplaythrough=null,a.onerror=null,s(null,"")},a.src=e,t.$ref=a}getRequestInst(){return 0==this.httpRequestPool.length||We.onVVMiniGame||We.onHWMiniGame?new er:this.httpRequestPool.pop()}returnRequestInst(t){t.reset(),this.httpRequestPool.length<10&&this.httpRequestPool.push(t)}}var rr=0;const sr={ext:null,typeId:null,main:!1,loaderType:null};class ar extends R{static registerLoader(t,e,i){let r;i?(r=ar.typeMap[i],r?r.loaderType!=e&&(r={typeId:r.typeId,loaderType:e}):ar.typeMap[i]=r={typeId:rr++,loaderType:e}):r={typeId:rr++,loaderType:e};for(let s of t){let t=ar.extMap[s];if(t&&i){let i=t.findIndex((t=>t.typeId==r.typeId));-1==i?t.push(r):t[i].loaderType=e}else ar.extMap[s]=[r]}}constructor(){super(),this.retryNum=1,this.retryDelay=0,this.maxLoader=5,this._loadings=new Map,this._queue=[],this._downloadings=new Set}get loading(){return this._loadings.size>0}load(t,e,i,r,s,a,n,h,o){let l,_,u,d,c=or;if(e instanceof Hi?(l=e,_=r):"string"==typeof e?_=e:null!=e&&(_=e.type,c=e),null==s&&null==a&&null==n&&null==o||(c=c===or?{priority:s,cache:a,group:n,useWorkerLoader:o}:Object.assign(c,{priority:s,cache:a,group:n,useWorkerLoader:o})),u=i instanceof Hi?t=>i.runWith(t):i,Array.isArray(t)){let e;u&&(e=new Ji(u));let i=[];for(let r=0;r<t.length;r++){let s=t[r];s&&("string"==typeof s?i.push(this._load1(s,_,c,null==e?void 0:e.createCallback())):i.push(this._load1(s.url,s.type||_,c!==or?Object.assign({},c,s):s,null==e?void 0:e.createCallback())))}d=Promise.all(i)}else d="string"==typeof t?this._load1(t,_,c,u):this._load1(t.url,t.type||_,c!==or?Object.assign({},c,t):t,u);return l?d.then((t=>(l.runWith(t),t))):d}_load1(t,e,i,r){let s=null;if(t.startsWith("res://")){s=t.substring(6);let a=lt.inst.UUID_to_URL(s);if(!a){let a=lt.inst.UUID_to_URL_async(s);return a?a.then((a=>a?this._load2(a,s,e,i,r):(!i.silent&&ar.warn(t),null))):(!i.silent&&ar.warn(t),Promise.resolve(null))}t=a}else{let s=lt.inst.URL_to_UUID_async(t);if(s)return s.then((s=>this._load2(t,s,e,i,r)))}return this._load2(t,s,e,i,r)}_load2(t,e,i,r,s){let{ext:a,typeId:n,main:h,loaderType:o}=ar.getURLInfo(t,i);if(!o)return!r.silent&&ar.warn(t),Promise.resolve(null);let l,_=_t.formatURL(t);if(r.group){let t=ar.groupMap[r.group];t||(t=ar.groupMap[r.group]=new Set),t.add(_)}if(null==r.cache||r.cache){let t=ar._getRes(_,i);if(void 0!==t){if(null==t)return Promise.resolve(null);if(!(t instanceof M))return Promise.resolve(t);if(t.obsolute&&(l=t),!(l||t.uuid&&e&&e!=t.uuid))return Promise.resolve(t)}}let u=_;h||(u+="@"+n);let d=this._loadings.get(u);if(d)return s&&d.onProgress.add(s),new Promise((t=>d.onComplete.add(t)));let c=$i.getFileLoadPath(_);if(c)return this.load(c.url,{type:ar.ATLAS,baseUrl:c.baseUrl}).then((()=>ar.getRes(t,i)));d=hr.length>0?hr.pop():new nr,d.type=i,d.url=t,d.uuid=e,d.ext=a,delete(r=Object.assign(d.options,r)).type,null==r.priority&&(r.priority=0),null==r.useWorkerLoader&&(r.useWorkerLoader=Zi.enable),s&&d.onProgress.add(s),d.loader=this,d.obsoluteInst=l;let p,f=new o;this._loadings.set(u,d);try{p=f.load(d)}catch(e){!r.silent&&ar.warn(t,e),p=Promise.resolve(null)}return p.then((i=>(i instanceof M&&i._setCreateURL(t,e),(null==d.options.cache||d.options.cache)&&ar._cacheRes(_,i,n,h),d.progress.update(-1,1),d.onComplete.invoke(i),i))).catch((e=>(!r.silent&&ar.warn(t,e),(null==d.options.cache||d.options.cache)&&ar._cacheRes(_,null,n,h),d.onComplete.invoke(null),null))).then((t=>(this._loadings.delete(u),d.reset(),hr.push(d),0==this._loadings.size&&this.event(y.COMPLETE),t)))}fetch(t,e,i,r){var s;let a={originalUrl:t,url:t,contentType:e,priority:null!==(s=(r=r||or).priority)&&void 0!==s?s:1,retryCnt:0,onProgress:i,onComplete:null};return r.useWorkerLoader&&(a.useWorkerLoader=!0),r.blob&&(a.blob=r.blob),r.noRetry&&(a.retryCnt=-1),r.silent&&(a.silent=!0),new Promise((e=>{lt.inst.resolveURL(t,(t=>{a.url=_t.formatURL(t),a.onComplete=e,this.queueToDownload(a)}))}))}queueToDownload(t){if(this._downloadings.size<this.maxLoader)return void this.download(t);let e=t.priority;if(0==e)this._queue.push(t);else{let i=this._queue.findIndex((t=>t.priority<e));-1!=i?this._queue.splice(i,0,t):this._queue.push(t)}}download(t){this._downloadings.add(t);let e=_t.postFormatURL(t.url);if("image"==t.contentType){let i=ar.preLoadedMap[t.url];if(i){if(!(i instanceof ArrayBuffer))return void this.completeItem(t,i);t.blob=i}t.blob?ar.downloader.imageWithBlob(t,t.blob,t.originalUrl,t.onProgress,((e,i)=>{e||(t.retryCnt=-1),this.completeItem(t,e,i)})):t.useWorkerLoader?ar.downloader.imageWithWorker(t,e,t.originalUrl,t.onProgress,((e,i)=>{e||(t.useWorkerLoader=!1),this.completeItem(t,e,i)})):ar.downloader.image(t,e,t.originalUrl,t.onProgress,((e,i)=>this.completeItem(t,e,i)))}else if("sound"==t.contentType)ar.downloader.audio(t,e,t.originalUrl,t.onProgress,((e,i)=>this.completeItem(t,e,i)));else{let i=ar.preLoadedMap[t.url];if(i)return void this.completeItem(t,i);ar.downloader.common(t,e,t.originalUrl,t.contentType,t.onProgress,((e,i)=>this.completeItem(t,e,i)))}}completeItem(t,e,i){this._downloadings.delete(t),e?(this._downloadings.size<this.maxLoader&&this._queue.length>0&&this.download(this._queue.shift()),t.onProgress&&t.onProgress(1),t.onComplete(e)):-1!=t.retryCnt&&t.retryCnt<this.retryNum?(t.retryCnt++,t.silent||console.debug(`Retry to load ${t.url} (${t.retryCnt})`),n.systemTimer.once(this.retryDelay,this,this.queueToDownload,[t],!1)):(!t.silent&&ar.warn(t.url),t.onProgress&&t.onProgress(1),this._downloadings.size<this.maxLoader&&this._queue.length>0&&this.download(this._queue.shift()),t.onComplete(null))}static getURLInfo(t,e){let i,r,s,a,n=t.startsWith("data:")?"png":d.getFileExtension(t);if(n.length>0&&(i=ar.extMap[n]),e){let t=ar.typeMap[e];if(!t)return console.warn(`not recognize type: '${e}'`),sr;r=t.typeId;let n=0;i?i[0].typeId===r||-1!=(n=i.findIndex((t=>t.typeId===r)))?(s=0==n,a=i[n].loaderType):(s=!1,a=t.loaderType):(s=e!=ar.TEXTURE2D,a=t.loaderType)}else{if(!i)return console.warn(`not recognize the resource suffix: '${t}'`),sr;s=!0,r=i[0].typeId,a=i[0].loaderType}return{ext:n,main:s,typeId:r,loaderType:a}}static warn(t,e){console.warn(`Failed to load ${t}`+(e?":"+e:""))}static getRes(t,e){return t=_t.formatURL(t),ar._getRes(t,e)||null}static _getRes(t,e){let i,r=ar.loadedMap[t];if(r){if(e){let t=ar.typeMap[e];if(!t)return;if(2==r.length)r[0]==t.typeId&&(i=r[1]);else{let e=r.indexOf(t.typeId);-1!=e&&(i=r[e+1])}}else i=r[1];return i instanceof M&&i.destroyed?void 0:i}}static getTexture2D(t){return ar.getRes(t,ar.TEXTURE2D)}static getBaseTexture(t){return ar.getRes(t,ar.TEXTURE2D)}static getAtlas(t){return ar.getRes(t,ar.ATLAS)}getRes(t,e){return ar.getRes(t,e)}static createNodes(t){var e;return null===(e=ar.getRes(t))||void 0===e?void 0:e.create()}static cacheRes(t,e,i){t=_t.formatURL(t);let r=ar.getURLInfo(t,i);null!=r.typeId&&ar._cacheRes(t,e,r.typeId,r.main)}static _cacheRes(t,e,i,r){let s=ar.loadedMap[t];if(r)s?(s[0]=i,s[1]=e):s=ar.loadedMap[t]=[i,e];else if(s){let t=s.findIndex((t=>t===i));-1!=t?s[t+1]=e:s.push(i,e)}else s=ar.loadedMap[t]=[null,void 0,i,e]}cacheRes(t,e,i){ar.cacheRes(t,e,i)}static clearRes(t,e){t=_t.formatURL(t),ar._clearRes(t,e)}clearRes(t,e){t=_t.formatURL(t),ar._clearRes(t,e)}static _clearRes(t,e){let i=ar.loadedMap[t];if(i)if(e){if(i[1]==e)2==i.length?delete ar.loadedMap[t]:i[1]=void 0;else{let r=i.indexOf(e);if(-1==r)return;4==i.length&&null==i[0]?delete ar.loadedMap[t]:i.splice(r-1,2)}e instanceof M&&!e.destroyed&&e.destroy()}else if(delete ar.loadedMap[t],i.length>2)for(let t=1;t<i.length;t+=2){let e=i[t];e instanceof M&&!e.destroyed&&e.destroy()}else{let t=i[1];t instanceof M&&!t.destroyed&&t.destroy()}}clearTextureRes(t){t=_t.formatURL(t);let e=ar.loadedMap[t];if(!e)return;let i=e[0];if(i instanceof ht)i.disposeBitmap();else if(i instanceof Qi)for(let t of i.textures)t.disposeBitmap()}static setGroup(t,e){t=_t.formatURL(t);let i=ar.groupMap[e];i||(i=ar.groupMap[e]=new Set),i.add(t)}static clearResByGroup(t){let e=ar.groupMap[t];if(e)for(let t of e)ar._clearRes(t)}clearUnLoaded(){if(0==this._queue.length)return;let t=this._queue.concat();this._queue.length=0;for(let e of t)e.onComplete(null)}cancelLoadByUrls(t){if(t)for(var e=0,i=t.length;e<i;e++)this.cancelLoadByUrl(t[e])}cancelLoadByUrl(t){t=_t.formatURL(t);let e=this._queue.findIndex((e=>e.url==t));if(-1!=e){let t=this._queue[e];this._queue.splice(e,1),t.onComplete(null)}}}ar.TEXT="text",ar.JSON="json",ar.XML="xml",ar.BUFFER="arraybuffer",ar.IMAGE="image",ar.SOUND="sound",ar.VIDEO="video",ar.ATLAS="atlas",ar.FONT="font",ar.TTF="ttf",ar.HIERARCHY="HIERARCHY",ar.MESH="MESH",ar.MATERIAL="MATERIAL",ar.TEXTURE2D="TEXTURE2D",ar.TEXTURECUBE="TEXTURE2D",ar.ANIMATIONCLIP="ANIMATIONCLIP",ar.TERRAINHEIGHTDATA="TERRAINHEIGHTDATA",ar.TERRAINRES="TERRAIN",ar.SPINE="SPINE",ar.extMap={},ar.typeMap={},ar.downloader=new ir,ar.groupMap={},ar.loadedMap={},ar.preLoadedMap={};class nr{constructor(){this.options={},this.onProgress=new E,this.onComplete=new E,this.progress=new Ji((t=>this.onProgress.invoke(t)))}reset(){for(let t in this.options)delete this.options[t];this.onProgress.clear(),this.onComplete.clear(),this.progress.reset(),this.obsoluteInst=null}}const hr=[],or={};class lr{static subtractVector3(t,e,i){i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2]}static lerp(t,e,i){return t*(1-i)+e*i}static scaleVector3(t,e,i){i[0]=t[0]*e,i[1]=t[1]*e,i[2]=t[2]*e}static lerpVector3(t,e,i,r){var s=t[0],a=t[1],n=t[2];r[0]=s+i*(e[0]-s),r[1]=a+i*(e[1]-a),r[2]=n+i*(e[2]-n)}static lerpVector4(t,e,i,r){var s=t[0],a=t[1],n=t[2],h=t[3];r[0]=s+i*(e[0]-s),r[1]=a+i*(e[1]-a),r[2]=n+i*(e[2]-n),r[3]=h+i*(e[3]-h)}static slerpQuaternionArray(t,e,i,r,s,a,n){var h,o,l,_,u,d=t[e+0],c=t[e+1],p=t[e+2],f=t[e+3],m=i[r+0],g=i[r+1],T=i[r+2],x=i[r+3];return(o=d*m+c*g+p*T+f*x)<0&&(o=-o,m=-m,g=-g,T=-T,x=-x),1-o>1e-6?(h=Math.acos(o),l=Math.sin(h),_=Math.sin((1-s)*h)/l,u=Math.sin(s*h)/l):(_=1-s,u=s),a[n+0]=_*d+u*m,a[n+1]=_*c+u*g,a[n+2]=_*p+u*T,a[n+3]=_*f+u*x,a}static getRotation(t,e,i,r){return Math.atan2(r-e,i-t)/Math.PI*180}static sortBigFirst(t,e){return t==e?0:e>t?1:-1}static sortSmallFirst(t,e){return t==e?0:e>t?-1:1}static sortNumBigFirst(t,e){return parseFloat(e)-parseFloat(t)}static sortNumSmallFirst(t,e){return parseFloat(t)-parseFloat(e)}static sortByKey(t,e=!1,i=!0){var r;return r=e?i?lr.sortNumBigFirst:lr.sortBigFirst:i?lr.sortNumSmallFirst:lr.sortSmallFirst,function(e,i){return r(e[t],i[t])}}}class _r extends qi{static _sortIndexFun(t,e){return t.index-e.index}constructor(){super(),void 0===_r._sortIndexFun&&(_r._sortIndexFun=lr.sortByKey("index",!1,!0))}_setUp(t,e){this._targetDic=t,this._animationData=e,this.interval=1e3/e.frameRate,e.parsed?(this._count=e.count,this._labels=e.labels,this._usedFrames=e.animationNewFrames):(this._usedFrames=[],this._calculateDatas(),e.parsed=!0,e.labels=this._labels,e.count=this._count,e.animationNewFrames=this._usedFrames)}clear(){return super.clear(),this._targetDic=null,this._animationData=null,this}_displayToIndex(t){if(this._animationData){t<0&&(t=0),t>this._count&&(t=this._count);var e,i=this._animationData.nodes,r=i.length;for(e=0;e<r;e++)this._displayNodeToFrame(i[e],t)}}_displayNodeToFrame(t,e,i=null){i||(i=this._targetDic);var r=i[t.target];if(r){var s,a,n,h,o=t.frames,l=t.keys,_=l.length;for(h=0;h<_;h++)n=(a=o[s=l[h]]).length>e?a[e]:a[a.length-1],r[s]=n;var u,d=t.funkeys;if(0!=(_=d.length))for(h=0;h<_;h++)void 0!==(u=o[s=d[h]])[e]&&r[s]&&r[s].apply(r,u[e])}}_calculateDatas(){if(this._animationData){var t,e,i=this._animationData.nodes,r=i.length;for(this._count=0,t=0;t<r;t++)e=i[t],this._calculateKeyFrames(e);this._count+=1}}_calculateKeyFrames(t){var e,i,r=t.keyframes,s=t.target;for(e in t.frames||(t.frames={}),t.keys?t.keys.length=0:t.keys=[],t.funkeys?t.funkeys.length=0:t.funkeys=[],t.initValues||(t.initValues={}),r){var a=-1!=e.indexOf("()");if(i=r[e],a&&(e=e.substr(0,e.length-2)),t.frames[e]||(t.frames[e]=[]),a){t.funkeys.push(e);for(var n=t.frames[e],h=0;h<i.length;h++){var o=i[h];n[o.index]=o.value,o.index>this._count&&(this._count=o.index)}}else this._targetDic&&this._targetDic[s]&&(t.initValues[e]=this._targetDic[s][e]),i.sort(_r._sortIndexFun),t.keys.push(e),this._calculateNodePropFrames(i,t.frames[e],e,s)}}resetNodes(){if(this._targetDic&&this._animationData){var t,e,i,r=this._animationData.nodes,s=r.length;for(t=0;t<s;t++)if(i=(e=r[t]).initValues){var a,n=this._targetDic[e.target];if(n)for(a in i)n[a]=i[a]}}}_calculateNodePropFrames(t,e,i,r){var s,a=t.length-1;for(e.length=t[a].index+1,s=0;s<a;s++)this._dealKeyFrame(t[s]),this._calculateFrameValues(t[s],t[s+1],e);0==a&&(e[0]=t[0].value,this._usedFrames&&(this._usedFrames[t[0].index]=!0)),this._dealKeyFrame(t[s])}_dealKeyFrame(t){t.label&&""!=t.label&&this.addLabel(t.label,t.index)}_calculateFrameValues(t,e,i){var r,s,a=t.index,n=e.index,h=t.value,o=e.value-t.value,l=n-a,_=this._usedFrames;if(n>this._count&&(this._count=n),t.tween)for(null==(s=Xi[t.tweenMethod])&&(s=Xi.linearNone),r=a;r<n;r++)i[r]=s(r-a,h,o,l),_&&(_[r]=!0);else for(r=a;r<n;r++)i[r]=h;_&&(_[t.index]=!0,_[e.index]=!0),i[e.index]=e.value}}class ur extends _r{constructor(){super(...arguments),this._nodeIDAniDic={}}_parseNodeList(t){this._nodeList||(this._nodeList=[]),this._nodeDefaultProps[t.compId]=t.props,t.compId&&this._nodeList.push(t.compId);var e=t.child;if(e){var i,r=e.length;for(i=0;i<r;i++)this._parseNodeList(e[i])}}_calGraphicData(t){var e;if(this._setUp(null,t),this._createGraphicData(),this._nodeIDAniDic)for(e in this._nodeIDAniDic)this._nodeIDAniDic[e]=null}_createGraphicData(){var t,e,i=[],r=this.count,s=this._usedFrames;for(s||(s=[]),t=0;t<r;t++)!s[t]&&e||(e=this._createFrameGraphic(t)),i.push(e);this._gList=i}_createFrameGraphic(t){var e=new Ui;return ur._rootMatrix||(ur._rootMatrix=new p),this._updateNodeGraphic(this._rootNode,t,ur._rootMatrix,e),e}_updateNodeGraphic(t,e,i,r,s=1){var a,n,h;(a=this._nodeGDic[t.compId]=this._getNodeGraphicData(t.compId,e,this._nodeGDic[t.compId])).resultTransform||(a.resultTransform=new p),n=a.resultTransform,p.mul(a.transform,i,n);var o=a.alpha*s;if(!(o<.01)){a.skin&&(h=this._getTextureByUrl(a.skin))&&(n._checkTransform()?(r.drawTexture(h,0,0,a.width,a.height,n,o),a.resultTransform=null):r.drawTexture(h,n.tx,n.ty,a.width,a.height,null,o));var l,_,u=t.child;if(u)for(_=u.length,l=0;l<_;l++)this._updateNodeGraphic(u[l],e,n,r,o)}}_updateNoChilds(t,e){if(t.skin){var i=this._getTextureByUrl(t.skin);if(i){var r=t.transform;r._checkTransform(),!r._bTransform?e.drawTexture(i,r.tx,r.ty,t.width,t.height,null,t.alpha):e.drawTexture(i,0,0,t.width,t.height,r.clone(),t.alpha)}}}_updateNodeGraphic2(t,e,i){var r;if(r=this._nodeGDic[t.compId]=this._getNodeGraphicData(t.compId,e,this._nodeGDic[t.compId]),t.child){var s,a,n,h=r.transform;h._checkTransform(),a=(s=!h._bTransform)&&(0!=h.tx||0!=h.ty),(n=h._bTransform||1!=r.alpha)&&i.save(),1!=r.alpha&&i.alpha(r.alpha),s?a&&i.translate(h.tx,h.ty):i.transform(h.clone());var o,l,_,u=t.child;if(r.skin&&(o=this._getTextureByUrl(r.skin))&&i.drawImage(o,0,0,r.width,r.height),u)for(_=u.length,l=0;l<_;l++)this._updateNodeGraphic2(u[l],e,i);n?i.restore():s?a&&i.translate(-h.tx,-h.ty):i.transform(h.clone().invert())}else this._updateNoChilds(r,i)}_calculateKeyFrames(t){super._calculateKeyFrames(t),this._nodeIDAniDic[t.target]=t}getNodeDataByID(t){return this._nodeIDAniDic[t]}_getParams(t,e,i,r){var s=ur._temParam;s.length=e.length;var a,n=e.length;for(a=0;a<n;a++)s[a]=this._getObjVar(t,e[a][0],i,e[a][1],r);return s}_getObjVar(t,e,i,r,s){if(e in t){var a=t[e];return i>=a.length&&(i=a.length-1),t[e][i]}return e in s?s[e]:r}_getNodeGraphicData(t,e,i){i||(i=new dr),i.transform?i.transform.identity():i.transform=new p;var r=this.getNodeDataByID(t);if(!r)return i;var s,a,n,h=r.frames,o=this._getParams(h,ur._drawTextureCmd,e,this._nodeDefaultProps[t]),l=o[0],_=o[5],u=o[6],d=o[13],c=o[14],f=o[7],m=o[8],g=o[9],T=o[11],x=o[12];s=o[3],a=o[4],0!=s&&0!=a||(l=null),-1==s&&(s=0),-1==a&&(a=0),i.skin=l,i.width=s,i.height=a,l&&((n=this._getTextureByUrl(l))?(s||(s=n.sourceWidth),a||(a=n.sourceHeight)):console.warn("lost skin:",l,",you may load pics first")),i.alpha=o[10];var E=i.transform;0!=d&&(_=d*s),0!=c&&(u=c*a),0==_&&0==u||E.translate(-_,-u);var y=null;if(g||1!==f||1!==m||T||x){(y=ur._tempMt).identity(),y._bTransform=!0;var v=.0174532922222222*(g-T),S=.0174532922222222*(g+x),R=Math.cos(S),b=Math.sin(S),C=Math.sin(v),A=Math.cos(v);y.a=f*R,y.b=f*b,y.c=-m*C,y.d=m*A,y.tx=y.ty=0}return y&&(E=p.mul(E,y,E)),E.translate(o[1],o[2]),i}_getTextureByUrl(t){return ar.getRes(t)}setAniData(t,e=null){if(t.animations){this._nodeDefaultProps={},this._nodeGDic={},this._nodeList&&(this._nodeList.length=0),this._rootNode=t,this._parseNodeList(t);var i,r,s={},a=[],n=t.animations,h=n.length;for(i=0;i<h;i++)if(r=n[i],this._labels=null,(!e||e==r.name)&&r){try{this._calGraphicData(r)}catch(t){console.warn("parse animation fail:"+r.name+",empty animation created"),this._gList=[]}var o={};o.interval=1e3/r.frameRate,o.frames=this._gList,o.labels=this._labels,o.name=r.name,a.push(o),s[r.name]=o}this.animationList=a,this.animationDic=s}ur._temParam.length=0}parseByData(t){var e,i;e=t.nodeRoot,i=t.aniO,delete t.nodeRoot,delete t.aniO,this._nodeDefaultProps={},this._nodeGDic={},this._nodeList&&(this._nodeList.length=0),this._rootNode=e,this._parseNodeList(e),this._labels=null;try{this._calGraphicData(i)}catch(t){console.warn("parse animation fail:"+i.name+",empty animation created"),this._gList=[]}var r=t;return r.interval=1e3/i.frameRate,r.frames=this._gList,r.labels=this._labels,r.name=i.name,r}setUpAniData(t){if(t.animations){var e,i,r={},s=[],a=t.animations,n=a.length;for(e=0;e<n;e++)if(i=a[e]){var h={};h.name=i.name,h.aniO=i,h.nodeRoot=t,s.push(h),r[i.name]=h}this.animationList=s,this.animationDic=r}}_clear(){this.animationList=null,this.animationDic=null,this._gList=null,this._nodeGDic=null}static parseAnimationByData(t){var e;return ur._I||(ur._I=new ur),e=ur._I.parseByData(t),ur._I._clear(),e}static parseAnimationData(t){var e;return ur._I||(ur._I=new ur),ur._I.setUpAniData(t),(e={}).animationList=ur._I.animationList,e.animationDic=ur._I.animationDic,ur._I._clear(),e}}ur._drawTextureCmd=[["skin",null],["x",0],["y",0],["width",-1],["height",-1],["pivotX",0],["pivotY",0],["scaleX",1],["scaleY",1],["rotation",0],["alpha",1],["skewX",0],["skewY",0],["anchorX",0],["anchorY",0]],ur._temParam=[],ur._tempMt=new p;class dr{constructor(){this.alpha=1}}class cr extends qi{constructor(){super(),this._setControlNode(this)}destroy(t=!0){this.stop(),super.destroy(t),this._frames=null,this._labels=null}play(t=0,e=!0,i=""){i&&this._setFramesFromCache(i,!0),super.play(t,e,i)}_setFramesFromCache(t,e=!1){if(this._url&&(t=this._url+"#"+t),t&&cr.framesMap[t]){var i=cr.framesMap[t];return i instanceof Array?(this._frames=cr.framesMap[t],this._count=this._frames.length):(i.nodeRoot&&(cr.framesMap[t]=ur.parseAnimationByData(i),i=cr.framesMap[t]),this._frames=i.frames,this._count=this._frames.length,this._frameRateChanged||(this._interval=i.interval),this._labels=this._copyLabels(i.labels)),!0}return e&&console.log("ani not found:",t),!1}_copyLabels(t){if(!t)return null;var e,i;for(i in e={},t)e[i]=d.copyArray([],t[i]);return e}_frameLoop(){this._visible&&this._style.alpha>.01&&this._frames&&super._frameLoop()}_displayToIndex(t){this._frames&&(this.graphics=this._frames[t])}get frames(){return this._frames}set frames(t){this._frames=t,t&&(this._count=t.length,this._actionName&&this._setFramesFromCache(this._actionName,!0),this.index=this._index)}set source(t){t.indexOf(".ani")>-1?this.loadAnimation(t):t.indexOf(".json")>-1||t.indexOf("als")>-1||t.indexOf("atlas")>-1?this.loadAtlas(t):this.loadImages(t.split(","))}set autoAnimation(t){this.play(0,!0,t)}set autoPlay(t){t?this.play():this.stop()}clear(){return super.clear(),this.stop(),this.graphics=null,this._frames=null,this._labels=null,this}loadImages(t,e=""){return this._url="",this._setFramesFromCache(e)||(this.frames=cr.framesMap[e]?cr.framesMap[e]:cr.createFrames(t,e)),this}loadAtlas(t,e=null,i=""){this._url="";var r=this;if(!r._setFramesFromCache(i)){function onLoaded(s){t===s&&(r.frames=cr.framesMap[i]?cr.framesMap[i]:cr.createFrames(t,i),e&&e.run())}ar.getAtlas(t)?onLoaded(t):n.loader.load(t,Hi.create(null,onLoaded,[t]),null,ar.ATLAS)}return this}loadAnimation(t,e=null,i=null){this._url=t;return this._actionName||(this._actionName=""),this._setFramesFromCache(this._actionName)?(this._setFramesFromCache(this._actionName,!0),this.index=0,e&&e.run()):!i||ar.getAtlas(i)?this._loadAnimationData(t,e,i):n.loader.load(i,Hi.create(this,this._loadAnimationData,[t,e,i]),null,ar.ATLAS),this}_loadAnimationData(t,e=null,i=null){!i||ar.getAtlas(i)?n.loader.fetch(t,"json").then((i=>{if(this._url!==t)return;if(!i)return void(cr.framesMap[t+"#"]&&(this._setFramesFromCache(this._actionName,!0),this.index=0,this._resumePlay(),e&&e.run()));let r;if(cr.framesMap[t+"#"])this._setFramesFromCache(this._actionName,!0),this.index=0,this._resumePlay();else{let e=ur.parseAnimationData(i);if(!e)return;let s,a=e.animationList,n=a.length;for(let e=0;e<n;e++)r=a[e],cr.framesMap[t+"#"+r.name]=r,s||(s=r);s&&(cr.framesMap[t+"#"]=s,this._setFramesFromCache(this._actionName,!0),this.index=0),this._resumePlay()}e&&e.run()})):console.warn("atlas load fail:"+i)}static createFrames(t,e){var i;if("string"==typeof t){var r=ar.getAtlas(t);if(r&&r.frames.length){let t=r.frames;i=[];for(var s=0,a=t.length;s<a;s++){var n=new Ui;n.drawImage(t[s],0,0),i.push(n)}}}else if(t instanceof Array)for(i=[],s=0,a=t.length;s<a;s++)(n=new Ui).loadImage(t[s],0,0),i.push(n);return e&&(cr.framesMap[e]=i),i}static clearCache(t){var e,i=cr.framesMap,r=t+"#";for(e in i)e!==t&&0!==e.indexOf(r)||delete cr.framesMap[e]}}cr.framesMap={};class pr{constructor(){this._fontCharDic={},this._fontWidthMap={},this._maxWidth=0,this._spaceWidth=10,this.fontSize=12,this.autoScaleSize=!1,this.letterSpacing=0}loadFont(t,e){this._path=t,t&&-1!==t.indexOf(".fnt")?n.loader.load([t,t.replace(".fnt",".png")]).then((t=>{this.parseFont(t[0].data,t[1]),e&&e.run()})):console.error('Bitmap font configuration information must be a ".fnt" file')}parseFont(t,e){if(null==t||null==e)return;this._texture=e,e._addReference();let i=t.getElementsByTagName("info");if(!i[0].getAttributeNode)return this.parseFont2(t,e);this.fontSize=parseInt(i[0].getAttributeNode("size").nodeValue);let r=i[0].getAttributeNode("padding").nodeValue.split(",");this._padding=[parseInt(r[0]),parseInt(r[1]),parseInt(r[2]),parseInt(r[3])];let s=t.getElementsByTagName("char");for(let t=0;t<s.length;t++){let i=s[t],r=parseInt(i.getAttributeNode("id").nodeValue),a=parseInt(i.getAttributeNode("xoffset").nodeValue)/1,n=parseInt(i.getAttributeNode("yoffset").nodeValue)/1,h=parseInt(i.getAttributeNode("xadvance").nodeValue)/1,o=new m;o.x=parseInt(i.getAttributeNode("x").nodeValue),o.y=parseInt(i.getAttributeNode("y").nodeValue),o.width=parseInt(i.getAttributeNode("width").nodeValue),o.height=parseInt(i.getAttributeNode("height").nodeValue);let l=ht.create(e,o.x,o.y,o.width,o.height,a,n);this._maxWidth=Math.max(this._maxWidth,h+this.letterSpacing),this._fontCharDic[r]=l,this._fontWidthMap[r]=h}}parseFont2(t,e){if(null==t||null==e)return;this._texture=e;let i=t.getElementsByTagName("info");this.fontSize=parseInt(i[0].attributes.size.nodeValue);let r=i[0].attributes.padding.nodeValue.split(",");this._padding=[parseInt(r[0]),parseInt(r[1]),parseInt(r[2]),parseInt(r[3])];let s=t.getElementsByTagName("char");for(let t=0;t<s.length;t++){let i=s[t].attributes,r=parseInt(i.id.nodeValue),a=parseInt(i.xoffset.nodeValue)/1,n=parseInt(i.yoffset.nodeValue)/1,h=parseInt(i.xadvance.nodeValue)/1,o=new m;o.x=parseInt(i.x.nodeValue),o.y=parseInt(i.y.nodeValue),o.width=parseInt(i.width.nodeValue),o.height=parseInt(i.height.nodeValue);let l=ht.create(e,o.x,o.y,o.width,o.height,a,n);this._maxWidth=Math.max(this._maxWidth,h+this.letterSpacing),this._fontCharDic[r]=l,this._fontWidthMap[r]=h}}getCharTexture(t){return this._fontCharDic[t.charCodeAt(0)]}destroy(){if(this._texture){for(let t in this._fontCharDic)this._fontCharDic[t].destroy();this._texture._removeReference(),this._fontCharDic=null,this._fontWidthMap=null,this._texture=null,this._padding=null}}setSpaceWidth(t){this._spaceWidth=t}getCharWidth(t){let e=t.charCodeAt(0);return this._fontWidthMap[e]?this._fontWidthMap[e]+this.letterSpacing:" "===t?this._spaceWidth+this.letterSpacing:0}getTextWidth(t){let e=0;for(let i=0,r=t.length;i<r;i++)e+=this.getCharWidth(t.charAt(i));return e}getMaxWidth(){return this._maxWidth}getMaxHeight(){return this.fontSize}_drawText(t,e,i,r,s,a){let n,h=this.getTextWidth(t),o=0;"center"===s&&(o=(a-h)/2),"right"===s&&(o=a-h);let l=0;for(let s=0,a=t.length;s<a;s++)n=this.getCharTexture(t.charAt(s)),n&&(e.graphics.drawImage(n,i+l+o,r),l+=this.getCharWidth(t.charAt(s)))}}class fr extends _r{constructor(){super(...arguments),this._initData={}}set target(t){this._target&&this._target.off(fr.EFFECT_BEGIN,this,this._onOtherBegin),this._target=t,this._target&&this._target.on(fr.EFFECT_BEGIN,this,this._onOtherBegin),this._addEvent()}get target(){return this._target}_onOtherBegin(t){t!==this&&this.stop()}set playEvent(t){this._playEvent=t,t&&this._addEvent()}_addEvent(){this._target&&this._playEvent&&(this._setControlNode(this._target),this._target.on(this._playEvent,this,this._onPlayAction))}_onPlayAction(){this.play(0,!1)}play(t=0,e=!0,i=""){this._target&&(this._target.event(fr.EFFECT_BEGIN,[this]),this._recordInitData(),super.play(t,e,i))}_recordInitData(){var t,e,i;if(this._aniKeys)for(e=this._aniKeys.length,t=0;t<e;t++)i=this._aniKeys[t],this._initData[i]=this._target[i]}set effectClass(t){if(this._effectClass=a.getClass(t),this._effectClass){var e=this._effectClass.uiView;if(e){var i=e.animations;if(i&&i[0]){var r=i[0];this._setUp({},r),r.nodes&&r.nodes[0]&&(this._aniKeys=r.nodes[0].keys)}}}}set effectData(t){if(t){var e=t.animations;if(e&&e[0]){var i=e[0];this._setUp({},i),i.nodes&&i.nodes[0]&&(this._aniKeys=i.nodes[0].keys)}}}_displayToIndex(t){if(this._animationData){t<0&&(t=0),t>this._count&&(t=this._count);var e,i=this._animationData.nodes,r=i.length;for(r=r>1?1:r,e=0;e<r;e++)this._displayNodeToFrame(i[e],t)}}_displayNodeToFrame(t,e,i=null){if(this._target){var r,s,a,n,h,o,l,_,u,d=this._target,c=t.frames,p=t.keys,f=p.length,m=t.secondFrames;for(n=0;n<f;n++)s=c[r=p[n]],-1==(h=m[r])?a=this._initData[r]:e<h?(_=(l=t.keyframes[r])[0]).tween?(null==(o=Xi[_.tweenMethod])&&(o=Xi.linearNone),u=l[1],a=o(e,this._initData[r],u.value-this._initData[r],u.index)):a=this._initData[r]:a=s.length>e?s[e]:s[s.length-1],d[r]=a}}_calculateKeyFrames(t){super._calculateKeyFrames(t);var e,i,r=t.keyframes;t.target;var s={};for(e in t.secondFrames=s,r)(i=r[e]).length<=1?s[e]=-1:s[e]=i[1].index}}fr.EFFECT_BEGIN="effectbegin";class mr extends si{constructor(){super(...arguments),this.italic=!1}reset(){return super.reset(),this.italic=!1,this.align="left",this.wordWrap=!1,this.leading=0,this.padding=[0,0,0,0],this.bgColor=null,this.borderColor=null,this.asPassword=!1,this.stroke=0,this.strokeColor="#000000",this.bold=!1,this.underline=!1,this.underlineColor=null,this.currBitmapFont=null,this}recover(){this!==mr.EMPTY&&o.recover("TextStyle",this.reset())}static create(){return o.getItemByClass("TextStyle",mr)}render(t,e,i,r){(this.bgColor||this.borderColor)&&e.drawRect(i-this.pivotX,r-this.pivotY,t.width,t.height,this.bgColor,this.borderColor,1)}}mr.EMPTY=new mr;class gr extends Ki{constructor(){super(),this._textWidth=0,this._textHeight=0,this._lines=[],this._lineWidths=[],this._startX=0,this._startY=0,this._charSize={},this._valign="top",this._fontSize=e.defaultFontSize,this._font=e.defaultFont,this._color="#000000",this._singleCharRender=!1,this.overflow=gr.VISIBLE,this._style=mr.EMPTY}getStyle(){return this._style===mr.EMPTY&&(this._style=mr.create()),this._style}_getTextStyle(){return this._style===mr.EMPTY&&(this._style=mr.create()),this._style}static registerBitmapFont(t,e){gr._bitmapFonts||(gr._bitmapFonts={}),gr._bitmapFonts[t]=e}static unregisterBitmapFont(t,e=!0){if(gr._bitmapFonts&&gr._bitmapFonts[t]){var i=gr._bitmapFonts[t];e&&i.destroy(),delete gr._bitmapFonts[t]}}destroy(t=!0){super.destroy(t),this._clipPoint=null,this._lines=null,this._lineWidths=null,this._words&&this._words.forEach((function(t){t.cleanCache()})),this._words=null,this._charSize=null}_getBoundPointsM(t=!1){var e=m.TEMP;return e.setTo(0,0,this.width,this.height),e._getBoundPoints()}getGraphicBounds(t=!1){var e=m.TEMP;return e.setTo(0,0,this.width,this.height),e}get width(){return this._width?this._width:this.textWidth+this.padding[1]+this.padding[3]}set width(t){t!=this._width&&(super.set_width(t),this.isChanged=!0,this.borderColor&&this._setBorderStyleColor(0,0,this.width,this.height,this.borderColor,1))}_getCSSStyle(){return this._style}get height(){return this._height?this._height:this.textHeight}set height(t){t!=this._height&&(super.set_height(t),this.isChanged=!0,this.borderColor&&this._setBorderStyleColor(0,0,this.width,this.height,this.borderColor,1))}get textWidth(){return this._isChanged&&n.systemTimer.runCallLater(this,this.typeset),this._textWidth}get textHeight(){return this._isChanged&&n.systemTimer.runCallLater(this,this.typeset),this._textHeight}get text(){return this._text||""}get_text(){return this._text||""}set_text(t){this._text!==t&&(this.lang(t+""),this.isChanged=!0,this.event(y.CHANGE),this.borderColor&&this._setBorderStyleColor(0,0,this.width,this.height,this.borderColor,1))}set text(t){this.set_text(t)}lang(t,e=null,i=null,r=null,s=null,a=null,n=null,h=null,o=null,l=null,_=null){if(t=gr.langPacks&&gr.langPacks[t]?gr.langPacks[t]:t,arguments.length<2)this._text=t;else{for(var u=0,d=arguments.length;u<d;u++)t=t.replace("{"+u+"}",arguments[u+1]);this._text=t}}get font(){return this._font}set font(t){this._style.currBitmapFont&&(this._getTextStyle().currBitmapFont=null,this.scale(1,1)),gr._bitmapFonts&&gr._bitmapFonts[t]&&(this._getTextStyle().currBitmapFont=gr._bitmapFonts[t]),this._font=t,this.isChanged=!0}get fontSize(){return this._fontSize}set fontSize(t){this._fontSize!=t&&(this._fontSize=t,this.isChanged=!0)}get bold(){return this._style.bold}set bold(t){this._getTextStyle().bold=t,this.isChanged=!0}get color(){return this._color}set color(t){this.set_color(t)}get_color(){return this._color}set_color(t){this._color!=t&&(this._color=t,!this._isChanged&&this._graphics?this._graphics.replaceTextColor(this.color):this.isChanged=!0)}get italic(){return this._style.italic}set italic(t){this._getTextStyle().italic=t,this.isChanged=!0}get align(){return this._style.align}set align(t){this._getTextStyle().align=t,this.isChanged=!0}get valign(){return this._valign}set valign(t){this._valign=t,this.isChanged=!0}get wordWrap(){return this._style.wordWrap}set wordWrap(t){this._getTextStyle().wordWrap=t,this.isChanged=!0}get leading(){return this._style.leading}set leading(t){this._getTextStyle().leading=t,this.isChanged=!0}get padding(){return this._style.padding}set padding(t){if("string"==typeof t){var e,i,r;for(r=(e=t.split(",")).length;e.length<4;)e.push(0);for(i=0;i<r;i++)e[i]=parseFloat(e[i])||0;t=e}this._getTextStyle().padding=t,this.isChanged=!0}get bgColor(){return this._style.bgColor}set bgColor(t){this.set_bgColor(t)}set_bgColor(t){this._getTextStyle().bgColor=t,this._renderType|=Mt.STYLE,this._setBgStyleColor(0,0,this.width,this.height,t),this._setRenderType(this._renderType),this.isChanged=!0}get_bgColor(){return this._style.bgColor}get borderColor(){return this._style.borderColor}set borderColor(t){this._getTextStyle().borderColor=t,this._renderType|=Mt.STYLE,this._setBorderStyleColor(0,0,this.width,this.height,t,1),this._setRenderType(this._renderType),this.isChanged=!0}get stroke(){return this._style.stroke}set stroke(t){this._getTextStyle().stroke=t,this.isChanged=!0}get strokeColor(){return this._style.strokeColor}set strokeColor(t){this._getTextStyle().strokeColor=t,this.isChanged=!0}set isChanged(t){this._isChanged!==t&&(this._isChanged=t,t&&n.systemTimer.callLater(this,this.typeset))}_getContextFont(){return(this.italic?"italic ":"")+(this.bold?"bold ":"")+this.fontSize+"px "+(n.Browser.onIPhone&&e.fontFamilyMap[this.font]||this.font)}_isPassWordMode(){var t=this._style.asPassword;return"prompt"in this&&this.prompt==this._text&&(t=!1),t}_getPassWordTxt(t){var e;e="";for(var i=t.length;i>0;i--)e+="●";return e}_renderText(){var t=this.padding,e=this._lines.length;this.overflow!=gr.VISIBLE&&(e=Math.min(e,Math.floor((this.height-t[0]-t[2])/(this.leading+this._charSize.height))+1));var i=this.scrollY/(this._charSize.height+this.leading)|0,r=this.graphics;r.clear(!0);var s=this._getContextFont();n.Browser.context.font=s;var a=t[3],h="left",o=this._lines,l=this.leading+this._charSize.height,_=this._style.currBitmapFont;_&&(l=this.leading+_.getMaxHeight());var u=t[0];!_&&this._width>0&&this._textWidth<=this._width&&("right"==this.align?(h="right",a=this._width-t[1]):"center"==this.align&&(h="center",a=.5*this._width+t[3]-t[1]));let d=1;if(_&&_.autoScaleSize&&(d=_.fontSize/this.fontSize),this._height>0){var c=this._textHeight>this._height?"top":this.valign;"middle"===c?u=.5*(this._height-e/d*l)+t[0]-t[2]:"bottom"===c&&(u=this._height-e/d*l-t[2])}if(this._clipPoint){var p,f;if(r.save(),_&&_.autoScaleSize)p=this._width?this._width-t[3]-t[1]:this._textWidth,f=this._height?this._height-t[0]-t[2]:this._textHeight,p*=d,f*=d,r.clipRect(t[3],t[0],p,f);else r.clipRect(t[3],t[0],this._width?this._width-t[3]-t[1]:this._textWidth,this._height?this._height-t[0]-t[2]:this._textHeight);this.repaint()}var m=this._style,g=m.asPassword;"prompt"in this&&this.prompt==this._text&&(g=!1);for(var T=0,x=0,E=Math.min(this._lines.length,e+i)||1,y=i;y<E;y++){var v,S=o[y];if(g){let t=S.length;S="";for(var R=t;R>0;R--)S+="●"}if(null==S&&(S=""),T=a-(this._clipPoint?this._clipPoint.x:0),x=u+l*y-(this._clipPoint?this._clipPoint.y:0),this.underline&&this._drawUnderline(h,T,x,y),_){var b=this.width;_.autoScaleSize&&(b=this.width*d,T*=d,x*=d),_._drawText(S,this,T,x,this.align,b)}else this._words||(this._words=[]),this._words.length>y-i?v=this._words[y-i]:(v=new Ue,this._words.push(v)),v.setText(S),v.splitRender=this._singleCharRender,m.stroke?r.fillBorderText(v,T,x,s,this.color,h,m.stroke,m.strokeColor):r.fillText(v,T,x,s,this.color,h)}if(_&&_.autoScaleSize){var C=1/d;this.scale(C,C)}this._clipPoint&&r.restore(),this._startX=a,this._startY=u}_drawUnderline(t,e,i,r){var s=this._lineWidths[r];switch(t){case"center":e-=s/2;break;case"right":e-=s}i+=this._charSize.height,this._graphics.drawLine(e,i,e+s,i,this.underlineColor||this.color,1)}typeset(){if(this._isChanged=!1,!this._text)return this._clipPoint=null,this._textWidth=this._textHeight=0,void this.graphics.clear(!0);h.isConch?window.conchTextCanvas.font=this._getContextFont():n.Browser.context.font=this._getContextFont(),this._lines.length=0,this._lineWidths.length=0,this._isPassWordMode()?this._parseLines(this._getPassWordTxt(this._text)):this._parseLines(this._text),this._evalTextSize(),this._checkEnabledViewportOrNot()?this._clipPoint||(this._clipPoint=new f(0,0)):this._clipPoint=null,this._renderText()}_evalTextSize(){var t,e;t=Math.max.apply(this,this._lineWidths);let i=this._style.currBitmapFont;if(i){let t=i.getMaxHeight();i.autoScaleSize&&(t=this.fontSize),e=this._lines.length*(t+this.leading)+this.padding[0]+this.padding[2]}else e=this._lines.length*(this._charSize.height+this.leading)+this.padding[0]+this.padding[2],this._lines.length&&(e-=this.leading);t==this._textWidth&&e==this._textHeight||(this._textWidth=t,this._textHeight=e)}_checkEnabledViewportOrNot(){return this.overflow==gr.SCROLL&&(this._width>0&&this._textWidth>this._width||this._height>0&&this._textHeight>this._height)}changeText(t){this._text!==t&&(this.lang(t+""),this._graphics&&this._graphics.replaceText(this._text)||this.typeset())}_parseLines(t){var e=this.wordWrap||this.overflow==gr.HIDDEN;if(e)var i=this._getWordWrapWidth();var r=this._style.currBitmapFont;if(r)this._charSize.width=r.getMaxWidth(),this._charSize.height=r.getMaxHeight();else{var s=null;(s=h.isConch?window.conchTextCanvas.measureText(gr._testWord):n.Browser.context.measureText(gr._testWord))||(s={width:100}),this._charSize.width=s.width,this._charSize.height=s.height||this.fontSize}for(var a=t.replace(/\r\n/g,"\n").split("\n"),o=0,l=a.length;o<l;o++){var _=a[o];e?this._parseLine(_,i):(this._lineWidths.push(this._getTextWidth(_)),this._lines.push(_))}}_parseLine(t,e){var i=this._lines,r=0,s=0,a=0,n=0;if((s=this._getTextWidth(t))<=e)return i.push(t),void this._lineWidths.push(s);s=this._charSize.width,0==(r=Math.floor(e/s))&&(r=1),a=s=this._getTextWidth(t.substring(0,r));for(var h=r,o=t.length;h<o;h++)if((a+=s=this._getTextWidth(t.charAt(h)))>e)if(this.wordWrap){var l=t.substring(n,h),_=l.charCodeAt(l.length-1);if(_<19968||_>40869){var u=/(?:[^\s\!-\/])+$/.exec(l);u&&(h=u.index+n,0==u.index?h+=l.length:l=t.substring(n,h))}if(i.push(l),this._lineWidths.push(a-s),n=h,!(h+r<o)){i.push(t.substring(n,o)),this._lineWidths.push(this._getTextWidth(i[i.length-1])),n=-1;break}h+=r,a=s=this._getTextWidth(t.substring(n,h)),h--}else if(this.overflow==gr.HIDDEN)return i.push(t.substring(0,h)),void this._lineWidths.push(this._getTextWidth(i[i.length-1]));this.wordWrap&&-1!=n&&(i.push(t.substring(n,o)),this._lineWidths.push(this._getTextWidth(i[i.length-1])))}_getTextWidth(t){var e=this._style.currBitmapFont;if(e)return e.getTextWidth(t);if(h.isConch)return window.conchTextCanvas.measureText(t).width;return(n.Browser.context.measureText(t)||{width:100}).width}_getWordWrapWidth(){var t,e=this.padding,i=this._style.currBitmapFont;return(t=i&&i.autoScaleSize?this._width*(i.fontSize/this.fontSize):this._width)<=0&&(t=this.wordWrap?100:n.Browser.width),t<=0&&(t=100),t-e[3]-e[1]}getCharPoint(t,e=null){this._isChanged&&n.systemTimer.runCallLater(this,this.typeset);for(var i=0,r=this._lines,s=0,a=0,h=r.length;a<h;a++){if(t<(i+=r[a].length)){var o=a;break}s=i}var l=(this.italic?"italic ":"")+(this.bold?"bold ":"")+this.fontSize+"px "+this.font;n.Browser.context.font=l;var _=this._getTextWidth(this._text.substring(s,t));return(e||new f).setTo(this._startX+_-(this._clipPoint?this._clipPoint.x:0),this._startY+o*(this._charSize.height+this.leading)-(this._clipPoint?this._clipPoint.y:0))}set scrollX(t){if(!(this.overflow!=gr.SCROLL||this.textWidth<this._width)&&this._clipPoint){t=t<this.padding[3]?this.padding[3]:t;var e=this._textWidth-this._width;t=t>e?e:t,this._clipPoint.x=t,this._renderText()}}get scrollX(){return this._clipPoint?this._clipPoint.x:0}set scrollY(t){if(!(this.overflow!=gr.SCROLL||this.textHeight<this._height)&&this._clipPoint){t=t<this.padding[0]?this.padding[0]:t;var e=this._textHeight-this._height;t=t>e?e:t,this._clipPoint.y=t,this._renderText()}}get scrollY(){return this._clipPoint?this._clipPoint.y:0}get maxScrollX(){return this.textWidth<this._width?0:this._textWidth-this._width}get maxScrollY(){return this.textHeight<this._height?0:this._textHeight-this._height}get lines(){return this._isChanged&&this.typeset(),this._lines}get underlineColor(){return this._style.underlineColor}set underlineColor(t){this._getTextStyle().underlineColor=t,this._isChanged||this._renderText()}get underline(){return this._style.underline}set underline(t){this._getTextStyle().underline=t}set singleCharRender(t){this._singleCharRender=t}get singleCharRender(){return this._singleCharRender}}gr.VISIBLE="visible",gr.SCROLL="scroll",gr.HIDDEN="hidden",gr._testWord="游",gr.CharacterCache=!0,gr.RightToLeft=!1;var Tr=!0;const xr=new f,Er=new m,yr=[],vr=[],Sr=[];var Rr;class br{constructor(){this._touches=[],this._touchPool=[],this._mouseTouch=new Ar(this._touches),this._pressKeys=new Set,this._keyEvent=new y,this._keyEvent._touches=this._touches}static get inst(){return Rr}static getTouchPos(t){var e,i;return null==t?(null===(e=Rr._touches[0])||void 0===e?void 0:e.pos)||f.EMPTY:(null===(i=Rr.getTouch(t))||void 0===i?void 0:i.pos)||f.EMPTY}static get touchTarget(){return Rr._touchTarget}static get touches(){return Rr._touches}static get touchCount(){return Rr._touches.length}static cancelClick(t){let e=null==t?Rr._touches[0]:Rr.getTouch(t);e&&(e.clickCancelled=!0)}static hasKeyDown(t){return Rr._pressKeys.has(t)}static __init__(t,e){let i=Rr=new br;i._stage=t,e.oncontextmenu=()=>!1,e.addEventListener("mousedown",(t=>{We.onIE||t.cancelable&&t.preventDefault(),i._touchInput||i.handleMouse(t,0)}),{passive:!1}),e.addEventListener("mouseup",(t=>{t.cancelable&&t.preventDefault(),i._touchInput||i.handleMouse(t,1)}),{passive:!1}),e.addEventListener("mousemove",(t=>{t.cancelable&&t.preventDefault(),i._touchInput||i.handleMouse(t,2)}),{passive:!1}),e.addEventListener("mouseout",(t=>{i._touchInput||i.handleMouse(t,3)}),{passive:!1}),e.addEventListener("touchstart",(t=>{i._touchInput=!0,Tr||br.isTextInputting||t.cancelable&&t.preventDefault(),i.handleTouch(t,0)}),{passive:!1}),e.addEventListener("touchend",(t=>{Tr||br.isTextInputting||t.cancelable&&t.preventDefault(),Tr=!1,i.handleTouch(t,1)}),{passive:!1}),e.addEventListener("touchmove",(t=>{t.cancelable&&t.preventDefault(),i.handleTouch(t,2)}),{passive:!1}),e.addEventListener("touchcancel",(t=>{t.cancelable&&t.preventDefault(),i.handleTouch(t,3)}),{passive:!1}),e.addEventListener("wheel",(t=>{i.handleMouse(t,4)}),{passive:!1}),e.addEventListener("pointerdown",(t=>{e.setPointerCapture(t.pointerId)})),e.addEventListener("pointerup",(t=>{e.releasePointerCapture(t.pointerId)}),!0);let r=We.document;r.addEventListener("keydown",(t=>{i.handleKeys(t)}),!0),r.addEventListener("keypress",(t=>{i.handleKeys(t)}),!0),r.addEventListener("keyup",(t=>{i.handleKeys(t)}),!0)}handleMouse(t,e){this._eventType=e,this._nativeEvent=t;let i=this._mouseTouch;xr.setTo(t.pageX||t.clientX,t.pageY||t.clientY),this._stage._canvasTransform&&this._stage._canvasTransform.invertTransformPoint(xr);let r=br.mouseX=xr.x,s=br.mouseY=xr.y;if(i.event.nativeEvent=t,3!=e&&br.mouseEventsEnabled){if(i.target=this._touchTarget=this.getNodeUnderPoint(r,s),(r!=i.pos.x||s!=i.pos.y)&&(this._stage._mouseMoveTime=We.now(),i.pos.setTo(r,s),i.move(),br.mouseEventsEnabled)){this.bubbleEvent(y.MOUSE_MOVE,i.event,i.target);for(let t of i.downTargets)t.event(y.MOUSE_DRAG,i.event)}}else i.target=this._touchTarget=null;if(i.lastRollOver!=i.target&&this.handleRollOver(i),0==e)i.began||(i.begin(),this._touches[0]=i,br.mouseEventsEnabled&&(this.handleFocus(),0==t.button?this.bubbleEvent(y.MOUSE_DOWN,i.event,i.target):this.bubbleEvent(y.RIGHT_MOUSE_DOWN,i.event,i.target)));else if(1==e){if(i.began&&(i.end(),this._touches.length=0,br.mouseEventsEnabled)){if(0==t.button?this.bubbleEvent(y.MOUSE_UP,i.event,i.target):this.bubbleEvent(y.RIGHT_MOUSE_UP,i.event,i.target),i.moved)for(let t of i.downTargets)t.event(y.MOUSE_DRAG_END,i.event);let e=i.clickTest();e&&(0==t.button?(this.bubbleEvent(y.CLICK,i.event,e),2==i.clickCount&&this.bubbleEvent(y.DOUBLE_CLICK,i.event,e)):this.bubbleEvent(y.RIGHT_CLICK,i.event,e))}}else 4==e&&br.mouseEventsEnabled&&(i.event.delta=.025*t.deltaY,this.bubbleEvent(y.MOUSE_WHEEL,i.event,i.target),i.event.delta=0)}handleTouch(t,e){this._eventType=e,this._nativeEvent=t;let i=t.changedTouches;for(let r=0;r<i.length;++r){let s=i[r];if(!br.multiTouchEnabled&&this._touches.length>0&&this._touches[0].touchId!=s.identifier)continue;xr.setTo(s.pageX,s.pageY),this._stage._canvasTransform&&this._stage._canvasTransform.invertTransformPoint(xr);let a=br.mouseX=xr.x,n=br.mouseY=xr.y,h=this.getTouch(s.identifier,0==e);if(h){if(h.event.nativeEvent=t,h.event.touchId=h.touchId,3!=e&&br.mouseEventsEnabled){if(h.target=this._touchTarget=this.getNodeUnderPoint(a,n),this._stage._mouseMoveTime=We.now(),(Math.abs(a-h.pos.x)>1.5||Math.abs(n-h.pos.y)>1.5)&&(h.pos.setTo(a,n),h.move(),br.mouseEventsEnabled)){this.bubbleEvent(y.MOUSE_MOVE,h.event,h.target);for(let t of h.downTargets)t.event(y.MOUSE_DRAG,h.event)}}else h.target=this._touchTarget=null;if(h.lastRollOver!=h.target&&this.handleRollOver(h),0==e)h.began||(h.begin(),br.mouseEventsEnabled&&(this.handleFocus(),this.bubbleEvent(y.MOUSE_DOWN,h.event,h.target)));else if((1==e||3==e)&&h.began){if(h.end(),br.mouseEventsEnabled){if(this.bubbleEvent(y.MOUSE_UP,h.event,h.target),h.moved)for(let t of h.downTargets)t.event(y.MOUSE_DRAG_END,h.event);if(3!=e){let t=h.clickTest();null!=t&&(this.bubbleEvent(y.CLICK,h.event,t),2==h.clickCount&&this.bubbleEvent(y.DOUBLE_CLICK,h.event,t))}}h.target=null,this.handleRollOver(h),h.reset(),this._touches.splice(this._touches.indexOf(h),1),this._touchPool.push(h)}}}}getTouch(t,e){let i=this._touches.find((e=>e.touchId==t));return i||!e||(i=this._touchPool.length>0?this._touchPool.pop():new Ar(this._touches),i.touchId=t,this._touches.push(i)),i}handleFocus(){if(br.isTextInputting&&this._stage.focus&&this._stage.focus.focus&&!this._stage.focus.contains(this._touchTarget)){let t=this._stage.focus._tf||this._stage.focus,e=this._touchTarget._tf||this._touchTarget;e.nativeInput&&e.multiline==t.multiline?t._focusOut():t.focus=!1}}handleKeys(t){let e=t.type,i=t.keyCode;if("keydown"===e?(0!=i&&this._pressKeys.add(i),this._pressKeys.add(t.key)):"keyup"===e&&(0!=i&&this._pressKeys.delete(i),this._pressKeys.delete(t.key)),this._keyEvent.nativeEvent=t,br.keyEventsEnabled){let t=this._stage.focus&&null!=this._stage.focus.event&&this._stage.focus.displayedInStage?this._stage.focus:this._stage,i=t;for(;i;)i.event(e,this._keyEvent.setTo(e,i,t)),i=i.parent}this._keyEvent.nativeEvent=null}getNodeUnderPoint(t,e){let i=this.getSpriteUnderPoint(this._stage,t,e);return i!=this._stage||(i=this.getSprite3DUnderPoint(t,e),i)?i:this._stage}getSpriteUnderPoint(t,e,i){let a=!h.isPlaying;if(t==this._stage){xr.setTo(e,i),t.fromParentPoint(xr),e=xr.x,i=xr.y;for(let n=t._children.length-1;n>-1;n--){let h=t._children[n];if(!h._is3D&&!h._destroyed&&(a&&!h.hasHideFlag(s.HideInHierarchy)||h._mouseState>1)&&(h._visible||h._getBit(r.DISABLE_VISIBILITY))){let t=this._getSpriteUnderPoint(h,e,i,a);if(t)return t}}return t}return this._getSpriteUnderPoint(t,e,i,a)}_getSpriteUnderPoint(t,e,i,a){xr.setTo(e,i),t.fromParentPoint(xr),e=xr.x,i=xr.y;let n=t._style.scrollRect;if(n&&!t._getBit(r.DISABLE_INNER_CLIPPING)&&(Er.setTo(n.x,n.y,n.width,n.height),!Er.contains(e,i)))return null;if(!a&&t.hitTestPrior&&!t.mouseThrough&&!this.hitTest(t,e,i,a))return null;for(let n=t._children.length-1;n>-1;n--){let h=t._children[n];if(!h._destroyed&&(a?!h.hasHideFlag(s.HideInHierarchy)||h.mouseThrough:h._mouseState>1)&&(h._visible||h._getBit(r.DISABLE_VISIBILITY)&&!h._getBit(r.HIDE_BY_EDITOR))){let t=this._getSpriteUnderPoint(h,e,i,a);if(t)return t}}for(let n=t._extUIChild.length-1;n>=0;n--){let h=t._extUIChild[n];if(!h._destroyed&&(a?!h.hasHideFlag(s.HideInHierarchy)||h.mouseThrough:h._mouseState>1)&&(h._visible||h._getBit(r.DISABLE_VISIBILITY))){let t=this._getSpriteUnderPoint(h,e,i,a);if(t)return t}}if(a){if(!t._getBit(r.LOCK_BY_EDITOR)&&!t.hasHideFlag(s.HideInHierarchy)&&this.hitTest(t,e,i,a))return t}else if(t.hitTestPrior&&!t.mouseThrough||this.hitTest(t,e,i,a))return t;return null}getSprite3DUnderPoint(t,e){return null}hitTest(t,e,i,r){let s=!1;t.scrollRect&&(e-=t._style.scrollRect.x,i-=t._style.scrollRect.y);let a=t._style.hitArea,n=t.mouseThrough;return r&&(a=null,n=!1),a?a.contains(e,i,t):((t.width>0&&t.height>0||n||a)&&(s=n?t.getGraphicBounds().contains(e,i):(a||Er.setTo(0,0,t.width,t.height)).contains(e,i)),s)}handleRollOver(t){if(!br.mouseEventsEnabled)return void(t.lastRollOver=t.target);yr.length=0,vr.length=0;let e=t.lastRollOver;for(;e;)vr.push(e),e=e.parent;for(t.lastRollOver=t.target,e=t.target;e;){let t=vr.indexOf(e);if(-1!=t){vr.splice(t,vr.length-t);break}yr.push(e),e=e.parent}let i=vr.length;if(i>0){for(let r=0;r<i;r++)e=vr[r],e._destroyed||e.event(y.MOUSE_OUT,t.event.setTo(y.MOUSE_OUT,e,e));vr.length=0}if(i=yr.length,i>0){for(let r=0;r<i;r++)e=yr[r],e.activeInHierarchy&&e.event(y.MOUSE_OVER,t.event.setTo(y.MOUSE_OVER,e,e));yr.length=0}}bubbleEvent(t,e,i){Sr.length=0;let r=i;for(;r;)r.activeInHierarchy&&Sr.push(r),r=r.parent;e._stopped=!1;for(let r of Sr)if(e.setTo(t,r,i),r.event(t,e),e._stopped)break}}br.multiTouchEnabled=!0,br.mouseEventsEnabled=!0,br.keyEventsEnabled=!0,br.clickTestThreshold=10,br.mouseX=0,br.mouseY=0,br.isTextInputting=!1,br.isiOSWKwebView=!1;const Cr={};class Ar{constructor(t){this.downPos=new f,this.downTargets=[],this.event=new y,this.event._touches=t,this.pos=this.event.touchPos,this.reset()}begin(){if(this.began=!0,this.clickCancelled=!1,this.moved=!1,this.downPos.copy(this.pos),this.downTargets.length=0,this.target){let t=this.target;for(;t;)this.downTargets.push(t),t=t.parent}}move(){this.moved=!0,(Math.abs(this.pos.x-this.downPos.x)>br.clickTestThreshold||Math.abs(this.pos.y-this.downPos.y)>br.clickTestThreshold)&&(this.clickCancelled=!0)}end(){this.began=!1;let t=performance.now(),e=Cr[this.touchId];e||(e={pos:new f,time:0,button:0},Cr[this.touchId]=e),0==this.downTargets.length||this.clickCancelled||Math.abs(this.pos.x-this.downPos.x)>br.clickTestThreshold||Math.abs(this.pos.y-this.downPos.y)>br.clickTestThreshold?(this.clickCancelled=!0,e.time=0,this.clickCount=1):(t-e.time<350&&Math.abs(this.pos.x-e.pos.x)<br.clickTestThreshold&&Math.abs(this.pos.y-e.pos.y)<br.clickTestThreshold&&e.button==this.event.button?this.clickCount=2:this.clickCount=1,e.time=t,e.pos.copy(this.pos),e.button=this.event.button)}clickTest(){if(this.clickCancelled)return this.downTargets.length=0,null;let t=this.downTargets[0];if(t.activeInHierarchy)return this.downTargets.length=0,t;for(t=this.target;t;){if(-1!=this.downTargets.indexOf(t)&&t.activeInHierarchy)break;t=t.parent}return this.downTargets.length=0,t}reset(){this.pos.setTo(0,0),this.touchId=0,this.clickCount=0,this.began=!1,this.moved=!1,this.target=null,this.downTargets.length=0,this.lastRollOver=null,this.clickCancelled=!1}}var wr,Mr,Dr,Ir,Pr,Br;t.WebGLMode=void 0,(wr=t.WebGLMode||(t.WebGLMode={}))[wr.Auto=0]="Auto",wr[wr.WebGL2=1]="WebGL2",wr[wr.WebGL1=2]="WebGL1";class Lr{static _nativeRender_enable(){}static enable(){return!0}static onStageResize(t,e){g.renderEngine.viewport(0,0,t,e),Y.width=t,Y.height=e}}Lr._isWebGL2=!1,Lr.isNativeRender_enable=!1;class Fr{constructor(){this.cmdArray=new Map}addCMD(t,e){this.cmdArray.set(t,e)}applyCMD(){g.renderEngine.applyRenderStateCMD(this)}clear(){this.cmdArray.clear()}}t.WebGLExtension=void 0,(Mr=t.WebGLExtension||(t.WebGLExtension={}))[Mr.OES_vertex_array_object=0]="OES_vertex_array_object",Mr[Mr.ANGLE_instanced_arrays=1]="ANGLE_instanced_arrays",Mr[Mr.OES_texture_half_float=2]="OES_texture_half_float",Mr[Mr.OES_texture_half_float_linear=3]="OES_texture_half_float_linear",Mr[Mr.OES_texture_float=4]="OES_texture_float",Mr[Mr.OES_element_index_uint=5]="OES_element_index_uint",Mr[Mr.OES_texture_float_linear=6]="OES_texture_float_linear",Mr[Mr.EXT_color_buffer_half_float=7]="EXT_color_buffer_half_float",Mr[Mr.EXT_shader_texture_lod=8]="EXT_shader_texture_lod",Mr[Mr.WEBGL_depth_texture=9]="WEBGL_depth_texture",Mr[Mr.EXT_sRGB=10]="EXT_sRGB",Mr[Mr.EXT_color_buffer_float=11]="EXT_color_buffer_float",Mr[Mr.EXT_texture_filter_anisotropic=12]="EXT_texture_filter_anisotropic",Mr[Mr.WEBGL_compressed_texture_s3tc=13]="WEBGL_compressed_texture_s3tc",Mr[Mr.WEBGL_compressed_texture_s3tc_srgb=14]="WEBGL_compressed_texture_s3tc_srgb",Mr[Mr.WEBGL_compressed_texture_pvrtc=15]="WEBGL_compressed_texture_pvrtc",Mr[Mr.WEBGL_compressed_texture_etc1=16]="WEBGL_compressed_texture_etc1",Mr[Mr.WEBGL_compressed_texture_etc=17]="WEBGL_compressed_texture_etc",Mr[Mr.WEBGL_compressed_texture_astc=18]="WEBGL_compressed_texture_astc";class Or{constructor(t){this._destroyed=!1,this._engine=t,this._gl=this._engine.gl,this._id=this._engine._IDCounter++}get destroyed(){return this._destroyed}setResourceManager(){}destroy(){this._destroyed||(this._destroyed=!0)}}class Nr extends Or{get mipmap(){return this._mipmap}get mipmapCount(){return this._mipmapCount}get gpuMemory(){return this._gpuMemory}set gpuMemory(e){this._gpuMemory=e,this._engine._addStatisticsInfo(t.RenderStatisticsInfo.GPUMemory,this._gpuMemory),this._engine._addStatisticsInfo(t.RenderStatisticsInfo.TextureMemeory,this._gpuMemory)}constructor(e,i,r,s,a,n,h,o){super(e),this._gpuMemory=0,this._baseMipmapLevel=0,this._maxMipmapLevel=0,this.resource=this._gl.createTexture(),this.width=r,this.height=s;const isPot=t=>0==(t&t-1);this.isPotSize=isPot(r)&&isPot(s),this._mipmap=n&&this.isPotSize,this._mipmapCount=this._mipmap?Math.max(Math.ceil(Math.log2(r))+1,Math.ceil(Math.log2(s))+1):1,this.useSRGBLoad=h,this.gammaCorrection=o,this.target=i,this.filterMode=t.FilterMode.Bilinear,this.wrapU=t.WrapMode.Repeat,this.wrapV=t.WrapMode.Repeat,this.wrapW=t.WrapMode.Repeat,this.anisoLevel=4}get filterMode(){return this._filterMode}set filterMode(t){if(this._filterMode!=t&&this.resource){let e=this._gl,i=this.mipmap,r=this.getFilteMinrParam(t,i);this._setTexParameteri(e.TEXTURE_MIN_FILTER,r);let s=this.getFilterMagParam(t);this._setTexParameteri(e.TEXTURE_MAG_FILTER,s),this._filterMode=t}}get wrapU(){return this._warpU}set wrapU(t){if(this._warpU!=t&&this.resource){let e=this._gl,i=this.getWrapParam(t);this._setWrapMode(e.TEXTURE_WRAP_S,i),this._warpU=t}}get wrapV(){return this._warpV}set wrapV(t){if(this._warpV!=t&&this.resource){let e=this._gl,i=this.getWrapParam(t);this._setWrapMode(e.TEXTURE_WRAP_T,i),this._warpV=t}}get wrapW(){return this._warpW}set wrapW(t){this._warpW=t}get anisoLevel(){return this._anisoLevel}set anisoLevel(e){let i=this._engine._supportCapatable.getExtension(t.WebGLExtension.EXT_texture_filter_anisotropic);if(i){let t=this._gl.getParameter(i.MAX_TEXTURE_MAX_ANISOTROPY_EXT),r=Math.max(1,Math.min(t,e));this._setTexParametexf(i.TEXTURE_MAX_ANISOTROPY_EXT,r),this._anisoLevel=r}else this._anisoLevel=1}set baseMipmapLevel(t){this._engine.isWebGL2&&this._setTexParameteri(this._gl.TEXTURE_BASE_LEVEL,t)}get baseMipmapLevel(){return this._baseMipmapLevel}set maxMipmapLevel(t){this._engine.isWebGL2&&this._setTexParameteri(this._gl.TEXTURE_MAX_LEVEL,t)}get maxMipmapLevel(){return this._maxMipmapLevel}get compareMode(){return this._compareMode}set compareMode(t){this._compareMode=t}_setTexParameteri(t,e){let i=this._gl,r=this.target;this._engine._bindTexture(r,this.resource),i.texParameteri(r,t,e),this._engine._bindTexture(r,null)}_setTexParametexf(t,e){let i=this._gl,r=this.target;this._engine._bindTexture(r,this.resource),i.texParameterf(r,t,e),this._engine._bindTexture(r,null)}getFilteMinrParam(e,i){let r=this._gl;switch(e){case t.FilterMode.Point:return i?r.NEAREST_MIPMAP_NEAREST:r.NEAREST;case t.FilterMode.Bilinear:return i?r.LINEAR_MIPMAP_NEAREST:r.LINEAR;case t.FilterMode.Trilinear:return i?r.LINEAR_MIPMAP_LINEAR:r.LINEAR;default:return i?r.LINEAR_MIPMAP_NEAREST:r.LINEAR}}getFilterMagParam(e){let i=this._gl;switch(e){case t.FilterMode.Point:return i.NEAREST;case t.FilterMode.Bilinear:case t.FilterMode.Trilinear:default:return i.LINEAR}}getWrapParam(e){let i=this._gl;switch(e){case t.WrapMode.Repeat:return i.REPEAT;case t.WrapMode.Clamp:return i.CLAMP_TO_EDGE;case t.WrapMode.Mirrored:return i.MIRRORED_REPEAT;default:return i.REPEAT}}_setWrapMode(t,e){let i=this._gl;this.isPotSize||(e=i.CLAMP_TO_EDGE),this._setTexParameteri(t,e)}dispose(){this._gl.deleteTexture(this.resource),this._engine._addStatisticsInfo(t.RenderStatisticsInfo.GPUMemory,-this._gpuMemory),this._engine._addStatisticsInfo(t.RenderStatisticsInfo.TextureMemeory,-this._gpuMemory),this._gpuMemory=0}}class Ur extends Or{get gpuMemory(){return this._gpuMemory}set gpuMemory(e){this._gpuMemory=e,this._engine._addStatisticsInfo(t.RenderStatisticsInfo.GPUMemory,this._gpuMemory),this._engine._addStatisticsInfo(t.RenderStatisticsInfo.RenderTextureMemory,this._gpuMemory)}constructor(t,e,i,r,s,a){super(t),this._gpuMemory=0,this.colorFormat=e,this.depthStencilFormat=i,this._isCube=r,this._generateMipmap=s,this._samples=a,this._textures=[],this._depthTexture=null,this._framebuffer=this._gl.createFramebuffer(),a>1&&(this._msaaFramebuffer=this._gl.createFramebuffer())}dispose(){this._textures.forEach((t=>{t&&t.dispose()})),this._textures=null,this._depthTexture&&this._depthTexture.dispose(),this._depthTexture=null,this._framebuffer&&this._gl.deleteFramebuffer(this._framebuffer),this._framebuffer=null,this._depthbuffer&&this._gl.deleteRenderbuffer(this._depthbuffer),this._depthbuffer=null,this._msaaFramebuffer&&this._gl.deleteFramebuffer(this._msaaFramebuffer),this._msaaFramebuffer=null,this._msaaRenderbuffer&&this._gl.deleteRenderbuffer(this._msaaRenderbuffer),this._msaaRenderbuffer=null,this._engine._addStatisticsInfo(t.RenderStatisticsInfo.GPUMemory,-this._gpuMemory),this._engine._addStatisticsInfo(t.RenderStatisticsInfo.RenderTextureMemory,-this._gpuMemory),this._gpuMemory=0}}t.TextureCompareMode=void 0,(Dr=t.TextureCompareMode||(t.TextureCompareMode={}))[Dr.None=0]="None",Dr[Dr.LEQUAL=1]="LEQUAL",Dr[Dr.GEQUAL=2]="GEQUAL",Dr[Dr.LESS=3]="LESS",Dr[Dr.GREATER=4]="GREATER",Dr[Dr.EQUAL=5]="EQUAL",Dr[Dr.NOTEQUAL=6]="NOTEQUAL",Dr[Dr.ALWAYS=7]="ALWAYS",Dr[Dr.NEVER=8]="NEVER";class Gr extends Or{constructor(e){super(e),this._glParam={internalFormat:0,format:0,type:0},this._sRGB=this._engine._supportCapatable.getExtension(t.WebGLExtension.EXT_sRGB),this._oesTextureHalfFloat=this._engine._supportCapatable.getExtension(t.WebGLExtension.OES_texture_half_float),this._compressdTextureS3tc_srgb=this._engine._supportCapatable.getExtension(t.WebGLExtension.WEBGL_compressed_texture_s3tc_srgb),this._compressedTextureEtc1=this._engine._supportCapatable.getExtension(t.WebGLExtension.WEBGL_compressed_texture_etc1),this._compressedTextureS3tc=this._engine._supportCapatable.getExtension(t.WebGLExtension.WEBGL_compressed_texture_s3tc),this._compressedTextureETC=this._engine._supportCapatable.getExtension(t.WebGLExtension.WEBGL_compressed_texture_etc),this._compressedTextureASTC=this._engine._supportCapatable.getExtension(t.WebGLExtension.WEBGL_compressed_texture_astc),this._webgl_depth_texture=this._engine._supportCapatable.getExtension(t.WebGLExtension.WEBGL_depth_texture)}glTextureParam(e,i){let r=this._gl;switch(this._glParam.internalFormat=null,this._glParam.format=null,this._glParam.type=null,e){case t.TextureFormat.R8G8B8:this._glParam.internalFormat=i?this._sRGB.SRGB_EXT:r.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=r.UNSIGNED_BYTE;break;case t.TextureFormat.R8G8B8A8:this._glParam.internalFormat=i?this._sRGB.SRGB_ALPHA_EXT:r.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=r.UNSIGNED_BYTE;break;case t.TextureFormat.R5G6B5:this._glParam.internalFormat=r.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=r.UNSIGNED_SHORT_5_6_5;break;case t.TextureFormat.R32G32B32A32:this._glParam.internalFormat=r.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=r.FLOAT;break;case t.TextureFormat.R32G32B32:this._glParam.internalFormat=r.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=r.FLOAT;break;case t.TextureFormat.R16G16B16A16:this._glParam.internalFormat=r.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._oesTextureHalfFloat.HALF_FLOAT_OES;break;case t.TextureFormat.R16G16B16:this._glParam.internalFormat=r.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._oesTextureHalfFloat.HALF_FLOAT_OES;break;case t.TextureFormat.DXT1:this._glParam.internalFormat=i?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT1_EXT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=r.UNSIGNED_BYTE;break;case t.TextureFormat.DXT3:this._glParam.internalFormat=i?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT3_EXT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=r.UNSIGNED_BYTE;break;case t.TextureFormat.DXT5:this._glParam.internalFormat=i?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT5_EXT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=r.UNSIGNED_BYTE;break;case t.TextureFormat.ETC1RGB:this._glParam.internalFormat=this._compressedTextureEtc1.COMPRESSED_RGB_ETC1_WEBGL,this._glParam.format=this._glParam.internalFormat,this._glParam.type=r.UNSIGNED_BYTE;break;case t.TextureFormat.ETC2RGBA:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_RGBA8_ETC2_EAC,this._glParam.format=this._glParam.internalFormat,this._glParam.type=r.UNSIGNED_BYTE;break;case t.TextureFormat.ETC2RGB:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_RGB8_ETC2,this._glParam.format=this._glParam.internalFormat,this._glParam.type=r.UNSIGNED_BYTE;break;case t.TextureFormat.ETC2SRGB:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_SRGB8_ETC2,this._glParam.format=this._glParam.internalFormat,this._glParam.type=r.UNSIGNED_BYTE;break;case t.TextureFormat.ETC2SRGB_Alpha8:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC,this._glParam.format=this._glParam.internalFormat,this._glParam.type=r.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC4x4:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_4x4_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=r.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC6x6:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_6x6_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=r.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC8x8:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_8x8_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=r.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC10x10:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_10x10_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=r.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC12x12:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_12x12_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=r.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC4x4SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=r.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC6x6SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=r.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC8x8SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=r.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC10x10SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=r.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC12x12SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=r.UNSIGNED_BYTE;break;default:throw"Unknown Texture Format."}return this._glParam}glRenderTextureParam(e,i){let r=this._gl;switch(this._glParam.internalFormat=null,this._glParam.format=null,this._glParam.type=null,e){case t.RenderTargetFormat.R8G8B8:this._glParam.internalFormat=i?this._sRGB.SRGB_EXT:r.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=r.UNSIGNED_BYTE;break;case t.RenderTargetFormat.R8G8B8A8:this._glParam.internalFormat=i?this._sRGB.SRGB_EXT:r.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=r.UNSIGNED_BYTE;break;case t.RenderTargetFormat.R16G16B16:this._glParam.internalFormat=r.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._oesTextureHalfFloat.HALF_FLOAT_OES;break;case t.RenderTargetFormat.R16G16B16A16:this._glParam.internalFormat=r.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._oesTextureHalfFloat.HALF_FLOAT_OES;break;case t.RenderTargetFormat.R32G32B32:this._glParam.internalFormat=r.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=r.FLOAT;break;case t.RenderTargetFormat.R32G32B32A32:this._glParam.internalFormat=r.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=r.FLOAT;break;case t.RenderTargetFormat.DEPTH_16:this._glParam.internalFormat=r.DEPTH_COMPONENT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=r.UNSIGNED_SHORT;break;case t.RenderTargetFormat.DEPTHSTENCIL_24_8:this._glParam.internalFormat=r.DEPTH_STENCIL,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._webgl_depth_texture.UNSIGNED_INT_24_8_WEBGL;break;case t.RenderTargetFormat.DEPTH_32:this._glParam.internalFormat=r.DEPTH_COMPONENT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=r.UNSIGNED_INT;break;case t.RenderTargetFormat.STENCIL_8:default:throw"render texture format wrong."}return this._glParam}glRenderBufferParam(e,i){let r=this._gl;switch(e){case t.RenderTargetFormat.DEPTH_16:return{internalFormat:r.DEPTH_COMPONENT16,attachment:r.DEPTH_ATTACHMENT};case t.RenderTargetFormat.DEPTHSTENCIL_24_8:return{internalFormat:r.DEPTH_STENCIL,attachment:r.DEPTH_STENCIL_ATTACHMENT};case t.RenderTargetFormat.DEPTH_32:return{internalFormat:r.DEPTH_STENCIL,attachment:r.DEPTH_ATTACHMENT};case t.RenderTargetFormat.STENCIL_8:return{internalFormat:r.STENCIL_INDEX8,attachment:r.STENCIL_ATTACHMENT};default:return null}}glRenderTargetAttachment(e){let i=this._gl;switch(e){case t.RenderTargetFormat.DEPTH_16:return i.DEPTH_ATTACHMENT;case t.RenderTargetFormat.DEPTHSTENCIL_24_8:return i.DEPTH_STENCIL_ATTACHMENT;case t.RenderTargetFormat.DEPTH_32:return i.DEPTH_ATTACHMENT;case t.RenderTargetFormat.STENCIL_8:return i.STENCIL_ATTACHMENT;case t.RenderTargetFormat.R8G8B8:case t.RenderTargetFormat.R8G8B8A8:case t.RenderTargetFormat.R16G16B16:case t.RenderTargetFormat.R16G16B16A16:case t.RenderTargetFormat.R32G32B32:case t.RenderTargetFormat.R32G32B32A32:return i.COLOR_ATTACHMENT0;default:throw"render format."}}getTarget(e){let i=this._gl;switch(e){case t.TextureDimension.Tex2D:return i.TEXTURE_2D;case t.TextureDimension.Cube:return i.TEXTURE_CUBE_MAP;default:throw"texture dimension wrong in WebGL1."}}getFormatPixelsParams(e){let i={channels:0,bytesPerPixel:0,dataTypedCons:Uint8Array,typedSize:1};switch(e){case t.TextureFormat.R8G8B8A8:return i.channels=4,i.bytesPerPixel=4,i.dataTypedCons=Uint8Array,i.typedSize=1,i;case t.TextureFormat.R8G8B8:return i.channels=3,i.bytesPerPixel=3,i.dataTypedCons=Uint8Array,i.typedSize=1,i;case t.TextureFormat.R5G6B5:return i.channels=3,i.bytesPerPixel=2,i.dataTypedCons=Uint16Array,i.typedSize=2,i;case t.TextureFormat.R16G16B16:return i.channels=3,i.bytesPerPixel=6,i.dataTypedCons=Uint16Array,i.typedSize=2,i;case t.TextureFormat.R16G16B16A16:return i.channels=4,i.bytesPerPixel=8,i.dataTypedCons=Uint16Array,i.typedSize=2,i;case t.TextureFormat.R32G32B32:return i.channels=3,i.bytesPerPixel=12,i.dataTypedCons=Float32Array,i.typedSize=4,i;case t.TextureFormat.R32G32B32A32:return i.channels=4,i.bytesPerPixel=16,i.dataTypedCons=Float32Array,i.typedSize=4,i;default:return i}}getGLtexMemory(t){let e=this._gl,i=0,r=0,s=0,a=this._sRGB?this._sRGB.SRGB_EXT:e.RGB,n=this._sRGB?this._sRGB.SRGB_ALPHA_EXT:e.RGBA;switch(t.internalFormat){case a:case e.RGB:i=3;break;case n:case e.RGBA:i=4;break;default:i=0}switch(t.type){case e.UNSIGNED_BYTE:r=1;break;case e.UNSIGNED_SHORT_5_6_5:r=2/3;break;case e.FLOAT:r=4;break;case this._oesTextureHalfFloat.HALF_FLOAT_OES:r=2;break;default:r=0}return s=i*r*t.width*t.height,t.mipmap&&(s*=1.333),t.target==e.TEXTURE_CUBE_MAP?s*=6:t.target==e.TEXTURE_2D&&(s*=1),s}getGLRTTexMemory(e,i,r,s,a,n,h){let getpixelbyte=e=>{let i=0;switch(e){case t.RenderTargetFormat.R8G8B8:i=3;break;case t.RenderTargetFormat.R8G8B8A8:i=4;break;case t.RenderTargetFormat.R16G16B16A16:i=8;break;case t.RenderTargetFormat.R32G32B32:i=12;break;case t.RenderTargetFormat.R32G32B32A32:i=16;break;case t.RenderTargetFormat.R16G16B16:i=6;break;case t.RenderTargetFormat.DEPTH_16:i=2;break;case t.RenderTargetFormat.STENCIL_8:i=1;break;case t.RenderTargetFormat.DEPTHSTENCIL_24_8:case t.RenderTargetFormat.DEPTH_32:i=4}return i},o=getpixelbyte(r);return n>1&&(o*=2),h&&(o*=6),a&&(o*=1.333),o*e*i+getpixelbyte(s)*e*i}supportSRGB(e,i){switch(e){case t.TextureFormat.R8G8B8:case t.TextureFormat.R8G8B8A8:return this._engine.getCapable(t.RenderCapable.Texture_SRGB)&&!i;case t.TextureFormat.DXT1:case t.TextureFormat.DXT3:case t.TextureFormat.DXT5:return this._engine.getCapable(t.RenderCapable.COMPRESS_TEXTURE_S3TC_SRGB)&&!i;default:return!1}}supportGenerateMipmap(e){switch(e){case t.RenderTargetFormat.DEPTH_16:case t.RenderTargetFormat.DEPTHSTENCIL_24_8:case t.RenderTargetFormat.DEPTH_32:case t.RenderTargetFormat.STENCIL_8:return!1;default:return!0}}isSRGBFormat(e){switch(e){case t.TextureFormat.ETC2SRGB:case t.TextureFormat.ETC2SRGB_Alpha8:case t.TextureFormat.ASTC4x4SRGB:case t.TextureFormat.ASTC6x6SRGB:case t.TextureFormat.ASTC8x8SRGB:case t.TextureFormat.ASTC10x10SRGB:case t.TextureFormat.ASTC12x12SRGB:return!0;default:return!1}}createTextureInternal(t,e,i,r,s,a){let n=this.isSRGBFormat(r)||a&&this.supportSRGB(r,s),h=1;!n&&a&&(h=2.2);let o=this.getTarget(t),l=new Nr(this._engine,o,e,i,t,s,n,h),_=this.glTextureParam(r,n);return l.internalFormat=_.internalFormat,l.format=_.format,l.type=_.type,l}setTextureImageData(t,e,i,r){t.width==e.width&&t.height==e.height||console.warn("setTextureImageData: size not match");let s=t.target,a=t.internalFormat,n=t.format,h=t.type;t.width,t.height;let o=t._gl;i&&o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),r&&o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(t.target,t.resource),o.texImage2D(s,0,a,n,h,e),t.gpuMemory=this.getGLtexMemory(t),t.mipmap&&o.generateMipmap(t.target),this._engine._bindTexture(t.target,null),i&&o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),r&&o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,!1)}setTexturebySubImageData(t,e,i,r,s,a){let n=t.target;t.internalFormat;let h=t.format,o=t.type;e.width,e.height;let l=t._gl;s&&l.pixelStorei(l.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&l.pixelStorei(l.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(t.target,t.resource),l.texSubImage2D(n,0,i,r,h,o,e),t.gpuMemory=this.getGLtexMemory(t),t.mipmap&&l.generateMipmap(t.target),this._engine._bindTexture(t.target,null),s&&l.pixelStorei(l.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&l.pixelStorei(l.UNPACK_FLIP_Y_WEBGL,!1)}initVideoTextureData(t){let e=t.target;t.internalFormat;let i=t.format,r=t.type,s=t.width,a=t.height,n=t._gl;this._engine._bindTexture(t.target,t.resource),n.texImage2D(e,0,t.internalFormat,s,a,0,i,r,null),t.gpuMemory=this.getGLtexMemory(t),t.mipmap&&n.generateMipmap(t.target),this._engine._bindTexture(t.target,null)}setTexturePixelsData(t,e,i,r){let s=t.target,a=t.internalFormat,n=t.format,h=t.type,o=t.width,l=t.height,_=o%4==0&&l%4==0,u=t._gl;i&&u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),r&&u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,!0),_||u.pixelStorei(u.UNPACK_ALIGNMENT,1),this._engine._bindTexture(t.target,t.resource),u.texImage2D(s,0,a,o,l,0,n,h,e),t.gpuMemory=this.getGLtexMemory(t),t.mipmap&&u.generateMipmap(t.target),this._engine._bindTexture(t.target,null),i&&u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),r&&u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,!1),_||u.pixelStorei(u.UNPACK_ALIGNMENT,4)}setTextureSubPixelsData(t,e,i,r,s,a,n,h,o,l){r=r&&0==i;let _=t.target;t.internalFormat;let u=t.format,d=t.type,c=n%4==0&&h%4==0,p=t._gl;o&&p.pixelStorei(p.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),l&&p.pixelStorei(p.UNPACK_FLIP_Y_WEBGL,!0),c||p.pixelStorei(p.UNPACK_ALIGNMENT,1),this._engine._bindTexture(t.target,t.resource),p.texSubImage2D(_,i,s,a,n,h,u,d,e),t.mipmap&&r&&p.generateMipmap(t.target),this._engine._bindTexture(t.target,null),o&&p.pixelStorei(p.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),l&&p.pixelStorei(p.UNPACK_FLIP_Y_WEBGL,!1),c||p.pixelStorei(p.UNPACK_ALIGNMENT,4)}setTextureDDSData(t,e){let i=t.target,r=t.internalFormat;t.format,t.type;let s=t.width,a=t.height,n=e.source,h=e.dataOffset,o=e.bpp,l=e.blockBytes,_=e.mipmapCount,u=s%4==0&&a%4==0,d=t._gl;u||d.pixelStorei(d.UNPACK_ALIGNMENT,1),this._engine._bindTexture(t.target,t.resource);let c=s,p=a,f=0;for(let t=0;t<_;t++){let e=Math.max(4,c)/4*Math.max(4,p)/4*l,s=new Uint8Array(n,h,e);d.compressedTexImage2D(i,t,r,c,p,0,s),f+=s.length,h+=o?c*p*(o/8):e,c*=.5,p*=.5,c=Math.max(1,c),p=Math.max(1,p)}t.gpuMemory=f,this._engine._bindTexture(t.target,null),u||d.pixelStorei(d.UNPACK_ALIGNMENT,4)}setTextureKTXData(t,e){let i=e.source,r=e.compress,s=t.target,a=t.internalFormat,n=t.format,h=t.type;t.mipmapCount;let o=t.width,l=t.height,_=o%4==0&&l%4==0,u=t._gl;_||u.pixelStorei(u.UNPACK_ALIGNMENT,1),this._engine._bindTexture(t.target,t.resource);let d=o,c=l,p=e.headerOffset+e.bytesOfKeyValueData,f=0;for(let t=0;t<e.mipmapCount;t++){let e=new Int32Array(i,p,1)[0];p+=4;let o=new Uint8Array(i,p,e);r&&u.compressedTexImage2D(s,t,a,d,c,0,o),!r&&u.texImage2D(s,t,a,d,c,0,n,h,o),f+=o.length,p+=e,p+=3-(e+3)%4,d=Math.max(1,.5*d),c=Math.max(1,.5*c)}t.gpuMemory=f,this._engine._bindTexture(t.target,null),_||u.pixelStorei(u.UNPACK_ALIGNMENT,4)}setTextureHDRData(t,e){let i=e.readScanLine();this.setTexturePixelsData(t,i,!1,!1)}setCubeImageData(t,e,i,r){let s=t._gl;const a=[s.TEXTURE_CUBE_MAP_POSITIVE_Z,s.TEXTURE_CUBE_MAP_NEGATIVE_Z,s.TEXTURE_CUBE_MAP_POSITIVE_X,s.TEXTURE_CUBE_MAP_NEGATIVE_X,s.TEXTURE_CUBE_MAP_POSITIVE_Y,s.TEXTURE_CUBE_MAP_NEGATIVE_Y];let n=t.internalFormat,h=t.format,o=t.type;t.width,t.height,i&&s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),r&&s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(t.target,t.resource);for(let t=0;t<a.length;t++){let i=a[t];s.texImage2D(i,0,n,h,o,e[t])}t.mipmap&&s.generateMipmap(t.target),this._engine._bindTexture(t.target,null),t.gpuMemory=this.getGLtexMemory(t),i&&s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),r&&s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!1)}setCubePixelsData(t,e,i,r){let s=t._gl;const a=[s.TEXTURE_CUBE_MAP_POSITIVE_Z,s.TEXTURE_CUBE_MAP_NEGATIVE_Z,s.TEXTURE_CUBE_MAP_POSITIVE_X,s.TEXTURE_CUBE_MAP_NEGATIVE_X,s.TEXTURE_CUBE_MAP_POSITIVE_Y,s.TEXTURE_CUBE_MAP_NEGATIVE_Y];t.target;let n=t.internalFormat,h=t.format,o=t.type,l=t.width,_=t.height,u=l%4==0;if(i&&s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),r&&s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!0),u||s.pixelStorei(s.UNPACK_ALIGNMENT,1),this._engine._bindTexture(t.target,t.resource),e){for(let t=0;t<a.length;t++){let i=a[t];s.texImage2D(i,0,n,l,_,0,h,o,e[t])}t.mipmap&&s.generateMipmap(t.target)}else{for(let t=0;t<a.length;t++){let e=a[t];s.texImage2D(e,0,n,l,_,0,h,o,null)}t.mipmap&&s.generateMipmap(t.target)}this._engine._bindTexture(t.target,null),t.gpuMemory=this.getGLtexMemory(t),i&&s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),r&&s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!1),u||s.pixelStorei(s.UNPACK_ALIGNMENT,4)}setCubeSubPixelData(t,e,i,r,s,a,n,h,o,l){r=r&&0==i;let _=t._gl;const u=[_.TEXTURE_CUBE_MAP_POSITIVE_Z,_.TEXTURE_CUBE_MAP_NEGATIVE_Z,_.TEXTURE_CUBE_MAP_POSITIVE_X,_.TEXTURE_CUBE_MAP_NEGATIVE_X,_.TEXTURE_CUBE_MAP_POSITIVE_Y,_.TEXTURE_CUBE_MAP_NEGATIVE_Y];t.target,t.internalFormat;let d=t.format,c=t.type,p=n%4==0;o&&_.pixelStorei(_.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),l&&_.pixelStorei(_.UNPACK_FLIP_Y_WEBGL,!0),p||_.pixelStorei(_.UNPACK_ALIGNMENT,1),this._engine._bindTexture(t.target,t.resource);for(let t=0;t<u.length;t++){let r=u[t];_.texSubImage2D(r,i,s,a,n,h,d,c,e[t])}t.mipmap&&r&&_.generateMipmap(t.target),this._engine._bindTexture(t.target,null),o&&_.pixelStorei(_.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),l&&_.pixelStorei(_.UNPACK_FLIP_Y_WEBGL,!1),p||_.pixelStorei(_.UNPACK_ALIGNMENT,4)}setCubeDDSData(e,i){let r=e.internalFormat,s=e.format,a=e.type,n=e.width,h=e.height,o=i.source,l=i.dataOffset,_=i.bpp,u=i.blockBytes,d=i.mipmapCount,c=n%4==0&&h%4==0;c=!0;let p=e._gl;this._engine._bindTexture(e.target,e.resource);const f=[p.TEXTURE_CUBE_MAP_POSITIVE_X,p.TEXTURE_CUBE_MAP_NEGATIVE_X,p.TEXTURE_CUBE_MAP_POSITIVE_Y,p.TEXTURE_CUBE_MAP_NEGATIVE_Y,p.TEXTURE_CUBE_MAP_POSITIVE_Z,p.TEXTURE_CUBE_MAP_NEGATIVE_Z];let m=this.getFormatPixelsParams(i.format),g=m.bytesPerPixel/m.channels,T=i.format==t.TextureFormat.R32G32B32A32?Float32Array:Uint16Array,x=0;if(i.compressed)for(let t=0;t<6;t++){let i=f[t],s=n,a=h;for(let t=0;t<d;t++){let n=Math.max(4,s)/4*Math.max(4,a)/4*u,h=new Uint8Array(o,l,n);(e.mipmap||0==t)&&p.compressedTexImage2D(i,t,r,s,a,0,h),x+=h.byteLength,l+=_?s*a*(_/8):n,s*=.5,a*=.5,s=Math.max(1,s),a=Math.max(1,a)}}else for(let t=0;t<6;t++){let e=f[t],i=n,_=h;for(let t=0;t<d;t++){let n=i*_*m.channels,h=new T(o,l,n);p.texImage2D(e,t,r,i,_,0,s,a,h),x+=h.byteLength,l+=n*g,i*=.5,_*=.5,i=Math.max(1,i),_=Math.max(1,_)}}e.gpuMemory=x,this._engine._bindTexture(e.target,null)}setCubeKTXData(t,e){let i=e.source,r=e.compress,s=t.internalFormat,a=t.format,n=t.type;e.mipmapCount;let h=t.width,o=t.height,l=h%4==0&&o%4==0,_=t._gl;const u=[_.TEXTURE_CUBE_MAP_POSITIVE_X,_.TEXTURE_CUBE_MAP_NEGATIVE_X,_.TEXTURE_CUBE_MAP_POSITIVE_Y,_.TEXTURE_CUBE_MAP_NEGATIVE_Y,_.TEXTURE_CUBE_MAP_POSITIVE_Z,_.TEXTURE_CUBE_MAP_NEGATIVE_Z];l||_.pixelStorei(_.UNPACK_ALIGNMENT,1),this._engine._bindTexture(t.target,t.resource);let d=h,c=o,p=e.headerOffset+e.bytesOfKeyValueData,f=0;for(let t=0;t<e.mipmapCount;t++){let h=new Int32Array(i,p,1)[0];p+=4;for(let o=0;o<6;o++){let l=u[o];if(r){let e=new Uint8Array(i,p,h);_.compressedTexImage2D(l,t,s,d,c,0,e),f+=e.byteLength}else{let r=this.getFormatPixelsParams(e.format),o=h/r.typedSize,u=new r.dataTypedCons(i,p,o);_.texImage2D(l,t,s,d,c,0,a,n,u),f+=u.byteLength}p+=h,p+=3-(h+3)%4}d=Math.max(1,.5*d),c=Math.max(1,.5*c)}this._engine._bindTexture(t.target,null),t.gpuMemory=f,l||_.pixelStorei(_.UNPACK_ALIGNMENT,4)}setTextureCompareMode(e,i){return t.TextureCompareMode.None}bindRenderTarget(t,e=0){let i=this._gl,r=t._framebuffer;if(i.bindFramebuffer(i.FRAMEBUFFER,r),t._isCube){let r=t._textures[0];i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_CUBE_MAP_POSITIVE_X+e,r.resource,0)}}bindoutScreenTarget(){let t=this._gl;t.bindFramebuffer(t.FRAMEBUFFER,null)}unbindRenderTarget(t){let e=t._gl;t._generateMipmap&&t._textures.forEach((t=>{let i=t.target;this._engine._bindTexture(i,t.resource),e.generateMipmap(i),this._engine._bindTexture(i,null)})),e.bindFramebuffer(e.FRAMEBUFFER,null)}createRenderTextureInternal(e,i,r,s,a,n){a=a&&this.supportGenerateMipmap(s);let h=1;n&&(h=2.2);let o=this.getTarget(e),l=new Nr(this._engine,o,i,r,e,a,false,h),_=this.glRenderTextureParam(s,false);l.internalFormat=_.internalFormat,l.format=_.format,l.type=_.type;let u=l.internalFormat,d=l.format,c=l.type,p=l._gl;return this._engine._bindTexture(l.target,l.resource),p.texImage2D(o,0,u,i,r,0,d,c,null),this._engine._bindTexture(l.target,null),s!=t.RenderTargetFormat.DEPTH_16&&s!=t.RenderTargetFormat.DEPTH_32&&s!=t.RenderTargetFormat.DEPTHSTENCIL_24_8||(l.filterMode=t.FilterMode.Point),l}createRenderTextureCubeInternal(e,i,r,s,a){s=s&&this.supportGenerateMipmap(r);let n=1;a&&(n=2.2);let h=this.getTarget(e),o=new Nr(this._engine,h,i,i,e,s,false,n),l=this.glRenderTextureParam(r,false);o.internalFormat=l.internalFormat,o.format=l.format,o.type=l.type;let _=o.internalFormat,u=o.format,d=o.type,c=o._gl;const p=[c.TEXTURE_CUBE_MAP_POSITIVE_Z,c.TEXTURE_CUBE_MAP_NEGATIVE_Z,c.TEXTURE_CUBE_MAP_POSITIVE_X,c.TEXTURE_CUBE_MAP_NEGATIVE_X,c.TEXTURE_CUBE_MAP_POSITIVE_Y,c.TEXTURE_CUBE_MAP_NEGATIVE_Y];this._engine._bindTexture(o.target,o.resource);for(let t=0;t<p.length;t++){let e=p[t];c.texImage2D(e,0,_,i,i,0,u,d,null)}return this._engine._bindTexture(o.target,null),r!=t.RenderTargetFormat.DEPTH_16&&r!=t.RenderTargetFormat.DEPTH_32&&r!=t.RenderTargetFormat.DEPTHSTENCIL_24_8||(o.filterMode=t.FilterMode.Point),o}createRenderTargetInternal(e,i,r,s,a,n,h){let o=this.createRenderTextureInternal(t.TextureDimension.Tex2D,e,i,r,a,n),l=new Ur(this._engine,r,s,!1,o.mipmap,1);l.gpuMemory=this.getGLRTTexMemory(e,i,r,s,a,1,!1),l.colorFormat=r,l.depthStencilFormat=s,l._textures.push(o);let _=l._framebuffer,u=l._gl;u.bindFramebuffer(u.FRAMEBUFFER,_);let d=this.glRenderTargetAttachment(r);u.framebufferTexture2D(u.FRAMEBUFFER,d,u.TEXTURE_2D,o.resource,0);let c=this.glRenderBufferParam(s,!1);if(c){let t=this.createRenderbuffer(e,i,c.internalFormat,l._samples);l._depthbuffer=t,u.framebufferRenderbuffer(u.FRAMEBUFFER,c.attachment,u.RENDERBUFFER,t)}return u.bindFramebuffer(u.FRAMEBUFFER,null),l}createRenderTargetCubeInternal(e,i,r,s,a,n){let h=this.createRenderTextureCubeInternal(t.TextureDimension.Cube,e,i,s,a),o=new Ur(this._engine,i,r,!0,h.mipmap,1);o.gpuMemory=this.getGLRTTexMemory(e,e,i,r,s,1,!0),o._textures.push(h);let l=o._framebuffer,_=o._gl;_.bindFramebuffer(_.FRAMEBUFFER,l);let u=this.glRenderBufferParam(r,!1);if(u){let t=this.createRenderbuffer(e,e,u.internalFormat,o._samples);o._depthbuffer=t,_.framebufferRenderbuffer(_.FRAMEBUFFER,u.attachment,_.RENDERBUFFER,t)}return _.bindFramebuffer(_.FRAMEBUFFER,null),o}createRenderbuffer(t,e,i,r){let s=this._gl,a=s.createRenderbuffer();return s.bindRenderbuffer(s.RENDERBUFFER,a),s.renderbufferStorage(s.RENDERBUFFER,i,t,e),s.bindRenderbuffer(s.RENDERBUFFER,null),a}setupRendertargetTextureAttachment(t,e){let i=t._gl;t._depthTexture=e;let r=t._depthbuffer;r&&i.deleteRenderbuffer(r),t._depthbuffer=null;let s=this.glRenderTargetAttachment(t.depthStencilFormat),a=t._framebuffer;i.bindFramebuffer(i.FRAMEBUFFER,a),i.framebufferTexture2D(i.FRAMEBUFFER,s,i.TEXTURE_2D,e.resource,0),i.bindFramebuffer(i.FRAMEBUFFER,null)}readRenderTargetPixelData(e,i,r,s,a,n){let h=e._gl;if(this.bindRenderTarget(e),!(h.checkFramebufferStatus(h.FRAMEBUFFER)==h.FRAMEBUFFER_COMPLETE))return this.unbindRenderTarget(e),null;switch(e.colorFormat){case t.RenderTargetFormat.R8G8B8:h.readPixels(i,r,s,a,h.RGB,h.UNSIGNED_BYTE,n);break;case t.RenderTargetFormat.R8G8B8A8:h.readPixels(i,r,s,a,h.RGBA,h.UNSIGNED_BYTE,n);break;case t.RenderTargetFormat.R16G16B16:h.readPixels(i,r,s,a,h.RGB,h.FLOAT,n);break;case t.RenderTargetFormat.R16G16B16A16:h.readPixels(i,r,s,a,h.RGBA,h.FLOAT,n);break;case t.RenderTargetFormat.R32G32B32:h.readPixels(i,r,s,a,h.RGB,h.FLOAT,n);break;case t.RenderTargetFormat.R32G32B32A32:h.readPixels(i,r,s,a,h.RGBA,h.FLOAT,n)}return this.unbindRenderTarget(e),n}updateVideoTexture(t,e,i,r){let s=t._gl,a=t.target,n=t.internalFormat,h=t.format,o=t.type;t.width,t.height,i&&s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),r&&s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!0),s.pixelStorei(s.UNPACK_ALIGNMENT,1),this._engine._bindTexture(t.target,t.resource),s.texImage2D(a,0,n,h,o,e),this._engine._bindTexture(t.target,null),i&&s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),r&&s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!1),s.pixelStorei(s.UNPACK_ALIGNMENT,4)}getRenderTextureData(e,i,r,s,a){if(e.colorFormat==t.RenderTargetFormat.None)return null;let n=e._gl;if(n.bindFramebuffer(n.FRAMEBUFFER,e._framebuffer),!(n.checkFramebufferStatus(n.FRAMEBUFFER)===n.FRAMEBUFFER_COMPLETE))return n.bindFramebuffer(n.FRAMEBUFFER,null),null;let h,o,l=s*a;var _;switch(e.colorFormat){case t.RenderTargetFormat.R8G8B8:h=n.RGB,o=n.UNSIGNED_BYTE,_=new Uint8Array(3*l);break;case t.RenderTargetFormat.R8G8B8A8:h=n.RGBA,o=n.UNSIGNED_BYTE,_=new Uint8Array(4*l);break;case t.RenderTargetFormat.R16G16B16:h=n.RGB,o=n.UNSIGNED_SHORT_4_4_4_4,_=new Uint16Array(3*l);break;case t.RenderTargetFormat.R16G16B16A16:h=n.RGBA,o=n.UNSIGNED_SHORT_4_4_4_4,_=new Uint16Array(4*l);break;case t.RenderTargetFormat.R32G32B32:h=n.RGB,o=n.FLOAT,_=new Float32Array(3*l);break;case t.RenderTargetFormat.R32G32B32A32:h=n.RGBA,o=n.FLOAT,_=new Float32Array(4*l);break;default:return null}return n.readPixels(i,r,s,a,h,o,_),n.bindFramebuffer(n.FRAMEBUFFER,null),_}}class kr extends Gr{constructor(t){super(t)}getTarget(e){let i=-1;switch(e){case t.TextureDimension.Cube:i=this._gl.TEXTURE_CUBE_MAP;break;case t.TextureDimension.Tex2D:i=this._gl.TEXTURE_2D;break;case t.TextureDimension.Texture2DArray:i=this._gl.TEXTURE_2D_ARRAY;break;case t.TextureDimension.Tex3D:i=this._gl.TEXTURE_3D;break;default:throw"Unknow Texture Target"}return i}glTextureParam(e,i){let r=this._gl;switch(this._glParam.internalFormat=null,this._glParam.format=null,this._glParam.type=null,e){case t.TextureFormat.R8G8B8:this._glParam.internalFormat=i?r.SRGB8:r.RGB8,this._glParam.format=r.RGB,this._glParam.type=r.UNSIGNED_BYTE;break;case t.TextureFormat.R8G8B8A8:this._glParam.internalFormat=i?r.SRGB8_ALPHA8:r.RGBA8,this._glParam.format=r.RGBA,this._glParam.type=r.UNSIGNED_BYTE;break;case t.TextureFormat.R5G6B5:this._glParam.internalFormat=r.RGB565,this._glParam.format=r.RGB,this._glParam.type=r.UNSIGNED_SHORT_5_6_5;break;case t.TextureFormat.R32G32B32A32:this._glParam.internalFormat=r.RGBA32F,this._glParam.format=r.RGBA,this._glParam.type=r.FLOAT;break;case t.TextureFormat.R32G32B32:this._glParam.internalFormat=r.RGB32F,this._glParam.format=r.RGB,this._glParam.type=r.FLOAT;break;case t.TextureFormat.R16G16B16:this._glParam.internalFormat=r.RGB16F,this._glParam.format=r.RGB,this._glParam.type=r.HALF_FLOAT;break;case t.TextureFormat.R16G16B16A16:this._glParam.internalFormat=r.RGBA16F,this._glParam.format=r.RGBA,this._glParam.type=r.HALF_FLOAT;break;case t.TextureFormat.DXT1:this._glParam.internalFormat=i?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT1_EXT;break;case t.TextureFormat.DXT3:this._glParam.internalFormat=i?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case t.TextureFormat.DXT5:this._glParam.internalFormat=i?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case t.TextureFormat.ETC1RGB:this._glParam.internalFormat=this._compressedTextureEtc1.COMPRESSED_RGB_ETC1_WEBGL;break;case t.TextureFormat.ETC2RGBA:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_RGBA8_ETC2_EAC;break;case t.TextureFormat.ETC2RGB:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_RGB8_ETC2;break;case t.TextureFormat.ETC2SRGB:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_SRGB8_ETC2;break;case t.TextureFormat.ETC2SRGB_Alpha8:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;break;case t.TextureFormat.ASTC4x4:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_4x4_KHR;break;case t.TextureFormat.ASTC6x6:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_6x6_KHR;break;case t.TextureFormat.ASTC8x8:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_8x8_KHR;break;case t.TextureFormat.ASTC10x10:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_10x10_KHR;break;case t.TextureFormat.ASTC12x12:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_12x12_KHR;break;case t.TextureFormat.ASTC4x4SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case t.TextureFormat.ASTC6x6SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;break;case t.TextureFormat.ASTC8x8SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;break;case t.TextureFormat.ASTC10x10SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;break;case t.TextureFormat.ASTC12x12SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;break;default:throw"Unknown Texture Format."}return this._glParam}glRenderBufferParam(e,i){let r=this._gl;switch(e){case t.RenderTargetFormat.DEPTH_16:return{internalFormat:r.DEPTH_COMPONENT16,attachment:r.DEPTH_ATTACHMENT};case t.RenderTargetFormat.DEPTHSTENCIL_24_8:return{internalFormat:r.DEPTH24_STENCIL8,attachment:r.DEPTH_STENCIL_ATTACHMENT};case t.RenderTargetFormat.DEPTH_32:return{internalFormat:r.DEPTH_COMPONENT32F,attachment:r.DEPTH_ATTACHMENT};case t.RenderTargetFormat.STENCIL_8:return{internalFormat:r.STENCIL_INDEX8,attachment:r.STENCIL_ATTACHMENT};case t.RenderTargetFormat.R8G8B8:return{internalFormat:i?r.SRGB8:r.RGB8,attachment:r.COLOR_ATTACHMENT0};case t.RenderTargetFormat.R8G8B8A8:return{internalFormat:i?r.SRGB8_ALPHA8:r.RGBA8,attachment:r.COLOR_ATTACHMENT0};case t.RenderTargetFormat.R16G16B16:return{internalFormat:r.RGB16F,attachment:r.COLOR_ATTACHMENT0};case t.RenderTargetFormat.R16G16B16A16:return{internalFormat:r.RGBA16F,attachment:r.COLOR_ATTACHMENT0};case t.RenderTargetFormat.R32G32B32:return{internalFormat:r.RGB32F,attachment:r.COLOR_ATTACHMENT0};case t.RenderTargetFormat.R32G32B32A32:return{internalFormat:r.RGBA32F,attachment:r.COLOR_ATTACHMENT0};default:return null}}glRenderTextureParam(e,i){let r=this._gl;switch(this._glParam.internalFormat=null,this._glParam.format=null,this._glParam.type=null,e){case t.RenderTargetFormat.R8G8B8:this._glParam.internalFormat=i?r.SRGB8:r.RGB8,this._glParam.format=r.RGB,this._glParam.type=r.UNSIGNED_BYTE;break;case t.RenderTargetFormat.R8G8B8A8:this._glParam.internalFormat=i?r.SRGB8_ALPHA8:r.RGBA8,this._glParam.format=r.RGBA,this._glParam.type=r.UNSIGNED_BYTE;break;case t.RenderTargetFormat.R16G16B16:this._glParam.internalFormat=r.RGB16F,this._glParam.format=r.RGB,this._glParam.type=r.HALF_FLOAT;break;case t.RenderTargetFormat.R16G16B16A16:this._glParam.internalFormat=r.RGBA16F,this._glParam.format=r.RGBA,this._glParam.type=r.HALF_FLOAT;break;case t.RenderTargetFormat.R32G32B32:this._glParam.internalFormat=r.RGB32F,this._glParam.format=r.RGB,this._glParam.type=r.FLOAT;break;case t.RenderTargetFormat.R32G32B32A32:this._glParam.internalFormat=r.RGBA32F,this._glParam.format=r.RGBA,this._glParam.type=r.FLOAT;break;case t.RenderTargetFormat.DEPTH_16:this._glParam.internalFormat=r.DEPTH_COMPONENT16,this._glParam.format=r.DEPTH_COMPONENT,this._glParam.type=r.UNSIGNED_INT;break;case t.RenderTargetFormat.DEPTHSTENCIL_24_8:this._glParam.internalFormat=r.DEPTH24_STENCIL8,this._glParam.format=this._glParam.internalFormat,this._glParam.type=r.UNSIGNED_INT_24_8;break;case t.RenderTargetFormat.DEPTH_32:this._glParam.internalFormat=r.DEPTH_COMPONENT32F,this._glParam.format=this._glParam.internalFormat,this._glParam.type=r.UNSIGNED_INT;break;case t.RenderTargetFormat.STENCIL_8:break;default:throw"depht texture format wrong."}return this._glParam}getGLtexMemory(t){let e=this._gl,i=0,r=0,s=0;switch(t.internalFormat){case e.SRGB8:case e.RGB8:case e.RGB565:case e.RGB32F:case e.RGB16F:i=3;break;case e.SRGB8_ALPHA8:case e.RGBA8:case e.RGBA32F:case e.RGBA16F:i=4;break;default:i=0}switch(t.type){case e.UNSIGNED_BYTE:r=1;break;case e.UNSIGNED_SHORT_5_6_5:r=2/3;break;case e.FLOAT:r=4;break;case e.HALF_FLOAT:r=2;break;default:r=0}return s=i*r*t.width*t.height,t.mipmap&&(s*=1.333),t.target==e.TEXTURE_CUBE_MAP?s*=6:t.target==e.TEXTURE_2D&&(s*=1),s}supportSRGB(e,i){switch(e){case t.TextureFormat.R8G8B8:return this._engine.getCapable(t.RenderCapable.Texture_SRGB)&&!i;case t.TextureFormat.R8G8B8A8:return this._engine.getCapable(t.RenderCapable.Texture_SRGB);case t.TextureFormat.DXT1:case t.TextureFormat.DXT3:case t.TextureFormat.DXT5:return this._engine.getCapable(t.RenderCapable.COMPRESS_TEXTURE_S3TC_SRGB)&&!i;default:return!1}}setTextureImageData(t,e,i,r){t.width==e.width&&t.height==e.height||console.warn("setTextureImageData: size not match");let s=t.target,a=t.internalFormat,n=t.format,h=t.type,o=t.width,l=t.height,_=t.mipmapCount,u=this._gl;i&&u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),r&&u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(t.target,t.resource),u.texStorage2D(s,_,a,o,l),u.texSubImage2D(s,0,0,0,o,l,n,h,e),t.gpuMemory=this.getGLtexMemory(t),t.mipmap&&u.generateMipmap(t.target),this._engine._bindTexture(t.target,null),i&&u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),r&&u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,!1)}setTexturebySubImageData(t,e,i,r,s,a){let n=t.target,h=t.internalFormat,o=t.format,l=t.type;t.width,t.height;let _=t.mipmapCount,u=this._gl;s&&u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(t.target,t.resource),u.texStorage2D(n,_,h,e.width,e.height),u.texSubImage2D(n,0,i,r,e.width,e.height,o,l,e),t.gpuMemory=this.getGLtexMemory(t),t.mipmap&&u.generateMipmap(t.target),this._engine._bindTexture(t.target,null),s&&u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,!1)}setTexturePixelsData(t,e,i,r){let s=t.target,a=t.internalFormat,n=t.format,h=t.type,o=t.width,l=t.height,_=t.mipmapCount,u=o%4==0&&l%4==0,d=this._gl;i&&d.pixelStorei(d.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),r&&d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,!0),u||d.pixelStorei(d.UNPACK_ALIGNMENT,1),this._engine._bindTexture(t.target,t.resource),d.texStorage2D(s,_,a,o,l),t.gpuMemory=this.getGLtexMemory(t),e&&(d.texSubImage2D(s,0,0,0,o,l,n,h,e),t.mipmap&&d.generateMipmap(t.target)),this._engine._bindTexture(t.target,null),i&&d.pixelStorei(d.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),r&&d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,!1),u||d.pixelStorei(d.UNPACK_ALIGNMENT,4)}setTextureHDRData(t,e){let i=e.readScanLine();this.setTexturePixelsData(t,i,!1,!1)}setTextureKTXData(t,e){let i=t.target,r=t.internalFormat,s=t.format,a=t.type;t.mipmapCount;let n=t.width,h=t.height,o=e.source,l=e.compress,_=n%4==0&&h%4==0,u=this._gl;_||u.pixelStorei(u.UNPACK_ALIGNMENT,1),this._engine._bindTexture(t.target,t.resource),l||u.texStorage2D(i,e.mipmapCount,r,n,h);let d=n,c=h,p=e.headerOffset+e.bytesOfKeyValueData,f=0;for(let t=0;t<e.mipmapCount;t++){let n=new Int32Array(o,p,1)[0];if(p+=4,l){let e=new Uint8Array(o,p,n);u.compressedTexImage2D(i,t,r,d,c,0,e),f+=e.length}else{let r=this.getFormatPixelsParams(e.format),h=n/r.typedSize,l=new r.dataTypedCons(o,p,h);u.texSubImage2D(i,t,0,0,d,c,s,a,l),f+=l.length}p+=n,p+=3-(n+3)%4,d=Math.max(1,.5*d),c=Math.max(1,.5*c)}this._engine._bindTexture(t.target,null),t.gpuMemory=f,_||u.pixelStorei(u.UNPACK_ALIGNMENT,4)}setCubeImageData(t,e,i,r){let s=this._gl;const a=[s.TEXTURE_CUBE_MAP_POSITIVE_Z,s.TEXTURE_CUBE_MAP_NEGATIVE_Z,s.TEXTURE_CUBE_MAP_POSITIVE_X,s.TEXTURE_CUBE_MAP_NEGATIVE_X,s.TEXTURE_CUBE_MAP_POSITIVE_Y,s.TEXTURE_CUBE_MAP_NEGATIVE_Y];let n=t.target,h=t.internalFormat,o=t.format,l=t.type,_=t.width,u=t.height,d=t.mipmapCount;i&&s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),r&&s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(t.target,t.resource),s.texStorage2D(n,d,h,_,u),t.gpuMemory=this.getGLtexMemory(t);for(let t=0;t<a.length;t++){let i=a[t];s.texSubImage2D(i,0,0,0,o,l,e[t])}t.mipmap&&s.generateMipmap(t.target),this._engine._bindTexture(t.target,null),i&&s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),r&&s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!1)}setCubePixelsData(t,e,i,r){let s=this._gl;const a=[s.TEXTURE_CUBE_MAP_POSITIVE_Z,s.TEXTURE_CUBE_MAP_NEGATIVE_Z,s.TEXTURE_CUBE_MAP_POSITIVE_X,s.TEXTURE_CUBE_MAP_NEGATIVE_X,s.TEXTURE_CUBE_MAP_POSITIVE_Y,s.TEXTURE_CUBE_MAP_NEGATIVE_Y];let n=t.target,h=t.internalFormat,o=t.format,l=t.type,_=t.width,u=t.height,d=t.mipmapCount,c=_%4==0;if(i&&s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),r&&s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!0),c||s.pixelStorei(s.UNPACK_ALIGNMENT,1),this._engine._bindTexture(t.target,t.resource),s.texStorage2D(n,d,h,_,u),e){for(let t=0;t<a.length;t++){let i=a[t];s.texSubImage2D(i,0,0,0,_,u,o,l,e[t])}t.mipmap&&s.generateMipmap(t.target)}this._engine._bindTexture(t.target,null),t.gpuMemory=this.getGLtexMemory(t),i&&s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),r&&s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!1),c||s.pixelStorei(s.UNPACK_ALIGNMENT,4)}setCubeKTXData(t,e){let i=this._gl;const r=[i.TEXTURE_CUBE_MAP_POSITIVE_X,i.TEXTURE_CUBE_MAP_NEGATIVE_X,i.TEXTURE_CUBE_MAP_POSITIVE_Y,i.TEXTURE_CUBE_MAP_NEGATIVE_Y,i.TEXTURE_CUBE_MAP_POSITIVE_Z,i.TEXTURE_CUBE_MAP_NEGATIVE_Z];let s=t.target,a=t.internalFormat,n=t.format,h=t.type;t.mipmapCount;let o=t.width,l=t.height,_=e.source,u=e.compress,d=o,c=l,p=e.headerOffset+e.bytesOfKeyValueData,f=o%4==0&&l%4==0;f||i.pixelStorei(i.UNPACK_ALIGNMENT,1),this._engine._bindTexture(t.target,t.resource),u||i.texStorage2D(s,e.mipmapCount,a,o,l);let m=0;for(let t=0;t<e.mipmapCount;t++){let s=new Int32Array(_,p,1)[0];p+=4;for(let o=0;o<6;o++){let l=r[o];if(u){let e=new Uint8Array(_,p,s);i.compressedTexImage2D(l,t,a,d,c,0,e),m+=e.byteLength}else{let r=this.getFormatPixelsParams(e.format),a=s/r.typedSize,o=new r.dataTypedCons(_,p,a);i.texSubImage2D(l,t,0,0,d,c,n,h,o),m+=o.byteLength}p+=s,p+=3-(s+3)%4}d=Math.max(1,.5*d),c=Math.max(1,.5*c)}t.gpuMemory=m,this._engine._bindTexture(t.target,null),f||i.pixelStorei(i.UNPACK_ALIGNMENT,4)}getCubeKTXRGBMData(t,e){let i=this._gl;const r=[i.TEXTURE_CUBE_MAP_POSITIVE_X,i.TEXTURE_CUBE_MAP_NEGATIVE_X,i.TEXTURE_CUBE_MAP_POSITIVE_Y,i.TEXTURE_CUBE_MAP_NEGATIVE_Y,i.TEXTURE_CUBE_MAP_POSITIVE_Z,i.TEXTURE_CUBE_MAP_NEGATIVE_Z];let s=t.target,a=t.internalFormat,n=t.format,h=t.type;t.mipmapCount;let o=t.width,l=t.height,_=e.source,u=e.compress,d=o,c=l,p=e.headerOffset+e.bytesOfKeyValueData,f=o%4==0&&l%4==0;f||i.pixelStorei(i.UNPACK_ALIGNMENT,1),this._engine._bindTexture(t.target,t.resource),u||i.texStorage2D(s,e.mipmapCount,a,o,l);let m=0;for(let t=0;t<e.mipmapCount;t++){let s=new Int32Array(_,p,1)[0];p+=4;for(let a=0;a<6;a++){let o=r[a],l=this.getFormatPixelsParams(e.format),u=s/l.typedSize,f=new l.dataTypedCons(_,p,u);i.texSubImage2D(o,t,0,0,d,c,n,h,f),m+=f.byteLength}p+=s,p+=3-(s+3)%4}d=Math.max(1,.5*d),c=Math.max(1,.5*c),t.gpuMemory=m,this._engine._bindTexture(t.target,null),f||i.pixelStorei(i.UNPACK_ALIGNMENT,4)}setTextureCompareMode(e,i){let r=this._gl;switch(i){case t.TextureCompareMode.LEQUAL:e._setTexParameteri(r.TEXTURE_COMPARE_FUNC,r.LEQUAL),e._setTexParameteri(r.TEXTURE_COMPARE_MODE,r.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.GEQUAL:e._setTexParameteri(r.TEXTURE_COMPARE_FUNC,r.GEQUAL),e._setTexParameteri(r.TEXTURE_COMPARE_MODE,r.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.LESS:e._setTexParameteri(r.TEXTURE_COMPARE_FUNC,r.LESS),e._setTexParameteri(r.TEXTURE_COMPARE_MODE,r.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.GREATER:e._setTexParameteri(r.TEXTURE_COMPARE_FUNC,r.GREATER),e._setTexParameteri(r.TEXTURE_COMPARE_MODE,r.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.EQUAL:e._setTexParameteri(r.TEXTURE_COMPARE_FUNC,r.EQUAL),e._setTexParameteri(r.TEXTURE_COMPARE_MODE,r.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.NOTEQUAL:e._setTexParameteri(r.TEXTURE_COMPARE_FUNC,r.NOTEQUAL),e._setTexParameteri(r.TEXTURE_COMPARE_MODE,r.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.ALWAYS:e._setTexParameteri(r.TEXTURE_COMPARE_FUNC,r.ALWAYS),e._setTexParameteri(r.TEXTURE_COMPARE_MODE,r.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.NEVER:e._setTexParameteri(r.TEXTURE_COMPARE_FUNC,r.NEVER),e._setTexParameteri(r.TEXTURE_COMPARE_MODE,r.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.None:default:e._setTexParameteri(r.TEXTURE_COMPARE_FUNC,r.LEQUAL),e._setTexParameteri(r.TEXTURE_COMPARE_MODE,r.NONE)}return i}createRenderbuffer(t,e,i,r){let s=this._gl,a=s.createRenderbuffer();return s.bindRenderbuffer(s.RENDERBUFFER,a),r>1?s.renderbufferStorageMultisample(s.RENDERBUFFER,r,i,t,e):s.renderbufferStorage(s.RENDERBUFFER,i,t,e),s.bindRenderbuffer(s.RENDERBUFFER,null),a}createRenderTextureInternal(e,i,r,s,a,n){a=a&&this.supportGenerateMipmap(s);let h=this.isSRGBFormat(s)||n&&this.supportSRGB(s,a),o=1;!h&&n&&(o=2.2);let l=this.getTarget(e),_=new Nr(this._engine,l,i,r,e,a,h,o),u=this.glRenderTextureParam(s,h);_.internalFormat=u.internalFormat,_.format=u.format,_.type=u.type;let d=_.internalFormat;_.format,_.type;let c=_._gl;return this._engine._bindTexture(_.target,_.resource),c.texStorage2D(l,_.mipmapCount,d,i,r),this._engine._bindTexture(_.target,null),s!=t.RenderTargetFormat.DEPTH_16&&s!=t.RenderTargetFormat.DEPTH_32&&s!=t.RenderTargetFormat.DEPTHSTENCIL_24_8||(_.filterMode=t.FilterMode.Point),_}createRenderTargetInternal(e,i,r,s,a,n,h){let o=this.createRenderTextureInternal(t.TextureDimension.Tex2D,e,i,r,a,n),l=new Ur(this._engine,r,s,!1,o.mipmap,h);l.gpuMemory=this.getGLRTTexMemory(e,i,r,s,a,h,!1),l._textures.push(o);let _=l._gl;if(l._samples>1){let t=l._msaaFramebuffer,a=this.glRenderBufferParam(r,n),h=l._msaaRenderbuffer=this.createRenderbuffer(e,i,a.internalFormat,l._samples);_.bindFramebuffer(_.FRAMEBUFFER,t),_.framebufferRenderbuffer(_.FRAMEBUFFER,a.attachment,_.RENDERBUFFER,h);let u=this.glRenderBufferParam(s,!1);if(u){let t=this.createRenderbuffer(e,i,u.internalFormat,l._samples);l._depthbuffer=t,_.framebufferRenderbuffer(_.FRAMEBUFFER,u.attachment,_.RENDERBUFFER,t)}_.bindFramebuffer(_.FRAMEBUFFER,null);let d=l._framebuffer;_.bindFramebuffer(_.FRAMEBUFFER,d);let c=this.glRenderTargetAttachment(r);_.framebufferTexture2D(_.FRAMEBUFFER,c,_.TEXTURE_2D,o.resource,0),_.bindFramebuffer(_.FRAMEBUFFER,null)}else{let t=l._framebuffer;_.bindFramebuffer(_.FRAMEBUFFER,t);let a=this.glRenderTargetAttachment(r);_.framebufferTexture2D(_.FRAMEBUFFER,a,_.TEXTURE_2D,o.resource,0);let n=this.glRenderBufferParam(s,!1);if(n){let t=this.createRenderbuffer(e,i,n.internalFormat,l._samples);l._depthbuffer=t,_.framebufferRenderbuffer(_.FRAMEBUFFER,n.attachment,_.RENDERBUFFER,t)}_.bindFramebuffer(_.FRAMEBUFFER,null)}return l}createRenderTargetCubeInternal(e,i,r,s,a,n){let h=this.createRenderTextureCubeInternal(t.TextureDimension.Cube,e,i,s,a),o=new Ur(this._engine,i,r,!0,h.mipmap,n);o.gpuMemory=this.getGLRTTexMemory(e,e,i,r,s,n,!0),o.colorFormat=i,o.depthStencilFormat=r,o._textures.push(h);let l=o._gl;if(o._samples>1){let t=o._msaaFramebuffer,s=this.glRenderBufferParam(i,!1),a=o._msaaRenderbuffer=this.createRenderbuffer(e,e,s.internalFormat,o._samples);l.bindFramebuffer(l.FRAMEBUFFER,t),l.framebufferRenderbuffer(l.FRAMEBUFFER,s.attachment,l.RENDERBUFFER,a);let n=this.glRenderBufferParam(r,!1);if(n){let t=this.createRenderbuffer(e,e,n.internalFormat,o._samples);o._depthbuffer=t,l.framebufferRenderbuffer(l.FRAMEBUFFER,n.attachment,l.RENDERBUFFER,t)}l.bindFramebuffer(l.FRAMEBUFFER,null)}else{let t=o._framebuffer;l.bindFramebuffer(l.FRAMEBUFFER,t);let i=this.glRenderBufferParam(r,!1);if(i){let t=this.createRenderbuffer(e,e,i.internalFormat,o._samples);o._depthbuffer=t,l.framebufferRenderbuffer(l.FRAMEBUFFER,i.attachment,l.RENDERBUFFER,t)}l.bindFramebuffer(l.FRAMEBUFFER,null)}return o}createRenderTextureCubeInternal(t,e,i,r,s){r=r&&this.supportGenerateMipmap(i);let a=this.isSRGBFormat(i)||s&&this.supportSRGB(i,r),n=1;!a&&s&&(n=2.2);let h=this.getTarget(t),o=new Nr(this._engine,h,e,e,t,r,a,n),l=this.glRenderTextureParam(i,a);o.internalFormat=l.internalFormat,o.format=l.format,o.type=l.type;let _=o.internalFormat;o.format,o.type;let u=o._gl;return this._engine._bindTexture(o.target,o.resource),u.texStorage2D(h,o.mipmapCount,_,e,e),this._engine._bindTexture(o.target,null),o}bindRenderTarget(t,e=0){let i=t._gl;if(t._isCube){let r=t._framebuffer;i.bindFramebuffer(i.FRAMEBUFFER,r);let s=t._textures[0];i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_CUBE_MAP_POSITIVE_X+e,s.resource,0)}if(t._samples>1)i.bindFramebuffer(i.FRAMEBUFFER,t._msaaFramebuffer);else{let e=t._framebuffer;i.bindFramebuffer(i.FRAMEBUFFER,e)}}unbindRenderTarget(t){let e=t._gl;if(t._samples>1){e.bindFramebuffer(e.READ_FRAMEBUFFER,t._msaaFramebuffer),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,t._framebuffer);let i=t._textures[0],r=e.COLOR_BUFFER_BIT;t._depthTexture&&(r|=e.DEPTH_BUFFER_BIT),e.blitFramebuffer(0,0,i.width,i.height,0,0,i.width,i.height,r,e.NEAREST)}t._generateMipmap&&t._textures.forEach((t=>{let i=t.target;this._engine._bindTexture(i,t.resource),e.generateMipmap(i),this._engine._bindTexture(i,null)})),e.bindFramebuffer(e.FRAMEBUFFER,null)}}class Wr extends Or{constructor(t,e,i){super(t),this._byteLength=0,this._glTargetType=e,this._glBufferUsageType=i,this._getGLTarget(this._glTargetType),this._getGLUsage(this._glBufferUsageType),this._glBuffer=this._gl.createBuffer()}_getGLUsage(e){switch(e){case t.BufferUsage.Static:this._glUsage=this._gl.STATIC_DRAW;break;case t.BufferUsage.Dynamic:this._glUsage=this._gl.DYNAMIC_DRAW;break;case t.BufferUsage.Stream:this._glUsage=this._gl.STREAM_DRAW;break;default:console.error("usage is not standard")}}_getGLTarget(e){switch(e){case t.BufferTargetType.ARRAY_BUFFER:this._glTarget=this._gl.ARRAY_BUFFER;break;case t.BufferTargetType.UNIFORM_BUFFER:this._glTarget=this._gl.UNIFORM_BUFFER;break;case t.BufferTargetType.ELEMENT_ARRAY_BUFFER:this._glTarget=this._gl.ELEMENT_ARRAY_BUFFER}}_memorychange(e){this._engine._addStatisticsInfo(t.RenderStatisticsInfo.BufferMemory,e),this._engine._addStatisticsInfo(t.RenderStatisticsInfo.GPUMemory,e)}bindBuffer(){return this._engine._getbindBuffer(this._glTargetType)!=this&&(this._gl.bindBuffer(this._glTarget,this._glBuffer),this._engine._setbindBuffer(this._glTargetType,this),!0)}unbindBuffer(){this._engine._getbindBuffer(this._glTargetType)==this&&(this._gl.bindBuffer(this._glTarget,null),this._engine._setbindBuffer(this._glTargetType,null))}orphanStorage(){this.bindBuffer(),this.setDataLength(this._byteLength)}setDataLength(t){let e=this._gl;this.bindBuffer(),this._memorychange(-this._byteLength),this._byteLength=t,e.bufferData(this._glTarget,this._byteLength,this._glUsage),this.unbindBuffer(),this._memorychange(this._byteLength)}setData(t,e){let i=this._gl;this.bindBuffer(),i.bufferSubData(this._glTarget,e,t),this.unbindBuffer()}setDataEx(t,e,i){let r=this._gl;this.bindBuffer(),r.bufferSubData(this._glTarget,e,t,0,i),this.unbindBuffer()}bindBufferBase(t){if(this._engine._getBindUBOBuffer(t)!=this){this._gl.bindBufferBase(this._glTarget,t,this._glBuffer),this._engine._setBindUBOBuffer(t,this)}}bindBufferRange(t,e,i){this._gl.bindBufferRange(this._glTarget,t,this._glBuffer,e,i)}resizeBuffer(t){this.bindBuffer();const e=this._gl;this._byteLength=t,e.bufferData(this._glTarget,this._byteLength,this._glUsage)}destroy(){super.destroy();this._gl.deleteBuffer(this._glBuffer),this._memorychange(-this._byteLength),this._byteLength=0,this._engine=null,this._glBuffer=null,this._glTarget=null,this._glUsage=null,this._gl=null}}!function(){var t={};function synthesizeGLError(e,i){var r;t[e]=!0,void 0!==i&&(r=i,window.console&&window.console.error&&window.console.error(r))}var e=function WebGLVertexArrayObjectOES(t){var e=t.gl;this.ext=t,this.isAlive=!0,this.hasBeenBound=!1,this.elementArrayBuffer=null,this.attribs=new Array(t.maxVertexAttribs);for(var i=0;i<this.attribs.length;i++){var r=new WebGLVertexArrayObjectOES.VertexAttrib(e);this.attribs[i]=r}this.maxAttrib=0};(e.VertexAttrib=function(t){this.enabled=!1,this.buffer=null,this.size=4,this.type=t.FLOAT,this.normalized=!1,this.stride=16,this.offset=0,this.cached="",this.recache()}).prototype.recache=function(){this.cached=[this.size,this.type,this.normalized,this.stride,this.offset].join(":")};var OESVertexArrayObject=function(e){var i=this;this.gl=e,function(e){var i=e.getError;e.getError=function(){var r;do{(r=i.apply(e))!=e.NO_ERROR&&(t[r]=!0)}while(r!=e.NO_ERROR);for(var s in t)if(t[s])return delete t[s],parseInt(s);return e.NO_ERROR}}(e);var r=this.original={getParameter:e.getParameter,enableVertexAttribArray:e.enableVertexAttribArray,disableVertexAttribArray:e.disableVertexAttribArray,bindBuffer:e.bindBuffer,getVertexAttrib:e.getVertexAttrib,vertexAttribPointer:e.vertexAttribPointer};e.getParameter=function(t){return t==i.VERTEX_ARRAY_BINDING_OES?i.currentVertexArrayObject==i.defaultVertexArrayObject?null:i.currentVertexArrayObject:r.getParameter.apply(this,arguments)},e.enableVertexAttribArray=function(t){var e=i.currentVertexArrayObject;e.maxAttrib=Math.max(e.maxAttrib,t);var s=e.attribs[t];return s.enabled=!0,r.enableVertexAttribArray.apply(this,arguments)},e.disableVertexAttribArray=function(t){var e=i.currentVertexArrayObject;e.maxAttrib=Math.max(e.maxAttrib,t);var s=e.attribs[t];return s.enabled=!1,r.disableVertexAttribArray.apply(this,arguments)},e.bindBuffer=function(t,s){switch(t){case e.ARRAY_BUFFER:i.currentArrayBuffer=s;break;case e.ELEMENT_ARRAY_BUFFER:i.currentVertexArrayObject.elementArrayBuffer=s}return r.bindBuffer.apply(this,arguments)},e.getVertexAttrib=function(t,s){var a=i.currentVertexArrayObject,n=a.attribs[t];switch(s){case e.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:return n.buffer;case e.VERTEX_ATTRIB_ARRAY_ENABLED:return n.enabled;case e.VERTEX_ATTRIB_ARRAY_SIZE:return n.size;case e.VERTEX_ATTRIB_ARRAY_STRIDE:return n.stride;case e.VERTEX_ATTRIB_ARRAY_TYPE:return n.type;case e.VERTEX_ATTRIB_ARRAY_NORMALIZED:return n.normalized;default:return r.getVertexAttrib.apply(this,arguments)}},e.vertexAttribPointer=function(t,e,s,a,n,h){var o=i.currentVertexArrayObject;o.maxAttrib=Math.max(o.maxAttrib,t);var l=o.attribs[t];return l.buffer=i.currentArrayBuffer,l.size=e,l.type=s,l.normalized=a,l.stride=n,l.offset=h,l.recache(),r.vertexAttribPointer.apply(this,arguments)},e.instrumentExtension&&e.instrumentExtension(this,"OES_vertex_array_object"),e.canvas.addEventListener("webglcontextrestored",(function(){var t;t="OESVertexArrayObject emulation library context restored",window.console&&window.console.log&&window.console.log(t),i.reset_()}),!0),this.reset_()};OESVertexArrayObject.prototype.VERTEX_ARRAY_BINDING_OES=34229,OESVertexArrayObject.prototype.reset_=function(){if(void 0!==this.vertexArrayObjects)for(var t=0;t<this.vertexArrayObjects.length;++t)this.vertexArrayObjects.isAlive=!1;var i=this.gl;this.maxVertexAttribs=i.getParameter(i.MAX_VERTEX_ATTRIBS),this.defaultVertexArrayObject=new e(this),this.currentVertexArrayObject=null,this.currentArrayBuffer=null,this.vertexArrayObjects=[this.defaultVertexArrayObject],this.bindVertexArrayOES(null)},OESVertexArrayObject.prototype.createVertexArrayOES=function(){var t=new e(this);return this.vertexArrayObjects.push(t),t},OESVertexArrayObject.prototype.deleteVertexArrayOES=function(t){t.isAlive=!1,this.vertexArrayObjects.splice(this.vertexArrayObjects.indexOf(t),1),this.currentVertexArrayObject==t&&this.bindVertexArrayOES(null)},OESVertexArrayObject.prototype.isVertexArrayOES=function(t){return!!(t&&t instanceof e&&t.hasBeenBound&&t.ext==this)},OESVertexArrayObject.prototype.bindVertexArrayOES=function(t){var e=this.gl;if(!t||t.isAlive){var i=this.original,r=this.currentVertexArrayObject;this.currentVertexArrayObject=t||this.defaultVertexArrayObject,this.currentVertexArrayObject.hasBeenBound=!0;var s=this.currentVertexArrayObject;if(r!=s){r&&s.elementArrayBuffer==r.elementArrayBuffer||i.bindBuffer.call(e,e.ELEMENT_ARRAY_BUFFER,s.elementArrayBuffer);for(var a=this.currentArrayBuffer,n=Math.max(r?r.maxAttrib:0,s.maxAttrib),h=0;h<=n;h++){var o=s.attribs[h],l=r?r.attribs[h]:null;if(r&&o.enabled==l.enabled||(o.enabled?i.enableVertexAttribArray.call(e,h):i.disableVertexAttribArray.call(e,h)),o.enabled){var _=!1;r&&o.buffer==l.buffer||(a!=o.buffer&&(i.bindBuffer.call(e,e.ARRAY_BUFFER,o.buffer),a=o.buffer),_=!0),(_||o.cached!=l.cached)&&i.vertexAttribPointer.call(e,h,o.size,o.type,o.normalized,o.stride,o.offset)}}this.currentArrayBuffer!=a&&i.bindBuffer.call(e,e.ARRAY_BUFFER,this.currentArrayBuffer)}}else synthesizeGLError(e.INVALID_OPERATION,"bindVertexArrayOES: attempt to bind deleted arrayObject")},window._setupVertexArrayObject=function(t){var e=t.getSupportedExtensions;t.getSupportedExtensions=function(){var t=e.call(this)||[];return t.indexOf("OES_vertex_array_object")<0&&t.push("OES_vertex_array_object"),t};var i=t.getExtension;t.getExtension=function(t){var e=i.call(this,t);return e||("OES_vertex_array_object"!==t?null:(this.__OESVertexArrayObject||(console.log("Setup OES_vertex_array_object polyfill"),this.__OESVertexArrayObject=new OESVertexArrayObject(this)),this.__OESVertexArrayObject))}}}();class Vr{constructor(t){this._extentionVendorPrefixes=["","WEBKIT_","MOZ_"],this._gl=t.gl,this.initExtension(t.isWebGL2),this.initCapable(t.isWebGL2)}initCapable(e){this._capabilityMap=new Map;let i=e||!!this.getExtension(t.WebGLExtension.OES_element_index_uint);this._capabilityMap.set(t.RenderCapable.Element_Index_Uint32,i),i=e||!!this.getExtension(t.WebGLExtension.OES_texture_float),this._capabilityMap.set(t.RenderCapable.TextureFormat_R32G32B32A32,i),i=e||!!this.getExtension(t.WebGLExtension.OES_texture_half_float),this._capabilityMap.set(t.RenderCapable.TextureFormat_R16G16B16A16,i),i=!!this.getExtension(t.WebGLExtension.EXT_texture_filter_anisotropic),this._capabilityMap.set(t.RenderCapable.Texture_anisotropic,i),i=e?!!this.getExtension(t.WebGLExtension.EXT_color_buffer_float):!!this.getExtension(t.WebGLExtension.OES_texture_half_float)&&!!this.getExtension(t.WebGLExtension.OES_texture_half_float_linear),this._capabilityMap.set(t.RenderCapable.RenderTextureFormat_R16G16B16A16,i),i=e||!!this.getExtension(t.WebGLExtension.WEBGL_depth_texture),this._capabilityMap.set(t.RenderCapable.RenderTextureFormat_Depth,i),i=e,this._capabilityMap.set(t.RenderCapable.RenderTextureFormat_ShadowMap,i),i=e||!!this.getExtension(t.WebGLExtension.OES_vertex_array_object),this._capabilityMap.set(t.RenderCapable.Vertex_VAO,i),i=e||!!this.getExtension(t.WebGLExtension.ANGLE_instanced_arrays),this._capabilityMap.set(t.RenderCapable.DrawElement_Instance,i),i=e||!!this.getExtension(t.WebGLExtension.EXT_shader_texture_lod),this._capabilityMap.set(t.RenderCapable.Shader_TextureLod,i),i=!!this.getExtension(t.WebGLExtension.WEBGL_compressed_texture_s3tc),this._capabilityMap.set(t.RenderCapable.COMPRESS_TEXTURE_S3TC,i),i=!!this.getExtension(t.WebGLExtension.WEBGL_compressed_texture_s3tc_srgb),this._capabilityMap.set(t.RenderCapable.COMPRESS_TEXTURE_S3TC_SRGB,i),i=!!this.getExtension(t.WebGLExtension.WEBGL_compressed_texture_pvrtc),this._capabilityMap.set(t.RenderCapable.COMPRESS_TEXTURE_PVRTC,i),i=!!this.getExtension(t.WebGLExtension.WEBGL_compressed_texture_etc1),this._capabilityMap.set(t.RenderCapable.COMPRESS_TEXTURE_ETC1,i),i=!!this.getExtension(t.WebGLExtension.WEBGL_compressed_texture_etc),this._capabilityMap.set(t.RenderCapable.COMPRESS_TEXTURE_ETC,i),i=!!this.getExtension(t.WebGLExtension.WEBGL_compressed_texture_astc),this._capabilityMap.set(t.RenderCapable.COMPRESS_TEXTURE_ASTC,i),i=e||!!this.getExtension(t.WebGLExtension.EXT_sRGB),this._capabilityMap.set(t.RenderCapable.Texture_SRGB,i),i=e,this._capabilityMap.set(t.RenderCapable.MSAA,i),this._capabilityMap.set(t.RenderCapable.UnifromBufferObject,i),this._capabilityMap.set(t.RenderCapable.GRAPHICS_API_GLES3,i)}initExtension(e){this._extensionMap=new Map;const setExtensionMap=(t,e,i)=>{e&&i.set(t,e)},i=this._getExtension("EXT_texture_filter_anisotropic");setExtensionMap(t.WebGLExtension.EXT_texture_filter_anisotropic,i,this._extensionMap);const r=this._getExtension("WEBGL_compressed_texture_s3tc");setExtensionMap(t.WebGLExtension.WEBGL_compressed_texture_s3tc,r,this._extensionMap);const s=this._getExtension("WEBGL_compressed_texture_s3tc_srgb");setExtensionMap(t.WebGLExtension.WEBGL_compressed_texture_s3tc_srgb,s,this._extensionMap);const a=this._getExtension("WEBGL_compressed_texture_pvrtc");setExtensionMap(t.WebGLExtension.WEBGL_compressed_texture_pvrtc,a,this._extensionMap);const n=this._getExtension("WEBGL_compressed_texture_etc1");setExtensionMap(t.WebGLExtension.WEBGL_compressed_texture_etc1,n,this._extensionMap);const h=this._getExtension("WEBGL_compressed_texture_etc");setExtensionMap(t.WebGLExtension.WEBGL_compressed_texture_etc,h,this._extensionMap);const o=this._getExtension("WEBGL_compressed_texture_astc");setExtensionMap(t.WebGLExtension.WEBGL_compressed_texture_astc,o,this._extensionMap);const l=this._getExtension("OES_texture_float_linear");if(setExtensionMap(t.WebGLExtension.OES_texture_float_linear,l,this._extensionMap),e){const e=this._getExtension("EXT_color_buffer_float");setExtensionMap(t.WebGLExtension.EXT_color_buffer_float,e,this._extensionMap);const i=this._getExtension("EXT_color_buffer_half_float");setExtensionMap(t.WebGLExtension.EXT_color_buffer_half_float,i,this._extensionMap)}else{window._setupVertexArrayObject&&window._setupVertexArrayObject(this._gl);const e=this._getExtension("OES_vertex_array_object");setExtensionMap(t.WebGLExtension.OES_vertex_array_object,e,this._extensionMap);const i=this._getExtension("ANGLE_instanced_arrays");setExtensionMap(t.WebGLExtension.ANGLE_instanced_arrays,i,this._extensionMap);const r=this._getExtension("OES_texture_half_float");setExtensionMap(t.WebGLExtension.OES_texture_half_float,r,this._extensionMap);const s=this._getExtension("OES_texture_half_float_linear");setExtensionMap(t.WebGLExtension.OES_texture_half_float_linear,s,this._extensionMap);const a=this._getExtension("OES_texture_float");setExtensionMap(t.WebGLExtension.OES_texture_float,a,this._extensionMap);const n=this._getExtension("OES_element_index_uint");setExtensionMap(t.WebGLExtension.OES_element_index_uint,n,this._extensionMap);const h=this._getExtension("EXT_shader_texture_lod");setExtensionMap(t.WebGLExtension.EXT_shader_texture_lod,h,this._extensionMap);const o=this._getExtension("WEBGL_depth_texture");setExtensionMap(t.WebGLExtension.WEBGL_depth_texture,o,this._extensionMap);const l=this._getExtension("EXT_sRGB");setExtensionMap(t.WebGLExtension.EXT_sRGB,l,this._extensionMap)}}getCapable(t){return this._capabilityMap.get(t)}getExtension(t){return this._extensionMap.has(t)?this._extensionMap.get(t):null}_getExtension(t){const e=this._extentionVendorPrefixes;for(const r in e){var i=this._gl.getExtension(e[r]+t);if(i)return i}return null}}class Xr{constructor(t){this._engine=t,this._gl=this._engine.gl,this._initParams()}_initParams(){const e=this._gl;this._glParamsData=new Map,this._glParamsData.set(t.RenderParams.Max_Active_Texture_Count,e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS));const i=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),r=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS);if(this._glParamsData.set(t.RenderParams.Max_Uniform_Count,Math.min(i,r)),this._glParamsData.set(t.RenderParams.MAX_Texture_Size,e.getParameter(e.MAX_TEXTURE_SIZE)),this._glParamsData.set(t.RenderParams.MAX_Texture_Image_Uint,e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS)),this._engine.getCapable(t.RenderCapable.Texture_anisotropic)){const i=this._engine._supportCapatable.getExtension(t.WebGLExtension.EXT_texture_filter_anisotropic);this._glParamsData.set(t.RenderParams.Max_AnisoLevel_Count,e.getParameter(i.MAX_TEXTURE_MAX_ANISOTROPY_EXT))}this._engine.isWebGL2?this._glParamsData.set(t.RenderParams.SHADER_CAPAILITY_LEVEL,35):this._glParamsData.set(t.RenderParams.SHADER_CAPAILITY_LEVEL,30),this._glParamsData.set(t.RenderParams.FLOAT,e.FLOAT),this._glParamsData.set(t.RenderParams.UNSIGNED_BYTE,e.UNSIGNED_BYTE),this._glParamsData.set(t.RenderParams.UNSIGNED_SHORT,e.UNSIGNED_SHORT),this._glParamsData.set(t.RenderParams.BYTE,e.BYTE)}getParams(t){return this._glParamsData.get(t)}}class Hr extends Or{constructor(t){super(t)}activeTexture(t){this._engine._activedTextureID!==t&&(this._gl.activeTexture(t),this._engine._activedTextureID=t)}bindTexture(t,e){this._engine._bindTexture(t,e)}bindUseProgram(t){return this.cacheShaderProgram!=t&&(this._gl.useProgram(t),this._engine._glUseProgram=null,!0)}}t.DrawType=void 0,(Ir=t.DrawType||(t.DrawType={}))[Ir.DrawArray=0]="DrawArray",Ir[Ir.DrawArrayInstance=1]="DrawArrayInstance",Ir[Ir.DrawElement=2]="DrawElement",Ir[Ir.DrawElementInstance=3]="DrawElementInstance";class Yr extends Or{constructor(e){super(e),this._engine.isWebGL2||(this._angleInstancedArrays=this._engine._supportCapatable.getExtension(t.WebGLExtension.ANGLE_instanced_arrays))}getMeshTopology(e){switch(e){case t.MeshTopology.Points:return this._gl.POINTS;case t.MeshTopology.Lines:return this._gl.LINES;case t.MeshTopology.LineLoop:return this._gl.LINE_LOOP;case t.MeshTopology.LineStrip:return this._gl.LINE_STRIP;case t.MeshTopology.Triangles:return this._gl.TRIANGLES;case t.MeshTopology.TriangleStrip:return this._gl.TRIANGLE_STRIP;case t.MeshTopology.TriangleFan:return this._gl.TRIANGLE_FAN}}getIndexType(e){switch(e){case t.IndexFormat.UInt8:return this._gl.UNSIGNED_BYTE;case t.IndexFormat.UInt16:return this._gl.UNSIGNED_SHORT;case t.IndexFormat.UInt32:return this._gl.UNSIGNED_INT}}drawElementsInstanced(e,i,r,s,a){const n=this.getMeshTopology(e),h=this.getIndexType(r);this._engine.isWebGL2?this._gl.drawElementsInstanced(n,i,h,s,a):this._angleInstancedArrays.drawElementsInstancedANGLE(n,i,h,s,a),this._engine._addStatisticsInfo(t.RenderStatisticsInfo.DrawCall,1),this._engine._addStatisticsInfo(t.RenderStatisticsInfo.InstanceDrawCall,1),this._engine._addStatisticsInfo(t.RenderStatisticsInfo.Triangle,i/3*a)}drawArraysInstanced(e,i,r,s){const a=this.getMeshTopology(e);this._engine.isWebGL2?this._gl.drawArraysInstanced(a,i,r,s):this._angleInstancedArrays.drawArraysInstancedANGLE(a,i,r,s),this._engine._addStatisticsInfo(t.RenderStatisticsInfo.DrawCall,1),this._engine._addStatisticsInfo(t.RenderStatisticsInfo.InstanceDrawCall,1),this._engine._addStatisticsInfo(t.RenderStatisticsInfo.Triangle,(r-2)*s)}drawArrays(e,i,r){const s=this.getMeshTopology(e);this._gl.drawArrays(s,i,r),this._engine._addStatisticsInfo(t.RenderStatisticsInfo.DrawCall,1),this._engine._addStatisticsInfo(t.RenderStatisticsInfo.Triangle,r-2)}drawElements(e,i,r,s){const a=this.getMeshTopology(e),n=this.getIndexType(r);this._gl.drawElements(a,i,n,s),this._engine._addStatisticsInfo(t.RenderStatisticsInfo.DrawCall,1),this._engine._addStatisticsInfo(t.RenderStatisticsInfo.Triangle,i/3)}drawGeometryElement(e){e.bufferState.bind();let i=e.drawParams.elements,r=e.drawParams.length;switch(e.drawType){case t.DrawType.DrawArray:for(let t=0;t<r;t+=2)this.drawArrays(e.mode,i[t],i[t+1]);break;case t.DrawType.DrawElement:for(let t=0;t<r;t+=2)this.drawElements(e.mode,i[t+1],e.indexFormat,i[t]);break;case t.DrawType.DrawArrayInstance:for(let t=0;t<r;t+=2)this.drawArraysInstanced(e.mode,i[t],i[t+1],e.instanceCount);break;case t.DrawType.DrawElementInstance:for(let t=0;t<r;t+=2)this.drawElementsInstanced(e.mode,i[t+1],e.indexFormat,i[t],e.instanceCount)}}}t.CompareFunction=void 0,(Pr=t.CompareFunction||(t.CompareFunction={}))[Pr.Never=0]="Never",Pr[Pr.Less=1]="Less",Pr[Pr.Equal=2]="Equal",Pr[Pr.LessEqual=3]="LessEqual",Pr[Pr.Greater=4]="Greater",Pr[Pr.NotEqual=5]="NotEqual",Pr[Pr.GreaterEqual=6]="GreaterEqual",Pr[Pr.Always=7]="Always",t.StencilOperation=void 0,(Br=t.StencilOperation||(t.StencilOperation={}))[Br.Keep=0]="Keep",Br[Br.Zero=1]="Zero",Br[Br.Replace=2]="Replace",Br[Br.IncrementSaturate=3]="IncrementSaturate",Br[Br.DecrementSaturate=4]="DecrementSaturate",Br[Br.Invert=5]="Invert",Br[Br.IncrementWrap=6]="IncrementWrap",Br[Br.DecrementWrap=7]="DecrementWrap";class zr{constructor(t){this._depthTest=!0,this._depthMask=!0,this._stencilTest=!1,this._blend=!1,this._cullFace=!1,this._engine=t,this._gl=this._engine.gl,this._initState()}_initState(){const t=this._gl;this.setDepthFunc(t.LESS),this.setBlendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),this._blendEquation=t.FUNC_ADD,this._sFactor=t.ONE,this._dFactor=t.ZERO,this._sFactorAlpha=t.ONE,this._dFactorAlpha=t.ONE}_getBlendFactor(e){const i=this._gl;switch(e){case t.BlendFactor.Zero:return i.ZERO;case t.BlendFactor.One:return i.ONE;case t.BlendFactor.SourceColor:return i.SRC_COLOR;case t.BlendFactor.OneMinusSourceColor:return i.ONE_MINUS_SRC_COLOR;case t.BlendFactor.DestinationColor:return i.DST_COLOR;case t.BlendFactor.OneMinusDestinationColor:return i.ONE_MINUS_DST_COLOR;case t.BlendFactor.SourceAlpha:return i.SRC_ALPHA;case t.BlendFactor.OneMinusSourceAlpha:return i.ONE_MINUS_SRC_ALPHA;case t.BlendFactor.DestinationAlpha:return i.DST_ALPHA;case t.BlendFactor.OneMinusDestinationAlpha:return i.ONE_MINUS_DST_ALPHA;case t.BlendFactor.SourceAlphaSaturate:return i.SRC_ALPHA_SATURATE;case t.BlendFactor.BlendColor:return i.CONSTANT_COLOR;case t.BlendFactor.OneMinusBlendColor:return i.ONE_MINUS_CONSTANT_COLOR}}_getBlendOperation(e){const i=this._gl;switch(e){case t.BlendEquationSeparate.ADD:return i.FUNC_ADD;case t.BlendEquationSeparate.SUBTRACT:return i.FUNC_SUBTRACT;case t.BlendEquationSeparate.REVERSE_SUBTRACT:return i.FUNC_REVERSE_SUBTRACT;default:throw"Unknow type"}}_getGLCompareFunction(e){const i=this._gl;switch(e){case t.CompareFunction.Never:return i.NEVER;case t.CompareFunction.Less:return i.LESS;case t.CompareFunction.Equal:return i.EQUAL;case t.CompareFunction.LessEqual:return i.LEQUAL;case t.CompareFunction.Greater:return i.GREATER;case t.CompareFunction.NotEqual:return i.NOTEQUAL;case t.CompareFunction.GreaterEqual:return i.GEQUAL;case t.CompareFunction.Always:return i.ALWAYS}}_getGLStencilOperation(e){const i=this._gl;switch(e){case t.StencilOperation.Keep:return i.KEEP;case t.StencilOperation.Zero:return i.ZERO;case t.StencilOperation.Replace:return i.REPLACE;case t.StencilOperation.IncrementSaturate:return i.INCR;case t.StencilOperation.DecrementSaturate:return i.DECR;case t.StencilOperation.Invert:return i.INVERT;case t.StencilOperation.IncrementWrap:return i.INCR_WRAP;case t.StencilOperation.DecrementWrap:return i.DECR_WRAP}}_getGLFrontfaceFactor(e){return e==t.CullMode.Front?this._gl.CCW:this._gl.CW}setDepthTest(t){t!==this._depthTest&&(this._depthTest=t,t?this._gl.enable(this._gl.DEPTH_TEST):this._gl.disable(this._gl.DEPTH_TEST))}setDepthMask(t){t!==this._depthMask&&(this._depthMask=t,this._gl.depthMask(t))}setDepthFunc(t){t!==this._depthFunc&&(this._depthFunc=t,this._gl.depthFunc(t))}setStencilTest(t){t!==this._stencilTest&&(this._stencilTest=t,t?this._gl.enable(this._gl.STENCIL_TEST):this._gl.disable(this._gl.STENCIL_TEST))}setStencilMask(t){t!==this._stencilMask&&(this._stencilMask=t,t?this._gl.stencilMask(255):this._gl.stencilMask(0))}setStencilFunc(t,e){t==this._stencilFunc&&e==this._stencilRef||(this._stencilFunc=t,this._stencilRef=e,this._gl.stencilFunc(t,e,255))}setstencilOp(t,e,i){this._stencilOp_fail==t&&this._stencilOp_zfail==e&&this._stencilOp_zpass==i||(this._stencilOp_fail=t,this._stencilOp_zfail=e,this._stencilOp_zpass=i,this._gl.stencilOp(t,e,i))}setBlend(t){t!==this._blend&&(this._blend=t,t?this._gl.enable(this._gl.BLEND):this._gl.disable(this._gl.BLEND))}setBlendEquation(t){t!==this._blendEquation&&(this._blendEquation=t,this._blendEquationRGB=this._blendEquationAlpha=null,this._gl.blendEquation(t))}setBlendEquationSeparate(t,e){t===this._blendEquationRGB&&e===this._blendEquationAlpha||(this._blendEquationRGB=t,this._blendEquationAlpha=e,this._blendEquation=null,this._gl.blendEquationSeparate(t,e))}setBlendFunc(t,e,i=!1){(i||t!==this._sFactor||e!==this._dFactor)&&(this._sFactor=t,this._dFactor=e,this._sFactorRGB=null,this._dFactorRGB=null,this._sFactorAlpha=null,this._dFactorAlpha=null,this._gl.blendFunc(t,e))}setBlendFuncSeperate(t,e,i,r){t===this._sFactorRGB&&e===this._dFactorRGB&&i===this._sFactorAlpha&&r===this._dFactorAlpha||(this._sFactorRGB=t,this._dFactorRGB=e,this._sFactorAlpha=i,this._dFactorAlpha=r,this._sFactor=null,this._dFactor=null,this._gl.blendFuncSeparate(t,e,i,r))}setCullFace(t){t!==this._cullFace&&(this._cullFace=t,t?this._gl.enable(this._gl.CULL_FACE):this._gl.disable(this._gl.CULL_FACE))}setFrontFace(t){t!==this._frontFace&&(this._frontFace=t,this._gl.frontFace(t))}applyRenderStateCommand(e){e.cmdArray.forEach(((e,i)=>{switch(i){case t.RenderStateType.DepthTest:this.setDepthTest(e);break;case t.RenderStateType.DepthMask:this.setDepthMask(e);break;case t.RenderStateType.DepthFunc:this.setDepthFunc(this._getGLCompareFunction(e));break;case t.RenderStateType.StencilTest:this.setStencilTest(e);break;case t.RenderStateType.StencilMask:this.setStencilMask(e);break;case t.RenderStateType.StencilFunc:this.setStencilFunc(this._getGLCompareFunction(e[0]),e[1]);break;case t.RenderStateType.StencilOp:this.setstencilOp(this._getGLStencilOperation(e[0]),this._getGLStencilOperation(e[1]),this._getGLStencilOperation(e[2]));break;case t.RenderStateType.BlendType:this.setBlend(e!=t.BlendType.BLEND_DISABLE);break;case t.RenderStateType.BlendEquation:this.setBlendEquation(this._getBlendOperation(e));break;case t.RenderStateType.BlendEquationSeparate:this.setBlendEquationSeparate(this._getBlendOperation(e[0]),this._getBlendOperation(e[1]));break;case t.RenderStateType.BlendFunc:this.setBlendFunc(this._getBlendFactor(e[0]),this._getBlendFactor(e[1]));break;case t.RenderStateType.BlendFuncSeperate:this.setBlendFuncSeperate(this._getBlendFactor(e[0]),this._getBlendFactor(e[1]),this._getBlendFactor(e[2]),this._getBlendFactor(e[3]));break;case t.RenderStateType.CullFace:this.setCullFace(e);break;case t.RenderStateType.FrontFace:this.setFrontFace(this._getGLFrontfaceFactor(e));break;default:throw"unknow type of renderStateType"}}))}}class jr{constructor(){this.textureID=-1}}class Kr extends Or{constructor(t,e,i,r){super(t),this._complete=!0,this._vs=e,this._ps=i,this._attributeMap=r,this._uniformMap=[],this._create()}_create(){const t=this._gl;for(var e in this._program=t.createProgram(),this._vshader=this._createShader(t,this._vs,t.VERTEX_SHADER),this._pshader=this._createShader(t,this._ps,t.FRAGMENT_SHADER),t.attachShader(this._program,this._vshader),t.attachShader(this._program,this._pshader),this._attributeMap)t.bindAttribLocation(this._program,this._attributeMap[e][0],e);t.linkProgram(this._program);if(!t.getProgramParameter(this._program,t.LINK_STATUS)){var i=t.getProgramInfoLog(this._program);return console.error(new Error("Could not compile WebGL program. \n\n"+i)),void(this._complete=!1)}const r=t.getProgramParameter(this._program,t.ACTIVE_UNIFORMS);let s,a;for(this.useProgram(),this._curActTexIndex=0,a=0;a<r;a++){var n=t.getActiveUniform(this._program,a),h=n.name;let e=t.getUniformLocation(this._program,h);(e||0==e)&&(s=new jr,s.location=e,h.indexOf("[0]")>0?(s.name=h=h.substr(0,h.length-3),s.isArray=!0):(s.name=h,s.isArray=!1),s.type=n.type,this._addShaderUnifiormFun(s),this._uniformMap.push(s),s.dataOffset=this._engine.propertyNameToID(h))}if(this._engine.isWebGL2){this._uniformObjectMap={};var o=t.getProgramParameter(this._program,t.ACTIVE_UNIFORM_BLOCKS);for(a=0;a<o;a++){let e=t;var l=e.getActiveUniformBlockName(this._program,a);s=new jr,s.name=l,s.isArray=!1,s.type=t.UNIFORM_BUFFER,s.dataOffset=this._engine.propertyNameToID(l);let i=s.location=e.getUniformBlockIndex(this._program,l);e.uniformBlockBinding(this._program,i,this._engine.getUBOPointer(l)),this._uniformObjectMap[s.name]=s,this._uniformMap.push(s),this._addShaderUnifiormFun(s)}}}_legalUBObyteLength(t){return 16*Math.ceil(t/16)}_createShader(t,e,i){var r=t.createShader(i);return t.shaderSource(r,e),t.compileShader(r),this._engine._isShaderDebugMode&&!t.getShaderParameter(r,t.COMPILE_STATUS)&&console.warn(t.getShaderInfoLog(r)),r}_addShaderUnifiormFun(t){var e=this._gl;t.caller=this;var i=t.isArray;switch(t.type){case e.BOOL:t.fun=this._uniform1i,t.uploadedValue=new Array(1);break;case e.INT:t.fun=i?this._uniform1iv:this._uniform1i,t.uploadedValue=new Array(1);break;case e.FLOAT:t.fun=i?this._uniform1fv:this._uniform1f,t.uploadedValue=new Array(1);break;case e.FLOAT_VEC2:t.fun=i?this._uniform_vec2v:this._uniform_vec2,t.uploadedValue=new Array(2);break;case e.FLOAT_VEC3:t.fun=i?this._uniform_vec3v:this._uniform_vec3,t.uploadedValue=new Array(3);break;case e.FLOAT_VEC4:t.fun=i?this._uniform_vec4v:this._uniform_vec4,t.uploadedValue=new Array(4);break;case e.FLOAT_MAT2:t.fun=this._uniformMatrix2fv;break;case e.FLOAT_MAT3:t.fun=this._uniformMatrix3fv;break;case e.FLOAT_MAT4:t.fun=i?this._uniformMatrix4fv:this._uniformMatrix4f;break;case e.SAMPLER_2D:case e.SAMPLER_2D_SHADOW:e.uniform1i(t.location,this._curActTexIndex),t.textureID=this._engine._glTextureIDParams[this._curActTexIndex++],t.fun=this._uniform_sampler2D;break;case 35679:e.uniform1i(t.location,this._curActTexIndex),t.textureID=this._engine._glTextureIDParams[this._curActTexIndex++],t.fun=this._uniform_sampler3D;break;case e.SAMPLER_CUBE:e.uniform1i(t.location,this._curActTexIndex),t.textureID=this._engine._glTextureIDParams[this._curActTexIndex++],t.fun=this._uniform_samplerCube;break;case e.UNIFORM_BUFFER:t.fun=this._uniform_UniformBuffer;break;default:throw new Error("compile shader err!")}}getUniformMap(){return this._uniformMap}bind(){return this.useProgram()}useProgram(){return this._engine._glUseProgram!==this&&(this._gl.useProgram(this._program),this._engine._glUseProgram=this,!0)}_uniform1f(t,e){var i=t.uploadedValue;return i[0]!==e?(this._gl.uniform1f(t.location,i[0]=e),1):0}_uniform1fv(t,e){if(e.length<4){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]||i[2]!==e[2]||i[3]!==e[3]?(this._gl.uniform1fv(t.location,e),i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],1):0}return this._gl.uniform1fv(t.location,e),1}_uniform_vec2(t,e){var i=t.uploadedValue;return i[0]!==e.x||i[1]!==e.y?(this._gl.uniform2f(t.location,i[0]=e.x,i[1]=e.y),1):0}_uniform_vec2v(t,e){if(e.length<2){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]||i[2]!==e[2]||i[3]!==e[3]?(this._gl.uniform2fv(t.location,e),i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],1):0}return this._gl.uniform2fv(t.location,e),1}_uniform_vec3(t,e){var i=t.uploadedValue;return i[0]!==e.x||i[1]!==e.y||i[2]!==e.z?(this._gl.uniform3f(t.location,i[0]=e.x,i[1]=e.y,i[2]=e.z),1):0}_uniform_vec3v(t,e){return this._gl.uniform3fv(t.location,e),1}_uniform_vec4(t,e){var i=t.uploadedValue;return i[0]!==e.x||i[1]!==e.y||i[2]!==e.z||i[3]!==e.w?(this._gl.uniform4f(t.location,i[0]=e.x,i[1]=e.y,i[2]=e.z,i[3]=e.w),1):0}_uniform_vec4v(t,e){return this._gl.uniform4fv(t.location,e),1}_uniformMatrix2fv(t,e){return this._gl.uniformMatrix2fv(t.location,!1,e),1}_uniformMatrix3fv(t,e){return this._gl.uniformMatrix3fv(t.location,!1,e),1}_uniformMatrix4f(t,e){var i=e.elements;return this._gl.uniformMatrix4fv(t.location,!1,i),1}_uniformMatrix4fv(t,e){return this._gl.uniformMatrix4fv(t.location,!1,e),1}_uniform1i(t,e){var i=t.uploadedValue;return i[0]!==e?(this._gl.uniform1i(t.location,i[0]=e),1):0}_uniform1iv(t,e){return this._gl.uniform1iv(t.location,e),1}_uniform_ivec2(t,e){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]?(this._gl.uniform2i(t.location,i[0]=e[0],i[1]=e[1]),1):0}_uniform_ivec2v(t,e){return this._gl.uniform2iv(t.location,e),1}_uniform_vec3i(t,e){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]||i[2]!==e[2]?(this._gl.uniform3i(t.location,i[0]=e[0],i[1]=e[1],i[2]=e[2]),1):0}_uniform_vec3vi(t,e){return this._gl.uniform3iv(t.location,e),1}_uniform_vec4i(t,e){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]||i[2]!==e[2]||i[3]!==e[3]?(this._gl.uniform4i(t.location,i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3]),1):0}_uniform_vec4vi(t,e){return this._gl.uniform4iv(t.location,e),1}_uniform_sampler2D(t,e){var i=e._getSource()||e.defaultTexture._getSource(),r=this._gl;return this._bindTexture(t.textureID,r.TEXTURE_2D,i),0}_uniform_sampler3D(t,e){var i=e._getSource()||e.defaultTexture._getSource();return this._bindTexture(t.textureID,WebGL2RenderingContext.TEXTURE_3D,i),0}_uniform_samplerCube(t,e){var i=e._getSource()||e.defaultTexture._getSource(),r=this._gl;return this._bindTexture(t.textureID,r.TEXTURE_CUBE_MAP,i),0}_uniform_UniformBuffer(t,e){e._bindUniformBufferBase()}_bindTexture(t,e,i){const r=this._gl;this._engine._activedTextureID!==t&&(r.activeTexture(t),this._engine._activedTextureID=t);const s=this._engine._activedTextureID-this._gl.TEXTURE0;this._engine._activeTextures[s]!==i&&(r.bindTexture(e,i),this._engine._activeTextures[s]=i)}destroy(){super.destroy();const t=this._gl;t.deleteShader(this._vshader),t.deleteShader(this._pshader),t.deleteProgram(this._program),this._vshader=null,this._pshader=null,this._program=null,this._attributeMap=null,this._uniformMap=null,this._uniformObjectMap=null,this._gl=null,this._engine=null}}class qr extends Or{constructor(e){super(e),this._vertexDeclaration=[],e.isWebGL2||(this._vaoExt=e._supportCapatable.getExtension(t.WebGLExtension.OES_vertex_array_object)),this._vao=this.createVertexArray(),this._angleInstancedArrays=this._engine._supportCapatable.getExtension(t.WebGLExtension.ANGLE_instanced_arrays)}createVertexArray(){return this._engine.isWebGL2?this._gl.createVertexArray():this._vaoExt.createVertexArrayOES()}deleteVertexArray(){this._engine.isWebGL2?this._gl.deleteVertexArray(this._vao):this._vaoExt.deleteVertexArrayOES(this._vao)}bindVertexArray(){this._engine._GLBindVertexArray!=this&&(this._engine.isWebGL2?this._gl.bindVertexArray(this._vao):this._vaoExt.bindVertexArrayOES(this._vao),this._engine._GLBindVertexArray=this)}unbindVertexArray(){this._engine.isWebGL2?this._gl.bindVertexArray(null):this._vaoExt.bindVertexArrayOES(null),this._engine._GLBindVertexArray=null}isVertexArray(){this._engine.isWebGL2?this._gl.isVertexArray(this._vao):this._vaoExt.isVertexArrayOES(this._vao)}applyVertexBuffer(t){if(this.clearVAO(),this._vertexBuffers=t,this._engine._GLBindVertexArray!=this)throw"BufferState: must call bind() function first.";this._vertexDeclaration.length=t.length;var e=0;t.forEach((t=>{var i=t.vertexDeclaration;this._vertexDeclaration[e++]=t.vertexDeclaration;var r=i._shaderValues;for(var s in t.bind(),r){var a=parseInt(s),n=r[s];this._gl.enableVertexAttribArray(a),this._gl.vertexAttribPointer(a,n[0],n[1],!!n[2],n[3],n[4]),t.instanceBuffer&&this.vertexAttribDivisor(a,1)}}))}clearVAO(){for(let r=0,s=this._vertexDeclaration.length;r<s;r++){var t=this._vertexDeclaration[r]._shaderValues;for(var e in t){var i=parseInt(e);this._gl.disableVertexAttribArray(i)}}}applyIndexBuffer(t){if(null!=t){if(this._engine._GLBindVertexArray!=this)throw"BufferState: must call bind() function first.";this._bindedIndexBuffer!==t&&(t.bind(),this._bindedIndexBuffer=t)}}vertexAttribDivisor(t,e){this._engine.isWebGL2?this._gl.vertexAttribDivisor(t,e):this._angleInstancedArrays.vertexAttribDivisorANGLE(t,e)}destroy(){super.destroy(),this._gl,this.deleteVertexArray(),this._gl=null,this._engine=null}}class $r{constructor(e,i=t.WebGLMode.Auto){this._propertyNameMap={},this._propertyNameCounter=0,this._IDCounter=0,this._isShaderDebugMode=!0,this._curUBOPointer=0,this._GLUBOPointerMap=new Map,this._GLBindPointerUBOMap=new Map,this._lastClearColor=new Z,this._lastClearDepth=1,this._GLStatisticsInfo=new Map,this._config=e,this._isWebGL2=!1,this._lastViewport=new je(0,0,0,0),this._lastClearColor=new Z(0,0,0,0),this._lastScissor=new je(0,0,0,0),this._webglMode=i,this._initStatisticsInfo()}get gl(){return this._gl}get isWebGL2(){return this._isWebGL2}get webglConfig(){return this._config}_initStatisticsInfo(){this._GLStatisticsInfo.set(t.RenderStatisticsInfo.DrawCall,0),this._GLStatisticsInfo.set(t.RenderStatisticsInfo.InstanceDrawCall,0),this._GLStatisticsInfo.set(t.RenderStatisticsInfo.Triangle,0),this._GLStatisticsInfo.set(t.RenderStatisticsInfo.UniformUpload,0),this._GLStatisticsInfo.set(t.RenderStatisticsInfo.TextureMemeory,0),this._GLStatisticsInfo.set(t.RenderStatisticsInfo.GPUMemory,0),this._GLStatisticsInfo.set(t.RenderStatisticsInfo.RenderTextureMemory,0),this._GLStatisticsInfo.set(t.RenderStatisticsInfo.BufferMemory,0)}_addStatisticsInfo(t,e){this._GLStatisticsInfo.set(t,this._GLStatisticsInfo.get(t)+e)}clearStatisticsInfo(t){this._GLStatisticsInfo.set(t,0)}getStatisticsInfo(t){return this._GLStatisticsInfo.get(t)}_getBindUBOBuffer(t){return this._GLBindPointerUBOMap.get(t)}_setBindUBOBuffer(t,e){this._GLBindPointerUBOMap.set(t,e)}initRenderEngine(e){let i,r;switch(this._webglMode){case t.WebGLMode.Auto:i=["webgl2","experimental-webgl2","webgl","experimental-webgl"];break;case t.WebGLMode.WebGL1:i=["webgl","experimental-webgl"];break;case t.WebGLMode.WebGL2:i=["webgl2","experimental-webgl2"]}for(var s=0;s<i.length;s++){try{r=e.getContext(i[s],this._config)}catch(t){}if(r){"webgl2"!==i[s]&&"experimental-webgl2"!==i[s]||(this._isWebGL2=!0);break}}this._gl=r,this._initBindBufferMap(),this._supportCapatable=new Vr(this),this._GLParams=new Xr(this),this._GLRenderState=new zr(this),this._glTextureIDParams=[r.TEXTURE0,r.TEXTURE1,r.TEXTURE2,r.TEXTURE3,r.TEXTURE4,r.TEXTURE5,r.TEXTURE6,r.TEXTURE7,r.TEXTURE8,r.TEXTURE9,r.TEXTURE10,r.TEXTURE11,r.TEXTURE12,r.TEXTURE13,r.TEXTURE14,r.TEXTURE15,r.TEXTURE16,r.TEXTURE17,r.TEXTURE18,r.TEXTURE19,r.TEXTURE20,r.TEXTURE21,r.TEXTURE22,r.TEXTURE23,r.TEXTURE24,r.TEXTURE25,r.TEXTURE26,r.TEXTURE27,r.TEXTURE28,r.TEXTURE29,r.TEXTURE30,r.TEXTURE31],this._activedTextureID=r.TEXTURE0,this._activeTextures=[],this._GLTextureContext=this.isWebGL2?new kr(this):new Gr(this),this._GLRenderDrawContext=new Yr(this),this._GL2DRenderContext=new Hr(this)}_initBindBufferMap(){this._GLBufferBindMap={},this._GLBufferBindMap[t.BufferTargetType.ARRAY_BUFFER]=null,this._GLBufferBindMap[t.BufferTargetType.ELEMENT_ARRAY_BUFFER]=null,this._GLBufferBindMap[t.BufferTargetType.UNIFORM_BUFFER]=null}_getbindBuffer(t){return this._GLBufferBindMap[t]}_setbindBuffer(t,e){this._GLBufferBindMap[t]=e}_bindTexture(t,e){const i=this._activedTextureID-this._gl.TEXTURE0;this._activeTextures[i]!==e&&(this._gl.bindTexture(t,e),this._activeTextures[i]=e)}bindTexture(t){this._bindTexture(t._texture.target,t._getSource())}applyRenderStateCMD(t){this._GLRenderState.applyRenderStateCommand(t)}getCapable(t){return this._supportCapatable.getCapable(t)}viewport(t,e,i,r){const s=this._gl,a=this._lastViewport;h.isConch?s.viewport(t,e,i,r):t===a.x&&e===a.y&&i===a.z&&r===a.w||(s.viewport(t,e,i,r),a.setValue(t,e,i,r))}scissor(t,e,i,r){const s=this._gl,a=this._lastScissor;h.isConch?s.scissor(t,e,i,r):t===a.x&&e===a.y&&i===a.z&&r===a.w||(s.scissor(t,e,i,r),a.setValue(t,e,i,r))}scissorTest(t){t?this._gl.enable(this._gl.SCISSOR_TEST):this._gl.disable(this._gl.SCISSOR_TEST)}clearRenderTexture(e,i=null,r=1){var s;e&t.RenderClearFlag.Color&&(i&&!this._lastClearColor.equal(i)&&(this._gl.clearColor(i.r,i.g,i.b,i.a),i.cloneTo(this._lastClearColor)),s|=this.gl.COLOR_BUFFER_BIT),e&t.RenderClearFlag.Depth&&(this._lastClearDepth!=r&&(this._gl.clearDepth(r),this._lastClearDepth=r),this._GLRenderState.setDepthMask(!0),s|=this._gl.DEPTH_BUFFER_BIT),e&t.RenderClearFlag.Stencil&&(this._gl.clearStencil(0),this._GLRenderState.setStencilMask(!0),s|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(s)}copySubFrameBuffertoTex(t,e,i,r,s,a,n,h){this._bindTexture(t._texture.target,t._getSource()),this._gl.copyTexSubImage2D(t._texture.target,e,i,r,s,a,n,h)}colorMask(t,e,i,r){this._gl.colorMask(t,e,i,r)}getParams(t){return this._GLParams.getParams(t)}createBuffer(t,e){return new Wr(this,t,e)}createShaderInstance(t,e,i){return new Kr(this,t,e,i)}createVertexState(){return new qr(this)}getUBOPointer(t){return this._GLUBOPointerMap.has(t)||this._GLUBOPointerMap.set(t,this._curUBOPointer++),this._GLUBOPointerMap.get(t)}getTextureContext(){return this._GLTextureContext}getDrawContext(){return this._GLRenderDrawContext}get2DRenderContext(){return this._GL2DRenderContext}getCreateRenderOBJContext(){return this._renderOBJCreateContext}propertyNameToID(t){if(null!=this._propertyNameMap[t])return this._propertyNameMap[t];var e=this._propertyNameCounter++;return this._propertyNameMap[t]=e,this._propertyNameMap[e]=t,e}propertyIDToName(t){return this._propertyNameMap[t]}uploadUniforms(t,e,i,r){t.bind();for(var s=i._data,a=e.getArrayData(),n=0,h=0,o=a.length;h<o;h++){var l=a[h];if(r||-1!==l.textureID){var _=s[l.dataOffset];null!=_&&(n+=l.fun.call(l.caller,l,_))}}return n}uploadCustomUniforms(t,e,i,r){t.bind();var s=0,a=e[i];return a&&null!=r&&(s+=a.fun.call(a.caller,a,r)),s}createRenderStateComand(){return new Fr}}class Zr{constructor(t){this._destroyed=!1,this._engine=t,this._gl=this._engine.gl,this._id=this._engine._IDCounter++}get destroyed(){return this._destroyed}setResourceManager(){}destroy(){this._destroyed||(this._destroyed=!0)}}class Qr extends Zr{constructor(t,e){super(t),this._native=e}createTextureInternal(t,e,i,r,s,a){return this._native.createTextureInternal(t,e,i,r,s,a)}setTextureImageData(t,e,i,r){this._native.setTextureImageData(t,e._nativeObj.conchImgId,i,r)}setTexturePixelsData(t,e,i,r){this._native.setTexturePixelsData(t,e,i,r)}initVideoTextureData(t){}setTextureSubPixelsData(t,e,i,r,s,a,n,h,o,l){this._native.setTextureSubPixelsData(t,e,i,r,s,a,n,h,o,l)}setTexturebySubImageData(t,e,i,r,s,a){}setTextureHDRData(t,e){let i=e.readScanLine();this.setTexturePixelsData(t,i,!1,!1)}setTextureDDSData(t,e){throw new Error("setTextureDDSData Method not implemented.")}setTextureKTXData(t,e){throw new Error("setTextureKTXData Method not implemented.")}setCubeImageData(t,e,i,r){var s=[],a=e.length;for(let t=0;t<a;t++)s.push(e[t]._nativeObj);this._native.setCubeImageData(t,s,i,r)}setCubePixelsData(t,e,i,r){this._native.setCubePixelsData(t,e,i,r)}setCubeSubPixelData(t,e,i,r,s,a,n,h,o,l){this._native.setCubeSubPixelData(t,e,i,r,s,a,n,h,o,l)}setCubeDDSData(t,e){throw new Error("setCubeDDSData Method not implemented.")}setCubeKTXData(t,e){throw new Error("setCubeKTXData Method not implemented.")}setTextureCompareMode(t,e){return this._native.setTextureCompareMode(t,e)}bindRenderTarget(t){this._native.bindRenderTarget(t)}bindoutScreenTarget(){this._native.bindoutScreenTarget()}unbindRenderTarget(t){this._native.unbindRenderTarget(t)}createRenderTextureInternal(t,e,i,r,s,a){return this._native.createRenderTextureInternal(t,e,i,r,s,a)}createRenderTargetInternal(e,i,r,s,a,n,h){return this._native.createRenderTargetInternal(e,i,r,s||t.RenderTargetFormat.None,a,n,h)}createRenderTargetCubeInternal(t,e,i,r,s,a){return this._native.createRenderTargetCubeInternal(t,e,i,r,s,a)}createRenderTextureCubeInternal(t,e,i,r,s){throw new Error("createRenderTextureCubeInternal Method not implemented.")}setupRendertargetTextureAttachment(t,e){this._native.setupRendertargetTextureAttachment(t,e)}readRenderTargetPixelData(t,e,i,r,s,a){return this._native.readRenderTargetPixelData(t,e,i,r,s,a)}updateVideoTexture(t,e,i,r){this._native.updateVideoTexture(t,e._nativeObj.conchImgId,i,r)}getRenderTextureData(t,e,i,r,s){return this._native.getRenderTextureData(t,e,i,r,s)}}class Jr extends Qr{constructor(t,e){super(t,e)}}class ts extends Zr{constructor(t){super(t),this._vertexDeclaration=[],this._nativeObj=new window.conchGLVertexState(t._nativeObj),this._nativeVertexBuffers=[]}bindVertexArray(){this._nativeObj.bindVertexArray()}unbindVertexArray(){this._nativeObj.unbindVertexArray()}applyVertexBuffer(t){this._vertexBuffers=t,this._nativeVertexBuffers.length=0,t.forEach((t=>{this._nativeVertexBuffers.push(t._conchVertexBuffer3D)})),this._nativeObj.applyVertexBuffer(this._nativeVertexBuffers)}applyIndexBuffer(t){null!=t&&(this._bindedIndexBuffer=t,this._nativeObj.applyIndexBuffer(t._conchIndexBuffer3D))}destroy(){this._vertexBuffers=null,this._nativeVertexBuffers=[],this._bindedIndexBuffer=null,super.destroy(),this._nativeObj.destroy()}}class es extends Zr{constructor(t){super(t),this._nativeObj=new window.conchGLRenderDrawContext(t._nativeObj)}drawElementsInstanced(t,e,i,r,s){this._nativeObj.drawElementsInstanced(t,e,i,r,s)}drawArraysInstanced(t,e,i,r){this._nativeObj.drawArraysInstanced(t,e,i,r)}drawArrays(t,e,i){this._nativeObj.drawArrays(t,e,i)}drawElements(t,e,i,r){this._nativeObj.drawElements(t,e,i,r)}drawGeometryElement(t){this._nativeObj.drawGeometryElement(t._nativeObj)}}class is extends Fr{constructor(){super(),this._nativeObj=new window.conchRenderStateCommand}addCMD(e,i){switch(e){case t.RenderStateType.DepthTest:case t.RenderStateType.DepthMask:case t.RenderStateType.DepthFunc:case t.RenderStateType.StencilTest:case t.RenderStateType.StencilMask:case t.RenderStateType.BlendEquation:case t.RenderStateType.CullFace:case t.RenderStateType.FrontFace:this._nativeObj.addCMDInt1(e,i);break;case t.RenderStateType.StencilFunc:case t.RenderStateType.BlendFunc:case t.RenderStateType.BlendEquationSeparate:this._nativeObj.addCMDInt2(e,i[0],i[1]);break;case t.RenderStateType.StencilOp:this._nativeObj.addCMDInt3(e,i[0],i[1],i[2]);break;case t.RenderStateType.BlendType:this._nativeObj.addCMDInt1(e,i!=t.BlendType.BLEND_DISABLE?1:0);break;case t.RenderStateType.BlendFuncSeperate:this._nativeObj.addCMDInt4(e,i[0],i[1],i[2],i[3]);break;default:throw"unknow type of renderStateType"}}applyCMD(){g.renderEngine.applyRenderStateCMD(this)}clear(){this._nativeObj.clear()}}class rs{constructor(e,i=t.WebGLMode.Auto){this._isShaderDebugMode=!0,this._nativeObj=new window.conchWebGLEngine(i)}createRenderStateComand(){return new is}getUBOPointer(t){return this._nativeObj.getUBOPointer(t)}_addStatisticsInfo(t,e){this._nativeObj.addStatisticsInfo(t,e)}clearStatisticsInfo(t){this._nativeObj.clearStatisticsInfo(t)}getStatisticsInfo(t){return this._nativeObj.getStatisticsInfo(t)}get gl(){return this._gl}get isWebGL2(){return this._nativeObj.isWebGL2}get webglConfig(){return this._config}initRenderEngine(t){this._nativeObj.initRenderEngine(),this._GLRenderDrawContext=new es(this),this.isWebGL2?this._GLTextureContext=new Jr(this,new window.conchGL2TextureContext(this._nativeObj)):this._GLTextureContext=new Qr(this,new window.conchGLTextureContext(this._nativeObj))}bindTexture(t){throw new Error("Method not implemented.")}applyRenderStateCMD(t){this._nativeObj.applyRenderStateCommand(t._nativeObj)}getCapable(t){return this._nativeObj.getCapable(t)}viewport(t,e,i,r){this._nativeObj.viewport(t,e,i,r)}scissor(t,e,i,r){this._nativeObj.scissor(t,e,i,r)}scissorTest(t){this._nativeObj.scissorTest(t)}clearRenderTexture(t,e=null,i=1){e?this._nativeObj.clearRenderTexture(t,!0,e.r,e.g,e.b,e.a,i):this._nativeObj.clearRenderTexture(t,!1,Z.BLACK.r,Z.BLACK.g,Z.BLACK.b,Z.BLACK.a,i)}copySubFrameBuffertoTex(t,e,i,r,s,a,n,h){this._nativeObj.copySubFrameBuffertoTex(t._texture,e,i,r,s,a,n,h)}colorMask(t,e,i,r){this._nativeObj.colorMask(t,e,i,r)}getParams(t){return this._nativeObj.getParams(t)}createBuffer(t,e){return new window.conchGLBuffer(this._nativeObj,t,e)}createShaderInstance(t,e,i){throw new Error("Method not implemented.")}createVertexState(){return new ts(this)}getTextureContext(){return this._GLTextureContext}getDrawContext(){return this._GLRenderDrawContext}get2DRenderContext(){return this._GL2DRenderContext}getCreateRenderOBJContext(){return this._renderOBJCreateContext}propertyNameToID(t){return this._nativeObj.propertyNameToID(t)}propertyIDToName(t){throw new Error("Method not implemented.")}uploadUniforms(t,e,i,r){throw new Error("Method not implemented.")}uploadCustomUniforms(t,e,i,r){throw new Error("Method not implemented.")}}class ss{static customRequestAnimationFrame(t,e){ss._customRequestAnimationFrame=t,ss._loopFunction=e}static set customRenderEngine(t){ss._customEngine=t}static get customRenderEngine(){return ss._customEngine}constructor(t,i,r){this._first=!0,this._startTm=0,this._timeId=0,ss._Render=this,ss._mainCanvas=r;let s=ss._mainCanvas.source;s.id="layaCanvas",s.width=t,s.height=i,h.isConch&&document.body.appendChild(s),this.initRender(ss._mainCanvas,t,i),window.requestAnimationFrame((function loop(t){performance.now(),a._first&&(a._startTm=Math.floor(t/l)*l,a._first=!1);t-=a._startTm;let e=Math.floor(t/l);(e-ss.lastFrm>0||h.isConch)&&(ss.lastFrm=e,n.stage._loop());ss._customRequestAnimationFrame&&ss._loopFunction?ss._customRequestAnimationFrame(ss._loopFunction):window.requestAnimationFrame(loop)}));let a=this;performance.now();let o=e.FPS,l=ss.ifps=1e3/o;n.stage.on("visibilitychange",this,this._onVisibilitychange)}_onVisibilitychange(){n.stage.isVisibility?0!=this._timeId&&window.clearInterval(this._timeId):this._timeId=window.setInterval(this._enterFrame,1e3)}static vsyncTime(){return ss.lastFrm*ss.ifps}initRender(i,r,s){let a={stencil:e.isStencil,alpha:e.isAlpha,antialias:e.isAntialias,premultipliedAlpha:e.premultipliedAlpha,preserveDrawingBuffer:e.preserveDrawingBuffer,depth:e.isDepth,failIfMajorPerformanceCaveat:e.isfailIfMajorPerformanceCaveat,powerPreference:e.powerPreference};const n=e.useWebGL2?t.WebGLMode.Auto:t.WebGLMode.WebGL1;let o;if(ss.customRenderEngine)o=ss.customRenderEngine,o.initRenderEngine(ss._mainCanvas.source);else if(h.isConch&&!window.conchConfig.conchWebGL)o=new rs(a,n),o.initRenderEngine(ss._mainCanvas.source),Lr._isWebGL2=o.isWebGL2;else{o=new $r(a,n),o.initRenderEngine(ss._mainCanvas.source);var l=et.mainContext=o.gl;if(e.printWebglOrder&&this._replaceWebglcall(l),!l)return!1;l&&(Lr._isWebGL2=o.isWebGL2)}g.renderEngine=o,g.textureContext=o.getTextureContext(),g.renderDrawContext=o.getDrawContext(),g.render2DContext=o.get2DRenderContext(),i.size(r,s),Gt.__init__(),Je.__init__(),Ut.__init__();var _=new Je;return Je._rendercontex=_,_.isMain=!0,ss._context=_,i._setContext(_),st.__init__(),Tt.__init__(),Se.__init__(),it._init_(),!0}_replaceWebglcall(t){var e={};for(const i in t)"function"==typeof t[i]&&"getError"!=i&&"__SPECTOR_Origin_getError"!=i&&"__proto__"!=i&&(e[i]=t[i],t[i]=function(){let r=[];for(let t=0;t<arguments.length;t++)r.push(arguments[t]);let s=e[i].apply(t,r);t.getError();return s})}_enterFrame(t=null){n.stage._loop()}static get context(){return ss._context}static get canvas(){return ss._mainCanvas.source}}ss.lastFrm=0,ss.ifps=1e3/60;class as extends gr{constructor(){super(),this._multiline=!1,this._editable=!0,this._maxChars=1e5,this._type="text",this._prompt="",this._promptColor="#A9A9A9",this._originColor="#000000",this._content="",as.IOS_IFRAME=n.Browser.onIOS&&n.Browser.window.top!=n.Browser.window.self,this._width=100,this._height=20,this.multiline=!1,this.overflow=gr.SCROLL,this.on(y.MOUSE_DOWN,this,this._onMouseDown),this.on(y.UNDISPLAY,this,this._onUnDisplay)}static __init__(){if(as._createInputElement(),n.Browser.onMobile){var t=!1;(n.Browser.onMiniGame||n.Browser.onBDMiniGame||n.Browser.onQGMiniGame||n.Browser.onKGMiniGame||n.Browser.onVVMiniGame||n.Browser.onAlipayMiniGame||n.Browser.onQQMiniGame||n.Browser.onBLMiniGame||n.Browser.onTTMiniGame||n.Browser.onHWMiniGame||n.Browser.onTBMiniGame)&&(t=!0),ss.canvas.addEventListener(as.IOS_IFRAME?t?"touchend":"click":"touchend",as._popupInputMethod)}}static _popupInputMethod(t){br.isTextInputting&&as.inputElement.focus()}static _createInputElement(){as._initInput(as.area=n.Browser.createElement("textarea")),as._initInput(as.input=n.Browser.createElement("input")),as.inputContainer=n.Browser.createElement("div"),as.inputContainer.style.position="absolute",as.inputContainer.style.zIndex="1E5",n.Browser.container.appendChild(as.inputContainer),as.inputContainer.setPos=function(t,e){as.inputContainer.style.left=t+"px",as.inputContainer.style.top=e+"px"}}static _initInput(t){var e=t.style;e.cssText="position:absolute;overflow:hidden;resize:none;transform-origin:0 0;-webkit-transform-origin:0 0;-moz-transform-origin:0 0;-o-transform-origin:0 0;",e.resize="none",e.backgroundColor="transparent",e.border="none",e.outline="none",e.zIndex="1",t.addEventListener("input",as._processInputting),t.addEventListener("mousemove",as._stopEvent,{passive:!1}),t.addEventListener("mousedown",as._stopEvent,{passive:!1}),t.addEventListener("touchmove",as._stopEvent,{passive:!1}),t.setFontFace=function(e){t.style.fontFamily=e},h.isConch&&!as.isAppUseNewInput||(t.setColor=function(e){t.style.color=e},t.setFontSize=function(e){t.style.fontSize=e+"px"})}static _processInputting(t){var e=as.inputElement.target;if(e){var i=as.inputElement.value;e._restrictPattern&&(i=i.replace(/\u2006|\x27/g,""),e._restrictPattern.test(i)&&(i=i.replace(e._restrictPattern,""),as.inputElement.value=i)),e._text=i,e.event(y.INPUT)}}static _stopEvent(t){"touchmove"==t.type&&t.preventDefault(),t.stopPropagation&&t.stopPropagation()}setSelection(t,e){this.focus=!0,as.inputElement.selectionStart=t,as.inputElement.selectionEnd=e}get multiline(){return this._multiline}set multiline(t){this._multiline=t,this.valign=t?"top":"middle"}get nativeInput(){return this._multiline?as.area:as.input}_onUnDisplay(t=null){this.focus=!1}_onMouseDown(t){this.focus=!0}_syncInputTransform(){var t=this.nativeInput,e=ji.getTransformRelativeToWindow(this,this.padding[3],this.padding[0]),i=this._width-this.padding[1]-this.padding[3],r=this._height-this.padding[0]-this.padding[2];h.isConch&&!as.isAppUseNewInput?(t.setScale(e.scaleX,e.scaleY),t.setSize(i,r),t.setPos(e.x,e.y)):(as.inputContainer.style.transform=as.inputContainer.style.webkitTransform="scale("+e.scaleX+","+e.scaleY+") rotate("+n.stage.canvasDegree+"deg)",t.style.width=i+"px",t.style.height=r+"px",as.inputContainer.style.left=e.x+"px",as.inputContainer.style.top=e.y+"px")}select(){this.nativeInput.select()}get focus(){return this._focus}set focus(t){var e=this.nativeInput;this._focus!==t&&(t?(e.target?e.target._focusOut():this._setInputMethod(),(e=this.nativeInput).target=this,this._focusIn()):(e.target=null,this._focusOut(),n.Browser.document.body.scrollTop=0,e.blur(),h.isConch&&!as.isAppUseNewInput?e.setPos(-1e4,-1e4):as.inputContainer.contains(e)&&as.inputContainer.removeChild(e)))}_setInputMethod(){as.input.parentElement&&as.inputContainer.removeChild(as.input),as.area.parentElement&&as.inputContainer.removeChild(as.area),n.Browser.onAndroid&&(as.input=as.inputElement=n.Browser.createElement("input"),as._initInput(as.input)),as.inputElement=this._multiline?as.area:as.input,as.inputContainer.appendChild(as.inputElement),gr.RightToLeft&&(as.inputElement.style.direction="rtl")}_focusIn(){br.isTextInputting=!0;var t=this.nativeInput;as.input&&(as.input.type=this._type),this._focus=!0;var i=t.style;i.whiteSpace=this.wordWrap?"pre-wrap":"nowrap",this._setPromptColor(),t.readOnly=!this._editable,h.isConch&&!as.isAppUseNewInput&&(t.setType(this._type),t.setForbidEdit(!this._editable)),t.maxLength=this._maxChars,t.value=this._content,t.placeholder=this._prompt,n.stage.off(y.KEY_DOWN,this,this._onKeyDown),n.stage.on(y.KEY_DOWN,this,this._onKeyDown),n.stage.focus=this,this.event(y.FOCUS),n.Browser.onPC&&t.focus(),h.isConch&&as.isAppUseNewInput||n.Browser.onMiniGame||n.Browser.onBDMiniGame||n.Browser.onQGMiniGame||n.Browser.onKGMiniGame||n.Browser.onVVMiniGame||n.Browser.onAlipayMiniGame||n.Browser.onQQMiniGame||n.Browser.onBLMiniGame||n.Browser.onTTMiniGame||n.Browser.onHWMiniGame||n.Browser.onTBMiniGame||(this._text=null),this.typeset(),t.setColor(this._originColor),t.setFontSize(this.fontSize),t.setFontFace(n.Browser.onIPhone&&e.fontFamilyMap[this.font]||this.font),h.isConch&&!as.isAppUseNewInput&&t.setMultiAble&&t.setMultiAble(this._multiline),i.lineHeight=this.leading+this.fontSize+"px",i.fontStyle=this.italic?"italic":"normal",i.fontWeight=this.bold?"bold":"normal",i.textAlign=this.align,i.padding="0 0",this._syncInputTransform(),!h.isConch&&n.Browser.onPC&&n.systemTimer.frameLoop(1,this,this._syncInputTransform)}_setPromptColor(){as.promptStyleDOM=n.Browser.getElementById("promptStyle"),as.promptStyleDOM||(as.promptStyleDOM=n.Browser.createElement("style"),as.promptStyleDOM.setAttribute("id","promptStyle"),n.Browser.document.head.appendChild(as.promptStyleDOM)),as.promptStyleDOM.innerText="input::-webkit-input-placeholder, textarea::-webkit-input-placeholder {color:"+this._promptColor+"}input:-moz-placeholder, textarea:-moz-placeholder {color:"+this._promptColor+"}input::-moz-placeholder, textarea::-moz-placeholder {color:"+this._promptColor+"}input:-ms-input-placeholder, textarea:-ms-input-placeholder {color:"+this._promptColor+"}"}_focusOut(){br.isTextInputting&&(br.isiOSWKwebView||(br.isTextInputting=!1),this._focus=!1,this._text=null,this._content=this.nativeInput.value,this._content?(super.set_text(this._content),super.set_color(this._originColor)):(super.set_text(this._prompt),super.set_color(this._promptColor)),n.stage.off(y.KEY_DOWN,this,this._onKeyDown),n.stage.focus=null,this.event(y.BLUR),this.event(y.CHANGE),h.isConch&&!as.isAppUseNewInput&&this.nativeInput.blur(),n.Browser.onPC&&n.systemTimer.clear(this,this._syncInputTransform))}_onKeyDown(t){13===t.keyCode&&(n.Browser.onMobile&&!this._multiline&&(this.focus=!1),this.event(y.ENTER))}miniGameTxt(t){super.set_color(this._originColor),t+="",this._multiline||(t=t.replace(/\r?\n/g,"")),this._content=t,t?super.set_text(t):(super.set_text(this._prompt),super.set_color(this.promptColor))}set text(t){super.set_color(this._originColor),t+="",this._focus?(this.nativeInput.value=t||"",this.event(y.CHANGE)):(this._multiline||(t=t.replace(/\r?\n/g,"")),this._content=t,t?super.set_text(t):(super.set_text(this._prompt),super.set_color(this.promptColor)))}get text(){return this._focus?this.nativeInput.value:this._content||""}changeText(t){this._content=t,this._focus?(this.nativeInput.value=t||"",this.event(y.CHANGE)):super.changeText(t)}set color(t){this._focus&&this.nativeInput.setColor(t),super.set_color(this._content?t:this._promptColor),this._originColor=t}get color(){return super.color}set bgColor(t){super.set_bgColor(t),h.isConch&&!as.isAppUseNewInput&&this.nativeInput.setBgColor(t)}get bgColor(){return super.bgColor}get restrict(){return this._restrictPattern?this._restrictPattern.source:""}set restrict(t){t?((t="[^"+t+"]").indexOf("^^")>-1&&(t=t.replace("^^","")),this._restrictPattern=new RegExp(t,"g")):this._restrictPattern=null}set editable(t){this._editable=t,h.isConch&&!as.isAppUseNewInput&&as.input.setForbidEdit(!t)}get editable(){return this._editable}get maxChars(){return this._maxChars}set maxChars(t){t<=0&&(t=1e5),this._maxChars=t}get prompt(){return this._prompt}set prompt(t){!this._text&&t&&super.set_color(this._promptColor),this.promptColor=this._promptColor,this._text?super.set_text(this._text==this._prompt?t:this._text):super.set_text(t),this._prompt=gr.langPacks&&gr.langPacks[t]?gr.langPacks[t]:t}get promptColor(){return this._promptColor}set promptColor(t){this._promptColor=t,this._content||super.set_color(t)}get type(){return this._type}set type(t){this._getTextStyle().asPassword="password"===t,this._type=t}}as.TYPE_TEXT="text",as.TYPE_PASSWORD="password",as.TYPE_EMAIL="email",as.TYPE_URL="url",as.TYPE_NUMBER="number",as.TYPE_RANGE="range",as.TYPE_DATE="date",as.TYPE_MONTH="month",as.TYPE_WEEK="week",as.TYPE_TIME="time",as.TYPE_DATE_TIME="datetime",as.TYPE_DATE_TIME_LOCAL="datetime-local",as.TYPE_SEARCH="search",as.IOS_IFRAME=!1,as.isAppUseNewInput=!1;class ns extends c{constructor(){super(),this._top=null,this._bottom=null,this._left=null,this._right=null,this._centerX=null,this._centerY=null,this.runInEditor=!0,this.hideFlags|=s.HideAndDontSave}onReset(){this._top=this._bottom=this._left=this._right=this._centerX=this._centerY=null}_onEnable(){this.owner.parent?this._onAdded():this.owner.once(y.ADDED,this,this._onAdded)}_onDisable(){this.owner.off(y.ADDED,this,this._onAdded),this.owner.parent&&this.owner.parent.off(y.RESIZE,this,this._onParentResize)}_onAdded(){this.owner.parent&&this.owner.parent.on(y.RESIZE,this,this._onParentResize),this.resetLayoutX(),this.resetLayoutY()}_onParentResize(){var t=this.resetLayoutX(),e=this.resetLayoutY();(t||e)&&this.owner.event(y.RESIZE)}resetLayoutX(){var t=this.owner;if(!t)return!1;var e=t.parent;if(e)if(null!=this._centerX)t.x=Math.round(.5*(e.width-t.displayWidth)+this._centerX+t.pivotX*t.scaleX);else if(null!=this._left){if(t.x=Math.round(this._left+t.pivotX*t.scaleX),null!=this._right){if(!e._width)return!1;var i=(e._width-this._left-this._right)/(t.scaleX||.01);if(i!=t._width)return t.width=i,!0}}else null!=this._right&&(t.x=Math.round(e.width-t.displayWidth-this._right+t.pivotX*t.scaleX));return!1}resetLayoutY(){var t=this.owner;if(!t)return!1;var e=t.parent;if(e)if(null!=this._centerY)t.y=Math.round(.5*(e.height-t.displayHeight)+this._centerY+t.pivotY*t.scaleY);else if(null!=this._top){if(t.y=Math.round(this._top+t.pivotY*t.scaleY),null!=this._bottom){if(!e._height)return!1;var i=(e._height-this._top-this._bottom)/(t.scaleY||.01);if(i!=t._height)return t.height=i,!0}}else null!=this._bottom&&(t.y=Math.round(e.height-t.displayHeight-this._bottom+t.pivotY*t.scaleY));return!1}resetLayout(){this.owner&&(this.resetLayoutX(),this.resetLayoutY())}get top(){return this._top}set top(t){isNaN(t)&&(t=null),this._top!=t&&(this._top=t,this.resetLayoutY())}get bottom(){return this._bottom}set bottom(t){isNaN(t)&&(t=null),this._bottom!=t&&(this._bottom=t,this.resetLayoutY())}get left(){return this._left}set left(t){isNaN(t)&&(t=null),this._left!=t&&(this._left=t,this.resetLayoutX())}get right(){return this._right}set right(t){isNaN(t)&&(t=null),this._right!=t&&(this._right=t,this.resetLayoutX())}get centerX(){return this._centerX}set centerX(t){isNaN(t)&&(t=null),this._centerX!=t&&(this._centerX=t,this.resetLayoutX())}get centerY(){return this._centerY}set centerY(t){isNaN(t)&&(t=null),this._centerY!=t&&(this._centerY=t,this.resetLayoutY())}}ns.EMPTY=null,ns.EMPTY=new ns;const hs=new m,os=new f;class ls{contains(t,e,i){return!!ls._isHitGraphic(t,e,i,this._hit)&&!ls._isHitGraphic(t,e,i,this._unHit)}static _isHitGraphic(t,e,i,r){if(!r)return!1;let s=r.cmds;if(0==s.length)return!1;let a=s.length;for(let r=0;r<a;r++){let a=s[r];if(a){if("Translate"===a.cmdID)t-=a.tx,e-=a.ty;if(ls._isHitCmd(t,e,i,a))return!0}}return!1}static _isHitCmd(t,e,i,r){if(!r)return!1;var s=!1;switch(r.cmdID){case"DrawRect":r.percent?hs.setTo(r.x*i.width,r.y*i.height,r.width*i.width,r.height*i.height):hs.setTo(r.x,r.y,r.width,r.height),s=hs.contains(t,e);break;case"DrawCircle":let a=r.radius;r.percent?(t-=r.x*i.width,e-=r.y*i.height,a*=i.width):(t-=r.x,e-=r.y),s=t*t+e*e<a*a;break;case"DrawPoly":t-=r.x,e-=r.y,s=ls._ptInPolygon(t,e,r.points)}return s}static _ptInPolygon(t,e,i){var r=os;r.setTo(t,e);var s,a,n,h,o,l=0;o=i.length;for(var _=0;_<o;_+=2){if(s=i[_],a=i[_+1],n=i[(_+2)%o],a!=(h=i[(_+3)%o]))if(!(r.y<Math.min(a,h)))if(!(r.y>=Math.max(a,h)))(r.y-a)*(n-s)/(h-a)+s>r.x&&l++}return l%2==1}get hit(){return this._hit||(this._hit=new Ui),this._hit}set hit(t){this._hit=t}get unHit(){return this._unHit||(this._unHit=new Ui),this._unHit}set unHit(t){this._unHit=t}onAfterDeserialize(){h.isPlaying&&(this._hitCmds&&(this.hit.cmds=this._hitCmds,delete this._hitCmds),this._unHitCmds&&(this.unHit.cmds=this._unHitCmds,delete this._unHitCmds))}}a.regClass("HitArea",ls);class _s{static __init__(){_s.I=new _s,_s.supportWeakMap||n.systemTimer.loop(_s.delInterval,null,_s.clearCache)}static clearCache(){for(var t=0,e=_s._maps.length;t<e;t++){_s._maps[t]._obj={}}}constructor(){this._obj={},_s._maps.push(this)}set(t,e){null!=t&&(_s.supportWeakMap||("string"==typeof t||"number"==typeof t?this._obj[t]=e:(t.$_GID||(t.$_GID=d.getGID()),this._obj[t.$_GID]=e)))}get(t){return null==t?null:_s.supportWeakMap?void 0:"string"==typeof t||"number"==typeof t?this._obj[t]:this._obj[t.$_GID]}del(t){null!=t&&(_s.supportWeakMap||("string"==typeof t||"number"==typeof t?delete this._obj[t]:delete this._obj[this._obj.$_GID]))}has(t){return null!=t&&(!_s.supportWeakMap&&("string"==typeof t||"number"==typeof t?null!=this._obj[t]:null!=this._obj[this._obj.$_GID]))}}_s.supportWeakMap=!1,_s.delInterval=6e5,_s._maps=[];class us extends M{constructor(t){super(),this.version=t,this._deps=[]}create(t,e){return this.json?ms.createByData(null,this.json):null}get deps(){return this._deps}addDep(t){t instanceof M&&(t._addReference(),this._deps.push(t),!h.isPlaying&&t instanceof us&&t.on("obsolute",this,this.onDepObsolute))}addDeps(t){for(let e of t)e instanceof M&&(e._addReference(),this._deps.push(e),!h.isPlaying&&e instanceof us&&e.on("obsolute",this,this.onDepObsolute))}_disposeResource(){for(let t of this._deps)t._removeReference(),!h.isPlaying&&t instanceof us&&t.off("obsolute",this,this.onDepObsolute)}get obsolute(){return this._obsolute}set obsolute(t){this._obsolute!=t&&(this._obsolute=t,t&&!h.isPlaying&&this.event("obsolute"))}onDepObsolute(){this.obsolute=!0}}var ds,cs,ps=us;class fs extends us{constructor(t,e,i){super(i),this.api=t,this.data=e}create(t,e){let i=this.api.parse(this.data,t,e);return Array.isArray(i)?(1==i.length&&(i[0].url=this.url),i[0]):(i.url=this.url,i)}}class ms{static parse(t,e){let i=null==e?void 0:e.root;if(!i){let e=h.isPlaying&&t.props.runtime?t.props.runtime:t.type,r=a.getClass(e);i="instance"==t.props.renderType?r.instance||(r.instance=new r):new r}return i&&i._viewCreated?i:ms.createByData(i,t)}static getBindFun(t){let e=ms._funMap;e||(e=ms._funMap=new _s);var i=ms._funMap.get(t);if(null==i){var r='"'+t+'"',s="(function(data){if(data==null)return;with(data){try{\nreturn "+(r=r.replace(/^"\${|}"$/g,"").replace(/\${/g,'"+').replace(/}/g,'+"'))+"\n}catch(e){}}})";i=window.Laya._runScript(s),ms._funMap.set(t,i)}return i}static createByData(t,e){var i=Ts.create();if("_idMap"in(t=ms.createComp(e,t,t,null,i))&&(t._idMap=i._idMap),e.animations){var s,a,n,h=[],o=e.animations,l=o.length;for(s=0;s<l;s++){switch(a=new _r,n=o[s],a._setUp(i._idMap,n),t[n.name]=a,a._setControlNode(t),n.action){case 1:a.play(0,!1);break;case 2:a.play(0,!0)}h.push(a)}t._aniList=h}return t instanceof xs&&t._width>0&&null==e.props.hitTestPrior&&!t.mouseThrough&&(t.hitTestPrior=!0),i.finish(),t._setBit(r.NOT_READY,!1),t.parent&&t.parent.activeInHierarchy&&t.active&&t._processActive(!0),t}static createInitTool(){return Ts.create()}static createComp(t,e=null,i=null,r=null,s=null){if(!(e=e||ms.getCompInstance(t)))return t.props&&t.props.runtime?console.warn("runtime not found:"+t.props.runtime):console.warn("can not create:"+t.type),null;var n=t.child;if(n)for(var h=e instanceof(ds||(ds=a.getClass("List"))),o=0,l=n.length;o<l;o++){var _=n[o];if(!("itemRender"in e)||"render"!=_.props.name&&"render"!==_.props.renderType)if("Graphic"==_.type)this._addGraphicsToSprite(_,e);else if(this._isDrawType(_.type))this._addGraphicToSprite(_,e,!0);else{if(h){var u=[],d=ms.createComp(_,null,i,u,s);u.length&&(d._$bindData=u)}else d=ms.createComp(_,null,i,r,s);"Script"==_.type?d instanceof c?e.addComponentInstance(d):"owner"in d?d.owner=e:"target"in d&&(d.target=e):"mask"==_.props.renderType||"mask"==_.props.name?e.mask=d:d instanceof ki&&e.addChild(d)}else e.itemRender=_}var p=t.props;for(var f in p){var m=p[f];"string"==typeof m&&(m.indexOf("@node:")>=0||m.indexOf("@Prefab:")>=0)?s&&s.addNodeRef(e,f,m):ms.setCompValue(e,f,m,i,r)}return e._afterInited&&e._afterInited(),t.compId&&s&&s._idMap&&(s._idMap[t.compId]=e),e}static setCompValue(t,e,i,r=null,s=null){if("string"==typeof i&&i.indexOf("${")>-1){if(ms._sheet||(ms._sheet=a.getClass("laya.data.Table")),!ms._sheet)return void console.warn("Can not find class Sheet");if(s)s.push(t,e,i);else if(r){-1==i.indexOf("].")&&(i=i.replace(".","[0]."));var n,h,o=new gs(t,e,i);o.exe(r);for(var l=i.replace(/\[.*?\]\./g,".");null!=(n=ms._parseWatchData.exec(l));){for(var _=n[1];null!=(h=ms._parseKeyWord.exec(_));){var u=h[0],d=r._watchMap[u]||(r._watchMap[u]=[]);d.push(o),ms._sheet.I.notifer.on(u,r,r.changeData,[u])}(d=r._watchMap[_]||(r._watchMap[_]=[])).push(o),ms._sheet.I.notifer.on(_,r,r.changeData,[_])}}}else"var"===e&&r?r[i]=t:t[e]="true"===i||"false"!==i&&i}static getCompInstance(t){if("UIView"==t.type&&t.props&&t.props.pageData)return ms.createByData(null,t.props.pageData);var e=h.isPlaying&&t.props&&t.props.runtime||t.type,i=a.getClass(e);if(!i)throw"Can not find class "+e;if("Script"===t.type&&i.prototype._doAwake){var r=o.createByClass(i);return r._destroyed=!1,r}if(t.props&&"renderType"in t.props&&"instance"==t.props.renderType)return i.instance||(i.instance=new i),i.instance;let s=new i;return s instanceof(cs||(cs=a.getClass("View")))&&(s._scene=s),s}static collectResourceLinks(t){let e=new Set,i=[];function addInnerUrl(t){e.has(t)||(e.add(t),i.push(t))}if(t.loadList)for(let e of t.loadList)addInnerUrl(e);if(t.loadList3D)for(let e of t.loadList3D)addInnerUrl(e);return function check(t){let e=t.props;for(let t in e){let i=e[t];if("string"==typeof i&&i.indexOf("@Prefab:")>=0){addInnerUrl(i.replace("@Prefab:",""))}}let i=t.child;if(i)for(let t=0,e=i.length;t<e;t++){check(i[t])}}(t),i}static createByJson(t,e=null,i=null,r=null,s=null){"string"==typeof t&&(t=JSON.parse(t));var n=t.props;if(!e&&!(e=s?s.runWith(t):a.getInstance(h.isPlaying&&n.runtime||t.type)))return null;var o=t.child;if(o)for(var l=0,_=o.length;l<_;l++){var u=o[l];if("render"!==u.props.name&&"render"!==u.props.renderType||!e._$set_itemRender)if("Graphic"==u.type)this._addGraphicsToSprite(u,e);else if(this._isDrawType(u.type))this._addGraphicToSprite(u,e,!0);else{var d=this.createByJson(u,null,i,r,s);"Script"===u.type?"owner"in d?d.owner=e:"target"in d&&(d.target=e):"mask"==u.props.renderType?e.mask=d:e.addChild(d)}else e.itemRender=u}if(n)for(var c in n){var p=n[c];"var"===c&&i?i[p]=e:p instanceof Array&&e[c]instanceof Function?e[c].apply(e,p):e[c]=p}return r&&t.customProps&&r.runWith([e,t]),e.created&&e.created(),e}static _addGraphicsToSprite(t,e){var i=t.child;if(i&&!(i.length<1)){var r,s,a=this._getGraphicsFromSprite(t,e),n=0,h=0;for(t.props&&(n=this._getObjVar(t.props,"x",0),h=this._getObjVar(t.props,"y",0)),0!=n&&0!=h&&a.translate(n,h),s=i.length,r=0;r<s;r++)this._addGraphicToGraphics(i[r],a);0!=n&&0!=h&&a.translate(-n,-h)}}static _addGraphicToSprite(t,e,i=!1){var r=i?this._getGraphicsFromSprite(t,e):e.graphics;this._addGraphicToGraphics(t,r)}static _getGraphicsFromSprite(t,e){if(!t||!t.props)return e.graphics;var i=t.props.renderType;if("hit"===i||"unHit"===i){var r=e._style.hitArea||(e.hitArea=new ls);r[i]||(r[i]=new Ui);var s=r[i]}return s||(s=e.graphics),s}static _getTransformData(t){var e;("pivotX"in t||"pivotY"in t)&&(e=e||new p).translate(-this._getObjVar(t,"pivotX",0),-this._getObjVar(t,"pivotY",0));var i=this._getObjVar(t,"scaleX",1),r=this._getObjVar(t,"scaleY",1),s=this._getObjVar(t,"rotation",0);return this._getObjVar(t,"skewX",0),this._getObjVar(t,"skewY",0),1==i&&1==r&&0==s||((e=e||new p).scale(i,r),e.rotate(.0174532922222222*s)),e}static _addGraphicToGraphics(t,e){var i,r;if((i=t.props)&&(r=this.DrawTypeDic[t.type])){var s=e,a=this._getParams(i,r[1],r[2],r[3]),n=this._tM;(n||1!=this._alpha)&&(s.save(),n&&s.transform(n),1!=this._alpha&&s.alpha(this._alpha)),s[r[0]].apply(s,a),(n||1!=this._alpha)&&s.restore()}}static _adptLineData(t){return t[2]=parseFloat(t[0])+parseFloat(t[2]),t[3]=parseFloat(t[1])+parseFloat(t[3]),t}static _adptTextureData(t){return t[0]=n.Loader.getRes(t[0]),t}static _adptLinesData(t){return t[2]=this._getPointListByStr(t[2]),t}static _isDrawType(t){return"Image"!==t&&t in this.DrawTypeDic}static _getParams(t,e,i=0,r=null){var s,a,n,h=this._temParam;for(h.length=e.length,a=e.length,s=0;s<a;s++)h[s]=this._getObjVar(t,e[s][0],e[s][1]);return this._alpha=this._getObjVar(t,"alpha",1),(n=this._getTransformData(t))?(i||(i=0),n.translate(h[i],h[i+1]),h[i]=h[i+1]=0,this._tM=n):this._tM=null,r&&this[r]&&(h=this[r](h)),h}static _getPointListByStr(t){var e,i,r=t.split(",");for(i=r.length,e=0;e<i;e++)r[e]=parseFloat(r[e]);return r}static _getObjVar(t,e,i){return e in t?t[e]:i}}ms._parseWatchData=/\${(.*?)}/g,ms._parseKeyWord=/[a-zA-Z_][a-zA-Z0-9_]*(?:(?:\.[a-zA-Z_][a-zA-Z0-9_]*)+)/g,ms.DrawTypeDic={Rect:["drawRect",[["x",0],["y",0],["width",0],["height",0],["fillColor",null],["lineColor",null],["lineWidth",1]]],Circle:["drawCircle",[["x",0],["y",0],["radius",0],["fillColor",null],["lineColor",null],["lineWidth",1]]],Pie:["drawPie",[["x",0],["y",0],["radius",0],["startAngle",0],["endAngle",0],["fillColor",null],["lineColor",null],["lineWidth",1]]],Image:["drawTexture",[["x",0],["y",0],["width",0],["height",0]]],Texture:["drawTexture",[["skin",null],["x",0],["y",0],["width",0],["height",0]],1,"_adptTextureData"],FillTexture:["fillTexture",[["skin",null],["x",0],["y",0],["width",0],["height",0],["repeat",null]],1,"_adptTextureData"],FillText:["fillText",[["text",""],["x",0],["y",0],["font",null],["color",null],["textAlign",null]],1],Line:["drawLine",[["x",0],["y",0],["toX",0],["toY",0],["lineColor",null],["lineWidth",0]],0,"_adptLineData"],Lines:["drawLines",[["x",0],["y",0],["points",""],["lineColor",null],["lineWidth",0]],0,"_adptLinesData"],Curves:["drawCurves",[["x",0],["y",0],["points",""],["lineColor",null],["lineWidth",0]],0,"_adptLinesData"],Poly:["drawPoly",[["x",0],["y",0],["points",""],["fillColor",null],["lineColor",null],["lineWidth",1]],0,"_adptLinesData"]},ms._temParam=[];class gs{constructor(t,e,i){this.comp=t,this.prop=e,this.value=i}exe(t){var e=ms.getBindFun(this.value);this.comp[this.prop]=e.call(this,t)}}class Ts{reset(){this._nodeRefList=null,this._initList=null,this._idMap=null}recover(){this.reset(),o.recover("InitTool",this)}static create(){var t=o.getItemByClass("InitTool",Ts);return t._idMap={},t}addNodeRef(t,e,i){this._nodeRefList||(this._nodeRefList=[]),this._nodeRefList.push([t,e,i])}setNodeRef(){if(this._nodeRefList)if(this._idMap){var t,e,i;for(e=this._nodeRefList.length,t=0;t<e;t++)(i=this._nodeRefList[t])[0][i[1]]=this.getReferData(i[2]);this._nodeRefList=null}else this._nodeRefList=null}getReferData(t){if(t.indexOf("@Prefab:")>=0)return new fs(ms,ar.getRes(t.replace("@Prefab:","")),2);if(t.indexOf("@arr:")>=0){var e,i,r,s;r=(e=(t=t.replace("@arr:","")).split(",")).length;var a=[];for(i=0;i<r;i++)(s=e[i])?a.push(this._idMap[s.replace("@node:","")]):a.push(null);return a}return this._idMap[t.replace("@node:","")]}addInitItem(t){this._initList||(this._initList=[]),this._initList.push(t)}doInits(){this._initList&&(this._initList=null)}finish(){this.setNodeRef(),this.doInits(),this.recover()}}class xs extends Ki{constructor(t=!0){super(),this.autoDestroyAtClosed=!1,this._anchorX=null,this._anchorY=null,this._viewCreated=!1,this._timer=n.timer,this._widget=ns.EMPTY,this._scene=this,t&&this.createChildren()}createChildren(){}static setUIMap(t){let e=n.loader.getRes(t);if(!e)throw"请提前加载uimap的json，再使用该接口设置！";for(let t in e)n.Loader.loadedMap[t+".scene"]=e[t]}loadScene(t){xs.unDestroyedScenes.add(this);let e=t.indexOf(".")>-1?t:t+".scene",i=n.loader.getRes(e);i?this._viewCreated||(i.create({root:this}),this._viewCreated=!0,xs.unDestroyedScenes.add(this)):(this._setBit(r.NOT_READY,!0),n.loader.load(e,null,(t=>{xs._loadPage&&xs._loadPage.event("progress",t)})).then((i=>{if(!i)throw"Can not find scene:"+t;this._viewCreated?this._setBit(r.NOT_READY,!1):(this.url=e,xs.hideLoadingPage(),i.create({root:this}),this._viewCreated=!0,xs.unDestroyedScenes.add(this))})))}createView(t){t&&!this._viewCreated&&(this._viewCreated=!0,ms.createByData(this,t))}getNodeByID(t){return this._idMap?this._idMap[t]:null}open(t=!0,e=null){t&&xs.closeAll(),xs.root.addChild(this),this._scene3D&&n.stage.addChildAt(this._scene3D,0),this.onOpened(e)}onOpened(t){}close(t=null){this.onClosed(t),this.autoDestroyAtClosed?(this.destroy(),this._scene3D&&this._scene3D.destroy()):(this.removeSelf(),this._scene3D&&this._scene3D.removeSelf())}onClosed(t=null){}destroy(t=!0){super.destroy(t),this._scene3D&&(this._scene3D.destroy(),this._scene3D=null),this._idMap=null,xs.unDestroyedScenes.delete(this)}set scaleX(t){super.get_scaleX()!=t&&(super.set_scaleX(t),this.event(y.RESIZE))}get scaleX(){return super.scaleX}set scaleY(t){super.get_scaleY()!=t&&(super.set_scaleY(t),this.event(y.RESIZE))}get scaleY(){return super.scaleY}get width(){if(this._width)return this._width;for(var t=0,e=this.numChildren-1;e>-1;e--){var i=this.getChildAt(e);i._visible&&(t=Math.max(i._x+i.width*i.scaleX,t))}return t}set width(t){super.get_width()!=t&&(super.set_width(t),this.callLater(this._sizeChanged))}get height(){if(this._height)return this._height;for(var t=0,e=this.numChildren-1;e>-1;e--){var i=this.getChildAt(e);i._visible&&(t=Math.max(i._y+i.height*i.scaleY,t))}return t}set height(t){super.get_height()!=t&&(super.set_height(t),this.callLater(this._sizeChanged))}get timer(){return this._timer}set timer(t){this._timer=t}get scene3D(){return this._scene3D}get top(){return this._widget.top}set top(t){t!=this._widget.top&&(this._getWidget().top=t)}get bottom(){return this._widget.bottom}set bottom(t){t!=this._widget.bottom&&(this._getWidget().bottom=t)}get left(){return this._widget.left}set left(t){t!=this._widget.left&&(this._getWidget().left=t)}get right(){return this._widget.right}set right(t){t!=this._widget.right&&(this._getWidget().right=t)}get centerX(){return this._widget.centerX}set centerX(t){t!=this._widget.centerX&&(this._getWidget().centerX=t)}get centerY(){return this._widget.centerY}set centerY(t){t!=this._widget.centerY&&(this._getWidget().centerY=t)}get anchorX(){return this._anchorX}set anchorX(t){this._anchorX!=t&&(this._anchorX=t,this.callLater(this._sizeChanged))}get anchorY(){return this._anchorY}set anchorY(t){this._anchorY!=t&&(this._anchorY=t,this.callLater(this._sizeChanged))}_sizeChanged(){null!=this._anchorX&&(this.pivotX=this.anchorX*this.width),null!=this._anchorY&&(this.pivotY=this.anchorY*this.height),this.event(y.RESIZE),this._widget!=ns.EMPTY&&this._widget.resetLayout()}freshLayout(){this._widget!=ns.EMPTY&&this._widget.resetLayout()}_getWidget(){return this._widget===ns.EMPTY&&(this._widget=this.addComponent(ns)),this._widget}static get root(){let t=xs._root;return t||(t=xs._root=n.stage.addChild(new Ki),t.name="root",t.mouseThrough=!0,n.stage.on("resize",null,(()=>{t.size(n.stage.width,n.stage.height),t.event(y.RESIZE)})),t.size(n.stage.width,n.stage.height),t.event(y.RESIZE)),t}static load(t,e=null,i=null){return n.loader.load(t,null,(t=>{xs._loadPage&&xs._loadPage.event("progress",t),i&&i.runWith(t)})).then((i=>{if(!i)throw"Can not find scene:"+t;let r,s=[],a=i.create(null,s);if(s.length>0&&console.warn(`Error loading ${t}: \n${s}`),a instanceof xs)r=a;else{if(!a._is3D)throw"Not a scene:"+t;r=new xs,r.left=r.right=r.top=r.bottom=0,r._scene3D=a}return r._viewCreated=!0,xs.hideLoadingPage(),e&&e.runWith(r),r}))}static open(t,e=!0,i=null,r=null,s=null){if(i instanceof Hi){var a=r;r=i,i=a}return xs.showLoadingPage(),xs.load(t,Hi.create(null,this._onSceneLoaded,[e,r,i]),s)}static _onSceneLoaded(t,e,i,r){r.open(t,i),e&&e.runWith(r)}static close(t,e){let i=!1;for(let r of xs.unDestroyedScenes)if(r&&r.parent&&r.url===t&&(null==e||r.name==e)){r.close(),i=!0;break}return i}static closeAll(){let t=xs.root;for(let i=0,r=t.numChildren;i<r;i++){var e=t.getChildAt(0);e instanceof xs?e.close():e.removeSelf()}}static destroy(t,e){let i=!1;for(let r of xs.unDestroyedScenes)if(r.url===t&&(null==e||r.name==e)&&!r._destroyed){r.destroy(),i=!0;break}return i}static gc(){M.destroyUnusedResources()}static setLoadingPage(t){xs._loadPage=t}static showLoadingPage(t=null,e=500){xs._loadPage&&(n.systemTimer.clear(null,xs._showLoading),n.systemTimer.clear(null,xs._hideLoading),n.systemTimer.once(e,null,xs._showLoading,[t],!1))}static _showLoading(t){n.stage.addChild(xs._loadPage),xs._loadPage instanceof xs&&xs._loadPage.onOpened(t)}static _hideLoading(){xs._loadPage instanceof xs?xs._loadPage.close():xs._loadPage.removeSelf()}static hideLoadingPage(t=500){xs._loadPage&&(n.systemTimer.clear(null,xs._showLoading),n.systemTimer.clear(null,xs._hideLoading),n.systemTimer.once(t,null,xs._hideLoading))}}xs.unDestroyedScenes=new Set;class Es{constructor(t=!0){this.scale=1,this.currFrame=0,this._delta=0,this._map={},this._handlers=[],this._temp=[],this._count=0,t&&Es.gSysTimer&&Es.gSysTimer.frameLoop(1,this,this._update),this.currTimer=this._getNowData(),this._lastTimer=this._getNowData()}get delta(){return this._delta}_update(){if(this.scale<=0)return this._lastTimer=this._getNowData(),void(this._delta=0);var t=this.currFrame=this.currFrame+this.scale,e=this._getNowData(),i=e-this._lastTimer>3e4;this._delta=(e-this._lastTimer)*this.scale;var r=this.currTimer=this.currTimer+this._delta;this._lastTimer=e;var s=this._handlers;this._count=0;for(var a=0,n=s.length;a<n;a++){var h=s[a];if(null!==h.method){var o=h.userFrame?t:r;if(o>=h.exeTime)if(h.repeat)if(!h.jumpFrame||i)h.exeTime+=h.delay,h.run(!1),o>h.exeTime&&(h.exeTime+=Math.ceil((o-h.exeTime)/h.delay)*h.delay);else for(;o>=h.exeTime;)h.exeTime+=h.delay,h.run(!1);else h.run(!0)}else this._count++}(this._count>30||t%200==0)&&this._clearHandlers()}_clearHandlers(){for(var t=this._handlers,e=0,i=t.length;e<i;e++){var r=t[e];null!==r.method?this._temp.push(r):this._recoverHandler(r)}this._handlers=this._temp,t.length=0,this._temp=t}_recoverHandler(t){this._map[t.key]==t&&delete this._map[t.key],t.clear(),Es._pool.push(t)}_getNowData(){return Date.now()}_create(t,e,i,r,s,a,n){if(!i)return s.apply(r,a),null;if(n){var h=this._getHandler(r,s);if(h)return h.repeat=e,h.userFrame=t,h.delay=i,h.caller=r,h.method=s,h.args=a,h.exeTime=i+(t?this.currFrame:this.currTimer+this._getNowData()-this._lastTimer),h}return(h=Es._pool.length>0?Es._pool.pop():new ys).repeat=e,h.userFrame=t,h.delay=i,h.caller=r,h.method=s,h.args=a,h.exeTime=i+(t?this.currFrame:this.currTimer+this._getNowData()-this._lastTimer),this._indexHandler(h),this._handlers.push(h),h}_indexHandler(t){var e=t.caller,i=t.method,r=e?e.$_GID||(e.$_GID=d.getGID()):0,s=i.$_TID||(i.$_TID=Es._mid++);t.key=r+"_"+s,this._map[t.key]=t}once(t,e,i,r=null,s=!0){this._create(!1,!1,t,e,i,r,s)}loop(t,e,i,r=null,s=!0,a=!1){var n=this._create(!1,!0,t,e,i,r,s);n&&(n.jumpFrame=a)}frameOnce(t,e,i,r=null,s=!0){this._create(!0,!1,t,e,i,r,s)}frameLoop(t,e,i,r=null,s=!0){this._create(!0,!0,t,e,i,r,s)}toString(){return" handlers:"+this._handlers.length+" pool:"+Es._pool.length}clear(t,e){var i=this._getHandler(t,e);i&&i.clear()}clearAll(t){if(t)for(var e=0,i=this._handlers.length;e<i;e++){var r=this._handlers[e];r.caller===t&&r.clear()}}_getHandler(t,e){var i=(t?t.$_GID||(t.$_GID=d.getGID()):0)+"_"+(e.$_TID||(e.$_TID=Es._mid++));return this._map[i]}callLater(t,e,i=null){vs.I.callLater(t,e,i)}runCallLater(t,e){vs.I.runCallLater(t,e)}runTimer(t,e){var i=this._getHandler(t,e);i&&null!=i.method&&(this._map[i.key]=null,i.run(!0))}pause(){this.scale=0}resume(){this.scale=1}destroy(){for(var t=0,e=this._handlers.length;t<e;t++){this._handlers[t].clear()}this._handlers.length=0,this._map={},this._temp.length=0}}Es.gSysTimer=null,Es._pool=[],Es._mid=1;class ys{clear(){this.caller=null,this.method=null,this.args=null}run(t){var e=this.caller;if(e&&e.destroyed)return this.clear();var i=this.method,r=this.args;t&&this.clear(),null!=i&&(r?i.apply(e,r):i.call(e))}}class vs{constructor(){this._pool=[],this._map={},this._laters=[]}_update(){let t=this._laters,e=t.length;if(e>0){for(let i=0,r=e-1;i<=r;i++){let e=t[i];this._map[e.key]=null,null!==e.method&&(e.run(),e.clear()),this._pool.push(e),i===r&&(r=t.length-1)}t.length=0}}_getHandler(t,e){var i=t?t.$_GID||(t.$_GID=d.getGID()):0,r=e.$_TID||(e.$_TID=Es._mid++);return this._map[i+"."+r]}callLater(t,e,i=null){if(null==this._getHandler(t,e)){let a;a=this._pool.length?this._pool.pop():new Ss,a.caller=t,a.method=e,a.args=i;var r=t?t.$_GID:0,s=e.$_TID;a.key=r+"."+s,this._map[a.key]=a,this._laters.push(a)}}runCallLater(t,e){var i=this._getHandler(t,e);i&&null!=i.method&&(this._map[i.key]=null,i.run(),i.clear())}clear(t,e){var i=this._getHandler(t,e);return!!i&&(this._map[i.key]=null,i.key="",i.clear(),!0)}clearAll(t){if(t)for(var e=0,i=this._laters.length;e<i;e++){var r=this._laters[e];r.caller===t&&(this._map[r.key]=null,r.key="",r.clear())}}}vs.I=new vs;class Ss{clear(){this.caller=null,this.method=null,this.args=null}run(){var t=this.caller;if(t&&t.destroyed)return this.clear();var e=this.method,i=this.args;null!=e&&(i?e.apply(t,i):e.call(t))}}class Rs{}Rs.createShaderCondition=function(t){var e="(function() {return "+t+";})";return window.Laya._runScript(e)},Rs.changeWebGLSize=function(t,e){Lr.onStageResize(t,e)};class bs{constructor(){this._onUpdates=new Set,this._onLateUpdates=new Set,this._onPreRenders=new Set,this._onPostRenders=new Set,this._toStarts=new Set,this._toDestroys=new Set}callStart(){for(let t of this._toStarts)if(2==t._status){t._status=3;try{t.onStart()}catch(t){console.log(t)}}this._toStarts.clear()}callUpdate(){for(let t of this._onUpdates)if(3==t._status)try{t.onUpdate()}catch(t){console.log(t)}}callLateUpdate(){for(let t of this._onLateUpdates)if(3==t._status)try{t.onLateUpdate()}catch(t){console.log(t)}}callPreRender(){for(let t of this._onPreRenders)if(3==t._status)try{t.onPreRender()}catch(t){console.log(t)}}callPostRender(){for(let t of this._onPostRenders)if(3==t._status)try{t.onPostRender()}catch(t){console.log(t)}}callDestroy(){for(let t of this._toDestroys)try{t._destroy(!0)}catch(t){console.log(t)}this._toDestroys.clear()}add(t){1==t._status&&(t.onStart?(t._status=2,this._toStarts.add(t)):t._status=3),t.onUpdate&&this._onUpdates.add(t),t.onLateUpdate&&this._onLateUpdates.add(t),t.onPreRender&&this._onPreRenders.add(t),t.onPostRender&&this._onPostRenders.add(t)}remove(t){2==t._status&&(t._status=1),t.onUpdate&&this._onUpdates.delete(t),t.onLateUpdate&&this._onLateUpdates.delete(t),t.onPreRender&&this._onPreRenders.delete(t),t.onPostRender&&this._onPostRenders.delete(t)}destroy(){}}class Cs extends Ki{constructor(){super(),this.offset=new f,this._frameRate="fast",this.designWidth=0,this.designHeight=0,this.canvasRotation=!1,this.canvasDegree=0,this.renderingEnabled=!0,this.screenAdaptationEnabled=!0,this._canvasTransform=new p,this._screenMode="none",this._scaleMode="noscale",this._alignV="top",this._alignH="left",this._bgColor="black",this._mouseMoveTime=0,this._renderCount=0,this._safariOffsetY=0,this._frameStartTime=0,this._previousOrientation=We.window.orientation,this._wgColor=[0,0,0,1],this._scene3Ds=[],this._globalRepaintSet=!1,this._globalRepaintGet=!1,this.useRetinalCanvas=!1,this._needUpdateCanvasSize=!1,super.set_transform(this._createTransform()),this.mouseEnabled=!0,this.hitTestPrior=!0,this.autoSize=!1,this._setBit(r.DISPLAYED_INSTAGE,!0),this._setBit(r.ACTIVE_INHIERARCHY,!0),this._isFocused=!0,this._isVisibility=!0,this.useRetinalCanvas=e.useRetinalCanvas;var t=We.window;t.addEventListener("focus",(()=>{this._isFocused=!0,this.event(y.FOCUS),this.event(y.FOCUS_CHANGE)})),t.addEventListener("blur",(()=>{this._isFocused=!1,this.event(y.BLUR),this.event(y.FOCUS_CHANGE),this._isInputting()&&(as.inputElement.target.focus=!1)}));var i="visibilityState",s="visibilitychange",a=t.document;void 0!==a.hidden?(s="visibilitychange",i="visibilityState"):void 0!==a.mozHidden?(s="mozvisibilitychange",i="mozVisibilityState"):void 0!==a.msHidden?(s="msvisibilitychange",i="msVisibilityState"):void 0!==a.webkitHidden&&(s="webkitvisibilitychange",i="webkitVisibilityState"),t.document.addEventListener(s,(()=>{"hidden"==We.document[i]?(this._isVisibility=!1,this._isInputting()&&(as.inputElement.target.focus=!1)):this._isVisibility=!0,this.renderingEnabled=this._isVisibility,this.event(y.VISIBILITY_CHANGE)})),t.addEventListener("resize",(()=>{var t=We.window.orientation;null!=t&&t!=this._previousOrientation&&this._isInputting()&&(as.inputElement.target.focus=!1),this._previousOrientation=t,this._isInputting()||(We.onSafari&&(this._safariOffsetY=(We.window.__innerHeight||We.document.body.clientHeight||We.document.documentElement.clientHeight)-We.window.innerHeight),this.screenAdaptationEnabled&&(this.event(y.WILL_RESIZE),this.updateCanvasSize()))})),t.addEventListener("orientationchange",(t=>{this.screenAdaptationEnabled&&(this.event(y.WILL_RESIZE),this.updateCanvasSize())})),this._componentDriver=new bs}_isInputting(){return We.onMobile&&br.isTextInputting}set width(t){this.designWidth=t,super.set_width(t),this.updateCanvasSize(!0)}get width(){return this.needUpdateCanvasSize(),super.get_width()}set height(t){this.designHeight=t,super.set_height(t),this.updateCanvasSize(!0)}get height(){return this.needUpdateCanvasSize(),super.get_height()}set transform(t){super.set_transform(t)}get transform(){return this._tfChanged&&this._adjustTransform(),this._transform=this._transform||this._createTransform()}get isFocused(){return this._isFocused}get isVisibility(){return this._isVisibility}updateCanvasSize(t){t?this._needUpdateCanvasSize||(this._needUpdateCanvasSize=!0,n.systemTimer.callLater(this,this.updateCanvasSize)):this.setScreenSize(We.clientWidth*We.pixelRatio,We.clientHeight*We.pixelRatio)}needUpdateCanvasSize(){this._needUpdateCanvasSize&&this.updateCanvasSize()}setScreenSize(t,e){this._needUpdateCanvasSize=!1;var i=!1;if(this._screenMode!==Cs.SCREEN_NONE&&(i=(t/e<1?Cs.SCREEN_VERTICAL:Cs.SCREEN_HORIZONTAL)!==this._screenMode)){var r=e;e=t,t=r}this.canvasRotation=i;var s=ss._mainCanvas,a=s.source.style,n=this._canvasTransform.identity(),h=this._scaleMode,o=t/this.designWidth,l=e/this.designHeight,_=this.useRetinalCanvas?t:this.designWidth,u=this.useRetinalCanvas?e:this.designHeight,d=t,c=e,p=We.pixelRatio;switch(this._width=this.designWidth,this._height=this.designHeight,h){case Cs.SCALE_NOSCALE:o=l=1,d=this.designWidth,c=this.designHeight;break;case Cs.SCALE_SHOWALL:o=l=Math.min(o,l),_=d=Math.round(this.designWidth*o),u=c=Math.round(this.designHeight*l);break;case Cs.SCALE_NOBORDER:o=l=Math.max(o,l),d=Math.round(this.designWidth*o),c=Math.round(this.designHeight*l);break;case Cs.SCALE_FULL:o=l=p,_=t,u=e,this._width=t/p,this._height=e/p;break;case Cs.SCALE_FIXED_WIDTH:l=o,this._height=u=Math.round(e/o);break;case Cs.SCALE_FIXED_HEIGHT:o=l,this._width=_=Math.round(t/l);break;case Cs.SCALE_FIXED_AUTO:t/e<this.designWidth/this.designHeight?(l=o,this._height=u=Math.round(e/o)):(o=l,this._width=_=Math.round(t/l));break;case Cs.SCALE_FIXED_AUTO_LAYAME:t<e?(l=o,this._height=u=Math.round(e/o)):(l=o=e/this.designWidth,this._width=_=Math.round(t/o),this._height=u=Math.round(e/l));break;case Cs.SCALE_FIXED_AUTO_LAYAVERSE:t>e?(o=l,this._width=_=Math.round(t/l)):(l=o=t/this.designHeight,this._width=_=Math.round(t/o),this._height=u=Math.round(e/l))}this.useRetinalCanvas&&(d=_=t,c=u=e),o*=this.scaleX,l*=this.scaleY,1===o&&1===l?this.transform.identity():(this.transform.a=this._formatData(o/(d/_)),this.transform.d=this._formatData(l/(c/u))),s.size(_,u),Rs.changeWebGLSize(_,u),n.scale(d/_/p,c/u/p),this._alignH===Cs.ALIGN_LEFT?this.offset.x=0:this._alignH===Cs.ALIGN_RIGHT?this.offset.x=t-d:this.offset.x=.5*(t-d)/p,this._alignV===Cs.ALIGN_TOP?this.offset.y=0:this._alignV===Cs.ALIGN_BOTTOM?this.offset.y=e-c:this.offset.y=.5*(e-c)/p,this.offset.x=Math.round(this.offset.x),this.offset.y=Math.round(this.offset.y),n.translate(this.offset.x,this.offset.y),this._safariOffsetY&&n.translate(0,this._safariOffsetY),this.canvasDegree=0,i&&(this._screenMode===Cs.SCREEN_HORIZONTAL?(n.rotate(Math.PI/2),n.translate(e/p,0),this.canvasDegree=90):(n.rotate(-Math.PI/2),n.translate(0,t/p),this.canvasDegree=-90)),n.a=this._formatData(n.a),n.d=this._formatData(n.d),n.tx=this._formatData(n.tx),n.ty=this._formatData(n.ty),super.set_transform(this.transform),a.transformOrigin=a.webkitTransformOrigin=a.msTransformOrigin=a.mozTransformOrigin=a.oTransformOrigin="0px 0px 0px",a.transform=a.webkitTransform=a.msTransform=a.mozTransform=a.oTransform="matrix("+n.toString()+")",a.width=_,a.height=u,this._safariOffsetY&&n.translate(0,-this._safariOffsetY),n.translate(parseInt(a.left)||0,parseInt(a.top)||0),this.visible=!0,this._repaint|=Mt.REPAINT_CACHE,this.event(y.RESIZE)}setScreenSizeForScene(t,e,i){var r=!1;if(i!==Cs.SCREEN_NONE&&(r=(t/e<1?Cs.SCREEN_VERTICAL:Cs.SCREEN_HORIZONTAL)!==i)){var s=e;e=t,t=s}this.canvasRotation=r,ss._mainCanvas.source.style,this._canvasTransform.clone().identity();var a=this._scaleMode,n=t/this.designWidth,h=e/this.designHeight,o=this.useRetinalCanvas?t:this.designWidth,l=this.useRetinalCanvas?e:this.designHeight,_=t,u=e;We.pixelRatio;let d=this.designWidth,c=this.designHeight;switch(a){case Cs.SCALE_NOSCALE:n=h=1,_=this.designWidth,u=this.designHeight;break;case Cs.SCALE_SHOWALL:n=h=Math.min(n,h),o=_=Math.round(this.designWidth*n),l=u=Math.round(this.designHeight*h);break;case Cs.SCALE_NOBORDER:n=h=Math.max(n,h),_=Math.round(this.designWidth*n),u=Math.round(this.designHeight*h);break;case Cs.SCALE_FULL:n=h=1,d=o=t,c=l=e;break;case Cs.SCALE_FIXED_WIDTH:h=n,c=l=Math.round(e/n);break;case Cs.SCALE_FIXED_HEIGHT:n=h,d=o=Math.round(t/h);break;case Cs.SCALE_FIXED_AUTO:t/e<this.designWidth/this.designHeight?(h=n,c=l=Math.round(e/n)):(n=h,d=o=Math.round(t/h))}return this.useRetinalCanvas&&(_=o=t,u=l=e),{stageWidth:d,stageHeight:c,canvasWidth:o,canvasHeight:l,scaleX:n/(_/o),scaleY:h/(u/l)}}_formatData(t){return Math.abs(t)<1e-6?0:Math.abs(1-t)<.001?t>0?1:-1:t}get scaleMode(){return this._scaleMode}set scaleMode(t){this._scaleMode=t,this.updateCanvasSize(!0)}get alignH(){return this.needUpdateCanvasSize(),this._alignH}set alignH(t){this._alignH=t,this.updateCanvasSize(!0)}get alignV(){return this.needUpdateCanvasSize(),this._alignV}set alignV(t){this._alignV=t,this.updateCanvasSize(!0)}get bgColor(){return this._bgColor}set bgColor(t){this._bgColor=t,this._wgColor=t?St.create(t).arrColor:null,ss.canvas.style.background=t||"none"}get mouseX(){return Math.round(br.mouseX/this.clientScaleX)}get mouseY(){return Math.round(br.mouseY/this.clientScaleY)}getMousePoint(){return f.TEMP.setTo(this.mouseX,this.mouseY)}get clientScaleX(){return this.needUpdateCanvasSize(),this._transform?this._transform.getScaleX():1}get clientScaleY(){return this.needUpdateCanvasSize(),this._transform?this._transform.getScaleY():1}get screenMode(){return this._screenMode}set screenMode(t){this._screenMode=t}repaint(t=Mt.REPAINT_CACHE){this._repaint|=t}parentRepaint(t=Mt.REPAINT_CACHE){}_loop(){return this._globalRepaintGet=this._globalRepaintSet,this._globalRepaintSet=!1,this.render(ss._context,0,0),!0}getFrameTm(){return this._frameStartTime}getTimeFromFrameStart(){return We.now()-this._frameStartTime}set visible(t){this.visible!==t&&(super.set_visible(t),ss._mainCanvas.source.style.visibility=t?"visible":"hidden")}get visible(){return super.visible}render(t,e,i){if(h.isConch)return void this.renderToNative(t,e,i);let r=n.timer._delta/1e3;if(this._frameRate===Cs.FRAME_SLEEP){var s=We.now();if(s-this._frameStartTime<1e3)return;this._frameStartTime=s}else{if(!this._visible)return this._renderCount++,void(this._renderCount%5==0&&(vs.I._update(),Nt.loopCount++,Yt.loopCount=Nt.loopCount,this._runComponents(),this._updateTimers()));this._frameStartTime=We.now(),Yt.loopStTm=this._frameStartTime}this._renderCount++;var a=(this._frameRate===Cs.FRAME_MOUSE?this._frameStartTime-this._mouseMoveTime<2e3?Cs.FRAME_FAST:Cs.FRAME_SLOW:this._frameRate)!==Cs.FRAME_SLOW,o=this._renderCount%2==0;if(Nt.renderSlow=!a,a||o){if(vs.I._update(),Nt.loopCount++,Yt.loopCount=Nt.loopCount,this.renderingEnabled){for(let t=0,e=this._scene3Ds.length;t<e;t++)this._scene3Ds[t]._update(r);this._runComponents(),t.clear(),this._componentDriver.callPreRender(),super.render(t,e,i),Nt._StatRender.renderNotCanvas(t,e,i),Cs.clear(this._bgColor),t.flush(),this._componentDriver.callPostRender(),Ni.instance&&Ni.getInstance().endDispose()}else this._runComponents();this._updateTimers()}}renderToNative(t,e,i){if(this._renderCount++,this._visible){if(this._frameStartTime=We.now(),vs.I._update(),Nt.loopCount++,Yt.loopCount=Nt.loopCount,this.renderingEnabled){for(let t=0,e=this._scene3Ds.length;t<e;t++)this._scene3Ds[t]._update();this._runComponents(),this._componentDriver.callPreRender(),t.clear(),super.render(t,e,i),Nt._StatRender.renderNotCanvas(t,e,i),this._componentDriver.callPostRender()}else this._runComponents();this.renderingEnabled&&(Cs.clear(this._bgColor),t.flush(),Ni.instance&&Ni.getInstance().endDispose()),this._updateTimers()}else this._renderCount%5==0&&(vs.I._update(),Nt.loopCount++,Yt.loopCount=Nt.loopCount,this._runComponents(),this._updateTimers())}_runComponents(){this._componentDriver.callStart(),this._componentDriver.callUpdate(),this._componentDriver.callLateUpdate(),this._componentDriver.callDestroy()}_updateTimers(){n.systemTimer._update(),n.physicsTimer._update(),n.timer._update()}set fullScreenEnabled(t){var e=We.document,i=ss.canvas;t?(i.addEventListener("mousedown",this._requestFullscreen),i.addEventListener("touchstart",this._requestFullscreen),e.addEventListener("fullscreenchange",this._fullScreenChanged),e.addEventListener("mozfullscreenchange",this._fullScreenChanged),e.addEventListener("webkitfullscreenchange",this._fullScreenChanged),e.addEventListener("msfullscreenchange",this._fullScreenChanged)):(i.removeEventListener("mousedown",this._requestFullscreen),i.removeEventListener("touchstart",this._requestFullscreen),e.removeEventListener("fullscreenchange",this._fullScreenChanged),e.removeEventListener("mozfullscreenchange",this._fullScreenChanged),e.removeEventListener("webkitfullscreenchange",this._fullScreenChanged),e.removeEventListener("msfullscreenchange",this._fullScreenChanged))}get frameRate(){return h.isConch?this._frameRateNative:this._frameRate}set frameRate(t){if(h.isConch){var e=window.conch;switch(t){case Cs.FRAME_FAST:e.config.setLimitFPS(60);break;case Cs.FRAME_MOUSE:e.config.setMouseFrame(2e3);break;case Cs.FRAME_SLOW:e.config.setSlowFrame(!0);break;case Cs.FRAME_SLEEP:e.config.setLimitFPS(1)}this._frameRateNative=t}else this._frameRate=t}_requestFullscreen(){var t=We.document.documentElement;t.requestFullscreen?t.requestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullscreen?t.webkitRequestFullscreen():t.msRequestFullscreen&&t.msRequestFullscreen()}_fullScreenChanged(){this.event(y.FULL_SCREEN_CHANGE)}exitFullscreen(){var t=We.document;t.exitFullscreen?t.exitFullscreen():t.mozCancelFullScreen?t.mozCancelFullScreen():t.webkitExitFullscreen&&t.webkitExitFullscreen()}isGlobalRepaint(){return this._globalRepaintGet}setGlobalRepaint(){this._globalRepaintSet=!0}}Cs.SCALE_NOSCALE="noscale",Cs.SCALE_EXACTFIT="exactfit",Cs.SCALE_SHOWALL="showall",Cs.SCALE_NOBORDER="noborder",Cs.SCALE_FULL="full",Cs.SCALE_FIXED_WIDTH="fixedwidth",Cs.SCALE_FIXED_HEIGHT="fixedheight",Cs.SCALE_FIXED_AUTO="fixedauto",Cs.SCALE_FIXED_AUTO_LAYAME="fixedauto_layame",Cs.SCALE_FIXED_AUTO_LAYAVERSE="fixedauto_layaverse",Cs.ALIGN_LEFT="left",Cs.ALIGN_RIGHT="right",Cs.ALIGN_CENTER="center",Cs.ALIGN_TOP="top",Cs.ALIGN_MIDDLE="middle",Cs.ALIGN_BOTTOM="bottom",Cs.SCREEN_NONE="none",Cs.SCREEN_HORIZONTAL="horizontal",Cs.SCREEN_VERTICAL="vertical",Cs.FRAME_FAST="fast",Cs.FRAME_SLOW="slow",Cs.FRAME_MOUSE="mouse",Cs.FRAME_SLEEP="sleep",Cs.clear=function(t){Je.set2DRenderConfig(),Y.worldScissorTest&&g.renderEngine.scissorTest(!1);var i=ss.context,r=0==i._submits._length||e.preserveDrawingBuffer?St.create(t).arrColor:n.stage._wgColor;r?i.clearBG(r[0],r[1],r[2],r[3]):i.clearBG(0,0,0,0),Y.clear()};class As{render(t,e,i,r,s){var a=Tt.create(st.TEXTURE2D,0);this.setShaderInfo(a,s,t.width,t.height),e.drawTarget(t,0,0,i,r,p.EMPTY.identity(),a)}setShaderInfo(t,e,i,r){t.defines.add(yt.BLUR);var s=t;As.blurinfo[0]=i,As.blurinfo[1]=r,s.blurInfo=As.blurinfo;var a=e.strength/3,n=a*a;e.strength_sig2_2sig2_gauss1[0]=e.strength,e.strength_sig2_2sig2_gauss1[1]=n,e.strength_sig2_2sig2_gauss1[2]=2*n,e.strength_sig2_2sig2_gauss1[3]=1/(2*Math.PI*n),s.strength_sig2_2sig2_gauss1=e.strength_sig2_2sig2_gauss1}}As.blurinfo=new Array(2);class ws extends yt{constructor(t=4){super(),this.strength_sig2_2sig2_gauss1=[],this.strength=t,this._glRender=new As}get type(){return yt.BLUR}getStrenth_sig2_2sig2_native(){this.strength_sig2_native||(this.strength_sig2_native=new Float32Array(4));var t=this.strength/3,e=t*t;return this.strength_sig2_native[0]=this.strength,this.strength_sig2_native[1]=e,this.strength_sig2_native[2]=2*e,this.strength_sig2_native[3]=1/(2*Math.PI*e),this.strength_sig2_native}}class Ms{setShaderInfo(t,e,i,r){t.defines.add(r.type);var s=t;s.u_blurInfo1=r._sv_blurInfo1;var a=r._sv_blurInfo2;a[0]=e,a[1]=i,s.u_blurInfo2=a,s.u_color=r.getColor()}render(t,e,i,r,s){var a=i,n=r,h=Tt.create(st.TEXTURE2D,0);this.setShaderInfo(h,a,n,s);var o=Tt.create(st.TEXTURE2D,0),l=p.TEMP.identity();e.drawTarget(t,0,0,a,n,l,h),e.drawTarget(t,0,0,a,n,l,o)}}class Ds extends yt{constructor(t,e=4,i=6,r=6){super(),this._elements=new Float32Array(9),this._sv_blurInfo1=new Array(4),this._sv_blurInfo2=[0,0,1,0],this._color=new St(t||"#000"),this.blur=Math.min(e,20),this.offX=i,this.offY=r,this._sv_blurInfo1[0]=this._sv_blurInfo1[1]=this.blur,this._sv_blurInfo1[2]=i,this._sv_blurInfo1[3]=-r,this._glRender=new Ms}get type(){return ws.GLOW}get offY(){return this._elements[6]}set offY(t){this._elements[6]=t,this._sv_blurInfo1[3]=-t}get offX(){return this._elements[5]}set offX(t){this._elements[5]=t,this._sv_blurInfo1[2]=t}get color(){return this._color.strColor}set color(t){this._color=new St(t)}getColor(){return this._color.arrColor}get blur(){return this._elements[4]}set blur(t){this._elements[4]=t,this._sv_blurInfo1[0]=this._sv_blurInfo1[1]=t}getColorNative(){this._color_native||(this._color_native=new Float32Array(4));var t=this.getColor();return this._color_native[0]=t[0],this._color_native[1]=t[1],this._color_native[2]=t[2],this._color_native[3]=t[3],this._color_native}getBlurInfo1Native(){return this._blurInof1_native||(this._blurInof1_native=new Float32Array(4)),this._blurInof1_native[0]=this._blurInof1_native[1]=this.blur,this._blurInof1_native[2]=this.offX,this._blurInof1_native[3]=this.offY,this._blurInof1_native}getBlurInfo2Native(){return this._blurInof2_native||(this._blurInof2_native=new Float32Array(4)),this._blurInof2_native[2]=1,this._blurInof2_native}}class Is extends R{constructor(){super(...arguments),this.isStopped=!1}set volume(t){}get volume(){return 1}get position(){return 0}get duration(){return 0}play(){}stop(){this.completeHandler&&this.completeHandler.runWith(!1)}pause(){}resume(){}__runComplete(t){t&&t.runWith(!0)}}class Ps extends Is{constructor(t){super(),this._audio=null,this._onEnd=this.__onEnd.bind(this),this._resumePlay=this.__resumePlay.bind(this),t.addEventListener("ended",this._onEnd),this._audio=t,this._src=t.src}__onEnd(t){if(1==this.loops)return this.completeHandler&&(n.systemTimer.once(10,this,this.__runComplete,[this.completeHandler],!1),this.completeHandler=null),this.stop(),void this.event(y.COMPLETE);this.loops>0&&this.loops--,this.startTime=0,this.play()}__resumePlay(){if(this._audio&&this._audio.removeEventListener("canplay",this._resumePlay),!this.isStopped)try{this._audio.currentTime=this.startTime,We.container.appendChild(this._audio),this._audio.play()}catch(t){this.event(y.ERROR)}}play(){this.isStopped=!1;try{this._audio.playbackRate=Os.playbackRate,this._audio.currentTime=this.startTime}catch(t){return void this._audio.addEventListener("canplay",this._resumePlay)}Os.addChannel(this),We.container.appendChild(this._audio),"play"in this._audio&&this._audio.play()}get position(){return this._audio?this._audio.currentTime:0}get duration(){return this._audio?this._audio.duration:0}stop(){super.stop(),this.isStopped=!0,Os.removeChannel(this),this.completeHandler=null,this._audio&&("pause"in this._audio&&h.isConch&&this._audio.stop(),this._audio.pause(),this._audio.removeEventListener("ended",this._onEnd),this._audio.removeEventListener("canplay",this._resumePlay),n.Browser.onIE||this._audio!=Bs._musicAudio&&o.recover("audio:"+this.url,this._audio),We.removeElement(this._audio),this._audio=null,Os.autoReleaseSound&&Os.disposeSoundLater(this.url))}pause(){this.isStopped=!0,Os.removeChannel(this),this._audio&&("pause"in this._audio&&this._audio.pause(),Os.autoReleaseSound&&Os.disposeSoundLater(this.url))}resume(){var t=this._audio;t&&(this.isStopped=!1,0==t.readyState&&(t.src=this._src,t.addEventListener("canplay",this._resumePlay),t.load()),Os.addChannel(this),"play"in t&&t.play())}set volume(t){this._audio&&(this._audio.volume=t)}get volume(){return this._audio?this._audio.volume:1}}class Bs extends R{constructor(){super(...arguments),this.loaded=!1}dispose(){var t=Bs._audioCache[this.url];o.clearBySign("audio:"+this.url),t&&(h.isConch||(t.src=""),delete Bs._audioCache[this.url])}static _initMusicAudio(){Bs._musicAudio||(Bs._musicAudio||(Bs._musicAudio=We.createElement("audio")),h.isConch||We.document.addEventListener("mousedown",Bs._makeMusicOK))}static _makeMusicOK(){We.document.removeEventListener("mousedown",Bs._makeMusicOK),Bs._musicAudio.src?Bs._musicAudio.play():(Bs._musicAudio.src="",Bs._musicAudio.load())}load(t){var e;if(this.url=t,t==Os._bgMusic?(Bs._initMusicAudio(),(e=Bs._musicAudio).originalUrl!=t&&(delete Bs._audioCache[e.originalUrl],e=null)):e=Bs._audioCache[t],e&&e.readyState>=2)this.event(y.COMPLETE);else{e||(t==Os._bgMusic?(Bs._initMusicAudio(),e=Bs._musicAudio):e=We.createElement("audio"),Bs._audioCache[t]=e,lt.inst.resolveURL(t,(t=>{e.src=_t.postFormatURL(_t.formatURL(t))}))),e.originalUrl=t,e.addEventListener("canplaythrough",onLoaded),e.addEventListener("error",onErr);var i=this;this.audio=e,e.load?e.load():onErr()}function onLoaded(){offs(),i.loaded=!0,i.event(y.COMPLETE)}function onErr(){e.load=null,offs(),i.event(y.ERROR)}function offs(){e.removeEventListener("canplaythrough",onLoaded),e.removeEventListener("error",onErr)}}play(t=0,e=0){if(!this.url)return null;var i,r;if(this.url==Os._bgMusic?""!=(i=Bs._musicAudio).src&&i.originalUrl!=this.url&&(delete Bs._audioCache[i.originalUrl],Bs._audioCache[this.url]=i):i=Bs._audioCache[this.url],!i)return null;r=o.getItem("audio:"+this.url),h.isConch?r||(r=We.createElement("audio"),lt.inst.resolveURL(this.url,(t=>{r.src=_t.postFormatURL(_t.formatURL(t))}))):this.url==Os._bgMusic?(Bs._initMusicAudio(),r=Bs._musicAudio,lt.inst.resolveURL(this.url,(t=>{r.src=_t.postFormatURL(_t.formatURL(t))}))):r=r||i.cloneNode(!0),r.originalUrl=this.url;var s=new Ps(r);return s.url=this.url,s.loops=e,s.startTime=t,s.play(),Os.addChannel(s),s}get duration(){var t;return(t=Bs._audioCache[this.url])?t.duration:0}}Bs._audioCache={};class Ls extends Is{constructor(){super(),this.bufferSource=null,this._currentTime=0,this._volume=1,this._startTime=0,this._pauseTime=0,this.context=Fs.ctx,this._onPlayEnd=this.__onPlayEnd.bind(this),this.context.createGain?this.gain=this.context.createGain():this.gain=this.context.createGainNode()}play(){if(Os.addChannel(this),this.isStopped=!1,this._clearBufferSource(),this.audioBuffer){if(this.startTime>=this.duration)return this.stop();var t=this.context,e=this.gain,i=t.createBufferSource();this.bufferSource=i,i.buffer=this.audioBuffer,i.connect(e),e&&e.disconnect(),e.connect(t.destination),i.onended=this._onPlayEnd,this._startTime=We.now(),this.gain.gain.setTargetAtTime?this.gain.gain.setTargetAtTime(this._volume,this.context.currentTime,Ls.SetTargetDelay):this.gain.gain.value=this._volume,0==this.loops&&(i.loop=!0),i.playbackRate.setTargetAtTime?i.playbackRate.setTargetAtTime(Os.playbackRate,this.context.currentTime,Ls.SetTargetDelay):i.playbackRate.value=Os.playbackRate,i.start(0,this.startTime),this._currentTime=0}}__onPlayEnd(){if(1==this.loops)return this.completeHandler&&(n.timer.once(10,this,this.__runComplete,[this.completeHandler],!1),this.completeHandler=null),this.stop(),void this.event(y.COMPLETE);this.loops>0&&this.loops--,this.startTime=0,this.play()}get position(){return this.bufferSource?(We.now()-this._startTime)/1e3+this.startTime:0}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}_clearBufferSource(){if(this.bufferSource){var t=this.bufferSource;t.stop?t.stop(0):t.noteOff(0),t.disconnect(0),t.onended=null,Ls._tryCleanFailed||this._tryClearBuffer(t),this.bufferSource=null}}_tryClearBuffer(t){try{t.buffer=null}catch(t){Ls._tryCleanFailed=!0}}stop(){super.stop(),this._clearBufferSource(),this.audioBuffer=null,this.gain&&this.gain.disconnect(),this.isStopped=!0,Os.removeChannel(this),this.completeHandler=null,Os.autoReleaseSound&&Os.disposeSoundLater(this.url)}pause(){this.isStopped||(this._pauseTime=this.position),this._clearBufferSource(),this.gain&&this.gain.disconnect(),this.isStopped=!0,Os.removeChannel(this),Os.autoReleaseSound&&Os.disposeSoundLater(this.url)}resume(){this.startTime=this._pauseTime,this.play()}set volume(t){this._volume=t,this.isStopped||(this.gain.gain.setTargetAtTime?this.gain.gain.setTargetAtTime(t,this.context.currentTime,Ls.SetTargetDelay):this.gain.gain.value=t)}get volume(){return this._volume}}Ls._tryCleanFailed=!1,Ls.SetTargetDelay=.001;class Fs extends R{constructor(){super(...arguments),this.loaded=!1,this._disposed=!1}static _playEmptySound(){if(null!=Fs.ctx){var t=Fs.ctx.createBufferSource();t.buffer=Fs._miniBuffer,t.connect(Fs.ctx.destination),t.start(0,0,0)}}static _unlock(){Fs._unlocked||(Fs._playEmptySound(),"running"==Fs.ctx.state&&(window.document.removeEventListener("mousedown",Fs._unlock,!0),window.document.removeEventListener("touchend",Fs._unlock,!0),window.document.removeEventListener("touchstart",Fs._unlock,!0),Fs._unlocked=!0))}static initWebAudio(){Fs.ctx=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext),"running"!=Fs.ctx.state&&(Fs._unlock(),window.document.addEventListener("mousedown",Fs._unlock,!0),window.document.addEventListener("touchend",Fs._unlock,!0),window.document.addEventListener("touchstart",Fs._unlock,!0))}load(t){this.url=t,this.audioBuffer=n.loader.getRes(t),this.audioBuffer?this._loaded(this.audioBuffer):n.loader.load(t,ar.SOUND).then((t=>this._loaded(t)))}_loaded(t){this._disposed||(this.audioBuffer=t,this.loaded=!0,this.event(y.COMPLETE))}__playAfterLoaded(){if(this.__toPlays){var t,e,i,r;for(e=(i=this.__toPlays).length,t=0;t<e;t++)(r=i[t])[2]&&!r[2].isStopped&&this.play(r[0],r[1],r[2]);this.__toPlays.length=0}}play(t=0,e=0,i=null){return i=i||new Ls,this.audioBuffer||this.url&&(this.__toPlays||(this.__toPlays=[]),this.__toPlays.push([t,e,i]),this.once(y.COMPLETE,this,this.__playAfterLoaded),this.load(this.url)),i.url=this.url,i.loops=e,i.audioBuffer=this.audioBuffer,i.startTime=t,i.play(),Os.addChannel(i),i}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}dispose(){this._disposed=!0,this.audioBuffer&&(n.loader.clearRes(this.url,this.audioBuffer),this.audioBuffer=null),this.__toPlays=[]}}Fs._miniBuffer=Fs.ctx?Fs.ctx.createBuffer(1,1,22050):void 0,Fs._unlocked=!1;class Os{static __init__(){var t=n.Browser.window,e=!!(t.AudioContext||t.webkitAudioContext||t.mozAudioContext);return e&&Fs.initWebAudio(),Os._soundClass=e?Fs:Bs,We.onTBMiniGame||Bs._initMusicAudio(),Os._musicClass=Bs,e}static addChannel(t){Os._channels.indexOf(t)>=0||Os._channels.push(t)}static removeChannel(t){for(let e=Os._channels.length-1;e>=0;e--)Os._channels[e]==t&&Os._channels.splice(e,1)}static disposeSoundLater(t){Os._lastSoundUsedTimeDic[t]=n.Browser.now(),Os._isCheckingDispose||(Os._isCheckingDispose=!0,n.timer.loop(5e3,null,Os._checkDisposeSound))}static _checkDisposeSound(){let t=n.Browser.now(),e=!1;for(let i in Os._lastSoundUsedTimeDic)t-Os._lastSoundUsedTimeDic[i]>3e4?(delete Os._lastSoundUsedTimeDic[i],Os.disposeSoundIfNotUsed(i)):e=!0;e||(Os._isCheckingDispose=!1,n.timer.clear(null,Os._checkDisposeSound))}static disposeSoundIfNotUsed(t){for(let e=Os._channels.length-1;e>=0;e--)if(Os._channels[e].url==t)return;Os.destroySound(t)}static set autoStopMusic(t){n.stage.off(y.BLUR,null,Os._stageOnBlur),n.stage.off(y.FOCUS,null,Os._stageOnFocus),n.stage.off(y.VISIBILITY_CHANGE,null,Os._visibilityChange),Os._autoStopMusic=t,t&&(n.stage.on(y.BLUR,null,Os._stageOnBlur),n.stage.on(y.FOCUS,null,Os._stageOnFocus),n.stage.on(y.VISIBILITY_CHANGE,null,Os._visibilityChange))}static get autoStopMusic(){return Os._autoStopMusic}static _visibilityChange(){n.stage.isVisibility?Os._stageOnFocus():Os._stageOnBlur()}static _stageOnBlur(){Os._isActive=!1,Os._musicChannel&&(Os._musicChannel.isStopped||(Os._blurPaused=!0,Os._musicChannel.pause())),Os.stopAllSound(),n.stage.once(y.MOUSE_DOWN,null,Os._stageOnFocus)}static _recoverWebAudio(){Fs.ctx&&"running"!=Fs.ctx.state&&Fs.ctx.resume&&Fs.ctx.resume()}static _stageOnFocus(){Os._isActive=!0,Os._recoverWebAudio(),n.stage.off(y.MOUSE_DOWN,null,Os._stageOnFocus),Os._blurPaused&&Os._musicChannel&&Os._musicChannel.isStopped&&(Os._blurPaused=!1,Os._musicChannel.resume())}static set muted(t){t!=Os._muted&&(t&&Os.stopAllSound(),Os.musicMuted=t,Os._muted=t)}static get muted(){return Os._muted}static set soundMuted(t){Os._soundMuted=t}static get soundMuted(){return Os._soundMuted}static set musicMuted(t){t!=Os._musicMuted&&(t?(Os._bgMusic&&Os._musicChannel&&!Os._musicChannel.isStopped?h.isConch?Os._musicChannel._audio&&(Os._musicChannel._audio.muted=!0):Os._musicChannel.pause():Os._musicChannel=null,Os._musicMuted=t):(Os._musicMuted=t,Os._bgMusic&&Os._musicChannel&&(h.isConch?Os._musicChannel._audio&&(Os._musicChannel._audio.muted=!1):Os._musicChannel.resume())))}static get musicMuted(){return Os._musicMuted}static get useAudioMusic(){return Os._useAudioMusic}static set useAudioMusic(t){Os._useAudioMusic=t,Os._musicClass=t?Bs:null}static playSound(t,e=1,i=null,r=null,s=0){if(!Os._isActive||!t)return null;if(Os._muted)return null;if(Os._recoverWebAudio(),t==Os._bgMusic){if(Os._musicMuted)return null}else if(Os._soundMuted)return null;let a;We._isMiniGame||(a=Os._soundCache[t]),r||(r=Os._soundClass),a||(a=new r,a.load(t),We._isMiniGame||(Os._soundCache[t]=a));let n=a.play(s,e);return n?(n.url=t,n.volume=t==Os._bgMusic?Os.musicVolume:Os.soundVolume,n.completeHandler=i,n):null}static destroySound(t){let e=Os._soundCache[t];e&&(delete Os._soundCache[t],e.dispose())}static playMusic(t,e=0,i=null,r=0){return Os._bgMusic=t,Os._musicChannel&&Os._musicChannel.stop(),Os._musicChannel=Os.playSound(t,e,i,Os._musicClass,r)}static stopSound(t){for(let e=Os._channels.length-1;e>=0;e--){let i=Os._channels[e];i.url==t&&i.stop()}}static stopAll(){var t;for(Os._bgMusic=null,t=Os._channels.length-1;t>=0;t--)Os._channels[t].stop()}static stopAllSound(){for(let t=Os._channels.length-1;t>=0;t--){let e=Os._channels[t];e.url!=Os._bgMusic&&e.stop()}}static stopMusic(){Os._musicChannel&&Os._musicChannel.stop(),Os._bgMusic=null}static setSoundVolume(t,e=null){if(e)Os._setVolume(e,t);else{Os.soundVolume=t;for(let e=Os._channels.length-1;e>=0;e--){let i=Os._channels[e];i.url!=Os._bgMusic&&(i.volume=t)}}}static setMusicVolume(t){Os.musicVolume=t,Os._setVolume(Os._bgMusic,t)}static _setVolume(t,e){for(let i=Os._channels.length-1;i>=0;i--){let r=Os._channels[i];r.url==t&&(r.volume=e)}}}Os.musicVolume=1,Os.soundVolume=1,Os.playbackRate=1,Os._useAudioMusic=!0,Os._muted=!1,Os._soundMuted=!1,Os._musicMuted=!1,Os._bgMusic=null,Os._musicChannel=null,Os._channels=[],Os._blurPaused=!1,Os._isActive=!0,Os._lastSoundUsedTimeDic={},Os._isCheckingDispose=!1,Os._soundCache={},Os.autoReleaseSound=!0;class Ns extends Ki{constructor(){super(),this.visible=!1,this.on(y.ADDED,this,this._onParentChange),this.on(y.REMOVED,this,this._onParentChange)}get source(){return this._source}set source(t){this._source=t,t||this.stop()}_onParentChange(){this.target=this.parent}play(t=1,e=null){isNaN(t)&&(t=1),this._source&&(this.stop(),this._channel=Os.playSound(this._source,t,e))}stop(){this._channel&&!this._channel.isStopped&&this._channel.stop(),this._channel=null}_setPlayAction(t,e,i,r=!0){this[i]&&t&&(r?t.on(e,this,this[i]):t.off(e,this,this[i]))}_setPlayActions(t,e,i,r=!0){if(t&&e){var s,a,n=e.split(",");for(a=n.length,s=0;s<a;s++)this._setPlayAction(t,n[s],i,r)}}set playEvent(t){this._playEvents=t,t&&this._tar&&this._setPlayActions(this._tar,t,"play")}set target(t){this._tar&&(this._setPlayActions(this._tar,this._playEvents,"play",!1),this._setPlayActions(this._tar,this._stopEvents,"stop",!1)),this._tar=t,this._tar&&(this._setPlayActions(this._tar,this._playEvents,"play",!0),this._setPlayActions(this._tar,this._stopEvents,"stop",!0))}set stopEvent(t){this._stopEvents=t,t&&this._tar&&this._setPlayActions(this._tar,t,"stop")}}class Us extends D{constructor(){let e=n.Browser.createElement("video");super(e.videoWidth,e.videoHeight,t.RenderTargetFormat.R8G8B8),this._needUpdate=!1,this._frameRender=!0,this._isLoaded=!1,this.immediatelyPlay=!1,this.element=e,this._listeningEvents={},this._dimension=t.TextureDimension.Tex2D;var i=this.element.style;i.position="absolute",i.top="0px",i.left="0px",e.setAttribute("crossorigin","anonymous"),n.Browser.onMobile&&(e["x5-playsInline"]=!0,e["x5-playsinline"]=!0,e.x5PlaysInline=!0,e.playsInline=!0,e["webkit-playsInline"]=!0,e["webkit-playsinline"]=!0,e.webkitPlaysInline=!0,e.playsinline=!0,e.style.playsInline=!0,e.crossOrigin="anonymous",e.setAttribute("playsinline","true"),e.setAttribute("x5-playsinline","true"),e.setAttribute("webkit-playsinline","true"),e.autoplay=!0),e.addEventListener("loadedmetadata",(()=>{this.loadedmetadata()}));const r=this;"requestVideoFrameCallback"in e&&e.requestVideoFrameCallback((function updateVideo(){r._needUpdate=!0,e.requestVideoFrameCallback(updateVideo)})),n.Browser.onWeiXin&&this.loadedmetadata()}isNeedUpdate(){return this._needUpdate}loadedmetadata(){this._isLoaded||(this._width=this.element.videoWidth,this._height=this.element.videoHeight,this._texture=g.textureContext.createTextureInternal(this._dimension,this.element.videoWidth,this.element.videoHeight,t.TextureFormat.R8G8B8,!1,!1),this.wrapModeU=t.WrapMode.Clamp,this.wrapModeV=t.WrapMode.Clamp,this.filterMode=t.FilterMode.Bilinear,g.textureContext.initVideoTextureData(this._texture),this._texture.gammaCorrection=2.2,this.immediatelyPlay&&this.play(),this._isLoaded=!0,this.event(y.READY,this))}get source(){return this._source}get gammaCorrection(){return 2.2}set source(t){this._source=t,t&&lt.inst.resolveURL(t,(t=>{for(;this.element.childElementCount;)this.element.firstChild.remove();t.startsWith("blob:")?this.element.src=t:this.appendSource(t)}))}appendSource(t){var e=n.Browser.createElement("source");e.src=_t.postFormatURL(_t.formatURL(t)),e.type="video/"+d.getFileExtension(t),this.element.appendChild(e)}render(){0!=this.element.readyState&&this.isNeedUpdate()&&(g.textureContext.updateVideoTexture(this._texture,this.element,!1,!1),this._needUpdate=!1)}set frameRender(t){this._frameRender&&!t&&n.timer.clear(this,this.render),!this._frameRender&&t&&n.timer.frameLoop(1,this,this.render),this._frameRender=t}get frameRender(){return this._frameRender}play(){this._texture?(this.element.play(),this._frameRender&&n.timer.frameLoop(1,this,this.render)):this.immediatelyPlay=!0}_getSource(){return this._texture?this._texture.resource:null}get defaultTexture(){return X.whiteTexture}pause(){this.element.pause(),this._frameRender&&n.timer.clear(this,this.render)}load(){this.element.load()}canPlayType(t){var e;switch(t){case 1:e="video/mp4";break;case 2:e="video/ogg";break;case 8:e="video/webm"}return this.element.canPlayType(e)}get buffered(){return this.element.buffered}get currentSrc(){return this.element.currentSrc}get currentTime(){return this.element.currentTime}set currentTime(t){this.element&&(this.element.currentTime=t,this.render())}set volume(t){this.element&&(this.element.volume=t)}get volume(){return this.element.volume}get readyState(){return this.element.readyState}get videoWidth(){return this.element.videoWidth}get videoHeight(){return this.element.videoHeight}get duration(){return this.element.duration}get ended(){return this.element.ended}get error(){return this.element.error}get loop(){return this.element.loop}set loop(t){this.element&&(this.element.loop=t)}get playbackRate(){return this.element.playbackRate}set playbackRate(t){this.element&&(this.element.playbackRate=t)}get muted(){return this.element.muted}set muted(t){this.element&&(this.element.muted=t)}get paused(){return this.element.paused}get preload(){return this.element.preload}set preload(t){this.element&&(this.element.preload=t)}get seekable(){return this.element.seekable}get seeking(){return this.element.seeking}onStartListeningToType(t){if(Gs.has(t)){let e=this._listeningEvents[t];e||(e=this._listeningEvents[t]=()=>{this.event(t)}),this.element.addEventListener(t,e)}}destroy(){h.isConch&&this.element._destroy(),n.timer.clear(this,this.render),super.destroy()}}const Gs=new Set(["abort","canplay","canplaythrough","durationchange","emptied","error","loadeddata","loadedmetadata","loadstart","pause","play","playing","progress","ratechange","seeked","seeking","stalled","suspend","timeupdate","volumechange","waiting"]);class ks extends Ki{constructor(){if(super(),this.texture=this._internalTex=new ht,h.isPlaying&&n.Browser.onMobile){let func=()=>{n.Browser.document.removeEventListener("touchend",func),this._videoTexture&&(We.onIOS?this._videoTexture.load():(this._videoTexture.play(),this._videoTexture.pause()))};n.Browser.document.addEventListener("touchend",func)}}get videoTexture(){return this._videoTexture}set videoTexture(t){this._videoTexture&&(this._videoTexture._removeReference(),this._videoTexture.off(y.READY,this,this.onVideoMetaLoaded)),this._videoTexture=t,t?(this._videoTexture._addReference(),this._videoTexture.on(y.READY,this,this.onVideoMetaLoaded),this._videoTexture._isLoaded&&this._internalTex.setTo(this._videoTexture)):this._internalTex.setTo(null)}get source(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.source}set source(t){t?(this._videoTexture||(this.videoTexture=new Us),this._videoTexture.source=t):this._videoTexture&&(this._videoTexture.source=t)}load(t){this.source=t}play(){this._videoTexture&&this._videoTexture.play()}pause(){this._videoTexture&&this._videoTexture.pause()}reload(){this._videoTexture&&this._videoTexture.load()}canPlayType(t){return this._videoTexture||(this.videoTexture=new Us),this._videoTexture.canPlayType(t)}onVideoMetaLoaded(){this._internalTex.setTo(this._videoTexture)}get buffered(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.buffered}get currentSrc(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.currentSrc}get currentTime(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.currentTime}set currentTime(t){this._videoTexture&&(this._videoTexture.currentTime=t)}set volume(t){this._videoTexture&&(this._videoTexture.volume=t)}get volume(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.volume}get readyState(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.readyState}get videoWidth(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.videoWidth}get videoHeight(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.videoHeight}get duration(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.duration}get ended(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.ended}get error(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.error}get loop(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.loop}set loop(t){this._videoTexture&&(this._videoTexture.loop=t)}get playbackRate(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.playbackRate}set playbackRate(t){this._videoTexture&&(this._videoTexture.playbackRate=t)}get muted(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.muted}set muted(t){this._videoTexture&&(this._videoTexture.muted=t)}get paused(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.paused}get preload(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.preload}set preload(t){this._videoTexture&&(this._videoTexture.preload=t)}get seekable(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.seekable}get seeking(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.seeking}_setX(t){if(super._setX(t),this._videoTexture&&h.isConch){var e=ji.getTransformRelativeToWindow(this,0,0);this._videoTexture.element.style.left=e.x}}_setY(t){if(super._setY(t),this._videoTexture&&h.isConch){var e=ji.getTransformRelativeToWindow(this,0,0);this._videoTexture.element.style.top=e.y}}set_width(t){if(super.set_width(t),this._videoTexture)if(h.isConch){var e=ji.getTransformRelativeToWindow(this,0,0);this._videoTexture.element.width=t*e.scaleX}else this._videoTexture.element.width=this.width/n.Browser.pixelRatio}set_height(t){if(super.set_height(t),this._videoTexture)if(h.isConch){var e=ji.getTransformRelativeToWindow(this,0,0);this._videoTexture.element.height=t*e.scaleY}else this._videoTexture.element.height=this.height/n.Browser.pixelRatio}destroy(t=!0){this.videoTexture=null,super.destroy(t)}}class Ws{get duration(){return this._duration}get animatorState(){return this._currentState}constructor(){this._currentState=null,this._frontPlay=!0}_resetPlayState(t,e){this._finish=!1,this._startPlayTime=t,this._elapsedTime=t,this._playEventIndex=0,this._lastIsFront=!0,this._playNum=0,this._playAllTime=0;var i=this._elapsedTime/e%1;this._normalizedPlayTime=i<0?i+1:i,this._frontPlay=!0}_cloneTo(t){t._finish=this._finish,t._startPlayTime=this._startPlayTime,t._elapsedTime=this._elapsedTime,t._playNum=this._playNum,t._normalizedPlayTime=this._normalizedPlayTime,t._playEventIndex=this._playEventIndex,t._lastIsFront=this._lastIsFront,t._frontPlay=this._frontPlay,t._playAllTime=this._playAllTime}}class Vs{constructor(t){this._referenceCount=0,this._playStateInfo=new Ws,this._crossPlayStateInfo=new Ws,this._crossMark=0,this._crossNodesOwnersCount=0,this._crossNodesOwnersIndicesMap={},this._srcCrossClipNodeIndices=[],this._destCrossClipNodeIndices=[],this.playOnWake=!0,this.defaultWeight=1,this.blendingMode=Vs.BLENDINGMODE_OVERRIDE,this.enable=!0,this._states=[],this._playType=-1,this.name=t}set states(t){if(this._states!==t){for(let t=this.states.length-1;t>=0;t--)this.removeState(this.states[t]);for(let e=t.length-1;e>=0;e--)this.addState(t[e])}}get states(){return this._states}set defaultStateName(t){if(this._defaultState=this.getStateByName(t),null==this._defaultState)if(0==this._states.length)this._defaultStateNameCatch=t;else for(var e=this._states.length-1;e>=0;e--)if(this._states[e].name==t){this._defaultState=this._states[e];break}}get defaultStateName(){return this._defaultState?this._defaultState.name:null}get defaultState(){return this._defaultState}set defaultState(t){this._defaultState=t}_removeClip(t,e,i){t.splice(e,1)}_getReferenceCount(){return this._referenceCount}_addReference(t){for(var e=0,i=this._states.length;e<i;e++)this._states[e]._addReference(t);this._referenceCount+=t}_removeReference(t=1){for(var e=0,i=this._states.length;e<i;e++)this._states[e]._removeReference(t);this._referenceCount-=t}_clearReference(){this._removeReference(-this._referenceCount)}getCurrentPlayState(){return this._playStateInfo}getStateByName(t){for(let e=this._states.length-1;e>=0;e--)if(this._states[e].name==t)return this._states[e];return null}addState(t){var e=t.name;if(this.getStateByName(e))throw"AnimatorControllerLayer:this stat's name has exist.";this._states.push(t),e==this._defaultStateNameCatch&&(this._defaultState=t,this._defaultStateNameCatch=null)}removeState(t){for(var e=this._states,i=-1,r=0,s=e.length;r<s;r++)if(e[r]===t){i=r;break}-1!=i&&this._removeClip(e,i,t)}clone(){var t=new Vs(this.name);return this.cloneTo(t),t}cloneTo(t){t.name=this.name}destroy(){this._removeReference();for(var t=0,e=this._states.length;t<e;t++)this._states[t].destroy();this._states.length=0}}var Xs,Hs,Ys,zs,js;Vs.BLENDINGMODE_OVERRIDE=0,Vs.BLENDINGMODE_ADDTIVE=1,t.AniParmType=void 0,(Xs=t.AniParmType||(t.AniParmType={}))[Xs.Float=0]="Float",Xs[Xs.Bool=1]="Bool",Xs[Xs.Trigger=2]="Trigger",t.AniStateConditionType=void 0,(Hs=t.AniStateConditionType||(t.AniStateConditionType={}))[Hs.Number=0]="Number",Hs[Hs.Bool=1]="Bool",Hs[Hs.Trigger=2]="Trigger",t.AniStateConditionNumberCompressType=void 0,(Ys=t.AniStateConditionNumberCompressType||(t.AniStateConditionNumberCompressType={}))[Ys.Less=0]="Less",Ys[Ys.Greater=1]="Greater";class Ks{static parse(t){let e=t,i=e.controllerLayers;null==i&&(i=[]);let r=[];for(let t=i.length-1;t>=0;t--){let s=i[t],a=s.states;a||(a=[],s.states=a),s.defaultStateName=null;let n=this.checkStates(a,r,e);n?s.defaultStateName=n.enterName:i.splice(t,1)}return{ret:e,clipsID:r}}static checkStates(t,e,i){let r=null,s=null;for(let a=t.length-1;a>=0;a--){let n=t[a];n.states?null==this.checkStates(n.states,e,i)?t.splice(a,1):(null==r&&(r=[]),r.push(n)):"-1"==n.id?s=n:"-2"==n.id||"-3"==n.id||(null==n.clip||null==n.clip._$uuid||""==n.clip._$uuid?t.splice(a,1):(0>e.indexOf(n.clip._$uuid)&&e.push(n.clip._$uuid),this.checkNext(n,t,i),null==r&&(r=[]),r.push(n)))}let a=null;if(r&&s){let t=this.checkDefault(s,r);null!=t&&(a={states:r,enterName:t})}return a}static checkNext(t,e,i){let r=t.soloTransitions;if(r)for(let t=r.length-1;t>=0;t--){let s=r[t],a=this.getStateByID(e,s.id);!a||null==a.clip&&"-3"!=a.id&&null==a.states?r.splice(t,1):(s.name=a.name,s.conditions=this.checkConditions(s.conditions,i))}}static checkConditions(e,i){if(!e||0==e.length||null==i.animatorParams||0==i.animatorParams.length)return[];let r=i.animatorParams;for(let i=e.length-1;i>=0;i--){let s=e[i],a=null;for(let t=r.length-1;t>=0;t--)if(r[t].id==s.id){a=r[t];break}if(null==a)e.splice(i,1);else if(s.name=a.name,a.type==t.AniParmType.Float){let t=Number(s.checkValue);isNaN(t)&&(s.checkValue=0),t=Number(s.type),isNaN(t)&&(s.type=0)}}return e}static checkDefault(t,e){let i=t.soloTransitions,r=null;i&&0<i.length&&(r=i[0].id);let s=null;if(null!=r&&(s=this.getStateByID(e,r)),null!=s&&(null!=s.clip||null!=s.states))return s.name;for(let t=e.length-1;t>=0;t--)if(e[t].clip)return e[t].name;return null}static getStateByID(t,e){if(t)for(let i=t.length-1;i>=0;i--)if(t[i].id==e)return t[i];return null}}t.AnimatorUpdateMode=void 0,(zs=t.AnimatorUpdateMode||(t.AnimatorUpdateMode={}))[zs.Normal=0]="Normal",zs[zs.LowFrame=1]="LowFrame",zs[zs.UnScaleTime=2]="UnScaleTime";class qs extends c{constructor(){super(),this._speed=1,this._updateMode=t.AnimatorUpdateMode.Normal,this._lowUpdateDelty=20,this._isPlaying=!0,this._controllerLayers=[],this._parameters={}}set controller(t){this._controller=t,t&&t.updateTo(this)}get controller(){return this._controller}set parameters(t){this._parameters=t}get parameters(){return this._parameters}set speed(t){this._speed=t}get speed(){return this._speed}get isPlaying(){return this._isPlaying}_updateStateFinish(t,e){e._finish&&t._eventExit()}_setClipDatasToNode(t,e,i,r,s=null){for(var a=t._realtimeDatas,n=t._clip._nodes,h=0,o=n.count;h<o;h++){var l=n.getNodeByIndex(h),_=this.getOwner(l);_&&this._applyFloat(_,e,i,r,a[h])}}_applyFloat(t,e,i,r,s){var a=t.pro;a&&a.ower&&(a.ower[a.key]=e&&"number"==typeof s?a.defVal+i*s:"number"==typeof s?i*s:s)}getOwner(t){var e;if(this._ownerMap&&(e=this._ownerMap.get(t)))return e;for(var i=this.owner,r=0,s=t.ownerPathCount;r<s;r++){var n=t.getOwnerPathByIndex(r);if(""!=n&&!(i=i.getChildByName(n)))break}if(e={ower:i},i){var h=i,o=t.propertyCount;if(1==o){var l=t.getPropertyByIndex(0);e.pro={ower:i,key:l,defVal:i[l]}}else for(var _=0;_<o;_++){l=t.getPropertyByIndex(_);if(_==o-1||null==h){e.pro={ower:h,key:l,defVal:h?h[l]:null};break}if(null==h[l]&&i==h){h=null;var u=a.getClass(l);u&&(h=i.getComponent(u))}else h=h[l]}}return null==this._ownerMap&&(this._ownerMap=new Map),this._ownerMap.set(t,e),e}_updateClipDatas(t,e,i){var r=t._clip,s=r._duration,a=t.clipStart*s+i._normalizedPlayTime*i._duration,n=t._currentFrameIndices;r._evaluateClipDatasRealTime(a,n,e,!0,t._realtimeDatas)}_updatePlayer(t,e,i,r,s){let a=!1;var n=t._clip._duration*(t.clipEnd-t.clipStart),h=e._elapsedTime;let o=e._playAllTime;e._playAllTime+=Math.abs(i),i=h+i,e._lastElapsedTime=h,e._elapsedTime=i;var l=i/n;let _=1;t.yoyo&&(_=2);let u=e._playAllTime/(n*_);Math.floor(o/(n*_))<Math.floor(u)&&(a=!0);var d=l%1;let c=d<0?d+1:d;if(e._normalizedPlayTime=c,e._duration=n,1!=_&&(c=(d=(l=e._playAllTime/(n*_))%1)<0?d+1:d,t.yoyo&&(.5>c?e._frontPlay||(0>t.speed?(e._elapsedTime=t.clipEnd,e._normalizedPlayTime=t.clipEnd):(e._elapsedTime=t.clipStart,e._normalizedPlayTime=t.clipStart),e._frontPlay=!0):e._frontPlay&&(e._frontPlay=!1,0>t.speed?(e._elapsedTime=t.clipStart,e._normalizedPlayTime=t.clipStart):(e._elapsedTime=t.clipEnd,e._normalizedPlayTime=t.clipEnd)))),t._eventStateUpdate(c),!this._applyTransition(s,t._eventtransition(c,this.parameters,a))&&a){let i=e._playAllTime/(n*_);if(0<r&&r<=i)return e._finish=!0,void(0>t.speed?t.yoyo?(e._elapsedTime=t.clipEnd,e._normalizedPlayTime=t.clipEnd):(e._elapsedTime=t.clipStart,e._normalizedPlayTime=t.clipStart):t.yoyo?(e._elapsedTime=t.clipStart,e._normalizedPlayTime=t.clipStart):(e._elapsedTime=t.clipEnd,e._normalizedPlayTime=t.clipEnd))}}_updateEventScript(t,e){let i=t._clip,r=i._animationEvents,s=i._duration,a=e._elapsedTime,n=a%s,h=Math.abs(Math.floor(a/s)-Math.floor(e._lastElapsedTime/s)),o=e._elapsedTime>=e._lastElapsedTime;e._lastIsFront!==o&&(o?e._playEventIndex++:e._playEventIndex--,e._lastIsFront=o);let l=e._playEventIndex;if(o){let t=this._eventScript(r,e._playEventIndex,h>0?s:n,!0);l===e._playEventIndex&&(e._playEventIndex=t);for(let t=0,e=h-1;t<e;t++)this._eventScript(r,0,s,!0);h>0&&n>0&&(e._playEventIndex=this._eventScript(r,0,n,!0))}else{let t=this._eventScript(r,e._playEventIndex,h>0?0:n,!1);l===e._playEventIndex&&(e._playEventIndex=t);let i=r.length-1;for(let t=0,e=h-1;t<e;t++)this._eventScript(r,i,0,!1);h>0&&n>0&&(e._playEventIndex=this._eventScript(r,i,n,!1))}}_eventScript(t,e,i,r){let s=this.owner.components;if(r)for(let r=t.length;e<r;e++){let r=t[e];if(!(r.time<=i))break;for(let t=0,e=s.length;t<e;t++){let e=s[t];if(e._isScript()){let t=e[r.eventName];t&&t.apply(e,r.params)}}}else for(;e>=0;e--){let r=t[e];if(!(r.time>=i))break;for(let t=0,e=s.length;t<e;t++){let e=s[t];if(e._isScript()){let t=e[r.eventName];t&&t.apply(e,r.params)}}}return e}_applyTransition(t,e){return!!e&&this.crossFade(e.destState.name,e.transduration,t,e.transstartoffset)}_applyUpdateMode(e){let i;switch(this._updateMode){case t.AnimatorUpdateMode.Normal:i=e;break;case t.AnimatorUpdateMode.LowFrame:i=Nt.loopCount%this._lowUpdateDelty==0?e*this._lowUpdateDelty:0;break;case t.AnimatorUpdateMode.UnScaleTime:i=0}return i}play(t,e=0,i=Number.NEGATIVE_INFINITY){this._isPlaying=!0;var r=this._controllerLayers[e];if(r){var s=r.defaultState;if(!t&&!s)throw new Error("Animator:must have default clip value,please set clip property.");var a=r._playStateInfo,n=a._currentState,h=t?r.getStateByName(t):s;if(!h._clip)return;var o=h._clip._duration,l=h._clip._duration*(h.clipEnd-h.clipStart);n!==h?(i!==Number.NEGATIVE_INFINITY?a._resetPlayState(o*i,l):a._resetPlayState(0,l),r._playType=0,a._currentState=h):i!==Number.NEGATIVE_INFINITY&&(a._resetPlayState(o*i,l),r._playType=0),h._eventStart()}var _=h._scripts;if(_)for(var u=0,d=_.length;u<d;u++)_[u].onStateEnter()}stop(){this._isPlaying=!1}onUpdate(){if(this._isPlaying){var t=this.owner.timer._delta/1e3;if(t=this._applyUpdateMode(t),0!=this.speed&&0!=t)for(var e=0,i=this._controllerLayers.length;e<i;e++){var r=this._controllerLayers[e];if(r.enable){var s=r._playStateInfo,a=r.blendingMode!=Vs.BLENDINGMODE_OVERRIDE;if(0===r._playType){var n=s._currentState,h=this._speed*n.speed,o=s._finish,l=n.loop;-1>=l&&(l=n._clip.islooping?0:1);let i=1;s._frontPlay||(i=-1),o||this._updatePlayer(n,s,t*h*i,l,e),this._updateClipDatas(n,a,s),o||this._setClipDatasToNode(n,a,r.defaultWeight,0==e,r),o||this._updateEventScript(n,s),o||this._updateStateFinish(n,s)}}}}}addControllerLayer(t){this._controllerLayers.push(t)}crossFade(t,e,i=0,r=Number.NEGATIVE_INFINITY){var s=this._controllerLayers[i];if(s){if(s.getStateByName(t))return this.play(t,i,r),!0;console.warn("Invalid layerIndex "+i+".")}return!1}onAfterDeserialize(){let t=this.controllerLayers;if(t&&null==this.controller){delete this.controllerLayers,this._controllerLayers.length=0;for(let e of t)this.addControllerLayer(e)}}onEnable(){if(this._isPlaying)for(var t=0,e=this._controllerLayers.length;t<e;t++){if(this._controllerLayers[t].playOnWake)this.getDefaultState(t)&&this.play(null,t)}}getDefaultState(t=0){return this._controllerLayers[t].defaultState}setParamsTrigger(e){this._parameters[e]={name:e,type:t.AniParmType.Trigger,value:!0}}setParamsNumber(e,i){this._parameters[e]={name:e,type:t.AniParmType.Float,value:i}}setParamsBool(e,i){this._parameters[e]={name:e,type:t.AniParmType.Float,value:i}}getParamsvalue(t){let e=this._parameters[t];return e?e.value:null}onDestroy(){for(var t=0,e=this._controllerLayers.length;t<e;t++)this._controllerLayers[t].destroy();this._controllerLayers.length=0,this._isPlaying=!1,this._parameters=null}}class $s extends R{constructor(){super(...arguments),this._referenceCount=0,this._clip=null,this._currentFrameIndices=null,this.speed=1,this.clipStart=0,this.clipEnd=1,this.loop=-1,this.yoyo=!1,this.transitions=[],this.soloTransitions=[],this._scripts=null,this._realtimeDatas=[]}get clip(){return this._clip}set clip(t){if(this._clip!=t){if(this._clip&&this._referenceCount>0&&this._clip._removeReference(this._referenceCount),t){var e=t._nodes.count;this._currentFrameIndices=new Int16Array(e),this._resetFrameIndices(),this._referenceCount>0&&t._addReference(this._referenceCount),this._realtimeDatas.length=e}this._clip=t}}_eventStateUpdate(t){if(this.event($s.EVENT_OnStateUpdate,t),this._scripts)for(var e=0,i=this._scripts.length;e<i;e++)this._scripts[e].onStateUpdate(t)}_eventStart(){if(this.event($s.EVENT_OnStateEnter),this._scripts)for(var t=0,e=this._scripts.length;t<e;t++)this._scripts[t].onStateEnter()}_eventExit(){if(this.event($s.EVENT_OnStateExit),this._scripts)for(let t=0,e=this._scripts.length;t<e;t++)this._scripts[t].onStateExit()}_eventtransition(t,e,i){let r=this.soloTransitions.length;if(r>0){for(var s=0;s<r;s++)if(this.soloTransitions[s].check(t,e,i))return this.soloTransitions[s];return null}let a=this.transitions.length;for(s=0;s<a;s++)if(this.transitions[s].check(t,e,i))return this.transitions[s];return null}_resetFrameIndices(){for(var t=0,e=this._currentFrameIndices.length;t<e;t++)this._currentFrameIndices[t]=-1}_getReferenceCount(){return this._referenceCount}_addReference(t){this._clip&&this._clip._addReference(t),this._referenceCount+=t}_removeReference(t){this._clip&&this._clip._removeReference(t),this._referenceCount-=t}_clearReference(){this._removeReference(-this._referenceCount)}addScript(t){var e=new t;return this._scripts=this._scripts||[],this._scripts.push(e),e}getScript(t){if(this._scripts)for(var e=0,i=this._scripts.length;e<i;e++){var r=this._scripts[e];if(r instanceof t)return r}return null}getScripts(t){var e=null;if(this._scripts)for(var i=0,r=this._scripts.length;i<r;i++){var s=this._scripts[i];s instanceof t&&(e=e||[]).push(s)}return e}clone(){var t=new $s;return this.cloneTo(t),t}cloneTo(t){var e=t;e.name=this.name,e.speed=this.speed,e.clip=this._clip}destroy(){this._clip=null,this._currentFrameIndices=null,this._scripts=null,this._realtimeDatas.length=0}}$s.EVENT_OnStateEnter="OnStartEnter",$s.EVENT_OnStateUpdate="OnStateUpdate",$s.EVENT_OnStateExit="OnStateExit";class Zs{constructor(){this._ownerPath=[],this._propertys=[],this._keyFrames=[]}get keyFramesCount(){return this._keyFrames.length}_setOwnerPathCount(t){this._ownerPath.length=t}_setOwnerPathByIndex(t,e){this._ownerPath[t]=e}_setPropertyCount(t){this._propertys.length=t}_setPropertyByIndex(t,e){this._propertys[t]=e}_setKeyframeCount(t){this._keyFrames.length=t}_joinOwnerPath(t){return this._ownerPath.join(t)}_joinProperty(t){return this._propertys.join(t)}getKeyframeByIndex(t){return this._keyFrames[t]}get ownerPathCount(){return this._ownerPath.length}get propertyCount(){return this._propertys.length}getOwnerPathByIndex(t){return this._ownerPath[t]}getPropertyByIndex(t){return this._propertys[t]}}class Qs{clone(){var t=new Qs;return this.cloneTo(t),t}cloneTo(t){t.time=this.time}}Qs.defaultWeight=.33333;class Js{constructor(){}}class ta{static READ_DATA(){this._DATA.offset=this._reader.getUint32(),this._DATA.size=this._reader.getUint32()}static READ_BLOCK(){for(var t=this._BLOCK.count=this._reader.getUint16(),e=this._BLOCK.blockStarts=[],i=this._BLOCK.blockLengths=[],r=0;r<t;r++)e.push(this._reader.getUint32()),i.push(this._reader.getUint32())}static READ_STRINGS(){var t=this._reader.getUint32(),e=this._reader.getUint16(),i=this._reader.pos;this._reader.pos=t+this._DATA.offset;for(var r=0;r<e;r++)this._strings[r]=this._reader.readUTFString();this._reader.pos=i}static parse(t,e,i){this._clip=t,this._reader=e,this._version=i,this.READ_DATA(),this.READ_BLOCK(),this.READ_STRINGS();for(var r=0,s=this._BLOCK.count;r<s;r++){var a=e.getUint16(),n=this._strings[a],h=this["READ_"+n];if(!h)throw new Error("model file err,no this function:"+a+" "+n);h.call(this)}this._version=null,this._reader=null,this._clip=null,this._strings.length=0}static timeToFrame(t,e){return Math.round(t*e)}static READ_ANIMATIONS2D(){var t,e,i,r=this._reader,s=this._clip,a=[],n=r.getUint16();for(a.length=n,t=0;t<n;t++)a[t]=r.getFloat32();s._duration=a[r.getInt16()],s.islooping=!!r.getByte(),s._frameRate=r.getInt16();var h=r.getInt16(),o=s._nodes;o.count=h;var l=s._nodesMap={},_=s._nodesDic={};for(t=0;t<h;t++){i=new Zs,o.setNodeByIndex(t,i),i._indexInList=t;var u=r.getUint16();for(i._setOwnerPathCount(u),e=0;e<u;e++)i._setOwnerPathByIndex(e,this._strings[r.getUint16()]);var d=i._joinOwnerPath("/"),c=l[d];c||(l[d]=c=[]),c.push(i);var p=r.getUint16();for(i._setPropertyCount(p),e=0;e<p;e++)i._setPropertyByIndex(e,this._strings[r.getUint16()]);var f=d+"."+i._joinProperty(".");_[f]=i,i.fullPath=f,i.nodePath=d;var m=r.getUint16();for(e=0;e<m;e++){var g=new Qs;g.time=a[r.getUint16()],g.data={f:this.timeToFrame(g.time,s._frameRate),val:0},1==r.getByte()&&(g.data.tweenType=this._strings[r.getUint16()]),1==r.getByte()&&(g.data.tweenInfo={},g.data.tweenInfo.inTangent=a[r.getUint16()],g.data.tweenInfo.outTangent=a[r.getUint16()],1==r.getByte()&&(g.data.tweenInfo.inWeight=a[r.getUint16()]),1==r.getByte()&&(g.data.tweenInfo.outWeight=a[r.getUint16()]));var T=r.getByte();if(0==T?g.data.val=a[r.getUint16()]:1==T?g.data.val=this._strings[r.getUint16()]:2==T&&(g.data.val=!!r.getByte()),1==r.getByte())try{g.data.extend=JSON.parse(this._strings[r.getUint16()])}catch(t){}i._keyFrames.push(g)}}var x=r.getUint16();for(t=0;t<x;t++){var E=new Js;E.time=a[r.getUint16()],E.eventName=this._strings[r.getUint16()];var y=[],v=r.getUint16();for(v>0&&(E.params=y=[]),e=0;e<v;e++){switch(r.getByte()){case 0:y.push(!!r.getByte());break;case 1:y.push(r.getInt32());break;case 2:y.push(a[r.getUint16()]);break;case 3:y.push(this._strings[r.getUint16()]);break;default:throw new Error("unknown type.")}}s.addEvent(E)}}}ta._strings=[],ta._DATA={offset:0,size:0},ta._BLOCK={count:0};class ea{constructor(){this._nodes=[]}get count(){return this._nodes.length}set count(t){this._nodes.length=t}getNodeByIndex(t){return this._nodes[t]}setNodeByIndex(t,e){this._nodes[t]=e}}class ia extends M{static _parse(t){var e=new ia,i=new I(t),r=i.readUTFString();if("LAYAANIMATION2D:01"!==r)throw"unknown animationClip version.";return ta.parse(e,i,r),e}constructor(){super(),this._nodes=new ea,this._animationEvents=[]}duration(){return this._duration}_evaluateClipDatasRealTime(t,e,i,r,s){for(var a=this._nodes,n=0,h=a.count;n<h;n++){var o,l=a.getNodeByIndex(n)._keyFrames,_=l.length,u=e[n];if(r)for(-1!=u&&t<l[u].time&&(u=-1,e[n]=u),o=u+1;o<_&&!(l[o].time>t);)u++,o++,e[n]=u;else for((o=u+1)!=_&&t>l[o].time&&(u=_-1,e[n]=u),o=u+1;u>-1&&!(l[u].time<t);)u--,o--,e[n]=u;var d=o==_;if(-1!=u){var c=l[u];if(d)s[n]=c.data.val;else{var p,f=l[o],m=f.time-c.time;p=0!==m?(t-c.time)/m:0,s[n]=this._getTweenVal(c,f,p,m)}}else s[n]=l[0].data.val;i&&"number"==typeof l[0].data.val&&(s[n]=s[n]-l[0].data.val)}}_getTweenVal(t,e,i,r){var s=t.data,a=e.data;if("number"!=typeof s.val||"number"!=typeof a.val)return s.val;var n=ia.tween[s.tweenType],h=s.val,o=a.val;if(null!=n)return n(i,h,o-h,1);var l=0,_=0,u=NaN,d=NaN;return null!=s.tweenInfo&&(l=s.tweenInfo.outTangent,u=s.tweenInfo.outWeight),null!=a.tweenInfo&&(_=a.tweenInfo.inTangent,d=a.tweenInfo.inWeight),(isNaN(u)||0>=u)&&(u=Qs.defaultWeight),(isNaN(d)||0>=d)&&(d=Qs.defaultWeight),isNaN(l)&&(l=0),isNaN(_)&&(_=0),Math.abs(l)==Number.MAX_VALUE&&(l=0>l?-1/0:1/0),Math.abs(_)==Number.MAX_VALUE&&(_=0>_?-1/0:1/0),!s.tweenInfo&&!a.tweenInfo||Qs.defaultWeight==d&&Qs.defaultWeight==u?ia.tween.hermiteInterpolate(l,_,h,o,i,r):this.hermiteCurveSplineWeight(h,t.time,u,l,o,e.time,d,_,i)}_binarySearchEventIndex(t){for(var e,i=0,r=this._animationEvents.length-1;i<=r;){e=i+r>>1;var s=this._animationEvents[e].time;if(s==t)return e;s>t?r=e-1:i=e+1}return i}hermiteCurveSplineWeight(t,e,i,r,s,a,n,h,o){let l=222e-18,_=o,u=t,d=i,c=n,p=a-e,f=s-u;f=Math.max(Math.abs(f),l)*(f<0?-1:1);let m=r,g=h;if(!Number.isFinite(m)||!Number.isFinite(g))return t;m=m*p/f,g=g*p/f;let T=1-c,x=.5,E=0;if(Math.abs(d-.33333334)<1e-4&&Math.abs(c-.33333334)<1e-4)x=_,E=1-x;else for(;;){E=1-x;let t=3*E*E*x*d+3*E*x*x*T+x*x*x-_;if(Math.abs(t)<=2.5*l)break;let e=3*E*E*d+6*E*x*(T-d)+3*x*x*(1-T),i=6*E*(T-2*d)+6*x*(1-2*T+d);x-=(6*t*e*e-3*t*t*i)/(6*e*e*e-6*t*e*i+t*t*(18*d-18*T+6))}return(3*E*E*x*d*m+3*E*x*x*(1-c*g)+x*x*x)*f+u}addEvent(t){var e=this._binarySearchEventIndex(t.time);this._animationEvents.splice(e,0,t)}}ia.tween={Linear:function(t,e,i,r){return i*t/r+e},Quad_EaseIn:function(t,e,i,r){return i*(t/=r)*t+e},Quad_EaseOut:function(t,e,i,r){return-i*(t/=r)*(t-2)+e},Quad_EaseInOut:function(t,e,i,r){return(t/=r/2)<1?i/2*t*t+e:-i/2*(--t*(t-2)-1)+e},Cubic_EaseIn:function(t,e,i,r){return i*(t/=r)*t*t+e},Cubic_EaseOut:function(t,e,i,r){return i*((t=t/r-1)*t*t+1)+e},Cubic_EaseInOut:function(t,e,i,r){return(t/=r/2)<1?i/2*t*t*t+e:i/2*((t-=2)*t*t+2)+e},Quart_EaseIn:function(t,e,i,r){return i*(t/=r)*t*t*t+e},Quart_EaseOut:function(t,e,i,r){return-i*((t=t/r-1)*t*t*t-1)+e},Quart_EaseInOut:function(t,e,i,r){return(t/=r/2)<1?i/2*t*t*t*t+e:-i/2*((t-=2)*t*t*t-2)+e},Quint_EaseIn:function(t,e,i,r){return i*(t/=r)*t*t*t*t+e},Quint_EaseOut:function(t,e,i,r){return i*((t=t/r-1)*t*t*t*t+1)+e},Quint_EaseInOut:function(t,e,i,r){return(t/=r/2)<1?i/2*t*t*t*t*t+e:i/2*((t-=2)*t*t*t*t+2)+e},Sine_EaseIn:function(t,e,i,r){return-i*Math.cos(t/r*(Math.PI/2))+i+e},Sine_EaseOut:function(t,e,i,r){return i*Math.sin(t/r*(Math.PI/2))+e},Sine_EaseInOut:function(t,e,i,r){return-i/2*(Math.cos(Math.PI*t/r)-1)+e},Expo_EaseIn:function(t,e,i,r){return 0==t?e:i*Math.pow(2,10*(t/r-1))+e},Expo_EaseOut:function(t,e,i,r){return t==r?e+i:i*(1-Math.pow(2,-10*t/r))+e},Expo_EaseInOut:function(t,e,i,r){return 0==t?e:t==r?e+i:(t/=r/2)<1?i/2*Math.pow(2,10*(t-1))+e:i/2*(2-Math.pow(2,-10*--t))+e},Circ_EaseIn:function(t,e,i,r){return-i*(Math.sqrt(1-(t/=r)*t)-1)+e},Circ_EaseOut:function(t,e,i,r){return i*Math.sqrt(1-(t=t/r-1)*t)+e},Circ_EaseInOut:function(t,e,i,r){return(t/=r/2)<1?-i/2*(Math.sqrt(1-t*t)-1)+e:i/2*(Math.sqrt(1-(t-=2)*t)+1)+e},Elastic_EaseIn:function(t,e,i,r,s,a){if(0==t)return e;if(1==(t/=r))return e+i;if(a||(a=.3*r),!s||s<Math.abs(i)){s=i;var n=a/4}else n=a/(2*Math.PI)*Math.asin(i/s);return-s*Math.pow(2,10*(t-=1))*Math.sin((t*r-n)*(2*Math.PI)/a)+e},Elastic_EaseOut:function(t,e,i,r,s,a){if(0==t)return e;if(1==(t/=r))return e+i;if(a||(a=.3*r),!s||s<Math.abs(i)){s=i;var n=a/4}else n=a/(2*Math.PI)*Math.asin(i/s);return s*Math.pow(2,-10*t)*Math.sin((t*r-n)*(2*Math.PI)/a)+i+e},Elastic_EaseInOut:function(t,e,i,r,s,a){if(0==t)return e;if(2==(t/=r/2))return e+i;if(a||(a=r*(.3*1.5)),!s||s<Math.abs(i)){s=i;var n=a/4}else n=a/(2*Math.PI)*Math.asin(i/s);return t<1?s*Math.pow(2,10*(t-=1))*Math.sin((t*r-n)*(2*Math.PI)/a)*-.5+e:s*Math.pow(2,-10*(t-=1))*Math.sin((t*r-n)*(2*Math.PI)/a)*.5+i+e},Back_EaseIn:function(t,e,i,r,s){return null==s&&(s=1.70158),i*(t/=r)*t*((s+1)*t-s)+e},Back_EaseOut:function(t,e,i,r,s){return null==s&&(s=1.70158),i*((t=t/r-1)*t*((s+1)*t+s)+1)+e},Back_EaseInOut:function(t,e,i,r,s){return null==s&&(s=1.70158),(t/=r/2)<1?i/2*(t*t*((1+(s*=1.525))*t-s))+e:i/2*((t-=2)*t*((1+(s*=1.525))*t+s)+2)+e},Bounce_EaseIn:function(t,e,i,r){return i-ia.tween.Bounce_EaseOut(r-t,0,i,r)+e},Bounce_EaseOut:function(t,e,i,r){return(t/=r)<1/2.75?i*(7.5625*t*t)+e:t<2/2.75?i*(7.5625*(t-=1.5/2.75)*t+.75)+e:t<2.5/2.75?i*(7.5625*(t-=2.25/2.75)*t+.9375)+e:i*(7.5625*(t-=2.625/2.75)*t+.984375)+e},Bounce_EaseInOut:function(t,e,i,r){return t<r/2?.5*ia.tween.Bounce_EaseIn(2*t,0,i,r)+e:.5*ia.tween.Bounce_EaseOut(2*t-r,0,i,r)+.5*i+e},hermiteInterpolate:function(t,e,i,r,s,a){if(Math.abs(t)==1/0||Math.abs(e)==1/0)return i;var n=s*s,h=n*s;return(2*h-3*n+1)*i+(h-2*n+s)*t*a+(h-n)*e*a+(-2*h+3*n)*r}};class ra{}t.AniConditionType=void 0,(js=t.AniConditionType||(t.AniConditionType={}))[js.Greater=0]="Greater",js[js.Less=1]="Less",js[js.Equals=2]="Equals",js[js.NotEqual=3]="NotEqual";class sa{}class aa{static conditionNameToID(t){if(null!=aa._conditionNameMap[t])return aa._conditionNameMap[t];var e=this._propertyNameCounter++;return this._conditionNameMap[t]=e,this._conditionNameMap[e]=t,e}static conditionIDToName(t){return this._conditionNameMap[t]}constructor(t=null){t&&(this._id=aa.conditionNameToID(t),this._name=t)}get id(){return this._id}get name(){return this._name}set name(t){this._id=aa.conditionNameToID(t),this._name=t}get type(){return this._type}checkState(t){return!1}}aa._conditionNameMap={},aa._propertyNameCounter=0;class na extends aa{constructor(e){super(e),this._numberValue=0,this._numberCompareFlag=t.AniStateConditionNumberCompressType.Greater,this._type=t.AniStateConditionType.Number}get numberValue(){return this._numberValue}set numberValue(t){this._numberValue=t}get compareFlag(){return this._numberCompareFlag}set compareFlag(t){this._numberCompareFlag=t}checkState(e){return t.AniStateConditionNumberCompressType.Greater==this._numberCompareFlag?e>this._numberValue:e<this._numberValue}}class ha extends aa{constructor(e){super(e),this._compareFlag=!0,this._type=t.AniStateConditionType.Bool}get compareFlag(){return this._compareFlag}set compareFlag(t){this._compareFlag=t}checkState(t){return this._compareFlag==t}}class oa extends aa{constructor(e){super(e),this._type=t.AniStateConditionType.Trigger}checkState(t){return t}}class la{constructor(){this.conditions=[],this.exitByTime=!0,this.exitTime=1,this.transduration=0,this.transstartoffset=0,this.mute=!1}addCondition(t){-1==this.conditions.indexOf(t)&&this.conditions.push(t)}removeCondition(t){let e=this.conditions.indexOf(t);-1!=e&&this.conditions.splice(e,0)}check(e,i,r){if(this.mute)return!1;if(this.exitByTime&&e<this.exitTime&&!r)return!1;if(null==this.conditions||0==this.conditions.length)return!0;for(var s=0;s<this.conditions.length;s++){let e=this.conditions[s];if(e.checkState(i[e.name].value))return e.type==t.AniStateConditionType.Trigger&&(i[e.name].value=!1),!0}return!1}}class _a extends M{constructor(t){super();let e=Ks.parse(t);this.data=e.ret,this.clipsID=e.clipsID}getLayers(){let t=this.data.controllerLayers,e=[];for(let i=t.length-1;i>=0;i--){let r=t[i],s=new Vs(r.name);e.unshift(s);for(let t in r)if("name"!=t&&"states"!=t&&null!=r[t])try{s[t]=r[t]}catch(t){}this.getState(r.states,s,this.data)}return e}createState(t,e,i){if(!t)return null;let r={},s=null;for(let n=t.length-1;n>=0;n--){let h=t[n],o=h.states;if(o){let t=this.createState(o,e,i);t&&(e[h.id]=t.states[t.id]);continue}if(0>Number(h.id)){if("-1"==h.id){let t=h.soloTransitions;t&&0<t.length&&(s=t[0].id)}continue}let l=new $s;e[h.id]=l,r[h.id]=l;for(let t in h)try{if("scripts"==t){let e=h[t];if(e&&Array.isArray(e))for(let t=e.length-1;t>=0;t--){let i=e[t],r=a.getClass(i);r&&l.addScript(r)}continue}if("soloTransitions"==t)continue;null!=h[t]&&(l[t]=h[t])}catch(t){}i.addState(l)}return{id:s,states:r}}getState(t,e,i){if(t){let r={};this.createState(t,r,e),this.setTransitions(t,r,e,i)}}setExitTransition(t,e,i,r,s){for(let a in t){let n=i[a];if(n){let h=n.transitions,o=n.soloTransitions,l=t[a];for(let t=e.length-1;t>=0;t--){let n=e[t];if("-3"!=n.id)for(let t=l.length-1;t>=0;t--){let e=l[t],s=new la;s.destState=i[n.id],n.conditions&&this.addConditions(n.conditions,s,r),e.conditions&&this.addConditions(e.conditions,s,r);for(let t in n)"solo"!=t&&"id"!=t&&"conditions"!=t&&(s[t]=n[t]);n.solo?o.unshift(s):h.unshift(s)}else null==s[a]&&(s[a]=[]),s[a].push(n)}}}}setTransitions(t,e,i,r,s){if(!t)return null;let a={};for(let s=t.length-1;s>=0;s--){let n=t[s];if(n.states){let t=this.setTransitions(n.states,e,i,r,n);if(t){let i=n.soloTransitions;i&&this.setExitTransition(t,i,e,r,a)}}}for(let n=t.length-1;n>=0;n--){let h=t[n];if(h.states)continue;if("-1"==h.id){if(h.soloTransitions&&0<h.soloTransitions.length){null==s?i.defaultState=e[h.soloTransitions[0].id]:e[s.id]=e[h.soloTransitions[0].id];continue}}else{if("-2"==h.id){let t=h.soloTransitions;if(t)for(let i=t.length-1;i>=0;i--){let s=t[i],a=e[s.id];if(a)for(let t in e){let i=e[t],n=new la;n.destState=a,s.conditions&&this.addConditions(s.conditions,n,r);for(let t in s)"solo"!=t&&"id"!=t&&"conditions"!=t&&(n[t]=s[t]);s.solo?i.soloTransitions.unshift(n):i.transitions.unshift(n)}}continue}if("-3"==h.id)continue}let o=h.soloTransitions;if(o&&e[h.id]){let t=e[h.id].transitions,i=e[h.id].soloTransitions;for(let s=o.length-1;s>=0;s--){let n=o[s];if("-3"==n.id){null==a[h.id]&&(a[h.id]=[]),a[h.id].push(n);continue}let l=new la;e[n.id]&&(l.destState=e[n.id]),n.conditions&&this.addConditions(n.conditions,l,r);for(let t in n)"solo"!=t&&"id"!=t&&"conditions"!=t&&(l[t]=n[t]);n.solo?i.unshift(l):t.unshift(l)}}}return a}addConditions(e,i,r){let s=r.animatorParams;if(null!=s&&0!=s.length)for(let r=0,a=e.length;r<a;r++){let a,n=e[r],h=null;for(let t=s.length-1;t>=0;t--)if(s[t].id==n.id){h=s[t];break}if(null==h)return;if(h.type==t.AniParmType.Bool){let t=new ha(n.name);t.compareFlag=Boolean(n.checkValue),a=t}else if(h.type==t.AniParmType.Float){let t=new na(n.name);t.numberValue=Number(n.checkValue),t.compareFlag=n.type,a=t}else if(h.type==t.AniParmType.Trigger){a=new oa(n.name)}i.addCondition(a)}}updateTo(t){let e=t._controllerLayers;for(let t=0,i=e.length;t<i;t++)e[t].destroy();e.length=0;let i=this.getLayers();for(let e=0,r=i.length;e<r;e++)t.addControllerLayer(i[e]);let r=this.data.animatorParams;if(r){let e={};for(let t=r.length-1;t>=0;t--){let i=r[t],s=new ra;s.name=i.name,s.type=i.type,s.value=i.val,e[i.name]=s}t.parameters=e}}}const ua=new Ke,da=new Ke,ca=new Ke,pa=new Ke,fa=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);class ma{static createRotationX(t,e){var i=e.elements,r=Math.sin(t),s=Math.cos(t);i[1]=i[2]=i[3]=i[4]=i[7]=i[8]=i[11]=i[12]=i[13]=i[14]=0,i[0]=i[15]=1,i[5]=i[10]=s,i[6]=r,i[9]=-r}static createRotationY(t,e){var i=e.elements,r=Math.sin(t),s=Math.cos(t);i[1]=i[3]=i[4]=i[6]=i[7]=i[9]=i[11]=i[12]=i[13]=i[14]=0,i[5]=i[15]=1,i[0]=i[10]=s,i[2]=-r,i[8]=r}static createRotationZ(t,e){var i=e.elements,r=Math.sin(t),s=Math.cos(t);i[2]=i[3]=i[6]=i[7]=i[8]=i[9]=i[11]=i[12]=i[13]=i[14]=0,i[10]=i[15]=1,i[0]=i[5]=s,i[1]=r,i[4]=-r}static createRotationYawPitchRoll(t,e,i,r){wa.createFromYawPitchRoll(t,e,i,wa.TEMP),ma.createRotationQuaternion(wa.TEMP,r)}static createRotationAxis(t,e,i){var r=t.x,s=t.y,a=t.z,n=Math.cos(e),h=Math.sin(e),o=r*r,l=s*s,_=a*a,u=r*s,d=r*a,c=s*a,p=i.elements;p[3]=p[7]=p[11]=p[12]=p[13]=p[14]=0,p[15]=1,p[0]=o+n*(1-o),p[1]=u-n*u+h*a,p[2]=d-n*d-h*s,p[4]=u-n*u-h*a,p[5]=l+n*(1-l),p[6]=c-n*c+h*r,p[8]=d-n*d+h*s,p[9]=c-n*c-h*r,p[10]=_+n*(1-_)}static createRotationQuaternion(t,e){var i=e.elements,r=t.x,s=t.y,a=t.z,n=t.w,h=r*r,o=s*s,l=a*a,_=r*s,u=a*n,d=a*r,c=s*n,p=s*a,f=r*n;i[3]=i[7]=i[11]=i[12]=i[13]=i[14]=0,i[15]=1,i[0]=1-2*(o+l),i[1]=2*(_+u),i[2]=2*(d-c),i[4]=2*(_-u),i[5]=1-2*(l+h),i[6]=2*(p+f),i[8]=2*(d+c),i[9]=2*(p-f),i[10]=1-2*(o+h)}static createTranslate(t,e){var i=e.elements;i[4]=i[8]=i[1]=i[9]=i[2]=i[6]=i[3]=i[7]=i[11]=0,i[0]=i[5]=i[10]=i[15]=1,i[12]=t.x,i[13]=t.y,i[14]=t.z}static createScaling(t,e){var i=e.elements;i[0]=t.x,i[5]=t.y,i[10]=t.z,i[1]=i[4]=i[8]=i[12]=i[9]=i[13]=i[2]=i[6]=i[14]=i[3]=i[7]=i[11]=0,i[15]=1}static multiply(t,e,i){var r=e.elements,s=t.elements,a=i.elements,n=r[0],h=r[1],o=r[2],l=r[3],_=r[4],u=r[5],d=r[6],c=r[7],p=r[8],f=r[9],m=r[10],g=r[11],T=r[12],x=r[13],E=r[14],y=r[15],v=s[0],S=s[1],R=s[2],b=s[3],C=s[4],A=s[5],w=s[6],M=s[7],D=s[8],I=s[9],P=s[10],B=s[11],L=s[12],F=s[13],O=s[14],N=s[15];a[0]=n*v+h*C+o*D+l*L,a[1]=n*S+h*A+o*I+l*F,a[2]=n*R+h*w+o*P+l*O,a[3]=n*b+h*M+o*B+l*N,a[4]=_*v+u*C+d*D+c*L,a[5]=_*S+u*A+d*I+c*F,a[6]=_*R+u*w+d*P+c*O,a[7]=_*b+u*M+d*B+c*N,a[8]=p*v+f*C+m*D+g*L,a[9]=p*S+f*A+m*I+g*F,a[10]=p*R+f*w+m*P+g*O,a[11]=p*b+f*M+m*B+g*N,a[12]=T*v+x*C+E*D+y*L,a[13]=T*S+x*A+E*I+y*F,a[14]=T*R+x*w+E*P+y*O,a[15]=T*b+x*M+E*B+y*N}static createFromQuaternion(t,e){var i=e.elements,r=t.x,s=t.y,a=t.z,n=t.w,h=r+r,o=s+s,l=a+a,_=r*h,u=s*h,d=s*o,c=a*h,p=a*o,f=a*l,m=n*h,g=n*o,T=n*l;i[0]=1-d-f,i[1]=u+T,i[2]=c-g,i[3]=0,i[4]=u-T,i[5]=1-_-f,i[6]=p+m,i[7]=0,i[8]=c+g,i[9]=p-m,i[10]=1-_-d,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1}static createAffineTransformation(t,e,i,r){var s=r.elements,a=e.x,n=e.y,h=e.z,o=e.w,l=a+a,_=n+n,u=h+h,d=a*l,c=a*_,p=a*u,f=n*_,m=n*u,g=h*u,T=o*l,x=o*_,E=o*u,y=i.x,v=i.y,S=i.z;s[0]=(1-(f+g))*y,s[1]=(c+E)*y,s[2]=(p-x)*y,s[3]=0,s[4]=(c-E)*v,s[5]=(1-(d+g))*v,s[6]=(m+T)*v,s[7]=0,s[8]=(p+x)*S,s[9]=(m-T)*S,s[10]=(1-(d+f))*S,s[11]=0,s[12]=t.x,s[13]=t.y,s[14]=t.z,s[15]=1}static createLookAt(t,e,i,r){var s=r.elements,a=ua,n=da,h=ca;Ke.subtract(t,e,h),Ke.normalize(h,h),Ke.cross(i,h,a),Ke.normalize(a,a),Ke.cross(h,a,n),s[3]=s[7]=s[11]=0,s[15]=1,s[0]=a.x,s[4]=a.y,s[8]=a.z,s[1]=n.x,s[5]=n.y,s[9]=n.z,s[2]=h.x,s[6]=h.y,s[10]=h.z,s[12]=-Ke.dot(a,t),s[13]=-Ke.dot(n,t),s[14]=-Ke.dot(h,t)}static createPerspective(t,e,i,r,s){var a=1/Math.tan(.5*t),n=i/(a/e),h=i/a;ma.createPerspectiveOffCenter(-n,n,-h,h,i,r,s)}static createPerspectiveOffCenter(t,e,i,r,s,a,n){var h=n.elements,o=a/(a-s);h[1]=h[2]=h[3]=h[4]=h[6]=h[7]=h[12]=h[13]=h[15]=0,h[0]=2*s/(e-t),h[5]=2*s/(r-i),h[8]=(t+e)/(e-t),h[9]=(r+i)/(r-i),h[10]=-o,h[11]=-1,h[14]=-s*o}static createOrthoOffCenter(t,e,i,r,s,a,n){var h=n.elements,o=1/(a-s);h[1]=h[2]=h[3]=h[4]=h[6]=h[8]=h[7]=h[9]=h[11]=0,h[15]=1,h[0]=2/(e-t),h[5]=2/(r-i),h[10]=-o,h[12]=(t+e)/(t-e),h[13]=(r+i)/(i-r),h[14]=-s*o}constructor(t=1,e=0,i=0,r=0,s=0,a=1,n=0,h=0,o=0,l=0,_=1,u=0,d=0,c=0,p=0,f=1,m=null){if(0!=arguments.length){if(1!==arguments.length||null!==arguments[0]){var g=this.elements=m||new Float32Array(16);g[0]=t,g[1]=e,g[2]=i,g[3]=r,g[4]=s,g[5]=a,g[6]=n,g[7]=h,g[8]=o,g[9]=l,g[10]=_,g[11]=u,g[12]=d,g[13]=c,g[14]=p,g[15]=f}}else this.elements=fa.slice()}getElementByRowColumn(t,e){if(t<0||t>3)throw new Error("row Rows and columns for matrices run from 0 to 3, inclusive.");if(e<0||e>3)throw new Error("column Rows and columns for matrices run from 0 to 3, inclusive.");return this.elements[4*t+e]}setElementByRowColumn(t,e,i){if(t<0||t>3)throw new Error("row Rows and columns for matrices run from 0 to 3, inclusive.");if(e<0||e>3)throw new Error("column Rows and columns for matrices run from 0 to 3, inclusive.");this.elements[4*t+e]=i}setRotation(t){var e=t.x,i=t.y,r=t.z,s=t.w,a=e*e,n=i*i,h=r*r,o=e*i,l=r*s,_=r*e,u=i*s,d=i*r,c=e*s,p=this.elements;p[0]=1-2*(n+h),p[1]=2*(o+l),p[2]=2*(_-u),p[4]=2*(o-l),p[5]=1-2*(h+a),p[6]=2*(d+c),p[8]=2*(_+u),p[9]=2*(d-c),p[10]=1-2*(n+a)}setPosition(t){var e=this.elements;e[12]=t.x,e[13]=t.y,e[14]=t.z}equalsOtherMatrix(t){var e=this.elements,i=t.elements;return Ye.nearEqual(e[0],i[0])&&Ye.nearEqual(e[1],i[1])&&Ye.nearEqual(e[2],i[2])&&Ye.nearEqual(e[3],i[3])&&Ye.nearEqual(e[4],i[4])&&Ye.nearEqual(e[5],i[5])&&Ye.nearEqual(e[6],i[6])&&Ye.nearEqual(e[7],i[7])&&Ye.nearEqual(e[8],i[8])&&Ye.nearEqual(e[9],i[9])&&Ye.nearEqual(e[10],i[10])&&Ye.nearEqual(e[11],i[11])&&Ye.nearEqual(e[12],i[12])&&Ye.nearEqual(e[13],i[13])&&Ye.nearEqual(e[14],i[14])&&Ye.nearEqual(e[15],i[15])}decomposeTransRotScale(t,e,i){var r=ga;return this.decomposeTransRotMatScale(t,r,i)?(wa.createFromMatrix4x4(r,e),!0):(e.identity(),!1)}decomposeTransRotMatScale(t,e,i){var r=this.elements,s=t,a=e.elements,n=i;s.x=r[12],s.y=r[13],s.z=r[14];var h=r[0],o=r[1],l=r[2],_=r[4],u=r[5],d=r[6],c=r[8],p=r[9],f=r[10],m=n.x=Math.sqrt(h*h+o*o+l*l),g=n.y=Math.sqrt(_*_+u*u+d*d),T=n.z=Math.sqrt(c*c+p*p+f*f);if(Ye.isZero(m)||Ye.isZero(g)||Ye.isZero(T))return a[1]=a[2]=a[3]=a[4]=a[6]=a[7]=a[8]=a[9]=a[11]=a[12]=a[13]=a[14]=0,a[0]=a[5]=a[10]=a[15]=1,!1;var x=ua;x.x=c/T,x.y=p/T,x.z=f/T;var E=da;E.x=h/m,E.y=o/m,E.z=l/m;var y=ca;Ke.cross(x,E,y);var v=da;return Ke.cross(y,x,v),a[3]=a[7]=a[11]=a[12]=a[13]=a[14]=0,a[15]=1,a[0]=v.x,a[1]=v.y,a[2]=v.z,a[4]=y.x,a[5]=y.y,a[6]=y.z,a[8]=x.x,a[9]=x.y,a[10]=x.z,a[0]*h+a[1]*o+a[2]*l<0&&(n.x=-m),a[4]*_+a[5]*u+a[6]*d<0&&(n.y=-g),a[8]*c+a[9]*p+a[10]*f<0&&(n.z=-T),!0}decomposeYawPitchRoll(t){var e=Math.asin(-this.elements[9]);t.y=e,Math.cos(e)>Ye.zeroTolerance?(t.z=Math.atan2(this.elements[1],this.elements[5]),t.x=Math.atan2(this.elements[8],this.elements[10])):(t.z=Math.atan2(-this.elements[4],this.elements[0]),t.x=0)}normalize(){var t=this.elements,e=t[0],i=t[1],r=t[2],s=Math.sqrt(e*e+i*i+r*r);if(!s)return t[0]=0,t[1]=0,void(t[2]=0);1!=s&&(s=1/s,t[0]=e*s,t[1]=i*s,t[2]=r*s)}transpose(){var t,e;return e=(t=this.elements)[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this}invert(t){var e=this.elements,i=t.elements,r=e[0],s=e[1],a=e[2],n=e[3],h=e[4],o=e[5],l=e[6],_=e[7],u=e[8],d=e[9],c=e[10],p=e[11],f=e[12],m=e[13],g=e[14],T=e[15],x=r*o-s*h,E=r*l-a*h,y=r*_-n*h,v=s*l-a*o,S=s*_-n*o,R=a*_-n*l,b=u*m-d*f,C=u*g-c*f,A=u*T-p*f,w=d*g-c*m,M=d*T-p*m,D=c*T-p*g,I=x*D-E*M+y*w+v*A-S*C+R*b;0!==Math.abs(I)&&(I=1/I,i[0]=(o*D-l*M+_*w)*I,i[1]=(a*M-s*D-n*w)*I,i[2]=(m*R-g*S+T*v)*I,i[3]=(c*S-d*R-p*v)*I,i[4]=(l*A-h*D-_*C)*I,i[5]=(r*D-a*A+n*C)*I,i[6]=(g*y-f*R-T*E)*I,i[7]=(u*R-c*y+p*E)*I,i[8]=(h*M-o*A+_*b)*I,i[9]=(s*A-r*M-n*b)*I,i[10]=(f*S-m*y+T*x)*I,i[11]=(d*y-u*S-p*x)*I,i[12]=(o*C-h*w-l*b)*I,i[13]=(r*w-s*C+a*b)*I,i[14]=(m*E-f*v-g*x)*I,i[15]=(u*v-d*E+c*x)*I)}static billboard(t,e,i,r,s){Ke.subtract(t,e,ua);var a=Ke.scalarLengthSquared(ua);Ye.isZero(a)?(Ke.scale(r,-1,da),da.cloneTo(ua)):Ke.scale(ua,1/Math.sqrt(a),ua),Ke.cross(i,ua,ca),Ke.normalize(ca,ca),Ke.cross(ua,ca,pa);var n=ca,h=pa,o=ua,l=t,_=s.elements;_[0]=n.x,_[1]=n.y,_[2]=n.z,_[3]=0,_[4]=h.x,_[5]=h.y,_[6]=h.z,_[7]=0,_[8]=o.x,_[9]=o.y,_[10]=o.z,_[11]=0,_[12]=l.x,_[13]=l.y,_[14]=l.z,_[15]=1}identity(){this.elements.set(fa)}isIdentity(){let t=this.elements,e=ma.DEFAULT.elements;for(let s=0,a=t.length;s<a;s++)if(i=t[s],r=e[s],!(Math.abs(i-r)<1e-7))return!1;var i,r;return!0}cloneTo(t){this.elements!==t.elements&&t.elements.set(this.elements)}cloneByArray(t){this.elements.set(t)}clone(){var t=new ma(null);return t.elements=this.elements.slice(),t}static translation(t,e){var i=e.elements;i[0]=i[5]=i[10]=i[15]=1,i[12]=t.x,i[13]=t.y,i[14]=t.z}getTranslationVector(t){var e=this.elements;t.x=e[12],t.y=e[13],t.z=e[14]}setTranslationVector(t){var e=this.elements,i=t;e[12]=i.x,e[13]=i.y,e[14]=i.z}getForward(t){var e=this.elements;t.x=-e[8],t.y=-e[9],t.z=-e[10]}setForward(t){var e=this.elements;e[8]=-t.x,e[9]=-t.y,e[10]=-t.z}getInvertFront(){this.decomposeTransRotScale(ua,wa.TEMP,da);var t=da,e=t.x<0;return t.y<0&&(e=!e),t.z<0&&(e=!e),e}}ma.TEMPMatrix0=new ma,ma.TEMPMatrix1=new ma,ma.DEFAULT=new ma,ma.ZERO=new ma(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const ga=new ma,Ta=new Float32Array([1,0,0,0,1,0,0,0,1]),xa=new Ke,Ea=new Ke,ya=new Ke;class va{static createRotationQuaternion(t,e){var i=t.x,r=t.y,s=t.z,a=t.w,n=i*i,h=r*r,o=s*s,l=i*r,_=s*a,u=s*i,d=r*a,c=r*s,p=i*a,f=e.elements;f[0]=1-2*(h+o),f[1]=2*(l+_),f[2]=2*(u-d),f[3]=2*(l-_),f[4]=1-2*(o+n),f[5]=2*(c+p),f[6]=2*(u+d),f[7]=2*(c-p),f[8]=1-2*(h+n)}static createFromTranslation(t,e){var i=e.elements;i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=1,i[5]=0,i[6]=t.x,i[7]=t.y,i[8]=1}static createFromRotation(t,e){var i=e.elements,r=Math.sin(t),s=Math.cos(t);i[0]=s,i[1]=r,i[2]=0,i[3]=-r,i[4]=s,i[5]=0,i[6]=0,i[7]=0,i[8]=1}static createFromScaling(t,e){var i=e.elements;i[0]=t.x,i[1]=0,i[2]=0,i[3]=0,i[4]=t.y,i[5]=0,i[6]=0,i[7]=0,i[8]=t.z}static createFromMatrix4x4(t,e){var i=t.elements,r=e.elements;r[0]=i[0],r[1]=i[1],r[2]=i[2],r[3]=i[4],r[4]=i[5],r[5]=i[6],r[6]=i[8],r[7]=i[9],r[8]=i[10]}static multiply(t,e,i){var r=t.elements,s=e.elements,a=i.elements,n=r[0],h=r[1],o=r[2],l=r[3],_=r[4],u=r[5],d=r[6],c=r[7],p=r[8],f=s[0],m=s[1],g=s[2],T=s[3],x=s[4],E=s[5],y=s[6],v=s[7],S=s[8];a[0]=f*n+m*l+g*d,a[1]=f*h+m*_+g*v,a[2]=f*o+m*u+g*p,a[3]=T*n+x*l+E*d,a[4]=T*h+x*_+E*c,a[5]=T*o+x*u+E*p,a[6]=y*n+v*l+S*d,a[7]=y*h+v*_+S*c,a[8]=y*o+v*u+S*p}constructor(t=!0){t&&(this.elements=Ta.slice())}determinant(){var t=this.elements,e=t[0],i=t[1],r=t[2],s=t[3],a=t[4],n=t[5],h=t[6],o=t[7],l=t[8];return e*(l*a-n*o)+i*(-l*s+n*h)+r*(o*s-a*h)}translate(t,e){var i=e.elements,r=this.elements,s=r[0],a=r[1],n=r[2],h=r[3],o=r[4],l=r[5],_=r[6],u=r[7],d=r[8],c=t.x,p=t.y;i[0]=s,i[1]=a,i[2]=n,i[3]=h,i[4]=o,i[5]=l,i[6]=c*s+p*h+_,i[7]=c*a+p*o+u,i[8]=c*n+p*l+d}rotate(t,e){var i=e.elements,r=this.elements,s=r[0],a=r[1],n=r[2],h=r[3],o=r[4],l=r[5],_=r[6],u=r[7],d=r[8],c=Math.sin(t),p=Math.cos(t);i[0]=p*s+c*h,i[1]=p*a+c*o,i[2]=p*n+c*l,i[3]=p*h-c*s,i[4]=p*o-c*a,i[5]=p*l-c*n,i[6]=_,i[7]=u,i[8]=d}scale(t,e){var i=e.elements,r=this.elements,s=t.x,a=t.y;i[0]=s*r[0],i[1]=s*r[1],i[2]=s*r[2],i[3]=a*r[3],i[4]=a*r[4],i[5]=a*r[5],i[6]=r[6],i[7]=r[7],i[8]=r[8]}invert(t){var e=t.elements,i=this.elements,r=i[0],s=i[1],a=i[2],n=i[3],h=i[4],o=i[5],l=i[6],_=i[7],u=i[8],d=u*h-o*_,c=-u*n+o*l,p=_*n-h*l,f=r*d+s*c+a*p;f&&(f=1/f,e[0]=d*f,e[1]=(-u*s+a*_)*f,e[2]=(o*s-a*h)*f,e[3]=c*f,e[4]=(u*r-a*l)*f,e[5]=(-o*r+a*n)*f,e[6]=p*f,e[7]=(-_*r+s*l)*f,e[8]=(h*r-s*n)*f)}transpose(t){var e=t.elements,i=this.elements;if(t===this){var r=i[1],s=i[2],a=i[5];e[1]=i[3],e[2]=i[6],e[3]=r,e[5]=i[7],e[6]=s,e[7]=a}else e[0]=i[0],e[1]=i[3],e[2]=i[6],e[3]=i[1],e[4]=i[4],e[5]=i[7],e[6]=i[2],e[7]=i[5],e[8]=i[8]}identity(){this.elements.set(Ta)}cloneTo(t){var e,i;(e=this.elements)!==(i=t.elements)&&e.set(i)}clone(){var t=new va(!1);return t.elements=this.elements.slice(),t}static lookAt(t,e,i,r){Ke.subtract(t,e,xa),Ke.normalize(xa,xa),Ke.cross(i,xa,Ea),Ke.normalize(Ea,Ea),Ke.cross(xa,Ea,ya);var s=xa,a=Ea,n=ya,h=r.elements;h[0]=a.x,h[3]=a.y,h[6]=a.z,h[1]=n.x,h[4]=n.y,h[7]=n.z,h[2]=s.x,h[5]=s.y,h[8]=s.z}static forwardLookAt(t,e,i,r){var s=Ea,a=ya,n=xa;e.vsub(t,n).normalize(),i.cross(n,s).normalize(),n.cross(s,a);var h=r.elements;h[0]=s.x,h[1]=s.y,h[2]=s.z,h[3]=a.x,h[4]=a.y,h[5]=a.z,h[6]=n.x,h[7]=n.y,h[8]=n.z}}va.DEFAULT=new va;const Sa=new Ke,Ra=new Ke,ba=new Ke,Ca=new Ke,Aa=new va;class wa{static createFromYawPitchRoll(t,e,i,r){var s=.5*i,a=.5*e,n=.5*t,h=Math.sin(s),o=Math.cos(s),l=Math.sin(a),_=Math.cos(a),u=Math.sin(n),d=Math.cos(n);r.x=d*l*o+u*_*h,r.y=u*_*o-d*l*h,r.z=d*_*h-u*l*o,r.w=d*_*o+u*l*h}static multiply(t,e,i){var r=t.x,s=t.y,a=t.z,n=t.w,h=e.x,o=e.y,l=e.z,_=e.w,u=s*l-a*o,d=a*h-r*l,c=r*o-s*h,p=r*h+s*o+a*l;i.x=r*_+h*n+u,i.y=s*_+o*n+d,i.z=a*_+l*n+c,i.w=n*_-p}static arcTanAngle(t,e){return 0==t?1==e?Math.PI/2:-Math.PI/2:t>0?Math.atan(e/t):t<0?e>0?Math.atan(e/t)+Math.PI:Math.atan(e/t)-Math.PI:0}static angleTo(t,e,i){Ke.subtract(e,t,Sa),Ke.normalize(Sa,Sa),i.x=Math.asin(Sa.y),i.y=wa.arcTanAngle(-Sa.z,-Sa.x)}static createFromAxisAngle(t,e,i){e*=.5;var r=Math.sin(e);i.x=r*t.x,i.y=r*t.y,i.z=r*t.z,i.w=Math.cos(e)}static createFromMatrix4x4(t,e){var i,r,s=t.elements,a=s[0]+s[5]+s[10];a>0?(i=Math.sqrt(a+1),e.w=.5*i,i=.5/i,e.x=(s[6]-s[9])*i,e.y=(s[8]-s[2])*i,e.z=(s[1]-s[4])*i):s[0]>=s[5]&&s[0]>=s[10]?(r=.5/(i=Math.sqrt(1+s[0]-s[5]-s[10])),e.x=.5*i,e.y=(s[1]+s[4])*r,e.z=(s[2]+s[8])*r,e.w=(s[6]-s[9])*r):s[5]>s[10]?(r=.5/(i=Math.sqrt(1+s[5]-s[0]-s[10])),e.x=(s[4]+s[1])*r,e.y=.5*i,e.z=(s[9]+s[6])*r,e.w=(s[8]-s[2])*r):(r=.5/(i=Math.sqrt(1+s[10]-s[0]-s[5])),e.x=(s[8]+s[2])*r,e.y=(s[9]+s[6])*r,e.z=.5*i,e.w=(s[1]-s[4])*r)}static slerp(t,e,i,r){var s,a,n,h,o,l=t.x,_=t.y,u=t.z,d=t.w,c=e.x,p=e.y,f=e.z,m=e.w;return(a=l*c+_*p+u*f+d*m)<0&&(a=-a,c=-c,p=-p,f=-f,m=-m),1-a>1e-6?(s=Math.acos(a),n=Math.sin(s),h=Math.sin((1-i)*s)/n,o=Math.sin(i*s)/n):(h=1-i,o=i),r.x=h*l+o*c,r.y=h*_+o*p,r.z=h*u+o*f,r.w=h*d+o*m,r}static lerp(t,e,i,r){var s=1-i;wa.dot(t,e)>=0?(r.x=s*t.x+i*e.x,r.y=s*t.y+i*e.y,r.z=s*t.z+i*e.z,r.w=s*t.w+i*e.w):(r.x=s*t.x-i*e.x,r.y=s*t.y-i*e.y,r.z=s*t.z-i*e.z,r.w=s*t.w-i*e.w),r.normalize(r)}static add(t,e,i){i.x=t.x+e.x,i.y=t.y+e.y,i.z=t.z+e.z,i.w=t.w+e.w}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w}constructor(t=0,e=0,i=0,r=1){this.x=t,this.y=e,this.z=i,this.w=r}setValue(t,e,i,r){this.x=t,this.y=e,this.z=i,this.w=r}set(t,e,i,r){return this.x=t,this.y=e,this.z=i,this.w=r,this}scaling(t,e){e.x=this.x*t,e.y=this.y*t,e.z=this.z*t,e.w=this.w*t}normalize(t){var e=this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w;e>0&&(e=1/Math.sqrt(e),t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t.w=this.w*e)}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}rotateX(t,e){t*=.5;var i=Math.sin(t),r=Math.cos(t);e.x=this.x*r+this.w*i,e.y=this.y*r+this.z*i,e.z=this.z*r-this.y*i,e.w=this.w*r-this.x*i}rotateY(t,e){t*=.5;var i=Math.sin(t),r=Math.cos(t);e.x=this.x*r-this.z*i,e.y=this.y*r+this.w*i,e.z=this.z*r+this.x*i,e.w=this.w*r-this.y*i}rotateZ(t,e){t*=.5;var i=Math.sin(t),r=Math.cos(t);e.x=this.x*r+this.y*i,e.y=this.y*r-this.x*i,e.z=this.z*r+this.w*i,e.w=this.w*r-this.z*i}getYawPitchRoll(t){Ke.transformQuat(Ke.ForwardRH,this,Ra),Ke.transformQuat(Ke.Up,this,ba);var e=ba;wa.angleTo(Ke.ZERO,Ra,Ca);var i=Ca;i.x==Math.PI/2?(i.y=wa.arcTanAngle(e.z,e.x),i.z=0):i.x==-Math.PI/2?(i.y=wa.arcTanAngle(-e.z,-e.x),i.z=0):(ma.createRotationY(-i.y,ma.TEMPMatrix0),ma.createRotationX(-i.x,ma.TEMPMatrix1),Ke.transformCoordinate(ba,ma.TEMPMatrix0,ba),Ke.transformCoordinate(ba,ma.TEMPMatrix1,ba),i.z=wa.arcTanAngle(e.y,-e.x)),i.y<=-Math.PI&&(i.y=Math.PI),i.z<=-Math.PI&&(i.z=Math.PI),i.y>=Math.PI&&i.z>=Math.PI&&(i.y=0,i.z=0,i.x=Math.PI-i.x);var r=t;r.x=i.y,r.y=i.x,r.z=i.z}invert(t){var e=this.x,i=this.y,r=this.z,s=this.w,a=e*e+i*i+r*r+s*s,n=a?1/a:0;t.x=-e*n,t.y=-i*n,t.z=-r*n,t.w=s*n}identity(){this.x=0,this.y=0,this.z=0,this.w=1}fromArray(t,e=0){this.x=t[e+0],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3]}cloneTo(t){this!==t&&(t.x=this.x,t.y=this.y,t.z=this.z,t.w=this.w)}clone(){var t=new wa;return this.cloneTo(t),t}equals(t){return Ye.nearEqual(this.x,t.x)&&Ye.nearEqual(this.y,t.y)&&Ye.nearEqual(this.z,t.z)&&Ye.nearEqual(this.w,t.w)}static rotationLookAt(t,e,i){wa.lookAt(Ke.ZERO,t,e,i)}static lookAt(t,e,i,r){va.lookAt(t,e,i,Aa),wa.rotationMatrix(Aa,r)}static forwardLookAt(t,e,i,r){va.forwardLookAt(t,e,i,Aa),wa.rotationMatrix(Aa,r)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}static invert(t,e){var i=t.lengthSquared();Ye.isZero(i)||(i=1/i,e.x=-t.x*i,e.y=-t.y*i,e.z=-t.z*i,e.w=t.w*i)}static rotationMatrix(t,e){var i,r,s=t.elements,a=s[0],n=s[1],h=s[2],o=s[3],l=s[4],_=s[5],u=s[6],d=s[7],c=s[8],p=a+l+c;p>0?(i=Math.sqrt(p+1),e.w=.5*i,i=.5/i,e.x=(_-d)*i,e.y=(u-h)*i,e.z=(n-o)*i):a>=l&&a>=c?(r=.5/(i=Math.sqrt(1+a-l-c)),e.x=.5*i,e.y=(n+o)*r,e.z=(h+u)*r,e.w=(_-d)*r):l>c?(r=.5/(i=Math.sqrt(1+l-a-c)),e.x=(o+n)*r,e.y=.5*i,e.z=(d+_)*r,e.w=(u-h)*r):(r=.5/(i=Math.sqrt(1+c-a-l)),e.x=(u+h)*r,e.y=(d+_)*r,e.z=.5*i,e.w=(n-o)*r)}forNativeElement(t=null){t?(this.elements=t,this.elements[0]=this.x,this.elements[1]=this.y,this.elements[2]=this.z,this.elements[3]=this.w):this.elements=new Float32Array([this.x,this.y,this.z,this.w]),ze.rewriteNumProperty(this,"x",0),ze.rewriteNumProperty(this,"y",1),ze.rewriteNumProperty(this,"z",2),ze.rewriteNumProperty(this,"w",3)}}var Ma;wa.TEMP=new wa,wa.DEFAULT=new wa,wa.NAN=new wa(NaN,NaN,NaN,NaN),t.TextResourceFormat=void 0,(Ma=t.TextResourceFormat||(t.TextResourceFormat={}))[Ma.Buffer=0]="Buffer",Ma[Ma.Plain=1]="Plain",Ma[Ma.JSON=2]="JSON",Ma[Ma.XML=3]="XML";class Da extends M{constructor(t,e){super(),this.data=t,this.format=e}}ar.registerLoader(["txt","csv"],class{load(e){return e.loader.fetch(e.url,"text",e.progress.createCallback(),e.options).then((e=>e?new Da(e,t.TextResourceFormat.Plain):null))}},ar.TEXT),ar.registerLoader(["bin","bytes"],class{load(e){return e.loader.fetch(e.url,"arraybuffer",e.progress.createCallback(),e.options).then((e=>e?new Da(e,t.TextResourceFormat.Buffer):null))}},ar.BUFFER),ar.registerLoader(["json"],class{load(e){return e.loader.fetch(e.url,"json",e.progress.createCallback(),e.options).then((e=>e?new Da(e,t.TextResourceFormat.JSON):null))}},ar.JSON),ar.registerLoader(["xml","fnt"],class{load(e){return e.loader.fetch(e.url,"xml",e.progress.createCallback(),e.options).then((e=>e?new Da(e,t.TextResourceFormat.XML):null))}},ar.XML);ar.registerLoader(["atlas"],class{load(t){return t.loader.fetch(t.url,"json",t.progress.createCallback(.2),t.options).then((e=>{if(!e)return null;let i=[];if(e.meta&&e.meta.image){let r="",s=t.url.lastIndexOf("/");-1!=s&&(r=t.url.substring(0,s+1));let a="";s=t.url.lastIndexOf("?"),-1!=s&&(a=t.url.substring(s));let n=e.meta.image.split(",");for(let e of n)i.push(t.loader.load(r+e+a,null,t.progress.createCallback()))}else i.push(t.loader.load(d.replaceFileExtension(t.url,"png"),null,t.progress.createCallback()));return Promise.all(i).then((i=>{let r=t.options.baseUrl||"",s=e.frames,a=e.meta&&null!=e.meta.prefix?e.meta.prefix:t.url.substring(0,t.url.lastIndexOf("."))+"/",n=[],h=1;e.meta&&e.meta.scale&&1!=e.meta.scale&&(h=parseFloat(e.meta.scale));for(let t of i)t&&(t._addReference(),t.scaleRate=h);for(let e in s){let h=s[e],o=i[h.frame.idx?h.frame.idx:0];if(!o)continue;let l=r+a+e,_=ht.create(o,h.frame.x,h.frame.y,h.frame.w,h.frame.h,h.spriteSourceSize.x,h.spriteSourceSize.y,h.sourceSize.w,h.sourceSize.h);_.lock=!0,t.loader.cacheRes(l,_),_.url=l,n.push(_)}return new Qi(a,i,n)}))}))}},ar.ATLAS);const Ia={Int8Array:Int8Array,Uint8Array:Uint8Array,Int16Array:Int16Array,Uint16Array:Uint16Array,Int32Array:Int32Array,Uint32Array:Uint32Array,Float32Array:Float32Array,Float64Array:Float64Array};class Pa{static decodeObj(t,e,i,r,s){if(null==t)return null;if(Array.isArray(t)){let e=[];for(let i=0;i<t.length;i++){let a=t[i];if(null!=a)try{e[i]=this.decodeObj(a,null,null,r,s)}catch(t){s&&s.push(t),e[i]=null}else e[i]=null}return e}if("object"==typeof t){if(null!=t._$uuid){let e=_t.getResURLByUUID(t._$uuid);return n.loader.getRes(e,Pa.getLoadTypeByEngineType(t._$type))}if(null!=t._$ref){let e=null==r?void 0:r(t._$ref);if(e&&t._$type){let i=a.getClass(t._$type);return i?e.getComponent(i):null}return e}if("any"===(i=i||t._$type))return t._$type?t.value:t;let h=Ia[i];if(null!=h)return t._$type?new h(t.value):new h(t);if(!e){let t=a.getClass(i);if(!t)return null;e=new t}for(let i in t){if(i.startsWith("_$"))continue;let a=t[i];if(null==a||"object"!=typeof a||Array.isArray(a)||a._$type||a._$uuid||a._$ref)try{e[i]=Pa.decodeObj(a,null,null,r,s)}catch(t){s&&s.push(t)}else{let t=e[i];if(t)try{Pa.decodeObj(a,t,null,r,s)}catch(t){s&&s.push(t)}}}return e.onAfterDeserialize&&e.onAfterDeserialize(),e}return t}static getLoadTypeByEngineType(t){switch(t){case"Texture2D":case"RenderTexture":return ar.TEXTURE2D;case"TextureCube":return ar.TEXTURECUBE;case"Prefab":return ar.HIERARCHY;default:return null}}}const Ba=[];class La{static parse(t,e,i){i=i||Ba;let r,s,n,h,o,l={},_=[],u=[],d=[];function createChildren(t,e){for(let i of t._$child)if(i._$child){let t=createNode(i,e);createChildren(i,i._$prefab?t:e),_.push(i),u.push(t)}else{let t=createNode(i,e);_.push(i),u.push(t)}}function createNode(t,e,r){let s,h;if(h=t._$override){if(e&&n)if(Array.isArray(h)){s=e;for(let t=0,e=h.length;t<e;t++){let e=n.get(s);if(s=null==e?void 0:e[h[t]],!s)break}}else{let i=n.get(e);i&&(s=i[t._$override])}}else{if(h=t._$prefab){let t=ar.getRes(_t.getResURLByUUID(h),ar.HIERARCHY);t&&(n||(n=new Map),s=t.create({inPrefab:!0,prefabNodeDict:n},i))}else if(h=t._$type){let t=null!=r?r:a.getClass(h);if(t)try{s=new t}catch(t){i.push(t)}else i.push(new Error(`unknown type '${h}'`))}s&&(l[t._$id]=s)}return s}function findNode(t){if(Array.isArray(t)){let e=l[t[0]];return e&&t.length>1?findNodeInPrefab(e,t,1):e}return l[t]}function findNodeInPrefab(t,e,i=0){if(!e)return t;let r=null==n?void 0:n.get(t);if(!r)return null;if(Array.isArray(e)){let t;for(let s=i,a=e.length;s<a;s++){if(!r)return null;if(t=r[e[s]],!t)break;r=n.get(t)}return t}return r[e]}if(e&&(s=e.inPrefab,s&&(n=e.prefabNodeDict),h=e.skinBaseUrl),t._$type||t._$prefab){if(o=t._$runtime){o.startsWith("res://")&&(o=o.substring(6));let t=a.getClass(o);t?o=t:i.push(new Error(`unknown runtime '${o}'`))}let e=createNode(t,null,o);e&&(t._$child&&createChildren(t,t._$prefab?e:null),_.push(t),u.push(e),e instanceof xs&&(r=e))}else t._$child&&createChildren(t,null);let c=_.length,p=0;for(let t=0;t<c;t++){let e=_[t],i=u[t],s=e._$child;if(s){let a=s.length;if(i)if(e._$prefab)for(let e=0;e<a;e++){let r=d[p-a+e];if(r&&!r.parent){let s=_[t-a+e],n=findNodeInPrefab(i,s._$parent);if(n){let t=s._$index;null!=t&&t<n.numChildren?n.addChildAt(r,t):n.addChild(r)}else i.addChildAt(r,0)}}else for(let t=0;t<a;t++){let e=d[p-a+t];e&&(i===r&&e._is3D?r._scene3D=e:i.addChild(e))}p-=a}d[p]=i,p++}d.length=p,d=d.filter((t=>null!=t));let f=d[0],m=[];for(let t=0;t<c;t++){let e=_[t]._$comp;if(!e)continue;let r=u[t];if(r)for(let t of e){let e;if(t._$override){let i=a.getClass(t._$override);i&&(e=r.getComponent(i))}else{let s=a.getClass(t._$type);if(s&&(e=r.getComponent(s),!e))try{e=r.addComponent(s)}catch(t){i.push(t)}}e&&m.push(t,e)}}for(let t=0;t<c;t++){let e=_[t],r=u[t];if(r&&(null!=h&&r instanceof Ki&&(r._skinBaseUrl=h),Pa.decodeObj(e,r,null,findNode,i),o&&e._$var&&r.name))try{f[r.name]=r}catch(t){i.push(t)}}c=m.length;for(let t=0;t<c;t+=2)Pa.decodeObj(m[t],m[t+1],null,findNode,i);return s&&n&&f&&n.set(f,l),i==Ba&&(Ba.length=0),d}static collectResourceLinks(t,e){let i={},r=[];function addInnerUrl(t,s){if(!t)return"";let a=i[t];if(void 0===a){let n;n=t.length>=36&&45===t.charCodeAt(8)&&45===t.charCodeAt(13)?"res://"+t:_t.join(e,t),r.push({url:n,type:s}),i[t]=a=[n,s]}else-1==a.indexOf(s)&&(a.push(s),r.push({url:a[0],type:s}));return a[0]}return function check(t){for(let e in t){let i=t[e];if(null!=i)if(Array.isArray(i))for(let t of i)null!=t&&"object"==typeof t&&(null!=t._$uuid?t._$uuid=addInnerUrl(t._$uuid,Pa.getLoadTypeByEngineType(t._$type)):null!=t._$prefab?(t._$prefab=addInnerUrl(t._$prefab,ar.HIERARCHY),check(t)):check(t));else"object"==typeof i&&(null!=i._$uuid?i._$uuid=addInnerUrl(i._$uuid,Pa.getLoadTypeByEngineType(i._$type)):null!=i._$prefab?(i._$prefab=addInnerUrl(i._$prefab,ar.HIERARCHY),check(i)):check(i))}}(t),r}}class Fa{load(t){let e=t.url;return("gltf"==t.ext||"fbx"==t.ext)&&(e=lt.inst.getSubAssetURL(e,t.uuid,"0","lh")),t.loader.fetch(e,"json",t.progress.createCallback(.2),t.options).then((e=>e?null!=e._$ver?this._load(Fa.v3,t,e,3):"ls"==t.ext||"lh"==t.ext?this._load(Fa.v2,t,e,2):"scene"==t.ext||"prefab"==t.ext?this._load(Fa.legacySceneOrPrefab,t,e,2):null:null))}_load(t,e,i,r){let s=_t.getPath(e.url),a=t.collectResourceLinks(i,s);return e.loader.load(a,null,e.progress.createCallback()).then((e=>{let s=new fs(t,i,r);return s.addDeps(e),s}))}}Fa.v3=La,Fa.v2=null,Fa.legacySceneOrPrefab=ms,ar.registerLoader(["lh","ls","scene","prefab"],Fa,ar.HIERARCHY);class Oa{static _parseHDRTexture(t,e=null,i=null){let r=Oa.getHDRInfo(t),s=new X(r.width,r.height,r.format,!1,!1,!1);return s.setHDRData(r),s}static getHDRInfo(e){let i=new Uint8Array(e),r=0;const readLine=()=>{let t=Oa.getLineString(i,r);return r+=t.length+1,t};if("#?RADIANCE"!=readLine())throw"HDR image: identifier wrong.";let s=new Map,a="";do{if(a=readLine(),"#"!=a[0]){let t=a.split("=");s.set(t[0],t[1])}}while(""!=a);if("32-bit_rle_rgbe"!=s.get("FORMAT"))throw"HDR image: unsupported format.";let n=readLine().split(" "),h="-Y"==n[0],o="-X"==n[2],l=parseInt(n[1]),_=parseInt(n[3]);return new Oa(e,r,o,h,_,l,t.TextureFormat.R32G32B32)}static getLineString(t,e){let i=t.length,r=e,s="",a="";for(;r<i&&"\n"!=a;)s=`${s}${a}`,a=String.fromCharCode(t[r]),r++;return s}constructor(t,e,i,r,s,a,n){this.source=t,this.byteOffset=e,this.decreaseX=i,this.decreaseY=r,this.width=s,this.height=a,this.format=n}get_32_bit_rle_rgbe(){let t=this.width,e=this.height;this.decreaseX,this.decreaseY;let i=new Uint8Array(this.source,this.byteOffset),r=0,s=new ArrayBuffer(4*t),a=new Uint8Array(s),n=new ArrayBuffer(t*e*4*3),h=new Float32Array(n);for(let s=e;s>0;s--){i[r++],i[r++];let n=i[r++]<<8|i[r++];if(n!=t)throw"HDR info: scanlineLength wrong.";let o=0;for(let t=0;t<4;t++){let e=(t+1)*n;for(;o<e;){let t=i[r++],s=i[r++];if(t>128){let i=t-128;if(i>e-o)throw"HDR info: ??";for(;i-- >0;)a[o++]=s}else{let n=t;if(0==n||n>e-o)throw"HDR info: ??";if(a[o++]=s,--n>0)for(let t=0;t<n;t++)a[o++]=i[r++]}}}for(let t=0;t<n;t++){let i=a[t],r=a[t+n],o=a[t+2*n],l=a[t+3*n],_=(e-s)*n*3+3*t;const Ldexp=(t,e)=>e>1023?t*Math.pow(2,1023)*Math.pow(2,e-1023):e<-1074?t*Math.pow(2,-1074)*Math.pow(2,e+1074):t*Math.pow(2,e);if(l>0){let t=Ldexp(1,l-136);h[_]=i*t,h[_+1]=r*t,h[_+2]=o*t}else h[_]=0,h[_+1]=0,h[_+2]=0}}return h}readScanLine(){let t=this.width,e=this.height,i=this.decreaseX,r=this.decreaseY,s=new Float32Array(t*e*3),a=new Uint8Array(4*t),n=new Uint8Array(this.source,this.byteOffset),h=n.length,o=0;const getc=()=>{if(o>=h)throw"HDR info: data wrong.";return n[o++]},wrong=()=>{throw"HDR info: data wrong."};for(let n=e-1;n>=0;n--){this.readcolors(a,getc,wrong);for(let h=0;h<t;h++){let o=4*h,l=a[o],_=a[o+1],u=a[o+2],d=a[o+3],c=n,p=h;r&&(c=e-1-n),i&&(p=t-1-h);let f=c*t*3+3*p;if(0==d)s[f]=0,s[f+1]=0,s[f+2]=0;else{let t=ldexp(1,d-136);s[f]=(l+.5)*t,s[f+1]=(_+.5)*t,s[f+2]=(u+.5)*t}}}return s}readcolors(t,e,i){const setScanLineData=(e,i,r)=>{t[4*e+i]=r};let r=this.width,s=e(),a=e(),n=e(),h=e();(r<8||r>32767)&&this.olddreadcolors(t,e),(2!=s||2!=a||128&n)&&this.olddreadcolors(t,e),(n<<8|h)!=r&&i();for(let t=0;t<4;t++)for(let s=0;s<r;){let a=e();if(a>128){a&=127;let n=e();for(s+a>r&&i();a--;)setScanLineData(s++,t,n)}else for(s+a>r&&i();a--;){setScanLineData(s++,t,e())}}}olddreadcolors(t,e){let i=0,r=this.width;for(let s=0;s<r;s++){let a=e(),n=e(),h=e(),o=e(),l=4*s;if(t[l]=a,t[l+1]=n,t[l+2]=h,t[l+3]=o,1==a&&1==n&&1==h){let e=l-4;for(let s=o<<i;s>0;s--)t[l]=t[e],t[l+1]=t[e+1],t[l+2]=t[e+2],t[l+3]=t[e+3],r--;i+=8}else r--,i=0}}color_color(t,e){let i=0;0==e.w?t.x=t.y=t.z=0:(i=ldexp(1,e.w-136),t.x=e.x*i,t.y=e.y*i,t.z=e.z*i)}}function ldexp(t,e){return t*Math.pow(2,e)}Oa.HDRTEXTURE="HDRTEXTURE";const Na={noRetry:!0,silent:!0};var Ua;const Ga={premultiplyAlpha:!0},ka=[null,null,t.TextureFormat.R8G8B8A8,!1,!1,!0];const Wa=["ktx","pvr","dds","hdr","lanit.ls"],Va=["mp4","webm"];ar.registerLoader(["png","jpg","jpeg","rendertexture",...Va,...Wa],class{wrapTex2D(t,e){if(!e)return null;let i=t.obsoluteInst;return i?(i.setTo(e),i.obsolute=!1):i=new ht(e),i}load(t){let e=t.loader.getRes(t.url,ar.TEXTURE2D);if(!e||e.obsolute){let e={url:t.url,type:ar.TEXTURE2D};return t.options.propertyParams?null==t.options.propertyParams.premultiplyAlpha&&(e.propertyParams=Object.assign({},Ga,t.options.propertyParams)):e.propertyParams=Ga,t.options.constructParams?null==t.options.constructParams[5]&&(e.constructParams=Object.assign([],ka,t.options.constructParams)):e.constructParams=ka,t.loader.load(e,t.options,t.progress.createCallback()).then((e=>this.wrapTex2D(t,e)))}return Promise.resolve(this.wrapTex2D(t,e))}},ar.IMAGE),ar.registerLoader([],class{constructor(){Ua||(Ua={"WhiteTexture.png":X.whiteTexture,"BlackTexture.png":X.blackTexture,"GrayTexture.png":X.grayTexture,"NormalTexture.png":X.normalTexture})}load(t){if(-1!=t.url.indexOf("internal/")){let e=Ua[d.getBaseName(t.url)];if(e)return Promise.resolve(e)}let e=lt.inst.getMeta(t.url,t.uuid);return e&&"object"!=typeof e?t.options.noMetaFile?this.load2(t,null):t.loader.fetch(e,"json",t.progress.createCallback(.1),Na).then((e=>this.load2(t,e))):this.load2(t,e)}load2(e,i){var r;let s,n,h=e.ext,o=e.url;if(i){let t=We.platform,a=(null===(r=i.platforms)||void 0===r?void 0:r[t])||0,l=i.files[a];l.file&&(o=lt.inst.getSubAssetURL(o,e.uuid,l.file,l.ext),h=l.ext),s=[0,0,l.format,i.mipmap,i.readWrite,i.sRGB],n={wrapModeU:i.wrapMode,wrapModeV:i.wrapMode,filterMode:i.filterMode,anisoLevel:i.anisoLevel,premultiplyAlpha:i.pma,hdrEncodeFormat:i.hdrEncodeFormat}}else s=e.options.constructParams,n=e.options.propertyParams;let l=-1!=Wa.indexOf(h)?h:null;return null!=l?e.loader.fetch(o,"arraybuffer",e.progress.createCallback(),e.options).then((i=>{if(!i)return null;let r;switch(l){case"dds":r=X._parseDDS(i,n,s);break;case"ktx":let e=V.getKTXTextureInfo(i);if(e.dimension==t.TextureDimension.Cube){let t=a.getClass("TextureCube");if(!t)return null;{let i=new t(e.width,e.format,e.mipmapCount>1,e.sRGB);i.setKTXData(e),r=i}}else e.dimension==t.TextureDimension.Tex2D&&(r=X._parseKTX(i,n,s));break;case"pvr":r=X._parsePVR(i,n,s);break;case"hdr":r=Oa._parseHDRTexture(i,n,s);break;case"lanit.ls":r=X._SimpleAnimatorTextureParse(i,n,s)}let h=e.obsoluteInst;return h&&Object.getPrototypeOf(h)==Object.getPrototypeOf(r)&&(r=this.move(h,r)),n&&n.hdrEncodeFormat&&(r.hdrEncodeFormat=n.hdrEncodeFormat),r})):e.loader.fetch(o,"image",e.progress.createCallback(),e.options).then((t=>{if(!t)return null;let i=X._parseImage(t,n,s),r=e.obsoluteInst;return r&&Object.getPrototypeOf(r)==Object.getPrototypeOf(i)&&(i=this.move(r,i)),i}))}move(t,e){return t._texture=e._texture,t.width=e.width,t.height=e.height,t.obsolute=!1,delete M._idResourcesMap[e.id],t}},ar.TEXTURE2D),ar.registerLoader(["rendertexture"],class{load(t){return t.loader.fetch(t.url,"json",t.progress.createCallback(),t.options).then((e=>{if(!e)return null;let i=t.obsoluteInst;return i?(i.recreate(e.width,e.height,e.colorFormat,e.depthFormat,e.generateMipmap,e.multiSamples,!1,e.sRGB),i):new $e(e.width,e.height,e.colorFormat,e.depthFormat,e.generateMipmap,e.multiSamples,!1,e.sRGB)}))}},ar.TEXTURE2D),ar.registerLoader(Va,class{load(t){let e=t.obsoluteInst||new Us;return e.source=t.url,Promise.resolve(e)}},ar.TEXTURE2D);ar.registerLoader(["mc"],class{load(t){return t.loader.fetch(t.url,"arraybuffer",t.progress.createCallback(),t.options).then((t=>t?ia._parse(t):null))}},"ANIMATIONCLIP2D");class Xa{load(t){return Promise.resolve(null)}}ar.registerLoader(["lighting"],Xa);ar.registerLoader(["mp3","wav","ogg"],class{load(t){return t.loader.fetch(t.url,"arraybuffer",t.progress.createCallback(),t.options).then((t=>t?Fs.ctx.decodeAudioData(t):null))}},ar.SOUND);let Ha=a.regClass;Ha("Record",Object),Ha("Node",ki),Ha("Sprite",Ki),Ha("Widget",ns),Ha("Text",gr),Ha("Input",as),Ha("AnimationBase",qi),Ha("Animation",cr),Ha("FrameAnimation",_r),Ha("EffectAnimation",fr),Ha("SoundNode",Ns),Ha("VideoNode",ks),Ha("Scene",xs),Ha("Stage",Cs),Ha("Component",c),Ha("BitmapFont",pr),Ha("BlurFilter",ws),Ha("ColorFilter",At),Ha("GlowFilter",Ds),Ha("Point",f),Ha("Rectangle",m),Ha("Texture",ht),Ha("Texture2D",X),Ha("Prefab",us),Ha("Animator2D",qs),Ha("AnimatorControllerLayer2D",Vs),Ha("AnimatorState2D",$s),Ha("AnimationClip2D",ia),Ha("AnimatorController2D",_a),Ha("Animation2DParm",ra),Ha("Animation2DCondition",sa),Ha("Vector2",ze),Ha("Vector3",Ke),Ha("Vector4",je),Ha("Quaternion",wa),Ha("Color",Z);class Ya{static __init__(){return Ya._baseClass||(Ya._baseClass=za,za.init()),Ya.items=Ya._baseClass.items,Ya.support=Ya._baseClass.support,Ya.support}static setItem(t,e){Ya._baseClass.setItem(t,e)}static getItem(t){return Ya._baseClass.getItem(t)}static setJSON(t,e){Ya._baseClass.setJSON(t,e)}static getJSON(t){return Ya._baseClass.getJSON(t)}static removeItem(t){Ya._baseClass.removeItem(t)}static clear(){Ya._baseClass.clear()}}Ya.support=!1;class za{static init(){try{za.support=!0,za.items=window.localStorage,za.setItem("laya","1"),za.removeItem("laya")}catch(t){za.support=!1}za.support||console.log("LocalStorage is not supprot or browser is private mode.")}static setItem(t,e){try{za.support&&za.items.setItem(t,e)}catch(t){console.warn("set localStorage failed",t)}}static getItem(t){return za.support?za.items.getItem(t):null}static setJSON(t,e){try{za.support&&za.items.setItem(t,JSON.stringify(e))}catch(t){console.warn("set localStorage failed",t)}}static getJSON(t){try{return JSON.parse(za.support?za.items.getItem(t):null)}catch(e){return za.items.getItem(t)}}static removeItem(t){za.support&&za.items.removeItem(t)}static clear(){za.support&&za.items.clear()}}za.support=!1;class ja{show(t=0,e=0,i){}enable(){}hide(){}set_onclick(t){}isCanvasRender(){return!0}renderNotCanvas(t,e,i){}}class Ka extends ja{constructor(){super(...arguments),this._show=!1,this._useCanvas=!1,this._height=100,this._view=[]}show(t=0,e=0,i){this._view.length=i.length;for(let t=0,e=this._view.length;t<e;t++)this._view[t]=i[t];this._show=!0,this._useCanvas?this.createUIPre(t,e):this.createUI(t,e),this.enable()}createUIPre(t,e){var i=We.pixelRatio;this._width=180*i,this._vx=120*i,this._height=i*(12*this._view.length+3*i)+4,Ka._fontSize=12*i;for(var r=0;r<this._view.length;r++)this._view[r].x=4,this._view[r].y=r*Ka._fontSize+2*i;this._canvas||(this._canvas=new ei(!0),this._canvas.size(this._width,this._height),this._ctx=this._canvas.getContext("2d"),this._ctx.textBaseline="top",this._ctx.font=Ka._fontSize+"px Arial",this._canvas.source.style.cssText="pointer-events:none;background:rgba(150,150,150,0.8);z-index:100000;position: absolute;direction:ltr;left:"+t+"px;top:"+e+"px;width:"+this._width/i+"px;height:"+this._height/i+"px;"),We.onKGMiniGame||We.container.appendChild(this._canvas.source),this._first=!0,this.loop(),this._first=!1}createUI(t,e){var i=this._sp,r=We.pixelRatio;i||(i=new Ki,this._leftText=new gr,this._leftText.pos(5,5),this._leftText.color="#ffffff",i.addChild(this._leftText),this._txt=new gr,this._txt.pos(170*r,5),this._txt.color="#ffffff",i.addChild(this._txt),this._sp=i),i.pos(t,e);for(var s="",a=0;a<this._view.length;a++){s+=this._view[a].title+"\n"}this._leftText.text=s;var n=138*r,h=r*(12*this._view.length+3*r)+4;this._txt.fontSize=Ka._fontSize*r,this._leftText.fontSize=Ka._fontSize*r,i.size(n,h),i.graphics.clear(),i.graphics.alpha(.5),i.graphics.drawRect(0,0,n+110,h+30,"#999999"),i.graphics.alpha(2),this.loop()}enable(){n.systemTimer.frameLoop(1,this,this.loop)}hide(){this._show=!1,n.systemTimer.clear(this,this.loop),this._canvas&&We.removeElement(this._canvas.source)}set_onclick(t){this._sp&&this._sp.on("click",this._sp,t),this._canvas&&(this._canvas.source.onclick=t,this._canvas.source.style.pointerEvents="")}loop(){Nt._count++;var t=We.now();if(!(t-Nt._timer<1e3)){var e=Nt._count;if(Nt.FPS=Math.round(1e3*e/(t-Nt._timer)),this._show){Nt.updateEngineData();var i=Nt.FPS>0?Math.floor(1e3/Nt.FPS).toString():" ";Nt._fpsStr=Nt.FPS+(Nt.renderSlow?" slow":"")+" "+i,this.renderInfo(e),Nt.clear()}Nt._count=0,Nt._timer=t}}renderInfo(t){for(var e="",i=0;i<this._view.length;i++){let s=this._view[i],a="average"==s.mode;var r=Nt[s.value];"M"==s.units&&(r=Math.floor(r/1048576*100)/100),"K"==s.units&&(r=Math.floor(r/1024*100)/100),a&&(r/=t,r=Math.floor(r)),"M"==s.units&&(r+="M"),"K"==s.units&&(r+="K"),e+=r+"\n"}this._txt.text=e}isCanvasRender(){return this._useCanvas}renderNotCanvas(t,e,i){this._show&&this._sp&&this._sp.render(t,0,0)}}Ka._fontSize=14;class qa extends Tt{constructor(e){super(st.SKINMESH,0),this.offsetX=300,this.offsetY=0;var r=8*i.BYTES_PE;const s=g.renderEngine.getParams(t.RenderParams.FLOAT);this.position=[2,s,!1,r,0],this.texcoord=[2,s,!1,r,2*i.BYTES_PE],this.color=[4,s,!1,r,4*i.BYTES_PE]}}class $a extends Tt{constructor(t){super(st.PRIMITIVE,0),this._attribLocation=["position",0,"attribColor",1]}}class Za extends Tt{constructor(t=0){super(st.TEXTURE2D,t),this.strength=0,this.blurInfo=null,this.colorMat=null,this.colorAlpha=null,this._attribLocation=["posuv",0,"attribColor",1,"attribFlags",2]}clear(){this.texture=null,this.shader=null,this.defines._value=this.subID}}class Qa{static set cursor(t){Qa._style.cursor=t}static get cursor(){return Qa._style.cursor}static __init__(){Qa._style=We.document.body.style}static hide(){"none"!=Qa.cursor&&(Qa._preCursor=Qa.cursor,Qa.cursor="none")}static show(){"none"==Qa.cursor&&(Qa._preCursor?Qa.cursor=Qa._preCursor:Qa.cursor="auto")}}class Ja extends $t{static __init__(){const e=g.renderEngine.getParams(t.RenderParams.FLOAT);Ja._fixattriInfo=[e,4,0,e,3,16,e,3,28,e,4,40,e,4,56,e,3,72,e,2,84,e,4,92,e,1,108,e,1,112]}constructor(t){super(Ja.const_stride,4*t*Ja.const_stride,4),this.canReuse=!0,this.setAttributes(Ja._fixattriInfo),this.createQuadIB(t),this._quadNum=t,Ja.vertexDeclaration||(Ja.vertexDeclaration=new kt(116,[new Wt(0,Gt.Vector4,0),new Wt(16,Gt.Vector3,1),new Wt(28,Gt.Vector3,2),new Wt(40,Gt.Vector4,3),new Wt(56,Gt.Vector4,4),new Wt(72,Gt.Vector3,5),new Wt(84,Gt.Vector2,6),new Wt(92,Gt.Vector4,7),new Wt(108,Gt.Single,8),new Wt(112,Gt.Single,9)])),this._vb.vertexDeclaration=Ja.vertexDeclaration}setMaxParticleNum(t){this._vb.buffer2D._resizeBuffer(4*t*Ja.const_stride,!1),this.createQuadIB(t)}static getAMesh(t){if(Ja._POOL.length){var e=Ja._POOL.pop();return e.setMaxParticleNum(t),e}return new Ja(t)}releaseMesh(){this._vb.buffer2D.setByteLength(0),this.vertNum=0,this.indexNum=0,Ja._POOL.push(this)}destroy(){this._ib.destroy(),this._vb.destroy(),this._vb.deleteBuffer()}}Ja.const_stride=116,Ja._POOL=[],Ja.vertexDeclaration=null;var tn=!1;class en{static init(...i){if(tn)return Promise.resolve();let r;tn=!0,r="number"==typeof i[0]?{designWidth:i[0],designHeight:i[1]}:i[0],ArrayBuffer.prototype.slice||(ArrayBuffer.prototype.slice=arrayBufferSlice),Float32Array.prototype.slice||(Float32Array.prototype.slice=float32ArraySlice),Uint16Array.prototype.slice||(Uint16Array.prototype.slice=uint16ArraySlice),Uint8Array.prototype.slice||(Uint8Array.prototype.slice=uint8ArraySlice),We.__init__(),_t.__init__();let s=window.Laya3D;if(s){if(!Lr.enable())return Promise.reject("Must support webGL!");Rs.changeWebGLSize=s._changeWebGLSize,ss.is3DMode=!0}var a=We.mainCanvas=new ei(!0),o=a.source.style;return o.position="absolute",o.top=o.left="0px",o.background="#000000",We.onKGMiniGame||We.onAlipayMiniGame||We.container.appendChild(a.source),We.canvas=new ei(!0),We.context=We.canvas.getContext("2d"),We.supportWebAudio=Os.__init__(),We.supportLocalStorage=Ya.__init__(),en.systemTimer=new Es(!1),t.systemTimer=Es.gSysTimer=en.systemTimer,en.physicsTimer=new Es(!1),en.timer=new Es(!1),n.systemTimer=en.systemTimer,t.timer=n.timer=en.timer,t.physicsTimer=n.physicsTimer=en.physicsTimer,en.loader=new ar,n.Laya=en,t.loader=n.loader=en.loader,_s.__init__(),Qa.__init__(),h.beforeInit&&(h.isPlaying?h.beforeInit(r):h.beforeInit=null),h.isConch&&en.enableNative(),Oi.beginCheck(),t.stage=en.stage=new Cs,n.stage=en.stage,h.isConch&&window.conch.setGlobalRepaint&&window.conch.setGlobalRepaint(t.stage.setGlobalRepaint.bind(t.stage)),Zt.__int__(),Jt.__init__(),Qt.__init__(),en.render=new ss(0,0,We.mainCanvas),t.render=en.render,t.stage.size(r.designWidth,r.designHeight),r.scaleMode&&(t.stage.scaleMode=r.scaleMode),r.screenMode&&(t.stage.screenMode=r.screenMode),r.alignV&&(t.stage.alignV=r.alignV),r.alignH&&(t.stage.alignH=r.alignH),e.isAlpha?t.stage.bgColor=null:r.backgroundColor&&(t.stage.bgColor=r.backgroundColor),window.stage=t.stage,et.__init__(),Ja.__init__(),se.__init__(),br.__init__(t.stage,ss.canvas),window.conch&&"conchUseWXAdapter"in We.window&&(as.isAppUseNewInput=!0),as.__init__(),Os.autoStopMusic=!0,Nt._StatRender=new Ka,Tt._initone(st.TEXTURE2D,Za),Tt._initone(st.TEXTURE2D|st.FILTERGLOW,Za),Tt._initone(st.PRIMITIVE,$a),Tt._initone(st.SKINMESH,qa),s?s.__init__().then((()=>{h.afterInit&&(h.isPlaying?h.afterInit():h.afterInit=null)})):(h.afterInit&&(h.isPlaying?h.afterInit():h.afterInit=null),Promise.resolve())}static addWasmModule(t,e,i){en.WasmModules[t]={exports:e,memory:i}}static alertGlobalError(t){var e=0;We.window.onerror=t?function(t,i,r,s,a){e++<5&&a&&this.alert("出错啦，请把此信息截图给研发商\n"+t+"\n"+a.stack)}:null}static _runScript(t){return We.window[en._evcode](t)}static enableDebugPanel(t="libs/laya.debugtool.js"){if(window.Laya.DebugPanel)window.Laya.DebugPanel.enable();else{var e=We.createElement("script");e.onload=function(){window.Laya.DebugPanel.enable()},e.src=t,We.document.body.appendChild(e)}}static enableNative(){en.isNativeRender_enable||(en.isNativeRender_enable=!0,Y.width=We.window.innerWidth,Y.height=We.window.innerHeight,We.measureText=function(t,e){return window.conchTextCanvas.font=e,window.conchTextCanvas.measureText(t)},Cs.clear=function(e){Je.set2DRenderConfig();var i=St.create(e).arrColor;g.renderEngine.clearRenderTexture(t.RenderClearFlag.Color|t.RenderClearFlag.Depth,new Z(i[0],i[1],i[2],i[3]),1),Y.clear()},Ki.drawToCanvas=function(t,e,i,r,s,a){s-=t.x,a-=t.y,s|=0,a|=0,i|=0,r|=0;var n=new ei(!1),h=n.getContext("2d");return n.size(i,r),h.asBitmap=!0,h._targets.start(),se.renders[e]._fun(t,h,s,a),h.flush(),h._targets.end(),h._targets.restore(),n},Object.defineProperty(J.prototype,"uv",{get:function(){return this._uv},set:function(t){this._uv=t}}),ei.prototype.getTexture=function(){return this._texture||(this._texture=this.context._targets,this._texture.uv=J.flipyuv,this._texture.bitmap=this._texture),this._texture})}}function arrayBufferSlice(t,e){var i=new Uint8Array(this,t,e-t),r=new Uint8Array(i.length);return r.set(i),r.buffer}function uint8ArraySlice(){for(var t=this.length,e=new Uint8Array(this.length),i=0;i<t;i++)e[i]=this[i];return e}function float32ArraySlice(){for(var t=this.length,e=new Float32Array(this.length),i=0;i<t;i++)e[i]=this[i];return e}function uint16ArraySlice(...t){var e,i,r;if(0===t.length)for(e=this.length,i=new Uint16Array(e),r=0;r<e;r++)i[r]=this[r];else if(2===t.length){var s=t[0],a=t[1];if(a>s)for(e=a-s,i=new Uint16Array(e),r=s;r<a;r++)i[r-s]=this[r];else i=new Uint16Array(0)}return i}en.stage=null,en.systemTimer=null,en.physicsTimer=null,en.timer=null,en.loader=null,en.isWXOpenDataContext=!1,en.isWXPosMsg=!1,en.WasmModules={},en._evcode="eval",en.isNativeRender_enable=!1,n.Loader=ar,n.Context=Je,n.Browser=We;var rn=en.init;t.stage=void 0,t.systemTimer=void 0,t.physicsTimer=void 0,t.timer=void 0,t.loader=void 0,t.render=void 0;var sn=en.alertGlobalError,an=en.enableDebugPanel;class nn extends c{constructor(){super(...arguments),this.duration=1e3,this.delay=0,this.repeat=0,this.autoDestroyAtComplete=!0}_onAwake(){this.target=this.target||this.owner,this.autoDestroyAtComplete&&(this._comlete=Hi.create(this.target,this.target.destroy,null,!1)),this.eventName?this.owner.on(this.eventName,this,this._exeTween):this._exeTween()}_exeTween(){this._tween=this._doTween(),this._tween.repeat=this.repeat}_doTween(){return null}onReset(){this.duration=1e3,this.delay=0,this.repeat=0,this.ease=null,this.target=null,this.eventName&&(this.owner.off(this.eventName,this,this._exeTween),this.eventName=null),this._comlete&&(this._comlete.recover(),this._comlete=null),this._tween&&(this._tween.clear(),this._tween=null)}}class hn{}hn.STANDARD=0,hn.LEFT=1,hn.RIGHT=2,hn.NUM_PAD=3;class on{}on.NUMBER_0=48,on.NUMBER_1=49,on.NUMBER_2=50,on.NUMBER_3=51,on.NUMBER_4=52,on.NUMBER_5=53,on.NUMBER_6=54,on.NUMBER_7=55,on.NUMBER_8=56,on.NUMBER_9=57,on.A=65,on.B=66,on.C=67,on.D=68,on.E=69,on.F=70,on.G=71,on.H=72,on.I=73,on.J=74,on.K=75,on.L=76,on.M=77,on.N=78,on.O=79,on.P=80,on.Q=81,on.R=82,on.S=83,on.T=84,on.U=85,on.V=86,on.W=87,on.X=88,on.Y=89,on.Z=90,on.F1=112,on.F2=113,on.F3=114,on.F4=115,on.F5=116,on.F6=117,on.F7=118,on.F8=119,on.F9=120,on.F10=121,on.F11=122,on.F12=123,on.F13=124,on.F14=125,on.F15=126,on.NUMPAD=21,on.NUMPAD_0=96,on.NUMPAD_1=97,on.NUMPAD_2=98,on.NUMPAD_3=99,on.NUMPAD_4=100,on.NUMPAD_5=101,on.NUMPAD_6=102,on.NUMPAD_7=103,on.NUMPAD_8=104,on.NUMPAD_9=105,on.NUMPAD_ADD=107,on.NUMPAD_DECIMAL=110,on.NUMPAD_DIVIDE=111,on.NUMPAD_ENTER=108,on.NUMPAD_MULTIPLY=106,on.NUMPAD_SUBTRACT=109,on.SEMICOLON=186,on.EQUAL=187,on.COMMA=188,on.MINUS=189,on.PERIOD=190,on.SLASH=191,on.BACKQUOTE=192,on.LEFTBRACKET=219,on.BACKSLASH=220,on.RIGHTBRACKET=221,on.QUOTE=222,on.ALTERNATE=18,on.BACKSPACE=8,on.CAPS_LOCK=20,on.COMMAND=15,on.CONTROL=17,on.DELETE=46,on.ENTER=13,on.ESCAPE=27,on.PAGE_UP=33,on.PAGE_DOWN=34,on.END=35,on.HOME=36,on.LEFT=37,on.UP=38,on.RIGHT=39,on.DOWN=40,on.SHIFT=16,on.SPACE=32,on.TAB=9,on.INSERT=45;class ln{constructor(){this._idata=[]}getArrayData(){return this._idata}getCount(){return this._idata.length}addShaderUniform(t){this._idata.push(t)}}class _n{static getMCDName(t){return _n._typeToNameDic[t]}static showRenderTypeInfo(t,e=!1){if(e||!_n.showedDic[t]){if(_n.showedDic[t]=!0,!_n._rendertypeToStrDic[t]){var i,r=[];for(i=1;i<=t;)i&t&&r.push(_n.getMCDName(i&t)),i<<=1;_n._rendertypeToStrDic[t]=r.join(",")}console.log("cmd:",_n._rendertypeToStrDic[t])}}static __init__(){_n._typeToNameDic[Mt.ALPHA]="ALPHA",_n._typeToNameDic[Mt.TRANSFORM]="TRANSFORM",_n._typeToNameDic[Mt.TEXTURE]="TEXTURE",_n._typeToNameDic[Mt.GRAPHICS]="GRAPHICS",_n._typeToNameDic[Mt.ONECHILD]="ONECHILD",_n._typeToNameDic[Mt.CHILDS]="CHILDS",_n._typeToNameDic[Mt.TRANSFORM|Mt.ALPHA]="TRANSFORM|ALPHA",_n._typeToNameDic[Mt.CANVAS]="CANVAS",_n._typeToNameDic[Mt.BLEND]="BLEND",_n._typeToNameDic[Mt.FILTERS]="FILTERS",_n._typeToNameDic[Mt.MASK]="MASK",_n._typeToNameDic[Mt.CLIP]="CLIP",_n._typeToNameDic[Mt.LAYAGL3D]="LAYAGL3D"}constructor(){}render(t,e,i){_n._addType(this._renderType),_n.showRenderTypeInfo(this._renderType),se.renders[this._renderType]._fun(this,t,e+this._x,i+this._y),this._repaint=0}_stageRender(t,e,i){_n._countStart(),_n._PreStageRender.call(n.stage,t,e,i),_n._countEnd()}static _countStart(){var t;for(t in _n._countDic)_n._countDic[t]=0}static _countEnd(){_n._i++,_n._i>60&&(_n.showCountInfo(),_n._i=0)}static _addType(t){_n._countDic[t]?_n._countDic[t]+=1:_n._countDic[t]=1}static showCountInfo(){var t;for(t in console.log("==================="),_n._countDic)console.log("count:"+_n._countDic[t]),_n.showRenderTypeInfo(t,!0)}static enableQuickTest(){_n.__init__(),Ki.prototype.render=_n.prototype.render,_n._PreStageRender=Cs.prototype.render,Cs.prototype.render=_n.prototype._stageRender}}_n.showedDic={},_n._rendertypeToStrDic={},_n._typeToNameDic={},_n._countDic={},_n._i=0;class un{load(t){this._url=t;var e=t.toLowerCase().split(".ttf")[0].split("/");this.fontName=e[e.length-1],h.isConch?n.loader.fetch(this._url,"arraybuffer").then((t=>{t&&window.conchTextCanvas.setFontFaceFromBuffer(this.fontName,t),this._complete()})):window.FontFace?this._loadWithFontFace():this._loadWithCSS()}_complete(){n.systemTimer.clear(this,this._complete),n.systemTimer.clear(this,this._checkComplete),this._div&&this._div.parentNode&&(this._div.parentNode.removeChild(this._div),this._div=null),this.complete&&(this.complete.runWith(this),this.complete=null)}_checkComplete(){n.Browser.measureText(un._testString,this._fontTxt).width!=this._txtWidth&&this._complete()}_loadWithFontFace(){var t=new window.FontFace(this.fontName,"url('"+this._url+"')");document.fonts.add(t);var e=this;t.loaded.then((function(){e._complete()})),t.load()}_createDiv(){this._div=We.createElement("div"),this._div.innerHTML="laya";var t=this._div.style;t.fontFamily=this.fontName,t.position="absolute",t.left="-100px",t.top="-100px",document.body.appendChild(this._div)}_loadWithCSS(){var t=We.createElement("style");t.type="text/css",document.body.appendChild(t),t.textContent="@font-face { font-family:'"+this.fontName+"'; src:url('"+this._url+"');}",this._fontTxt="40px "+this.fontName,this._txtWidth=We.measureText(un._testString,this._fontTxt).width;var e=this;t.onload=function(){n.systemTimer.once(1e4,e,e._complete)},n.systemTimer.loop(20,this,this._checkComplete),this._createDiv()}}un._testString="LayaTTFFont";class dn{static enable(t,e,i=2){dn.type=i,n.loader.fetch(t,"json").then((t=>{t?(dn.manifest=t,_t.customFormat=dn.addVersionPrefix,e.run()):console.warn("资源版本清单文件不存在，不使用资源版本管理。忽略ERR_FILE_NOT_FOUND错误。")}))}static addVersionPrefix(t){return dn.manifest&&dn.manifest[t]?dn.type==dn.FILENAME_VERSION?dn.manifest[t]:dn.manifest[t]+"/"+t:t}}dn.FOLDER_VERSION=1,dn.FILENAME_VERSION=2,dn.type=dn.FOLDER_VERSION;class cn extends R{get input(){return this._input}get output(){return this._output}get connected(){return this._connected}get endian(){return this._endian}set endian(t){this._endian=t,null!=this._input&&(this._input.endian=t),null!=this._output&&(this._output.endian=t)}constructor(t=null,e=0,i=null,r=null){super(),this.disableInput=!1,this.protocols=[],this._byteClass=i||I,this.protocols=r,this.endian=cn.BIG_ENDIAN,t&&e>0&&e<65535&&this.connect(t,e)}connect(t,e){var i="ws://"+t+":"+e;this.connectByUrl(i)}connectByUrl(t){null!=this._socket&&this.close(),this._socket&&this.cleanSocket(),this.protocols&&0!=this.protocols.length?this._socket=new We.window.WebSocket(t,this.protocols):this._socket=new We.window.WebSocket(t),this._socket.binaryType="arraybuffer",this._output=new this._byteClass,this._output.endian=this.endian,this._input=new this._byteClass,this._input.endian=this.endian,this._addInputPosition=0,this._socket.onopen=t=>{this._onOpen(t)},this._socket.onmessage=t=>{this._onMessage(t)},this._socket.onclose=t=>{this._onClose(t)},this._socket.onerror=t=>{this._onError(t)}}cleanSocket(){this.close(),this._connected=!1,this._socket.onopen=null,this._socket.onmessage=null,this._socket.onclose=null,this._socket.onerror=null,this._socket=null}close(){if(null!=this._socket)try{this._socket.close()}catch(t){}}_onOpen(t){this._connected=!0,this.event(y.OPEN,t)}_onMessage(t){if(t&&t.data){var e=t.data;if(this.disableInput&&e)this.event(y.MESSAGE,e);else{this._input.length>0&&this._input.bytesAvailable<1&&(this._input.clear(),this._addInputPosition=0);var i=this._input.pos;!this._addInputPosition&&(this._addInputPosition=0),this._input.pos=this._addInputPosition,e&&("string"==typeof e?this._input.writeUTFBytes(e):this._input.writeArrayBuffer(e),this._addInputPosition=this._input.pos,this._input.pos=i),this.event(y.MESSAGE,e)}}}_onClose(t){this._connected=!1,this.event(y.CLOSE,t)}_onError(t){this.event(y.ERROR,t)}send(t){this._socket.send(t)}flush(){if(this._output&&this._output.length>0){var t;try{this._socket&&this._socket.send(this._output.__getBuffer().slice(0,this._output.length))}catch(e){t=e}this._output.endian=this.endian,this._output.clear(),t&&this.event(y.ERROR,t)}}}cn.LITTLE_ENDIAN="littleEndian",cn.BIG_ENDIAN="bigEndian";class pn{static init(){if(!pn.lookup){pn.lookup=new Uint8Array(256);for(var t=0;t<pn.chars.length;t++)pn.lookup[pn.chars.charCodeAt(t)]=t}}static isBase64String(t){return pn.reg.test(t)}static encode(t){var e,i=new Uint8Array(t),r=i.length,s="";for(e=0;e<r;e+=3)s+=pn.chars[i[e]>>2],s+=pn.chars[(3&i[e])<<4|i[e+1]>>4],s+=pn.chars[(15&i[e+1])<<2|i[e+2]>>6],s+=pn.chars[63&i[e+2]];return r%3==2?s=s.substring(0,s.length-1)+"=":r%3==1&&(s=s.substring(0,s.length-2)+"=="),s}static decode(t){pn.init();var e,i,r,s,a,n=.75*t.length,h=t.length,o=0;"="===t[t.length-1]&&(n--,"="===t[t.length-2]&&n--);var l=new ArrayBuffer(n),_=new Uint8Array(l);for(e=0;e<h;e+=4)i=pn.lookup[t.charCodeAt(e)],r=pn.lookup[t.charCodeAt(e+1)],s=pn.lookup[t.charCodeAt(e+2)],a=pn.lookup[t.charCodeAt(e+3)],_[o++]=i<<2|r>>4,_[o++]=(15&r)<<4|s>>2,_[o++]=(3&s)<<6|63&a;return l}}pn.chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",pn.reg=/^\s*data:([a-z]+\/[a-z0-9-+.]+(;[a-z-]+=[a-z0-9-]+)?)?(;base64)?,([a-z0-9!$&',()*+;=\-._~:@\/?%\s]*?)\s*$/i,pn.reghead=/^\s*data:([a-z]+\/[a-z0-9-+.]+(;[a-z-]+=[a-z0-9-]+)?)?(;base64)?,/i,pn.lookup=null;class fn{constructor(){this.reset()}setData(t,e,i,r){return this.char=t,this.charNum=t.charCodeAt(0),this.x=this.y=0,this.width=e,this.height=i,this.style=r,this.isWord=!fn._isWordRegExp.test(t),this}reset(){return this.x=this.y=this.width=this.height=0,this.isWord=!1,this.char=null,this.charNum=0,this.style=null,this}recover(){o.recover("HTMLChar",this.reset())}static create(){return o.getItemByClass("HTMLChar",fn)}_isChar(){return!0}_getCSSStyle(){return this.style}}fn._isWordRegExp=new RegExp("[\\w.]","");class mn{static enable(){mn._logdiv||(mn._logdiv=We.createElement("div"),mn._logdiv.style.cssText="border:white;padding:4px;overflow-y:auto;z-index:1000000;background:rgba(100,100,100,0.6);color:white;position: absolute;left:0px;top:0px;width:50%;height:50%;",We.document.body.appendChild(mn._logdiv),mn._btn=We.createElement("button"),mn._btn.innerText="Hide",mn._btn.style.cssText="z-index:1000001;position: absolute;left:10px;top:10px;",mn._btn.onclick=mn.toggle,We.document.body.appendChild(mn._btn))}static toggle(){var t=mn._logdiv.style;""===t.display?(mn._btn.innerText="Show",t.display="none"):(mn._btn.innerText="Hide",t.display="")}static print(t){mn._logdiv&&(mn._count>=mn.maxCount&&mn.clear(),mn._count++,mn._logdiv.innerText+=t+"\n",mn.autoScrollToBottom&&mn._logdiv.scrollHeight-mn._logdiv.scrollTop-mn._logdiv.clientHeight<50&&(mn._logdiv.scrollTop=mn._logdiv.scrollHeight))}static clear(){mn._logdiv.innerText="",mn._count=0}}mn._count=0,mn.maxCount=50,mn.autoScrollToBottom=!0;class gn{constructor(t,e,i,r){this.scale=1,this.datas=new Array(300),this.datapos=0,this.id=t,this.color=e,this.name=i,this.scale=r}addData(t){this.datas[this.datapos]=t,this.datapos++,this.datapos%=300}}class Tn extends Ki{constructor(){super(),this.datas=[],this.xdata=new Array(Tn.DATANUM),this.ydata=new Array(Tn.DATANUM),this.hud_width=800,this.hud_height=200,this.gMinV=0,this.gMaxV=100,this.textSpace=40,this.sttm=0,Tn.inst=this,this._renderType|=Mt.CUSTOM,this._setRenderType(this._renderType),this._setCustomRender(),this.addDataDef(0,16777215,"frame",1),this.addDataDef(1,65280,"update",1),this.addDataDef(2,16711680,"flush",1),Tn._now=performance?performance.now.bind(performance):Date.now}now(){return Tn._now()}start(){this.sttm=Tn._now()}end(t){var e=Tn._now()-this.sttm;this.updateValue(t,e)}config(t,e){this.hud_width=t,this.hud_height=e}addDataDef(t,e,i,r){this.datas[t]=new gn(t,e,i,r)}updateValue(t,e){this.datas[t].addData(e)}v2y(t){return this._y,this.hud_height,this.gMinV,this.gMaxV,this._y+this.hud_height*(1-(t-this.gMinV)/this.gMaxV)}drawHLine(t,e,i,r){var s=this._x;this._x,this.hud_width;var a=this.v2y(e);t.fillText(r,s,a-6,null,"green",null),s+=this.textSpace,t.fillStyle=i,t.fillRect(s,a,this._x+this.hud_width,1,null)}customRender(t,e,i){var r=performance.now();Tn._lastTm<=0&&(Tn._lastTm=r),this.updateValue(0,r-Tn._lastTm),Tn._lastTm=r,t.save(),t.fillRect(this._x,this._y,this.hud_width,this.hud_height+4,"#000000cc"),t.globalAlpha=.9,this.drawHLine(t,0,"green","    0"),this.drawHLine(t,10,"green","  10"),this.drawHLine(t,16.667,"red"," "),this.drawHLine(t,20,"green","50|20"),this.drawHLine(t,33.334,"yellow",""),this.drawHLine(t,16.667*3,"yellow",""),this.drawHLine(t,66.668,"yellow",""),this.drawHLine(t,50,"green","20|50"),this.drawHLine(t,100,"green","10|100");for(var s=0,a=this.datas.length;s<a;s++){var n=this.datas[s];if(n){var h=n.datas.length,o=(this.hud_width-this.textSpace)/h,l=n.datapos,_=this._x+this.textSpace;t.fillStyle=n.color;for(var u=h;l<u;l++){var d=this.v2y(n.datas[l]*n.scale);t.fillRect(_,d,o,this.hud_height+this._y-d,null),_+=o}for(l=0;l<n.datapos;l++)d=this.v2y(n.datas[l]*n.scale),t.fillRect(_,d,o,this.hud_height+this._y-d,null),_+=o}}t.restore()}}Tn._lastTm=0,Tn._now=null,Tn.DATANUM=300,Tn.drawTexTm=0;class xn{constructor(){this.maxCount=1e3}getCacheList(){return o.getPoolBySign(this.sign)}tryDispose(t){var e;(e=o.getPoolBySign(this.sign)).length>this.maxCount&&e.splice(this.maxCount,e.length-this.maxCount)}static addPoolCacheManager(t,e=100){var i;(i=new xn).sign=t,i.maxCount=e,Oi.regCacheByFunction(i.tryDispose.bind(i),i.getCacheList.bind(i))}}class En{constructor(){this.elements=[],this.length=0}_add(t){this.length===this.elements.length?this.elements.push(t):this.elements[this.length]=t}add(t){let e=this.elements.indexOf(t);"number"!=typeof t&&-1!=e&&e<this.length||(this.length===this.elements.length?this.elements.push(t):this.elements[this.length]=t,this.length++)}indexof(t){let e=this.elements.indexOf(t);return-1!=e&&e<this.length?e:-1}remove(t){let e=this.elements.indexOf(t);-1!=e&&e<this.length&&(this.elements[e]=this.elements[this.length-1],this.length--)}clear(){this.elements=[],this.length=0}destroy(){this.elements=null}}class yn extends R{constructor(){super(...arguments),this._tweenDic={},this._tweenDataList=[],this._currTime=0,this._lastTime=0,this._startTime=0,this._index=0,this._gidIndex=0,this._firstTweenDic={},this._startTimeSort=!1,this._endTimeSort=!1,this._loopKey=!1,this.scale=1,this._frameRate=60,this._frameIndex=0,this._total=0}static to(t,e,i,r=null,s=0){return(new yn).to(t,e,i,r,s)}static from(t,e,i,r=null,s=0){return(new yn).from(t,e,i,r,s)}to(t,e,i,r=null,s=0){return this._create(t,e,i,r,s,!0)}from(t,e,i,r=null,s=0){return this._create(t,e,i,r,s,!1)}_create(t,e,i,r,s,a){var n=o.getItemByClass("tweenData",vn);return n.isTo=a,n.type=0,n.target=t,n.duration=i,n.data=e,n.startTime=this._startTime+s,n.endTime=n.startTime+n.duration,n.ease=r,this._startTime=Math.max(n.endTime,this._startTime),this._tweenDataList.push(n),this._startTimeSort=!0,this._endTimeSort=!0,this}addLabel(t,e){var i=o.getItemByClass("tweenData",vn);return i.type=1,i.data=t,i.endTime=i.startTime=this._startTime+e,this._labelDic||(this._labelDic={}),this._labelDic[t]=i,this._tweenDataList.push(i),this}removeLabel(t){if(this._labelDic&&this._labelDic[t]){var e=this._labelDic[t];if(e){var i=this._tweenDataList.indexOf(e);i>-1&&this._tweenDataList.splice(i,1)}delete this._labelDic[t]}}gotoTime(t){if(null!=this._tweenDataList&&0!=this._tweenDataList.length){var e,i,r,s;for(var a in this._firstTweenDic)if(i=this._firstTweenDic[a])for(var n in i)n in i.diyTarget&&(i.diyTarget[n]=i[n]);for(a in this._tweenDic)(e=this._tweenDic[a]).clear(),delete this._tweenDic[a];if(this._index=0,this._gidIndex=0,this._currTime=t,this._lastTime=We.now(),null==this._endTweenDataList||this._endTimeSort){function Compare(t,e){return t.endTime>e.endTime?1:t.endTime<e.endTime?-1:0}this._endTimeSort=!1,this._endTweenDataList=r=this._tweenDataList.concat(),r.sort(Compare)}else r=this._endTweenDataList;for(var h=0,l=r.length;h<l;h++)if(0==(s=r[h]).type){if(!(t>=s.endTime))break;this._index=Math.max(this._index,h+1);var _=s.data;if(s.isTo)for(var u in _)s.target[u]=_[u]}for(h=0,l=this._tweenDataList.length;h<l;h++)0==(s=this._tweenDataList[h]).type&&t>=s.startTime&&t<s.endTime&&(this._index=Math.max(this._index,h+1),this._gidIndex++,(e=o.getItemByClass("tween",Yi))._create(s.target,s.data,s.duration,s.ease,Hi.create(this,this._animComplete,[this._gidIndex]),0,!1,s.isTo,!0,!1),e.setStartTime(this._currTime-(t-s.startTime)),e._updateEase(this._currTime),e.gid=this._gidIndex,this._tweenDic[this._gidIndex]=e)}}gotoLabel(t){if(null!=this._labelDic){var e=this._labelDic[t];e&&this.gotoTime(e.startTime)}}pause(){n.timer.clear(this,this._update)}resume(){this.play(this._currTime,this._loopKey)}play(t=0,e=!1){if(this._tweenDataList){if(this._startTimeSort){function Compare(t,e){return t.startTime>e.startTime?1:t.startTime<e.startTime?-1:0}this._startTimeSort=!1,this._tweenDataList.sort(Compare);for(var i=0,r=this._tweenDataList.length;i<r;i++){var s=this._tweenDataList[i];if(null!=s&&0==s.type){var a=s.target,h=a.$_GID||(a.$_GID=d.getGID()),o=null;for(var l in null==this._firstTweenDic[h]?((o={}).diyTarget=a,this._firstTweenDic[h]=o):o=this._firstTweenDic[h],s.data)null==o[l]&&(o[l]=a[l])}}}"string"==typeof t?this.gotoLabel(t):this.gotoTime(t),this._loopKey=e,this._lastTime=We.now(),n.timer.frameLoop(1,this,this._update)}}_update(){if(this._currTime>=this._startTime){if(!this._loopKey){for(var t in this._tweenDic)(e=this._tweenDic[t]).complete();return this.pause(),void this._complete()}if(this._complete(),!this._tweenDataList)return;this.gotoTime(0)}var e,i=We.now(),r=i-this._lastTime,s=this._currTime+=r*this.scale;for(t in this._lastTime=i,this._tweenDic)(e=this._tweenDic[t])._updateEase(s);if(0!=this._tweenDataList.length&&this._index<this._tweenDataList.length){var a=this._tweenDataList[this._index];s>=a.startTime&&(this._index++,0==a.type?(this._gidIndex++,(e=o.getItemByClass("tween",Yi))._create(a.target,a.data,a.duration,a.ease,Hi.create(this,this._animComplete,[this._gidIndex]),0,!1,a.isTo,!0,!1),e.setStartTime(s),e.gid=this._gidIndex,this._tweenDic[this._gidIndex]=e,e._updateEase(s)):this.event(y.LABEL,a.data))}}_animComplete(t){this._tweenDic[t]&&delete this._tweenDic[t]}_complete(){this.event(y.COMPLETE)}get index(){return this._frameIndex}set index(t){this._frameIndex=t,this.gotoTime(this._frameIndex/this._frameRate*1e3)}get total(){return this._total=Math.floor(this._startTime/1e3*this._frameRate),this._total}reset(){var t,e,i;if(this._labelDic)for(t in this._labelDic)delete this._labelDic[t];for(t in this._tweenDic)this._tweenDic[t].clear(),delete this._tweenDic[t];for(t in this._firstTweenDic)delete this._firstTweenDic[t];if(this._endTweenDataList=null,this._tweenDataList&&this._tweenDataList.length)for(i=this._tweenDataList.length,e=0;e<i;e++)this._tweenDataList[e]&&this._tweenDataList[e].destroy();this._tweenDataList.length=0,this._currTime=0,this._lastTime=0,this._startTime=0,this._index=0,this._gidIndex=0,this.scale=1,n.timer.clear(this,this._update)}destroy(){this.reset(),this._labelDic=null,this._tweenDic=null,this._tweenDataList=null,this._firstTweenDic=null}}class vn{constructor(){this.type=0,this.isTo=!0}destroy(){this.target=null,this.ease=null,this.data=null,this.isTo=!0,this.type=0,o.recover("tweenData",this)}}class Sn{static create(t){var e=o.getItemByClass("DrawParticleCmd",Sn);return e._templ=t,e}recover(){this._templ=null,o.recover("DrawParticleCmd",this)}run(t,e,i){t.drawParticle(e,i,this._templ)}get cmdID(){return Sn.ID}}Sn.ID="DrawParticleCmd";class Rn{static create(t,e,i){}constructor(t){this.blendType=0}}Rn._blend_All_pool={},Rn._blend_seperate_pool={};class bn{static getHash(t,e,i){return t+(e<<3)+(i<<7)}static getBlendComponent(t,e,i){let r=bn.getHash(t,e,i);return bn._pool[r]||(bn._pool[r]=new bn(t,e,i,r)),bn._pool[r]}constructor(t,e,i,r){this._hashIndex=0,this._hashIndex=r,this._blendOperationGLData=t,this._sourceBlendFactor=e,this._destinationFactor=i}}bn._pool={};var Cn,An,wn,Mn,Dn,In,Pn;t.AttributeType=void 0,(Cn=t.AttributeType||(t.AttributeType={})).box2i="box2i",Cn.box2f="box2f",Cn.chlist="chlist",Cn.chromaticities="chromaticities",Cn.compression="compression",Cn.double="double",Cn.envmap="envmap",Cn.float="float",Cn.int="int",Cn.keycode="keycode",Cn.lineOrder="lineOrder",Cn.m33f="m33f",Cn.m44f="m44f",Cn.preview="preview",Cn.rational="rational",Cn.string="string",Cn.stringvector="stringvector",Cn.titledesc="titledesc",Cn.timecode="timecode",Cn.v2i="v2i",Cn.v2f="v2f",Cn.v3i="v3i",Cn.v3f="v3f";class Bn{constructor(){this._mask=[],this._length=0}_intersectionDefineDatas(t){for(var e=t._mask,i=this._mask,r=this._length-1;r>=0;r--){var s=i[r]&e[r];0==s&&r==this._length-1?this._length--:i[r]=s}}add(t){var e=t._index,i=e+1,r=this._mask,s=this._length;if(s<i){for(r.length<i&&(r.length=i);s<e;s++)r[s]=0;r[e]=t._value,this._length=i}else r[e]|=t._value}remove(t){var e=t._index,i=this._mask,r=this._length-1;if(!(e>r)){var s=i[e]&~t._value;e==r&&0===s?this._length--:i[e]=s}}addDefineDatas(t){var e=t._mask,i=t._length,r=this._mask,s=this._length;if(s<i){r.length=i;for(var a=0;a<s;a++)r[a]|=e[a];for(;a<i;a++)r[a]=e[a];this._length=i}else for(a=0;a<i;a++)r[a]|=e[a]}removeDefineDatas(t){for(var e=t._mask,i=this._mask,r=this._length-1,s=Math.min(t._length,r);s>=0;s--){var a=i[s]&~e[s];s==r&&0===a?(r--,this._length--):i[s]=a}}has(t){var e=t._index;return!(e>=this._length)&&0!=(this._mask[e]&t._value)}clear(){this._length=0}cloneTo(t){var e=t,i=e._mask,r=this._mask,s=this._length;i.length=s;for(var a=0;a<s;a++)i[a]=r[a];e._length=s}clone(){var t=new Bn;return this.cloneTo(t),t}destroy(){delete this._mask}}class Ln{constructor(t,e){this._index=t,this._value=e}}Ln._texGammaDefine={};class Fn{get shader(){return this._shader}get subShaderIndex(){return this._subShaderIndex}get passIndex(){return this._passIndex}get defineNames(){return this._defineNames}constructor(t,e,i,r){this._subShaderIndex=0,this._passIndex=0,this.setValue(t,e,i,r)}setValue(t,e,i,r){if(!t)throw"ShaderVariantInfo:Shader can't be null.";var s=t.getSubShaderAt(e);if(!s)throw`ShaderVariantInfo:Shader don't have subShaderIndex of ${e}.`;var a=s._passes[i];if(!a)throw`ShaderVariantInfo:Shader don't have passIndex of ${i}.`;for(var n=a._validDefine,h=0,o=r.length;h<o;h++){var l=r[h];if(!n.has(Xn.getDefineByName(l)))throw`ShaderVariantInfo:Invalid defineName ${l} in ${t._name} subShaderIndex of ${e} passIndex of ${i}.`}this._shader=t,this._subShaderIndex=e,this._passIndex=i,this._defineNames=r}equal(t){if(this._shader!==t._shader||this._subShaderIndex!==t._subShaderIndex||this._passIndex!==t._passIndex)return!1;var e=this._defineNames,i=t._defineNames;if(e.length!==i.length)return!1;for(var r=0,s=this._defineNames.length;r<s;r++)if(e[r]!==i[r])return!1;return!0}clone(){return new Fn(this._shader,this._subShaderIndex,this._passIndex,this._defineNames.slice())}}class On{constructor(){this._allCompiled=!1,this._variants=[]}get allCompiled(){return this._allCompiled}get variantCount(){return this._variants.length}add(t){for(var e=0,i=this._variants.length;e<i;e++)if(this._variants[e].equal(t))return!1;return this._variants.push(t.clone()),this._allCompiled=!1,!0}remove(t){for(var e=0,i=this._variants.length;e<i;e++)if(this._variants[e].equal(t))return this._variants.splice(e,1),!0;return!1}contatins(t){for(var e=0,i=this._variants.length;e<i;e++)if(this._variants[e].equal(t))return!0;return!1}getByIndex(t){return this._variants[t]}clear(){this._variants.length=0}compile(){if(!this._allCompiled){for(var t=this._variants,e=0,i=t.length;e<i;e++){var r=t[e];Xn.compileShaderByDefineNames(r._shader._name,r._subShaderIndex,r._passIndex,r._defineNames)}this._allCompiled=!0}}}t.ShaderDataType=void 0,(An=t.ShaderDataType||(t.ShaderDataType={}))[An.Int=0]="Int",An[An.Bool=1]="Bool",An[An.Float=2]="Float",An[An.Vector2=3]="Vector2",An[An.Vector3=4]="Vector3",An[An.Vector4=5]="Vector4",An[An.Color=6]="Color",An[An.Matrix4x4=7]="Matrix4x4",An[An.Texture2D=8]="Texture2D",An[An.TextureCube=9]="TextureCube",An[An.Buffer=10]="Buffer";class Nn{get uniformBufferDatas(){return this._uniformBufferDatas}get uniformBuffersMap(){return this._uniformBuffersMap}constructor(t=null){this._ownerResource=null,this._data=null,this._defineDatas=new Bn,this._ownerResource=t,this._initData(),this._uniformBufferDatas=new Map,this._uniformBuffersMap=new Map}_addCheckUBO(t,e,i){this._uniformBufferDatas.set(t,e),i._uniformParamsState.forEach(((t,i)=>{this.uniformBuffersMap.set(i,e)})),e.setDataByUniformBufferData(i)}_initData(){this._data={},this._gammaColorMap=new Map}getData(){return this._data}addDefine(t){this._defineDatas.add(t)}removeDefine(t){this._defineDatas.remove(t)}hasDefine(t){return this._defineDatas.has(t)}clearDefine(){this._defineDatas.clear()}getBool(t){return this._data[t]}setBool(t,e){this._data[t]=e}getInt(t){return this._data[t]}setInt(t,e){this._data[t]=e;let i=this._uniformBuffersMap.get(t);i&&(i._updateDataInfo._setData(t,this.getInt(t)),i.setDataByUniformBufferData(i._updateDataInfo))}getNumber(t){return this._data[t]}setNumber(t,e){this._data[t]=e;let i=this._uniformBuffersMap.get(t);i&&(i._updateDataInfo._setData(t,this.getNumber(t)),i.setDataByUniformBufferData(i._updateDataInfo))}getVector2(t){return this._data[t]}setVector2(t,e){this._data[t]?e.cloneTo(this._data[t]):this._data[t]=e.clone();let i=this._uniformBuffersMap.get(t);i&&(i._updateDataInfo._setData(t,this.getVector2(t)),i.setDataByUniformBufferData(i._updateDataInfo))}getVector3(t){return this._data[t]}setVector3(t,e){this._data[t]?e.cloneTo(this._data[t]):this._data[t]=e.clone();let i=this._uniformBuffersMap.get(t);i&&(i._updateDataInfo._setData(t,this.getVector3(t)),i.setDataByUniformBufferData(i._updateDataInfo))}getVector(t){return this._data[t]}setVector(t,e){this._data[t]?e.cloneTo(this._data[t]):this._data[t]=e.clone();let i=this._uniformBuffersMap.get(t);i&&(i._updateDataInfo._setData(t,this.getVector(t)),i.setDataByUniformBufferData(i._updateDataInfo))}getColor(t){return this._gammaColorMap.get(t)}setColor(t,e){if(!e)return;if(this._data[t]){let i=this._gammaColorMap.get(t);e.cloneTo(i);let r=this._data[t];r.x=Z.gammaToLinearSpace(e.r),r.y=Z.gammaToLinearSpace(e.g),r.z=Z.gammaToLinearSpace(e.b),r.w=e.a}else{let i=new je;i.x=Z.gammaToLinearSpace(e.r),i.y=Z.gammaToLinearSpace(e.g),i.z=Z.gammaToLinearSpace(e.b),i.w=e.a,this._data[t]=i,this._gammaColorMap.set(t,e.clone())}let i=this._uniformBuffersMap.get(t);i&&(i._updateDataInfo._setData(t,this.getLinearColor(t)),i.setDataByUniformBufferData(i._updateDataInfo))}getLinearColor(t){return this._data[t]}getMatrix4x4(t){return this._data[t]}setMatrix4x4(t,e){this._data[t]?e.cloneTo(this._data[t]):this._data[t]=e.clone();let i=this._uniformBuffersMap.get(t);i&&(i._updateDataInfo._setData(t,this.getVector(t)),i.setDataByUniformBufferData(i._updateDataInfo))}getBuffer(t){return this._data[t]}setBuffer(t,e){this._data[t]=e}setTexture(t,e){var i=this._data[t];if(e){let i=Ln._texGammaDefine[t];i&&e&&e.gammaCorrection>1?this.addDefine(i):i&&this.removeDefine(i)}this._data[t]=e||X.erroTextur,i&&i._removeReference(),e&&e._addReference()}getTexture(t){return this._data[t]}setValueData(t,e){if(e instanceof Z)return void this.setColor(t,e);e&&e.clone?this._data[t]=e.clone():this._data[t]=e;let i=this._uniformBuffersMap.get(t);i&&(i._updateDataInfo._setData(t,this.getValueData(t)),i.setDataByUniformBufferData(i._updateDataInfo))}setUniformBuffer(t,e){this._data[t]=e}getUniformBuffer(t){return this._data[t]}setShaderData(e,i,r){switch(i){case t.ShaderDataType.Int:this.setInt(e,r);break;case t.ShaderDataType.Bool:this.setBool(e,r);break;case t.ShaderDataType.Float:this.setNumber(e,r);break;case t.ShaderDataType.Vector2:this.setVector2(e,r);break;case t.ShaderDataType.Vector3:this.setVector3(e,r);break;case t.ShaderDataType.Vector4:this.setVector(e,r);break;case t.ShaderDataType.Color:this.setColor(e,r);break;case t.ShaderDataType.Matrix4x4:this.setMatrix4x4(e,r);break;case t.ShaderDataType.Texture2D:case t.ShaderDataType.TextureCube:this.setTexture(e,r);break;case t.ShaderDataType.Buffer:this.setBuffer(e,r);break;default:throw"unkone shader data type."}}getShaderData(e,i){switch(i){case t.ShaderDataType.Int:return this.getInt(e);case t.ShaderDataType.Bool:return this.getBool(e);case t.ShaderDataType.Float:return this.getNumber(e);case t.ShaderDataType.Vector2:return this.getVector2(e);case t.ShaderDataType.Vector3:return this.getVector3(e);case t.ShaderDataType.Vector4:return this.getVector(e);case t.ShaderDataType.Color:return this.getColor(e);case t.ShaderDataType.Matrix4x4:return this.getMatrix4x4(e);case t.ShaderDataType.Texture2D:case t.ShaderDataType.TextureCube:return this.getTexture(e);case t.ShaderDataType.Buffer:return this.getBuffer(e);default:throw"unkone shader data type."}}getValueData(t){return this._data[t]}cloneTo(t){var e=t,i=e._data;for(var r in this._data){var s=this._data[r];if(null!=s)if("number"==typeof s)i[r]=s;else if("number"==typeof s)i[r]=s;else if("boolean"==typeof s)i[r]=s;else if(s instanceof ze){var a=i[r]||(i[r]=new ze);s.cloneTo(a),i[r]=a}else if(s instanceof Ke){var n=i[r]||(i[r]=new Ke);s.cloneTo(n),i[r]=n}else if(s instanceof je){let e=this.getColor(parseInt(r));if(e){let i=e.clone();t.setColor(parseInt(r),i)}else{var h=i[r]||(i[r]=new je);s.cloneTo(h),i[r]=h}}else if(s instanceof ma){var o=i[r]||(i[r]=new ma);s.cloneTo(o),i[r]=o}else s instanceof D&&(i[r]=s,s._addReference())}this._defineDatas.cloneTo(e._defineDatas),this._gammaColorMap.forEach(((e,i)=>{t._gammaColorMap.set(i,e.clone())}))}clone(){var t=new Nn;return this.cloneTo(t),t}reset(){for(var t in this._data){var e=this._data[t];e instanceof M&&e._removeReference()}this._data={},this._gammaColorMap.clear(),this._uniformBufferDatas.clear(),this._uniformBuffersMap.clear(),this._defineDatas.clear()}destroy(){for(var t in this._defineDatas.destroy(),this._defineDatas=null,this._data){var e=this._data[t];e instanceof M&&e._removeReference()}this._data=null,this._gammaColorMap.clear(),this._gammaColorMap=null,delete this._uniformBufferDatas,delete this._uniformBuffersMap,this._uniformBufferDatas=null,this._uniformBuffersMap=null}}class Un{constructor(t,e,i){this._validDefine=new Bn,this._cacheShaderHierarchy=1,this._cacheSharders={},this._owner=t,this.name=e,this._VS=i.vsNode,this._PS=i.psNode,this._defs=i.defs;for(let t of i.defs)this._validDefine.add(Xn.getDefineByName(t))}_resizeCacheShaderMap(t,e,i){var r=this._cacheShaderHierarchy-1;if(e==r)for(var s in t)for(var a=t[s],n=0,h=i-r;n<h;n++)n==h-1?t[0]=a:t=t[0==n?s:0]={};else for(var s in++e,t)this._resizeCacheShaderMap(t[s],e,i)}withCompile(t){var e,i=Un._debugDefineString,r=Un._debugDefineMask;t._intersectionDefineDatas(this._validDefine),Xn.debugMode&&(e=t._length);var s=this._cacheSharders,a=t._length;a>this._cacheShaderHierarchy&&(this._resizeCacheShaderMap(s,0,a),this._cacheShaderHierarchy=a);for(var n=t._mask,h=t._length-1,o=this._cacheShaderHierarchy-1,l=0;l<o;l++){var _=h<l?0:n[l],u=s[_];u||(s[_]=u={}),s=u}var d=h<o?0:n[o],c=s[d];if(c)return c;var p=Un._defineString;Xn._getNamesByDefineData(t,p);var f,m,T={},x="";Lr._isWebGL2?(f="#version 300 es\n\n                #define attribute in\n                #define varying out\n                #define textureCube texture\n                #define texture2D texture\n",m="#version 300 es\n\n                #define varying in\n                out highp vec4 pc_fragColor;\n                #define gl_FragColor pc_fragColor\n                #define gl_FragDepthEXT gl_FragDepth\n                #define texture2D texture\n                #define textureCube texture\n                #define texture2DProj textureProj\n                #define texture2DLodEXT textureLod\n                #define texture2DProjLodEXT textureProjLod\n                #define textureCubeLodEXT textureLod\n                #define texture2DGradEXT textureGrad\n                #define texture2DProjGradEXT textureProjGrad\n                #define textureCubeGradEXT textureGrad\n"):(f="",m="#ifdef GL_EXT_shader_texture_lod\n                    #extension GL_EXT_shader_texture_lod : enable\n                #endif\n                #if !defined(GL_EXT_shader_texture_lod)\n                    #define texture1DLodEXT texture1D\n                    #define texture2DLodEXT texture2D\n                    #define texture2DProjLodEXT texture2DProj\n                    #define texture3DLodEXT texture3D\n                    #define textureCubeLodEXT textureCube\n                #endif\n");l=0;for(var E=p.length;l<E;l++){var y=p[l];x+="#define "+y+"\n",T[y]=!0}var v=this._VS.toscript(T,[]),S="";0==v[0].indexOf("#version")&&(S=v[0]+"\n",v.shift());var R=this._PS.toscript(T,[]),b="";if(0==R[0].indexOf("#version")&&(b=R[0]+"\n",R.shift()),c=g.renderOBJCreate.createShaderInstance(S+f+x+v.join("\n"),b+m+x+R.join("\n"),this._owner._attributeMap,this),s[d]=c,Xn.debugMode){var C="",A="";for(l=0,E=e;l<E;l++)A+=l==E-1?r[l]:r[l]+",";for(l=0,E=i.length;l<E;l++)C+=l==E-1?i[l]:i[l]+",";console.log("%cLayaAir: Shader Compile Information---ShaderName:"+this.name+"  DefineMask:["+A+"] DefineNames:["+C+"]","color:green")}return c}}Un._defineString=[],Un._debugDefineString=[],Un._debugDefineMask=[];class Gn{static glslAttributeString(t){let e="";for(const i in t){e=`${e}attribute ${getAttributeType(t[i][1])} ${i};\n`}return e}static glslUniformString(t,e){if(e){let e="",i="";for(const r in t)if("object"==typeof t[r]){let i=t[r];e+=`uniform ${r} {\n`;for(const t in i){e+=`${getAttributeType(i[t])} ${t};\n`}e+="};\n"}else{i+=`uniform ${getAttributeType(t[r])} ${r};\n`}return e+i}{let e="";for(const i in t)if("object"==typeof t[i]){let r=t[i];for(const t in r){e+=`uniform ${getAttributeType(r[t])} ${t};\n`}}else{e+=`uniform ${getAttributeType(t[i])} ${i};\n`}return e}}}function getAttributeType(e){switch(e){case t.ShaderDataType.Int:return"int";case t.ShaderDataType.Bool:return"bool";case t.ShaderDataType.Float:return"float";case t.ShaderDataType.Vector2:return"vec2";case t.ShaderDataType.Vector3:return"vec3";case t.ShaderDataType.Vector4:case t.ShaderDataType.Color:return"vec4";case t.ShaderDataType.Matrix4x4:return"mat4";case t.ShaderDataType.Texture2D:return"sampler2D";case t.ShaderDataType.TextureCube:return"samplerCube";default:return""}}class kn extends Un{get renderState(){return this._renderState}constructor(t,e){super(t,null,e),this._tags={},this.statefirst=!1,this._renderState=g.renderOBJCreate.createRenderState(),this._renderState.setNull()}_addDebugShaderVariantCollection(t,e,i){var r=Xn._debugShaderVariantInfo,s=this._owner,a=s._owner,n=t._mask;Xn._getNamesByDefineData(t,e),i.length=n.length;for(var h=0,o=n.length;h<o;h++)i[h]=n[h];r?r.setValue(a,a._subShaders.indexOf(s),s._passes.indexOf(this),e):Xn._debugShaderVariantInfo=r=new Fn(a,a._subShaders.indexOf(s),s._passes.indexOf(this),e),Xn.debugShaderVariantCollection.add(r)}withCompile(e){var i,r=kn._debugDefineStrings,s=kn._debugDefineMasks;e._intersectionDefineDatas(this._validDefine),Xn.debugMode&&(i=e._length,this._addDebugShaderVariantCollection(e,r,s));var a=this._cacheSharders,n=e._length;n>this._cacheShaderHierarchy&&(this._resizeCacheShaderMap(a,0,n),this._cacheShaderHierarchy=n);for(var h=e._mask,o=e._length-1,l=this._cacheShaderHierarchy-1,_=0;_<l;_++){var u=o<_?0:h[_],d=a[u];d||(a[u]=d={}),a=d}var c=o<l?0:h[l],p=a[c];if(p)return p;var f=kn._defineStrings;Xn._getNamesByDefineData(e,f);var m,T,x=qe.lightClusterCount,E={},y="";let v=this._owner._attributeMap,S=this._owner._uniformMap,R=qe._uniformBlock,b=Gn.glslAttributeString(v),C=Gn.glslUniformString(S,R);Lr._isWebGL2?(m=`#version 300 es\n#if defined(GL_FRAGMENT_PRECISION_HIGH)\n    precision highp float;\n    precision highp int;\n#else\n    precision mediump float;\n    precision mediump int;\n#endif\nlayout(std140, column_major) uniform;\n#define attribute in\n#define varying out\n#define textureCube texture\n#define texture2D texture\n${b}\n${C}\n`,T=`#version 300 es\n#if defined(GL_FRAGMENT_PRECISION_HIGH)\n    precision highp float;\n    precision highp int;\n#else\n    precision mediump float;\n    precision mediump int;\n#endif\nlayout(std140, column_major) uniform;\n#define varying in\nout highp vec4 pc_fragColor;\n#define gl_FragColor pc_fragColor\n#define gl_FragDepthEXT gl_FragDepth\n#define texture2D texture\n#define textureCube texture\n#define texture2DProj textureProj\n#define texture2DLodEXT textureLod\n#define texture2DProjLodEXT textureProjLod\n#define textureCubeLodEXT textureLod\n#define texture2DGradEXT textureGrad\n#define texture2DProjGradEXT textureProjGrad\n#define textureCubeGradEXT textureGrad\n${C}`):(m=`#if defined(GL_FRAGMENT_PRECISION_HIGH)\n    precision highp float;\n    precision highp int;\n#else\n    precision mediump float;\n    precision mediump int;\n#endif\n${b}\n${C}`,T=`#ifdef GL_EXT_shader_texture_lod\n    #extension GL_EXT_shader_texture_lod : enable\n#endif\n\n#if defined(GL_FRAGMENT_PRECISION_HIGH)\n    precision highp float;\n    precision highp int;\n#else\n    precision mediump float;\n    precision mediump int;\n#endif\n\n#if !defined(GL_EXT_shader_texture_lod)\n    #define texture1DLodEXT texture1D\n    #define texture2DLodEXT texture2D\n    #define texture2DProjLodEXT texture2DProj\n    #define texture3DLodEXT texture3D\n    #define textureCubeLodEXT textureCube\n#endif\n${C}`),y+="#define MAX_LIGHT_COUNT "+qe.maxLightCount+"\n",y+="#define MAX_LIGHT_COUNT_PER_CLUSTER "+qe._maxAreaLightCountPerClusterAverage+"\n",y+="#define CLUSTER_X_COUNT "+x.x+"\n",y+="#define CLUSTER_Y_COUNT "+x.y+"\n",y+="#define CLUSTER_Z_COUNT "+x.z+"\n",y+="#define SHADER_CAPAILITY_LEVEL "+g.renderEngine.getParams(t.RenderParams.SHADER_CAPAILITY_LEVEL)+"\n";_=0;for(var A=f.length;_<A;_++){var w=f[_];y+="#define "+w+"\n",E[w]=!0}var M=this._VS.toscript(E,[]),D="";0==M[0].indexOf("#version")&&(D=M[0]+"\n",M.shift());var I=this._PS.toscript(E,[]),P="";if(0==I[0].indexOf("#version")&&(P=I[0]+"\n",I.shift()),p=g.renderOBJCreate.createShaderInstance(D+m+y+M.join("\n"),P+T+y+I.join("\n"),this._owner._attributeMap,this),a[c]=p,Xn.debugMode){var B="",L="";for(_=0,A=i;_<A;_++)L+=_==A-1?s[_]:s[_]+",";for(_=0,A=r.length;_<A;_++)B+=_==A-1?r[_]:r[_]+",";console.log("%cLayaAir: Shader Compile Information---ShaderName:"+this._owner._owner._name+" SubShaderIndex:"+this._owner._owner._subShaders.indexOf(this._owner)+" PassIndex:"+this._owner._passes.indexOf(this)+" DefineMask:["+L+"] DefineNames:["+B+"]","color:green")}return p}}kn._defineStrings=[],kn._debugDefineStrings=[],kn._debugDefineMasks=[];class Wn{static __init__(){Wn.instanceWorldMatrixDeclaration=new kt(64,[new Wt(0,Gt.Vector4,Wn.MESH_WORLDMATRIX_ROW0),new Wt(16,Gt.Vector4,Wn.MESH_WORLDMATRIX_ROW1),new Wt(32,Gt.Vector4,Wn.MESH_WORLDMATRIX_ROW2),new Wt(48,Gt.Vector4,Wn.MESH_WORLDMATRIX_ROW3)]),Wn.instanceSimpleAnimatorDeclaration=new kt(16,[new Wt(0,Gt.Vector4,Wn.MESH_SIMPLEANIMATOR)])}static getVertexDeclaration(t,e=!0){var i=Wn._vertexDeclarationMap[t+(e?"_0":"_1")];if(!i){for(var r=t.split(","),s=0,a=[],n=0,h=r.length;n<h;n++){var o;switch(r[n]){case"POSITION":o=new Wt(s,Gt.Vector3,Wn.MESH_POSITION0),s+=12;break;case"NORMAL":o=new Wt(s,Gt.Vector3,Wn.MESH_NORMAL0),s+=12;break;case"COLOR":o=new Wt(s,Gt.Vector4,Wn.MESH_COLOR0),s+=16;break;case"UV":o=new Wt(s,Gt.Vector2,Wn.MESH_TEXTURECOORDINATE0),s+=8;break;case"UV1":o=new Wt(s,Gt.Vector2,Wn.MESH_TEXTURECOORDINATE1),s+=8;break;case"BLENDWEIGHT":o=new Wt(s,Gt.Vector4,Wn.MESH_BLENDWEIGHT0),s+=16;break;case"BLENDINDICES":e?(o=new Wt(s,Gt.Vector4,Wn.MESH_BLENDINDICES0),s+=16):(o=new Wt(s,Gt.Byte4,Wn.MESH_BLENDINDICES0),s+=4);break;case"TANGENT":o=new Wt(s,Gt.Vector4,Wn.MESH_TANGENT0),s+=16;break;case"NORMAL_BYTE":o=new Wt(s,Gt.NorByte4,Wn.MESH_NORMAL0),s+=4;break;default:throw"VertexMesh: unknown vertex flag."}a.push(o)}i=new kt(s,a),Wn._vertexDeclarationMap[t+(e?"_0":"_1")]=i}return i}}Wn.MESH_POSITION0=0,Wn.MESH_COLOR0=1,Wn.MESH_TEXTURECOORDINATE0=2,Wn.MESH_NORMAL0=3,Wn.MESH_TANGENT0=4,Wn.MESH_BLENDINDICES0=5,Wn.MESH_BLENDWEIGHT0=6,Wn.MESH_TEXTURECOORDINATE1=7,Wn.MESH_WORLDMATRIX_ROW0=8,Wn.MESH_WORLDMATRIX_ROW1=9,Wn.MESH_WORLDMATRIX_ROW2=10,Wn.MESH_WORLDMATRIX_ROW3=11,Wn.MESH_SIMPLEANIMATOR=12,Wn.MESH_CUSTOME0=12,Wn.MESH_CUSTOME1=13,Wn.MESH_CUSTOME2=14,Wn.MESH_CUSTOME3=15,Wn._vertexDeclarationMap={};class Vn{static regIncludeBindUnifrom(t,e,i){let r={},s=r[t]={};s.uniformMap=e,s.defaultValue=i,Object.assign(Vn.IncludeUniformMap,r)}static __init__(){let t={s_Cull:Xn.RENDER_STATE_CULL,s_Blend:Xn.RENDER_STATE_BLEND,s_BlendSrc:Xn.RENDER_STATE_BLEND_SRC,s_BlendDst:Xn.RENDER_STATE_BLEND_DST,s_BlendSrcRGB:Xn.RENDER_STATE_BLEND_SRC_RGB,s_BlendDstRGB:Xn.RENDER_STATE_BLEND_DST_RGB,s_BlendSrcAlpha:Xn.RENDER_STATE_BLEND_SRC_ALPHA,s_BlendDstAlpha:Xn.RENDER_STATE_BLEND_DST_ALPHA,s_BlendEquation:Xn.RENDER_STATE_BLEND_EQUATION,s_BlendEquationRGB:Xn.RENDER_STATE_BLEND_EQUATION_RGB,s_BlendEquationAlpha:Xn.RENDER_STATE_BLEND_EQUATION_ALPHA,s_DepthTest:Xn.RENDER_STATE_DEPTH_TEST,s_DepthWrite:Xn.RENDER_STATE_DEPTH_WRITE,s_StencilRef:Xn.RENDER_STATE_STENCIL_REF,s_StencilTest:Xn.RENDER_STATE_STENCIL_TEST,s_StencilWrite:Xn.RENDER_STATE_STENCIL_WRITE,s_StencilOp:Xn.RENDER_STATE_STENCIL_OP};this.StateParamsMap={};for(let e in t)this.StateParamsMap[t[e]]=Xn.propertyNameToID(e);Vn.IncludeUniformMap={}}constructor(e=Vn.DefaultAttributeMap,i={},r=null){this._uniformBufferDataMap=new Map,this._flags={},this._passes=[],this._attributeMap=e,this._uniformMap=i,this._uniformDefaultValue=r,this._uniformTypeMap=new Map;for(const e in i)if("object"==typeof i[e]){let t=i[e],r=new Map;for(const e in t){let i=ShaderDataTypeToUniformBufferType(t[e]);r.set(e,i),this._uniformTypeMap.set(e,t[e])}let s=new Map;r.forEach(((t,e)=>{s.set(Xn.propertyNameToID(e),t)}));let a=new Hn(s);this._uniformBufferDataMap.set(e,a)}else{let r=i[e];if(this._uniformTypeMap.set(e,r),r==t.ShaderDataType.Texture2D||r==t.ShaderDataType.TextureCube){let t=Xn.getDefineByName(`Gamma_${e}`),i=Xn.propertyNameToID(e);Ln._texGammaDefine[i]=t}}}setFlag(t,e){e?this._flags[t]=e:delete this._flags[t]}getFlag(t){return this._flags[t]}addShaderPass(t,e,i="Forward"){return this._addShaderPass(ft.compile(t,e),i)}_addShaderPass(t,e="Forward"){var i=new kn(this,t);return i._pipelineMode=e,this._passes.push(i),this._addIncludeUniform(t.includeNames),i}_addIncludeUniform(t){for(let i of t)if(Vn.IncludeUniformMap[i]){let t=Vn.IncludeUniformMap[i],r=t.uniformMap,s=t.defaultValue;for(var e in r)this._uniformTypeMap.has(e)||(this._uniformTypeMap.set(e,r[e]),this._uniformMap[e]=r[e]);for(var e in s)this._uniformDefaultValue[e]||(this._uniformDefaultValue[e]=s[e])}}}function ShaderDataTypeToUniformBufferType(e){switch(e){case t.ShaderDataType.Float:return t.UniformBufferParamsType.Number;case t.ShaderDataType.Vector2:return t.UniformBufferParamsType.Vector2;case t.ShaderDataType.Vector3:return t.UniformBufferParamsType.Vector3;case t.ShaderDataType.Vector4:case t.ShaderDataType.Color:return t.UniformBufferParamsType.Vector4;case t.ShaderDataType.Matrix4x4:return t.UniformBufferParamsType.Matrix4x4;default:throw"ShaderDataType can not be in UniformBuffer."}}Vn.DefaultAttributeMap={a_Position:[Wn.MESH_POSITION0,t.ShaderDataType.Vector4],a_Normal:[Wn.MESH_NORMAL0,t.ShaderDataType.Vector3],a_Tangent0:[Wn.MESH_TANGENT0,t.ShaderDataType.Vector4],a_Texcoord0:[Wn.MESH_TEXTURECOORDINATE0,t.ShaderDataType.Vector2],a_Texcoord1:[Wn.MESH_TEXTURECOORDINATE1,t.ShaderDataType.Vector2],a_Color:[Wn.MESH_COLOR0,t.ShaderDataType.Vector4],a_BoneWeights:[Wn.MESH_BLENDWEIGHT0,t.ShaderDataType.Vector4],a_BoneIndices:[Wn.MESH_BLENDINDICES0,t.ShaderDataType.Vector4],a_WorldMat:[Wn.MESH_WORLDMATRIX_ROW0,t.ShaderDataType.Matrix4x4],a_SimpleTextureParams:[Wn.MESH_SIMPLEANIMATOR,t.ShaderDataType.Vector2]};class Xn{static _getNamesByDefineData(t,e){var i=Xn._maskMap,r=t._mask;e.length=0;for(var s=0,a=t._length;s<a;s++)for(var n=i[s],h=r[s],o=0;o<32;o++){var l=1<<o;if(h>0&&l>h)break;h&l&&e.push(n[l])}}static getDefineByName(t){var e=Xn._defineMap[t];if(!e){var i=Xn._maskMap,r=Xn._defineCounter,s=Math.floor(r/32),a=1<<r%32;e=new Ln(s,a),Xn._defineMap[t]=e,s==i.length&&(i.length++,i[s]={}),i[s][a]=t,Xn._defineCounter++}return e}static propertyNameToID(t){return g.renderEngine.propertyNameToID(t)}static propertyIDToName(t){return g.renderEngine.propertyIDToName(t)}static addInclude(t,e){ft.addInclude(t,e)}static compileShaderByDefineNames(t,e,i,r){var s=Xn.find(t);if(s){var a=s.getSubShaderAt(e);if(a){var n=a._passes[i];if(n){var h=Xn._compileDefineDatas;h.clear();for(var o=0,l=r.length;o<l;o++)h.add(Xn.getDefineByName(r[o]));h.addDefineDatas(Xn._configDefineValues),n.withCompile(h)}else console.warn("Shader3D: unknown passIndex.")}else console.warn("Shader3D: unknown subShaderIndex.")}else console.warn("Shader3D: unknown shader name.")}static add(t,e=!1,i=!1){return Xn._preCompileShader[t]=new Xn(t,e,i)}static find(t){return Xn._preCompileShader[t]}static parse(t,e){t.name&&t.uniformMap||console.error("TODO");let i=Xn.add(t.name,t.enableInstancing,t.supportReflectionProbe),r=new Vn(t.attributeMap?t.attributeMap:Vn.DefaultAttributeMap,t.uniformMap,t.defaultValue);i.addSubShader(r);let s=t.shaderPass;for(var a in s){let t=s[a];r._addShaderPass(ft.compile(t.VS,t.FS,e),t.pipeline)}return i}get name(){return this._name}constructor(t,e,i){this._enableInstancing=!1,this._supportReflectionProbe=!1,this._subShaders=[],this._name=t,this._enableInstancing=e,this._supportReflectionProbe=i}addSubShader(t){this._subShaders.push(t),t._owner=this}getSubShaderAt(t){return this._subShaders[t]}static compileShader(t,e,i,...r){var s=Xn.find(t);if(s){var a=s.getSubShaderAt(e);if(a){var n=a._passes[i];if(n){var h=Xn._compileDefineDatas,o=h._mask;o.length=0;for(var l=0,_=r.length;l<_;l++)o.push(r[l]);h._length=r.length,n.withCompile(h)}else console.warn("Shader3D: unknown passIndex.")}else console.warn("Shader3D: unknown subShaderIndex.")}else console.warn("Shader3D: unknown shader name.")}}Xn._configDefineValues=new Bn,Xn._compileDefineDatas=new Bn,Xn.RENDER_STATE_CULL=0,Xn.RENDER_STATE_BLEND=1,Xn.RENDER_STATE_BLEND_SRC=2,Xn.RENDER_STATE_BLEND_DST=3,Xn.RENDER_STATE_BLEND_SRC_RGB=4,Xn.RENDER_STATE_BLEND_DST_RGB=5,Xn.RENDER_STATE_BLEND_SRC_ALPHA=6,Xn.RENDER_STATE_BLEND_DST_ALPHA=7,Xn.RENDER_STATE_BLEND_CONST_COLOR=8,Xn.RENDER_STATE_BLEND_EQUATION=9,Xn.RENDER_STATE_BLEND_EQUATION_RGB=10,Xn.RENDER_STATE_BLEND_EQUATION_ALPHA=11,Xn.RENDER_STATE_DEPTH_TEST=12,Xn.RENDER_STATE_DEPTH_WRITE=13,Xn.RENDER_STATE_STENCIL_TEST=14,Xn.RENDER_STATE_STENCIL_WRITE=15,Xn.RENDER_STATE_STENCIL_REF=16,Xn.RENDER_STATE_STENCIL_OP=17,Xn.PERIOD_CUSTOM=0,Xn.PERIOD_MATERIAL=1,Xn.PERIOD_SPRITE=2,Xn.PERIOD_CAMERA=3,Xn.PERIOD_SCENE=4,Xn._propertyNameMap={},Xn._propertyNameCounter=0,Xn._defineCounter=0,Xn._defineMap={},Xn._preCompileShader={},Xn._maskMap=[],Xn.debugMode=!1,Xn.debugShaderVariantCollection=new On,t.UniformBufferParamsType=void 0,(wn=t.UniformBufferParamsType||(t.UniformBufferParamsType={}))[wn.Number=0]="Number",wn[wn.Vector2=1]="Vector2",wn[wn.Vector3=2]="Vector3",wn[wn.Vector4=3]="Vector4",wn[wn.Matrix4x4=4]="Matrix4x4",wn[wn.Vector4Array=5]="Vector4Array",wn[wn.MatrixArray=6]="MatrixArray";class Hn{constructor(t){this._uniformParamsState=new Map(t),this._createBuffer(),this._updateFlag=new ze,this._resetUpdateFlag()}_createBuffer(){var t=0;this._layoutMap={};this._uniformParamsState.forEach(((e,i)=>{t+=this._addUniformParams(i,e,t)})),this._bytelength=4*Math.ceil(t/4)*4,this._buffer=new Float32Array(t)}_getArraySize(t){let e=t.indexOf("["),i=t.indexOf("]");if(-1!=e&&-1!=i&&e<i)return parseFloat(t.substring(e+1,i));throw t+" is illegal "}_addUniformParams(e,i,r){let s,a=0,n=0,h=r%4;switch(i){case t.UniformBufferParamsType.Number:a=1,n=1;break;case t.UniformBufferParamsType.Vector2:switch(a=2,h){case 0:case 2:n=2;break;case 1:case 3:r+=1,n=3}break;case t.UniformBufferParamsType.Vector3:switch(a=3,n=3,h){case 1:case 2:case 3:r+=4-h,n=4-h+3}break;case t.UniformBufferParamsType.Vector4:switch(a=4,h){case 0:n=4;break;case 1:r+=3,n=7;break;case 2:r+=2,n=6;break;case 3:r+=1,n=5}break;case t.UniformBufferParamsType.Matrix4x4:a=16,s=h?4-h:h,r+=s,n=a+s;break;case t.UniformBufferParamsType.Vector4Array:a=4*this._getArraySize(Xn.propertyIDToName(e)),s=h?4-h:h,r+=s,n=a+s;break;case t.UniformBufferParamsType.MatrixArray:a=16*this._getArraySize(Xn.propertyIDToName(e)),s=h?4-h:h,r+=s,n=a+s;break;default:throw"Unifrom Buffer Params Type is illegal "}const o=new ze(r,a);return this._layoutMap[e]=o,n}_getParamsInfo(t){return this._layoutMap[t]}_setUpdateFlag(t,e){t<this._updateFlag.x&&(this._updateFlag.x=t),e>this._updateFlag.y&&(this._updateFlag.y=e)}destroy(){delete this._buffer,this._uniformParamsState.clear(),this._uniformParamsState=null,this._layoutMap=null,this._updateFlag=null}_resetUpdateFlag(){this._updateFlag.setValue(this._buffer.length,0)}_has(t){return!!this._getParamsInfo(t)}_setData(e,i){switch(this._uniformParamsState.get(e)){case t.UniformBufferParamsType.Number:this.setNumberbyIndex(e,i);break;case t.UniformBufferParamsType.Vector2:this.setVector2byIndex(e,i);break;case t.UniformBufferParamsType.Vector3:this.setVector3byIndex(e,i);break;case t.UniformBufferParamsType.Vector4:this.setVector4byIndex(e,i);break;case t.UniformBufferParamsType.Matrix4x4:this.setMatrixbyIndex(e,i);break;case t.UniformBufferParamsType.Vector4Array:this.setVector4ArraybyIndex(e,i);break;case t.UniformBufferParamsType.MatrixArray:this.setMatrixArraybyIndex(e,i)}}getbyteLength(){return this._bytelength}setVector4Array(t,e){const i=Xn.propertyNameToID(t);this.setVector4ArraybyIndex(i,e)}setVector4ArraybyIndex(t,e){const i=this._getParamsInfo(t);if(!i)return;let r=i.x,s=i.y/4;for(let t=0;t<s;t++){let i=e[t];this._buffer[r++]=i.x,this._buffer[r++]=i.y,this._buffer[r++]=i.z,this._buffer[r++]=i.w}this._setUpdateFlag(i.x,r)}setMatrixArray(t,e){const i=Xn.propertyNameToID(t);this.setMatrixArraybyIndex(i,e)}setMatrixArraybyIndex(t,e){const i=this._getParamsInfo(t);if(!i)return;let r=i.x,s=i.y/4;for(let t=0;t<s;t++){let i=e[t];this._buffer.set(i.elements,r),r+=16}this._setUpdateFlag(i.x,r)}setNumber(t,e){const i=Xn.propertyNameToID(t);this.setNumberbyIndex(i,e)}setNumberbyIndex(t,e){const i=this._getParamsInfo(t);if(!i)return;let r=i.x;this._buffer[r++]=e,this._setUpdateFlag(i.x,r)}setVector2(t,e){const i=Xn.propertyNameToID(t);this.setVector2byIndex(i,e)}setVector2byIndex(t,e){const i=this._getParamsInfo(t);if(!i)return;let r=i.x;this._buffer[r++]=e.x,this._buffer[r++]=e.y,this._setUpdateFlag(i.x,r)}setVector3(t,e){const i=Xn.propertyNameToID(t);this.setVector3byIndex(i,e)}setVector3byIndex(t,e){const i=this._getParamsInfo(t);if(!i)return;let r=i.x;this._buffer[r++]=e.x,this._buffer[r++]=e.y,this._buffer[r++]=e.z,this._setUpdateFlag(i.x,r)}setVector4(t,e){const i=Xn.propertyNameToID(t);this.setVector4byIndex(i,e)}setVector4byIndex(t,e){const i=this._getParamsInfo(t);if(!i)return;let r=i.x;this._buffer[r++]=e.x,this._buffer[r++]=e.y,this._buffer[r++]=e.z,this._buffer[r++]=e.w,this._setUpdateFlag(i.x,r)}setColor(t,e){const i=Xn.propertyNameToID(t);this.setColorbyIndex(i,e)}setColorbyIndex(t,e){const i=this._getParamsInfo(t);if(!i)return;let r=i.x;this._buffer[r++]=Z.gammaToLinearSpace(e.r),this._buffer[r++]=Z.gammaToLinearSpace(e.g),this._buffer[r++]=Z.gammaToLinearSpace(e.b),this._buffer[r++]=Z.gammaToLinearSpace(e.a),this._setUpdateFlag(i.x,r)}setMatrix(t,e){const i=Xn.propertyNameToID(t);this.setMatrixbyIndex(i,e)}setMatrixbyIndex(t,e){const i=this._getParamsInfo(t);if(!i)return;let r=i.x;this._buffer.set(e.elements,r),r+=16,this._setUpdateFlag(i.x,r)}clone(){return new Hn(this._uniformParamsState)}}class Yn{constructor(t,e,i){this._mapArray=[],this._blockName=t,this._singgle=i,this._glPointerID=e}add(t){-1==this._mapArray.indexOf(t)&&this._mapArray.push(t)}splitBuffer(t){let e=this._mapArray.indexOf(t);-1!=e&&this._mapArray.splice(e,1)}}class zn extends Xt{static create(t,e,i,r=!1){zn._Map.get(t)||zn._Map.set(t,new Yn(t,g.renderEngine.getUBOPointer(t),r));let s=zn._Map.get(t);if(s._singgle&&s._mapArray.length>0)return null;{let a=g.renderOBJCreate.createUniformBufferObject(s._glPointerID,t,e,i,r);return s._singgle&&s.add(a),a}}static getBuffer(t,e){let i=zn._Map.get(t);return i?i._mapArray[e]:null}constructor(e,i,r,s,a){super(t.BufferTargetType.UNIFORM_BUFFER,r),this._isSingle=!1,this._glPointer=e,this.byteLength=s,this._name=i,this._isSingle=a,this.bind(),this._isSingle&&this._bindUniformBufferBase(),this._glBuffer.setDataLength(this.byteLength)}_bindUniformBufferBase(){this._glBuffer.bindBufferBase(this._glPointer)}_bindBufferRange(t,e){this.bind(),this._glBuffer.bindBufferRange(this._glPointer,t,e)}_reset(t){this._glBuffer&&(this._glBuffer.destroy(),this._glBuffer=null),this._byteLength=this.byteLength=t,this._glBuffer=g.renderEngine.createBuffer(this._bufferType,this._bufferUsage),this._isSingle&&this._bindUniformBufferBase(),this._glBuffer.setDataLength(this.byteLength)}bind(){return this._glBuffer.bindBuffer()}setData(t,e=0,i=Number.MAX_SAFE_INTEGER){if(!(i<0))if(this.bind(),!(0==e&&i==this.byteLength)){var r=new Uint8Array(t.buffer,e,i);this._glBuffer.setData(r,e)}else this._glBuffer.setDataEx(t,e,t.length)}setDataByUniformBufferData(t){this._updateDataInfo==t?(this.setData(t._buffer,4*t._updateFlag.x,4*(t._updateFlag.y-t._updateFlag.x)),t._resetUpdateFlag()):(this.setData(t._buffer,0,this.byteLength),t._resetUpdateFlag(),this._updateDataInfo=t)}setDataByByUniformBufferDataOffset(t,e){let i=t.getbyteLength(),r=t._realByte;t._resetUpdateFlag(),this.bind(),this._glBuffer.setDataEx(t._buffer,e*i,r/4)}destroy(){super.destroy()}}zn.UBONAME_SCENE="SceneUniformBlock",zn.UBONAME_CAMERA="CameraUniformBlock",zn.UBONAME_SPRITE3D="SpriteUniformBlock",zn.UBONAME_SHADOW="ShadowUniformBlock",zn.commonMap=["CameraUniformBlock","SceneUniformBlock","SpriteUniformBlock","ShadowUniformBlock"],zn._Map=new Map,t.RenderDrawMode=void 0,(Mn=t.RenderDrawMode||(t.RenderDrawMode={}))[Mn.TRIANGLES=0]="TRIANGLES",Mn[Mn.POINTS=1]="POINTS",Mn[Mn.LINES=2]="LINES",t.RenderIndexMode=void 0,(Dn=t.RenderIndexMode||(t.RenderIndexMode={}))[Dn.UNSIGNED_BYTE=0]="UNSIGNED_BYTE",Dn[Dn.UNSIGNED_SHORT=1]="UNSIGNED_SHORT",Dn[Dn.UNSIGNED_INT=2]="UNSIGNED_INT",t.TextureDecodeFormat=void 0,(In=t.TextureDecodeFormat||(t.TextureDecodeFormat={}))[In.Normal=0]="Normal",In[In.RGBM=1]="RGBM";class jn{constructor(){this.cull=jn.CULL_BACK,this.blend=jn.BLEND_DISABLE,this.srcBlend=jn.BLENDPARAM_ONE,this.dstBlend=jn.BLENDPARAM_ZERO,this.srcBlendRGB=jn.BLENDPARAM_ONE,this.dstBlendRGB=jn.BLENDPARAM_ZERO,this.srcBlendAlpha=jn.BLENDPARAM_ONE,this.dstBlendAlpha=jn.BLENDPARAM_ZERO,this.blendEquation=jn.BLENDEQUATION_ADD,this.blendEquationRGB=jn.BLENDEQUATION_ADD,this.blendEquationAlpha=jn.BLENDEQUATION_ADD,this.depthTest=jn.DEPTHTEST_LEQUAL,this.depthWrite=!0,this.stencilRef=1,this.stencilTest=jn.STENCILTEST_OFF,this.stencilWrite=!1,this.stencilOp=new Ke(jn.STENCILOP_KEEP,jn.STENCILOP_KEEP,jn.STENCILOP_REPLACE)}setNull(){this.cull=null,this.blend=null,this.srcBlend=null,this.dstBlend=null,this.srcBlendRGB=null,this.dstBlendRGB=null,this.srcBlendAlpha=null,this.dstBlendAlpha=null,this.blendEquation=null,this.blendEquationRGB=null,this.blendEquationAlpha=null,this.depthTest=null,this.depthWrite=null,this.stencilRef=null,this.stencilTest=null,this.stencilWrite=null,this.stencilOp=null}}jn.CULL_NONE=t.CullMode.Off,jn.CULL_FRONT=t.CullMode.Front,jn.CULL_BACK=t.CullMode.Back,jn.BLEND_DISABLE=t.BlendType.BLEND_DISABLE,jn.BLEND_ENABLE_ALL=t.BlendType.BLEND_ENABLE_ALL,jn.BLEND_ENABLE_SEPERATE=t.BlendType.BLEND_ENABLE_SEPERATE,jn.BLENDPARAM_ZERO=t.BlendFactor.Zero,jn.BLENDPARAM_ONE=t.BlendFactor.One,jn.BLENDPARAM_SRC_COLOR=t.BlendFactor.SourceColor,jn.BLENDPARAM_ONE_MINUS_SRC_COLOR=t.BlendFactor.OneMinusSourceColor,jn.BLENDPARAM_DST_COLOR=t.BlendFactor.DestinationColor,jn.BLENDPARAM_ONE_MINUS_DST_COLOR=t.BlendFactor.OneMinusDestinationColor,jn.BLENDPARAM_SRC_ALPHA=t.BlendFactor.SourceAlpha,jn.BLENDPARAM_ONE_MINUS_SRC_ALPHA=t.BlendFactor.OneMinusSourceAlpha,jn.BLENDPARAM_DST_ALPHA=t.BlendFactor.DestinationAlpha,jn.BLENDPARAM_ONE_MINUS_DST_ALPHA=t.BlendFactor.OneMinusDestinationAlpha,jn.BLENDPARAM_SRC_ALPHA_SATURATE=t.BlendFactor.SourceAlphaSaturate,jn.BLENDPARAM_BLENDCOLOR=t.BlendFactor.BlendColor,jn.BLENDPARAM_BLEND_ONEMINUS_COLOR=t.BlendFactor.OneMinusBlendColor,jn.BLENDEQUATION_ADD=t.BlendEquationSeparate.ADD,jn.BLENDEQUATION_SUBTRACT=t.BlendEquationSeparate.SUBTRACT,jn.BLENDEQUATION_REVERSE_SUBTRACT=t.BlendEquationSeparate.REVERSE_SUBTRACT,jn.BLENDEQUATION_MIN=t.BlendEquationSeparate.MIN,jn.BLENDEQUATION_MAX=t.BlendEquationSeparate.MAX,jn.DEPTHTEST_OFF=0,jn.DEPTHTEST_NEVER=t.CompareFunction.Never,jn.DEPTHTEST_LESS=t.CompareFunction.Less,jn.DEPTHTEST_EQUAL=t.CompareFunction.Equal,jn.DEPTHTEST_LEQUAL=t.CompareFunction.LessEqual,jn.DEPTHTEST_GREATER=t.CompareFunction.Greater,jn.DEPTHTEST_NOTEQUAL=t.CompareFunction.NotEqual,jn.DEPTHTEST_GEQUAL=t.CompareFunction.GreaterEqual,jn.DEPTHTEST_ALWAYS=t.CompareFunction.Always,jn.STENCILTEST_OFF=0,jn.STENCILTEST_NEVER=t.CompareFunction.Never,jn.STENCILTEST_LESS=t.CompareFunction.Less,jn.STENCILTEST_EQUAL=t.CompareFunction.Equal,jn.STENCILTEST_LEQUAL=t.CompareFunction.LessEqual,jn.STENCILTEST_GREATER=t.CompareFunction.Greater,jn.STENCILTEST_NOTEQUAL=t.CompareFunction.NotEqual,jn.STENCILTEST_GEQUAL=t.CompareFunction.GreaterEqual,jn.STENCILTEST_ALWAYS=t.CompareFunction.Always,jn.STENCILOP_KEEP=t.StencilOperation.Keep,jn.STENCILOP_ZERO=t.StencilOperation.Zero,jn.STENCILOP_REPLACE=t.StencilOperation.Replace,jn.STENCILOP_INCR=t.StencilOperation.IncrementSaturate,jn.STENCILOP_INCR_WRAP=t.StencilOperation.IncrementWrap,jn.STENCILOP_DECR=t.StencilOperation.DecrementSaturate,jn.STENCILOP_DECR_WRAP=t.StencilOperation.DecrementWrap,jn.STENCILOP_INVERT=t.StencilOperation.Invert,jn.Default=new jn;class Kn{static creatBlock(t){return new ArrayBuffer(t)}static freeMemoryBlock(t){}}t.MemoryDataType=void 0,(Pn=t.MemoryDataType||(t.MemoryDataType={}))[Pn.ShaderData=0]="ShaderData",Pn[Pn.TextureData=1]="TextureData",Pn[Pn.VertexData=2]="VertexData",Pn[Pn.IndexData=3]="IndexData",Pn[Pn.BaseRenderData=4]="BaseRenderData";class qn{constructor(t,e){if(e){if(t>qn._sharedBuffer.byteLength)throw new Error("NativeMemory:shared buffer not enough");this._buffer=qn._sharedBuffer}else this._buffer=Kn.creatBlock(t);this._idata=new Int32Array(this._buffer),this._fdata=new Float32Array(this._buffer),this._f64data=new Float64Array(this._buffer),this._byteArray=new Uint8Array(this._buffer),this._byteLength=t}get float32Array(){return this._fdata}get float64Array(){return this._f64data}get uint8Array(){return this._byteArray}get int32Array(){return this._idata}destroy(){this._destroyed||(this.clear(),Kn.freeMemoryBlock(this._buffer),this._destroyed=!0)}clear(){this._idata=null,this._fdata=null,this._byteArray=null}}qn.NativeSourceID=0,qn._sharedBuffer=new ArrayBuffer(256);class $n extends qn{constructor(t){super(t,!1),this._currentOffsetInByte=0}addBlockCell(t,e){t.uploadDataTOShareMemory(this,this._currentOffsetInByte)&&(this._currentOffsetInByte+=e)}check(t){return this._currentOffsetInByte+t<this._byteLength}clear(){this._currentOffsetInByte=0}}class Zn{constructor(){this._dataNodeList=new En,this._commandNums=0,this._currentBlock=new $n(Zn.UploadMemorySize),this._conchUploadMemoryManager=new window.conchUploadMemoryManager}static getInstance(){return Zn._instance||(Zn._instance=new Zn),Zn._instance}_addNodeCommand(t,e){this._currentBlock.addBlockCell(t,e),this._commandNums++}static syncRenderMemory(){Zn.getInstance()._serialiseData(),Zn.getInstance().clear()}_serialiseData(){const t=this._dataNodeList.elements;for(let e=0;e<this._dataNodeList.length;e++){let i=t[e],r=i.getUploadMemoryLength();if(r>Zn.UploadMemorySize)throw"dataSize is too large, greater than UploadMemorySize,";this._currentBlock.check(r)?(this.uploadData(),this._addNodeCommand(i,r)):this._addNodeCommand(i,r)}this.uploadData()}uploadData(){this._commandNums>0&&(this._conchUploadMemoryManager.uploadData(this._currentBlock._buffer,this._commandNums),this._commandNums=0,this._currentBlock.clear())}clear(){this._dataNodeList.length=0}}Zn.UploadMemorySize=1048576,Zn._instance=null;class Qn{characterMapContains(t){for(var e=0;e<Qn.charsMap.length;++e)if(Qn.charsMap[e][0]===t)return!0;return!1}getCharRep(t){for(var e=0;e<Qn.charsMap.length;++e)if(Qn.charsMap[e][0]===t)return Qn.charsMap[e];return!1}getCombCharRep(t,e){for(var i=0;i<Qn.combCharsMap.length;++i)if(Qn.combCharsMap[i][0][0]===t&&Qn.combCharsMap[i][0][1]===e)return Qn.combCharsMap[i];return!1}isTransparent(t){for(var e=0;e<Qn.transChars.length;++e)if(Qn.transChars[e]===t)return!0;return!1}getOriginalCharsFromCode(t){var e;for(e=0;e<Qn.charsMap.length;++e)if(Qn.charsMap[e].indexOf(t)>-1)return String.fromCharCode(Qn.charsMap[e][0]);for(e=0;e<Qn.combCharsMap.length;++e)if(Qn.combCharsMap[e].indexOf(t)>-1)return String.fromCharCode(Qn.combCharsMap[e][0][0])+String.fromCharCode(Qn.combCharsMap[e][0][1]);return String.fromCharCode(t)}convertArabic(t){for(var e,i,r="",s=0;s<t.length;++s){var a=t.charCodeAt(s);if(this.characterMapContains(a)){for(var n=null,h=null,o=s-1,l=s+1;o>=0&&this.isTransparent(t.charCodeAt(o));--o);for((!(e=!!(n=o>=0?t.charCodeAt(o):null)&&this.getCharRep(n))||null==e[2]&&null==e[3])&&(n=null);l<t.length&&this.isTransparent(t.charCodeAt(l));++l);if((!(e=!!(h=l<t.length?t.charCodeAt(l):null)&&this.getCharRep(h))||null==e[3]&&null==e[4])&&(h=null),1604===a&&null!=h&&(1570===h||1571===h||1573===h||1575===h)){i=this.getCombCharRep(a,h),r+=null!=n?String.fromCharCode(i[4]):String.fromCharCode(i[1]),++s;continue}if(e=this.getCharRep(a),null!=n&&null!=h&&null!=e[3]){r+=String.fromCharCode(e[3]);continue}if(null!=n&&null!=e[4]){r+=String.fromCharCode(e[4]);continue}if(null!=h&&null!=e[2]){r+=String.fromCharCode(e[2]);continue}r+=String.fromCharCode(e[1])}else r+=String.fromCharCode(a)}return r}convertArabicBack(t){var e,i,r="";for(i=0;i<t.length;++i)e=t.charCodeAt(i),r+=this.getOriginalCharsFromCode(e);return r}}Qn.charsMap=[[1569,65152,null,null,null],[1570,65153,null,null,65154],[1571,65155,null,null,65156],[1572,65157,null,null,65158],[1573,65159,null,null,65160],[1574,65161,65163,65164,65162],[1575,65165,null,null,65166],[1576,65167,65169,65170,65168],[1577,65171,null,null,65172],[1578,65173,65175,65176,65174],[1579,65177,65179,65180,65178],[1580,65181,65183,65184,65182],[1581,65185,65187,65188,65186],[1582,65189,65191,65192,65190],[1583,65193,null,null,65194],[1584,65195,null,null,65196],[1585,65197,null,null,65198],[1586,65199,null,null,65200],[1587,65201,65203,65204,65202],[1588,65205,65207,65208,65206],[1589,65209,65211,65212,65210],[1590,65213,65215,65216,65214],[1591,65217,65219,65220,65218],[1592,65221,65223,65224,65222],[1593,65225,65227,65228,65226],[1594,65229,65231,65232,65230],[1600,1600,1600,1600,1600],[1601,65233,65235,65236,65234],[1602,65237,65239,65240,65238],[1603,65241,65243,65244,65242],[1604,65245,65247,65248,65246],[1605,65249,65251,65252,65250],[1606,65253,65255,65256,65254],[1607,65257,65259,65260,65258],[1608,65261,null,null,65262],[1609,65263,null,null,65264],[1610,65265,65267,65268,65266],[1662,64342,64344,64345,64343],[1740,64508,64510,64511,64509],[1670,64378,64380,64381,64379],[1705,64398,64400,64401,64399],[1711,64402,64404,64405,64403],[1688,64394,null,null,64395]],Qn.combCharsMap=[[[1604,1570],65269,null,null,65270],[[1604,1571],65271,null,null,65272],[[1604,1573],65273,null,null,65274],[[1604,1575],65275,null,null,65276]],Qn.transChars=[1552,1554,1555,1556,1557,1611,1612,1613,1614,1615,1616,1617,1618,1619,1620,1621,1622,1623,1624,1648,1750,1751,1752,1753,1754,1755,1756,1759,1760,1761,1762,1763,1764,1767,1768,1770,1771,1772,1773];class Jn{static ArrayMul(t,e,i){if(t)if(e)for(var r,s,a,n,h=0;h<4;h++)r=t[h],s=t[h+4],a=t[h+8],n=t[h+12],i[h]=r*e[0]+s*e[1]+a*e[2]+n*e[3],i[h+4]=r*e[4]+s*e[5]+a*e[6]+n*e[7],i[h+8]=r*e[8]+s*e[9]+a*e[10]+n*e[11],i[h+12]=r*e[12]+s*e[13]+a*e[14]+n*e[15];else Jn.copyArray(t,i);else Jn.copyArray(e,i)}static copyArray(t,e){if(t&&e)for(var i=0;i<t.length;i++)e[i]=t[i]}}return t.AlphaCmd=ai,t.Animation=cr,t.Animation2DCondition=sa,t.Animation2DEvent=Js,t.Animation2DParm=ra,t.AnimationBase=qi,t.AnimationClip2D=ia,t.AnimationClip2DParse01=ta,t.Animator2D=qs,t.AnimatorController2D=_a,t.AnimatorControllerLayer2D=Vs,t.AnimatorControllerParse=Ks,t.AnimatorPlayState2D=Ws,t.AnimatorState2D=$s,t.AnimatorState2DScript=class{onStateEnter(){}onStateUpdate(){}onStateExit(){}},t.AnimatorStateBoolCondition=ha,t.AnimatorStateCondition=aa,t.AnimatorStateNumberCondition=na,t.AnimatorStateTriggerCondition=oa,t.AnimatorTransition2D=la,t.ArabicReshaper=Qn,t.AssetDb=lt,t.AtlasGrid=Be,t.AtlasInfoManager=$i,t.AtlasResource=Qi,t.AudioSound=Bs,t.AudioSoundChannel=Ps,t.Base64Tool=pn,t.BasePoly=be,t.BaseShader=H,t.BaseTexture=D,t.BatchProgress=Ji,t.Bezier=ae,t.BitmapFont=pr,t.BlendComponent=bn,t.BlendMode=it,t.BlendState=Rn,t.BlurFilter=ws,t.BlurFilterGLRender=As,t.BoundsStyle=ii,t.Browser=We,t.Buffer=Xt,t.Buffer2D=zt,t.BufferState=Vt,t.ButtonEffect=class{constructor(){this._curState=0,this.effectScale=1.5,this.tweenTime=300}set target(t){this._tar=t,t.on(y.MOUSE_DOWN,this,this.toChangedState),t.on(y.MOUSE_UP,this,this.toInitState),t.on(y.MOUSE_OUT,this,this.toInitState)}toChangedState(){this._curState=1,this._curTween&&Yi.clear(this._curTween),this._curTween=Yi.to(this._tar,{scaleX:this.effectScale,scaleY:this.effectScale},this.tweenTime,Xi[this.effectEase],Hi.create(this,this.tweenComplete))}toInitState(){2!=this._curState&&(this._curTween&&Yi.clear(this._curTween),this._curState=2,this._curTween=Yi.to(this._tar,{scaleX:1,scaleY:1},this.tweenTime,Xi[this.backEase],Hi.create(this,this.tweenComplete)))}tweenComplete(){this._curState=0,this._curTween=null}},t.Byte=I,t.CacheManger=Oi,t.CacheStyle=ri,t.CallLater=vs,t.CharRenderInfo=Ge,t.CharRender_Canvas=Ve,t.CharRender_Native=Xe,t.CharSubmitCache=Pe,t.ClassUtils=a,t.ClipRectCmd=Bi,t.Color=Z,t.ColorFilter=At,t.ColorUtils=St,t.CommandEncoder=ln,t.CommandUniformMap=class{constructor(t){this._idata={},this._stateName=t}hasPtrID(t){return!(null==this._idata[t])}getMap(){return this._idata}addShaderUniform(t,e){this._idata[t]=e}},t.CommonMemoryAllocater=Kn,t.Component=c,t.ComponentDriver=bs,t.Config=e,t.Config3D=qe,t.Const=i,t.Context=Je,t.DDSTextureInfo=N,t.DefineDatas=Bn,t.Delegate=E,t.DepthState=class{},t.Downloader=ir,t.Dragging=zi,t.Draw9GridTextureCmd=Ci,t.DrawCircleCmd=ni,t.DrawCurvesCmd=hi,t.DrawImageCmd=oi,t.DrawLineCmd=li,t.DrawLinesCmd=ui,t.DrawParticleCmd=Sn,t.DrawPathCmd=di,t.DrawPieCmd=pi,t.DrawPolyCmd=mi,t.DrawRectCmd=gi,t.DrawStyle=ne,t.DrawTextureCmd=Ti,t.DrawTexturesCmd=Li,t.DrawTrianglesCmd=bi,t.EXRTextureInfo=class{static getEXRInfo(e){const wrong=()=>{throw"EXR info: data wrong."},todo=()=>{console.log("EXR info: todo")};let i=!0,r=new DataView(e),s=0;const getString=(t=0)=>{let e,i="",a=0;for(;0!=(e=r.getUint8(s++));)if(i=`${i}${String.fromCharCode(e)}`,a++,a==t){s++;break}return i},getUnsignedChar=()=>r.getUint8(s++),getInt=()=>{let t=r.getInt32(s,i);return s+=4,t},getUnsignedlong=()=>{let t=r.getBigUint64(s,i);return s+=8,t},getFloat=()=>{let t=r.getFloat32(s,i);return s+=4,t},readChlist=t=>{let e=[],i=s+t;for(;s<i-1;){let t={name:getString(),pixelType:getInt(),pLinear:getUnsignedChar(),reserved:`${getUnsignedChar()}${getUnsignedChar()}${getUnsignedChar()}`,xSampling:getInt(),ySampling:getInt()};e.push(t)}return 0!=getUnsignedChar()&&wrong(),e};let a=r.getInt32(s,i);s+=4,20000630!=a&&wrong();let n=getInt();n&=255;let h=n&=512;n&=1024;let o=n&=2048,l=n&=4096;0==h&&0==o&&0==l||(1==h&&0==o&&0==l||0==h&&0==o&&1==l||0==h&&1==o&&0==l||0==h&&1==o&&1==l)&&(todo(),wrong());let _,u=new Map;for(;""!=(_=getString());){let e={name:_,value:null},i=getString(),r=getInt();switch(i){case t.AttributeType.chlist:let i=readChlist(r);e.value=i;break;case t.AttributeType.compression:let s=getUnsignedChar();e.value=s;break;case t.AttributeType.box2i:let a={xMin:getInt(),yMin:getInt(),xMax:getInt(),yMax:getInt()};e.value=a;break;case t.AttributeType.lineOrder:let n=getUnsignedChar();e.value=n;break;case t.AttributeType.float:e.value=getFloat();break;case t.AttributeType.v2f:e.value=[getFloat(),getFloat()];break;default:wrong()}console.log(e),u.set(e.name,e.value)}let d=0;if(0==l&&!u.has("chunkCount")){let t=u.get("dataWindow");if(d=t.yMax-t.yMin+1,4===u.get("compression"))d/=32;else wrong();d=Math.ceil(d)}for(let t=0;t<d;t++)getUnsignedlong();for(let t=0;t<d;t++){getInt();let t=getInt();s+=t}s!=e.byteLength&&wrong()}},t.Earcut=Ae,t.EarcutNode=Ce,t.Ease=Xi,t.EffectAnimation=fr,t.EffectBase=nn,t.Event=y,t.EventDispatcher=R,t.FadeIn=class extends nn{_doTween(){return this.target.alpha=0,Yi.to(this.target,{alpha:1},this.duration,Xi[this.ease],this._comlete,this.delay)}},t.FadeOut=class extends nn{_doTween(){return this.target.alpha=1,Yi.to(this.target,{alpha:0},this.duration,Xi[this.ease],this._comlete,this.delay)}},t.FillTextCmd=Fi,t.FillTextureCmd=xi,t.Filter=yt,t.FontInfo=Oe,t.FrameAnimation=_r,t.GL2TextureContext=kr,t.GLBuffer=Wr,t.GLObject=Or,t.GLParams=Xr,t.GLRender2DContext=Hr,t.GLRenderDrawContext=Yr,t.GLRenderState=zr,t.GLSLCodeGenerator=Gn,t.GLShaderInstance=Kr,t.GLTextureContext=Gr,t.GLVertexState=qr,t.GlCapable=Vr,t.GlowFilter=Ds,t.GlowFilterGLRender=Ms,t.GrahamScan=wt,t.GraphicAnimation=ur,t.Graphics=Ui,t.GraphicsBounds=Pi,t.HDRTextureInfo=Oa,t.HTMLCanvas=ei,t.HTMLChar=fn,t.HalfFloatUtils=P,t.Handler=Hi,t.HideFlags=s,t.HierarchyLoader=Fa,t.HierarchyParser=La,t.HierarchyResource=ps,t.HitArea=ls,t.HttpRequest=er,t.ICharRender=ke,t.ILaya=n,t.IStatRender=ja,t.ImgUtils=tr,t.IncludeFile=ut,t.IndexBuffer=Ht,t.IndexBuffer2D=jt,t.Input=as,t.InputManager=br,t.KTXTextureInfo=V,t.KeyLocation=hn,t.Keyboard=on,t.Keyframe2D=Qs,t.KeyframeNode2D=Zs,t.KeyframeNodeList2D=ea,t.Laya=en,t.LayaEnv=h,t.LayaGL=g,t.LayaGLQuickRunner=ie,t.LegacyUIParser=ms,t.Loader=ar,t.LocalStorage=Ya,t.Log=mn,t.MathUtil=lr,t.MathUtils3D=Ye,t.MatirxArray=Jn,t.Matrix=p,t.Matrix3x3=va,t.Matrix4x4=ma,t.Mesh2D=$t,t.MeshParticle2D=Ja,t.MeshQuadTexture=Zt,t.MeshTexture=Qt,t.MeshVG=Jt,t.Mouse=Qa,t.NativeContext=Ze,t.NativeFilter=re,t.NativeGL2TextureContext=Jr,t.NativeGLObject=Zr,t.NativeGLRender2DContext=class extends Zr{constructor(t){super(t)}activeTexture(t){}bindTexture(t,e){}bindUseProgram(t){return!0}},t.NativeGLRenderDrawContext=es,t.NativeGLTextureContext=Qr,t.NativeGLVertexState=ts,t.NativeMemory=qn,t.NativeRenderStateCommand=is,t.NativeRenderTexture2D=Q,t.NativeWebGLCacheAsNormalCanvas=te,t.NativeWebGLEngine=rs,t.NativeWordText=Ne,t.Node=ki,t.NodeFlags=r,t.NullLoader=Xa,t.Path=he,t.PerfData=gn,t.PerfHUD=Tn,t.Point=f,t.Pool=o,t.PoolCache=xn,t.Prefab=us,t.PrefabImpl=fs,t.PrimitiveSV=$a,t.Quaternion=wa,t.QuickTestTool=_n,t.Rectangle=m,t.Render=ss,t.RenderInfo=Yt,t.RenderSprite=se,t.RenderState=jn,t.RenderState2D=Y,t.RenderStateCommand=Fr,t.RenderStateContext=et,t.RenderTexture=$e,t.RenderTexture2D=J,t.Resource=M,t.ResourceVersion=dn,t.RestoreCmd=Ei,t.RotateCmd=yi,t.RunDriver=Rs,t.SaveBase=le,t.SaveClipRect=_e,t.SaveCmd=wi,t.SaveMark=ue,t.SaveTransform=de,t.SaveTranslate=ce,t.ScaleCmd=vi,t.Scene=xs,t.Script=class extends c{_isScript(){return!0}setupScript(){let t,e=this.owner;(t=this.onTriggerEnter)&&e.on(y.TRIGGER_ENTER,this,t),(t=this.onTriggerStay)&&e.on(y.TRIGGER_STAY,this,t),(t=this.onTriggerExit)&&e.on(y.TRIGGER_EXIT,this,t),(t=this.onCollisionEnter)&&e.on(y.COLLISION_ENTER,this,t),(t=this.onCollisionStay)&&e.on(y.COLLISION_STAY,this,t),(t=this.onCollisionExit)&&e.on(y.COLLISION_EXIT,this,t),(t=this.onJointBreak)&&e.on(y.JOINT_BREAK,this,t),(t=this.onMouseDown)&&e.on(y.MOUSE_DOWN,this,t),(t=this.onMouseUp)&&e.on(y.MOUSE_UP,this,t),(t=this.onRightMouseDown)&&e.on(y.RIGHT_MOUSE_DOWN,this,t),(t=this.onRightMouseUp)&&e.on(y.RIGHT_MOUSE_UP,this,t),(t=this.onMouseMove)&&e.on(y.MOUSE_MOVE,this,t),(t=this.onMouseDrag)&&e.on(y.MOUSE_DRAG,this,t),(t=this.onMouseDragEnd)&&e.on(y.MOUSE_DRAG_END,this,t),(t=this.onMouseOver)&&e.on(y.MOUSE_OVER,this,t),(t=this.onMouseOut)&&e.on(y.MOUSE_OUT,this,t),(t=this.onMouseClick)&&e.on(y.CLICK,this,t),(t=this.onMouseDoubleClick)&&e.on(y.DOUBLE_CLICK,this,t),(t=this.onMouseRightClick)&&e.on(y.RIGHT_CLICK,this,t),(t=this.onKeyDown)&&e.on(y.KEY_DOWN,this,t),(t=this.onKeyPress)&&e.on(y.KEY_PRESS,this,t),(t=this.onKeyUp)&&e.on(y.KEY_UP,this,t)}},t.SerializeUtil=Pa,t.Shader=mt,t.Shader2D=Se,t.Shader2X=gt,t.Shader3D=Xn,t.ShaderCompile=ft,t.ShaderCompileDefineBase=Un,t.ShaderData=Nn,t.ShaderDataDefaultValue=function(e){switch(e){case t.ShaderDataType.Int:return 0;case t.ShaderDataType.Bool:return!1;case t.ShaderDataType.Float:return 0;case t.ShaderDataType.Vector2:return ze.ZERO;case t.ShaderDataType.Vector3:return Ke.ZERO;case t.ShaderDataType.Vector4:return je.ZERO;case t.ShaderDataType.Color:return Z.BLACK;case t.ShaderDataType.Matrix4x4:return ma.DEFAULT}return null},t.ShaderDefine=Ln,t.ShaderDefines2D=st,t.ShaderDefinesBase=rt,t.ShaderInstance=class{constructor(t,e,i,r){this._customUniformParamsMap=[],this._uploadMark=-1,this._uploadRenderType=-1,this._cullStateCMD=g.renderOBJCreate.createRenderStateComand(),this._renderShaderInstance=g.renderEngine.createShaderInstance(t,e,i),this._renderShaderInstance._complete&&(this._shaderPass=r,this._create())}get complete(){return this._renderShaderInstance._complete}_create(){this._sceneUniformParamsMap=new ln,this._cameraUniformParamsMap=new ln,this._spriteUniformParamsMap=new ln,this._materialUniformParamsMap=new ln;const t=g.renderOBJCreate.createGlobalUniformMap("Scene3D"),e=g.renderOBJCreate.createGlobalUniformMap("Sprite3D"),i=g.renderOBJCreate.createGlobalUniformMap("BaseCamera"),r=g.renderOBJCreate.createGlobalUniformMap("Custom");let s,a,n=this._renderShaderInstance.getUniformMap();for(s=0,a=n.length;s<a;s++){let a=n[s];t.hasPtrID(a.dataOffset)?this._sceneUniformParamsMap.addShaderUniform(a):i.hasPtrID(a.dataOffset)?this._cameraUniformParamsMap.addShaderUniform(a):e.hasPtrID(a.dataOffset)?this._spriteUniformParamsMap.addShaderUniform(a):r.hasPtrID(a.dataOffset)?(this._customUniformParamsMap||(this._customUniformParamsMap=[]),this._customUniformParamsMap[a.dataOffset]=a):this._materialUniformParamsMap.addShaderUniform(a)}}_disposeResource(){this._renderShaderInstance.destroy(),this._sceneUniformParamsMap=null,this._cameraUniformParamsMap=null,this._spriteUniformParamsMap=null,this._materialUniformParamsMap=null,this._customUniformParamsMap=null,this._uploadMaterial=null,this._uploadRender=null,this._uploadCameraShaderValue=null,this._uploadScene=null}_getRenderState(t,e){return t[Vn.StateParamsMap[e]]}bind(){return this._renderShaderInstance.bind()}uploadUniforms(t,e,i){g.renderEngine.uploadUniforms(this._renderShaderInstance,t,e,i)}uploadRenderStateBlendDepth(t){var e=this._shaderPass.renderState,i=t.getData(),r=this._getRenderState(i,Xn.RENDER_STATE_DEPTH_WRITE),s=this._getRenderState(i,Xn.RENDER_STATE_DEPTH_TEST),a=this._getRenderState(i,Xn.RENDER_STATE_BLEND),n=this._getRenderState(i,Xn.RENDER_STATE_STENCIL_REF),h=this._getRenderState(i,Xn.RENDER_STATE_STENCIL_TEST),o=this._getRenderState(i,Xn.RENDER_STATE_STENCIL_WRITE),l=this._getRenderState(i,Xn.RENDER_STATE_STENCIL_OP);switch(this._shaderPass.statefirst?(null!=e.depthWrite&&(r=e.depthWrite),null!=e.depthTest&&(s=e.depthTest),null!=e.blend&&(a=e.blend),null!=e.stencilRef&&(n=e.stencilRef),null!=e.stencilTest&&(h=e.stencilTest),null!=e.stencilWrite&&(o=e.stencilWrite),null!=e.stencilOp&&(l=e.stencilOp)):(r=null!=r?r:e.depthWrite,s=null!=s?s:e.depthTest,a=null!=a?a:e.blend,n=null!=n?n:e.stencilRef,h=null!=h?h:e.stencilTest,o=null!=o?o:e.stencilWrite,l=null!=l?l:e.stencilOp),r=null!=r?r:jn.Default.depthWrite,s=null!=s?s:jn.Default.depthTest,a=null!=a?a:jn.Default.blend,n=null!=n?n:jn.Default.stencilRef,h=null!=h?h:jn.Default.stencilTest,o=null!=o?o:jn.Default.stencilWrite,l=null!=l?l:jn.Default.stencilOp,et.setDepthMask(r),s===jn.DEPTHTEST_OFF?et.setDepthTest(!1):(et.setDepthTest(!0),et.setDepthFunc(s)),a){case jn.BLEND_DISABLE:et.setBlend(!1);break;case jn.BLEND_ENABLE_ALL:var _=this._getRenderState(i,Xn.RENDER_STATE_BLEND_EQUATION),u=this._getRenderState(i,Xn.RENDER_STATE_BLEND_SRC),d=this._getRenderState(i,Xn.RENDER_STATE_BLEND_DST);this._shaderPass.statefirst?(null!=e.blendEquation&&(_=e.blendEquation),null!=e.srcBlend&&(u=e.srcBlend),null!=e.dstBlend&&(d=e.dstBlend)):(_=null!=_?_:e.blendEquation,u=null!=u?u:e.srcBlend,d=null!=d?d:e.dstBlend),_=null!=_?_:jn.Default.blendEquation,u=null!=u?u:jn.Default.srcBlend,d=null!=d?d:jn.Default.dstBlend,et.setBlend(!0),et.setBlendEquation(_),et.setBlendFunc(u,d);break;case jn.BLEND_ENABLE_SEPERATE:var c=this._getRenderState(i,Xn.RENDER_STATE_BLEND_EQUATION_RGB),p=this._getRenderState(i,Xn.RENDER_STATE_BLEND_EQUATION_ALPHA),f=this._getRenderState(i,Xn.RENDER_STATE_BLEND_SRC_RGB),m=this._getRenderState(i,Xn.RENDER_STATE_BLEND_DST_RGB),g=this._getRenderState(i,Xn.RENDER_STATE_BLEND_SRC_ALPHA),T=this._getRenderState(i,Xn.RENDER_STATE_BLEND_DST_ALPHA);this._shaderPass.statefirst?(null!=e.blendEquationRGB&&(c=e.blendEquationRGB),null!=e.blendEquationAlpha&&(p=e.blendEquationAlpha),null!=e.srcBlendRGB&&(f=e.srcBlendRGB),null!=e.dstBlendRGB&&(m=e.dstBlendRGB),null!=e.srcBlendAlpha&&(g=e.srcBlendAlpha),null!=e.dstBlendAlpha&&(T=e.dstBlendAlpha)):(c=null!=c?c:e.blendEquationRGB,p=null!=p?p:e.blendEquationAlpha,f=null!=f?f:e.srcBlendRGB,m=null!=m?m:e.dstBlendRGB,g=null!=g?g:e.srcBlendAlpha,T=null!=T?T:e.dstBlendAlpha),c=null!=c?c:jn.Default.blendEquationRGB,p=null!=p?p:jn.Default.blendEquationAlpha,f=null!=f?f:jn.Default.srcBlendRGB,m=null!=m?m:jn.Default.dstBlendRGB,g=null!=g?g:jn.Default.srcBlendAlpha,T=null!=T?T:jn.Default.dstBlendAlpha,et.setBlend(!0),et.setBlendEquationSeparate(c,p),et.setBlendFuncSeperate(f,m,g,T)}et.setStencilMask(o),h==jn.STENCILTEST_OFF?et.setStencilTest(!1):(et.setStencilTest(!0),et.setStencilFunc(h,n)),et.setstencilOp(l.x,l.y,l.z)}uploadRenderStateFrontFace(e,i,r){var s;this._cullStateCMD.clear();var a,n=this._shaderPass.renderState,h=e.getData(),o=this._getRenderState(h,Xn.RENDER_STATE_CULL);switch(this._shaderPass.statefirst&&(o=null!==(s=n.cull)&&void 0!==s?s:o),o=null!=o?o:jn.Default.cull){case jn.CULL_NONE:this._cullStateCMD.addCMD(t.RenderStateType.CullFace,!1);break;case jn.CULL_FRONT:this._cullStateCMD.addCMD(t.RenderStateType.CullFace,!0),a=i==r?t.CullMode.Front:t.CullMode.Back,this._cullStateCMD.addCMD(t.RenderStateType.FrontFace,a);break;case jn.CULL_BACK:this._cullStateCMD.addCMD(t.RenderStateType.CullFace,!0),a=i!=r?t.CullMode.Front:t.CullMode.Back,this._cullStateCMD.addCMD(t.RenderStateType.FrontFace,a)}this._cullStateCMD.applyCMD()}uploadCustomUniform(t,e){g.renderEngine.uploadCustomUniforms(this._renderShaderInstance,this._customUniformParamsMap,t,e)}},t.ShaderNode=dt,t.ShaderPass=kn,t.ShaderValue=class{constructor(){}},t.ShaderVariable=jr,t.ShaderVariant=Fn,t.ShaderVariantCollection=On,t.SingletonList=En,t.SkinMeshBuffer=Re,t.SkinSV=qa,t.Socket=cn,t.Sound=class extends R{load(t){}play(t=0,e=0){return null}get duration(){return 0}dispose(){}},t.SoundChannel=Is,t.SoundManager=Os,t.SoundNode=Ns,t.Sprite=Ki,t.SpriteConst=Mt,t.SpriteStyle=si,t.SpriteUtils=ji,t.Stage=Cs,t.Stat=Nt,t.StatUI=Ka,t.StencilState=class{},t.StringKey=ot,t.SubShader=Vn,t.SubUniformBufferData=class extends Hn{constructor(t,e){super(t),this._isInPool=!1,this._needUpdate=!1,this._realByte=0,this._offset=e,this._realByte=this._bytelength,this._bytelength=256*Math.ceil(this._bytelength/256)}},t.Submit=we,t.SubmitBase=Ut,t.SubmitCMD=Et,t.SubmitCanvas=Me,t.SubmitKey=xt,t.SubmitTarget=De,t.SubmitTexture=Ie,t.System=class{static changeDefinition(t,e){window.Laya[t]=e;var i=t+"=classObj";window.eval(i)}},t.TTFLoader=un,t.Text=gr,t.TextAtlas=Fe,t.TextRender=He,t.TextResource=Da,t.TextStyle=mr,t.TextTexture=Le,t.Texture=ht,t.Texture2D=X,t.TextureSV=Za,t.TimeLine=yn,t.Timer=Es,t.TransformCmd=Si,t.TranslateCmd=Ri,t.Tween=Yi,t.TypedArrayClasses=Ia,t.URL=_t,t.UniformBufferBase=Yn,t.UniformBufferObject=zn,t.UnifromBufferData=Hn,t.UploadMemory=$n,t.UploadMemoryManager=Zn,t.Utils=d,t.Value2D=Tt,t.Vector2=ze,t.Vector3=Ke,t.Vector4=je,t.VectorGraphManager=Ni,t.VertexArrayObject=class{constructor(){}},t.VertexBuffer=Kt,t.VertexBuffer2D=qt,t.VertexDeclaration=kt,t.VertexElement=Wt,t.VertexElementFormat=Gt,t.VertexMesh=Wn,t.VideoNode=ks,t.VideoTexture=Us,t.WeakObject=_s,t.WebAudioSound=Fs,t.WebAudioSoundChannel=Ls,t.WebGL=Lr,t.WebGLCacheAsNormalCanvas=ee,t.WebGLEngine=$r,t.WebGLInternalRT=Ur,t.WebGLInternalTex=Nr,t.WebGLRTMgr=tt,t.WebGlConfig=class{},t.Widget=ns,t.WordText=Ue,t.WorkerLoader=Zi,t.alertGlobalError=sn,t.classInfo=function(t){return dummy2},t.enableDebugPanel=an,t.init=rn,t.isWXOpenDataContext=undefined,t.isWXPosMsg=undefined,t.lateTimer=undefined,t.property=function(t){return dummy2},t.regClass=function(){return dummy},t.runInEditor=function(t){},t.startTimer=undefined,t.updateTimer=undefined,t}({});