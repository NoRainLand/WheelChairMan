!function(t,e){"use strict";class i{}i.Skeleton=null,i.AnimationTemplet=null,i.Templet=null;class a{}class r{}class s{}class n{static parse(t,n){var h,l,o,u,p,_,d,c=n.__getBuffer(),m=n.readUTFString();t._aniClassName=m;var x,y=n.readUTFString().split("\n"),g=n.getUint8(),f=n.getUint32(),M=n.getUint32();f>0&&(x=c.slice(f,M));var D=new e.Byte(x);for(M>0&&(t._publicExtData=c.slice(M,c.byteLength)),t._useParent=!!n.getUint8(),t._anis.length=g,h=0;h<g;h++){var v=t._anis[h]=new a;v.nodes=[];var I=v.name=y[n.getUint16()];t._aniMap[I]=h,v.bone3DMap={},v.playTime=n.getFloat32();var A=v.nodes.length=n.getUint8();for(v.totalKeyframeDatasLength=0,l=0;l<A;l++){var S=v.nodes[l]=new r;S.childs=[];var b=n.getInt16();b>=0&&(S.name=y[b],v.bone3DMap[S.name]=l),S.keyFrame=[],S.parentIndex=n.getInt16(),-1==S.parentIndex?S.parent=null:S.parent=v.nodes[S.parentIndex],S.lerpType=n.getUint8();var T=n.getUint32();D.pos=T;var C=S.keyframeWidth=D.getUint16();if(v.totalKeyframeDatasLength+=C,0===S.lerpType||1===S.lerpType)for(S.interpolationMethod=[],S.interpolationMethod.length=C,o=0;o<C;o++)S.interpolationMethod[o]=i.AnimationTemplet.interpolation[D.getUint8()];null!=S.parent&&S.parent.childs.push(S);var F=n.getUint16();F>0&&(S.extenData=c.slice(n.pos,n.pos+F),n.pos+=F);var w=n.getUint16();S.keyFrame.length=w;var k,U=0;for(o=0,u=w;o<u;o++){if((k=S.keyFrame[o]=new s).duration=n.getFloat32(),k.startTime=U,2===S.lerpType){k.interpolationData=[];var B,P=n.getUint8();switch(B=n.getFloat32()){case 254:for(k.interpolationData.length=C,d=0;d<C;d++)k.interpolationData[d]=0;break;case 255:for(k.interpolationData.length=C,d=0;d<C;d++)k.interpolationData[d]=5;break;default:for(k.interpolationData.push(B),_=1;_<P;_++)k.interpolationData.push(n.getFloat32())}}for(k.data=new Float32Array(C),k.dData=new Float32Array(C),k.nextData=new Float32Array(C),p=0;p<C;p++)k.data[p]=n.getFloat32(),k.data[p]>-1e-8&&k.data[p]<1e-8&&(k.data[p]=0);U+=k.duration}k.startTime=v.playTime,S.playTime=v.playTime,t._calculateKeyFrame(S,w,C)}}}}class h{static READ_DATA(){h._DATA.offset=h._reader.getUint32(),h._DATA.size=h._reader.getUint32()}static READ_BLOCK(){for(var t=h._BLOCK.count=h._reader.getUint16(),e=h._BLOCK.blockStarts=[],i=h._BLOCK.blockLengths=[],a=0;a<t;a++)e.push(h._reader.getUint32()),i.push(h._reader.getUint32())}static READ_STRINGS(){var t=h._reader.getUint32(),e=h._reader.getUint16(),i=h._reader.pos;h._reader.pos=t+h._DATA.offset;for(var a=0;a<e;a++)h._strings[a]=h._reader.readUTFString();h._reader.pos=i}static parse(t,e){h._templet=t,h._reader=e,e.__getBuffer(),h.READ_DATA(),h.READ_BLOCK(),h.READ_STRINGS();for(var i=0,a=h._BLOCK.count;i<a;i++){var r=e.getUint16(),s=h._strings[r],n=h["READ_"+s];if(null==n)throw new Error("model file err,no this function:"+r+" "+s);n.call(null)}}static READ_ANIMATIONS(){var t,e,n,l,o=h._reader,u=o.__getBuffer(),p=o.getUint16(),_=[];for(_.length=p,t=0;t<p;t++)_[t]=i.AnimationTemplet.interpolation[o.getByte()];var d=o.getUint8();for(h._templet._anis.length=d,t=0;t<d;t++){var c=h._templet._anis[t]=new a;c.nodes=[];var m=c.name=h._strings[o.getUint16()];h._templet._aniMap[m]=t,c.bone3DMap={},c.playTime=o.getFloat32();var x=c.nodes.length=o.getInt16();for(c.totalKeyframeDatasLength=0,e=0;e<x;e++){var y=c.nodes[e]=new r;y.keyframeWidth=p,y.childs=[];var g=o.getUint16();g>=0&&(y.name=h._strings[g],c.bone3DMap[y.name]=e),y.keyFrame=[],y.parentIndex=o.getInt16(),-1==y.parentIndex?y.parent=null:y.parent=c.nodes[y.parentIndex],c.totalKeyframeDatasLength+=p,y.interpolationMethod=_,null!=y.parent&&y.parent.childs.push(y);var f=o.getUint16();y.keyFrame.length=f;var M=null,D=null;for(n=0,l=f;n<l;n++){(M=y.keyFrame[n]=new s).startTime=o.getFloat32(),D&&(D.duration=M.startTime-D.startTime),M.dData=new Float32Array(p),M.nextData=new Float32Array(p);var v=h._DATA.offset,I=o.getUint32(),A=4*p,S=u.slice(v+I,v+I+A);M.data=new Float32Array(S),D=M}M.duration=0,y.playTime=c.playTime,h._templet._calculateKeyFrame(y,f,p)}}}}h._strings=[],h._BLOCK={count:0},h._DATA={offset:0,size:0};class l{constructor(){}}l.stopped=0,l.paused=1,l.playing=2;class o extends e.EventDispatcher{get templet(){return this._templet}set templet(t){this.state!==l.stopped&&this.stop(!0),this._templet!==t&&(this._templet=t,this._computeFullKeyframeIndices())}get playStart(){return this._playStart}get playEnd(){return this._playEnd}get playDuration(){return this._playDuration}get overallDuration(){return this._overallDuration}get currentAnimationClipIndex(){return this._currentAnimationClipIndex}get currentKeyframeIndex(){return this._currentKeyframeIndex}get currentPlayTime(){return this._currentTime+this._playStart}get currentFrameTime(){return this._currentFrameTime}get cachePlayRate(){return this._cachePlayRate}set cachePlayRate(t){this._cachePlayRate!==t&&(this._cachePlayRate=t,this._templet&&this._computeFullKeyframeIndices())}get cacheFrameRate(){return this._cacheFrameRate}set cacheFrameRate(t){this._cacheFrameRate!==t&&(this._cacheFrameRate=t,this._cacheFrameRateInterval=1e3/this._cacheFrameRate,this._templet&&this._computeFullKeyframeIndices())}set currentTime(t){if(-1!==this._currentAnimationClipIndex&&this._templet){if(t<this._playStart||t>this._playEnd)throw new Error("AnimationPlayer:value must large than playStartTime,small than playEndTime.");this._startUpdateLoopCount=e.Stat.loopCount;var i=this._cacheFrameRateInterval*this._cachePlayRate;this._currentTime=t,this._currentKeyframeIndex=Math.floor(this.currentPlayTime/i),this._currentFrameTime=this._currentKeyframeIndex*i}}get paused(){return this._paused}set paused(t){this._paused=t,t&&this.event(e.Event.PAUSED)}get cacheFrameRateInterval(){return this._cacheFrameRateInterval}get state(){return-1===this._currentAnimationClipIndex?l.stopped:this._paused?l.paused:l.playing}get destroyed(){return this._destroyed}constructor(){super(),this.isCache=!0,this.playbackRate=1,this._destroyed=!1,this._currentAnimationClipIndex=-1,this._currentKeyframeIndex=-1,this._currentTime=0,this._overallDuration=Number.MAX_VALUE,this._stopWhenCircleFinish=!1,this._elapsedPlaybackTime=0,this._startUpdateLoopCount=-1,this._cachePlayRate=1,this.cacheFrameRate=60,this.returnToZeroStopped=!1}_onTempletLoadedComputeFullKeyframeIndices(t,e,i){this._templet===i&&this._cachePlayRate===t&&this._cacheFrameRate===e&&this._computeFullKeyframeIndices()}_computeFullKeyframeIndices(){}_onAnimationTempletLoaded(){this.destroyed||this._calculatePlayDuration()}_calculatePlayDuration(){if(this.state!==l.stopped){var t=this._templet.getAniDuration(this._currentAnimationClipIndex);0===this._playEnd&&(this._playEnd=t),this._playEnd>t&&(this._playEnd=t),this._playDuration=this._playEnd-this._playStart}}_setPlayParams(t,e){this._currentTime=t,this._currentKeyframeIndex=Math.floor(this.currentPlayTime/e+.01),this._currentFrameTime=this._currentKeyframeIndex*e}_setPlayParamsWhenStop(t,e,i=-1){this._currentTime=t;var a=i>0?i:t;this._currentKeyframeIndex=Math.floor(a/e+.01),this._currentKeyframeIndex=Math.floor(t/e+.01),this._currentFrameTime=this._currentKeyframeIndex*e,this._currentAnimationClipIndex=-1}_update(t){if(-1!==this._currentAnimationClipIndex&&!this._paused&&this._templet){var i=this._cacheFrameRateInterval*this._cachePlayRate,a=0;this._startUpdateLoopCount!==e.Stat.loopCount&&(a=t*this.playbackRate,this._elapsedPlaybackTime+=a);var r=this.playDuration;if(a+=this._currentTime,0!==this._overallDuration&&this._elapsedPlaybackTime>=this._overallDuration||0===this._overallDuration&&this._elapsedPlaybackTime>=r||0===this._overallDuration&&a>=this.playEnd)return this._setPlayParamsWhenStop(r,i,this.playEnd),void this.event(e.Event.STOPPED);if(r>0){if(a>=r)return this._stopWhenCircleFinish?(this._setPlayParamsWhenStop(r,i),this._stopWhenCircleFinish=!1,void this.event(e.Event.STOPPED)):(a%=r,this._setPlayParams(a,i),void this.event(e.Event.COMPLETE));this._setPlayParams(a,i)}else{if(this._stopWhenCircleFinish)return this._setPlayParamsWhenStop(r,i),this._stopWhenCircleFinish=!1,void this.event(e.Event.STOPPED);this._currentTime=this._currentFrameTime=this._currentKeyframeIndex=0,this.event(e.Event.COMPLETE)}}}_destroy(){this.offAll(),this._templet=null,this._destroyed=!0}play(t=0,i=1,a=2147483647,r=0,s=0){if(!this._templet)throw new Error("AnimationPlayer:templet must not be null,maybe you need to set url.");if(a<0||r<0||s<0)throw new Error("AnimationPlayer:overallDuration,playStart and playEnd must large than zero.");if(0!==s&&r>s)throw new Error("AnimationPlayer:start must less than end.");this._currentTime=0,this._currentFrameTime=0,this._elapsedPlaybackTime=0,this.playbackRate=i,this._overallDuration=a,this._playStart=r,this._playEnd=s,this._paused=!1,this._currentAnimationClipIndex=t,this._currentKeyframeIndex=0,this._startUpdateLoopCount=e.Stat.loopCount,this.event(e.Event.PLAYED),this._calculatePlayDuration(),this._update(0)}playByFrame(t=0,e=1,i=2147483647,a=0,r=0,s=30){var n=1e3/s;this.play(t,e,i,a*n,r*n)}stop(t=!0){t?(this._currentTime=this._currentFrameTime=this._currentKeyframeIndex=0,this._currentAnimationClipIndex=-1,this.event(e.Event.STOPPED)):this._stopWhenCircleFinish=!0}destroy(){}}class u{constructor(){}static getBezierRate(t,e,i,a,r){var s=u._getBezierParamKey(e,i,a,r),n=100*s+t;if(u._bezierResultCache[n])return u._bezierResultCache[n];var h,l,o=u._getBezierPoints(e,i,a,r,s);for(l=o.length,h=0;h<l;h+=2)if(t<=o[h])return u._bezierResultCache[n]=o[h+1],o[h+1];return u._bezierResultCache[n]=1,1}static _getBezierParamKey(t,e,i,a){return 100*(100*(100*(100*t+e)+i)+a)}static _getBezierPoints(t,i,a,r,s){return u._bezierPointsCache[s]?u._bezierPointsCache[s]:(n=[0,0,t,i,a,r,1,1],h=(new e.Bezier).getBezierPoints(n,100,3),u._bezierPointsCache[s]=h,h);var n,h}}u._bezierResultCache={},u._bezierPointsCache={};class p extends e.Resource{static _LinearInterpolation_0(t,e,i,a,r,s,n,h,l,o=null){return i[a]=r[e]+s*n[e],1}static _QuaternionInterpolation_1(t,i,a,r,s,n,h,l,o,u=null){var p=0===l?0:n/l;return e.MathUtil.slerpQuaternionArray(s,i,o,i,p,a,r),4}static _AngleInterpolation_2(t,e,i,a,r,s,n,h,l,o=null){return 0}static _RadiansInterpolation_3(t,e,i,a,r,s,n,h,l,o=null){return 0}static _Matrix4x4Interpolation_4(t,e,i,a,r,s,n,h,l,o=null){for(let t=0;t<16;t++,e++)i[a+t]=r[e]+s*n[e];return 16}static _NoInterpolation_5(t,e,i,a,r,s,n,h,l,o=null){return i[a]=r[e],1}static _BezierInterpolation_6(t,e,i,a,r,s,n,h,l,o=null,p=0){return i[a]=r[e]+(l[e]-r[e])*u.getBezierRate(s/h,o[p],o[p+1],o[p+2],o[p+3]),5}static _BezierInterpolation_7(t,e,i,a,r,s,n,h,l,o=null,p=0){return i[a]=o[p+4]+o[p+5]*u.getBezierRate((.001*s+o[p+6])/o[p+7],o[p],o[p+1],o[p+2],o[p+3]),9}constructor(){super(),this._anis=[],this._aniMap={},this.unfixedLastAniIndex=-1,this._fullFrames=null,this._boneCurKeyFrm=[]}_calculateKeyFrame(t,e,i){var a=t.keyFrame;a[e]=a[0];for(var r=0;r<e;r++)for(var s=a[r],n=0;n<i;n++)s.dData[n]=0===s.duration?0:(a[r+1].data[n]-s.data[n])/s.duration,s.nextData[n]=a[r+1].data[n];a.length--}_onAsynLoaded(t,i=null){var a=new e.Byte(t);if(this._aniVersion=a.readUTFString(),"LAYAANIMATION:02"===this._aniVersion)h.parse(this,a);else n.parse(this,a)}getAnimationCount(){return this._anis.length}getAnimation(t){return this._anis[t]}getAniDuration(t){return this._anis[t].playTime}getNodes(t){return this._anis[t].nodes}getNodeIndexWithName(t,e){return this._anis[t].bone3DMap[e]}getNodeCount(t){return this._anis[t].nodes.length}getTotalkeyframesLength(t){return this._anis[t].totalKeyframeDatasLength}getPublicExtData(){return this._publicExtData}getAnimationDataWithCache(t,e,i,a){var r=e[i];if(r){var s=r[t];return s?s[a]:null}return null}setAnimationDataWithCache(t,e,i,a,r){var s=e[i]||(e[i]={});(s[t]||(s[t]=[]))[a]=r}getNodeKeyFrame(t,e,i){var a=this._boneCurKeyFrm[e],r=t.length;(null==a||a>=r)&&(a=this._boneCurKeyFrm[e]=0);var s=t[a],n=i-s.startTime;if(0==n||n>0&&s.duration>n)return a;var h=0;if(n>0){for(i+=.01,h=a+1;h<r;h++)if((s=t[h]).startTime<=i&&s.startTime+s.duration>i)return this._boneCurKeyFrm[e]=h,h;return r-1}for(h=0;h<a;h++)if((s=t[h]).startTime<=i&&s.startTime+s.duration>i)return this._boneCurKeyFrm[e]=h,h;return a}getOriginalData(t,e,i,a,r){var s=this._anis[t].nodes,n=this._boneCurKeyFrm;n.length<s.length&&(n.length=s.length);for(var h=0,l=0,o=s.length,u=0;l<o;l++){var _,d=s[l],c=d.keyFrame;_=c[this.getNodeKeyFrame(c,l,r)],d.dataOffset=u;var m=r-_.startTime,x=d.lerpType;if(x)switch(x){case 0:case 1:for(h=0;h<d.keyframeWidth;)h+=d.interpolationMethod[h](d,h,e,u+h,_.data,m,_.dData,_.duration,_.nextData);break;case 2:var y=_.interpolationData,g=y.length,f=0;for(h=0;h<g;){var M=y[h];switch(M){case 6:case 7:h+=p.interpolation[M](d,f,e,u+f,_.data,m,_.dData,_.duration,_.nextData,y,h+1);break;default:h+=p.interpolation[M](d,f,e,u+f,_.data,m,_.dData,_.duration,_.nextData)}f++}}else for(h=0;h<d.keyframeWidth;)h+=d.interpolationMethod[h](d,h,e,u+h,_.data,m,_.dData,_.duration,_.nextData);u+=d.keyframeWidth}}getNodesCurrentFrameIndex(t,e){var i=this._anis[t].nodes;t!==this.unfixedLastAniIndex&&(this.unfixedCurrentFrameIndexes=new Uint32Array(i.length),this.unfixedCurrentTimes=new Float32Array(i.length),this.unfixedLastAniIndex=t);for(var a=0,r=i.length;a<r;a++){var s=i[a];for(e<this.unfixedCurrentTimes[a]&&(this.unfixedCurrentFrameIndexes[a]=0),this.unfixedCurrentTimes[a]=e;this.unfixedCurrentFrameIndexes[a]<s.keyFrame.length&&!(s.keyFrame[this.unfixedCurrentFrameIndexes[a]].startTime>this.unfixedCurrentTimes[a]);)this.unfixedCurrentFrameIndexes[a]++;this.unfixedCurrentFrameIndexes[a]--}return this.unfixedCurrentFrameIndexes}getOriginalDataUnfixedRate(t,e,i){var a=this._anis[t].nodes;t!==this.unfixedLastAniIndex&&(this.unfixedCurrentFrameIndexes=new Uint32Array(a.length),this.unfixedCurrentTimes=new Float32Array(a.length),this.unfixedKeyframes=[],this.unfixedLastAniIndex=t);for(var r=0,s=0,n=a.length,h=0;s<n;s++){var l=a[s];for(i<this.unfixedCurrentTimes[s]&&(this.unfixedCurrentFrameIndexes[s]=0),this.unfixedCurrentTimes[s]=i;this.unfixedCurrentFrameIndexes[s]<l.keyFrame.length&&!(l.keyFrame[this.unfixedCurrentFrameIndexes[s]].startTime>this.unfixedCurrentTimes[s]);)this.unfixedKeyframes[s]=l.keyFrame[this.unfixedCurrentFrameIndexes[s]],this.unfixedCurrentFrameIndexes[s]++;var o=this.unfixedKeyframes[s];l.dataOffset=h;var u=i-o.startTime;if(l.lerpType)switch(l.lerpType){case 0:case 1:for(r=0;r<l.keyframeWidth;)r+=l.interpolationMethod[r](l,r,e,h+r,o.data,u,o.dData,o.duration,o.nextData);break;case 2:var _=o.interpolationData,d=_.length,c=0;for(r=0;r<d;){var m=_[r];switch(m){case 6:case 7:r+=p.interpolation[m](l,c,e,h+c,o.data,u,o.dData,o.duration,o.nextData,_,r+1);break;default:r+=p.interpolation[m](l,c,e,h+c,o.data,u,o.dData,o.duration,o.nextData)}c++}}else for(r=0;r<l.keyframeWidth;)r+=l.interpolationMethod[r](l,r,e,h+r,o.data,u,o.dData,o.duration,o.nextData);h+=l.keyframeWidth}}}p.interpolation=[p._LinearInterpolation_0,p._QuaternionInterpolation_1,p._AngleInterpolation_2,p._RadiansInterpolation_3,p._Matrix4x4Interpolation_4,p._NoInterpolation_5,p._BezierInterpolation_6,p._BezierInterpolation_7],i.AnimationTemplet=p;class _ extends e.Graphics{drawSkin(t,i){this.drawTriangles(t.texture,0,0,t.vertices,t.uvs,t.indexes,t.transform||e.Matrix.EMPTY,i)}static create(){return _._caches.pop()||new _}static recycle(t){t.clear(),_._caches.push(t)}}_._caches=[];class d{constructor(t,e){this.isSpine=!0,this.isDebug=!1,this._targetBone=e[t.targetBoneIndex],this.isSpine=t.isSpine,null==this._bones&&(this._bones=[]),this._bones.length=0;for(var i=0,a=t.boneIndexs.length;i<a;i++)this._bones.push(e[t.boneIndexs[i]]);this.name=t.name,this.mix=t.mix,this.bendDirection=t.bendDirection}apply(){switch(this._bones.length){case 1:this._applyIk1(this._bones[0],this._targetBone.resultMatrix.tx,this._targetBone.resultMatrix.ty,this.mix);break;case 2:this.isSpine?this._applyIk2(this._bones[0],this._bones[1],this._targetBone.resultMatrix.tx,this._targetBone.resultMatrix.ty,this.bendDirection,this.mix):this._applyIk3(this._bones[0],this._bones[1],this._targetBone.resultMatrix.tx,this._targetBone.resultMatrix.ty,this.bendDirection,this.mix)}}_applyIk1(t,e,i,a){var r=t.parentBone,s=1/(r.resultMatrix.a*r.resultMatrix.d-r.resultMatrix.b*r.resultMatrix.c),n=e-r.resultMatrix.tx,h=i-r.resultMatrix.ty,l=(n*r.resultMatrix.d-h*r.resultMatrix.c)*s-t.transform.x,o=(h*r.resultMatrix.a-n*r.resultMatrix.b)*s-t.transform.y,u=Math.atan2(o,l)*d.radDeg-0-t.transform.skX;t.transform.scX<0&&(u+=180),u>180?u-=360:u<-180&&(u+=360),t.transform.skX=t.transform.skY=t.transform.skX+u*a,t.update()}updatePos(t,e){this._sp&&this._sp.pos(t,e)}_applyIk2(t,i,a,r,s,n){if(0!=n){var h,l,o,u=t.resultTransform.x,p=t.resultTransform.y,_=t.transform.scX,c=t.transform.scY,m=i.transform.scX;_<0?(_=-_,h=180,o=-1):(h=0,o=1),c<0&&(c=-c,o=-o),m<0?(m=-m,l=180):l=0;var x,y,g,f=i.resultTransform.x,M=t.resultMatrix.a,D=t.resultMatrix.c,v=t.resultMatrix.b,I=t.resultMatrix.d,A=Math.abs(_-c)<=1e-4;A?(y=M*f+D*(x=i.resultTransform.y)+t.resultMatrix.tx,g=v*f+I*x+t.resultMatrix.ty):(x=0,y=M*f+t.resultMatrix.tx,g=v*f+t.resultMatrix.ty),this.isDebug&&(this._sp||(this._sp=new e.Sprite,e.ILaya.stage.addChild(this._sp)),this._sp.graphics.clear(),this._sp.graphics.drawCircle(a,r,15,"#ffff00"),this._sp.graphics.drawCircle(y,g,15,"#ff00ff")),t.setRotation(Math.atan2(g-t.resultMatrix.ty,y-t.resultMatrix.tx));var S=t.parentBone;M=S.resultMatrix.a,D=S.resultMatrix.c,v=S.resultMatrix.b;var b,T,C=1/(M*(I=S.resultMatrix.d)-D*v),F=a-S.resultMatrix.tx,w=r-S.resultMatrix.ty,k=(F*I-w*D)*C-u,U=(w*M-F*v)*C-p,B=((F=y-S.resultMatrix.tx)*I-(w=g-S.resultMatrix.ty)*D)*C-u,P=(w*M-F*v)*C-p,L=Math.sqrt(B*B+P*P),N=i.length*m;if(A){var E=(k*k+U*U-L*L-(N*=_)*N)/(2*L*N);E<-1?E=-1:E>1&&(E=1),T=Math.acos(E)*s,M=L+N*E,D=N*Math.sin(T),b=Math.atan2(U*M-k*D,k*M+U*D)}else{var R=(M=_*N)*M,V=(D=c*N)*D,O=k*k+U*U,K=Math.atan2(U,k),Y=-2*V*L,X=V-R;if((I=Y*Y-4*X*(v=V*L*L+R*O-R*V))>0){var W=Math.sqrt(I);Y<0&&(W=-W);var z=(W=-(Y+W)/2)/X,G=v/W,q=Math.abs(z)<Math.abs(G)?z:G;q*q<=O&&(w=Math.sqrt(O-q*q)*s,b=K-Math.atan2(w,q),T=Math.atan2(w/c,(q-L)/_))}var H=0,Q=Number.MAX_VALUE,Z=0,j=0,J=0,$=0,tt=0,et=0;(I=(F=L+M)*F)>$&&(J=0,$=I,tt=F),(I=(F=L-M)*F)<Q&&(H=Math.PI,Q=I,Z=F);var it=Math.acos(-M*L/(R-V));(I=(F=M*Math.cos(it)+L)*F+(w=D*Math.sin(it))*w)<Q&&(H=it,Q=I,Z=F,j=w),I>$&&(J=it,$=I,tt=F,et=w),O<=(Q+$)/2?(b=K-Math.atan2(j*s,Z),T=H*s):(b=K-Math.atan2(et*s,tt),T=J*s)}var at=Math.atan2(x,f)*o,rt=t.resultTransform.skX;(b=(b-at)*d.radDeg+h-rt)>180?b-=360:b<-180&&(b+=360),t.resultTransform.x=u,t.resultTransform.y=p,t.resultTransform.skX=t.resultTransform.skY=rt+b*n,rt=i.resultTransform.skX,rt%=360,(T=((T+at)*d.radDeg-0)*o+l-rt)>180?T-=360:T<-180&&(T+=360),i.resultTransform.x=f,i.resultTransform.y=x,i.resultTransform.skX=i.resultTransform.skY=i.resultTransform.skY+T*n,t.update()}}_applyIk3(t,i,a,r,s,n){if(0==n)return;var h,l;const o=i.resultMatrix.a*i.length,u=i.resultMatrix.b*i.length,p=o*o+u*u,_=Math.sqrt(p);var c=t.resultMatrix.tx,m=t.resultMatrix.ty,x=i.resultMatrix.tx,y=i.resultMatrix.ty,g=x-c,f=y-m;const M=g*g+f*f,D=Math.sqrt(M),v=(g=a-t.resultMatrix.tx)*g+(f=r-t.resultMatrix.ty)*f,I=Math.sqrt(v);if(_+D<=I||I+_<=D||I+D<=_){var A;x=c+(A=_+D<=I?1:-1)*(a-c)*D/I,y=m+A*(r-m)*D/I}else{const t=(M-p+v)/(2*v),e=Math.sqrt(M-t*t*v)/I,i=c+g*t,a=m+f*t,r=-f*e,n=g*e;s>0?(x=i-r,y=a-n):(x=i+r,y=a+n)}var S,b,T,C;h=x,l=y,this.isDebug&&(this._sp||(this._sp=new e.Sprite,e.ILaya.stage.addChild(this._sp)),this._sp.graphics.clear(),this._sp.graphics.drawCircle(c,m,15,"#ff00ff"),this._sp.graphics.drawCircle(a,r,15,"#ffff00"),this._sp.graphics.drawCircle(h,l,15,"#ff00ff")),S=Math.atan2(l-t.resultMatrix.ty,h-t.resultMatrix.tx),t.setRotation(S),(b=d._tempMatrix).identity(),b.rotate(S),b.scale(t.resultMatrix.getScaleX(),t.resultMatrix.getScaleY()),b.translate(t.resultMatrix.tx,t.resultMatrix.ty),b.copyTo(t.resultMatrix),t.updateChild(),T=Math.atan2(r-l,a-h),i.setRotation(T),(C=d._tempMatrix).identity(),C.rotate(T),C.scale(i.resultMatrix.getScaleX(),i.resultMatrix.getScaleY()),C.translate(h,l),b.copyTo(i.resultMatrix),i.updateChild()}}d.radDeg=180/Math.PI,d.degRad=Math.PI/180,d._tempMatrix=new e.Matrix;class c{constructor(t,e){this._debugKey=!1,this._segments=[],this._curves=[],this.data=t,this.position=t.position,this.spacing=t.spacing,this.rotateMix=t.rotateMix,this.translateMix=t.translateMix,this.bones=[];for(var i=this.data.bones,a=0,r=i.length;a<r;a++)this.bones.push(e[i[a]])}apply(t,e){if(this.target){var i=this.translateMix,a=this.translateMix,r=a>0,s=this.data.spacingMode,n="length"==s,h=this.data.rotateMode,l="tangent"==h,o="chainScale"==h,u=[],p=this.bones.length,_=l?p:p+1,d=[];this._spaces=d,d[0]=this.position;var c=this.spacing;if(o||n)for(var m=0,x=_-1;m<x;){var y=this.bones[m],g=y.length,f=g*y.resultMatrix.a,M=g*y.resultMatrix.b;g=Math.sqrt(f*f+M*M),o&&(u[m]=g),d[++m]=n?Math.max(0,g+c):c}else for(m=1;m<_;m++)d[m]=c;var D=this.computeWorldPositions(this.target,t,e,_,l,"percent"==this.data.positionMode,"percent"==s);if(this._debugKey){for(m=0;m<D.length;m++)e.drawCircle(D[m++],D[m++],5,"#00ff00");var v=[];for(m=0;m<D.length;m++)v.push(D[m++],D[m++]);e.drawLines(0,0,v,"#ff0000")}var I,A=D[0],S=D[1],b=this.data.offsetRotation,T="chain"==h&&0==b;for(m=0,I=3;m<p;m++,I+=3){(y=this.bones[m]).resultMatrix.tx+=(A-y.resultMatrix.tx)*i,y.resultMatrix.ty+=(S-y.resultMatrix.ty)*i;var C=(f=D[I])-A,F=(M=D[I+1])-S;if(o&&0!=(g=u[m])){var w=(Math.sqrt(C*C+F*F)/g-1)*a+1;y.resultMatrix.a*=w,y.resultMatrix.c*=w}if(A=f,S=M,r){var k,U,B,P=y.resultMatrix.a,L=y.resultMatrix.c,N=y.resultMatrix.b,E=y.resultMatrix.d;k=l?D[I-1]:0==d[m+1]?D[I+2]:Math.atan2(F,C),k-=Math.atan2(N,P)-b/180*Math.PI,T&&(U=Math.cos(k),B=Math.sin(k),A+=((g=y.length)*(U*P-B*N)-C)*a,S+=(g*(B*P+U*N)-F)*a),k>Math.PI?k-=2*Math.PI:k<-Math.PI&&(k+=2*Math.PI),k*=a,U=Math.cos(k),B=Math.sin(k),y.resultMatrix.a=U*P-B*N,y.resultMatrix.c=U*L-B*E,y.resultMatrix.b=B*P+U*N,y.resultMatrix.d=B*L+U*E}}}}computeWorldVertices2(t,e,i,a,r,s){var n,h,l,o=t.currDisplayData.bones,u=t.currDisplayData.weights,p=t.currDisplayData.triangles,_=0,d=0,m=0,x=0,y=0,g=0,f=0,M=0,D=0,v=0;if(null!=o){for(_=0;_<i;_+=2)d+=(x=o[d])+1,m+=x;var I=e;for(y=s,g=3*m;y<a;y+=2){for(f=0,M=0,x=o[d++],x+=d;d<x;d++,g+=3){n=I[o[d]].resultMatrix,D=u[g],v=u[g+1];var A=u[g+2];f+=(D*n.a+v*n.c+n.tx)*A,M+=(D*n.b+v*n.d+n.ty)*A}r[y]=f,r[y+1]=M}}else{var S,b;if(p||(p=u),t.deformData&&(p=t.deformData),S=t.parent,e)for(l=e.length,_=0;_<l;_++)if(e[_].name==S){h=e[_];break}h&&(b=h.resultMatrix),b||(b=c._tempMt);var T=b.tx,C=b.ty,F=b.a,w=b.b,k=b.c,U=b.d;for(h&&(U*=h.d),d=i,y=s;y<a;d+=2,y+=2)D=p[d],v=p[d+1],r[y]=D*F+v*w+T,r[y+1]=-(D*k+v*U+C)}}computeWorldPositions(t,e,i,a,r,s,n){t.currDisplayData.bones,t.currDisplayData.weights,t.currDisplayData.triangles;var h,l,o,u,p,_,d,c,m=[],x=0,y=t.currDisplayData.verLen,g=this.position,f=this._spaces,M=[],D=y/6,v=-1;if(D--,y-=4,this.computeWorldVertices2(t,e,2,y,m,0),this._debugKey)for(x=0;x<m.length;)i.drawCircle(m[x++],m[x++],10,"#ff0000");h=m,this._curves.length=D;var I=this._curves;l=0;var A,S,b,T,C,F,w,k,U,B=h[0],P=h[1],L=0,N=0,E=0,R=0,V=0,O=0;for(x=0,U=2;x<D;x++,U+=6)C=2*(A=.1875*(B-2*(L=h[U])+(E=h[U+2])))+(b=.09375*(3*(L-E)-B+(V=h[U+4]))),F=2*(S=.1875*(P-2*(N=h[U+1])+(R=h[U+3])))+(T=.09375*(3*(N-R)-P+(O=h[U+5]))),w=.75*(L-B)+A+.16666667*b,k=.75*(N-P)+S+.16666667*T,l+=Math.sqrt(w*w+k*k),w+=C,k+=F,C+=b,F+=T,l+=Math.sqrt(w*w+k*k),w+=C,k+=F,l+=Math.sqrt(w*w+k*k),w+=C+b,k+=F+T,l+=Math.sqrt(w*w+k*k),I[x]=l,B=V,P=O;if(s&&(g*=l),n)for(x=0;x<a;x++)f[x]*=l;var K,Y=this._segments,X=0;for(x=0,o=0,u=0,K=0;x<a;x++,o+=3)if((p=g+=_=f[x])<0)this.addBeforePosition(p,h,0,M,o);else if(p>l)this.addAfterPosition(p-l,h,y-4,M,o);else{for(;;u++)if(!(p>(c=I[u]))){0==u?p/=c:p=(p-(d=I[u-1]))/(c-d);break}if(u!=v){v=u;var W=6*u;for(C=2*(A=.03*((B=h[W])-2*(L=h[W+2])+(E=h[W+4])))+(b=.006*(3*(L-E)-B+(V=h[W+6]))),F=2*(S=.03*((P=h[W+1])-2*(N=h[W+3])+(R=h[W+5])))+(T=.006*(3*(N-R)-P+(O=h[W+7]))),w=.3*(L-B)+A+.16666667*b,k=.3*(N-P)+S+.16666667*T,X=Math.sqrt(w*w+k*k),Y[0]=X,W=1;W<8;W++)w+=C,k+=F,C+=b,F+=T,X+=Math.sqrt(w*w+k*k),Y[W]=X;w+=C,k+=F,X+=Math.sqrt(w*w+k*k),Y[8]=X,w+=C+b,k+=F+T,X+=Math.sqrt(w*w+k*k),Y[9]=X,K=0}for(p*=X;;K++)if(!(p>(c=Y[K]))){0==K?p/=c:p=K+(p-(d=Y[K-1]))/(c-d);break}this.addCurvePosition(.1*p,B,P,L,N,E,R,V,O,M,o,r||x>0&&0==_)}return M}addBeforePosition(t,e,i,a,r){var s=e[i],n=e[i+1],h=e[i+2]-s,l=e[i+3]-n,o=Math.atan2(l,h);a[r]=s+t*Math.cos(o),a[r+1]=n+t*Math.sin(o),a[r+2]=o}addAfterPosition(t,e,i,a,r){var s=e[i+2],n=e[i+3],h=s-e[i],l=n-e[i+1],o=Math.atan2(l,h);a[r]=s+t*Math.cos(o),a[r+1]=n+t*Math.sin(o),a[r+2]=o}addCurvePosition(t,e,i,a,r,s,n,h,l,o,u,p){0==t&&(t=1e-4);var _=t*t,d=_*t,c=1-t,m=c*c,x=m*c,y=c*t,g=3*y,f=c*g,M=g*t,D=e*x+a*f+s*M+h*d,v=i*x+r*f+n*M+l*d;o[u]=D,o[u+1]=v,o[u+2]=p?Math.atan2(v-(i*m+r*y*2+n*_),D-(e*m+a*y*2+s*_)):0}}c.BEFORE=-2,c.AFTER=-3,c._tempMt=new e.Matrix;class m{constructor(t,e){var i,a;for(this._temp=[],this._data=t,null==this._bones&&(this._bones=[]),this.target=e[t.targetIndex],i=0,a=t.boneIndexs.length;i<a;i++)this._bones.push(e[t.boneIndexs[i]]);this.rotateMix=t.rotateMix,this.translateMix=t.translateMix,this.scaleMix=t.scaleMix,this.shearMix=t.shearMix}apply(){for(var t,e=this.target.resultMatrix.a,i=this.target.resultMatrix.b,a=this.target.resultMatrix.c,r=this.target.resultMatrix.d,s=0,n=this._bones.length;s<n;s++){if(t=this._bones[s],this.rotateMix>0){var h=t.resultMatrix.a,l=t.resultMatrix.b,o=t.resultMatrix.c,u=t.resultMatrix.d,p=Math.atan2(a,e)-Math.atan2(o,h)+this._data.offsetRotation*Math.PI/180;p>Math.PI?p-=2*Math.PI:p<-Math.PI&&(p+=2*Math.PI),p*=this.rotateMix;var _=Math.cos(p),d=Math.sin(p);t.resultMatrix.a=_*h-d*o,t.resultMatrix.b=_*l-d*u,t.resultMatrix.c=d*h+_*o,t.resultMatrix.d=d*l+_*u}if(this.translateMix&&(this._temp[0]=this._data.offsetX,this._temp[1]=this._data.offsetY,this.target.localToWorld(this._temp),t.resultMatrix.tx+=(this._temp[0]-t.resultMatrix.tx)*this.translateMix,t.resultMatrix.ty+=(this._temp[1]-t.resultMatrix.ty)*this.translateMix,t.updateChild()),this.scaleMix>0){var c=Math.sqrt(t.resultMatrix.a*t.resultMatrix.a+t.resultMatrix.c*t.resultMatrix.c),m=Math.sqrt(e*e+a*a),x=c>1e-5?(c+(m-c+this._data.offsetScaleX)*this.scaleMix)/c:0;t.resultMatrix.a*=x,t.resultMatrix.c*=x,c=Math.sqrt(t.resultMatrix.b*t.resultMatrix.b+t.resultMatrix.d*t.resultMatrix.d),m=Math.sqrt(i*i+r*r),x=c>1e-5?(c+(m-c+this._data.offsetScaleY)*this.scaleMix)/c:0,t.resultMatrix.b*=x,t.resultMatrix.d*=x}if(this.shearMix>0){l=t.resultMatrix.b,u=t.resultMatrix.d;var y=Math.atan2(u,l);(p=Math.atan2(r,i)-Math.atan2(a,e)-(y-Math.atan2(t.resultMatrix.c,t.resultMatrix.a)))>Math.PI?p-=2*Math.PI:p<-Math.PI&&(p+=2*Math.PI),p=y+(p+this._data.offsetShearY*Math.PI/180)*this.shearMix,x=Math.sqrt(l*l+u*u),t.resultMatrix.b=Math.cos(p)*x,t.resultMatrix.d=Math.sin(p)*x}}}}class x extends e.Sprite{constructor(t=0){super(),this._boneMatrixArray=[],this._lastTime=0,this._currAniIndex=-1,this._pause=!0,this._aniClipIndex=-1,this._clipIndex=-1,this._skinIndex=0,this._skinName="default",this._aniMode=0,this._index=-1,this._total=-1,this._indexControl=!1,this._eventIndex=0,this._drawOrderIndex=0,this._drawOrder=null,this._lastAniClipIndex=-1,this._lastUpdateAniClipIndex=-1,this._playAudio=!0,this._soundChannelArr=[],this._animationName="",this._loop=!0,this._aniMode=t}get index(){return this._index}set index(t){this.player&&(this._index=t,this._player.currentTime=1e3*this._index/this._player.cacheFrameRate,this._indexControl=!0,(this._aniClipIndex<0||this._aniClipIndex>=this.getAnimNum())&&(this._aniClipIndex=0,this._currAniIndex=0,this._curOriginalData=new Float32Array(this._templet.getTotalkeyframesLength(this._currAniIndex)),this._drawOrder=null,this._eventIndex=0),this._update(!1))}get total(){return this._templet&&this._player?this._total=Math.floor(this._templet.getAniDuration(this._player.currentAnimationClipIndex)/1e3*this._player.cacheFrameRate):this._total=-1,this._total}get player(){return this._player}get skinName(){return this._skinName}set skinName(t){this._skinName=t,this._templet&&this.showSkinByName(t)}get animationName(){return this._animationName}set animationName(t){this._animationName=t,this._templet&&this.play(t,this._loop,!0)}get loop(){return this._loop}set loop(t){this._loop=t,this._templet&&this.play(this._animationName,this._loop,!0)}get templet(){return this._templet}set templet(t){this.init(t)}get source(){return this._source}set source(t){this._source=t,t?e.ILaya.loader.load(t).then((t=>{t&&!t.isCreateFromURL(this._source)||(this.templet=t)})):this.templet=null}get aniMode(){return this._aniMode}set aniMode(t){this._aniMode=t}init(t){if(this._templet&&(this.reset(),this.graphics.clear()),this._templet=t,this._templet){if(1==this._aniMode){this._graphicsCache=[];for(let e=0,i=t.getAnimationCount();e<i;e++)this._graphicsCache.push([])}if(this._yReverseMatrix=t.yReverseMatrix,this._templet._addReference(1),this._player=new o,this._player.templet=t,this._player.play(),this._parseSrcBoneMatrix(),this._boneList=t.mBoneArr,this._rootBone=t.mRootBone,this._aniSectionDic=t.aniSectionDic,t.ikArr.length>0){this._ikArr=[];for(let e=0,i=t.ikArr.length;e<i;e++)this._ikArr.push(new d(t.ikArr[e],this._boneList))}if(t.pathArr.length>0){this._pathDic={};for(let e=0,i=t.pathArr.length;e<i;e++){let i=t.pathArr[e],a=new c(i,this._boneList),r=this._boneSlotDic[i.name];r&&(a=new c(i,this._boneList),a.target=r),this._pathDic[i.name]=a}}if(t.tfArr.length>0){this._tfArr=[];for(let e=0,i=t.tfArr.length;e<i;e++)this._tfArr.push(new m(t.tfArr[e],this._boneList))}t.skinDataArray.length>0&&(this._skinIndex=this._templet.getSkinIndexByName(this._skinName),-1==this._skinIndex&&(this._skinIndex=0)),this._player.on(e.Event.PLAYED,this,this._onPlay),this._player.on(e.Event.STOPPED,this,this._onStop),this._player.on(e.Event.PAUSED,this,this._onPause),e.LayaEnv.isPlaying&&this._animationName&&this.play(this._animationName,this._loop,!0)}}load(t,i=null){e.ILaya.loader.load(t).then((e=>{null!=e&&e.isCreateFromURL(t)&&(this.init(e),this.play(0,!0),this._complete&&this._complete.runWith(this))}))}_onPlay(){this.event(e.Event.PLAYED)}_onStop(){let t=this._templet.eventAniArr[this._aniClipIndex];if(t&&this._eventIndex<t.length)for(;this._eventIndex<t.length;this._eventIndex++){let i=t[this._eventIndex];i.time>=this._player.playStart&&i.time<=this._player.playEnd&&this.event(e.Event.LABEL,i)}this._drawOrder=null,this.event(e.Event.STOPPED)}_onPause(){this.event(e.Event.PAUSED)}_parseSrcBoneMatrix(){let t=this._templet.srcBoneMatrixArr.length;for(let i=0;i<t;i++)this._boneMatrixArray.push(new e.Matrix);if(0==this._aniMode)this._boneSlotDic=this._templet.boneSlotDic,this._bindBoneBoneSlotDic=this._templet.bindBoneBoneSlotDic,this._boneSlotArray=this._templet.boneSlotArray;else{this._boneSlotDic={},this._bindBoneBoneSlotDic={},this._boneSlotArray=[];let t=this._templet.boneSlotArray;for(let e=0,i=t.length;e<i;e++){let i=t[e],a=this._bindBoneBoneSlotDic[i.parent];null==a&&(this._bindBoneBoneSlotDic[i.parent]=a=[]),this._boneSlotDic[i.name]=i=i.copy(),a.push(i),this._boneSlotArray.push(i)}}}_emitMissedEvents(t,i,a=0){let r=this._templet.eventAniArr[this._player.currentAnimationClipIndex];if(r){let t=r.length;for(let i=a;i<t;i++){let t=r[i];t.time>=this._player.playStart&&t.time<=this._player.playEnd&&this.event(e.Event.LABEL,t)}}}_update(t=!0){if(t&&this._pause)return;if(t&&this._indexControl)return;let i=this.timer.currTimer,a=this._player.currentKeyframeIndex,r=i-this._lastTime;if(t?this._player._update(r):a=-1,this._lastTime=i,this._index=this._clipIndex=this._player.currentKeyframeIndex,this._index<0)return;if(r>0&&this._clipIndex==a&&this._lastUpdateAniClipIndex==this._aniClipIndex)return;this._lastUpdateAniClipIndex=this._aniClipIndex,a>this._clipIndex&&0!=this._eventIndex&&(this._emitMissedEvents(this._player.playStart,this._player.playEnd,this._eventIndex),this._eventIndex=0);let s=this._templet.eventAniArr[this._aniClipIndex];if(s&&this._eventIndex<s.length){let t=s[this._eventIndex];if(t.time>=this._player.playStart&&t.time<=this._player.playEnd){if(this._player.currentPlayTime>=t.time&&(this.event(e.Event.LABEL,t),this._eventIndex++,this._playAudio&&t.audioValue&&"null"!==t.audioValue&&"undefined"!==t.audioValue)){let i=e.SoundManager.playSound(this._player.templet._path+t.audioValue,1,e.Handler.create(this,this._onAniSoundStoped));e.SoundManager.playbackRate=this._player.playbackRate,i&&this._soundChannelArr.push(i)}}else if(t.time<this._player.playStart&&this._playAudio&&t.audioValue&&"null"!==t.audioValue&&"undefined"!==t.audioValue){this._eventIndex++;let i=e.SoundManager.playSound(this._player.templet._path+t.audioValue,1,e.Handler.create(this,this._onAniSoundStoped),null,(this._player.currentPlayTime-t.time)/1e3);e.SoundManager.playbackRate=this._player.playbackRate,i&&this._soundChannelArr.push(i)}else this._eventIndex++}if(0==this._aniMode){let t=this._templet.getGrahicsDataWithCache(this._aniClipIndex,this._clipIndex)||this._createGraphics();t&&this.graphics!=t&&(this.graphics=t)}else if(1==this._aniMode){let t=this._getGrahicsDataWithCache(this._aniClipIndex,this._clipIndex)||this._createGraphics();t&&this.graphics!=t&&(this.graphics=t)}else this._createGraphics()}_onAniSoundStoped(t){for(let e=this._soundChannelArr.length,i=0;i<e;i++){let a=this._soundChannelArr[i];(a.isStopped||t)&&(!a.isStopped&&a.stop(),this._soundChannelArr.splice(i,1),e--,i--)}}_createGraphics(t=-1){-1==t&&(t=this._clipIndex);let i=t*this._player.cacheFrameRateInterval,a=this._templet.drawOrderAniArr[this._aniClipIndex];if(a&&a.length>0){this._drawOrderIndex=0;let t=a[this._drawOrderIndex];for(;i>=t.time&&(this._drawOrder=t.drawOrder,this._drawOrderIndex++,!(this._drawOrderIndex>=a.length));)t=a[this._drawOrderIndex]}0==this._aniMode||1==this._aniMode?this.graphics=_.create():this.graphics instanceof _?this.graphics.clear():this.graphics=_.create();let r=this.graphics,s=this._templet.getNodes(this._aniClipIndex),n=0==this._player.state;this._templet.getOriginalData(this._aniClipIndex,this._curOriginalData,null,t,n?i+this._player.cacheFrameRateInterval:i);let h=this._aniSectionDic[this._aniClipIndex],l=0,o=0,u=0,p=0,d=0,c=this._templet.srcBoneMatrixArr.length,m=this._curOriginalData;for(o=0,d=h[0];o<c;o++){let t=this._boneList[o].resultTransform,e=this._templet.srcBoneMatrixArr[o];t.scX=e.scX*m[l++],t.skX=e.skX+m[l++],t.skY=e.skY+m[l++],t.scY=e.scY*m[l++],t.x=e.x+m[l++],t.y=e.y+m[l++],8===this._templet.tMatrixDataLen&&(t.skewX=e.skewX+m[l++],t.skewY=e.skewY+m[l++])}let x={},y={};for(d+=h[1];o<d;o++){let t=s[o];x[t.name]=m[l++],y[t.name]=m[l++],l+=4}let g={},f={};for(d+=h[2];o<d;o++){let t=s[o];g[t.name]=m[l++],f[t.name]=m[l++],l+=4}if(this._pathDic)for(d+=h[3];o<d;o++){let t=s[o],i=this._pathDic[t.name];if(i){switch(new e.Byte(t.extenData).getByte()){case 1:i.position=m[l++];break;case 2:i.spacing=m[l++];break;case 3:i.rotateMix=m[l++],i.translateMix=m[l++]}}}if(this._rootBone.update(this._yReverseMatrix||e.Matrix.TEMP.identity()),this._ikArr){let t;for(o=0,d=this._ikArr.length;o<d;o++)t=this._ikArr[o],t.name in g&&(t.bendDirection=g[t.name]),t.name in f&&(t.mix=f[t.name]),t.apply()}if(this._pathDic)for(let t in this._pathDic){this._pathDic[t].apply(this._boneList,r)}if(this._tfArr)for(o=0,p=this._tfArr.length;o<p;o++){this._tfArr[o].apply()}for(o=0,p=this._boneList.length;o<p;o++){let t=this._boneList[o],e=this._bindBoneBoneSlotDic[t.name];if(t.resultMatrix.copyTo(this._boneMatrixArray[o]),e)for(u=0,d=e.length;u<d;u++){let i=e[u];i&&i.setParentMatrix(t.resultMatrix)}}let M={},D=this._templet.deformAniArr;if(D&&D.length>0){if(this._lastAniClipIndex!=this._aniClipIndex)for(this._lastAniClipIndex=this._aniClipIndex,o=0,d=this._boneSlotArray.length;o<d;o++){this._boneSlotArray[o].deformData=null}let t,e=D[this._aniClipIndex],a=e.default;for(t in this._setDeform(a,M,this._boneSlotArray,i),e)"default"!=t&&t!=this._skinName&&(a=e[t],this._setDeform(a,M,this._boneSlotArray,i));a=e[this._skinName],this._setDeform(a,M,this._boneSlotArray,i)}if(this._drawOrder)for(o=0,d=this._drawOrder.length;o<d;o++){let t=this._boneSlotArray[this._drawOrder[o]],e=x[t.name],i=y[t.name];if(isNaN(e)||-2==e||(this._templet.attachmentNames?t.showDisplayByName(this._templet.attachmentNames[e]):t.showDisplayByIndex(e)),M[this._drawOrder[o]]){let e=M[this._drawOrder[o]];t.currDisplayData&&e[t.currDisplayData.attachmentName]?t.deformData=e[t.currDisplayData.attachmentName]:t.deformData=null}else t.deformData=null;isNaN(i)?t.draw(r,this._boneMatrixArray,2==this._aniMode):t.draw(r,this._boneMatrixArray,2==this._aniMode,i)}else for(o=0,d=this._boneSlotArray.length;o<d;o++){let t=this._boneSlotArray[o],e=x[t.name],i=y[t.name];if(isNaN(e)||-2==e||(this._templet.attachmentNames?t.showDisplayByName(this._templet.attachmentNames[e]):t.showDisplayByIndex(e)),M[o]){let e=M[o];t.currDisplayData&&e[t.currDisplayData.attachmentName]?t.deformData=e[t.currDisplayData.attachmentName]:t.deformData=null}else t.deformData=null;isNaN(i)?t.draw(r,this._boneMatrixArray,2==this._aniMode):t.draw(r,this._boneMatrixArray,2==this._aniMode,i)}return 0==this._aniMode?(this._templet.setGrahicsDataWithCache(this._aniClipIndex,t,r),this._checkIsAllParsed(this._aniClipIndex)):1==this._aniMode&&this._setGrahicsDataWithCache(this._aniClipIndex,t,r),r}_checkIsAllParsed(t){let e=Math.floor(.01+this._templet.getAniDuration(t)/1e3*this._player.cacheFrameRate);for(let i=0;i<e;i++)if(!this._templet.getGrahicsDataWithCache(t,i))return;this._templet.getGrahicsDataWithCache(t,e)?this._templet.deleteAniData(t):this._createGraphics(e)}_setDeform(t,e,i,a){if(!t)return;let r,s,n;if(t)for(let h=0,l=t.deformSlotDataList.length;h<l;h++){r=t.deformSlotDataList[h];for(let t=0;t<r.deformSlotDisplayList.length;t++)s=r.deformSlotDisplayList[t],n=i[s.slotIndex],s.apply(a,n),e[s.slotIndex]||(e[s.slotIndex]={}),e[s.slotIndex][s.attachment]=s.deformData}}getAnimNum(){return this._templet.getAnimationCount()}getAniNameByIndex(t){return this._templet.getAniNameByIndex(t)}getSlotByName(t){return this._boneSlotDic[t]}showSkinByName(t,e=!0){this.showSkinByIndex(this._templet.getSkinIndexByName(t),e)}showSkinByIndex(t,e=!0){for(let t=0;t<this._boneSlotArray.length;t++)this._boneSlotArray[t].showSlotData(null,e);if(this._templet.showSkinByIndex(this._boneSlotDic,t,e)){let e=this._templet.skinDataArray[t];this._skinName=e.name}this._clearCache()}showSlotSkinByIndex(t,e){if(0==this._aniMode)return;let i=this.getSlotByName(t);i&&i.showDisplayByIndex(e),this._clearCache()}showSlotSkinByName(t,e){if(0==this._aniMode)return;let i=this.getSlotByName(t);i&&i.showDisplayByName(e),this._clearCache()}replaceSlotSkinName(t,e,i){if(0==this._aniMode)return;let a=this.getSlotByName(t);a&&a.replaceDisplayByName(e,i),this._clearCache()}replaceSlotSkinByIndex(t,e,i){if(0==this._aniMode)return;let a=this.getSlotByName(t);a&&a.replaceDisplayByIndex(e,i),this._clearCache()}setSlotSkin(t,e){if(0==this._aniMode)return;let i=this.getSlotByName(t);i&&i.replaceSkin(e),this._clearCache()}_clearCache(){if(1==this._aniMode)for(let e=0,i=this._graphicsCache.length;e<i;e++){for(let i=0,a=this._graphicsCache[e].length;i<a;i++){var t=this._graphicsCache[e][i];t&&t!=this.graphics&&_.recycle(t)}this._graphicsCache[e].length=0}}play(t,i,a=!0,r=0,s=0,n=!0,h=!0){this._playAudio=h,this._indexControl=!1;let l=-1;var o;if(o=i?2147483647:0,"string"==typeof t)for(let e=0,i=this._templet.getAnimationCount();e<i;e++){let i=this._templet.getAnimation(e);if(i&&t==i.name){l=e;break}}else l=t;l>-1&&l<this.getAnimNum()&&(this._aniClipIndex=l,(a||this._pause||this._currAniIndex!=l)&&(this._currAniIndex=l,this._curOriginalData=new Float32Array(this._templet.getTotalkeyframesLength(l)),this._drawOrder=null,this._eventIndex=0,this._player.play(l,this._player.playbackRate,o,r,s),n&&this._templet.showSkinByIndex(this._boneSlotDic,this._skinIndex),this._pause&&(this._pause=!1,this._lastTime=e.ILaya.Browser.now(),this.timer.frameLoop(1,this,this._update,null,!0)),this._update()))}stop(){this._pause||(this._pause=!0,this._player&&this._player.stop(!0),this._soundChannelArr.length>0&&this._onAniSoundStoped(!0),this.timer.clear(this,this._update))}playbackRate(t){this._player&&(this._player.playbackRate=t)}paused(){if(!this._pause){if(this._pause=!0,this._player&&(this._player.paused=!0),this._soundChannelArr.length>0)for(let t=this._soundChannelArr.length,e=0;e<t;e++){let t=this._soundChannelArr[e];t.isStopped||t.pause()}this.timer.clear(this,this._update)}}resume(){if(this._indexControl=!1,this._pause){if(this._pause=!1,this._player&&(this._player.paused=!1),this._soundChannelArr.length>0)for(let t=this._soundChannelArr.length,e=0;e<t;e++){let t=this._soundChannelArr[e];t.audioBuffer&&t.resume()}this._lastTime=e.ILaya.Browser.now(),this.timer.frameLoop(1,this,this._update,null,!0)}}_getGrahicsDataWithCache(t,e){return this._graphicsCache[t][e]}_setGrahicsDataWithCache(t,e,i){this._graphicsCache[t][e]=i}reset(){this._templet._removeReference(),this._templet=null,this._player.offAll(),this._player=null,this._curOriginalData=null,this._boneMatrixArray.length=0,this._ikArr=null,this._pathDic=null,this._tfArr=null,this._lastTime=0,this._currAniIndex=-1,this._clipIndex=-1,this._indexControl=!1,this._eventIndex=0,this._drawOrderIndex=0,this._drawOrder=null,this._lastAniClipIndex=-1,this._lastUpdateAniClipIndex=-1,this._pause=!0,this.timer.clear(this,this._update),this._soundChannelArr.length>0&&this._onAniSoundStoped(!0)}destroy(t=!0){super.destroy(t),this._templet&&this.reset()}}i.Skeleton=x;class y{constructor(){this.skX=0,this.skY=0,this.scX=1,this.scY=1,this.x=0,this.y=0,this.skewX=0,this.skewY=0}initData(t){null!=t.x&&(this.x=t.x),null!=t.y&&(this.y=t.y),null!=t.skX&&(this.skX=t.skX),null!=t.skY&&(this.skY=t.skY),null!=t.scX&&(this.scX=t.scX),null!=t.scY&&(this.scY=t.scY)}getMatrix(){var t;return(t=this.mMatrix?this.mMatrix:this.mMatrix=new e.Matrix).identity(),t.scale(this.scX,this.scY),(this.skewX||this.skewY)&&this.skew(t,this.skewX*Math.PI/180,this.skewY*Math.PI/180),t.rotate(this.skX*Math.PI/180),t.translate(this.x,this.y),t}skew(t,e,i){var a=Math.sin(i),r=Math.cos(i),s=Math.sin(e),n=Math.cos(e);return t.setTo(t.a*n-t.b*a,t.a*s+t.b*r,t.c*n-t.d*a,t.c*s+t.d*r,t.tx*n-t.ty*a,t.tx*s+t.ty*r),t}}class g{constructor(){this.length=10,this.resultTransform=new y,this.resultMatrix=new e.Matrix,this.inheritScale=!0,this.inheritRotation=!0,this.d=-1,this._children=[]}setTempMatrix(t){this._tempMatrix=t;var e,i=0;for(i=0,e=this._children.length;i<e;i++)this._children[i].setTempMatrix(this._tempMatrix)}update(t=null){var i;if(this.rotation=this.transform.skX,t)i=this.resultTransform.getMatrix(),e.Matrix.mul(i,t,this.resultMatrix),this.resultRotation=this.rotation;else if(this.resultRotation=this.rotation+this.parentBone.resultRotation,this.parentBone)if(this.inheritRotation&&this.inheritScale)i=this.resultTransform.getMatrix(),e.Matrix.mul(i,this.parentBone.resultMatrix,this.resultMatrix);else{var a,r,s,n=this.parentBone,h=this.parentBone.resultMatrix;i=this.resultTransform.getMatrix();var l=h.a*i.tx+h.c*i.ty+h.tx,o=h.b*i.tx+h.d*i.ty+h.ty,u=new e.Matrix;this.inheritRotation?(a=Math.atan2(n.resultMatrix.b,n.resultMatrix.a),r=Math.cos(a),s=Math.sin(a),u.setTo(r,s,-s,r,0,0),e.Matrix.mul(this._tempMatrix,u,e.Matrix.TEMP),e.Matrix.TEMP.copyTo(u),i=this.resultTransform.getMatrix(),e.Matrix.mul(i,u,this.resultMatrix),this.resultTransform.scX*this.resultTransform.scY<0&&this.resultMatrix.rotate(.5*Math.PI),this.resultMatrix.tx=l,this.resultMatrix.ty=o):(this.inheritScale,i=this.resultTransform.getMatrix(),e.Matrix.TEMP.identity(),e.Matrix.TEMP.d=this.d,e.Matrix.mul(i,e.Matrix.TEMP,this.resultMatrix),this.resultMatrix.tx=l,this.resultMatrix.ty=o)}else(i=this.resultTransform.getMatrix()).copyTo(this.resultMatrix);var p,_=0;for(_=0,p=this._children.length;_<p;_++)this._children[_].update()}updateChild(){var t,e=0;for(e=0,t=this._children.length;e<t;e++)this._children[e].update()}setRotation(t){this._sprite&&(this._sprite.rotation=180*t/Math.PI)}updateDraw(t,i){g.ShowBones&&!g.ShowBones[this.name]||(this._sprite?(this._sprite.x=t+this.resultMatrix.tx,this._sprite.y=i+this.resultMatrix.ty):(this._sprite=new e.Sprite,this._sprite.graphics.drawCircle(0,0,5,"#ff0000"),this._sprite.graphics.drawLine(0,0,this.length,0,"#00ff00"),this._sprite.graphics.fillText(this.name,0,0,"20px Arial","#00ff00","center"),e.ILaya.stage.addChild(this._sprite),this._sprite.x=t+this.resultMatrix.tx,this._sprite.y=i+this.resultMatrix.ty));var a,r=0;for(r=0,a=this._children.length;r<a;r++)this._children[r].updateDraw(t,i)}addChild(t){this._children.push(t),t.parentBone=this}findBone(t){if(this.name==t)return this;var e,i,a;for(e=0,i=this._children.length;e<i;e++)if(a=this._children[e].findBone(t))return a;return null}localToWorld(t){var e=t[0],i=t[1];t[0]=e*this.resultMatrix.a+i*this.resultMatrix.c+this.resultMatrix.tx,t[1]=e*this.resultMatrix.b+i*this.resultMatrix.d+this.resultMatrix.ty}}g.ShowBones={};class f{constructor(){this.boneIndexs=[]}}class M{constructor(){this.bones=[]}}class D{constructor(){this.deformSlotDataList=[]}}class v{constructor(){this.deformSlotDisplayList=[]}}class I{constructor(){this.slotIndex=-1,this.timeList=[],this.vectices=[],this.tweenKeyList=[],this.frameIndex=0}binarySearch1(t,e){var i=0,a=t.length-2;if(0==a)return 1;for(var r=a>>>1;;){if(t[Math.floor(r+1)]<=e?i=r+1:a=r,i==a)return i+1;r=i+a>>>1}return 0}apply(t,e,i=1){if(t+=.05,!(this.timeList.length<=0)){var a=0;if(!(t<this.timeList[0])){var r=this.vectices[0].length,s=[],n=this.binarySearch1(this.timeList,t);if(this.frameIndex=n,t>=this.timeList[this.timeList.length-1]){var h=this.vectices[this.vectices.length-1];if(i<1)for(a=0;a<r;a++)s[a]+=(h[a]-s[a])*i;else for(a=0;a<r;a++)s[a]=h[a];this.deformData=s}else{var l,o=this.vectices[this.frameIndex-1],u=this.vectices[this.frameIndex],p=this.timeList[this.frameIndex-1],_=this.timeList[this.frameIndex];for(i=this.tweenKeyList[n-1]?(t-p)/(_-p):0,a=0;a<r;a++)l=o[a],s[a]=l+(u[a]-l)*i;this.deformData=s}}}}}class A{constructor(){this.drawOrder=[]}}class S{constructor(){}}class b{constructor(){}static getRelativeUV(t,e,i=null){var a,r,s=t[0],n=t[2]-t[0],h=t[1],l=t[5]-t[1];i||(i=[]),i.length=e.length,r=i.length;var o=1/n,u=1/l;for(a=0;a<r;a+=2)i[a]=(e[a]-s)*o,i[a+1]=(e[a+1]-h)*u;return i}static getAbsoluteUV(t,i,a=null){if(0==t[0]&&0==t[1]&&1==t[4]&&1==t[5])return a?(e.Utils.copyArray(a,i),a):i;var r,s,n=t[0],h=t[2]-t[0],l=t[1],o=t[5]-t[1];for(a||(a=[]),a.length=i.length,s=a.length,r=0;r<s;r+=2)a[r]=i[r]*h+n,a[r+1]=i[r+1]*o+l;return a}}class T{constructor(){this.uvs=new Float32Array([0,0,1,0,1,1,0,1]),this.vertices=new Float32Array([0,0,100,0,100,100,0,100]),this.indexes=new Uint16Array([0,1,3,3,1,2]),this.useUvTransform=!1,this.canvasPadding=1}getBounds(){return e.Rectangle._getWrapRec(this.vertices)}}class C extends T{constructor(){super()}init2(t,e,i,a){this.transform&&(this.transform=null);var r=e||[0,1,3,3,1,2];this.texture=t,this.indexes=new Uint16Array(r),this.vertices=new Float32Array(i),this.uvs=new Float32Array(a)}}class F{constructor(){this.srcDisplayIndex=-1,this.type="src",this.displayIndex=-1,this.originalIndex=-1,this._replaceDic={}}showSlotData(t,e=!0){this.currSlotData=t,e&&(this.displayIndex=this.srcDisplayIndex),this.currDisplayData=null,this.currTexture=null}showDisplayByName(t){this.currSlotData&&this.showDisplayByIndex(this.currSlotData.getDisplayByName(t))}replaceDisplayByName(t,e){var i,a;this.currSlotData&&(i=this.currSlotData.getDisplayByName(t),a=this.currSlotData.getDisplayByName(e),this.replaceDisplayByIndex(i,a))}replaceDisplayByIndex(t,e){this.currSlotData&&(this._replaceDic[t]=e,this.originalIndex==t&&this.showDisplayByIndex(t))}showDisplayByIndex(t){if(this.originalIndex=t,null!=this._replaceDic[t]&&(t=this._replaceDic[t]),this.currSlotData&&t>-1&&t<this.currSlotData.displayArr.length){if(this.displayIndex=t,this.currDisplayData=this.currSlotData.displayArr[t],this.currDisplayData){var e=this.currDisplayData.name;this.currTexture=this.templet.getTexture(e),this.currTexture&&0==this.currDisplayData.type&&this.currDisplayData.uvs&&(this.currTexture=this.currDisplayData.createTexture(this.currTexture))}}else this.displayIndex=-1,this.currDisplayData=null,this.currTexture=null}replaceSkin(t){this._diyTexture=t,this._curDiyUV&&(this._curDiyUV.length=0),this.currDisplayData&&this._diyTexture==this.currDisplayData.texture&&(this._diyTexture=null)}setParentMatrix(t){this._parentMatrix=t}static createSkinMesh(){return new C}static isSameArr(t,e){if(t.length!=e.length)return!1;var i,a;for(a=t.length,i=0;i<a;i++)if(t[i]!=e[i])return!1;return!0}getSaveVerticle(t){return F.useSameMatrixAndVerticle&&this._preGraphicVerticle&&F.isSameArr(t,this._preGraphicVerticle)?t=this._preGraphicVerticle:(t=e.Utils.copyArray([],t),this._preGraphicVerticle=t),t}static isSameMatrix(t,e){return t.a==e.a&&t.b==e.b&&t.c==e.c&&t.d==e.d&&Math.abs(t.tx-e.tx)<1e-5&&Math.abs(t.ty-e.ty)<1e-5}getSaveMatrix(t){if(F.useSameMatrixAndVerticle&&this._preGraphicMatrix&&F.isSameMatrix(t,this._preGraphicMatrix))t=this._preGraphicMatrix;else{var e=t.clone();t=e,this._preGraphicMatrix=t}return t}draw(t,i,a=!1,r=1){if((null!=this._diyTexture||null!=this.currTexture)&&null!=this.currDisplayData||this.currDisplayData&&3==this.currDisplayData.type){var s,n=this.currTexture;switch(this._diyTexture&&(n=this._diyTexture),this.currDisplayData.type){case 0:if(t){var h=this.getDisplayMatrix();if(this._parentMatrix){var l=!1;if(h){var o;if(e.Matrix.mul(h,this._parentMatrix,e.Matrix.TEMP),a?(null==this._resultMatrix&&(this._resultMatrix=new e.Matrix),o=this._resultMatrix):o=F._tempResultMatrix,this._diyTexture&&this.currDisplayData.uvs){var u=F._tempMatrix;u.identity(),this.currDisplayData.uvs[1]>this.currDisplayData.uvs[5]&&(u.d=-1),this.currDisplayData.uvs[0]>this.currDisplayData.uvs[4]&&this.currDisplayData.uvs[1]>this.currDisplayData.uvs[5]&&(l=!0,u.rotate(-Math.PI/2)),e.Matrix.mul(u,e.Matrix.TEMP,o)}else e.Matrix.TEMP.copyTo(o);a||(o=this.getSaveMatrix(o)),o._checkTransform(),l?t.drawTexture(n,-this.currDisplayData.height/2,-this.currDisplayData.width/2,this.currDisplayData.height,this.currDisplayData.width,o,r):t.drawTexture(n,-this.currDisplayData.width/2,-this.currDisplayData.height/2,this.currDisplayData.width,this.currDisplayData.height,o,r)}}}break;case 1:if(a?(null==this._skinSprite&&(this._skinSprite=F.createSkinMesh()),s=this._skinSprite):s=F.createSkinMesh(),null==s)return;var p;if(null==this.currDisplayData.bones){var _,d=this.currDisplayData.weights;this.deformData&&(d=this.deformData),this._diyTexture?(this._curDiyUV||(this._curDiyUV=[]),0==this._curDiyUV.length&&(this._curDiyUV=b.getRelativeUV(this.currTexture.uv,this.currDisplayData.uvs,this._curDiyUV),this._curDiyUV=b.getAbsoluteUV(this._diyTexture.uv,this._curDiyUV,this._curDiyUV)),_=this._curDiyUV):_=this.currDisplayData.uvs,this._mVerticleArr=d,this.currDisplayData.triangles.length,p=this.currDisplayData.triangles,this.deformData&&(a||(this._mVerticleArr=this.getSaveVerticle(this._mVerticleArr))),s.init2(n,p,this._mVerticleArr,_);var c,m=this.getDisplayMatrix();if(this._parentMatrix)if(m)e.Matrix.mul(m,this._parentMatrix,e.Matrix.TEMP),a?(null==this._resultMatrix&&(this._resultMatrix=new e.Matrix),c=this._resultMatrix):c=F._tempResultMatrix,e.Matrix.TEMP.copyTo(c),a||(c=this.getSaveMatrix(c)),s.transform=c}else this.skinMesh(i,s);t.drawSkin(s,r);break;case 2:if(a?(null==this._skinSprite&&(this._skinSprite=F.createSkinMesh()),s=this._skinSprite):s=F.createSkinMesh(),null==s)return;this.skinMesh(i,s),t.drawSkin(s,r)}}}skinMesh(t,e){var i,a=this.currTexture,r=this.currDisplayData.bones;this._diyTexture?(a=this._diyTexture,this._curDiyUV||(this._curDiyUV=[]),0==this._curDiyUV.length&&(this._curDiyUV=b.getRelativeUV(this.currTexture.uv,this.currDisplayData.uvs,this._curDiyUV),this._curDiyUV=b.getAbsoluteUV(this._diyTexture.uv,this._curDiyUV,this._curDiyUV)),i=this._curDiyUV):i=this.currDisplayData.uvs;var s,n,h,l,o,u=this.currDisplayData.weights,p=this.currDisplayData.triangles,_=0,d=0,c=0,m=0,x=0,y=0,g=0;if(F._tempVerticleArr.length=0,o=F._tempVerticleArr,this.deformData&&this.deformData.length>0){var f=0;for(y=0,g=r.length;y<g;){for(c=r[y++]+y,_=0,d=0;y<c;y++)n=t[r[y]],h=u[m]+this.deformData[f++],l=u[m+1]+this.deformData[f++],x=u[m+2],_+=(h*n.a+l*n.c+n.tx)*x,d+=(h*n.b+l*n.d+n.ty)*x,m+=3;o.push(_,d)}}else for(y=0,g=r.length;y<g;){for(c=r[y++]+y,_=0,d=0;y<c;y++)n=t[r[y]],h=u[m],l=u[m+1],x=u[m+2],_+=(h*n.a+l*n.c+n.tx)*x,d+=(h*n.b+l*n.d+n.ty)*x,m+=3;o.push(_,d)}this._mVerticleArr=o,s=p,this._mVerticleArr=this.getSaveVerticle(this._mVerticleArr),e.init2(a,s,this._mVerticleArr,i)}drawBonePoint(t){t&&this._parentMatrix&&t.drawCircle(this._parentMatrix.tx,this._parentMatrix.ty,5,"#ff0000")}getDisplayMatrix(){return this.currDisplayData?this.currDisplayData.transform.getMatrix():null}getMatrix(){return this._resultMatrix}copy(){var t=new F;return t.type="copy",t.name=this.name,t.attachmentName=this.attachmentName,t.srcDisplayIndex=this.srcDisplayIndex,t.parent=this.parent,t.displayIndex=this.displayIndex,t.templet=this.templet,t.currSlotData=this.currSlotData,t.currTexture=this.currTexture,t.currDisplayData=this.currDisplayData,t}}F._tempMatrix=new e.Matrix,F._tempResultMatrix=new e.Matrix,F.useSameMatrixAndVerticle=!0,F._tempVerticleArr=[];class w{constructor(){this.slotArr=[]}}class k{createTexture(t){return this.texture||(this.texture=new e.Texture(t.bitmap,this.uvs),this.uvs[0]>this.uvs[4]&&this.uvs[1]>this.uvs[5]?(this.texture.width=t.height,this.texture.height=t.width,this.texture.offsetX=-t.offsetX,this.texture.offsetY=-t.offsetY,this.texture.sourceWidth=t.sourceHeight,this.texture.sourceHeight=t.sourceWidth):(this.texture.width=t.width,this.texture.height=t.height,this.texture.offsetX=-t.offsetX,this.texture.offsetY=-t.offsetY,this.texture.sourceWidth=t.sourceWidth,this.texture.sourceHeight=t.sourceHeight)),this.texture}destory(){this.texture&&this.texture.destroy()}}class U{constructor(){this.displayArr=[]}getDisplayByName(t){for(var e=0,i=this.displayArr.length;e<i;e++)if(this.displayArr[e].attachmentName==t)return e;return-1}}class B{constructor(){this.boneNames=[],this.bendDirection=1,this.mix=1,this.isSpine=!0,this.targetBoneIndex=-1,this.boneIndexs=[]}}const P="LAYAANIMATION:1.7.0";class L extends p{constructor(){super(...arguments),this.rate=30,this._graphicsCache=[],this.srcBoneMatrixArr=[],this.ikArr=[],this.tfArr=[],this.pathArr=[],this.boneSlotDic={},this.bindBoneBoneSlotDic={},this.boneSlotArray=[],this.skinDataArray=[],this.skinDic={},this.subTextureDic={},this.isParseFail=!1,this.drawOrderAniArr=[],this.eventAniArr=[],this.attachmentNames=null,this.deformAniArr=[],this.skinSlotDisplayDataArr=[],this._isParseAudio=!1,this.aniSectionDic={},this.mBoneArr=[]}buildArmature(t=0){let e=new x(t);return e.templet=this,e}_parse(t,i,a){this._path=i.slice(0,i.lastIndexOf("/"))+"/",t._addReference(),this._mainTexture=t;var r=new e.Byte(a);this._aniVersion=r.readUTFString(),n.parse(this,r),this._aniVersion===P?this._isParseAudio=!0:"LAYAANIMATION:1.6.0"!=this._aniVersion&&console.log("[Error] 版本不一致，请使用IDE版本配套的重新导出"+this._aniVersion+"->"+P);for(let t=0,e=this.getAnimationCount();t<e;t++)this._graphicsCache.push([]);var s,h=new e.Byte(this.getPublicExtData()),l=0,o=0,u=0,p=0,_=0,d=0,c=0,m=0,x=0,b=h.getInt32(),T=h.readUTFString(),C=T.split("\n");for(let t=0;t<b;t++)this._path,C[2*t],T=C[2*t+1],l=h.getFloat32(),o=h.getFloat32(),u=h.getFloat32(),p=h.getFloat32(),x=h.getFloat32(),_=isNaN(x)?0:x,x=h.getFloat32(),d=isNaN(x)?0:x,x=h.getFloat32(),c=isNaN(x)?u:x,x=h.getFloat32(),m=isNaN(x)?p:x,this.subTextureDic[T]=e.Texture.create(this._mainTexture,l,o,u,p,-_,-d,c,m);s="Dragon"!=this._aniClassName;var L,N,E,R,V,O=h.getUint16();for(let t=0;t<O;t++)(L=[]).push(h.getUint16()),L.push(h.getUint16()),L.push(h.getUint16()),L.push(h.getUint16()),this.aniSectionDic[t]=L;var K,Y=h.getInt16(),X={};for(let t=0;t<Y;t++)N=new g,0==t?K=N:N.root=K,N.d=s?-1:1,R=h.readUTFString(),V=h.readUTFString(),N.length=h.getFloat32(),1==h.getByte()&&(N.inheritRotation=!1),1==h.getByte()&&(N.inheritScale=!1),N.name=R,V&&((E=X[V])?E.addChild(N):this.mRootBone=N),X[R]=N,this.mBoneArr.push(N);this.tMatrixDataLen=h.getUint16();var W,z,G=h.getUint16(),q=Math.floor(G/this.tMatrixDataLen),H=this.srcBoneMatrixArr;for(let t=0;t<q;t++)(W=new y).scX=h.getFloat32(),W.skX=h.getFloat32(),W.skY=h.getFloat32(),W.scY=h.getFloat32(),W.x=h.getFloat32(),W.y=h.getFloat32(),8===this.tMatrixDataLen&&(W.skewX=h.getFloat32(),W.skewY=h.getFloat32()),H.push(W),(N=this.mBoneArr[t]).transform=W;var Q,Z,j=h.getUint16();for(let t=0;t<j;t++){z=new B,Q=h.getUint16();for(let t=0;t<Q;t++)z.boneNames.push(h.readUTFString()),z.boneIndexs.push(h.getInt16());z.name=h.readUTFString(),z.targetBoneName=h.readUTFString(),z.targetBoneIndex=h.getInt16(),z.bendDirection=h.getFloat32(),z.mix=h.getFloat32(),z.isSpine=s,this.ikArr.push(z)}var J,$,tt=h.getUint16();for(let t=0;t<tt;t++){Z=new f,J=h.getUint16();for(let t=0;t<J;t++)Z.boneIndexs.push(h.getInt16());Z.name=h.getUTFString(),Z.targetIndex=h.getInt16(),Z.rotateMix=h.getFloat32(),Z.translateMix=h.getFloat32(),Z.scaleMix=h.getFloat32(),Z.shearMix=h.getFloat32(),Z.offsetRotation=h.getFloat32(),Z.offsetX=h.getFloat32(),Z.offsetY=h.getFloat32(),Z.offsetScaleX=h.getFloat32(),Z.offsetScaleY=h.getFloat32(),Z.offsetShearY=h.getFloat32(),this.tfArr.push(Z)}var et,it,at,rt,st,nt,ht,lt,ot,ut,pt=h.getUint16();for(let t=0;t<pt;t++){($=new M).name=h.readUTFString(),et=h.getUint16();for(let t=0;t<et;t++)$.bones.push(h.getInt16());$.target=h.readUTFString(),$.positionMode=h.readUTFString(),$.spacingMode=h.readUTFString(),$.rotateMode=h.readUTFString(),$.offsetRotation=h.getFloat32(),$.position=h.getFloat32(),$.spacing=h.getFloat32(),$.rotateMix=h.getFloat32(),$.translateMix=h.getFloat32(),this.pathArr.push($)}var _t,dt=h.getInt16();for(let t=0;t<dt;t++){var ct=h.getUint8(),mt={};this.deformAniArr.push(mt);for(let t=0;t<ct;t++){(ht=new D).skinName=h.getUTFString(),mt[ht.skinName]=ht,it=h.getInt16();for(let t=0;t<it;t++){lt=new v,ht.deformSlotDataList.push(lt),at=h.getInt16();for(let t=0;t<at;t++){ot=new I,lt.deformSlotDisplayList.push(ot),ot.slotIndex=h.getInt16(),ot.attachment=h.getUTFString(),rt=h.getInt16();for(let t=0;t<rt;t++){1==h.getByte()?ot.tweenKeyList.push(!0):ot.tweenKeyList.push(!1),st=h.getFloat32(),ot.timeList.push(st),ut=[],ot.vectices.push(ut),nt=h.getInt16();for(let t=0;t<nt;t++)ut.push(h.getFloat32())}}}}}var xt,yt,gt,ft,Mt=h.getInt16();for(let t=0;t<Mt;t++){xt=h.getInt16(),_t=[];for(let t=0;t<xt;t++){(yt=new A).time=h.getFloat32(),gt=h.getInt16();for(let t=0;t<gt;t++)yt.drawOrder.push(h.getInt16());_t.push(yt)}this.drawOrderAniArr.push(_t)}var Dt,vt,It=h.getInt16();for(let t=0;t<It;t++){Dt=h.getInt16(),ft=[];for(let t=0;t<Dt;t++)(vt=new S).name=h.getUTFString(),this._isParseAudio&&(vt.audioValue=h.getUTFString()),vt.intValue=h.getInt32(),vt.floatValue=h.getFloat32(),vt.stringValue=h.getUTFString(),vt.time=h.getFloat32(),ft.push(vt);this.eventAniArr.push(ft)}var At=h.getInt16();if(At>0){this.attachmentNames=[];for(let t=0;t<At;t++)this.attachmentNames.push(h.getUTFString())}var St,bt,Tt=h.getInt16();for(let t=0;t<Tt;t++)(St=new F).name=h.readUTFString(),St.parent=h.readUTFString(),St.attachmentName=h.readUTFString(),St.srcDisplayIndex=St.displayIndex=h.getInt16(),St.templet=this,this.boneSlotDic[St.name]=St,null==(bt=this.bindBoneBoneSlotDic[St.parent])&&(this.bindBoneBoneSlotDic[St.parent]=bt=[]),bt.push(St),this.boneSlotArray.push(St);var Ct,Ft,wt,kt,Ut,Bt,Pt,Lt,Nt,Et,Rt=h.readUTFString().split("\n"),Vt=0,Ot=h.getUint8();for(let t=0;t<Ot;t++){(Ct=new w).name=Rt[Vt++],kt=h.getUint8();for(let t=0;t<kt;t++){(Ft=new U).name=Rt[Vt++],St=this.boneSlotDic[Ft.name],Ut=h.getUint8();for(let t=0;t<Ut;t++){if(wt=new k,this.skinSlotDisplayDataArr.push(wt),wt.name=Rt[Vt++],wt.attachmentName=Rt[Vt++],wt.transform=new y,wt.transform.scX=h.getFloat32(),wt.transform.skX=h.getFloat32(),wt.transform.skY=h.getFloat32(),wt.transform.scY=h.getFloat32(),wt.transform.x=h.getFloat32(),wt.transform.y=h.getFloat32(),Ft.displayArr.push(wt),wt.width=h.getFloat32(),wt.height=h.getFloat32(),wt.type=h.getUint8(),wt.verLen=h.getUint16(),(Y=h.getUint16())>0){wt.bones=[];for(let t=0;t<Y;t++){let t=h.getUint16();wt.bones.push(t)}}if((Bt=h.getUint16())>0){wt.uvs=[];for(let t=0;t<Bt;t++)wt.uvs.push(h.getFloat32())}if((Pt=h.getUint16())>0){wt.weights=[];for(let t=0;t<Pt;t++)wt.weights.push(h.getFloat32())}if((Lt=h.getUint16())>0){wt.triangles=[];for(let t=0;t<Lt;t++)wt.triangles.push(h.getUint16())}if((Nt=h.getUint16())>0){wt.vertices=[];for(let t=0;t<Nt;t++)wt.vertices.push(h.getFloat32())}if((Et=h.getUint16())>0){wt.lengths=[];for(let t=0;t<Et;t++)wt.lengths.push(h.getFloat32())}}Ct.slotArr.push(Ft)}this.skinDic[Ct.name]=Ct,this.skinDataArray.push(Ct)}1==h.getUint8()?(this.yReverseMatrix=new e.Matrix(1,0,0,-1,0,0),K&&K.setTempMatrix(this.yReverseMatrix)):K&&K.setTempMatrix(new e.Matrix),this.showSkinByIndex(this.boneSlotDic,0)}getTexture(t){let e=this.subTextureDic[t];return e||(e=this.subTextureDic[t.substring(0,t.length-1)]),null==e?this._mainTexture:e}showSkinByIndex(t,e,i=!0){if(e<0&&e>=this.skinDataArray.length)return!1;var a,r,s,n,h=this.skinDataArray[e];if(h){for(a=0,r=h.slotArr.length;a<r;a++)(n=h.slotArr[a])&&(s=t[n.name])&&(s.showSlotData(n,i),i&&"undefined"!=s.attachmentName&&"null"!=s.attachmentName?s.showDisplayByName(s.attachmentName):s.showDisplayByIndex(s.displayIndex));return!0}return!1}getSkinIndexByName(t){for(let e=0,i=this.skinDataArray.length;e<i;e++){if(this.skinDataArray[e].name==t)return e}return-1}getGrahicsDataWithCache(t,e){return this._graphicsCache[t]&&this._graphicsCache[t][e]?this._graphicsCache[t][e]:null}setGrahicsDataWithCache(t,e,i){this._graphicsCache[t][e]=i}deleteAniData(t){if(this._anis[t]){var e=this._anis[t];e.bone3DMap=null,e.nodes=null}}_disposeResource(){var t;for(let e in this.subTextureDic)null===(t=this.subTextureDic[e])||void 0===t||t.destroy();this._mainTexture._removeReference();for(var e=0,i=this.skinSlotDisplayDataArr.length;e<i;e++)this.skinSlotDisplayDataArr[e].destory();this.skinSlotDisplayDataArr.length=0}getAniNameByIndex(t){var e=this.getAnimation(t);return e?e.name:null}}i.Templet=L;e.Loader.registerLoader(["sk"],class{load(t){return Promise.all([t.loader.fetch(t.url,"arraybuffer",t.progress.createCallback(),t.options),t.loader.load(e.Utils.replaceFileExtension(t.url,"png"),null,t.progress.createCallback())]).then((e=>{if(!e[0]||!e[1])return null;let i=new L;return i._parse(e[1],t.url,e[0]),i}))}}),(0,e.ClassUtils.regClass)("Skeleton",x);class N extends e.Sprite{constructor(t=null){super(),this._start=0,this._Pos=0,this._ended=!0,this._loadedImage={},this._endFrame=-1,this.interval=30,this._ids={},this._idOfSprite=[],this._reset(),this._playing=!1,this._parentMovieClip=t,t?(this._isRoot=!1,this._movieClipList=t._movieClipList,this._movieClipList.push(this)):(this._movieClipList=[this],this._isRoot=!0,this._setBitUp(e.NodeFlags.DISPLAY))}destroy(t=!0){this._clear(),super.destroy(t)}_setDisplay(t){super._setDisplay(t),this._isRoot&&this._onDisplay(t)}_onDisplay(t){t?this.timer.loop(this.interval,this,this.updates,null,!0):this.timer.clear(this,this.updates)}updates(){var t,e;if(!this._parentMovieClip)for(e=this._movieClipList.length,t=0;t<e;t++)this._movieClipList[t]&&this._movieClipList[t]._update()}get index(){return this._playIndex}set index(t){this._playIndex=t,this._data&&this._displayFrame(this._playIndex),this._labels&&this._labels[t]&&this.event(e.Event.LABEL,this._labels[t])}addLabel(t,e){this._labels||(this._labels={}),this._labels[e]=t}removeLabel(t){if(t){if(!this._labels)for(var e in this._labels)if(this._labels[e]===t){delete this._labels[e];break}}else this._labels=null}get count(){return this._count}get playing(){return this._playing}_update(){if(this._data&&this._playing){if(this._playIndex++,this._playIndex>=this._count){if(!this.loop)return this._playIndex--,void this.stop();this._playIndex=0}if(this._parseFrame(this._playIndex),this._labels&&this._labels[this._playIndex]&&this.event(e.Event.LABEL,this._labels[this._playIndex]),-1!=this._endFrame&&this._endFrame==this._playIndex){if(this._endFrame=-1,null!=this._completeHandler){var t=this._completeHandler;this._completeHandler=null,t.run()}this.stop()}}}stop(){this._playing=!1}gotoAndStop(t){this.index=t,this.stop()}_clear(){if(this.stop(),this._idOfSprite.length=0,!this._parentMovieClip){var t,i;for(this.timer.clear(this,this.updates),i=this._movieClipList.length,t=0;t<i;t++)this._movieClipList[t]!=this&&this._movieClipList[t]._clear();this._movieClipList.length=0}var a;for(a in this._loadedImage){let t=this._loadedImage[a];t&&(e.ILaya.Loader.clearRes(a,t),this._loadedImage[a]=!1)}this.removeChildren(),this.graphics=null,this._parentMovieClip=null}play(t=0,e=!0){this.loop=e,this._playing=!0,this._data&&this._displayFrame(t)}_displayFrame(t=-1){-1!=t&&(this._curIndex>t&&this._reset(),this._parseFrame(t))}_reset(t=!0){t&&1!=this._curIndex&&this.removeChildren(),this._preIndex=this._curIndex=-1,this._Pos=this._start}_parseFrame(t){var i,a,r,s,n,h,l=!1,o=this._idOfSprite,u=this._data;for(this._ended&&this._reset(),u.pos=this._Pos,this._ended=!1,this._playIndex=t,this._curIndex>t&&t<this._preIndex&&(this._reset(!0),u.pos=this._Pos);this._curIndex<=t&&!this._ended;)switch(u.getUint16()){case 12:if(r=u.getUint16(),s=this._ids[u.getUint16()],this._Pos=u.pos,u.pos=s,0==(n=u.getUint8())){var p=u.getUint16();if(!(a=o[r])){a=o[r]=new e.Sprite;var _=new e.Sprite;_.loadImage(this.basePath+p+".png"),this._loadedImage[this.basePath+p+".png"]=!0,a.addChild(_),_.size(u.getFloat32(),u.getFloat32());var d=u._getMatrix();_.transform=d}a.alpha=1}else 1==n&&((i=o[r])||(o[r]=i=new N(this),i.interval=this.interval,i._ids=this._ids,i.basePath=this.basePath,i._setData(u,s),i._initState(),i.play(0)),i.alpha=1);u.pos=this._Pos;break;case 3:var c=o[u.getUint16()];c&&(this.addChild(c),c.zOrder=u.getUint16(),l=!0);break;case 4:(c=o[u.getUint16()])&&c.removeSelf();break;case 5:o[u.getUint16()][N._ValueList[u.getUint16()]]=u.getFloat32();break;case 6:o[u.getUint16()].visible=u.getUint8()>0;break;case 7:var m=(a=o[u.getUint16()]).transform||e.Matrix.create();m.setTo(u.getFloat32(),u.getFloat32(),u.getFloat32(),u.getFloat32(),u.getFloat32(),u.getFloat32()),a.transform=m;break;case 8:o[u.getUint16()].setPos(u.getFloat32(),u.getFloat32());break;case 9:o[u.getUint16()].setSize(u.getFloat32(),u.getFloat32());break;case 10:o[u.getUint16()].alpha=u.getFloat32();break;case 11:o[u.getUint16()].setScale(u.getFloat32(),u.getFloat32());break;case 98:h=u.getString(),this.event(h),"stop"==h&&this.stop();break;case 99:this._curIndex=u.getUint16(),l&&this.updateZOrder();break;case 100:this._count=this._curIndex+1,this._ended=!0,this._playing&&(this.event(e.Event.FRAME),this.event(e.Event.END),this.event(e.Event.COMPLETE)),this._reset(!1)}this._playing&&!this._ended&&this.event(e.Event.FRAME),this._Pos=u.pos}_setData(t,e){this._data=t,this._start=e+3}get source(){return this._source}set source(t){this.load(t)}load(t,i=!1,a=null){this.stop(),this._clear(),this._movieClipList=[this],this._source=t,i&&(a=a||t.split(".swf")[0]+".json"),e.ILaya.loader.load(a?[t,a]:[t],e.Loader.BUFFER).then((a=>{var r;if(!a)return void this.event(e.Event.ERROR,"file not find");let s=i?null===(r=a[1])||void 0===r?void 0:r.dir:t.split(".swf")[0]+"/image/";this._initData(new e.Byte(a[0].data),s)}))}_initState(){this._reset(),this._ended=!1;var t=this._playing;for(this._playing=!1,this._curIndex=0;!this._ended;)this._parseFrame(++this._curIndex);this._playing=t}_initData(t,i){this.basePath=i;let a=t.getUint16();for(let e=0;e<a;e++)this._ids[t.getInt16()]=t.getInt32();this.interval=1e3/t.getUint16(),this._setData(t,this._ids[32767]),this._initState(),this.play(0),this.event(e.Event.READY),this._parentMovieClip||this.timer.loop(this.interval,this,this.updates,null,!0)}playTo(t,e,i=null){this._completeHandler=i,this._endFrame=e,this.play(t,!1)}}N._ValueList=["x","y","width","height","scaleX","scaleY","rotation","alpha"],t.AnimationContent=a,t.AnimationNodeContent=r,t.AnimationParser01=n,t.AnimationParser02=h,t.AnimationPlayer=o,t.AnimationState=l,t.AnimationTemplet=p,t.BezierLerp=u,t.Bone=g,t.BoneSlot=F,t.DeformAniData=D,t.DeformSlotData=v,t.DeformSlotDisplayData=I,t.DrawOrderData=A,t.EventData=S,t.GraphicsAni=_,t.IAniLib=i,t.IkConstraint=d,t.IkConstraintData=B,t.KeyFramesContent=s,t.MeshData=T,t.MovieClip=N,t.PathConstraint=c,t.PathConstraintData=M,t.Skeleton=x,t.SkinData=w,t.SkinMeshForGraphic=C,t.SkinSlotDisplayData=k,t.SlotData=U,t.Templet=L,t.TfConstraint=m,t.TfConstraintData=f,t.Transform=y,t.UVTools=b}(window.Laya=window.Laya||{},Laya);